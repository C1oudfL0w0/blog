
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>2024工业互联网安全决赛 | 雲流のLowest World</title>
    <meta name="author" content="C1oudfL0w0" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
    <link rel="icon" href="/blog/images/croppedImage_cropped.jpg" />
    <!-- cdn挂掉的时候要可以引用本地 -->
<!-- <script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.min.js"></script> -->
<script src="/blog/js/vue.global.prod.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.2.1/css/all.min.css" />


<link rel="stylesheet" href="/blog/css/all.min.css" />
<link rel="stylesheet" href="/blog/css/fonts.min.css" />
<link rel="stylesheet" href="/blog/css/search.css" />
<script> const mixins = {}; </script>

<!-- 引入jQuery-->
<!-- <script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script> -->
<script src="/blog/js/jquery.min.js"></script>

<!--改成了prismjs高亮-->

<script src="/blog/js/lib/prism.js"></script>
<link rel="stylesheet" href="/blog/css/prism.css" rel="stylesheet" />



<script src="/blog/js/lib/preview.js"></script>










<script src="/blog/js/lib/home.js"></script>

<link rel="stylesheet" href="/blog/css/main.css" />
<!-- 引入不蒜子-->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<!-- 引入clipboard -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeCopy.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/blog/atom.xml" title="雲流のLowest World" type="application/atom+xml">
</head>

<body>
    <!--flag{never_g0nna g1ve_you up}-->

    <!-- 页面点击特效 -->
    <script type="text/javascript" src="/blog/js/love-click.js"></script>

    <!-- 浏览器标题 -->
    <script async type="text/javascript" src="/blog/js/FunnyTitle.js"></script>

    <!-- 动态背景 -->
    

    <!--文章目录-->
    
    <div id="toc" class="toc-article">
    <h3><i class="fas fa-stream"></i>  目录</h3>
      <div class="toc-title"></div>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E4%B8%80%EF%BC%9A%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91%E6%9E%84%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">任务一：网络拓扑构建</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E4%BA%8C%EF%BC%9A%E4%BA%A4%E6%8D%A2%E6%9C%BA%E9%85%8D%E7%BD%AE%EF%BC%88Unsolved%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">任务二：交换机配置（Unsolved）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E5%8D%81%E4%B8%89%EF%BC%9A%E4%BB%A3%E7%A0%81%E5%AE%89%E5%85%A8%E5%AE%A1%E8%AE%A1"><span class="toc-number">4.</span> <span class="toc-text">任务十三：代码安全审计</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B8%97%E9%80%8F-%E6%95%B0%E5%AD%97%E5%8C%96%E8%A3%85%E9%85%8D%E5%9C%BA%E6%99%AF"><span class="toc-number">5.</span> <span class="toc-text">渗透-数字化装配场景</span></a></li></ol>
    </div>
  

    <!--返回顶部-->
    <div id="totop" style="position:fixed;bottom:50px;right:60px;font-size: 48px;cursor: pointer;z-index: 10;">
        <a title="返回顶部">↑</a>
    </div>
    <script src="/blog/js/totop.js"></script>

    <div id="layout">
        
            <div id="content-background" ref="contentBackground" data-images="https://pic.imgdb.cn/item/65d61d809f345e8d03b8bc7a.png"></div>
            
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>第一次加载文章图片可能会花费较长时间</p>
                    <p>要不挂个梯子试试？（x</p>
                    <p>加载过慢请开启缓存&ensp;浏览器默认开启</p>
                    <img src="/blog/images/loading.gif" />
                </div>
            </div>
        </transition>
        <transition name="into">
            <div id="main" v-show="!loading">
                <nav id="menu" ref="menu">
    <div class="desktop-menu">
        <a class="title" href="/blog/">
            <span>雲流のLOWEST WORLD</span>
        </a>
        
        <a href="/blog/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/blog/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/blog/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/blog/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/blog/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
        <a href="/blog/links">
            <i class="fa-solid fa-link fa-fw"></i>
            <span>&ensp;Links</span>
        </a>
        
        <a href="/blog/search">
            <i class="fa-solid fa-search fa-fw"></i>
            <span>&ensp;Search</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="curtain" v-show="showMenu" @click="showMenu = !showMenu"></div>
        <div class="title" @click="showMenu = !showMenu">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;雲流のLOWEST WORLD</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="showMenu">
            
            <a href="/blog/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                </div>
            </a>
            
            <a href="/blog/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                </div>
            </a>
            
            <a href="/blog/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                </div>
            </a>
            
            <a href="/blog/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                </div>
            </a>
            
            <a href="/blog/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                </div>
            </a>
            
            <a href="/blog/links">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-link fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Links</div>
                </div>
            </a>
            
            <a href="/blog/search">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-search fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Search</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>

                <div class="article">
    <div>
        <h1>2024工业互联网安全决赛</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/11/28
        </span>
        
        <span class="category">
            <a href="/blog/categories/%E7%BA%BF%E4%B8%8B%E8%B5%9B/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                线下赛
            </a>
        </span>
        
        
        <!--文章字数统计-->
        
            
<div style="margin-top:10px;">
    <span class="post-time">
      <span class="post-meta-item-icon">
        <i class="fa fa-keyboard-o"></i>
        <span class="post-meta-item-text">  字数统计: </span>
        <!-- 安装插件npm install hexo-wordcount --save -->
        <span class="post-count">4.1k字</span>
      </span>
    </span>

    <span class="post-time">
      &nbsp; | &nbsp;
      <span class="post-meta-item-icon">
        <i class="fa fa-hourglass-half"></i>
        <span class="post-meta-item-text">  阅读时长: </span>
        <span class="post-count">22分</span>
      </span>
    </span>
    
    <!--不蒜子统计访问数-->
    <span id="busuanzi_container_page_pv">
    &nbsp; | &nbsp;
    总文章阅读量：<span id="busuanzi_value_page_pv"></span>次
    </span>
</div>

          
    </div>
    
    <div class="content" v-pre>
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>赛制是 理论 + 工控ctf + 渗透or运维build</p>
<p>理论赛本地大模型魅力时刻</p>
<p>ctf 部分上来先考计算机网络&#x2F;路由交换实践，而我还在重修计网，令人感叹（</p>
<p>然后用 ctf 的分换取渗透&#x2F;build启动环境的机会，渗透每次启动环境都只有一小时的时间能打，只能说根本打不完555</p>
<p><img src="/blog/2024/11/28/2024%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8/image-20241128171247204.png" alt="image-20241128171247204"></p>
<span id="more"></span>

<hr>
<p>设备如下，是西门子的，交换机是tplink的，比赛的时候显示器接的是 SCADA：</p>
<p><img src="/blog/2024/11/28/2024%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8/1733190508111.jpg" alt="1733190508111"></p>
<h1 id="任务一：网络拓扑构建"><a href="#任务一：网络拓扑构建" class="headerlink" title="任务一：网络拓扑构建"></a>任务一：网络拓扑构建</h1><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">以本机能够ping通192.168.N.86成功为标准构建拓扑（N是自己队伍的C段）<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>安装所给的console驱动</p>
<p>笔记本 usb 插 console 线，另一头插交换机的 console 口进行连接，xshell用 SERIAL 协议连接 COM7 口（在设备管理器-端口处查看对应的端口）</p>
<p><img src="/blog/2024/11/28/2024%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8/image-20241203141901391.png" alt="image-20241203141901391"></p>
<p>波特率设置为主办方提供的38400，设备管理器那边也要设置为38400（波特率不对会没有输入输出）</p>
<p><img src="/blog/2024/11/28/2024%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8/image-20241203142021367.png" alt="image-20241203142021367"></p>
<p>然后就能连上</p>
<p>拓扑图：</p>
<p><img src="/blog/2024/11/28/2024%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8/image-20241128120244671.png" alt="image-20241128120244671"></p>
<p>console连上交换机2进行配置，键入<code>?</code>可以查看可用命令和帮助，tab可以补全，删除字符要用del：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">TL-SG521<span class="token operator"><span class="token file-descriptor important">0</span>></span>
 broadcast            - Write message to all <span class="token function">users</span> logged in,at <span class="token function">most</span> <span class="token number">256</span>
                         characters
 <span class="token builtin class-name">enable</span>               - Enter Privileged EXEC Mode
 <span class="token function">ping</span>                 - Ping <span class="token builtin class-name">command</span>
 tracert              - Tracet route to destination
 <span class="token builtin class-name">exit</span>                 - Exit current mode

TL-SG521<span class="token operator"><span class="token file-descriptor important">0</span>></span>enable

TL-SG5210<span class="token comment">#</span>
 broadcast            - Write message to all <span class="token function">users</span> logged in,at <span class="token function">most</span> <span class="token number">256</span>
                         characters
 configure            - Enter Global Configuration Mode
 copy                 - Config <span class="token function">file</span> commands
 debug                - Debugging commands
 enable-admin         - Achieve the admin privilege
 firmware             - Firmware commands
 <span class="token builtin class-name">logout</span>               - Logout the system
 <span class="token function">ping</span>                 - Ping <span class="token builtin class-name">command</span>
 <span class="token function">reboot</span>               - Reboot the system
 remove               - Config <span class="token function">file</span> commands
 reset                - Reset the system
 tracert              - Tracet route to destination
 <span class="token function">clear</span>                - Reset functions
 <span class="token builtin class-name">exit</span>                 - Exit current mode
 show                 - Display system information
 
TL-SG5210<span class="token comment">#ping 192.168.52.86</span>

Pinging <span class="token number">192.168</span>.52.86 with <span class="token number">64</span> bytes of data <span class="token builtin class-name">:</span>
Destination Host Unreachable<span class="token operator">!</span>
Destination Host Unreachable<span class="token operator">!</span>
Destination Host Unreachable<span class="token operator">!</span>
Destination Host Unreachable<span class="token operator">!</span>

Ping statistics <span class="token keyword">for</span> <span class="token number">192.168</span>.52.86:
    Packets: Sent <span class="token operator">=</span> <span class="token number">0</span> , Received <span class="token operator">=</span> <span class="token number">0</span> , Lost <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0</span>% loss<span class="token punctuation">)</span>
Approximate round trip <span class="token builtin class-name">times</span> <span class="token keyword">in</span> milli-seconds:
Minimum <span class="token operator">=</span> 0ms , Maximum <span class="token operator">=</span> 0ms , Average <span class="token operator">=</span> 0ms

TL-SG5210<span class="token comment">#enable-admin</span>
Authentication fail. You should <span class="token builtin class-name">enable</span> AAA first.

Error password<span class="token operator">!</span>

TL-SG5210<span class="token comment">#configure</span>

TL-SG5210<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token comment">#</span>
 aaa                  - Authentication Authorization Accounting commands
 access-list          - Create a temporary Access-List entry
 arp                  - Address Resolution Protocol <span class="token punctuation">(</span>ARP<span class="token punctuation">)</span>
 boot                 - Boot configuration
 cloud-server         - Config Cloud Server status
 contact-info         - Contact information
 dns                  - Configure domain name system
 dot1q-tunnel         - Dot1q-tunnel configuration
 dot1x                - Globally Enable <span class="token number">802</span>.1x feature
 <span class="token builtin class-name">enable</span>               - Configure <span class="token builtin class-name">enable</span> password
 gvrp                 - GVRP global configuration
 holiday              - Configure the holiday <span class="token function">time</span> range
 <span class="token function">hostname</span>             - System name
 interface            - Select an interface to configure
 <span class="token function">ip</span>                   - IP address commands
 ipv6                 - Internet Protocol version <span class="token number">6</span> <span class="token punctuation">(</span>IPv6<span class="token punctuation">)</span>
 lacp                 - Configure LACP global system priority
 line                 - Enter Line Configuration Mode
 lldp                 - Configure LLDP global subcommands
 location             - System location
 logging              - System log configuration
 loopback-detection   - Enable loopback-detection
 mac                  - Global Bridge table configuration commands
 mac-vlan             - Configure a MAC-based VLAN entry
 monitor              - Monitoring different system events
 port-channel         - EtherChannel configuration
 protocol-vlan        - Protocol VLAN commands
 qos                  - Configure quality of <span class="token function">service</span> <span class="token punctuation">(</span>QoS<span class="token punctuation">)</span> on the device
 radius-server        - Modify RADIUS query parameters
 rmon                 - SNMP RMON configuration
 router               - router
 <span class="token function">service</span>              - Change Service state
 snmp-server          - SNMP server configuration
 spanning-tree        - Configure Spanning Tree Subsystem
 system-time          - System-time configuration
 tacacs-server        - Modify TACACS query parameters
 telnet               - Telnet configuration
 time-range           - Configure the <span class="token function">time</span> range 
 ucl                  - UCL commands
 user                 - Add a new user or modify an exist user
 vlan                 - VLAN commands
 voice                - Voice VLAN global commands
 <span class="token function">clear</span>                - Reset functions
 end                  - Return to Privileged EXEC Mode
 <span class="token builtin class-name">exit</span>                 - Exit current mode
 no                   - Negate <span class="token builtin class-name">command</span>
 show                 - Display system information
 
TL-SG5210<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token comment">#interface </span>
 fastEthernet         - FastEthernet IEEE <span class="token number">802.3</span>
 gigabitEthernet      - GigabitEthernet IEEE <span class="token number">802</span>.3z
 loopback             - Loopback interface
 port-channel         - Ethernet Channel of interfaces
 range                - Interface Range Mode
 ten-gigabitEthernet  - Ten-GigabitEthernet IEEE <span class="token number">802</span>.3ae
 vlan                 - Interface VLAN Mode<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>那么就是要在config模式下对交换机路由进行配置，测试发现<code>interface gigabitEthernet 1/0/2</code>进入 config-if 模式下配不了 ip 地址</p>
<p>先看一下现有的路由配置</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">TL-SG5210<span class="token comment">#show </span>
 aaa                  - Display the AAA configuration
 access-list          - Display ACL information
 arp                  - Display ARP information
 bandwidth            - Display bandwidth rate configuration
 boot                 - Display the boot configuration
 cable-diagnostics    - Display Cable diagnostics results
 cloud-server         - cloud-server 
 cluster              - Display cluster information
 cpu-utilization      - Display CPU utilization
 debugging            - Dispaly modules debug status
 dot1q-tunnel         - Display VLAN VPN configuration
 dot1x                - Display <span class="token number">802</span>.1x configuration information
 etherchannel         - Display EtherChannel information
 gvrp                 - Display GVRP information
 <span class="token function">history</span>              - Display <span class="token builtin class-name">command</span> <span class="token function">history</span>
 holiday              - Display holiday information
 image-info           - Display the image info
 interface            - Display interface status and configuration
 <span class="token function">ip</span>                   - Display IP information
 ipv6                 - Internet Protocol version <span class="token number">6</span> <span class="token punctuation">(</span>IPv6<span class="token punctuation">)</span>
 lacp                 - Display LACP configuration
 lldp                 - Display LLDP information
 logging              - Display log information
 loopback-detection   - Display loopback detection information
 mac                  - Display mac information
 mac-vlan             - Display MAC Based VLAN information
 memory-utilization   - Display memory utilization
 monitor              - Display monitor sessions information
 port                 - Display Ethernet port configuration
 protocol-vlan        - Display protocol VLAN configuration
 qos                  - Display QoS related information
 radius-server        - Show radius server information
 rmon                 - Display SNMP RMON information
 running-config       - Display running config
 snmp-server          - Display SNMP related information
 spanning-tree        - Display spanning tree information
 startup-config       - Display startup config
 storm-control        - Display interface's storm-control configuration
 system-info          - Display system information
 system-time          - Display current system <span class="token function">time</span> information
 tacacs-server        - Show tacacs+ server information
 telnet-status        - Display telnet status
 time-range           - Display <span class="token function">time</span> segment information
 ucl                  - Display UCL information
 user                 - Display user account information
 vlan                 - Display VLAN information
 voice                - Display voice VLAN configuration

TL-SG5210<span class="token comment">#show ip interface </span>
 brief                - Brief summary of IP status and configuration
 fastEthernet         - FastEthernet IEEE <span class="token number">802.3</span>
 gigabitEthernet      - GigabitEthernet IEEE <span class="token number">802</span>.3z
 loopback             - Loopback interface
 port-channel         - Ethernet Channel of interfaces
 ten-gigabitEthernet  - Ten-GigabitEthernet IEEE <span class="token number">802</span>.3ae
 vlan                 - VLAN interface
 <span class="token operator">&lt;</span>cr<span class="token operator">></span>

TL-SG5210<span class="token comment">#show ip interface brief </span>
 Interface             IP-Address          Method  Status  Protocol  Shutdown
 ---------             ----------          ------  ------  --------  --------
 Vlan1                 <span class="token number">192.168</span>.0.1/24      Static  up      up        no
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>config 模式下启用AAA</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">TL-SG5210<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token comment">#aaa </span>
 accounting           - Configure accounting method list
 authentication       - Configure authentication method list
 <span class="token builtin class-name">enable</span>               - Enable AAA
 group                - Configure AAA group

TL-SG5210<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token comment">#aaa enable</span>

TL-SG5210<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token comment">#exit</span>

TL-SG5210<span class="token comment">#enable-admin</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>接下来结合这张表配置 vlan</p>
<p><img src="/blog/2024/11/28/2024%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8/image-20241203143852945.png" alt="image-20241203143852945"></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">TL-SG5210<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token comment">#interface </span>
 fastEthernet         - FastEthernet IEEE <span class="token number">802.3</span>
 gigabitEthernet      - GigabitEthernet IEEE <span class="token number">802</span>.3z
 loopback             - Loopback interface
 port-channel         - Ethernet Channel of interfaces
 range                - Interface Range Mode
 ten-gigabitEthernet  - Ten-GigabitEthernet IEEE <span class="token number">802</span>.3ae
 vlan                 - Interface VLAN Mode

TL-SG5210<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token comment">#interface vlan                                               </span>
 <span class="token operator">&lt;</span><span class="token number">1</span>-409<span class="token operator"><span class="token file-descriptor important">4</span>></span>             - VLAN interface number
 
TL-SG5210<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token comment">#interface vlan 4</span>

TL-SG5210<span class="token punctuation">(</span>config-if<span class="token punctuation">)</span><span class="token comment">#</span>
 access-list          - Configure the access list control module
 arp                  - Address Resolution Protocol <span class="token punctuation">(</span>ARP<span class="token punctuation">)</span>
 description          - Specify vlan interface description
 <span class="token function">ip</span>                   - Configure interface internet protocol
 ipv6                 - IPv6 interface subcommands
 <span class="token function">shutdown</span>             - Shutdown the selected interface
 <span class="token function">clear</span>                - Reset functions
 end                  - Return to Privileged EXEC Mode
 <span class="token builtin class-name">exit</span>                 - Exit current mode
 no                   - Negate <span class="token builtin class-name">command</span>
 show                 - Display system information
 
TL-SG5210<span class="token punctuation">(</span>config-if<span class="token punctuation">)</span><span class="token comment">#ip </span>
 address              - Set IP address manually
 address-alloc        - Set IP address by bootp or dhcp
 helper-address       - Specify a destination address <span class="token keyword">for</span> DHCP broadcasts
 local-proxy-arp      - Specify <span class="token builtin class-name">local</span> proxy ARP configuration
 proxy-arp            - Specify proxy ARP configuration
 rip                  - Specify RIP protocol interface configuration

TL-SG5210<span class="token punctuation">(</span>config-if<span class="token punctuation">)</span><span class="token comment">#ip address</span>
address             address-alloc       

TL-SG5210<span class="token punctuation">(</span>config-if<span class="token punctuation">)</span><span class="token comment">#ip address 192.168.52.86 </span>
 A.B.C.D              - Specify the IP subnet mask

TL-SG5210<span class="token punctuation">(</span>config-if<span class="token punctuation">)</span><span class="token comment">#ip address 192.168.52.86 255.255.255.0</span>

TL-SG5210<span class="token punctuation">(</span>config-if<span class="token punctuation">)</span><span class="token comment">#no shutdown </span>
<span class="token function">shutdown</span>            <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样就配置完成了，然后把电脑的网线另一头从hub上拔下来接到交换机的 lan 口上就能ping通了</p>
<hr>
<h1 id="任务二：交换机配置（Unsolved）"><a href="#任务二：交换机配置（Unsolved）" class="headerlink" title="任务二：交换机配置（Unsolved）"></a>任务二：交换机配置（Unsolved）</h1><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">对竞赛平台中的网络设备进行配置，完成该任务应能够实现以下效果：
1. 工业防火墙、工业日志审计的管理口同处于交换机 SW1 的 VLAN 5 下，操作人员可通过桌面 Hub 访问 MES 的 Web 页面，通过 G1/0/3 访问工业日志审计管理页面、工业防火墙管理页面。
2. SCADA、HMI 同处于 VLAN 下，操作人员可通过 SCADA 访问 MES 的 web 页面。
3. 通过工业日志审计能够监控流经交换机 SW1 和交换机 SW2 的所有流量数据。
4. 将交换机 1 的 G1/0/8 的 IP 地址配置为 12.0.N.254/24。
5. 添加静态路由 171.16.0.0/16，网关为 12.0.N.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>直接把console线插到交换机1上，用同样的方式配置 vlan5，使其能够通过网线访问工业防火墙、工业日志审计</p>
<p><img src="/blog/2024/11/28/2024%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8/image-20241128150333714.png" alt="image-20241128150333714"></p>
<p><img src="/blog/2024/11/28/2024%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8/image-20241128150413106.png" alt="image-20241128150413106"></p>
<p>但是还差一个 通过桌面 Hub 访问 MES 的 Web 页面</p>
<p>hint：MES的web服务开在不常见端口</p>
<p>于是把65535全扫了一遍。。然后没扫到，不知道怎么搞的</p>
<hr>
<h1 id="任务十三：代码安全审计"><a href="#任务十三：代码安全审计" class="headerlink" title="任务十三：代码安全审计"></a>任务十三：代码安全审计</h1><p>对以下这段代码进行安全审计：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">filter_var</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token constant">FILTER_VALIDATE_URL</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$error</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"无效的 URL，请检查格式。"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$ch</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_HEADER</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_FOLLOWLOCATION</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_MAXREDIRS</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$response</span> <span class="token operator">===</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$error</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'cURL 错误: '</span> <span class="token operator">.</span> <span class="token function">curl_error</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>zh<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>危化品处理系统<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">
        <span class="token selector">body</span> <span class="token punctuation">&#123;</span>
            <span class="token property">font-family</span><span class="token punctuation">:</span> Arial<span class="token punctuation">,</span> sans-serif<span class="token punctuation">;</span>
            <span class="token property">background-color</span><span class="token punctuation">:</span> #f5f5f5<span class="token punctuation">;</span>
            <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
            <span class="token property">padding</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
            <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
            <span class="token property">justify-content</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
            <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
            <span class="token property">height</span><span class="token punctuation">:</span> 100vh<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token selector">.container</span> <span class="token punctuation">&#123;</span>
            <span class="token property">background-color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
            <span class="token property">padding</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
            <span class="token property">border-radius</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span>
            <span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 0 10px <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token property">width</span><span class="token punctuation">:</span> 400px<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token selector">h1</span> <span class="token punctuation">&#123;</span>
            <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token selector">label</span> <span class="token punctuation">&#123;</span>
            <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
            <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span>
            <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token selector">input[type="text"]</span> <span class="token punctuation">&#123;</span>
            <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
            <span class="token property">padding</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
            <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 15px<span class="token punctuation">;</span>
            <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #ccc<span class="token punctuation">;</span>
            <span class="token property">border-radius</span><span class="token punctuation">:</span> 4px<span class="token punctuation">;</span>
            <span class="token property">box-sizing</span><span class="token punctuation">:</span> border-box<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token selector">.btn</span> <span class="token punctuation">&#123;</span>
            <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
            <span class="token property">padding</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
            <span class="token property">background-color</span><span class="token punctuation">:</span> #4CAF50<span class="token punctuation">;</span>
            <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
            <span class="token property">border</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
            <span class="token property">border-radius</span><span class="token punctuation">:</span> 4px<span class="token punctuation">;</span>
            <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span>
            <span class="token property">font-size</span><span class="token punctuation">:</span> 16px<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token selector">.btn:hover</span> <span class="token punctuation">&#123;</span>
            <span class="token property">background-color</span><span class="token punctuation">:</span> #45a049<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token selector">.error</span> <span class="token punctuation">&#123;</span>
            <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>
            <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token selector">.result</span> <span class="token punctuation">&#123;</span>
            <span class="token property">margin-top</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
            <span class="token property">background-color</span><span class="token punctuation">:</span> #f1f1f1<span class="token punctuation">;</span>
            <span class="token property">padding</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
            <span class="token property">border-radius</span><span class="token punctuation">:</span> 4px<span class="token punctuation">;</span>
            <span class="token property">word-wrap</span><span class="token punctuation">:</span> break-word<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>危化品处理<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>请输入 URL：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>请输入有效的 URL<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span><span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">></span></span>
        
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>提交处理<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>

        <span class="token comment">&lt;!-- 显示错误消息 --></span>
        <span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$error</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token delimiter important">?></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>error<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span><span class="token variable">$error</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
        <span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">endif</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>

    <span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$response</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$error</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token delimiter important">?></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>result<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>请求结果:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span><span class="token punctuation">></span></span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span><span class="token variable">$response</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">endif</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li><p>指出代码存在漏洞的行数：一眼在12行<code>$response = curl_exec($ch);</code>这里可以随便ssrf</p>
</li>
<li><p>如果要对代码进行修复，应该做出怎样修改：简单过滤一手</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">filter_var</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token constant">FILTER_VALIDATE_URL</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token keyword type-declaration">false</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/^(https?|ftp):\/\/.[^\s]*$/'</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$error</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"无效的 URL，请检查格式。"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$ch</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_HEADER</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_FOLLOWLOCATION</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_MAXREDIRS</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$response</span> <span class="token operator">===</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$error</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'cURL 错误: '</span> <span class="token operator">.</span> <span class="token function">curl_error</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<hr>
<h1 id="渗透-数字化装配场景"><a href="#渗透-数字化装配场景" class="headerlink" title="渗透-数字化装配场景"></a>渗透-数字化装配场景</h1><p>日志处存在任意文件读取，甚至可以列出目录</p>
<p><img src="/blog/2024/11/28/2024%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8/image-20241128140416081.png" alt="image-20241128140416081"></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/proc/self/cmdline<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/11/28/2024%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8/image-20241128140838919.png" alt="image-20241128140838919"></p>
<p>读取的日志有最大长度</p>
<p>..&#x2F;data_monitor.py</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">"""
opc-ua类: 实现工业机器交互
opc-ua安装使用方式：pip install opcua
opencv-python
"""</span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> tempfile
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> time
<span class="token keyword">import</span> datetime
<span class="token keyword">import</span> json
<span class="token keyword">from</span> functools <span class="token keyword">import</span> wraps
<span class="token keyword">from</span> itertools <span class="token keyword">import</span> islice

<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> send_file<span class="token punctuation">,</span> request<span class="token punctuation">,</span> Response<span class="token punctuation">,</span> make_response
<span class="token keyword">from</span> flask_cors <span class="token keyword">import</span> CORS
<span class="token keyword">from</span> opcua <span class="token keyword">import</span> Client<span class="token punctuation">,</span> ua<span class="token punctuation">,</span> Node
<span class="token keyword">import</span> cv2
<span class="token keyword">from</span> base_info <span class="token keyword">import</span> sub_ids<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> port<span class="token punctuation">,</span> host<span class="token punctuation">,</span> user<span class="token punctuation">,</span> pw<span class="token punctuation">,</span> database
<span class="token keyword">from</span> get_generate_plan <span class="token keyword">import</span> get_random_plan
<span class="token keyword">from</span> update_value <span class="token keyword">import</span> monitor_task
<span class="token keyword">from</span> mysql_db <span class="token keyword">import</span> MySQLDatabase


app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
CORS<span class="token punctuation">(</span>app<span class="token punctuation">,</span> resources<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">r"/*"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token string">"origins"</span><span class="token punctuation">:</span> <span class="token string">"*"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

abs_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>abs_path<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/dashboard"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">get_monitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> MySQLDatabase<span class="token punctuation">(</span>host<span class="token punctuation">,</span> user<span class="token punctuation">,</span> pw<span class="token punctuation">,</span> database<span class="token punctuation">)</span> <span class="token keyword">as</span> db<span class="token punctuation">:</span>
            data <span class="token operator">=</span> db<span class="token punctuation">.</span>execute_query<span class="token punctuation">(</span><span class="token string">"SELECT name_key, content FROM monitor"</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
            info <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> data<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> data<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'code'</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">:</span> info<span class="token punctuation">&#125;</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'code'</span><span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/plan"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">get_plan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        plan_list <span class="token operator">=</span> get_random_plan<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'code'</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">:</span> plan_list<span class="token punctuation">&#125;</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'code'</span><span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/get_log"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">get_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    filename <span class="token operator">=</span> request<span class="token punctuation">.</span>json<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span>

    file_path <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>abs_path<span class="token punctuation">&#125;</span></span><span class="token string">/log/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>filename<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                lines <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>islice<span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token keyword">with</span> tempfile<span class="token punctuation">.</span>NamedTemporaryFile<span class="token punctuation">(</span>delete<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> temp_file<span class="token punctuation">:</span>
                temp_file<span class="token punctuation">.</span>writelines<span class="token punctuation">(</span>lines<span class="token punctuation">)</span>
                temp_file_path <span class="token operator">=</span> temp_file<span class="token punctuation">.</span>name

            response <span class="token operator">=</span> make_response<span class="token punctuation">(</span>send_file<span class="token punctuation">(</span>temp_file_path<span class="token punctuation">)</span><span class="token punctuation">)</span>
            response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Content-Type'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'application/json'</span>
            <span class="token keyword">return</span> response
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">"文件不存在"</span><span class="token punctuation">,</span> <span class="token number">400</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> Response<span class="token punctuation">(</span>
            json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>abs_path<span class="token punctuation">&#125;</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>filename<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            content_type<span class="token operator">=</span><span class="token string">"application/json"</span><span class="token punctuation">,</span>
            headers<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">VideoCamera</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span> account<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span> passwd<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"rtsp://</span><span class="token interpolation"><span class="token punctuation">&#123;</span>account<span class="token punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">&#123;</span>passwd<span class="token punctuation">&#125;</span></span><span class="token string">@</span><span class="token interpolation"><span class="token punctuation">&#123;</span>host<span class="token punctuation">&#125;</span></span><span class="token string">:554/Streaming/Channels/1"</span></span>
        self<span class="token punctuation">.</span>video <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span>self<span class="token punctuation">.</span>url<span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@property</span>
    <span class="token keyword">def</span> <span class="token function">check</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>video<span class="token punctuation">.</span>isOpened<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>

    <span class="token keyword">def</span> <span class="token function">__del__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>video<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_frame</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        success<span class="token punctuation">,</span> image <span class="token operator">=</span> self<span class="token punctuation">.</span>video<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        ret<span class="token punctuation">,</span> jpeg <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imencode<span class="token punctuation">(</span><span class="token string">'.jpg'</span><span class="token punctuation">,</span> image<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>IMWRITE_JPEG_QUALITY<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> jpeg<span class="token punctuation">.</span>tobytes<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>..&#x2F;mysql_db.py</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> mysql<span class="token punctuation">.</span>connector


<span class="token keyword">class</span> <span class="token class-name">MySQLDatabase</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> host<span class="token punctuation">,</span> user<span class="token punctuation">,</span> password<span class="token punctuation">,</span> database<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>host <span class="token operator">=</span> host
        self<span class="token punctuation">.</span>user <span class="token operator">=</span> user
        self<span class="token punctuation">.</span>password <span class="token operator">=</span> password
        self<span class="token punctuation">.</span>database <span class="token operator">=</span> database
        self<span class="token punctuation">.</span>conn <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>cursor <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>conn <span class="token operator">=</span> mysql<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>
            host<span class="token operator">=</span>self<span class="token punctuation">.</span>host<span class="token punctuation">,</span>
            user<span class="token operator">=</span>self<span class="token punctuation">.</span>user<span class="token punctuation">,</span>
            password<span class="token operator">=</span>self<span class="token punctuation">.</span>password<span class="token punctuation">,</span>
            database<span class="token operator">=</span>self<span class="token punctuation">.</span>database
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cursor <span class="token operator">=</span> self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self

    <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> exc_type<span class="token punctuation">,</span> exc_val<span class="token punctuation">,</span> exc_tb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>cursor<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>cursor<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>conn<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">execute_query</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>query<span class="token punctuation">,</span> params<span class="token punctuation">)</span>
        result <span class="token operator">=</span> self<span class="token punctuation">.</span>cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> result

    <span class="token keyword">def</span> <span class="token function">update_record</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>query<span class="token punctuation">,</span> params<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>cursor<span class="token punctuation">.</span>lastrowid


<span class="token triple-quoted-string string">""" 使用with语句进行数据库操作
with MySQLDatabase(host='localhost', user='yourusername', password='yourpassword', database='mydatabase') as db:
    result = db.execute_query("SELECT * FROM customers")
    for x in result:
        print(x)

    updated_rows = db.update_record("UPDATE customers SET address = 'Canyon 123' WHERE address = 'Valley 345'")
    print(updated_rows, "记录被修改")
"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>..&#x2F;base_info.py</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">"""
sis监控文件统一放到  /home/opt/monitor目录下
mis前端文件统一放到  /var/www/html 并指定默认访问页面为index.php
"""</span>

<span class="token comment"># mysql</span>
host <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span>
user <span class="token operator">=</span> <span class="token string">"root"</span>
pw <span class="token operator">=</span> <span class="token string">"abc123!@#"</span>
database <span class="token operator">=</span> <span class="token string">"mesdb"</span>

<span class="token comment"># 组态系统信息</span>
ip <span class="token operator">=</span> <span class="token string">'192.168.2.32'</span>
port <span class="token operator">=</span> <span class="token number">4862</span>

<span class="token comment"># 监控节点数据</span>
sub_ids <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token string">'ns=1;s=t|DLSSL'</span><span class="token punctuation">,</span>  <span class="token comment"># 打螺丝数量</span>
    <span class="token string">'ns=1;s=t|FTQS'</span><span class="token punctuation">,</span>  <span class="token comment"># 发条圈数</span>
    <span class="token string">'ns=1;s=t|FZJD'</span><span class="token punctuation">,</span>  <span class="token comment"># 翻转角度</span>
    <span class="token string">'ns=1;s=t|FZZP_Run'</span><span class="token punctuation">,</span>  <span class="token comment"># 翻转装配运行</span>
    <span class="token comment"># 'ns=1;s=t|FZZP_Start',  # 翻转装配启动</span>
    <span class="token comment"># 'ns=1;s=t|FZZP_Stop',  # 翻转装配停止</span>
    <span class="token comment"># 'ns=1;s=t|hand',  # 手自动模式</span>
    <span class="token string">'ns=1;s=t|HJ_SD'</span><span class="token punctuation">,</span>  <span class="token comment"># 环境湿度</span>
    <span class="token string">'ns=1;s=t|HJ_WD'</span><span class="token punctuation">,</span>  <span class="token comment"># 环境温度</span>
    <span class="token string">'ns=1;s=t|JGDB_Run'</span><span class="token punctuation">,</span>  <span class="token comment"># 激光打标运行</span>
    <span class="token comment"># 'ns=1;s=t|JGDB_Start',  # 激光打标启动</span>
    <span class="token comment"># 'ns=1;s=t|JGDB_Stop',  # 激光打标停止</span>
    <span class="token string">'ns=1;s=t|JGPL'</span><span class="token punctuation">,</span>  <span class="token comment"># 激光频率</span>
    <span class="token string">'ns=1;s=t|JXSL_Run'</span><span class="token punctuation">,</span>  <span class="token comment"># 机芯上料运行</span>
    <span class="token comment"># 'ns=1;s=t|JXSL_Start',  # 机芯上料启动</span>
    <span class="token comment"># 'ns=1;s=t|JXSL_Stop',  # 机芯上料停止</span>
    <span class="token string">'ns=1;s=t|JZDL_Run'</span><span class="token punctuation">,</span>  <span class="token comment"># 基座打料运行</span>
    <span class="token comment"># 'ns=1;s=t|JZDL_Start',  # 基座打料启动</span>
    <span class="token comment"># 'ns=1;s=t|JZDL_Stop',  # 基座打料停止</span>
    <span class="token string">'ns=1;s=t|SCSL'</span><span class="token punctuation">,</span>  <span class="token comment"># 生产数量</span>
    <span class="token string">'ns=1;s=t|SGDLS_Run'</span><span class="token punctuation">,</span>  <span class="token comment"># 上盖打螺丝运行</span>
    <span class="token comment"># 'ns=1;s=t|SGDLS_Start',  # 上盖打螺丝启动</span>
    <span class="token comment"># 'ns=1;s=t|SGDLS_Stop',  # 上盖打螺丝停止</span>
    <span class="token string">'ns=1;s=t|SJSFT_Run'</span><span class="token punctuation">,</span>  <span class="token comment"># 视觉上发条运行</span>
    <span class="token comment"># 'ns=1;s=t|SJSFT_Start',  # 视觉上发条启动</span>
    <span class="token comment"># 'ns=1;s=t|SJSFT_Stop',  # 视觉上发条停止</span>
    <span class="token string">'ns=1;s=t|SLSD'</span><span class="token punctuation">,</span>  <span class="token comment"># 上料速度</span>
    <span class="token string">'ns=1;s=t|tongxun_state'</span><span class="token punctuation">,</span>  <span class="token comment"># PLC通讯状态</span>
    <span class="token string">'ns=1;s=t|TPZY_Run'</span><span class="token punctuation">,</span>  <span class="token comment"># 托盘转运运行</span>
    <span class="token comment"># 'ns=1;s=t|TPZY_Start',  # 托盘转运启动</span>
    <span class="token comment"># 'ns=1;s=t|TPZY_Stop',  # 托盘转运停止</span>
    <span class="token string">'ns=1;s=t|YJ_Run'</span><span class="token punctuation">,</span>  <span class="token comment"># 一键运行</span>
    <span class="token comment"># 'ns=1;s=t|YJ_Start',  # 一键启动</span>
    <span class="token comment"># 'ns=1;s=t|YJ_Stop',  # 一键停止</span>
    <span class="token string">'ns=1;s=t|ZN_M_OVERSPEED'</span><span class="token punctuation">,</span>  <span class="token comment"># 电机超速报警</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>..&#x2F;update_value.py</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> re
<span class="token keyword">import</span> os
<span class="token keyword">import</span> time
<span class="token keyword">import</span> datetime

<span class="token keyword">from</span> base_info <span class="token keyword">import</span> sub_ids<span class="token punctuation">,</span> host<span class="token punctuation">,</span> user<span class="token punctuation">,</span> pw<span class="token punctuation">,</span> database
<span class="token keyword">from</span> mysql_db <span class="token keyword">import</span> MySQLDatabase


node_dict <span class="token operator">=</span> <span class="token punctuation">&#123;</span>x<span class="token punctuation">:</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'\|(.*)'</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> sub_ids<span class="token punctuation">&#125;</span>
abs_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">monitor_task</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> MySQLDatabase<span class="token punctuation">(</span>host<span class="token punctuation">,</span> user<span class="token punctuation">,</span> pw<span class="token punctuation">,</span> database<span class="token punctuation">)</span> <span class="token keyword">as</span> db<span class="token punctuation">:</span>
            result <span class="token operator">=</span> db<span class="token punctuation">.</span>execute_query<span class="token punctuation">(</span>
                <span class="token string">"SELECT * FROM monitor WHERE name= %s"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> result<span class="token punctuation">:</span>
                db<span class="token punctuation">.</span>update_record<span class="token punctuation">(</span>
                    <span class="token string">"UPDATE monitor SET content=%s WHERE name = %s"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                db<span class="token punctuation">.</span>update_record<span class="token punctuation">(</span>
                    <span class="token string">"INSERT INTO monitor (name, name_key, content) VALUES (%s, %s, %s)"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>key<span class="token punctuation">,</span> node_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f">>>>> </span><span class="token interpolation"><span class="token punctuation">&#123;</span>node_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string"> 记录被修改 >>>>>"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"monitor_task_error: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"monitor_task_use_time: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">&#125;</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>..&#x2F;get_generate_plan.py</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> random
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta


NUM_PLANS <span class="token operator">=</span> <span class="token number">20</span>
MIN_PLAN_QUANTITY <span class="token operator">=</span> <span class="token number">10</span>
MAX_PLAN_QUANTITY <span class="token operator">=</span> <span class="token number">100</span>
MIN_PLAN_DURATION <span class="token operator">=</span> <span class="token number">1</span>
MAX_PLAN_DURATION <span class="token operator">=</span> <span class="token number">14</span>


<span class="token keyword">def</span> <span class="token function">generate_plan</span><span class="token punctuation">(</span>start_date<span class="token punctuation">,</span> end_date<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">:</span>
    order_number <span class="token operator">=</span> generate_plan_number<span class="token punctuation">(</span>start_date<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
    plan_quantity <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>MIN_PLAN_QUANTITY<span class="token punctuation">,</span> MAX_PLAN_QUANTITY<span class="token punctuation">)</span>
    plan_start <span class="token operator">=</span> random_date<span class="token punctuation">(</span>start_date<span class="token punctuation">,</span> end_date<span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span>
    plan_duration <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>MIN_PLAN_DURATION<span class="token punctuation">,</span> MAX_PLAN_DURATION<span class="token punctuation">)</span>
    plan_end <span class="token operator">=</span> <span class="token punctuation">(</span>start_date <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span>plan_duration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span>
    order_status <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"正在进行"</span><span class="token punctuation">,</span> <span class="token string">"已完成"</span><span class="token punctuation">,</span> <span class="token string">"取消"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    completion_rate <span class="token operator">=</span> <span class="token builtin">round</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"order_number"</span><span class="token punctuation">:</span> order_number<span class="token punctuation">,</span>
        <span class="token string">"plan_quantity"</span><span class="token punctuation">:</span> plan_quantity<span class="token punctuation">,</span>
        <span class="token string">"plan_start"</span><span class="token punctuation">:</span> plan_start<span class="token punctuation">,</span>
        <span class="token string">"plan_end"</span><span class="token punctuation">:</span> plan_end<span class="token punctuation">,</span>
        <span class="token string">"order_status"</span><span class="token punctuation">:</span> order_status<span class="token punctuation">,</span>
        <span class="token string">"completion_rate"</span><span class="token punctuation">:</span> completion_rate
    <span class="token punctuation">&#125;</span>


<span class="token keyword">def</span> <span class="token function">generate_plan_number</span><span class="token punctuation">(</span>start_date<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"ORDER-</span><span class="token interpolation"><span class="token punctuation">&#123;</span>start_date<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y%m%d'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>zfill<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>


<span class="token keyword">def</span> <span class="token function">random_date</span><span class="token punctuation">(</span>start_date<span class="token punctuation">,</span> end_date<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time_between <span class="token operator">=</span> end_date <span class="token operator">-</span> start_date
    random_days <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> time_between<span class="token punctuation">.</span>days<span class="token punctuation">)</span>
    <span class="token keyword">return</span> start_date <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span>random_days<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">production_plan</span><span class="token punctuation">(</span>start_date<span class="token punctuation">,</span> end_date<span class="token punctuation">,</span> num_plans<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>generate_plan<span class="token punctuation">(</span>start_date<span class="token punctuation">,</span> end_date<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_plans<span class="token punctuation">)</span><span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">get_random_plan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    start_date <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>date<span class="token punctuation">(</span><span class="token punctuation">)</span>
    end_date <span class="token operator">=</span> start_date <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span>
    random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> production_plan<span class="token punctuation">(</span>start_date<span class="token punctuation">,</span> end_date<span class="token punctuation">,</span> NUM_PLANS<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;home&#x2F;scada&#x2F;app.py，是5001端口上的服务</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> request<span class="token punctuation">,</span> redirect<span class="token punctuation">,</span> url_for<span class="token punctuation">,</span> session<span class="token punctuation">,</span> render_template_string<span class="token punctuation">,</span>Markup<span class="token punctuation">,</span>make_response<span class="token punctuation">,</span>flash
<span class="token keyword">import</span> random
<span class="token keyword">import</span> hashlib
<span class="token keyword">from</span> flask_sqlalchemy <span class="token keyword">import</span> SQLAlchemy  
<span class="token keyword">from</span> werkzeug<span class="token punctuation">.</span>security <span class="token keyword">import</span> generate_password_hash<span class="token punctuation">,</span> check_password_hash  
<span class="token keyword">import</span> pymysql
<span class="token keyword">from</span> jinja2 <span class="token keyword">import</span> Template
<span class="token comment"># flag&#123;Yes_You_find_Me!&#125;</span>
app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>secret_key <span class="token operator">=</span> <span class="token string">'icssla'</span>  <span class="token comment"># 设置一个密钥用于session加密</span>
<span class="token comment"># 数据库连接配置  </span>
db_config <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  
    <span class="token string">'host'</span><span class="token punctuation">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>  
    <span class="token string">'user'</span><span class="token punctuation">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>  
    <span class="token string">'password'</span><span class="token punctuation">:</span> <span class="token string">'abc123!@#'</span><span class="token punctuation">,</span>  
    <span class="token string">'db'</span><span class="token punctuation">:</span> <span class="token string">'flask_login_db'</span><span class="token punctuation">,</span>  
    <span class="token string">'charset'</span><span class="token punctuation">:</span> <span class="token string">'utf8mb4'</span><span class="token punctuation">,</span>  
    <span class="token string">'cursorclass'</span><span class="token punctuation">:</span> pymysql<span class="token punctuation">.</span>cursors<span class="token punctuation">.</span>DictCursor<span class="token punctuation">,</span>  
<span class="token punctuation">&#125;</span> 
<span class="token comment"># 设置 session cookie 的 HttpOnly 和 Secure 标志</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SESSION_COOKIE_HTTPONLY'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># 设置为 False，允许 JavaScript 访问</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SESSION_COOKIE_SECURE'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># 设置为 False，允许在 HTTP 上发送 cookie</span>

<span class="token keyword">def</span> <span class="token function">contains_sql_keywords</span><span class="token punctuation">(</span>input_string<span class="token punctuation">,</span> keywords<span class="token punctuation">)</span><span class="token punctuation">:</span> 
    <span class="token keyword">for</span> keyword <span class="token keyword">in</span> keywords<span class="token punctuation">:</span>  
        <span class="token keyword">if</span> keyword <span class="token keyword">in</span> input_string<span class="token punctuation">:</span>  
            <span class="token keyword">return</span> <span class="token boolean">True</span>  
    <span class="token keyword">return</span> <span class="token boolean">False</span>  

<span class="token keyword">def</span> <span class="token function">contains_ssti_keywords</span><span class="token punctuation">(</span>input_string<span class="token punctuation">,</span> keywords<span class="token punctuation">)</span><span class="token punctuation">:</span> 
    <span class="token keyword">for</span> keyword <span class="token keyword">in</span> keywords<span class="token punctuation">:</span>  
        <span class="token keyword">if</span> keyword <span class="token keyword">in</span> input_string<span class="token punctuation">:</span>  
            <span class="token keyword">return</span> <span class="token boolean">True</span>  
    <span class="token keyword">return</span> <span class="token boolean">False</span>  
<span class="token comment"># 假设这是你的用户数据库</span>
<span class="token comment">#users = &#123;</span>
<span class="token comment">#    "admin": "admin@123"</span>
<span class="token comment">#&#125;</span>
md5_hash <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token comment"># 生成随机风机数据</span>
<span class="token keyword">def</span> <span class="token function">generate_random_data</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> num_entries<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_entries<span class="token punctuation">)</span><span class="token punctuation">:</span>
        fan <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"Fan </span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>
        speed <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>  <span class="token comment"># 转速范围 1000-3000 RPM</span>
        power <span class="token operator">=</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">100.0</span><span class="token punctuation">,</span> <span class="token number">500.0</span><span class="token punctuation">)</span>  <span class="token comment"># 发电量范围 100-500 kW</span>
        data<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"fan"</span><span class="token punctuation">:</span> fan<span class="token punctuation">,</span> <span class="token string">"speed"</span><span class="token punctuation">:</span> speed<span class="token punctuation">,</span> <span class="token string">"power"</span><span class="token punctuation">:</span> power<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    page_size <span class="token operator">=</span> <span class="token number">10</span>  <span class="token comment"># 每页显示的数据条数</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        page <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span>
        start_index <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> page_size
        end_index <span class="token operator">=</span> start_index <span class="token operator">+</span> page_size
        <span class="token keyword">return</span> data<span class="token punctuation">[</span>start_index<span class="token punctuation">:</span>end_index<span class="token punctuation">]</span><span class="token punctuation">,</span> page
    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span>  <span class="token comment"># 如果输入的不是有效的整数，返回空数据和默认页数1</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">'username'</span> <span class="token keyword">in</span> session<span class="token punctuation">:</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'dashboard.html'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>
        username <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span>
        password <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span>
        sql_keywords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'select'</span><span class="token punctuation">,</span> <span class="token string">'from'</span><span class="token punctuation">,</span> <span class="token string">'where'</span><span class="token punctuation">,</span> <span class="token string">'union'</span><span class="token punctuation">,</span> <span class="token string">'join'</span><span class="token punctuation">,</span> <span class="token string">'sleep'</span><span class="token punctuation">,</span><span class="token string">' '</span><span class="token punctuation">]</span>  
        input_string <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>username<span class="token punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">&#123;</span>password<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>  
        md5_hash<span class="token punctuation">.</span>update<span class="token punctuation">(</span>input_string<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        hex_dig <span class="token operator">=</span> md5_hash<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
        connection <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token operator">**</span>db_config<span class="token punctuation">)</span>  
        <span class="token keyword">if</span> contains_sql_keywords<span class="token punctuation">(</span>username<span class="token punctuation">,</span> sql_keywords<span class="token punctuation">)</span><span class="token punctuation">:</span>  
            <span class="token keyword">return</span> <span class="token string">"Error: There are illegal characters in the character you entered."</span><span class="token punctuation">,</span> <span class="token number">400</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>  
            <span class="token keyword">with</span> connection<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cursor<span class="token punctuation">:</span>  
                <span class="token comment"># 执行查询  </span>
                sql <span class="token operator">=</span> <span class="token string">"SELECT * FROM users WHERE username ='"</span> <span class="token operator">+</span> username <span class="token operator">+</span><span class="token string">"'"</span>
                cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>  
                <span class="token comment">#sql = "SELECT * FROM users WHERE username = %s"  </span>
                <span class="token comment">#cursor.execute(sql, (username,))  </span>
                result <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchone<span class="token punctuation">(</span><span class="token punctuation">)</span>  
                <span class="token comment"># 验证用户名和密码  </span>
                <span class="token keyword">if</span> result <span class="token keyword">and</span> result<span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span> <span class="token operator">==</span> password<span class="token punctuation">:</span>   
                    flash<span class="token punctuation">(</span><span class="token string">'Login successful!'</span><span class="token punctuation">,</span> <span class="token string">'success'</span><span class="token punctuation">)</span>  
                    session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> username  
                    <span class="token comment"># 假设 session_token 是与 session 相关的一个值  </span>
                    session_token <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">,</span> <span class="token number">999999</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 仅为示例  </span>
                    response <span class="token operator">=</span> make_response<span class="token punctuation">(</span>redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
                    response<span class="token punctuation">.</span>set_cookie<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> hex_dig<span class="token punctuation">,</span> httponly<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> secure<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>  
                    <span class="token keyword">return</span> response  
                <span class="token keyword">else</span><span class="token punctuation">:</span>  
                    flash<span class="token punctuation">(</span><span class="token string">'Invalid username or password'</span><span class="token punctuation">,</span> <span class="token string">'danger'</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token string">'Invalid credentials'</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>  
            connection<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'login.html'</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/logout'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最后在root下翻出一个flag，home下好像也有一个flag，交了俩flag</p>
<p>接下来应该是拿shell然后打横向，但是时间太短反应不过来（</p>

    </div>
    
    
    
    
    
    
    
</div>

            </div>
        </transition>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/blog/js/main.js"></script>
    
    




    
    

<div id="vcomments"></div>

<script src="/blog/js/lib/valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: 'U9mZLKunkRUTcBFthjXPjnZE-9Nh9j0Va',
        app_key: 'SzWOnY0PWLGNuL6jW8TZYc7j',
        visitor: 'true',
        placeholder: '写点什么吧(●ˇ∀ˇ●)',
        serverURLs: 'https://u9mzlkun.lc-cn-n1-shared.com',
    });
</script>

    <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2025 雲流のLowest World
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;C1oudfL0w0
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

<script src="/blog/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/blog/live2dw/assets/z16.model.json"},"display":{"position":"left","width":150,"height":290},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>